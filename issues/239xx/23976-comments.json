[
   {
      "author_association" : "MEMBER",
      "body" : "cc @jnewbery, as requested [here](https://github.com/bitcoin/bitcoin/pull/23683#issuecomment-1002662617)",
      "created_at" : "2022-01-04T16:11:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23976#issuecomment-1004941207",
      "id" : 1004941207,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23976",
      "node_id" : "IC_kwDOABII58475i-X",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1004941207/reactions"
      },
      "updated_at" : "2022-01-04T16:18:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1004941207",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#24080](https://github.com/bitcoin/bitcoin/pull/24080) (policy: Remove unused locktime flags by MarcoFalke)\n* [#23897](https://github.com/bitcoin/bitcoin/pull/23897) (refactor: Separate lockpoint calculate logic from CheckSequenceLocks function by hebasto)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-01-05T06:28:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23976#issuecomment-1005417236",
      "id" : 1005417236,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23976",
      "node_id" : "IC_kwDOABII58477XMU",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1005417236/reactions"
      },
      "updated_at" : "2022-01-18T07:20:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1005417236",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK c633c41e3089c44a90f1f8c32a2b411889cefcdf",
      "created_at" : "2022-01-05T12:55:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23976#issuecomment-1005662118",
      "id" : 1005662118,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23976",
      "node_id" : "IC_kwDOABII58478S-m",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1005662118/reactions"
      },
      "updated_at" : "2022-01-05T12:55:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1005662118",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23976#discussion_r778807125"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23976"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/778807125"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n        }  if (!validLP) {\r\n```\r\n\r\nnit: no need for else. I find it confusing in early return statements.",
      "commit_id" : "c633c41e3089c44a90f1f8c32a2b411889cefcdf",
      "created_at" : "2022-01-05T13:12:52Z",
      "diff_hunk" : "@@ -340,21 +340,29 @@ void CChainState::MaybeUpdateMempoolForReorg(\n     // the disconnectpool that were added back and cleans up the mempool state.\n     m_mempool->UpdateTransactionsFromBlock(vHashUpdate);\n \n-    const auto check_final_and_mature = [this, flags=STANDARD_LOCKTIME_VERIFY_FLAGS](CTxMemPool::txiter it)\n+    // Check whether the transaction is still final and, if it spends a coinbase output, mature.\n+    // Update the entry's cached LockPoints if needed. If this returns true, the tx would be invalid\n+    // in the next block, so the mempool must remove this entry and all of its descendants.\n+    const auto filter_final_and_mature = [this, flags=STANDARD_LOCKTIME_VERIFY_FLAGS](CTxMemPool::txiter it)\n         EXCLUSIVE_LOCKS_REQUIRED(m_mempool->cs, ::cs_main) {\n-        bool should_remove = false;\n         AssertLockHeld(m_mempool->cs);\n         AssertLockHeld(::cs_main);\n         const CTransaction& tx = it->GetTx();\n         LockPoints lp = it->GetLockPoints();\n         const bool validLP{TestLockPointValidity(m_chain, lp)};\n         CCoinsViewMemPool view_mempool(&CoinsTip(), *m_mempool);\n-        if (!CheckFinalTx(m_chain.Tip(), tx, flags)\n-            || !CheckSequenceLocks(m_chain.Tip(), view_mempool, tx, flags, &lp, validLP)) {\n-            // Note if CheckSequenceLocks fails the LockPoints may still be invalid\n-            // So it's critical that we remove the tx and not depend on the LockPoints.\n-            should_remove = true;\n-        } else if (it->GetSpendsCoinbase()) {\n+        // The transaction must be final.\n+        if (!CheckFinalTx(m_chain.Tip(), tx, flags)) return true;\n+        // Note if CheckSequenceLocks fails the LockPoints may still be invalid\n+        // So it's critical that we remove the tx and not depend on the LockPoints.\n+        if (!CheckSequenceLocks(m_chain.Tip(), view_mempool, tx, flags, &lp, validLP)) {\n+            return true;\n+        } else if (!validLP) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23976#discussion_r778807125",
      "id" : 778807125,
      "line" : 360,
      "node_id" : "PRRC_kwDOABII584ua6dV",
      "original_commit_id" : "c633c41e3089c44a90f1f8c32a2b411889cefcdf",
      "original_line" : 360,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 29,
      "pull_request_review_id" : 844582843,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23976",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/778807125/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-05T13:14:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/778807125",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23976#discussion_r778885827"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23976"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/778885827"
         }
      },
      "author_association" : "MEMBER",
      "body" : "See rationale here: https://github.com/bitcoin/bitcoin/pull/23683#discussion_r772879178 , but you're right that they've equivalent, so both are fine.",
      "commit_id" : "c633c41e3089c44a90f1f8c32a2b411889cefcdf",
      "created_at" : "2022-01-05T14:57:32Z",
      "diff_hunk" : "@@ -340,21 +340,29 @@ void CChainState::MaybeUpdateMempoolForReorg(\n     // the disconnectpool that were added back and cleans up the mempool state.\n     m_mempool->UpdateTransactionsFromBlock(vHashUpdate);\n \n-    const auto check_final_and_mature = [this, flags=STANDARD_LOCKTIME_VERIFY_FLAGS](CTxMemPool::txiter it)\n+    // Check whether the transaction is still final and, if it spends a coinbase output, mature.\n+    // Update the entry's cached LockPoints if needed. If this returns true, the tx would be invalid\n+    // in the next block, so the mempool must remove this entry and all of its descendants.\n+    const auto filter_final_and_mature = [this, flags=STANDARD_LOCKTIME_VERIFY_FLAGS](CTxMemPool::txiter it)\n         EXCLUSIVE_LOCKS_REQUIRED(m_mempool->cs, ::cs_main) {\n-        bool should_remove = false;\n         AssertLockHeld(m_mempool->cs);\n         AssertLockHeld(::cs_main);\n         const CTransaction& tx = it->GetTx();\n         LockPoints lp = it->GetLockPoints();\n         const bool validLP{TestLockPointValidity(m_chain, lp)};\n         CCoinsViewMemPool view_mempool(&CoinsTip(), *m_mempool);\n-        if (!CheckFinalTx(m_chain.Tip(), tx, flags)\n-            || !CheckSequenceLocks(m_chain.Tip(), view_mempool, tx, flags, &lp, validLP)) {\n-            // Note if CheckSequenceLocks fails the LockPoints may still be invalid\n-            // So it's critical that we remove the tx and not depend on the LockPoints.\n-            should_remove = true;\n-        } else if (it->GetSpendsCoinbase()) {\n+        // The transaction must be final.\n+        if (!CheckFinalTx(m_chain.Tip(), tx, flags)) return true;\n+        // Note if CheckSequenceLocks fails the LockPoints may still be invalid\n+        // So it's critical that we remove the tx and not depend on the LockPoints.\n+        if (!CheckSequenceLocks(m_chain.Tip(), view_mempool, tx, flags, &lp, validLP)) {\n+            return true;\n+        } else if (!validLP) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23976#discussion_r778885827",
      "id" : 778885827,
      "in_reply_to_id" : 778807125,
      "line" : 360,
      "node_id" : "PRRC_kwDOABII584ubNrD",
      "original_commit_id" : "c633c41e3089c44a90f1f8c32a2b411889cefcdf",
      "original_line" : 360,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 29,
      "pull_request_review_id" : 844697178,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23976",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/778885827/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-05T14:57:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/778885827",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Related #23897.",
      "created_at" : "2022-01-05T15:15:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23976#issuecomment-1005775038",
      "id" : 1005775038,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23976",
      "node_id" : "IC_kwDOABII58478ui-",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1005775038/reactions"
      },
      "updated_at" : "2022-01-05T15:15:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1005775038",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23976#discussion_r778919211"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23976"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/778919211"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why this branch--`if (!validLP)`--has been moved before `if (it->GetSpendsCoinbase())` ?",
      "commit_id" : "c633c41e3089c44a90f1f8c32a2b411889cefcdf",
      "created_at" : "2022-01-05T15:37:40Z",
      "diff_hunk" : "@@ -340,21 +340,29 @@ void CChainState::MaybeUpdateMempoolForReorg(\n     // the disconnectpool that were added back and cleans up the mempool state.\n     m_mempool->UpdateTransactionsFromBlock(vHashUpdate);\n \n-    const auto check_final_and_mature = [this, flags=STANDARD_LOCKTIME_VERIFY_FLAGS](CTxMemPool::txiter it)\n+    // Check whether the transaction is still final and, if it spends a coinbase output, mature.\n+    // Update the entry's cached LockPoints if needed. If this returns true, the tx would be invalid\n+    // in the next block, so the mempool must remove this entry and all of its descendants.\n+    const auto filter_final_and_mature = [this, flags=STANDARD_LOCKTIME_VERIFY_FLAGS](CTxMemPool::txiter it)\n         EXCLUSIVE_LOCKS_REQUIRED(m_mempool->cs, ::cs_main) {\n-        bool should_remove = false;\n         AssertLockHeld(m_mempool->cs);\n         AssertLockHeld(::cs_main);\n         const CTransaction& tx = it->GetTx();\n         LockPoints lp = it->GetLockPoints();\n         const bool validLP{TestLockPointValidity(m_chain, lp)};\n         CCoinsViewMemPool view_mempool(&CoinsTip(), *m_mempool);\n-        if (!CheckFinalTx(m_chain.Tip(), tx, flags)\n-            || !CheckSequenceLocks(m_chain.Tip(), view_mempool, tx, flags, &lp, validLP)) {\n-            // Note if CheckSequenceLocks fails the LockPoints may still be invalid\n-            // So it's critical that we remove the tx and not depend on the LockPoints.\n-            should_remove = true;\n-        } else if (it->GetSpendsCoinbase()) {\n+        // The transaction must be final.\n+        if (!CheckFinalTx(m_chain.Tip(), tx, flags)) return true;\n+        // Note if CheckSequenceLocks fails the LockPoints may still be invalid\n+        // So it's critical that we remove the tx and not depend on the LockPoints.\n+        if (!CheckSequenceLocks(m_chain.Tip(), view_mempool, tx, flags, &lp, validLP)) {\n+            return true;\n+        } else if (!validLP) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23976#discussion_r778919211",
      "id" : 778919211,
      "in_reply_to_id" : 778807125,
      "line" : 360,
      "node_id" : "PRRC_kwDOABII584ubV0r",
      "original_commit_id" : "c633c41e3089c44a90f1f8c32a2b411889cefcdf",
      "original_line" : 360,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 29,
      "pull_request_review_id" : 844746034,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23976",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/778919211/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-05T15:37:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/778919211",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23976#discussion_r780389911"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23976"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/780389911"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Because logically it's connected to the previous if statement - if `CheckSequenceLocks()` returns false then this filter function fails immediately. If it returns true, then the lockpoints may be invalid so they should be updated.\r\n\r\nFunctionally this is equivalent, but it groups the related functionality together.",
      "commit_id" : "c633c41e3089c44a90f1f8c32a2b411889cefcdf",
      "created_at" : "2022-01-07T16:47:21Z",
      "diff_hunk" : "@@ -340,21 +340,29 @@ void CChainState::MaybeUpdateMempoolForReorg(\n     // the disconnectpool that were added back and cleans up the mempool state.\n     m_mempool->UpdateTransactionsFromBlock(vHashUpdate);\n \n-    const auto check_final_and_mature = [this, flags=STANDARD_LOCKTIME_VERIFY_FLAGS](CTxMemPool::txiter it)\n+    // Check whether the transaction is still final and, if it spends a coinbase output, mature.\n+    // Update the entry's cached LockPoints if needed. If this returns true, the tx would be invalid\n+    // in the next block, so the mempool must remove this entry and all of its descendants.\n+    const auto filter_final_and_mature = [this, flags=STANDARD_LOCKTIME_VERIFY_FLAGS](CTxMemPool::txiter it)\n         EXCLUSIVE_LOCKS_REQUIRED(m_mempool->cs, ::cs_main) {\n-        bool should_remove = false;\n         AssertLockHeld(m_mempool->cs);\n         AssertLockHeld(::cs_main);\n         const CTransaction& tx = it->GetTx();\n         LockPoints lp = it->GetLockPoints();\n         const bool validLP{TestLockPointValidity(m_chain, lp)};\n         CCoinsViewMemPool view_mempool(&CoinsTip(), *m_mempool);\n-        if (!CheckFinalTx(m_chain.Tip(), tx, flags)\n-            || !CheckSequenceLocks(m_chain.Tip(), view_mempool, tx, flags, &lp, validLP)) {\n-            // Note if CheckSequenceLocks fails the LockPoints may still be invalid\n-            // So it's critical that we remove the tx and not depend on the LockPoints.\n-            should_remove = true;\n-        } else if (it->GetSpendsCoinbase()) {\n+        // The transaction must be final.\n+        if (!CheckFinalTx(m_chain.Tip(), tx, flags)) return true;\n+        // Note if CheckSequenceLocks fails the LockPoints may still be invalid\n+        // So it's critical that we remove the tx and not depend on the LockPoints.\n+        if (!CheckSequenceLocks(m_chain.Tip(), view_mempool, tx, flags, &lp, validLP)) {\n+            return true;\n+        } else if (!validLP) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23976#discussion_r780389911",
      "id" : 780389911,
      "in_reply_to_id" : 778807125,
      "line" : 360,
      "node_id" : "PRRC_kwDOABII584ug84X",
      "original_commit_id" : "c633c41e3089c44a90f1f8c32a2b411889cefcdf",
      "original_line" : 360,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 29,
      "pull_request_review_id" : 846793464,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23976",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/780389911/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-07T16:47:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/780389911",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23976#discussion_r780862952"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23976"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/780862952"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: this renaming isn't reflected in the signature of `removeForReorg`. ",
      "commit_id" : "c633c41e3089c44a90f1f8c32a2b411889cefcdf",
      "created_at" : "2022-01-10T01:56:09Z",
      "diff_hunk" : "@@ -363,18 +371,16 @@ void CChainState::MaybeUpdateMempoolForReorg(\n                 assert(!coin.IsSpent());\n                 const auto mempool_spend_height{m_chain.Tip()->nHeight + 1};\n                 if (coin.IsSpent() || (coin.IsCoinBase() && mempool_spend_height - coin.nHeight < COINBASE_MATURITY)) {\n-                    should_remove = true;\n-                    break;\n+                    return true;\n                 }\n             }\n         }\n-        // CheckSequenceLocks updates lp. Update the mempool entry LockPoints.\n-        if (!validLP) m_mempool->mapTx.modify(it, update_lock_points(lp));\n-        return should_remove;\n+        // Transaction is still valid and cached LockPoints are updated.\n+        return false;\n     };\n \n     // We also need to remove any now-immature transactions\n-    m_mempool->removeForReorg(m_chain, check_final_and_mature);\n+    m_mempool->removeForReorg(m_chain, filter_final_and_mature);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23976#discussion_r780862952",
      "id" : 780862952,
      "line" : 383,
      "node_id" : "PRRC_kwDOABII584uiwXo",
      "original_commit_id" : "c633c41e3089c44a90f1f8c32a2b411889cefcdf",
      "original_line" : 383,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 57,
      "pull_request_review_id" : 847339618,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23976",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/780862952/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-10T02:25:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/780862952",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23976#discussion_r780863583"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23976"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/780863583"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: this sounds like we're getting rid of final/mature txs.\r\n\r\na little longer but `filter_for_final_and_mature` makes it less ambiguous to me",
      "commit_id" : "c633c41e3089c44a90f1f8c32a2b411889cefcdf",
      "created_at" : "2022-01-10T02:00:54Z",
      "diff_hunk" : "@@ -340,21 +340,29 @@ void CChainState::MaybeUpdateMempoolForReorg(\n     // the disconnectpool that were added back and cleans up the mempool state.\n     m_mempool->UpdateTransactionsFromBlock(vHashUpdate);\n \n-    const auto check_final_and_mature = [this, flags=STANDARD_LOCKTIME_VERIFY_FLAGS](CTxMemPool::txiter it)\n+    // Check whether the transaction is still final and, if it spends a coinbase output, mature.\n+    // Update the entry's cached LockPoints if needed. If this returns true, the tx would be invalid\n+    // in the next block, so the mempool must remove this entry and all of its descendants.\n+    const auto filter_final_and_mature = [this, flags=STANDARD_LOCKTIME_VERIFY_FLAGS](CTxMemPool::txiter it)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23976#discussion_r780863583",
      "id" : 780863583,
      "line" : 346,
      "node_id" : "PRRC_kwDOABII584uiwhf",
      "original_commit_id" : "c633c41e3089c44a90f1f8c32a2b411889cefcdf",
      "original_line" : 346,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 8,
      "pull_request_review_id" : 847339618,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23976",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/780863583/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-10T02:25:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/780863583",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23976#discussion_r780867228"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23976"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/780867228"
         }
      },
      "author_association" : "MEMBER",
      "body" : "while we're here: I'm not sure what this comment block is saying. ",
      "commit_id" : "c633c41e3089c44a90f1f8c32a2b411889cefcdf",
      "created_at" : "2022-01-10T02:25:39Z",
      "diff_hunk" : "@@ -340,21 +340,29 @@ void CChainState::MaybeUpdateMempoolForReorg(\n     // the disconnectpool that were added back and cleans up the mempool state.\n     m_mempool->UpdateTransactionsFromBlock(vHashUpdate);\n \n-    const auto check_final_and_mature = [this, flags=STANDARD_LOCKTIME_VERIFY_FLAGS](CTxMemPool::txiter it)\n+    // Check whether the transaction is still final and, if it spends a coinbase output, mature.\n+    // Update the entry's cached LockPoints if needed. If this returns true, the tx would be invalid\n+    // in the next block, so the mempool must remove this entry and all of its descendants.\n+    const auto filter_final_and_mature = [this, flags=STANDARD_LOCKTIME_VERIFY_FLAGS](CTxMemPool::txiter it)\n         EXCLUSIVE_LOCKS_REQUIRED(m_mempool->cs, ::cs_main) {\n-        bool should_remove = false;\n         AssertLockHeld(m_mempool->cs);\n         AssertLockHeld(::cs_main);\n         const CTransaction& tx = it->GetTx();\n         LockPoints lp = it->GetLockPoints();\n         const bool validLP{TestLockPointValidity(m_chain, lp)};\n         CCoinsViewMemPool view_mempool(&CoinsTip(), *m_mempool);\n-        if (!CheckFinalTx(m_chain.Tip(), tx, flags)\n-            || !CheckSequenceLocks(m_chain.Tip(), view_mempool, tx, flags, &lp, validLP)) {\n-            // Note if CheckSequenceLocks fails the LockPoints may still be invalid\n-            // So it's critical that we remove the tx and not depend on the LockPoints.\n-            should_remove = true;\n-        } else if (it->GetSpendsCoinbase()) {\n+        // The transaction must be final.\n+        if (!CheckFinalTx(m_chain.Tip(), tx, flags)) return true;\n+        // Note if CheckSequenceLocks fails the LockPoints may still be invalid",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23976#discussion_r780867228",
      "id" : 780867228,
      "line" : 356,
      "node_id" : "PRRC_kwDOABII584uixac",
      "original_commit_id" : "c633c41e3089c44a90f1f8c32a2b411889cefcdf",
      "original_line" : 356,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 25,
      "pull_request_review_id" : 847339618,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23976",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/780867228/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-10T02:25:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/780867228",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Sorry for the delay! I've addressed @hebasto and @instagibbs comments and grouped in @hebasto's commit from #23958.",
      "created_at" : "2022-01-17T10:52:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23976#issuecomment-1014386275",
      "id" : 1014386275,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23976",
      "node_id" : "IC_kwDOABII5848dk5j",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1014386275/reactions"
      },
      "updated_at" : "2022-01-17T10:52:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1014386275",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23976#discussion_r785846884"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23976"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/785846884"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed",
      "commit_id" : "283936b10d2e218726648bc9cd640d56d6922bb2",
      "created_at" : "2022-01-17T10:52:30Z",
      "diff_hunk" : "@@ -363,18 +371,16 @@ void CChainState::MaybeUpdateMempoolForReorg(\n                 assert(!coin.IsSpent());\n                 const auto mempool_spend_height{m_chain.Tip()->nHeight + 1};\n                 if (coin.IsSpent() || (coin.IsCoinBase() && mempool_spend_height - coin.nHeight < COINBASE_MATURITY)) {\n-                    should_remove = true;\n-                    break;\n+                    return true;\n                 }\n             }\n         }\n-        // CheckSequenceLocks updates lp. Update the mempool entry LockPoints.\n-        if (!validLP) m_mempool->mapTx.modify(it, update_lock_points(lp));\n-        return should_remove;\n+        // Transaction is still valid and cached LockPoints are updated.\n+        return false;\n     };\n \n     // We also need to remove any now-immature transactions\n-    m_mempool->removeForReorg(m_chain, check_final_and_mature);\n+    m_mempool->removeForReorg(m_chain, filter_final_and_mature);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23976#discussion_r785846884",
      "id" : 785846884,
      "in_reply_to_id" : 780862952,
      "line" : 400,
      "node_id" : "PRRC_kwDOABII584u1xJk",
      "original_commit_id" : "c633c41e3089c44a90f1f8c32a2b411889cefcdf",
      "original_line" : 400,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 65,
      "pull_request_review_id" : 854238523,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23976",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/785846884/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-17T10:54:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/785846884",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23976#discussion_r785847491"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23976"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/785847491"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Clarified the comments so it should be more clear to a first-time reader why the branches are linked",
      "commit_id" : "283936b10d2e218726648bc9cd640d56d6922bb2",
      "created_at" : "2022-01-17T10:52:55Z",
      "diff_hunk" : "@@ -340,21 +340,29 @@ void CChainState::MaybeUpdateMempoolForReorg(\n     // the disconnectpool that were added back and cleans up the mempool state.\n     m_mempool->UpdateTransactionsFromBlock(vHashUpdate);\n \n-    const auto check_final_and_mature = [this, flags=STANDARD_LOCKTIME_VERIFY_FLAGS](CTxMemPool::txiter it)\n+    // Check whether the transaction is still final and, if it spends a coinbase output, mature.\n+    // Update the entry's cached LockPoints if needed. If this returns true, the tx would be invalid\n+    // in the next block, so the mempool must remove this entry and all of its descendants.\n+    const auto filter_final_and_mature = [this, flags=STANDARD_LOCKTIME_VERIFY_FLAGS](CTxMemPool::txiter it)\n         EXCLUSIVE_LOCKS_REQUIRED(m_mempool->cs, ::cs_main) {\n-        bool should_remove = false;\n         AssertLockHeld(m_mempool->cs);\n         AssertLockHeld(::cs_main);\n         const CTransaction& tx = it->GetTx();\n         LockPoints lp = it->GetLockPoints();\n         const bool validLP{TestLockPointValidity(m_chain, lp)};\n         CCoinsViewMemPool view_mempool(&CoinsTip(), *m_mempool);\n-        if (!CheckFinalTx(m_chain.Tip(), tx, flags)\n-            || !CheckSequenceLocks(m_chain.Tip(), view_mempool, tx, flags, &lp, validLP)) {\n-            // Note if CheckSequenceLocks fails the LockPoints may still be invalid\n-            // So it's critical that we remove the tx and not depend on the LockPoints.\n-            should_remove = true;\n-        } else if (it->GetSpendsCoinbase()) {\n+        // The transaction must be final.\n+        if (!CheckFinalTx(m_chain.Tip(), tx, flags)) return true;\n+        // Note if CheckSequenceLocks fails the LockPoints may still be invalid\n+        // So it's critical that we remove the tx and not depend on the LockPoints.\n+        if (!CheckSequenceLocks(m_chain.Tip(), view_mempool, tx, flags, &lp, validLP)) {\n+            return true;\n+        } else if (!validLP) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23976#discussion_r785847491",
      "id" : 785847491,
      "in_reply_to_id" : 778807125,
      "line" : 375,
      "node_id" : "PRRC_kwDOABII584u1xTD",
      "original_commit_id" : "c633c41e3089c44a90f1f8c32a2b411889cefcdf",
      "original_line" : 375,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 35,
      "pull_request_review_id" : 854238523,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23976",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/785847491/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-17T10:54:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/785847491",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23976#discussion_r785849855"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23976"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/785849855"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've updated the comments to make it more clear that this is meant to be a predicate for filtering, so returning `true` for something we want to filter out is natural.",
      "commit_id" : "283936b10d2e218726648bc9cd640d56d6922bb2",
      "created_at" : "2022-01-17T10:54:39Z",
      "diff_hunk" : "@@ -340,21 +340,29 @@ void CChainState::MaybeUpdateMempoolForReorg(\n     // the disconnectpool that were added back and cleans up the mempool state.\n     m_mempool->UpdateTransactionsFromBlock(vHashUpdate);\n \n-    const auto check_final_and_mature = [this, flags=STANDARD_LOCKTIME_VERIFY_FLAGS](CTxMemPool::txiter it)\n+    // Check whether the transaction is still final and, if it spends a coinbase output, mature.\n+    // Update the entry's cached LockPoints if needed. If this returns true, the tx would be invalid\n+    // in the next block, so the mempool must remove this entry and all of its descendants.\n+    const auto filter_final_and_mature = [this, flags=STANDARD_LOCKTIME_VERIFY_FLAGS](CTxMemPool::txiter it)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23976#discussion_r785849855",
      "id" : 785849855,
      "in_reply_to_id" : 780863583,
      "line" : 357,
      "node_id" : "PRRC_kwDOABII584u1x3_",
      "original_commit_id" : "c633c41e3089c44a90f1f8c32a2b411889cefcdf",
      "original_line" : 357,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 10,
      "pull_request_review_id" : 854238523,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23976",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/785849855/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-17T10:54:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/785849855",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23976#discussion_r785850447"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23976"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/785850447"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Better now?",
      "commit_id" : "283936b10d2e218726648bc9cd640d56d6922bb2",
      "created_at" : "2022-01-17T10:55:05Z",
      "diff_hunk" : "@@ -340,21 +340,29 @@ void CChainState::MaybeUpdateMempoolForReorg(\n     // the disconnectpool that were added back and cleans up the mempool state.\n     m_mempool->UpdateTransactionsFromBlock(vHashUpdate);\n \n-    const auto check_final_and_mature = [this, flags=STANDARD_LOCKTIME_VERIFY_FLAGS](CTxMemPool::txiter it)\n+    // Check whether the transaction is still final and, if it spends a coinbase output, mature.\n+    // Update the entry's cached LockPoints if needed. If this returns true, the tx would be invalid\n+    // in the next block, so the mempool must remove this entry and all of its descendants.\n+    const auto filter_final_and_mature = [this, flags=STANDARD_LOCKTIME_VERIFY_FLAGS](CTxMemPool::txiter it)\n         EXCLUSIVE_LOCKS_REQUIRED(m_mempool->cs, ::cs_main) {\n-        bool should_remove = false;\n         AssertLockHeld(m_mempool->cs);\n         AssertLockHeld(::cs_main);\n         const CTransaction& tx = it->GetTx();\n         LockPoints lp = it->GetLockPoints();\n         const bool validLP{TestLockPointValidity(m_chain, lp)};\n         CCoinsViewMemPool view_mempool(&CoinsTip(), *m_mempool);\n-        if (!CheckFinalTx(m_chain.Tip(), tx, flags)\n-            || !CheckSequenceLocks(m_chain.Tip(), view_mempool, tx, flags, &lp, validLP)) {\n-            // Note if CheckSequenceLocks fails the LockPoints may still be invalid\n-            // So it's critical that we remove the tx and not depend on the LockPoints.\n-            should_remove = true;\n-        } else if (it->GetSpendsCoinbase()) {\n+        // The transaction must be final.\n+        if (!CheckFinalTx(m_chain.Tip(), tx, flags)) return true;\n+        // Note if CheckSequenceLocks fails the LockPoints may still be invalid",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23976#discussion_r785850447",
      "id" : 785850447,
      "in_reply_to_id" : 780867228,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584u1yBP",
      "original_commit_id" : "c633c41e3089c44a90f1f8c32a2b411889cefcdf",
      "original_line" : 356,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 854241433,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23976",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/785850447/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-17T10:55:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/785850447",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23976#discussion_r785878663"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23976"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/785878663"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yes the comment you left actually matches my understanding of the code",
      "commit_id" : "283936b10d2e218726648bc9cd640d56d6922bb2",
      "created_at" : "2022-01-17T11:21:49Z",
      "diff_hunk" : "@@ -340,21 +340,29 @@ void CChainState::MaybeUpdateMempoolForReorg(\n     // the disconnectpool that were added back and cleans up the mempool state.\n     m_mempool->UpdateTransactionsFromBlock(vHashUpdate);\n \n-    const auto check_final_and_mature = [this, flags=STANDARD_LOCKTIME_VERIFY_FLAGS](CTxMemPool::txiter it)\n+    // Check whether the transaction is still final and, if it spends a coinbase output, mature.\n+    // Update the entry's cached LockPoints if needed. If this returns true, the tx would be invalid\n+    // in the next block, so the mempool must remove this entry and all of its descendants.\n+    const auto filter_final_and_mature = [this, flags=STANDARD_LOCKTIME_VERIFY_FLAGS](CTxMemPool::txiter it)\n         EXCLUSIVE_LOCKS_REQUIRED(m_mempool->cs, ::cs_main) {\n-        bool should_remove = false;\n         AssertLockHeld(m_mempool->cs);\n         AssertLockHeld(::cs_main);\n         const CTransaction& tx = it->GetTx();\n         LockPoints lp = it->GetLockPoints();\n         const bool validLP{TestLockPointValidity(m_chain, lp)};\n         CCoinsViewMemPool view_mempool(&CoinsTip(), *m_mempool);\n-        if (!CheckFinalTx(m_chain.Tip(), tx, flags)\n-            || !CheckSequenceLocks(m_chain.Tip(), view_mempool, tx, flags, &lp, validLP)) {\n-            // Note if CheckSequenceLocks fails the LockPoints may still be invalid\n-            // So it's critical that we remove the tx and not depend on the LockPoints.\n-            should_remove = true;\n-        } else if (it->GetSpendsCoinbase()) {\n+        // The transaction must be final.\n+        if (!CheckFinalTx(m_chain.Tip(), tx, flags)) return true;\n+        // Note if CheckSequenceLocks fails the LockPoints may still be invalid",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23976#discussion_r785878663",
      "id" : 785878663,
      "in_reply_to_id" : 780867228,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584u146H",
      "original_commit_id" : "c633c41e3089c44a90f1f8c32a2b411889cefcdf",
      "original_line" : 356,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 854269206,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23976",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/785878663/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-17T11:21:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/785878663",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> It looks like some changes that belong to the second commit--a replacing `update_lock_points` with a lambda--go to the first commit accidentally, no?\r\n\r\nOops! Good catch, fixed.",
      "created_at" : "2022-01-18T11:57:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23976#issuecomment-1015341062",
      "id" : 1015341062,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23976",
      "node_id" : "IC_kwDOABII5848hOAG",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1015341062/reactions"
      },
      "updated_at" : "2022-01-18T11:57:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1015341062",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23976#discussion_r787758193"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23976"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/787758193"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: any reason to check for `coin.IsSpent()`, given the assertion?",
      "commit_id" : "e177fcab3831b6d259da5164cabedcc9e78f6957",
      "created_at" : "2022-01-19T13:44:54Z",
      "diff_hunk" : "@@ -372,18 +388,16 @@ void CChainState::MaybeUpdateMempoolForReorg(\n                 assert(!coin.IsSpent());\n                 const auto mempool_spend_height{m_chain.Tip()->nHeight + 1};\n                 if (coin.IsSpent() || (coin.IsCoinBase() && mempool_spend_height - coin.nHeight < COINBASE_MATURITY)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23976#discussion_r787758193",
      "id" : 787758193,
      "line" : 390,
      "node_id" : "PRRC_kwDOABII584u9Dxx",
      "original_commit_id" : "c7cd98c7176800a51e6a6b3634a26b508aa33ff2",
      "original_line" : 390,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 49,
      "pull_request_review_id" : 856811822,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23976",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/787758193/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-19T13:45:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/787758193",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
