[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK\r\n\r\nTIL Witness Replacement",
      "created_at" : "2021-08-10T14:48:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#issuecomment-896093753",
      "id" : 896093753,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22675",
      "node_id" : "IC_kwDOABII5841aU45",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-10T14:48:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/896093753",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19157360?v=4",
         "events_url" : "https://api.github.com/users/0xB10C/events{/privacy}",
         "followers_url" : "https://api.github.com/users/0xB10C/followers",
         "following_url" : "https://api.github.com/users/0xB10C/following{/other_user}",
         "gists_url" : "https://api.github.com/users/0xB10C/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/0xB10C",
         "id" : 19157360,
         "login" : "0xB10C",
         "node_id" : "MDQ6VXNlcjE5MTU3MzYw",
         "organizations_url" : "https://api.github.com/users/0xB10C/orgs",
         "received_events_url" : "https://api.github.com/users/0xB10C/received_events",
         "repos_url" : "https://api.github.com/users/0xB10C/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/0xB10C/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/0xB10C/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/0xB10C"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "A new circular dependency `policy/rbf -> txmempool -> validation -> policy/rbf` is introduced here, so I've added it to `EXPECTED_CIRCULAR_DEPENDENCIES` to suppress the issue. I understand this is not ideal. The main problem, I think, is the txmempool -> validation part (which already exists), so I've taken a crack at it in #22677.",
      "created_at" : "2021-08-10T16:33:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#issuecomment-896133317",
      "id" : 896133317,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22675",
      "node_id" : "IC_kwDOABII5841aejF",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-10T16:33:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/896133317",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#22855](https://github.com/bitcoin/bitcoin/pull/22855) (RBF move 3/3: improve RBF documentation by glozow)\n* [#22674](https://github.com/bitcoin/bitcoin/pull/22674) (validation: mempool validation and submission for packages of 1 child + parents by glozow)\n* [#22539](https://github.com/bitcoin/bitcoin/pull/22539) (Re-include RBF replacement txs in fee estimation by darosior)\n* [#22290](https://github.com/bitcoin/bitcoin/pull/22290) (Package Mempool Submission with Package Fee-Bumping by glozow)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-08-10T18:53:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#issuecomment-896233882",
      "id" : 896233882,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22675",
      "node_id" : "IC_kwDOABII5841a3Ga",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-03T01:41:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/896233882",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2021-08-11T02:45:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#issuecomment-896457050",
      "id" : 896457050,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22675",
      "node_id" : "IC_kwDOABII5841btla",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-11T02:45:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/896457050",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r686672590"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686672590"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Any reason this shouldn't go in `policy/policy.h`? It would get rid of the circular dependency as well\r\n\r\nAs precedent, we do have at least one BIP 125 specific constant there:\r\n```c++\r\n/** Default for -incrementalrelayfee, which sets the minimum feerate increase for mempool limiting or BIP 125 replacement **/\r\nstatic const unsigned int DEFAULT_INCREMENTAL_RELAY_FEE = 1000;\r\n```",
      "commit_id" : "520d3efda0128c3e87f5f56f1c282d0e8b295d49",
      "created_at" : "2021-08-11T09:45:21Z",
      "diff_hunk" : "@@ -7,6 +7,10 @@\n \n #include <txmempool.h>\n \n+/** Maximum number of transactions that can be replaced by BIP125 RBF (Rule #5). This includes all\n+ * mempool conflicts and their descendants. */\n+static constexpr uint32_t MAX_BIP125_REPLACEMENT_CANDIDATES{100};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r686672590",
      "id" : 686672590,
      "line" : 13,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NjY3MjU5MA==",
      "original_commit_id" : "94655e96a43def6125fb602251313f1ab7693229",
      "original_line" : 12,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/policy/rbf.h",
      "position" : 8,
      "pull_request_review_id" : 727275844,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-11T11:05:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686672590",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r686678031"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686678031"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re 76354e503c039ae9c7e0d0f93191b211d699478c, nice ð I had the same thought when reading this code that it'd be more efficient to do something like this",
      "commit_id" : "520d3efda0128c3e87f5f56f1c282d0e8b295d49",
      "created_at" : "2021-08-11T09:52:42Z",
      "diff_hunk" : "@@ -835,33 +835,36 @@ bool MemPoolAccept::PreChecks(ATMPArgs& args, Workspace& ws)\n                             newFeeRate.ToString(),\n                             oldFeeRate.ToString()));\n             }\n+        }\n+\n+        for (const auto& mi : setIterConflicting) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r686678031",
      "id" : 686678031,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NjY3ODAzMQ==",
      "original_commit_id" : "76354e503c039ae9c7e0d0f93191b211d699478c",
      "original_line" : 840,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 727275844,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-11T11:05:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686678031",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r686711392"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686711392"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I guess the reason it may overestimate here is due to the same descendant being counted multiple times when multiple conflicting parents share that same descendant?",
      "commit_id" : "520d3efda0128c3e87f5f56f1c282d0e8b295d49",
      "created_at" : "2021-08-11T10:41:33Z",
      "diff_hunk" : "@@ -42,3 +46,38 @@ RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx)\n     // If we don't have a local mempool we can only check the transaction itself.\n     return SignalsOptInRBF(tx) ? RBFTransactionState::REPLACEABLE_BIP125 : RBFTransactionState::UNKNOWN;\n }\n+\n+bool GetEntriesForRBF(const CTransaction& tx, CTxMemPool& m_pool,\n+                      const CTxMemPool::setEntries setIterConflicting,\n+                      TxValidationState& state, CTxMemPool::setEntries& allConflicting)\n+{\n+    AssertLockHeld(m_pool.cs);\n+    const uint256 hash = tx.GetHash();\n+    std::set<uint256> setConflictsParents;\n+    uint64_t nConflictingCount = 0;\n+    for (const auto& mi : setIterConflicting) {\n+        for (const CTxIn &txin : mi->GetTx().vin)\n+        {\n+            setConflictsParents.insert(txin.prevout.hash);\n+        }\n+\n+        nConflictingCount += mi->GetCountWithDescendants();\n+        // This potentially overestimates the number of actual descendants",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r686711392",
      "id" : 686711392,
      "line" : 90,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NjcxMTM5Mg==",
      "original_commit_id" : "b003c8da7539183fc22bcfdbb154b2cb17c2648e",
      "original_line" : 65,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/policy/rbf.cpp",
      "position" : 59,
      "pull_request_review_id" : 727275844,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-11T11:05:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686711392",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r686712403"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686712403"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Is this necessary? Can't we just use `!SignalsOptInRBF` from `util/rbf.h`?\r\n\r\nNote: I realize this is a move only PR, but I'm just wondering, maybe it's a minor refactor later",
      "commit_id" : "520d3efda0128c3e87f5f56f1c282d0e8b295d49",
      "created_at" : "2021-08-11T10:43:07Z",
      "diff_hunk" : "@@ -47,6 +47,29 @@ RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx)\n     return SignalsOptInRBF(tx) ? RBFTransactionState::REPLACEABLE_BIP125 : RBFTransactionState::UNKNOWN;\n }\n \n+bool IsRBFOptOut(const CTransaction& txConflicting)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r686712403",
      "id" : 686712403,
      "line" : 52,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NjcxMjQwMw==",
      "original_commit_id" : "aa30c6f7d6eb62c1466d5272b39ee3d7e437cbda",
      "original_line" : 50,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/policy/rbf.cpp",
      "position" : 21,
      "pull_request_review_id" : 727275844,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-11T11:05:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686712403",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r686717457"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686717457"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: I'm sure if `util/rbf.h` existence is justified in the first place, but if we go with the current convention, `IsRBFOptOut` would seem to belong there",
      "commit_id" : "520d3efda0128c3e87f5f56f1c282d0e8b295d49",
      "created_at" : "2021-08-11T10:51:05Z",
      "diff_hunk" : "@@ -47,6 +47,29 @@ RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx)\n     return SignalsOptInRBF(tx) ? RBFTransactionState::REPLACEABLE_BIP125 : RBFTransactionState::UNKNOWN;\n }\n \n+bool IsRBFOptOut(const CTransaction& txConflicting)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r686717457",
      "id" : 686717457,
      "in_reply_to_id" : 686712403,
      "line" : 52,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NjcxNzQ1Nw==",
      "original_commit_id" : "aa30c6f7d6eb62c1466d5272b39ee3d7e437cbda",
      "original_line" : 50,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/policy/rbf.cpp",
      "position" : 21,
      "pull_request_review_id" : 727275844,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-11T11:05:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686717457",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r686721462"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686721462"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "We are populating `setConflictsParents` in this method, but we never use it",
      "commit_id" : "520d3efda0128c3e87f5f56f1c282d0e8b295d49",
      "created_at" : "2021-08-11T10:57:29Z",
      "diff_hunk" : "@@ -42,3 +48,174 @@ RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx)\n     // If we don't have a local mempool we can only check the transaction itself.\n     return SignalsOptInRBF(tx) ? RBFTransactionState::REPLACEABLE_BIP125 : RBFTransactionState::UNKNOWN;\n }\n+\n+bool IsRBFOptOut(const CTransaction& txConflicting)\n+{\n+    // Allow opt-out of transaction replacement by setting\n+    // nSequence > MAX_BIP125_RBF_SEQUENCE (SEQUENCE_FINAL-2) on all inputs.\n+    //\n+    // SEQUENCE_FINAL-1 is picked to still allow use of nLockTime by\n+    // non-replaceable transactions. All inputs rather than just one\n+    // is for the sake of multi-party protocols, where we don't\n+    // want a single party to be able to disable replacement.\n+    //\n+    // Transactions that don't explicitly signal replaceability are\n+    // *not* replaceable with the current logic, even if one of their\n+    // unconfirmed ancestors signals replaceability. This diverges\n+    // from BIP125's inherited signaling description (see CVE-2021-31876).\n+    // Applications relying on first-seen mempool behavior should\n+    // check all unconfirmed ancestors; otherwise an opt-in ancestor\n+    // might be replaced, causing removal of this descendant.\n+    for (const CTxIn &_txin : txConflicting.vin) {\n+        if (_txin.nSequence <= MAX_BIP125_RBF_SEQUENCE) return false;\n+    }\n+    return true;\n+}\n+\n+bool GetEntriesForRBF(const CTransaction& tx, CTxMemPool& m_pool,\n+                      const CTxMemPool::setEntries setIterConflicting,\n+                      TxValidationState& state, CTxMemPool::setEntries& allConflicting)\n+{\n+    AssertLockHeld(m_pool.cs);\n+    const uint256 hash = tx.GetHash();\n+    std::set<uint256> setConflictsParents;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r686721462",
      "id" : 686721462,
      "line" : 81,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NjcyMTQ2Mg==",
      "original_commit_id" : "520d3efda0128c3e87f5f56f1c282d0e8b295d49",
      "original_line" : 81,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/policy/rbf.cpp",
      "position" : 50,
      "pull_request_review_id" : 727275844,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-11T11:05:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686721462",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r686722096"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686722096"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Now we are populating `setConflictsParents` again, the same way we did in `GetEntriesForRBF`, but we use it here",
      "commit_id" : "520d3efda0128c3e87f5f56f1c282d0e8b295d49",
      "created_at" : "2021-08-11T10:58:27Z",
      "diff_hunk" : "@@ -42,3 +48,174 @@ RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx)\n     // If we don't have a local mempool we can only check the transaction itself.\n     return SignalsOptInRBF(tx) ? RBFTransactionState::REPLACEABLE_BIP125 : RBFTransactionState::UNKNOWN;\n }\n+\n+bool IsRBFOptOut(const CTransaction& txConflicting)\n+{\n+    // Allow opt-out of transaction replacement by setting\n+    // nSequence > MAX_BIP125_RBF_SEQUENCE (SEQUENCE_FINAL-2) on all inputs.\n+    //\n+    // SEQUENCE_FINAL-1 is picked to still allow use of nLockTime by\n+    // non-replaceable transactions. All inputs rather than just one\n+    // is for the sake of multi-party protocols, where we don't\n+    // want a single party to be able to disable replacement.\n+    //\n+    // Transactions that don't explicitly signal replaceability are\n+    // *not* replaceable with the current logic, even if one of their\n+    // unconfirmed ancestors signals replaceability. This diverges\n+    // from BIP125's inherited signaling description (see CVE-2021-31876).\n+    // Applications relying on first-seen mempool behavior should\n+    // check all unconfirmed ancestors; otherwise an opt-in ancestor\n+    // might be replaced, causing removal of this descendant.\n+    for (const CTxIn &_txin : txConflicting.vin) {\n+        if (_txin.nSequence <= MAX_BIP125_RBF_SEQUENCE) return false;\n+    }\n+    return true;\n+}\n+\n+bool GetEntriesForRBF(const CTransaction& tx, CTxMemPool& m_pool,\n+                      const CTxMemPool::setEntries setIterConflicting,\n+                      TxValidationState& state, CTxMemPool::setEntries& allConflicting)\n+{\n+    AssertLockHeld(m_pool.cs);\n+    const uint256 hash = tx.GetHash();\n+    std::set<uint256> setConflictsParents;\n+    uint64_t nConflictingCount = 0;\n+    for (const auto& mi : setIterConflicting) {\n+        for (const CTxIn &txin : mi->GetTx().vin)\n+        {\n+            setConflictsParents.insert(txin.prevout.hash);\n+        }\n+\n+        nConflictingCount += mi->GetCountWithDescendants();\n+        // This potentially overestimates the number of actual descendants\n+        // but we just want to be conservative to avoid doing too much\n+        // work.\n+        if (nConflictingCount > MAX_BIP125_REPLACEMENT_CANDIDATES) {\n+            return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"too many potential replacements\",\n+                    strprintf(\"rejecting replacement %s; too many potential replacements (%d > %d)\\n\",\n+                        hash.ToString(),\n+                        nConflictingCount,\n+                        MAX_BIP125_REPLACEMENT_CANDIDATES));\n+        }\n+    }\n+    // If not too many to replace, then calculate the set of\n+    // transactions that would have to be evicted\n+    for (CTxMemPool::txiter it : setIterConflicting) {\n+        m_pool.CalculateDescendants(it, allConflicting);\n+    }\n+    return true;\n+}\n+\n+bool HasNoNewUnconfirmed(const CTransaction& tx, CTxMemPool& m_pool,\n+                         const CTxMemPool::setEntries setIterConflicting, TxValidationState& state)\n+{\n+    AssertLockHeld(m_pool.cs);\n+    std::set<uint256> setConflictsParents;\n+    for (const auto& mi : setIterConflicting) {\n+        for (const CTxIn &txin : mi->GetTx().vin)\n+        {\n+            setConflictsParents.insert(txin.prevout.hash);\n+        }\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r686722096",
      "id" : 686722096,
      "line" : 119,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NjcyMjA5Ng==",
      "original_commit_id" : "520d3efda0128c3e87f5f56f1c282d0e8b295d49",
      "original_line" : 119,
      "original_position" : 88,
      "original_start_line" : 113,
      "path" : "src/policy/rbf.cpp",
      "position" : 88,
      "pull_request_review_id" : 727275844,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : 113,
      "start_side" : "RIGHT",
      "updated_at" : "2021-08-11T11:05:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686722096",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r686725070"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686725070"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Note: `nConflictingSize` is an unused variable",
      "commit_id" : "520d3efda0128c3e87f5f56f1c282d0e8b295d49",
      "created_at" : "2021-08-11T11:03:17Z",
      "diff_hunk" : "@@ -42,3 +48,174 @@ RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx)\n     // If we don't have a local mempool we can only check the transaction itself.\n     return SignalsOptInRBF(tx) ? RBFTransactionState::REPLACEABLE_BIP125 : RBFTransactionState::UNKNOWN;\n }\n+\n+bool IsRBFOptOut(const CTransaction& txConflicting)\n+{\n+    // Allow opt-out of transaction replacement by setting\n+    // nSequence > MAX_BIP125_RBF_SEQUENCE (SEQUENCE_FINAL-2) on all inputs.\n+    //\n+    // SEQUENCE_FINAL-1 is picked to still allow use of nLockTime by\n+    // non-replaceable transactions. All inputs rather than just one\n+    // is for the sake of multi-party protocols, where we don't\n+    // want a single party to be able to disable replacement.\n+    //\n+    // Transactions that don't explicitly signal replaceability are\n+    // *not* replaceable with the current logic, even if one of their\n+    // unconfirmed ancestors signals replaceability. This diverges\n+    // from BIP125's inherited signaling description (see CVE-2021-31876).\n+    // Applications relying on first-seen mempool behavior should\n+    // check all unconfirmed ancestors; otherwise an opt-in ancestor\n+    // might be replaced, causing removal of this descendant.\n+    for (const CTxIn &_txin : txConflicting.vin) {\n+        if (_txin.nSequence <= MAX_BIP125_RBF_SEQUENCE) return false;\n+    }\n+    return true;\n+}\n+\n+bool GetEntriesForRBF(const CTransaction& tx, CTxMemPool& m_pool,\n+                      const CTxMemPool::setEntries setIterConflicting,\n+                      TxValidationState& state, CTxMemPool::setEntries& allConflicting)\n+{\n+    AssertLockHeld(m_pool.cs);\n+    const uint256 hash = tx.GetHash();\n+    std::set<uint256> setConflictsParents;\n+    uint64_t nConflictingCount = 0;\n+    for (const auto& mi : setIterConflicting) {\n+        for (const CTxIn &txin : mi->GetTx().vin)\n+        {\n+            setConflictsParents.insert(txin.prevout.hash);\n+        }\n+\n+        nConflictingCount += mi->GetCountWithDescendants();\n+        // This potentially overestimates the number of actual descendants\n+        // but we just want to be conservative to avoid doing too much\n+        // work.\n+        if (nConflictingCount > MAX_BIP125_REPLACEMENT_CANDIDATES) {\n+            return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"too many potential replacements\",\n+                    strprintf(\"rejecting replacement %s; too many potential replacements (%d > %d)\\n\",\n+                        hash.ToString(),\n+                        nConflictingCount,\n+                        MAX_BIP125_REPLACEMENT_CANDIDATES));\n+        }\n+    }\n+    // If not too many to replace, then calculate the set of\n+    // transactions that would have to be evicted\n+    for (CTxMemPool::txiter it : setIterConflicting) {\n+        m_pool.CalculateDescendants(it, allConflicting);\n+    }\n+    return true;\n+}\n+\n+bool HasNoNewUnconfirmed(const CTransaction& tx, CTxMemPool& m_pool,\n+                         const CTxMemPool::setEntries setIterConflicting, TxValidationState& state)\n+{\n+    AssertLockHeld(m_pool.cs);\n+    std::set<uint256> setConflictsParents;\n+    for (const auto& mi : setIterConflicting) {\n+        for (const CTxIn &txin : mi->GetTx().vin)\n+        {\n+            setConflictsParents.insert(txin.prevout.hash);\n+        }\n+    }\n+\n+    for (unsigned int j = 0; j < tx.vin.size(); j++)\n+    {\n+        // We don't want to accept replacements that require low\n+        // feerate junk to be mined first. Ideally we'd keep track of\n+        // the ancestor feerates and make the decision based on that,\n+        // but for now requiring all new inputs to be confirmed works.\n+        //\n+        // Note that if you relax this to make RBF a little more useful,\n+        // this may break the CalculateMempoolAncestors RBF relaxation,\n+        // above. See the comment above the first CalculateMempoolAncestors\n+        // call for more info.\n+        if (!setConflictsParents.count(tx.vin[j].prevout.hash))\n+        {\n+            // Rather than check the UTXO set - potentially expensive -\n+            // it's cheaper to just check if the new input refers to a\n+            // tx that's in the mempool.\n+            if (m_pool.exists(tx.vin[j].prevout.hash)) {\n+                return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"replacement-adds-unconfirmed\",\n+                        strprintf(\"replacement %s adds unconfirmed input, idx %d\",\n+                            tx.GetHash().ToString(), j));\n+            }\n+        }\n+    }\n+    return true;\n+}\n+\n+bool SpendsAndConflictsDisjoint(CTxMemPool::setEntries& setAncestors, std::set<uint256> setConflicts,\n+                                TxValidationState& state, const uint256& hash)\n+{\n+    for (CTxMemPool::txiter ancestorIt : setAncestors)\n+    {\n+        const uint256 &hashAncestor = ancestorIt->GetTx().GetHash();\n+        if (setConflicts.count(hashAncestor))\n+        {\n+            return state.Invalid(TxValidationResult::TX_CONSENSUS, \"bad-txns-spends-conflicting-tx\",\n+                    strprintf(\"%s spends conflicting transaction %s\",\n+                        hash.ToString(),\n+                        hashAncestor.ToString()));\n+        }\n+    }\n+    return true;\n+}\n+\n+bool PaysMoreThanConflicts(const CTxMemPool::setEntries& setIterConflicting, CFeeRate newFeeRate,\n+                           TxValidationState& state, const uint256& hash)\n+{\n+    for (const auto& mi : setIterConflicting) {\n+        // Don't allow the replacement to reduce the feerate of the\n+        // mempool.\n+        //\n+        // We usually don't want to accept replacements with lower\n+        // feerates than what they replaced as that would lower the\n+        // feerate of the next block. Requiring that the feerate always\n+        // be increased is also an easy-to-reason about way to prevent\n+        // DoS attacks via replacements.\n+        //\n+        // We only consider the feerates of transactions being directly\n+        // replaced, not their indirect descendants. While that does\n+        // mean high feerate children are ignored when deciding whether\n+        // or not to replace, we do require the replacement to pay more\n+        // overall fees too, mitigating most cases.\n+        CFeeRate oldFeeRate(mi->GetModifiedFee(), mi->GetTxSize());\n+        if (newFeeRate <= oldFeeRate)\n+        {\n+            return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"insufficient fee\",\n+                    strprintf(\"rejecting replacement %s; new feerate %s <= old feerate %s\",\n+                        hash.ToString(),\n+                        newFeeRate.ToString(),\n+                        oldFeeRate.ToString()));\n+        }\n+    }\n+    return true;\n+}\n+\n+bool PaysForRBF(CAmount nConflictingFees, size_t nConflictingSize,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r686725070",
      "id" : 686725070,
      "line" : 195,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NjcyNTA3MA==",
      "original_commit_id" : "520d3efda0128c3e87f5f56f1c282d0e8b295d49",
      "original_line" : 195,
      "original_position" : 164,
      "original_start_line" : null,
      "path" : "src/policy/rbf.cpp",
      "position" : 164,
      "pull_request_review_id" : 727275844,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-11T11:05:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686725070",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r686859852"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686859852"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hm, I think everything in util/rbf should be moved to policy/rbf actually :thinking: There's no reason to have two places for RBF (I think) and organization-wise, all RBF logic and code is policy.",
      "commit_id" : "6a0a8ef791400d78fb4192a81a392131be78270b",
      "created_at" : "2021-08-11T13:59:36Z",
      "diff_hunk" : "@@ -47,6 +47,29 @@ RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx)\n     return SignalsOptInRBF(tx) ? RBFTransactionState::REPLACEABLE_BIP125 : RBFTransactionState::UNKNOWN;\n }\n \n+bool IsRBFOptOut(const CTransaction& txConflicting)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r686859852",
      "id" : 686859852,
      "in_reply_to_id" : 686712403,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4Njg1OTg1Mg==",
      "original_commit_id" : "aa30c6f7d6eb62c1466d5272b39ee3d7e437cbda",
      "original_line" : 50,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/policy/rbf.cpp",
      "position" : null,
      "pull_request_review_id" : 727523177,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-11T13:59:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686859852",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r686862622"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686862622"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It wouldn't get rid of the circular dependency unfortunately, because it's caused by validation.cpp including policy/rbf.h",
      "commit_id" : "6a0a8ef791400d78fb4192a81a392131be78270b",
      "created_at" : "2021-08-11T14:02:25Z",
      "diff_hunk" : "@@ -7,6 +7,10 @@\n \n #include <txmempool.h>\n \n+/** Maximum number of transactions that can be replaced by BIP125 RBF (Rule #5). This includes all\n+ * mempool conflicts and their descendants. */\n+static constexpr uint32_t MAX_BIP125_REPLACEMENT_CANDIDATES{100};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r686862622",
      "id" : 686862622,
      "in_reply_to_id" : 686672590,
      "line" : 13,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4Njg2MjYyMg==",
      "original_commit_id" : "94655e96a43def6125fb602251313f1ab7693229",
      "original_line" : 13,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/policy/rbf.h",
      "position" : 8,
      "pull_request_review_id" : 727526907,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-11T14:02:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686862622",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r686863065"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686863065"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes, that's exactly right.",
      "commit_id" : "6a0a8ef791400d78fb4192a81a392131be78270b",
      "created_at" : "2021-08-11T14:02:51Z",
      "diff_hunk" : "@@ -42,3 +46,38 @@ RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx)\n     // If we don't have a local mempool we can only check the transaction itself.\n     return SignalsOptInRBF(tx) ? RBFTransactionState::REPLACEABLE_BIP125 : RBFTransactionState::UNKNOWN;\n }\n+\n+bool GetEntriesForRBF(const CTransaction& tx, CTxMemPool& m_pool,\n+                      const CTxMemPool::setEntries setIterConflicting,\n+                      TxValidationState& state, CTxMemPool::setEntries& allConflicting)\n+{\n+    AssertLockHeld(m_pool.cs);\n+    const uint256 hash = tx.GetHash();\n+    std::set<uint256> setConflictsParents;\n+    uint64_t nConflictingCount = 0;\n+    for (const auto& mi : setIterConflicting) {\n+        for (const CTxIn &txin : mi->GetTx().vin)\n+        {\n+            setConflictsParents.insert(txin.prevout.hash);\n+        }\n+\n+        nConflictingCount += mi->GetCountWithDescendants();\n+        // This potentially overestimates the number of actual descendants",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r686863065",
      "id" : 686863065,
      "in_reply_to_id" : 686711392,
      "line" : 61,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4Njg2MzA2NQ==",
      "original_commit_id" : "b003c8da7539183fc22bcfdbb154b2cb17c2648e",
      "original_line" : 61,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/policy/rbf.cpp",
      "position" : 30,
      "pull_request_review_id" : 727527469,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-11T14:02:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686863065",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r686883898"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686883898"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not sure, it would make all users of policy/rbf depend on txmempool. Eg not sure the standalone binaries `wallet-util` and friends depend on it although they use util/rbf.",
      "commit_id" : "6a0a8ef791400d78fb4192a81a392131be78270b",
      "created_at" : "2021-08-11T14:25:20Z",
      "diff_hunk" : "@@ -47,6 +47,29 @@ RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx)\n     return SignalsOptInRBF(tx) ? RBFTransactionState::REPLACEABLE_BIP125 : RBFTransactionState::UNKNOWN;\n }\n \n+bool IsRBFOptOut(const CTransaction& txConflicting)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r686883898",
      "id" : 686883898,
      "in_reply_to_id" : 686712403,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4Njg4Mzg5OA==",
      "original_commit_id" : "aa30c6f7d6eb62c1466d5272b39ee3d7e437cbda",
      "original_line" : 50,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/policy/rbf.cpp",
      "position" : null,
      "pull_request_review_id" : 727556139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-11T14:25:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686883898",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22457751?v=4",
         "events_url" : "https://api.github.com/users/darosior/events{/privacy}",
         "followers_url" : "https://api.github.com/users/darosior/followers",
         "following_url" : "https://api.github.com/users/darosior/following{/other_user}",
         "gists_url" : "https://api.github.com/users/darosior/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/darosior",
         "id" : 22457751,
         "login" : "darosior",
         "node_id" : "MDQ6VXNlcjIyNDU3NzUx",
         "organizations_url" : "https://api.github.com/users/darosior/orgs",
         "received_events_url" : "https://api.github.com/users/darosior/received_events",
         "repos_url" : "https://api.github.com/users/darosior/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/darosior/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/darosior/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/darosior"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r686916506"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686916506"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ahh good point @darosior. I was wrong. I think it makes sense for policy/* to depend on mempool, but I see how util/rbf is needed now.",
      "commit_id" : "6a0a8ef791400d78fb4192a81a392131be78270b",
      "created_at" : "2021-08-11T15:00:07Z",
      "diff_hunk" : "@@ -47,6 +47,29 @@ RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx)\n     return SignalsOptInRBF(tx) ? RBFTransactionState::REPLACEABLE_BIP125 : RBFTransactionState::UNKNOWN;\n }\n \n+bool IsRBFOptOut(const CTransaction& txConflicting)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r686916506",
      "id" : 686916506,
      "in_reply_to_id" : 686712403,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NjkxNjUwNg==",
      "original_commit_id" : "aa30c6f7d6eb62c1466d5272b39ee3d7e437cbda",
      "original_line" : 50,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/policy/rbf.cpp",
      "position" : null,
      "pull_request_review_id" : 727600345,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-11T15:05:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686916506",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r686924148"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686924148"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Oopsie good catch! did a few different attempts at moving BIP125, this is leftover from a previous one :sweat_smile: ",
      "commit_id" : "6a0a8ef791400d78fb4192a81a392131be78270b",
      "created_at" : "2021-08-11T15:08:44Z",
      "diff_hunk" : "@@ -42,3 +48,174 @@ RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx)\n     // If we don't have a local mempool we can only check the transaction itself.\n     return SignalsOptInRBF(tx) ? RBFTransactionState::REPLACEABLE_BIP125 : RBFTransactionState::UNKNOWN;\n }\n+\n+bool IsRBFOptOut(const CTransaction& txConflicting)\n+{\n+    // Allow opt-out of transaction replacement by setting\n+    // nSequence > MAX_BIP125_RBF_SEQUENCE (SEQUENCE_FINAL-2) on all inputs.\n+    //\n+    // SEQUENCE_FINAL-1 is picked to still allow use of nLockTime by\n+    // non-replaceable transactions. All inputs rather than just one\n+    // is for the sake of multi-party protocols, where we don't\n+    // want a single party to be able to disable replacement.\n+    //\n+    // Transactions that don't explicitly signal replaceability are\n+    // *not* replaceable with the current logic, even if one of their\n+    // unconfirmed ancestors signals replaceability. This diverges\n+    // from BIP125's inherited signaling description (see CVE-2021-31876).\n+    // Applications relying on first-seen mempool behavior should\n+    // check all unconfirmed ancestors; otherwise an opt-in ancestor\n+    // might be replaced, causing removal of this descendant.\n+    for (const CTxIn &_txin : txConflicting.vin) {\n+        if (_txin.nSequence <= MAX_BIP125_RBF_SEQUENCE) return false;\n+    }\n+    return true;\n+}\n+\n+bool GetEntriesForRBF(const CTransaction& tx, CTxMemPool& m_pool,\n+                      const CTxMemPool::setEntries setIterConflicting,\n+                      TxValidationState& state, CTxMemPool::setEntries& allConflicting)\n+{\n+    AssertLockHeld(m_pool.cs);\n+    const uint256 hash = tx.GetHash();\n+    std::set<uint256> setConflictsParents;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r686924148",
      "id" : 686924148,
      "in_reply_to_id" : 686721462,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NjkyNDE0OA==",
      "original_commit_id" : "520d3efda0128c3e87f5f56f1c282d0e8b295d49",
      "original_line" : 81,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/policy/rbf.cpp",
      "position" : null,
      "pull_request_review_id" : 727610919,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-11T15:08:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686924148",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r686924532"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686924532"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Removed - thanks!",
      "commit_id" : "6a0a8ef791400d78fb4192a81a392131be78270b",
      "created_at" : "2021-08-11T15:09:05Z",
      "diff_hunk" : "@@ -42,3 +48,174 @@ RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx)\n     // If we don't have a local mempool we can only check the transaction itself.\n     return SignalsOptInRBF(tx) ? RBFTransactionState::REPLACEABLE_BIP125 : RBFTransactionState::UNKNOWN;\n }\n+\n+bool IsRBFOptOut(const CTransaction& txConflicting)\n+{\n+    // Allow opt-out of transaction replacement by setting\n+    // nSequence > MAX_BIP125_RBF_SEQUENCE (SEQUENCE_FINAL-2) on all inputs.\n+    //\n+    // SEQUENCE_FINAL-1 is picked to still allow use of nLockTime by\n+    // non-replaceable transactions. All inputs rather than just one\n+    // is for the sake of multi-party protocols, where we don't\n+    // want a single party to be able to disable replacement.\n+    //\n+    // Transactions that don't explicitly signal replaceability are\n+    // *not* replaceable with the current logic, even if one of their\n+    // unconfirmed ancestors signals replaceability. This diverges\n+    // from BIP125's inherited signaling description (see CVE-2021-31876).\n+    // Applications relying on first-seen mempool behavior should\n+    // check all unconfirmed ancestors; otherwise an opt-in ancestor\n+    // might be replaced, causing removal of this descendant.\n+    for (const CTxIn &_txin : txConflicting.vin) {\n+        if (_txin.nSequence <= MAX_BIP125_RBF_SEQUENCE) return false;\n+    }\n+    return true;\n+}\n+\n+bool GetEntriesForRBF(const CTransaction& tx, CTxMemPool& m_pool,\n+                      const CTxMemPool::setEntries setIterConflicting,\n+                      TxValidationState& state, CTxMemPool::setEntries& allConflicting)\n+{\n+    AssertLockHeld(m_pool.cs);\n+    const uint256 hash = tx.GetHash();\n+    std::set<uint256> setConflictsParents;\n+    uint64_t nConflictingCount = 0;\n+    for (const auto& mi : setIterConflicting) {\n+        for (const CTxIn &txin : mi->GetTx().vin)\n+        {\n+            setConflictsParents.insert(txin.prevout.hash);\n+        }\n+\n+        nConflictingCount += mi->GetCountWithDescendants();\n+        // This potentially overestimates the number of actual descendants\n+        // but we just want to be conservative to avoid doing too much\n+        // work.\n+        if (nConflictingCount > MAX_BIP125_REPLACEMENT_CANDIDATES) {\n+            return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"too many potential replacements\",\n+                    strprintf(\"rejecting replacement %s; too many potential replacements (%d > %d)\\n\",\n+                        hash.ToString(),\n+                        nConflictingCount,\n+                        MAX_BIP125_REPLACEMENT_CANDIDATES));\n+        }\n+    }\n+    // If not too many to replace, then calculate the set of\n+    // transactions that would have to be evicted\n+    for (CTxMemPool::txiter it : setIterConflicting) {\n+        m_pool.CalculateDescendants(it, allConflicting);\n+    }\n+    return true;\n+}\n+\n+bool HasNoNewUnconfirmed(const CTransaction& tx, CTxMemPool& m_pool,\n+                         const CTxMemPool::setEntries setIterConflicting, TxValidationState& state)\n+{\n+    AssertLockHeld(m_pool.cs);\n+    std::set<uint256> setConflictsParents;\n+    for (const auto& mi : setIterConflicting) {\n+        for (const CTxIn &txin : mi->GetTx().vin)\n+        {\n+            setConflictsParents.insert(txin.prevout.hash);\n+        }\n+    }\n+\n+    for (unsigned int j = 0; j < tx.vin.size(); j++)\n+    {\n+        // We don't want to accept replacements that require low\n+        // feerate junk to be mined first. Ideally we'd keep track of\n+        // the ancestor feerates and make the decision based on that,\n+        // but for now requiring all new inputs to be confirmed works.\n+        //\n+        // Note that if you relax this to make RBF a little more useful,\n+        // this may break the CalculateMempoolAncestors RBF relaxation,\n+        // above. See the comment above the first CalculateMempoolAncestors\n+        // call for more info.\n+        if (!setConflictsParents.count(tx.vin[j].prevout.hash))\n+        {\n+            // Rather than check the UTXO set - potentially expensive -\n+            // it's cheaper to just check if the new input refers to a\n+            // tx that's in the mempool.\n+            if (m_pool.exists(tx.vin[j].prevout.hash)) {\n+                return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"replacement-adds-unconfirmed\",\n+                        strprintf(\"replacement %s adds unconfirmed input, idx %d\",\n+                            tx.GetHash().ToString(), j));\n+            }\n+        }\n+    }\n+    return true;\n+}\n+\n+bool SpendsAndConflictsDisjoint(CTxMemPool::setEntries& setAncestors, std::set<uint256> setConflicts,\n+                                TxValidationState& state, const uint256& hash)\n+{\n+    for (CTxMemPool::txiter ancestorIt : setAncestors)\n+    {\n+        const uint256 &hashAncestor = ancestorIt->GetTx().GetHash();\n+        if (setConflicts.count(hashAncestor))\n+        {\n+            return state.Invalid(TxValidationResult::TX_CONSENSUS, \"bad-txns-spends-conflicting-tx\",\n+                    strprintf(\"%s spends conflicting transaction %s\",\n+                        hash.ToString(),\n+                        hashAncestor.ToString()));\n+        }\n+    }\n+    return true;\n+}\n+\n+bool PaysMoreThanConflicts(const CTxMemPool::setEntries& setIterConflicting, CFeeRate newFeeRate,\n+                           TxValidationState& state, const uint256& hash)\n+{\n+    for (const auto& mi : setIterConflicting) {\n+        // Don't allow the replacement to reduce the feerate of the\n+        // mempool.\n+        //\n+        // We usually don't want to accept replacements with lower\n+        // feerates than what they replaced as that would lower the\n+        // feerate of the next block. Requiring that the feerate always\n+        // be increased is also an easy-to-reason about way to prevent\n+        // DoS attacks via replacements.\n+        //\n+        // We only consider the feerates of transactions being directly\n+        // replaced, not their indirect descendants. While that does\n+        // mean high feerate children are ignored when deciding whether\n+        // or not to replace, we do require the replacement to pay more\n+        // overall fees too, mitigating most cases.\n+        CFeeRate oldFeeRate(mi->GetModifiedFee(), mi->GetTxSize());\n+        if (newFeeRate <= oldFeeRate)\n+        {\n+            return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"insufficient fee\",\n+                    strprintf(\"rejecting replacement %s; new feerate %s <= old feerate %s\",\n+                        hash.ToString(),\n+                        newFeeRate.ToString(),\n+                        oldFeeRate.ToString()));\n+        }\n+    }\n+    return true;\n+}\n+\n+bool PaysForRBF(CAmount nConflictingFees, size_t nConflictingSize,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r686924532",
      "id" : 686924532,
      "in_reply_to_id" : 686725070,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NjkyNDUzMg==",
      "original_commit_id" : "520d3efda0128c3e87f5f56f1c282d0e8b295d49",
      "original_line" : 195,
      "original_position" : 164,
      "original_start_line" : null,
      "path" : "src/policy/rbf.cpp",
      "position" : null,
      "pull_request_review_id" : 727611376,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-11T15:09:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686924532",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "crACK 6a0a8ef791400d78fb4192a81a392131be78270b",
      "created_at" : "2021-08-12T01:24:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#issuecomment-897274755",
      "id" : 897274755,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22675",
      "node_id" : "IC_kwDOABII5841e1OD",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-12T01:24:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/897274755",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2021-08-12T12:11:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#issuecomment-897587220",
      "id" : 897587220,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22675",
      "node_id" : "IC_kwDOABII5841gBgU",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-12T12:11:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/897587220",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Tested ACK 6a0a8ef791400d78fb4192a81a392131be78270b",
      "created_at" : "2021-08-13T14:49:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#issuecomment-898510534",
      "id" : 898510534,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22675",
      "node_id" : "IC_kwDOABII5841ji7G",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-13T14:49:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/898510534",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r688663550"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/688663550"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I guess for performance reasons, we should pass `setIterConflicting` by reference, rather than by value?\r\n```suggestion\r\n                      const CTxMemPool::setEntries& setIterConflicting,\r\n```",
      "commit_id" : "6a0a8ef791400d78fb4192a81a392131be78270b",
      "created_at" : "2021-08-13T17:12:07Z",
      "diff_hunk" : "@@ -43,3 +47,31 @@ RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx)\n     return SignalsOptInRBF(tx) ? RBFTransactionState::REPLACEABLE_BIP125 : RBFTransactionState::UNKNOWN;\n }\n \n+bool GetEntriesForRBF(const CTransaction& tx, CTxMemPool& m_pool,\n+                      const CTxMemPool::setEntries setIterConflicting,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r688663550",
      "id" : 688663550,
      "line" : 53,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4ODY2MzU1MA==",
      "original_commit_id" : "474258f4296878a3740c8e19c9358ba4134cd48d",
      "original_line" : 51,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/policy/rbf.cpp",
      "position" : 22,
      "pull_request_review_id" : 729819432,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-13T17:30:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/688663550",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r688667057"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/688667057"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This header doesn't seem to be directly needed in this compilation unit (strings _are_ used as return values/parameters for `uint256.ToString()` and `strprintf`, but it's the job of the headers offering those functions to already also include `<string>`).\r\n```suggestion\r\n```",
      "commit_id" : "6a0a8ef791400d78fb4192a81a392131be78270b",
      "created_at" : "2021-08-13T17:18:42Z",
      "diff_hunk" : "@@ -2,9 +2,13 @@\n // Distributed under the MIT software license, see the accompanying\n // file COPYING or http://www.opensource.org/licenses/mit-license.php.\n \n+#include <consensus/validation.h>\n+#include <logging.h>\n #include <policy/rbf.h>\n #include <util/rbf.h>\n \n+#include <string>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r688667057",
      "id" : 688667057,
      "line" : 12,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4ODY2NzA1Nw==",
      "original_commit_id" : "474258f4296878a3740c8e19c9358ba4134cd48d",
      "original_line" : 10,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/policy/rbf.cpp",
      "position" : 11,
      "pull_request_review_id" : 729819432,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-13T17:30:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/688667057",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r688975344"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/688975344"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\nbool HasNoNewUnconfirmed(const CTransaction& tx, const CTxMemPool& m_pool,\r\n                         const CTxMemPool::setEntries& setIterConflicting, TxValidationState& state)\r\n```",
      "commit_id" : "6a0a8ef791400d78fb4192a81a392131be78270b",
      "created_at" : "2021-08-14T18:04:08Z",
      "diff_hunk" : "@@ -75,3 +75,40 @@ bool GetEntriesForRBF(const CTransaction& tx, CTxMemPool& m_pool,\n     return true;\n }\n \n+bool HasNoNewUnconfirmed(const CTransaction& tx, CTxMemPool& m_pool,\n+                         const CTxMemPool::setEntries setIterConflicting, TxValidationState& state)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r688975344",
      "id" : 688975344,
      "line" : 81,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4ODk3NTM0NA==",
      "original_commit_id" : "7558a4f0c1f00b35639adcd9772b6cdc9bd4431c",
      "original_line" : 79,
      "original_position" : 5,
      "original_start_line" : 78,
      "path" : "src/policy/rbf.cpp",
      "position" : 50,
      "pull_request_review_id" : 730123757,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : 80,
      "start_side" : "RIGHT",
      "updated_at" : "2021-08-14T18:43:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/688975344",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r688976433"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/688976433"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\nbool SpendsAndConflictsDisjoint(const CTxMemPool::setEntries& setAncestors, const std::set<uint256>& setConflicts,\r\n```",
      "commit_id" : "6a0a8ef791400d78fb4192a81a392131be78270b",
      "created_at" : "2021-08-14T18:15:21Z",
      "diff_hunk" : "@@ -112,3 +112,20 @@ bool HasNoNewUnconfirmed(const CTransaction& tx, CTxMemPool& m_pool,\n     }\n     return true;\n }\n+\n+bool SpendsAndConflictsDisjoint(CTxMemPool::setEntries& setAncestors, std::set<uint256> setConflicts,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r688976433",
      "id" : 688976433,
      "line" : 118,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4ODk3NjQzMw==",
      "original_commit_id" : "85feb62fbf8c3486992926b685d4df0705c5ca24",
      "original_line" : 116,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/policy/rbf.cpp",
      "position" : 87,
      "pull_request_review_id" : 730123757,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-14T18:43:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/688976433",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r688976657"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/688976657"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n * returns true if the intersection is empty, false if otherwise.\r\n```",
      "commit_id" : "6a0a8ef791400d78fb4192a81a392131be78270b",
      "created_at" : "2021-08-14T18:17:45Z",
      "diff_hunk" : "@@ -51,4 +51,12 @@ bool GetEntriesForRBF(const CTransaction& tx, CTxMemPool& m_pool,\n bool HasNoNewUnconfirmed(const CTransaction& tx, CTxMemPool& m_pool,\n                          const CTxMemPool::setEntries setIterConflicting,\n                          TxValidationState& state) EXCLUSIVE_LOCKS_REQUIRED(m_pool.cs);\n+\n+/** Check the intersection between original mempool transactions (candidates for being replaced) and\n+ * the ancestors of replacement transactions.\n+ * @param[in]   hash    Transaction ID, included in the error message if violation occurs.\n+ * returns false if the intersection is empty, true if otherwise.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r688976657",
      "id" : 688976657,
      "line" : 58,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4ODk3NjY1Nw==",
      "original_commit_id" : "85feb62fbf8c3486992926b685d4df0705c5ca24",
      "original_line" : 58,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/policy/rbf.h",
      "position" : 35,
      "pull_request_review_id" : 730123757,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-14T18:43:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/688976657",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r688977532"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/688977532"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This line removal must be unintentional (three placeholders, but only two arguments)? Quite a pity that the compiler doesn't warn us in this case. At least the tinyformat library seems to be nice enough to notice us at runtime :)\r\n```\r\n$ ./test/functional/feature_rbf.py\r\n.....\r\n.....\r\n2021-08-14T18:32:49.823000Z TestFramework (INFO): Running test replacement relay fee...\r\n2021-08-14T18:32:49.834000Z TestFramework (ERROR): Assertion failed\r\nTraceback (most recent call last):                                                                                                                                                             File \"/home/honey/bitcoin_prrev/test/functional/test_framework/util.py\", line 132, in try_rpc\r\n    fun(*args, **kwds)\r\n  File \"/home/honey/bitcoin_prrev/test/functional/test_framework/coverage.py\", line 49, in __call__\r\n    return_val = self.auth_service_proxy_instance.__call__(*args, **kwargs)\r\n  File \"/home/honey/bitcoin_prrev/test/functional/test_framework/authproxy.py\", line 146, in __call__\r\n    raise JSONRPCException(response['error'], status)\r\ntest_framework.authproxy.JSONRPCException: tinyformat: Too many conversion specifiers in format string (-1)\r\n```",
      "commit_id" : "6a0a8ef791400d78fb4192a81a392131be78270b",
      "created_at" : "2021-08-14T18:28:17Z",
      "diff_hunk" : "@@ -828,7 +804,6 @@ bool MemPoolAccept::PreChecks(ATMPArgs& args, Workspace& ws)\n             return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"insufficient fee\",\n                     strprintf(\"rejecting replacement %s, not enough additional fees to relay; %s < %s\",\n                         hash.ToString(),\n-                        FormatMoney(nDeltaFees),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r688977532",
      "id" : 688977532,
      "line" : 909,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4ODk3NzUzMg==",
      "original_commit_id" : "a30b0270d0129f16573827d45250aa42912803d3",
      "original_line" : 831,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 171,
      "pull_request_review_id" : 730123757,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-14T18:43:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/688977532",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r689346785"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/689346785"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "woah good catch O.o",
      "commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "created_at" : "2021-08-16T08:42:45Z",
      "diff_hunk" : "@@ -828,7 +804,6 @@ bool MemPoolAccept::PreChecks(ATMPArgs& args, Workspace& ws)\n             return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"insufficient fee\",\n                     strprintf(\"rejecting replacement %s, not enough additional fees to relay; %s < %s\",\n                         hash.ToString(),\n-                        FormatMoney(nDeltaFees),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r689346785",
      "id" : 689346785,
      "in_reply_to_id" : 688977532,
      "line" : 909,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4OTM0Njc4NQ==",
      "original_commit_id" : "a30b0270d0129f16573827d45250aa42912803d3",
      "original_line" : 909,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 171,
      "pull_request_review_id" : 730465340,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-16T08:42:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/689346785",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r689392421"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/689392421"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Good point, done!",
      "commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "created_at" : "2021-08-16T09:48:01Z",
      "diff_hunk" : "@@ -43,3 +47,31 @@ RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx)\n     return SignalsOptInRBF(tx) ? RBFTransactionState::REPLACEABLE_BIP125 : RBFTransactionState::UNKNOWN;\n }\n \n+bool GetEntriesForRBF(const CTransaction& tx, CTxMemPool& m_pool,\n+                      const CTxMemPool::setEntries setIterConflicting,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r689392421",
      "id" : 689392421,
      "in_reply_to_id" : 688663550,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4OTM5MjQyMQ==",
      "original_commit_id" : "474258f4296878a3740c8e19c9358ba4134cd48d",
      "original_line" : 51,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/policy/rbf.cpp",
      "position" : null,
      "pull_request_review_id" : 730524212,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-16T09:48:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/689392421",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r689392517"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/689392517"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "created_at" : "2021-08-16T09:48:10Z",
      "diff_hunk" : "@@ -2,9 +2,13 @@\n // Distributed under the MIT software license, see the accompanying\n // file COPYING or http://www.opensource.org/licenses/mit-license.php.\n \n+#include <consensus/validation.h>\n+#include <logging.h>\n #include <policy/rbf.h>\n #include <util/rbf.h>\n \n+#include <string>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r689392517",
      "id" : 689392517,
      "in_reply_to_id" : 688667057,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4OTM5MjUxNw==",
      "original_commit_id" : "474258f4296878a3740c8e19c9358ba4134cd48d",
      "original_line" : 10,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/policy/rbf.cpp",
      "position" : null,
      "pull_request_review_id" : 730524333,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-16T09:48:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/689392517",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r689392704"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/689392704"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "created_at" : "2021-08-16T09:48:27Z",
      "diff_hunk" : "@@ -75,3 +75,40 @@ bool GetEntriesForRBF(const CTransaction& tx, CTxMemPool& m_pool,\n     return true;\n }\n \n+bool HasNoNewUnconfirmed(const CTransaction& tx, CTxMemPool& m_pool,\n+                         const CTxMemPool::setEntries setIterConflicting, TxValidationState& state)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r689392704",
      "id" : 689392704,
      "in_reply_to_id" : 688975344,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4OTM5MjcwNA==",
      "original_commit_id" : "7558a4f0c1f00b35639adcd9772b6cdc9bd4431c",
      "original_line" : 79,
      "original_position" : 5,
      "original_start_line" : 78,
      "path" : "src/policy/rbf.cpp",
      "position" : null,
      "pull_request_review_id" : 730524556,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-08-16T09:48:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/689392704",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r689393199"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/689393199"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Good point, done",
      "commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "created_at" : "2021-08-16T09:49:09Z",
      "diff_hunk" : "@@ -112,3 +112,20 @@ bool HasNoNewUnconfirmed(const CTransaction& tx, CTxMemPool& m_pool,\n     }\n     return true;\n }\n+\n+bool SpendsAndConflictsDisjoint(CTxMemPool::setEntries& setAncestors, std::set<uint256> setConflicts,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r689393199",
      "id" : 689393199,
      "in_reply_to_id" : 688976433,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4OTM5MzE5OQ==",
      "original_commit_id" : "85feb62fbf8c3486992926b685d4df0705c5ca24",
      "original_line" : 116,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/policy/rbf.cpp",
      "position" : null,
      "pull_request_review_id" : 730525111,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-16T09:49:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/689393199",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r689393296"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/689393296"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed",
      "commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "created_at" : "2021-08-16T09:49:17Z",
      "diff_hunk" : "@@ -51,4 +51,12 @@ bool GetEntriesForRBF(const CTransaction& tx, CTxMemPool& m_pool,\n bool HasNoNewUnconfirmed(const CTransaction& tx, CTxMemPool& m_pool,\n                          const CTxMemPool::setEntries setIterConflicting,\n                          TxValidationState& state) EXCLUSIVE_LOCKS_REQUIRED(m_pool.cs);\n+\n+/** Check the intersection between original mempool transactions (candidates for being replaced) and\n+ * the ancestors of replacement transactions.\n+ * @param[in]   hash    Transaction ID, included in the error message if violation occurs.\n+ * returns false if the intersection is empty, true if otherwise.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r689393296",
      "id" : 689393296,
      "in_reply_to_id" : 688976657,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4OTM5MzI5Ng==",
      "original_commit_id" : "85feb62fbf8c3486992926b685d4df0705c5ca24",
      "original_line" : 58,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/policy/rbf.h",
      "position" : null,
      "pull_request_review_id" : 730525239,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-16T09:49:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/689393296",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r689398361"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/689398361"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed",
      "commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "created_at" : "2021-08-16T09:56:52Z",
      "diff_hunk" : "@@ -828,7 +804,6 @@ bool MemPoolAccept::PreChecks(ATMPArgs& args, Workspace& ws)\n             return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"insufficient fee\",\n                     strprintf(\"rejecting replacement %s, not enough additional fees to relay; %s < %s\",\n                         hash.ToString(),\n-                        FormatMoney(nDeltaFees),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r689398361",
      "id" : 689398361,
      "in_reply_to_id" : 688977532,
      "line" : 909,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4OTM5ODM2MQ==",
      "original_commit_id" : "a30b0270d0129f16573827d45250aa42912803d3",
      "original_line" : 909,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 171,
      "pull_request_review_id" : 730531942,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-16T09:56:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/689398361",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "\r\n> To be extra-cautious, I also compiled and ran unit tests + the functional test feature_rbf.py on every commit.\r\n> Left some more suggestions considering const-correctness and passing by reference rather than by value. On the second-to-last commit [a30b027](https://github.com/bitcoin/bitcoin/commit/a30b0270d0129f16573827d45250aa42912803d3) the test feature_rbf.py currently fails, see comment below. In the last commit this is fixed, as the deleted strprintf() argument line is re-introduced in the helper function.\r\n\r\nThanks @theStack and good catch! Fixed. Good idea for reviewers to run `git rebase --exec \"make check; test/functional/feature_rbf.py\" -i HEAD~11` in general\r\n\r\nAlso added a small scripted diff style cleanup, should be simple to review",
      "created_at" : "2021-08-16T09:58:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#issuecomment-899381767",
      "id" : 899381767,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22675",
      "node_id" : "IC_kwDOABII5841m3oH",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-16T09:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/899381767",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r689596026"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/689596026"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Concept ACK, but I think we should avoid adding a circular dependency here.\r\nEdit: oh, I see you already have a PR, #22677, for this. I guess it's fine under the condition that it's temporarily (to keep this one move-only).",
      "commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "created_at" : "2021-08-16T14:38:21Z",
      "diff_hunk" : "@@ -15,6 +15,7 @@ EXPECTED_CIRCULAR_DEPENDENCIES=(\n     \"index/base -> validation -> index/blockfilterindex -> index/base\"\n     \"index/coinstatsindex -> node/coinstats -> index/coinstatsindex\"\n     \"policy/fees -> txmempool -> policy/fees\"\n+    \"policy/rbf -> txmempool -> validation -> policy/rbf\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r689596026",
      "id" : 689596026,
      "line" : 18,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4OTU5NjAyNg==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 18,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/lint/lint-circular-dependencies.sh",
      "position" : 4,
      "pull_request_review_id" : 730794542,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-16T14:47:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/689596026",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r691672020"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/691672020"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think `src/util/rbf.h`, did already incorporate bip125 policy value such as `MAX_BIP125_RBF_SEQUENCE` and if we have a newer `src/policy/rbf.h` encapsulating the RBF-logic better to gather in the same place to avoid bugs where our components (wallet/mempool/etc) misinterpret policy/consensus rules. E.g the wallet applying the pre-bip113 semantic for finality see #17443.",
      "commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "created_at" : "2021-08-18T23:32:41Z",
      "diff_hunk" : "@@ -15,4 +15,7 @@ static const uint32_t MAX_BIP125_RBF_SEQUENCE = 0xfffffffd;\n // opt-in to replace-by-fee, according to BIP 125\n bool SignalsOptInRBF(const CTransaction &tx);\n \n+/** Determine whether a mempool transaction is opting out of RBF. Mempool entries do not inherit\n+ * signaling from their parents in this implementation. */\n+bool IsRBFOptOut(const CTransaction& txConflicting);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r691672020",
      "id" : 691672020,
      "line" : 20,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MTY3MjAyMA==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 20,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/util/rbf.h",
      "position" : 6,
      "pull_request_review_id" : 733433190,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-19T01:02:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/691672020",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r691690916"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/691690916"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If you're pointing to the exact standard rule, I think that's better to either textually quote it to minimize risks of inconsistency OR propose an amendment to the spec with your better wording.\r\n\r\nNote, exact standard quoting is a development practice heavily done by CL. E.g : https://github.com/ElementsProject/lightning/blob/4514d2a18098c9136d1b26b5028298f79028012e/lightningd/onchain_control.c#L31\r\n\r\nPersonally, I think that make easier to audit a codebase from the outside, as you can just grep the refs without knowing in-details the code architecture.",
      "commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "created_at" : "2021-08-19T00:26:24Z",
      "diff_hunk" : "@@ -31,4 +36,51 @@ enum class RBFTransactionState {\n RBFTransactionState IsRBFOptIn(const CTransaction& tx, const CTxMemPool& pool) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx);\n \n+/** Get all descendants of iters_conflicting. Also enforce BIP125 Rule 5 and quit as early as\n+ * possible. There cannot be more than MAX_BIP125_REPLACEMENT_CANDIDATES potential entries.\n+ * @param[in]   iters_conflicting   The set of iterators to mempool entries.\n+ * @param[out]  state               Used to return errors, if any.\n+ * @param[out]  all_conflicts       Populated with all the mempool entries that would be replaced,\n+ *                                  which includes descendants of iters_conflicting. Not cleared at\n+ *                                  the start; any existing mempool entries will remain in the set.\n+ * @returns false if Rule 5 is broken.\n+ */\n+bool GetEntriesForRBF(const CTransaction& tx, CTxMemPool& pool,\n+                      const CTxMemPool::setEntries& iters_conflicting, TxValidationState& state,\n+                      CTxMemPool::setEntries& all_conflicts) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n+\n+/** Enforce BIP125 Rule 2: a replacement transaction must not add any new unconfirmed inputs. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r691690916",
      "id" : 691690916,
      "line" : 52,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MTY5MDkxNg==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 52,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/policy/rbf.h",
      "position" : 29,
      "pull_request_review_id" : 733433190,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-19T01:02:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/691690916",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r691695502"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/691695502"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think a more accurate name would be \"VerifyAncestorCandidateConflictsDisjunction\".\r\n\r\nAlso `hash` could be `txid` to dissociate clearly from `wtxid`.\r\nAnd `(candidates to be replaced)` is a bit unclear imho as a the direct conflicts aren't mempool candidate anymore, they're are already in until the replacement succeeds, if it does.\r\n\r\nAlso maybe, this function could be made a helper in `txmempool`, and if the disjunction boolean is false, the policy error is qualified.",
      "commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "created_at" : "2021-08-19T00:40:54Z",
      "diff_hunk" : "@@ -31,4 +36,51 @@ enum class RBFTransactionState {\n RBFTransactionState IsRBFOptIn(const CTransaction& tx, const CTxMemPool& pool) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx);\n \n+/** Get all descendants of iters_conflicting. Also enforce BIP125 Rule 5 and quit as early as\n+ * possible. There cannot be more than MAX_BIP125_REPLACEMENT_CANDIDATES potential entries.\n+ * @param[in]   iters_conflicting   The set of iterators to mempool entries.\n+ * @param[out]  state               Used to return errors, if any.\n+ * @param[out]  all_conflicts       Populated with all the mempool entries that would be replaced,\n+ *                                  which includes descendants of iters_conflicting. Not cleared at\n+ *                                  the start; any existing mempool entries will remain in the set.\n+ * @returns false if Rule 5 is broken.\n+ */\n+bool GetEntriesForRBF(const CTransaction& tx, CTxMemPool& pool,\n+                      const CTxMemPool::setEntries& iters_conflicting, TxValidationState& state,\n+                      CTxMemPool::setEntries& all_conflicts) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n+\n+/** Enforce BIP125 Rule 2: a replacement transaction must not add any new unconfirmed inputs. */\n+bool HasNoNewUnconfirmed(const CTransaction& tx, const CTxMemPool& pool,\n+                         const CTxMemPool::setEntries& iters_conflicting,\n+                         TxValidationState& state) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n+\n+/** Check the intersection between two sets of mempool entries to make sure they are disjoint.\n+ * @param[in]   ancestors           Set of mempool entries corresponding to ancestors of the\n+ *                                  replacement transactions.\n+ * @param[in]   direct_conflicts    Set of mempool entries corresponding to the mempool conflicts\n+ *                                  (candidates to be replaced).\n+ * @param[in]   hash                Transaction ID, included in the error message if violation occurs.\n+ * returns true if the two sets are disjoint (i.e. intersection is empty), false if otherwise.\n+ */\n+bool SpendsAndConflictsDisjoint(const CTxMemPool::setEntries& ancestors,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r691695502",
      "id" : 691695502,
      "line" : 65,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MTY5NTUwMg==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 65,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/policy/rbf.h",
      "position" : 42,
      "pull_request_review_id" : 733433190,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-19T01:02:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/691695502",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692140815"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692140815"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yep! I've rebased #22677 on top of this PR so it's more clear that it would fix this problem.",
      "commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "created_at" : "2021-08-19T14:02:10Z",
      "diff_hunk" : "@@ -15,6 +15,7 @@ EXPECTED_CIRCULAR_DEPENDENCIES=(\n     \"index/base -> validation -> index/blockfilterindex -> index/base\"\n     \"index/coinstatsindex -> node/coinstats -> index/coinstatsindex\"\n     \"policy/fees -> txmempool -> policy/fees\"\n+    \"policy/rbf -> txmempool -> validation -> policy/rbf\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692140815",
      "id" : 692140815,
      "in_reply_to_id" : 689596026,
      "line" : 18,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MjE0MDgxNQ==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 18,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/lint/lint-circular-dependencies.sh",
      "position" : 4,
      "pull_request_review_id" : 734029253,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-19T14:02:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692140815",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> That said, why not proceed the other way around to avoid introducing the circular dependency at all?\r\n\r\nTrue, I just did it this way because this PR is a bit further along (other one is still looking for approach feedback), and I have some branches depending on this refactor.",
      "created_at" : "2021-08-20T10:20:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#issuecomment-902593124",
      "id" : 902593124,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22675",
      "node_id" : "IC_kwDOABII5841zHpk",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-20T10:20:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/902593124",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692845155"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692845155"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think this needs to mention mempool:\r\n\r\n```suggestion\r\n/** Determine whether a transaction is opting out of RBF. Mempool entries do not inherit\r\n```",
      "commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "created_at" : "2021-08-20T10:34:02Z",
      "diff_hunk" : "@@ -15,4 +15,7 @@ static const uint32_t MAX_BIP125_RBF_SEQUENCE = 0xfffffffd;\n // opt-in to replace-by-fee, according to BIP 125\n bool SignalsOptInRBF(const CTransaction &tx);\n \n+/** Determine whether a mempool transaction is opting out of RBF. Mempool entries do not inherit",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692845155",
      "id" : 692845155,
      "line" : 18,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5Mjg0NTE1NQ==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 18,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/util/rbf.h",
      "position" : 4,
      "pull_request_review_id" : 734897366,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-20T13:17:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692845155",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692845356"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692845356"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n * signaling from their ancestors in this implementation. */\r\n```",
      "commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "created_at" : "2021-08-20T10:34:28Z",
      "diff_hunk" : "@@ -15,4 +15,7 @@ static const uint32_t MAX_BIP125_RBF_SEQUENCE = 0xfffffffd;\n // opt-in to replace-by-fee, according to BIP 125\n bool SignalsOptInRBF(const CTransaction &tx);\n \n+/** Determine whether a mempool transaction is opting out of RBF. Mempool entries do not inherit\n+ * signaling from their parents in this implementation. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692845356",
      "id" : 692845356,
      "line" : 19,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5Mjg0NTM1Ng==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 19,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/util/rbf.h",
      "position" : 5,
      "pull_request_review_id" : 734897366,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-20T13:17:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692845356",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692846284"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692846284"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In the final fixup commit, you could fix this to use current style:\r\n\r\n```suggestion\r\n    for (const CTxIn& txin : txConflicting.vin) {\r\n        if (txin.nSequence <= MAX_BIP125_RBF_SEQUENCE) return false;\r\n```",
      "commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "created_at" : "2021-08-20T10:36:04Z",
      "diff_hunk" : "@@ -15,3 +15,26 @@ bool SignalsOptInRBF(const CTransaction &tx)\n     }\n     return false;\n }\n+\n+bool IsRBFOptOut(const CTransaction& txConflicting)\n+{\n+    // Allow opt-out of transaction replacement by setting\n+    // nSequence > MAX_BIP125_RBF_SEQUENCE (SEQUENCE_FINAL-2) on all inputs.\n+    //\n+    // SEQUENCE_FINAL-1 is picked to still allow use of nLockTime by\n+    // non-replaceable transactions. All inputs rather than just one\n+    // is for the sake of multi-party protocols, where we don't\n+    // want a single party to be able to disable replacement.\n+    //\n+    // Transactions that don't explicitly signal replaceability are\n+    // *not* replaceable with the current logic, even if one of their\n+    // unconfirmed ancestors signals replaceability. This diverges\n+    // from BIP125's inherited signaling description (see CVE-2021-31876).\n+    // Applications relying on first-seen mempool behavior should\n+    // check all unconfirmed ancestors; otherwise an opt-in ancestor\n+    // might be replaced, causing removal of this descendant.\n+    for (const CTxIn &_txin : txConflicting.vin) {\n+        if (_txin.nSequence <= MAX_BIP125_RBF_SEQUENCE) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692846284",
      "id" : 692846284,
      "line" : 37,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5Mjg0NjI4NA==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 37,
      "original_position" : 23,
      "original_start_line" : 36,
      "path" : "src/util/rbf.cpp",
      "position" : 23,
      "pull_request_review_id" : 734897366,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : 36,
      "start_side" : "RIGHT",
      "updated_at" : "2021-08-20T13:17:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692846284",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692847264"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692847264"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In eb3bd36a8b _MOVEONLY: signal checking into policy/rbf_\r\n\r\nDon't add this new blank line.",
      "commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "created_at" : "2021-08-20T10:37:49Z",
      "diff_hunk" : "@@ -42,3 +42,4 @@ RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx)\n     // If we don't have a local mempool we can only check the transaction itself.\n     return SignalsOptInRBF(tx) ? RBFTransactionState::REPLACEABLE_BIP125 : RBFTransactionState::UNKNOWN;\n }\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692847264",
      "id" : 692847264,
      "line" : 49,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5Mjg0NzI2NA==",
      "original_commit_id" : "eb3bd36a8b8f7849757f6e6f01a704e63cdfef2e",
      "original_line" : 45,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/policy/rbf.cpp",
      "position" : 36,
      "pull_request_review_id" : 734897366,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-20T13:17:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692847264",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692847949"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692847949"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Perhaps add a note to the commit log that this circular dependency is due to the txmempool->validation dependency, and that #22677 resolves it.",
      "commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "created_at" : "2021-08-20T10:39:04Z",
      "diff_hunk" : "@@ -15,6 +15,7 @@ EXPECTED_CIRCULAR_DEPENDENCIES=(\n     \"index/base -> validation -> index/blockfilterindex -> index/base\"\n     \"index/coinstatsindex -> node/coinstats -> index/coinstatsindex\"\n     \"policy/fees -> txmempool -> policy/fees\"\n+    \"policy/rbf -> txmempool -> validation -> policy/rbf\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692847949",
      "id" : 692847949,
      "in_reply_to_id" : 689596026,
      "line" : 18,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5Mjg0Nzk0OQ==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 18,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/lint/lint-circular-dependencies.sh",
      "position" : 4,
      "pull_request_review_id" : 734897366,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-20T13:17:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692847949",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692891251"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692891251"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is potentially a behavior change. Previously, these would get set to zero unconditionally. Now, they only get set if `fReplacementTransaction` is true.\r\n\r\nI think it'd be safer to default initialize `m_conflicting_fees` and `m_conflicting_size` to 0 in the struct member declarations, and remove these assignments.\r\n\r\nI might even go further and remove the `nConflictingFees` and `nConflictingSize` references. I think they harm readability more than help.\r\n",
      "commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "created_at" : "2021-08-20T12:02:20Z",
      "diff_hunk" : "@@ -784,23 +761,8 @@ bool MemPoolAccept::PreChecks(ATMPArgs& args, Workspace& ws)\n     // that we have the set of all ancestors we can detect this\n     // pathological case by making sure setConflicts and setAncestors don't\n     // intersect.\n-    for (CTxMemPool::txiter ancestorIt : setAncestors)\n-    {\n-        const uint256 &hashAncestor = ancestorIt->GetTx().GetHash();\n-        if (setConflicts.count(hashAncestor))\n-        {\n-            return state.Invalid(TxValidationResult::TX_CONSENSUS, \"bad-txns-spends-conflicting-tx\",\n-                    strprintf(\"%s spends conflicting transaction %s\",\n-                        hash.ToString(),\n-                        hashAncestor.ToString()));\n-        }\n-    }\n+    if (!SpendsAndConflictsDisjoint(setAncestors, setConflicts, state, hash)) return false;\n \n-    // Check if it's economically rational to mine this transaction rather\n-    // than the ones it replaces.\n-    nConflictingFees = 0;\n-    nConflictingSize = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692891251",
      "id" : 692891251,
      "line" : 802,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5Mjg5MTI1MQ==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 802,
      "original_position" : 61,
      "original_start_line" : 801,
      "path" : "src/validation.cpp",
      "position" : 61,
      "pull_request_review_id" : 734897366,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "LEFT",
      "start_line" : 801,
      "start_side" : "LEFT",
      "updated_at" : "2021-08-20T13:17:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692891251",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692892064"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692892064"
         }
      },
      "author_association" : "MEMBER",
      "body" : "sort includes :)",
      "commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "created_at" : "2021-08-20T12:03:59Z",
      "diff_hunk" : "@@ -6,6 +6,11 @@\n #define BITCOIN_POLICY_RBF_H\n \n #include <txmempool.h>\n+#include <consensus/validation.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692892064",
      "id" : 692892064,
      "line" : 9,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5Mjg5MjA2NA==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 9,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/policy/rbf.h",
      "position" : 4,
      "pull_request_review_id" : 734897366,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-20T13:17:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692892064",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692893230"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692893230"
         }
      },
      "author_association" : "MEMBER",
      "body" : "First include this file's header, then other headers in the project:\r\n\r\n```c++\r\n#include <policy/rbf.h>\r\n\r\n#include <consensus/validation.h>\r\n#include <logging.h>\r\n#include <policy/settings.h>\r\n#include <util/moneystr.h>\r\n#include <util/rbf.h>\r\n```",
      "commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "created_at" : "2021-08-20T12:06:12Z",
      "diff_hunk" : "@@ -2,14 +2,18 @@\n // Distributed under the MIT software license, see the accompanying\n // file COPYING or http://www.opensource.org/licenses/mit-license.php.\n \n+#include <consensus/validation.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692893230",
      "id" : 692893230,
      "line" : 5,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5Mjg5MzIzMA==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 5,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/policy/rbf.cpp",
      "position" : 4,
      "pull_request_review_id" : 734897366,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-20T13:17:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692893230",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692897400"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692897400"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Consider updating this to current style in the fixup commit:\r\n\r\n```suggestion\r\n    uint64_t number_conflicting_tx{0};\r\n```\r\n\r\nor similar",
      "commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "created_at" : "2021-08-20T12:12:57Z",
      "diff_hunk" : "@@ -42,3 +46,133 @@ RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx)\n     // If we don't have a local mempool we can only check the transaction itself.\n     return SignalsOptInRBF(tx) ? RBFTransactionState::REPLACEABLE_BIP125 : RBFTransactionState::UNKNOWN;\n }\n+\n+bool GetEntriesForRBF(const CTransaction& tx, CTxMemPool& pool,\n+                      const CTxMemPool::setEntries& iters_conflicting,\n+                      TxValidationState& state, CTxMemPool::setEntries& all_conflicts)\n+{\n+    AssertLockHeld(pool.cs);\n+    const uint256 hash = tx.GetHash();\n+    uint64_t nConflictingCount = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692897400",
      "id" : 692897400,
      "line" : 56,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5Mjg5NzQwMA==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 56,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/policy/rbf.cpp",
      "position" : 43,
      "pull_request_review_id" : 734897366,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-20T13:17:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692897400",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692901343"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692901343"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Split this comment up:\r\n\r\n```suggestion\r\n        // Calculate all conflicting entries and enforce BIP125 rule 5.\r\n        if (!GetEntriesForRBF(tx, m_pool, setIterConflicting, state, allConflicting)) return false;\r\n        // Enforce BIP125 rule 2.\r\n        if (!HasNoNewUnconfirmed(tx, m_pool, setIterConflicting, state)) return false;\r\n```\r\n\r\n(The comment is added in 28e7da0363 _MOVEONLY: getting mempool conflicts to policy/rbf_, which is a bit confusing since it implies that `GetEntriesForRBF()` enforces rule 2)",
      "commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "created_at" : "2021-08-20T12:19:56Z",
      "diff_hunk" : "@@ -809,106 +771,21 @@ bool MemPoolAccept::PreChecks(ATMPArgs& args, Workspace& ws)\n     if (fReplacementTransaction)\n     {\n         CFeeRate newFeeRate(nModifiedFees, nSize);\n-        std::set<uint256> setConflictsParents;\n-        const int maxDescendantsToVisit = 100;\n-        for (const auto& mi : setIterConflicting) {\n-            // Don't allow the replacement to reduce the feerate of the\n-            // mempool.\n-            //\n-            // We usually don't want to accept replacements with lower\n-            // feerates than what they replaced as that would lower the\n-            // feerate of the next block. Requiring that the feerate always\n-            // be increased is also an easy-to-reason about way to prevent\n-            // DoS attacks via replacements.\n-            //\n-            // We only consider the feerates of transactions being directly\n-            // replaced, not their indirect descendants. While that does\n-            // mean high feerate children are ignored when deciding whether\n-            // or not to replace, we do require the replacement to pay more\n-            // overall fees too, mitigating most cases.\n-            CFeeRate oldFeeRate(mi->GetModifiedFee(), mi->GetTxSize());\n-            if (newFeeRate <= oldFeeRate)\n-            {\n-                return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"insufficient fee\",\n-                        strprintf(\"rejecting replacement %s; new feerate %s <= old feerate %s\",\n-                            hash.ToString(),\n-                            newFeeRate.ToString(),\n-                            oldFeeRate.ToString()));\n-            }\n-\n-            for (const CTxIn &txin : mi->GetTx().vin)\n-            {\n-                setConflictsParents.insert(txin.prevout.hash);\n-            }\n-\n-            nConflictingCount += mi->GetCountWithDescendants();\n-        }\n-        // This potentially overestimates the number of actual descendants\n-        // but we just want to be conservative to avoid doing too much\n-        // work.\n-        if (nConflictingCount <= maxDescendantsToVisit) {\n-            // If not too many to replace, then calculate the set of\n-            // transactions that would have to be evicted\n-            for (CTxMemPool::txiter it : setIterConflicting) {\n-                m_pool.CalculateDescendants(it, allConflicting);\n-            }\n-            for (CTxMemPool::txiter it : allConflicting) {\n-                nConflictingFees += it->GetModifiedFee();\n-                nConflictingSize += it->GetTxSize();\n-            }\n-        } else {\n-            return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"too many potential replacements\",\n-                    strprintf(\"rejecting replacement %s; too many potential replacements (%d > %d)\\n\",\n-                        hash.ToString(),\n-                        nConflictingCount,\n-                        maxDescendantsToVisit));\n-        }\n-\n-        for (unsigned int j = 0; j < tx.vin.size(); j++)\n-        {\n-            // We don't want to accept replacements that require low\n-            // feerate junk to be mined first. Ideally we'd keep track of\n-            // the ancestor feerates and make the decision based on that,\n-            // but for now requiring all new inputs to be confirmed works.\n-            //\n-            // Note that if you relax this to make RBF a little more useful,\n-            // this may break the CalculateMempoolAncestors RBF relaxation,\n-            // above. See the comment above the first CalculateMempoolAncestors\n-            // call for more info.\n-            if (!setConflictsParents.count(tx.vin[j].prevout.hash))\n-            {\n-                // Rather than check the UTXO set - potentially expensive -\n-                // it's cheaper to just check if the new input refers to a\n-                // tx that's in the mempool.\n-                if (m_pool.exists(tx.vin[j].prevout.hash)) {\n-                    return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"replacement-adds-unconfirmed\",\n-                            strprintf(\"replacement %s adds unconfirmed input, idx %d\",\n-                                hash.ToString(), j));\n-                }\n-            }\n-        }\n+        if (!PaysMoreThanConflicts(setIterConflicting, newFeeRate, state, hash)) return false;\n \n-        // The replacement must pay greater fees than the transactions it\n-        // replaces - if we did the bandwidth used by those conflicting\n-        // transactions would not be paid for.\n-        if (nModifiedFees < nConflictingFees)\n-        {\n-            return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"insufficient fee\",\n-                    strprintf(\"rejecting replacement %s, less fees than conflicting txs; %s < %s\",\n-                        hash.ToString(), FormatMoney(nModifiedFees), FormatMoney(nConflictingFees)));\n-        }\n+        // Calculate all conflicting entries and enforce Rules 2 and 5.\n+        if (!GetEntriesForRBF(tx, m_pool, setIterConflicting, state, allConflicting)) return false;\n+        if (!HasNoNewUnconfirmed(tx, m_pool, setIterConflicting, state)) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692901343",
      "id" : 692901343,
      "line" : 778,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MjkwMTM0Mw==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 778,
      "original_position" : 161,
      "original_start_line" : 776,
      "path" : "src/validation.cpp",
      "position" : 161,
      "pull_request_review_id" : 734897366,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : 776,
      "start_side" : "RIGHT",
      "updated_at" : "2021-08-20T13:17:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692901343",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692903895"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692903895"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You don't actually need `logging.h`. You could just include `tinyformat.h`.",
      "commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "created_at" : "2021-08-20T12:24:26Z",
      "diff_hunk" : "@@ -2,14 +2,18 @@\n // Distributed under the MIT software license, see the accompanying\n // file COPYING or http://www.opensource.org/licenses/mit-license.php.\n \n+#include <consensus/validation.h>\n+#include <logging.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692903895",
      "id" : 692903895,
      "line" : 6,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MjkwMzg5NQ==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 6,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/policy/rbf.cpp",
      "position" : 5,
      "pull_request_review_id" : 734897366,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-20T13:17:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692903895",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692905894"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692905894"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This seems like an odd detail to specify in the interface, when this function is only ever called with an empty `all_conflicts` set.",
      "commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "created_at" : "2021-08-20T12:27:52Z",
      "diff_hunk" : "@@ -31,4 +36,51 @@ enum class RBFTransactionState {\n RBFTransactionState IsRBFOptIn(const CTransaction& tx, const CTxMemPool& pool) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx);\n \n+/** Get all descendants of iters_conflicting. Also enforce BIP125 Rule 5 and quit as early as\n+ * possible. There cannot be more than MAX_BIP125_REPLACEMENT_CANDIDATES potential entries.\n+ * @param[in]   iters_conflicting   The set of iterators to mempool entries.\n+ * @param[out]  state               Used to return errors, if any.\n+ * @param[out]  all_conflicts       Populated with all the mempool entries that would be replaced,\n+ *                                  which includes descendants of iters_conflicting. Not cleared at\n+ *                                  the start; any existing mempool entries will remain in the set.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692905894",
      "id" : 692905894,
      "line" : 45,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MjkwNTg5NA==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 45,
      "original_position" : 22,
      "original_start_line" : 44,
      "path" : "src/policy/rbf.h",
      "position" : 22,
      "pull_request_review_id" : 734897366,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : 44,
      "start_side" : "RIGHT",
      "updated_at" : "2021-08-20T13:17:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692905894",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692908052"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692908052"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Perhaps this should be named `GetEntriesForRBFConflicts()` or similar?",
      "commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "created_at" : "2021-08-20T12:31:25Z",
      "diff_hunk" : "@@ -31,4 +36,51 @@ enum class RBFTransactionState {\n RBFTransactionState IsRBFOptIn(const CTransaction& tx, const CTxMemPool& pool) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx);\n \n+/** Get all descendants of iters_conflicting. Also enforce BIP125 Rule 5 and quit as early as\n+ * possible. There cannot be more than MAX_BIP125_REPLACEMENT_CANDIDATES potential entries.\n+ * @param[in]   iters_conflicting   The set of iterators to mempool entries.\n+ * @param[out]  state               Used to return errors, if any.\n+ * @param[out]  all_conflicts       Populated with all the mempool entries that would be replaced,\n+ *                                  which includes descendants of iters_conflicting. Not cleared at\n+ *                                  the start; any existing mempool entries will remain in the set.\n+ * @returns false if Rule 5 is broken.\n+ */\n+bool GetEntriesForRBF(const CTransaction& tx, CTxMemPool& pool,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692908052",
      "id" : 692908052,
      "line" : 48,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MjkwODA1Mg==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 48,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/policy/rbf.h",
      "position" : 25,
      "pull_request_review_id" : 734897366,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-20T13:17:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692908052",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692909522"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692909522"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In fixup commit:\r\n\r\n```suggestion\r\n    for (unsigned int j = 0; j < tx.vin.size(); j++) {\r\n```",
      "commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "created_at" : "2021-08-20T12:33:50Z",
      "diff_hunk" : "@@ -42,3 +46,133 @@ RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx)\n     // If we don't have a local mempool we can only check the transaction itself.\n     return SignalsOptInRBF(tx) ? RBFTransactionState::REPLACEABLE_BIP125 : RBFTransactionState::UNKNOWN;\n }\n+\n+bool GetEntriesForRBF(const CTransaction& tx, CTxMemPool& pool,\n+                      const CTxMemPool::setEntries& iters_conflicting,\n+                      TxValidationState& state, CTxMemPool::setEntries& all_conflicts)\n+{\n+    AssertLockHeld(pool.cs);\n+    const uint256 hash = tx.GetHash();\n+    uint64_t nConflictingCount = 0;\n+    for (const auto& mi : iters_conflicting) {\n+        nConflictingCount += mi->GetCountWithDescendants();\n+        // This potentially overestimates the number of actual descendants but we just want to be\n+        // conservative to avoid doing too much work.\n+        if (nConflictingCount > MAX_BIP125_REPLACEMENT_CANDIDATES) {\n+            return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"too many potential replacements\",\n+                strprintf(\"rejecting replacement %s; too many potential replacements (%d > %d)\\n\",\n+                          hash.ToString(),\n+                          nConflictingCount,\n+                          MAX_BIP125_REPLACEMENT_CANDIDATES));\n+        }\n+    }\n+    // If not too many to replace, then calculate the set of\n+    // transactions that would have to be evicted\n+    for (CTxMemPool::txiter it : iters_conflicting) {\n+        pool.CalculateDescendants(it, all_conflicts);\n+    }\n+    return true;\n+}\n+\n+bool HasNoNewUnconfirmed(const CTransaction& tx, const CTxMemPool& pool,\n+                         const CTxMemPool::setEntries& iters_conflicting,\n+                         TxValidationState& state)\n+{\n+    AssertLockHeld(pool.cs);\n+    std::set<uint256> parents_of_conflicts;\n+    for (const auto& mi : iters_conflicting) {\n+        for (const CTxIn &txin : mi->GetTx().vin) {\n+            parents_of_conflicts.insert(txin.prevout.hash);\n+        }\n+    }\n+\n+    for (unsigned int j = 0; j < tx.vin.size(); j++)\n+    {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692909522",
      "id" : 692909522,
      "line" : 90,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MjkwOTUyMg==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 90,
      "original_position" : 77,
      "original_start_line" : 89,
      "path" : "src/policy/rbf.cpp",
      "position" : 77,
      "pull_request_review_id" : 734897366,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : 89,
      "start_side" : "RIGHT",
      "updated_at" : "2021-08-20T13:17:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692909522",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692912024"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692912024"
         }
      },
      "author_association" : "MEMBER",
      "body" : "These are txids, not mempool entries:\r\n\r\n```suggestion\r\n * @param[in]   direct_conflicts    Set of txids for entries corresponding to the mempool conflicts\r\n *                                  (candidates to be replaced).\r\n```\r\n\r\nThis comment uses the wrong argument name in commit 4f656bb23c _MOVEONLY: check for disjoint conflicts and ancestors to policy/rbf_ (fixed in later commit)",
      "commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "created_at" : "2021-08-20T12:37:58Z",
      "diff_hunk" : "@@ -31,4 +36,51 @@ enum class RBFTransactionState {\n RBFTransactionState IsRBFOptIn(const CTransaction& tx, const CTxMemPool& pool) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx);\n \n+/** Get all descendants of iters_conflicting. Also enforce BIP125 Rule 5 and quit as early as\n+ * possible. There cannot be more than MAX_BIP125_REPLACEMENT_CANDIDATES potential entries.\n+ * @param[in]   iters_conflicting   The set of iterators to mempool entries.\n+ * @param[out]  state               Used to return errors, if any.\n+ * @param[out]  all_conflicts       Populated with all the mempool entries that would be replaced,\n+ *                                  which includes descendants of iters_conflicting. Not cleared at\n+ *                                  the start; any existing mempool entries will remain in the set.\n+ * @returns false if Rule 5 is broken.\n+ */\n+bool GetEntriesForRBF(const CTransaction& tx, CTxMemPool& pool,\n+                      const CTxMemPool::setEntries& iters_conflicting, TxValidationState& state,\n+                      CTxMemPool::setEntries& all_conflicts) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n+\n+/** Enforce BIP125 Rule 2: a replacement transaction must not add any new unconfirmed inputs. */\n+bool HasNoNewUnconfirmed(const CTransaction& tx, const CTxMemPool& pool,\n+                         const CTxMemPool::setEntries& iters_conflicting,\n+                         TxValidationState& state) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n+\n+/** Check the intersection between two sets of mempool entries to make sure they are disjoint.\n+ * @param[in]   ancestors           Set of mempool entries corresponding to ancestors of the\n+ *                                  replacement transactions.\n+ * @param[in]   direct_conflicts    Set of mempool entries corresponding to the mempool conflicts\n+ *                                  (candidates to be replaced).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692912024",
      "id" : 692912024,
      "line" : 61,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MjkxMjAyNA==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 61,
      "original_position" : 38,
      "original_start_line" : 60,
      "path" : "src/policy/rbf.h",
      "position" : 38,
      "pull_request_review_id" : 734897366,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : 60,
      "start_side" : "RIGHT",
      "updated_at" : "2021-08-20T13:17:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692912024",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692912546"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692912546"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I agree that `txid` would be better than `hash` here (and for `PaysMoreThanConflicts()` below).",
      "commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "created_at" : "2021-08-20T12:38:50Z",
      "diff_hunk" : "@@ -31,4 +36,51 @@ enum class RBFTransactionState {\n RBFTransactionState IsRBFOptIn(const CTransaction& tx, const CTxMemPool& pool) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx);\n \n+/** Get all descendants of iters_conflicting. Also enforce BIP125 Rule 5 and quit as early as\n+ * possible. There cannot be more than MAX_BIP125_REPLACEMENT_CANDIDATES potential entries.\n+ * @param[in]   iters_conflicting   The set of iterators to mempool entries.\n+ * @param[out]  state               Used to return errors, if any.\n+ * @param[out]  all_conflicts       Populated with all the mempool entries that would be replaced,\n+ *                                  which includes descendants of iters_conflicting. Not cleared at\n+ *                                  the start; any existing mempool entries will remain in the set.\n+ * @returns false if Rule 5 is broken.\n+ */\n+bool GetEntriesForRBF(const CTransaction& tx, CTxMemPool& pool,\n+                      const CTxMemPool::setEntries& iters_conflicting, TxValidationState& state,\n+                      CTxMemPool::setEntries& all_conflicts) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n+\n+/** Enforce BIP125 Rule 2: a replacement transaction must not add any new unconfirmed inputs. */\n+bool HasNoNewUnconfirmed(const CTransaction& tx, const CTxMemPool& pool,\n+                         const CTxMemPool::setEntries& iters_conflicting,\n+                         TxValidationState& state) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n+\n+/** Check the intersection between two sets of mempool entries to make sure they are disjoint.\n+ * @param[in]   ancestors           Set of mempool entries corresponding to ancestors of the\n+ *                                  replacement transactions.\n+ * @param[in]   direct_conflicts    Set of mempool entries corresponding to the mempool conflicts\n+ *                                  (candidates to be replaced).\n+ * @param[in]   hash                Transaction ID, included in the error message if violation occurs.\n+ * returns true if the two sets are disjoint (i.e. intersection is empty), false if otherwise.\n+ */\n+bool SpendsAndConflictsDisjoint(const CTxMemPool::setEntries& ancestors,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692912546",
      "id" : 692912546,
      "in_reply_to_id" : 691695502,
      "line" : 65,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MjkxMjU0Ng==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 65,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/policy/rbf.h",
      "position" : 42,
      "pull_request_review_id" : 734897366,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-20T13:17:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692912546",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692912827"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692912827"
         }
      },
      "author_association" : "MEMBER",
      "body" : "As below, the second argument isn't mempool entries.",
      "commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "created_at" : "2021-08-20T12:39:21Z",
      "diff_hunk" : "@@ -31,4 +36,51 @@ enum class RBFTransactionState {\n RBFTransactionState IsRBFOptIn(const CTransaction& tx, const CTxMemPool& pool) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx);\n \n+/** Get all descendants of iters_conflicting. Also enforce BIP125 Rule 5 and quit as early as\n+ * possible. There cannot be more than MAX_BIP125_REPLACEMENT_CANDIDATES potential entries.\n+ * @param[in]   iters_conflicting   The set of iterators to mempool entries.\n+ * @param[out]  state               Used to return errors, if any.\n+ * @param[out]  all_conflicts       Populated with all the mempool entries that would be replaced,\n+ *                                  which includes descendants of iters_conflicting. Not cleared at\n+ *                                  the start; any existing mempool entries will remain in the set.\n+ * @returns false if Rule 5 is broken.\n+ */\n+bool GetEntriesForRBF(const CTransaction& tx, CTxMemPool& pool,\n+                      const CTxMemPool::setEntries& iters_conflicting, TxValidationState& state,\n+                      CTxMemPool::setEntries& all_conflicts) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n+\n+/** Enforce BIP125 Rule 2: a replacement transaction must not add any new unconfirmed inputs. */\n+bool HasNoNewUnconfirmed(const CTransaction& tx, const CTxMemPool& pool,\n+                         const CTxMemPool::setEntries& iters_conflicting,\n+                         TxValidationState& state) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n+\n+/** Check the intersection between two sets of mempool entries to make sure they are disjoint.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692912827",
      "id" : 692912827,
      "line" : 57,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MjkxMjgyNw==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 57,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/policy/rbf.h",
      "position" : 34,
      "pull_request_review_id" : 734897366,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-20T13:17:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692912827",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692915252"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692915252"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe worth adding a comment here that this is a consensus rule violation since the transaction is self-inconsistent, and can never be valid.",
      "commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "created_at" : "2021-08-20T12:43:05Z",
      "diff_hunk" : "@@ -42,3 +46,133 @@ RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx)\n     // If we don't have a local mempool we can only check the transaction itself.\n     return SignalsOptInRBF(tx) ? RBFTransactionState::REPLACEABLE_BIP125 : RBFTransactionState::UNKNOWN;\n }\n+\n+bool GetEntriesForRBF(const CTransaction& tx, CTxMemPool& pool,\n+                      const CTxMemPool::setEntries& iters_conflicting,\n+                      TxValidationState& state, CTxMemPool::setEntries& all_conflicts)\n+{\n+    AssertLockHeld(pool.cs);\n+    const uint256 hash = tx.GetHash();\n+    uint64_t nConflictingCount = 0;\n+    for (const auto& mi : iters_conflicting) {\n+        nConflictingCount += mi->GetCountWithDescendants();\n+        // This potentially overestimates the number of actual descendants but we just want to be\n+        // conservative to avoid doing too much work.\n+        if (nConflictingCount > MAX_BIP125_REPLACEMENT_CANDIDATES) {\n+            return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"too many potential replacements\",\n+                strprintf(\"rejecting replacement %s; too many potential replacements (%d > %d)\\n\",\n+                          hash.ToString(),\n+                          nConflictingCount,\n+                          MAX_BIP125_REPLACEMENT_CANDIDATES));\n+        }\n+    }\n+    // If not too many to replace, then calculate the set of\n+    // transactions that would have to be evicted\n+    for (CTxMemPool::txiter it : iters_conflicting) {\n+        pool.CalculateDescendants(it, all_conflicts);\n+    }\n+    return true;\n+}\n+\n+bool HasNoNewUnconfirmed(const CTransaction& tx, const CTxMemPool& pool,\n+                         const CTxMemPool::setEntries& iters_conflicting,\n+                         TxValidationState& state)\n+{\n+    AssertLockHeld(pool.cs);\n+    std::set<uint256> parents_of_conflicts;\n+    for (const auto& mi : iters_conflicting) {\n+        for (const CTxIn &txin : mi->GetTx().vin) {\n+            parents_of_conflicts.insert(txin.prevout.hash);\n+        }\n+    }\n+\n+    for (unsigned int j = 0; j < tx.vin.size(); j++)\n+    {\n+        // We don't want to accept replacements that require low feerate junk to be mined first.\n+        // Ideally we'd keep track of the ancestor feerates and make the decision based on that, but\n+        // for now requiring all new inputs to be confirmed works.\n+        //\n+        // Note that if you relax this to make RBF a little more useful, this may break the\n+        // CalculateMempoolAncestors RBF relaxation, above. See the comment above the first\n+        // CalculateMempoolAncestors call for more info.\n+        if (!parents_of_conflicts.count(tx.vin[j].prevout.hash)) {\n+            // Rather than check the UTXO set - potentially expensive - it's cheaper to just check\n+            // if the new input refers to a tx that's in the mempool.\n+            if (pool.exists(tx.vin[j].prevout.hash)) {\n+                return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"replacement-adds-unconfirmed\",\n+                    strprintf(\"replacement %s adds unconfirmed input, idx %d\",\n+                              tx.GetHash().ToString(),\n+                              j));\n+            }\n+        }\n+    }\n+    return true;\n+}\n+\n+bool SpendsAndConflictsDisjoint(const CTxMemPool::setEntries& ancestors,\n+                                const std::set<uint256>& direct_conflicts,\n+                                TxValidationState& state, const uint256& hash)\n+{\n+    for (CTxMemPool::txiter ancestorIt : ancestors) {\n+        const uint256 &hashAncestor = ancestorIt->GetTx().GetHash();\n+        if (direct_conflicts.count(hashAncestor)) {\n+            return state.Invalid(TxValidationResult::TX_CONSENSUS, \"bad-txns-spends-conflicting-tx\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692915252",
      "id" : 692915252,
      "line" : 119,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MjkxNTI1Mg==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 119,
      "original_position" : 106,
      "original_start_line" : null,
      "path" : "src/policy/rbf.cpp",
      "position" : 106,
      "pull_request_review_id" : 734897366,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-20T13:17:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692915252",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692925516"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692925516"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe explicitly mention BIP125 rule 3 in this comment.",
      "commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "created_at" : "2021-08-20T12:58:43Z",
      "diff_hunk" : "@@ -42,3 +46,133 @@ RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx)\n     // If we don't have a local mempool we can only check the transaction itself.\n     return SignalsOptInRBF(tx) ? RBFTransactionState::REPLACEABLE_BIP125 : RBFTransactionState::UNKNOWN;\n }\n+\n+bool GetEntriesForRBF(const CTransaction& tx, CTxMemPool& pool,\n+                      const CTxMemPool::setEntries& iters_conflicting,\n+                      TxValidationState& state, CTxMemPool::setEntries& all_conflicts)\n+{\n+    AssertLockHeld(pool.cs);\n+    const uint256 hash = tx.GetHash();\n+    uint64_t nConflictingCount = 0;\n+    for (const auto& mi : iters_conflicting) {\n+        nConflictingCount += mi->GetCountWithDescendants();\n+        // This potentially overestimates the number of actual descendants but we just want to be\n+        // conservative to avoid doing too much work.\n+        if (nConflictingCount > MAX_BIP125_REPLACEMENT_CANDIDATES) {\n+            return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"too many potential replacements\",\n+                strprintf(\"rejecting replacement %s; too many potential replacements (%d > %d)\\n\",\n+                          hash.ToString(),\n+                          nConflictingCount,\n+                          MAX_BIP125_REPLACEMENT_CANDIDATES));\n+        }\n+    }\n+    // If not too many to replace, then calculate the set of\n+    // transactions that would have to be evicted\n+    for (CTxMemPool::txiter it : iters_conflicting) {\n+        pool.CalculateDescendants(it, all_conflicts);\n+    }\n+    return true;\n+}\n+\n+bool HasNoNewUnconfirmed(const CTransaction& tx, const CTxMemPool& pool,\n+                         const CTxMemPool::setEntries& iters_conflicting,\n+                         TxValidationState& state)\n+{\n+    AssertLockHeld(pool.cs);\n+    std::set<uint256> parents_of_conflicts;\n+    for (const auto& mi : iters_conflicting) {\n+        for (const CTxIn &txin : mi->GetTx().vin) {\n+            parents_of_conflicts.insert(txin.prevout.hash);\n+        }\n+    }\n+\n+    for (unsigned int j = 0; j < tx.vin.size(); j++)\n+    {\n+        // We don't want to accept replacements that require low feerate junk to be mined first.\n+        // Ideally we'd keep track of the ancestor feerates and make the decision based on that, but\n+        // for now requiring all new inputs to be confirmed works.\n+        //\n+        // Note that if you relax this to make RBF a little more useful, this may break the\n+        // CalculateMempoolAncestors RBF relaxation, above. See the comment above the first\n+        // CalculateMempoolAncestors call for more info.\n+        if (!parents_of_conflicts.count(tx.vin[j].prevout.hash)) {\n+            // Rather than check the UTXO set - potentially expensive - it's cheaper to just check\n+            // if the new input refers to a tx that's in the mempool.\n+            if (pool.exists(tx.vin[j].prevout.hash)) {\n+                return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"replacement-adds-unconfirmed\",\n+                    strprintf(\"replacement %s adds unconfirmed input, idx %d\",\n+                              tx.GetHash().ToString(),\n+                              j));\n+            }\n+        }\n+    }\n+    return true;\n+}\n+\n+bool SpendsAndConflictsDisjoint(const CTxMemPool::setEntries& ancestors,\n+                                const std::set<uint256>& direct_conflicts,\n+                                TxValidationState& state, const uint256& hash)\n+{\n+    for (CTxMemPool::txiter ancestorIt : ancestors) {\n+        const uint256 &hashAncestor = ancestorIt->GetTx().GetHash();\n+        if (direct_conflicts.count(hashAncestor)) {\n+            return state.Invalid(TxValidationResult::TX_CONSENSUS, \"bad-txns-spends-conflicting-tx\",\n+                strprintf(\"%s spends conflicting transaction %s\",\n+                          hash.ToString(),\n+                          hashAncestor.ToString()));\n+        }\n+    }\n+    return true;\n+}\n+\n+bool PaysMoreThanConflicts(const CTxMemPool::setEntries& iters_conflicting, CFeeRate replacement_feerate,\n+                           TxValidationState& state, const uint256& hash)\n+{\n+    for (const auto& mi : iters_conflicting) {\n+        // Don't allow the replacement to reduce the feerate of the mempool.\n+        //\n+        // We usually don't want to accept replacements with lower feerates than what they replaced\n+        // as that would lower the feerate of the next block. Requiring that the feerate always be\n+        // increased is also an easy-to-reason about way to prevent DoS attacks via replacements.\n+        //\n+        // We only consider the feerates of transactions being directly replaced, not their indirect\n+        // descendants. While that does mean high feerate children are ignored when deciding whether\n+        // or not to replace, we do require the replacement to pay more overall fees too, mitigating\n+        // most cases.\n+        CFeeRate original_feerate(mi->GetModifiedFee(), mi->GetTxSize());\n+        if (replacement_feerate <= original_feerate) {\n+            return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"insufficient fee\",\n+                strprintf(\"rejecting replacement %s; new feerate %s <= old feerate %s\",\n+                          hash.ToString(),\n+                          replacement_feerate.ToString(),\n+                          original_feerate.ToString()));\n+        }\n+    }\n+    return true;\n+}\n+\n+bool PaysForRBF(CAmount original_fees, CAmount replacement_fees, size_t replacement_vsize,\n+                TxValidationState& state, const uint256& hash)\n+{\n+    // The replacement must pay greater fees than the transactions it replaces - if we did the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692925516",
      "id" : 692925516,
      "line" : 157,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MjkyNTUxNg==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 157,
      "original_position" : 144,
      "original_start_line" : null,
      "path" : "src/policy/rbf.cpp",
      "position" : 144,
      "pull_request_review_id" : 734897366,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-20T13:17:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692925516",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692926040"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692926040"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe explicitly mention BIP125 rule 4 in this comment. Also remove \"Finally\" - I guess that was there before because this was the final check in `PreChecks()`.",
      "commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "created_at" : "2021-08-20T12:59:31Z",
      "diff_hunk" : "@@ -42,3 +46,133 @@ RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx)\n     // If we don't have a local mempool we can only check the transaction itself.\n     return SignalsOptInRBF(tx) ? RBFTransactionState::REPLACEABLE_BIP125 : RBFTransactionState::UNKNOWN;\n }\n+\n+bool GetEntriesForRBF(const CTransaction& tx, CTxMemPool& pool,\n+                      const CTxMemPool::setEntries& iters_conflicting,\n+                      TxValidationState& state, CTxMemPool::setEntries& all_conflicts)\n+{\n+    AssertLockHeld(pool.cs);\n+    const uint256 hash = tx.GetHash();\n+    uint64_t nConflictingCount = 0;\n+    for (const auto& mi : iters_conflicting) {\n+        nConflictingCount += mi->GetCountWithDescendants();\n+        // This potentially overestimates the number of actual descendants but we just want to be\n+        // conservative to avoid doing too much work.\n+        if (nConflictingCount > MAX_BIP125_REPLACEMENT_CANDIDATES) {\n+            return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"too many potential replacements\",\n+                strprintf(\"rejecting replacement %s; too many potential replacements (%d > %d)\\n\",\n+                          hash.ToString(),\n+                          nConflictingCount,\n+                          MAX_BIP125_REPLACEMENT_CANDIDATES));\n+        }\n+    }\n+    // If not too many to replace, then calculate the set of\n+    // transactions that would have to be evicted\n+    for (CTxMemPool::txiter it : iters_conflicting) {\n+        pool.CalculateDescendants(it, all_conflicts);\n+    }\n+    return true;\n+}\n+\n+bool HasNoNewUnconfirmed(const CTransaction& tx, const CTxMemPool& pool,\n+                         const CTxMemPool::setEntries& iters_conflicting,\n+                         TxValidationState& state)\n+{\n+    AssertLockHeld(pool.cs);\n+    std::set<uint256> parents_of_conflicts;\n+    for (const auto& mi : iters_conflicting) {\n+        for (const CTxIn &txin : mi->GetTx().vin) {\n+            parents_of_conflicts.insert(txin.prevout.hash);\n+        }\n+    }\n+\n+    for (unsigned int j = 0; j < tx.vin.size(); j++)\n+    {\n+        // We don't want to accept replacements that require low feerate junk to be mined first.\n+        // Ideally we'd keep track of the ancestor feerates and make the decision based on that, but\n+        // for now requiring all new inputs to be confirmed works.\n+        //\n+        // Note that if you relax this to make RBF a little more useful, this may break the\n+        // CalculateMempoolAncestors RBF relaxation, above. See the comment above the first\n+        // CalculateMempoolAncestors call for more info.\n+        if (!parents_of_conflicts.count(tx.vin[j].prevout.hash)) {\n+            // Rather than check the UTXO set - potentially expensive - it's cheaper to just check\n+            // if the new input refers to a tx that's in the mempool.\n+            if (pool.exists(tx.vin[j].prevout.hash)) {\n+                return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"replacement-adds-unconfirmed\",\n+                    strprintf(\"replacement %s adds unconfirmed input, idx %d\",\n+                              tx.GetHash().ToString(),\n+                              j));\n+            }\n+        }\n+    }\n+    return true;\n+}\n+\n+bool SpendsAndConflictsDisjoint(const CTxMemPool::setEntries& ancestors,\n+                                const std::set<uint256>& direct_conflicts,\n+                                TxValidationState& state, const uint256& hash)\n+{\n+    for (CTxMemPool::txiter ancestorIt : ancestors) {\n+        const uint256 &hashAncestor = ancestorIt->GetTx().GetHash();\n+        if (direct_conflicts.count(hashAncestor)) {\n+            return state.Invalid(TxValidationResult::TX_CONSENSUS, \"bad-txns-spends-conflicting-tx\",\n+                strprintf(\"%s spends conflicting transaction %s\",\n+                          hash.ToString(),\n+                          hashAncestor.ToString()));\n+        }\n+    }\n+    return true;\n+}\n+\n+bool PaysMoreThanConflicts(const CTxMemPool::setEntries& iters_conflicting, CFeeRate replacement_feerate,\n+                           TxValidationState& state, const uint256& hash)\n+{\n+    for (const auto& mi : iters_conflicting) {\n+        // Don't allow the replacement to reduce the feerate of the mempool.\n+        //\n+        // We usually don't want to accept replacements with lower feerates than what they replaced\n+        // as that would lower the feerate of the next block. Requiring that the feerate always be\n+        // increased is also an easy-to-reason about way to prevent DoS attacks via replacements.\n+        //\n+        // We only consider the feerates of transactions being directly replaced, not their indirect\n+        // descendants. While that does mean high feerate children are ignored when deciding whether\n+        // or not to replace, we do require the replacement to pay more overall fees too, mitigating\n+        // most cases.\n+        CFeeRate original_feerate(mi->GetModifiedFee(), mi->GetTxSize());\n+        if (replacement_feerate <= original_feerate) {\n+            return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"insufficient fee\",\n+                strprintf(\"rejecting replacement %s; new feerate %s <= old feerate %s\",\n+                          hash.ToString(),\n+                          replacement_feerate.ToString(),\n+                          original_feerate.ToString()));\n+        }\n+    }\n+    return true;\n+}\n+\n+bool PaysForRBF(CAmount original_fees, CAmount replacement_fees, size_t replacement_vsize,\n+                TxValidationState& state, const uint256& hash)\n+{\n+    // The replacement must pay greater fees than the transactions it replaces - if we did the\n+    // bandwidth used by those conflicting transactions would not be paid for.\n+    if (replacement_fees < original_fees) {\n+        return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"insufficient fee\",\n+            strprintf(\"rejecting replacement %s, less fees than conflicting txs; %s < %s\",\n+                      hash.ToString(),\n+                      FormatMoney(replacement_fees),\n+                      FormatMoney(original_fees)));\n+    }\n+\n+    // Finally in addition to paying more fees than the conflicts the new transaction must pay for",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692926040",
      "id" : 692926040,
      "line" : 167,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MjkyNjA0MA==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 167,
      "original_position" : 154,
      "original_start_line" : null,
      "path" : "src/policy/rbf.cpp",
      "position" : 154,
      "pull_request_review_id" : 734897366,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-20T13:17:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692926040",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692928092"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692928092"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe explicitly mention that this is BIP125 rule 2.",
      "commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "created_at" : "2021-08-20T13:02:30Z",
      "diff_hunk" : "@@ -42,3 +46,133 @@ RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx)\n     // If we don't have a local mempool we can only check the transaction itself.\n     return SignalsOptInRBF(tx) ? RBFTransactionState::REPLACEABLE_BIP125 : RBFTransactionState::UNKNOWN;\n }\n+\n+bool GetEntriesForRBF(const CTransaction& tx, CTxMemPool& pool,\n+                      const CTxMemPool::setEntries& iters_conflicting,\n+                      TxValidationState& state, CTxMemPool::setEntries& all_conflicts)\n+{\n+    AssertLockHeld(pool.cs);\n+    const uint256 hash = tx.GetHash();\n+    uint64_t nConflictingCount = 0;\n+    for (const auto& mi : iters_conflicting) {\n+        nConflictingCount += mi->GetCountWithDescendants();\n+        // This potentially overestimates the number of actual descendants but we just want to be\n+        // conservative to avoid doing too much work.\n+        if (nConflictingCount > MAX_BIP125_REPLACEMENT_CANDIDATES) {\n+            return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"too many potential replacements\",\n+                strprintf(\"rejecting replacement %s; too many potential replacements (%d > %d)\\n\",\n+                          hash.ToString(),\n+                          nConflictingCount,\n+                          MAX_BIP125_REPLACEMENT_CANDIDATES));\n+        }\n+    }\n+    // If not too many to replace, then calculate the set of\n+    // transactions that would have to be evicted\n+    for (CTxMemPool::txiter it : iters_conflicting) {\n+        pool.CalculateDescendants(it, all_conflicts);\n+    }\n+    return true;\n+}\n+\n+bool HasNoNewUnconfirmed(const CTransaction& tx, const CTxMemPool& pool,\n+                         const CTxMemPool::setEntries& iters_conflicting,\n+                         TxValidationState& state)\n+{\n+    AssertLockHeld(pool.cs);\n+    std::set<uint256> parents_of_conflicts;\n+    for (const auto& mi : iters_conflicting) {\n+        for (const CTxIn &txin : mi->GetTx().vin) {\n+            parents_of_conflicts.insert(txin.prevout.hash);\n+        }\n+    }\n+\n+    for (unsigned int j = 0; j < tx.vin.size(); j++)\n+    {\n+        // We don't want to accept replacements that require low feerate junk to be mined first.\n+        // Ideally we'd keep track of the ancestor feerates and make the decision based on that, but\n+        // for now requiring all new inputs to be confirmed works.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692928092",
      "id" : 692928092,
      "line" : 93,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MjkyODA5Mg==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 93,
      "original_position" : 80,
      "original_start_line" : 92,
      "path" : "src/policy/rbf.cpp",
      "position" : 80,
      "pull_request_review_id" : 734897366,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : 92,
      "start_side" : "RIGHT",
      "updated_at" : "2021-08-20T13:17:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692928092",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692928855"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692928855"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe explicitly comment that this is BIP125 rule 1.",
      "commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "created_at" : "2021-08-20T13:03:39Z",
      "diff_hunk" : "@@ -15,3 +15,26 @@ bool SignalsOptInRBF(const CTransaction &tx)\n     }\n     return false;\n }\n+\n+bool IsRBFOptOut(const CTransaction& txConflicting)\n+{\n+    // Allow opt-out of transaction replacement by setting\n+    // nSequence > MAX_BIP125_RBF_SEQUENCE (SEQUENCE_FINAL-2) on all inputs.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692928855",
      "id" : 692928855,
      "line" : 22,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MjkyODg1NQ==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 22,
      "original_position" : 8,
      "original_start_line" : 21,
      "path" : "src/util/rbf.cpp",
      "position" : 8,
      "pull_request_review_id" : 734897366,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : 21,
      "start_side" : "RIGHT",
      "updated_at" : "2021-08-20T13:17:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692928855",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692929833"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692929833"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe explicitly comment that this is BIP125 rule 5.",
      "commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "created_at" : "2021-08-20T13:05:04Z",
      "diff_hunk" : "@@ -42,3 +46,133 @@ RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx)\n     // If we don't have a local mempool we can only check the transaction itself.\n     return SignalsOptInRBF(tx) ? RBFTransactionState::REPLACEABLE_BIP125 : RBFTransactionState::UNKNOWN;\n }\n+\n+bool GetEntriesForRBF(const CTransaction& tx, CTxMemPool& pool,\n+                      const CTxMemPool::setEntries& iters_conflicting,\n+                      TxValidationState& state, CTxMemPool::setEntries& all_conflicts)\n+{\n+    AssertLockHeld(pool.cs);\n+    const uint256 hash = tx.GetHash();\n+    uint64_t nConflictingCount = 0;\n+    for (const auto& mi : iters_conflicting) {\n+        nConflictingCount += mi->GetCountWithDescendants();\n+        // This potentially overestimates the number of actual descendants but we just want to be\n+        // conservative to avoid doing too much work.\n+        if (nConflictingCount > MAX_BIP125_REPLACEMENT_CANDIDATES) {\n+            return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"too many potential replacements\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692929833",
      "id" : 692929833,
      "line" : 62,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MjkyOTgzMw==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 62,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/policy/rbf.cpp",
      "position" : 49,
      "pull_request_review_id" : 734897366,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-20T13:17:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692929833",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692937815"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692937815"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Since you're changing the parameter name already, consider:\r\n\r\n```suggestion\r\nbool IsRBFOptOut(const CTransaction& tx);\r\n```",
      "commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "created_at" : "2021-08-20T13:16:32Z",
      "diff_hunk" : "@@ -15,4 +15,7 @@ static const uint32_t MAX_BIP125_RBF_SEQUENCE = 0xfffffffd;\n // opt-in to replace-by-fee, according to BIP 125\n bool SignalsOptInRBF(const CTransaction &tx);\n \n+/** Determine whether a mempool transaction is opting out of RBF. Mempool entries do not inherit\n+ * signaling from their parents in this implementation. */\n+bool IsRBFOptOut(const CTransaction& txConflicting);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692937815",
      "id" : 692937815,
      "in_reply_to_id" : 691672020,
      "line" : 20,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MjkzNzgxNQ==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 20,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/util/rbf.h",
      "position" : 6,
      "pull_request_review_id" : 734897366,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-20T13:17:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692937815",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692991925"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692991925"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "![image](https://user-images.githubusercontent.com/25183001/130248786-e8c84e2f-4932-4605-b372-fb5c9edb4976.png)\r\n",
      "commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "created_at" : "2021-08-20T14:28:49Z",
      "diff_hunk" : "@@ -31,4 +36,51 @@ enum class RBFTransactionState {\n RBFTransactionState IsRBFOptIn(const CTransaction& tx, const CTxMemPool& pool) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx);\n \n+/** Get all descendants of iters_conflicting. Also enforce BIP125 Rule 5 and quit as early as\n+ * possible. There cannot be more than MAX_BIP125_REPLACEMENT_CANDIDATES potential entries.\n+ * @param[in]   iters_conflicting   The set of iterators to mempool entries.\n+ * @param[out]  state               Used to return errors, if any.\n+ * @param[out]  all_conflicts       Populated with all the mempool entries that would be replaced,\n+ *                                  which includes descendants of iters_conflicting. Not cleared at\n+ *                                  the start; any existing mempool entries will remain in the set.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692991925",
      "id" : 692991925,
      "in_reply_to_id" : 692905894,
      "line" : 45,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5Mjk5MTkyNQ==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 45,
      "original_position" : 22,
      "original_start_line" : 44,
      "path" : "src/policy/rbf.h",
      "position" : 22,
      "pull_request_review_id" : 735089756,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : 44,
      "start_side" : "RIGHT",
      "updated_at" : "2021-08-20T14:28:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692991925",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692993619"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692993619"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "https://github.com/bitcoin/bitcoin/pull/22290/commits/6c04bf5a60e2af86c326c4e65aba777d8bf768bb#diff-97c3a52bc5fad452d82670a7fd291800bae20c7bc35bb82686c2c0a4ea7b5b98R970-R972",
      "commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "created_at" : "2021-08-20T14:31:03Z",
      "diff_hunk" : "@@ -31,4 +36,51 @@ enum class RBFTransactionState {\n RBFTransactionState IsRBFOptIn(const CTransaction& tx, const CTxMemPool& pool) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx);\n \n+/** Get all descendants of iters_conflicting. Also enforce BIP125 Rule 5 and quit as early as\n+ * possible. There cannot be more than MAX_BIP125_REPLACEMENT_CANDIDATES potential entries.\n+ * @param[in]   iters_conflicting   The set of iterators to mempool entries.\n+ * @param[out]  state               Used to return errors, if any.\n+ * @param[out]  all_conflicts       Populated with all the mempool entries that would be replaced,\n+ *                                  which includes descendants of iters_conflicting. Not cleared at\n+ *                                  the start; any existing mempool entries will remain in the set.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r692993619",
      "id" : 692993619,
      "in_reply_to_id" : 692905894,
      "line" : 45,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5Mjk5MzYxOQ==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 45,
      "original_position" : 22,
      "original_start_line" : 44,
      "path" : "src/policy/rbf.h",
      "position" : 22,
      "pull_request_review_id" : 735091992,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : 44,
      "start_side" : "RIGHT",
      "updated_at" : "2021-08-20T14:31:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692993619",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r693095550"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/693095550"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Okie done",
      "commit_id" : "7d9fc8153cddec24e90f75662b37e4e46baa7469",
      "created_at" : "2021-08-20T17:05:43Z",
      "diff_hunk" : "@@ -15,6 +15,7 @@ EXPECTED_CIRCULAR_DEPENDENCIES=(\n     \"index/base -> validation -> index/blockfilterindex -> index/base\"\n     \"index/coinstatsindex -> node/coinstats -> index/coinstatsindex\"\n     \"policy/fees -> txmempool -> policy/fees\"\n+    \"policy/rbf -> txmempool -> validation -> policy/rbf\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r693095550",
      "id" : 693095550,
      "in_reply_to_id" : 689596026,
      "line" : 18,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MzA5NTU1MA==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 18,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/lint/lint-circular-dependencies.sh",
      "position" : 4,
      "pull_request_review_id" : 735226667,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-20T17:05:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/693095550",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r693095821"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/693095821"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Deleted this, ended up just calling `SignalsOptInRBF` instead",
      "commit_id" : "7d9fc8153cddec24e90f75662b37e4e46baa7469",
      "created_at" : "2021-08-20T17:06:11Z",
      "diff_hunk" : "@@ -15,4 +15,7 @@ static const uint32_t MAX_BIP125_RBF_SEQUENCE = 0xfffffffd;\n // opt-in to replace-by-fee, according to BIP 125\n bool SignalsOptInRBF(const CTransaction &tx);\n \n+/** Determine whether a mempool transaction is opting out of RBF. Mempool entries do not inherit\n+ * signaling from their parents in this implementation. */\n+bool IsRBFOptOut(const CTransaction& txConflicting);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r693095821",
      "id" : 693095821,
      "in_reply_to_id" : 691672020,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MzA5NTgyMQ==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 20,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/util/rbf.h",
      "position" : null,
      "pull_request_review_id" : 735227046,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-20T17:06:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/693095821",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r693096304"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/693096304"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "(Doesn't apply anymore because I deleted the function)",
      "commit_id" : "7d9fc8153cddec24e90f75662b37e4e46baa7469",
      "created_at" : "2021-08-20T17:07:00Z",
      "diff_hunk" : "@@ -15,3 +15,26 @@ bool SignalsOptInRBF(const CTransaction &tx)\n     }\n     return false;\n }\n+\n+bool IsRBFOptOut(const CTransaction& txConflicting)\n+{\n+    // Allow opt-out of transaction replacement by setting\n+    // nSequence > MAX_BIP125_RBF_SEQUENCE (SEQUENCE_FINAL-2) on all inputs.\n+    //\n+    // SEQUENCE_FINAL-1 is picked to still allow use of nLockTime by\n+    // non-replaceable transactions. All inputs rather than just one\n+    // is for the sake of multi-party protocols, where we don't\n+    // want a single party to be able to disable replacement.\n+    //\n+    // Transactions that don't explicitly signal replaceability are\n+    // *not* replaceable with the current logic, even if one of their\n+    // unconfirmed ancestors signals replaceability. This diverges\n+    // from BIP125's inherited signaling description (see CVE-2021-31876).\n+    // Applications relying on first-seen mempool behavior should\n+    // check all unconfirmed ancestors; otherwise an opt-in ancestor\n+    // might be replaced, causing removal of this descendant.\n+    for (const CTxIn &_txin : txConflicting.vin) {\n+        if (_txin.nSequence <= MAX_BIP125_RBF_SEQUENCE) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r693096304",
      "id" : 693096304,
      "in_reply_to_id" : 692846284,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MzA5NjMwNA==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 37,
      "original_position" : 23,
      "original_start_line" : 36,
      "path" : "src/util/rbf.cpp",
      "position" : null,
      "pull_request_review_id" : 735227642,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-08-20T17:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/693096304",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r693096529"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/693096529"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "7d9fc8153cddec24e90f75662b37e4e46baa7469",
      "created_at" : "2021-08-20T17:07:24Z",
      "diff_hunk" : "@@ -784,23 +761,8 @@ bool MemPoolAccept::PreChecks(ATMPArgs& args, Workspace& ws)\n     // that we have the set of all ancestors we can detect this\n     // pathological case by making sure setConflicts and setAncestors don't\n     // intersect.\n-    for (CTxMemPool::txiter ancestorIt : setAncestors)\n-    {\n-        const uint256 &hashAncestor = ancestorIt->GetTx().GetHash();\n-        if (setConflicts.count(hashAncestor))\n-        {\n-            return state.Invalid(TxValidationResult::TX_CONSENSUS, \"bad-txns-spends-conflicting-tx\",\n-                    strprintf(\"%s spends conflicting transaction %s\",\n-                        hash.ToString(),\n-                        hashAncestor.ToString()));\n-        }\n-    }\n+    if (!SpendsAndConflictsDisjoint(setAncestors, setConflicts, state, hash)) return false;\n \n-    // Check if it's economically rational to mine this transaction rather\n-    // than the ones it replaces.\n-    nConflictingFees = 0;\n-    nConflictingSize = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r693096529",
      "id" : 693096529,
      "in_reply_to_id" : 692891251,
      "line" : 802,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MzA5NjUyOQ==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 802,
      "original_position" : 61,
      "original_start_line" : 801,
      "path" : "src/validation.cpp",
      "position" : 77,
      "pull_request_review_id" : 735227921,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "LEFT",
      "start_line" : 801,
      "start_side" : "LEFT",
      "updated_at" : "2021-08-20T17:07:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/693096529",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r693097179"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/693097179"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Actually decided to remove this dependency because I realized it's not the right place to be deciding what `TxValidationResult` to return (should be in validation.cpp)\r\nBut yes, sorted includes :salute:",
      "commit_id" : "7d9fc8153cddec24e90f75662b37e4e46baa7469",
      "created_at" : "2021-08-20T17:08:32Z",
      "diff_hunk" : "@@ -6,6 +6,11 @@\n #define BITCOIN_POLICY_RBF_H\n \n #include <txmempool.h>\n+#include <consensus/validation.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r693097179",
      "id" : 693097179,
      "in_reply_to_id" : 692892064,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MzA5NzE3OQ==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 9,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/policy/rbf.h",
      "position" : null,
      "pull_request_review_id" : 735228741,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-20T17:08:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/693097179",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r693097385"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/693097385"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done, good point",
      "commit_id" : "7d9fc8153cddec24e90f75662b37e4e46baa7469",
      "created_at" : "2021-08-20T17:08:56Z",
      "diff_hunk" : "@@ -809,106 +771,21 @@ bool MemPoolAccept::PreChecks(ATMPArgs& args, Workspace& ws)\n     if (fReplacementTransaction)\n     {\n         CFeeRate newFeeRate(nModifiedFees, nSize);\n-        std::set<uint256> setConflictsParents;\n-        const int maxDescendantsToVisit = 100;\n-        for (const auto& mi : setIterConflicting) {\n-            // Don't allow the replacement to reduce the feerate of the\n-            // mempool.\n-            //\n-            // We usually don't want to accept replacements with lower\n-            // feerates than what they replaced as that would lower the\n-            // feerate of the next block. Requiring that the feerate always\n-            // be increased is also an easy-to-reason about way to prevent\n-            // DoS attacks via replacements.\n-            //\n-            // We only consider the feerates of transactions being directly\n-            // replaced, not their indirect descendants. While that does\n-            // mean high feerate children are ignored when deciding whether\n-            // or not to replace, we do require the replacement to pay more\n-            // overall fees too, mitigating most cases.\n-            CFeeRate oldFeeRate(mi->GetModifiedFee(), mi->GetTxSize());\n-            if (newFeeRate <= oldFeeRate)\n-            {\n-                return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"insufficient fee\",\n-                        strprintf(\"rejecting replacement %s; new feerate %s <= old feerate %s\",\n-                            hash.ToString(),\n-                            newFeeRate.ToString(),\n-                            oldFeeRate.ToString()));\n-            }\n-\n-            for (const CTxIn &txin : mi->GetTx().vin)\n-            {\n-                setConflictsParents.insert(txin.prevout.hash);\n-            }\n-\n-            nConflictingCount += mi->GetCountWithDescendants();\n-        }\n-        // This potentially overestimates the number of actual descendants\n-        // but we just want to be conservative to avoid doing too much\n-        // work.\n-        if (nConflictingCount <= maxDescendantsToVisit) {\n-            // If not too many to replace, then calculate the set of\n-            // transactions that would have to be evicted\n-            for (CTxMemPool::txiter it : setIterConflicting) {\n-                m_pool.CalculateDescendants(it, allConflicting);\n-            }\n-            for (CTxMemPool::txiter it : allConflicting) {\n-                nConflictingFees += it->GetModifiedFee();\n-                nConflictingSize += it->GetTxSize();\n-            }\n-        } else {\n-            return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"too many potential replacements\",\n-                    strprintf(\"rejecting replacement %s; too many potential replacements (%d > %d)\\n\",\n-                        hash.ToString(),\n-                        nConflictingCount,\n-                        maxDescendantsToVisit));\n-        }\n-\n-        for (unsigned int j = 0; j < tx.vin.size(); j++)\n-        {\n-            // We don't want to accept replacements that require low\n-            // feerate junk to be mined first. Ideally we'd keep track of\n-            // the ancestor feerates and make the decision based on that,\n-            // but for now requiring all new inputs to be confirmed works.\n-            //\n-            // Note that if you relax this to make RBF a little more useful,\n-            // this may break the CalculateMempoolAncestors RBF relaxation,\n-            // above. See the comment above the first CalculateMempoolAncestors\n-            // call for more info.\n-            if (!setConflictsParents.count(tx.vin[j].prevout.hash))\n-            {\n-                // Rather than check the UTXO set - potentially expensive -\n-                // it's cheaper to just check if the new input refers to a\n-                // tx that's in the mempool.\n-                if (m_pool.exists(tx.vin[j].prevout.hash)) {\n-                    return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"replacement-adds-unconfirmed\",\n-                            strprintf(\"replacement %s adds unconfirmed input, idx %d\",\n-                                hash.ToString(), j));\n-                }\n-            }\n-        }\n+        if (!PaysMoreThanConflicts(setIterConflicting, newFeeRate, state, hash)) return false;\n \n-        // The replacement must pay greater fees than the transactions it\n-        // replaces - if we did the bandwidth used by those conflicting\n-        // transactions would not be paid for.\n-        if (nModifiedFees < nConflictingFees)\n-        {\n-            return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"insufficient fee\",\n-                    strprintf(\"rejecting replacement %s, less fees than conflicting txs; %s < %s\",\n-                        hash.ToString(), FormatMoney(nModifiedFees), FormatMoney(nConflictingFees)));\n-        }\n+        // Calculate all conflicting entries and enforce Rules 2 and 5.\n+        if (!GetEntriesForRBF(tx, m_pool, setIterConflicting, state, allConflicting)) return false;\n+        if (!HasNoNewUnconfirmed(tx, m_pool, setIterConflicting, state)) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r693097385",
      "id" : 693097385,
      "in_reply_to_id" : 692901343,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MzA5NzM4NQ==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 778,
      "original_position" : 161,
      "original_start_line" : 776,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 735229033,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-08-20T17:08:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/693097385",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r693097509"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/693097509"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Switched to tinyformat",
      "commit_id" : "7d9fc8153cddec24e90f75662b37e4e46baa7469",
      "created_at" : "2021-08-20T17:09:08Z",
      "diff_hunk" : "@@ -2,14 +2,18 @@\n // Distributed under the MIT software license, see the accompanying\n // file COPYING or http://www.opensource.org/licenses/mit-license.php.\n \n+#include <consensus/validation.h>\n+#include <logging.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r693097509",
      "id" : 693097509,
      "in_reply_to_id" : 692903895,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MzA5NzUwOQ==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 6,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/policy/rbf.cpp",
      "position" : null,
      "pull_request_review_id" : 735229169,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-20T17:09:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/693097509",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r693100416"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/693100416"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Marked all of them with their corresponding BIP125 rule numbers :+1: ",
      "commit_id" : "7d9fc8153cddec24e90f75662b37e4e46baa7469",
      "created_at" : "2021-08-20T17:14:19Z",
      "diff_hunk" : "@@ -42,3 +46,133 @@ RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx)\n     // If we don't have a local mempool we can only check the transaction itself.\n     return SignalsOptInRBF(tx) ? RBFTransactionState::REPLACEABLE_BIP125 : RBFTransactionState::UNKNOWN;\n }\n+\n+bool GetEntriesForRBF(const CTransaction& tx, CTxMemPool& pool,\n+                      const CTxMemPool::setEntries& iters_conflicting,\n+                      TxValidationState& state, CTxMemPool::setEntries& all_conflicts)\n+{\n+    AssertLockHeld(pool.cs);\n+    const uint256 hash = tx.GetHash();\n+    uint64_t nConflictingCount = 0;\n+    for (const auto& mi : iters_conflicting) {\n+        nConflictingCount += mi->GetCountWithDescendants();\n+        // This potentially overestimates the number of actual descendants but we just want to be\n+        // conservative to avoid doing too much work.\n+        if (nConflictingCount > MAX_BIP125_REPLACEMENT_CANDIDATES) {\n+            return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"too many potential replacements\",\n+                strprintf(\"rejecting replacement %s; too many potential replacements (%d > %d)\\n\",\n+                          hash.ToString(),\n+                          nConflictingCount,\n+                          MAX_BIP125_REPLACEMENT_CANDIDATES));\n+        }\n+    }\n+    // If not too many to replace, then calculate the set of\n+    // transactions that would have to be evicted\n+    for (CTxMemPool::txiter it : iters_conflicting) {\n+        pool.CalculateDescendants(it, all_conflicts);\n+    }\n+    return true;\n+}\n+\n+bool HasNoNewUnconfirmed(const CTransaction& tx, const CTxMemPool& pool,\n+                         const CTxMemPool::setEntries& iters_conflicting,\n+                         TxValidationState& state)\n+{\n+    AssertLockHeld(pool.cs);\n+    std::set<uint256> parents_of_conflicts;\n+    for (const auto& mi : iters_conflicting) {\n+        for (const CTxIn &txin : mi->GetTx().vin) {\n+            parents_of_conflicts.insert(txin.prevout.hash);\n+        }\n+    }\n+\n+    for (unsigned int j = 0; j < tx.vin.size(); j++)\n+    {\n+        // We don't want to accept replacements that require low feerate junk to be mined first.\n+        // Ideally we'd keep track of the ancestor feerates and make the decision based on that, but\n+        // for now requiring all new inputs to be confirmed works.\n+        //\n+        // Note that if you relax this to make RBF a little more useful, this may break the\n+        // CalculateMempoolAncestors RBF relaxation, above. See the comment above the first\n+        // CalculateMempoolAncestors call for more info.\n+        if (!parents_of_conflicts.count(tx.vin[j].prevout.hash)) {\n+            // Rather than check the UTXO set - potentially expensive - it's cheaper to just check\n+            // if the new input refers to a tx that's in the mempool.\n+            if (pool.exists(tx.vin[j].prevout.hash)) {\n+                return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"replacement-adds-unconfirmed\",\n+                    strprintf(\"replacement %s adds unconfirmed input, idx %d\",\n+                              tx.GetHash().ToString(),\n+                              j));\n+            }\n+        }\n+    }\n+    return true;\n+}\n+\n+bool SpendsAndConflictsDisjoint(const CTxMemPool::setEntries& ancestors,\n+                                const std::set<uint256>& direct_conflicts,\n+                                TxValidationState& state, const uint256& hash)\n+{\n+    for (CTxMemPool::txiter ancestorIt : ancestors) {\n+        const uint256 &hashAncestor = ancestorIt->GetTx().GetHash();\n+        if (direct_conflicts.count(hashAncestor)) {\n+            return state.Invalid(TxValidationResult::TX_CONSENSUS, \"bad-txns-spends-conflicting-tx\",\n+                strprintf(\"%s spends conflicting transaction %s\",\n+                          hash.ToString(),\n+                          hashAncestor.ToString()));\n+        }\n+    }\n+    return true;\n+}\n+\n+bool PaysMoreThanConflicts(const CTxMemPool::setEntries& iters_conflicting, CFeeRate replacement_feerate,\n+                           TxValidationState& state, const uint256& hash)\n+{\n+    for (const auto& mi : iters_conflicting) {\n+        // Don't allow the replacement to reduce the feerate of the mempool.\n+        //\n+        // We usually don't want to accept replacements with lower feerates than what they replaced\n+        // as that would lower the feerate of the next block. Requiring that the feerate always be\n+        // increased is also an easy-to-reason about way to prevent DoS attacks via replacements.\n+        //\n+        // We only consider the feerates of transactions being directly replaced, not their indirect\n+        // descendants. While that does mean high feerate children are ignored when deciding whether\n+        // or not to replace, we do require the replacement to pay more overall fees too, mitigating\n+        // most cases.\n+        CFeeRate original_feerate(mi->GetModifiedFee(), mi->GetTxSize());\n+        if (replacement_feerate <= original_feerate) {\n+            return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"insufficient fee\",\n+                strprintf(\"rejecting replacement %s; new feerate %s <= old feerate %s\",\n+                          hash.ToString(),\n+                          replacement_feerate.ToString(),\n+                          original_feerate.ToString()));\n+        }\n+    }\n+    return true;\n+}\n+\n+bool PaysForRBF(CAmount original_fees, CAmount replacement_fees, size_t replacement_vsize,\n+                TxValidationState& state, const uint256& hash)\n+{\n+    // The replacement must pay greater fees than the transactions it replaces - if we did the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r693100416",
      "id" : 693100416,
      "in_reply_to_id" : 692925516,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MzEwMDQxNg==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 157,
      "original_position" : 144,
      "original_start_line" : null,
      "path" : "src/policy/rbf.cpp",
      "position" : null,
      "pull_request_review_id" : 735232922,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-20T17:14:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/693100416",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r693100683"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/693100683"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "good eyes. added a comment",
      "commit_id" : "7d9fc8153cddec24e90f75662b37e4e46baa7469",
      "created_at" : "2021-08-20T17:14:44Z",
      "diff_hunk" : "@@ -42,3 +46,133 @@ RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx)\n     // If we don't have a local mempool we can only check the transaction itself.\n     return SignalsOptInRBF(tx) ? RBFTransactionState::REPLACEABLE_BIP125 : RBFTransactionState::UNKNOWN;\n }\n+\n+bool GetEntriesForRBF(const CTransaction& tx, CTxMemPool& pool,\n+                      const CTxMemPool::setEntries& iters_conflicting,\n+                      TxValidationState& state, CTxMemPool::setEntries& all_conflicts)\n+{\n+    AssertLockHeld(pool.cs);\n+    const uint256 hash = tx.GetHash();\n+    uint64_t nConflictingCount = 0;\n+    for (const auto& mi : iters_conflicting) {\n+        nConflictingCount += mi->GetCountWithDescendants();\n+        // This potentially overestimates the number of actual descendants but we just want to be\n+        // conservative to avoid doing too much work.\n+        if (nConflictingCount > MAX_BIP125_REPLACEMENT_CANDIDATES) {\n+            return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"too many potential replacements\",\n+                strprintf(\"rejecting replacement %s; too many potential replacements (%d > %d)\\n\",\n+                          hash.ToString(),\n+                          nConflictingCount,\n+                          MAX_BIP125_REPLACEMENT_CANDIDATES));\n+        }\n+    }\n+    // If not too many to replace, then calculate the set of\n+    // transactions that would have to be evicted\n+    for (CTxMemPool::txiter it : iters_conflicting) {\n+        pool.CalculateDescendants(it, all_conflicts);\n+    }\n+    return true;\n+}\n+\n+bool HasNoNewUnconfirmed(const CTransaction& tx, const CTxMemPool& pool,\n+                         const CTxMemPool::setEntries& iters_conflicting,\n+                         TxValidationState& state)\n+{\n+    AssertLockHeld(pool.cs);\n+    std::set<uint256> parents_of_conflicts;\n+    for (const auto& mi : iters_conflicting) {\n+        for (const CTxIn &txin : mi->GetTx().vin) {\n+            parents_of_conflicts.insert(txin.prevout.hash);\n+        }\n+    }\n+\n+    for (unsigned int j = 0; j < tx.vin.size(); j++)\n+    {\n+        // We don't want to accept replacements that require low feerate junk to be mined first.\n+        // Ideally we'd keep track of the ancestor feerates and make the decision based on that, but\n+        // for now requiring all new inputs to be confirmed works.\n+        //\n+        // Note that if you relax this to make RBF a little more useful, this may break the\n+        // CalculateMempoolAncestors RBF relaxation, above. See the comment above the first\n+        // CalculateMempoolAncestors call for more info.\n+        if (!parents_of_conflicts.count(tx.vin[j].prevout.hash)) {\n+            // Rather than check the UTXO set - potentially expensive - it's cheaper to just check\n+            // if the new input refers to a tx that's in the mempool.\n+            if (pool.exists(tx.vin[j].prevout.hash)) {\n+                return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"replacement-adds-unconfirmed\",\n+                    strprintf(\"replacement %s adds unconfirmed input, idx %d\",\n+                              tx.GetHash().ToString(),\n+                              j));\n+            }\n+        }\n+    }\n+    return true;\n+}\n+\n+bool SpendsAndConflictsDisjoint(const CTxMemPool::setEntries& ancestors,\n+                                const std::set<uint256>& direct_conflicts,\n+                                TxValidationState& state, const uint256& hash)\n+{\n+    for (CTxMemPool::txiter ancestorIt : ancestors) {\n+        const uint256 &hashAncestor = ancestorIt->GetTx().GetHash();\n+        if (direct_conflicts.count(hashAncestor)) {\n+            return state.Invalid(TxValidationResult::TX_CONSENSUS, \"bad-txns-spends-conflicting-tx\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r693100683",
      "id" : 693100683,
      "in_reply_to_id" : 692915252,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MzEwMDY4Mw==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 119,
      "original_position" : 106,
      "original_start_line" : null,
      "path" : "src/policy/rbf.cpp",
      "position" : null,
      "pull_request_review_id" : 735233249,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-20T17:14:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/693100683",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r693100874"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/693100874"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done and fixed the commit jumping",
      "commit_id" : "7d9fc8153cddec24e90f75662b37e4e46baa7469",
      "created_at" : "2021-08-20T17:15:01Z",
      "diff_hunk" : "@@ -31,4 +36,51 @@ enum class RBFTransactionState {\n RBFTransactionState IsRBFOptIn(const CTransaction& tx, const CTxMemPool& pool) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx);\n \n+/** Get all descendants of iters_conflicting. Also enforce BIP125 Rule 5 and quit as early as\n+ * possible. There cannot be more than MAX_BIP125_REPLACEMENT_CANDIDATES potential entries.\n+ * @param[in]   iters_conflicting   The set of iterators to mempool entries.\n+ * @param[out]  state               Used to return errors, if any.\n+ * @param[out]  all_conflicts       Populated with all the mempool entries that would be replaced,\n+ *                                  which includes descendants of iters_conflicting. Not cleared at\n+ *                                  the start; any existing mempool entries will remain in the set.\n+ * @returns false if Rule 5 is broken.\n+ */\n+bool GetEntriesForRBF(const CTransaction& tx, CTxMemPool& pool,\n+                      const CTxMemPool::setEntries& iters_conflicting, TxValidationState& state,\n+                      CTxMemPool::setEntries& all_conflicts) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n+\n+/** Enforce BIP125 Rule 2: a replacement transaction must not add any new unconfirmed inputs. */\n+bool HasNoNewUnconfirmed(const CTransaction& tx, const CTxMemPool& pool,\n+                         const CTxMemPool::setEntries& iters_conflicting,\n+                         TxValidationState& state) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n+\n+/** Check the intersection between two sets of mempool entries to make sure they are disjoint.\n+ * @param[in]   ancestors           Set of mempool entries corresponding to ancestors of the\n+ *                                  replacement transactions.\n+ * @param[in]   direct_conflicts    Set of mempool entries corresponding to the mempool conflicts\n+ *                                  (candidates to be replaced).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r693100874",
      "id" : 693100874,
      "in_reply_to_id" : 692912024,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MzEwMDg3NA==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 64,
      "original_position" : 38,
      "original_start_line" : 60,
      "path" : "src/policy/rbf.h",
      "position" : null,
      "pull_request_review_id" : 735233479,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-08-20T17:15:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/693100874",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r693101024"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/693101024"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I named it `GetEntriesForConflicts()`",
      "commit_id" : "7d9fc8153cddec24e90f75662b37e4e46baa7469",
      "created_at" : "2021-08-20T17:15:18Z",
      "diff_hunk" : "@@ -31,4 +36,51 @@ enum class RBFTransactionState {\n RBFTransactionState IsRBFOptIn(const CTransaction& tx, const CTxMemPool& pool) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx);\n \n+/** Get all descendants of iters_conflicting. Also enforce BIP125 Rule 5 and quit as early as\n+ * possible. There cannot be more than MAX_BIP125_REPLACEMENT_CANDIDATES potential entries.\n+ * @param[in]   iters_conflicting   The set of iterators to mempool entries.\n+ * @param[out]  state               Used to return errors, if any.\n+ * @param[out]  all_conflicts       Populated with all the mempool entries that would be replaced,\n+ *                                  which includes descendants of iters_conflicting. Not cleared at\n+ *                                  the start; any existing mempool entries will remain in the set.\n+ * @returns false if Rule 5 is broken.\n+ */\n+bool GetEntriesForRBF(const CTransaction& tx, CTxMemPool& pool,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r693101024",
      "id" : 693101024,
      "in_reply_to_id" : 692908052,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MzEwMTAyNA==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 48,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/policy/rbf.h",
      "position" : null,
      "pull_request_review_id" : 735233694,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-20T17:15:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/693101024",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r693925667"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/693925667"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I didn't end up renaming `hash` to `txid` because I want to be able to pass in either package id or txid in the future :thinking: let me know if it's too weird though, and I can change it",
      "commit_id" : "7d9fc8153cddec24e90f75662b37e4e46baa7469",
      "created_at" : "2021-08-23T12:27:43Z",
      "diff_hunk" : "@@ -31,4 +36,51 @@ enum class RBFTransactionState {\n RBFTransactionState IsRBFOptIn(const CTransaction& tx, const CTxMemPool& pool) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx);\n \n+/** Get all descendants of iters_conflicting. Also enforce BIP125 Rule 5 and quit as early as\n+ * possible. There cannot be more than MAX_BIP125_REPLACEMENT_CANDIDATES potential entries.\n+ * @param[in]   iters_conflicting   The set of iterators to mempool entries.\n+ * @param[out]  state               Used to return errors, if any.\n+ * @param[out]  all_conflicts       Populated with all the mempool entries that would be replaced,\n+ *                                  which includes descendants of iters_conflicting. Not cleared at\n+ *                                  the start; any existing mempool entries will remain in the set.\n+ * @returns false if Rule 5 is broken.\n+ */\n+bool GetEntriesForRBF(const CTransaction& tx, CTxMemPool& pool,\n+                      const CTxMemPool::setEntries& iters_conflicting, TxValidationState& state,\n+                      CTxMemPool::setEntries& all_conflicts) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n+\n+/** Enforce BIP125 Rule 2: a replacement transaction must not add any new unconfirmed inputs. */\n+bool HasNoNewUnconfirmed(const CTransaction& tx, const CTxMemPool& pool,\n+                         const CTxMemPool::setEntries& iters_conflicting,\n+                         TxValidationState& state) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n+\n+/** Check the intersection between two sets of mempool entries to make sure they are disjoint.\n+ * @param[in]   ancestors           Set of mempool entries corresponding to ancestors of the\n+ *                                  replacement transactions.\n+ * @param[in]   direct_conflicts    Set of mempool entries corresponding to the mempool conflicts\n+ *                                  (candidates to be replaced).\n+ * @param[in]   hash                Transaction ID, included in the error message if violation occurs.\n+ * returns true if the two sets are disjoint (i.e. intersection is empty), false if otherwise.\n+ */\n+bool SpendsAndConflictsDisjoint(const CTxMemPool::setEntries& ancestors,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r693925667",
      "id" : 693925667,
      "in_reply_to_id" : 691695502,
      "line" : 68,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MzkyNTY2Nw==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 68,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/policy/rbf.h",
      "position" : 45,
      "pull_request_review_id" : 736058763,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-23T12:27:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/693925667",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r693926118"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/693926118"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Makes sense, quoted BIP125",
      "commit_id" : "7d9fc8153cddec24e90f75662b37e4e46baa7469",
      "created_at" : "2021-08-23T12:28:23Z",
      "diff_hunk" : "@@ -31,4 +36,51 @@ enum class RBFTransactionState {\n RBFTransactionState IsRBFOptIn(const CTransaction& tx, const CTxMemPool& pool) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx);\n \n+/** Get all descendants of iters_conflicting. Also enforce BIP125 Rule 5 and quit as early as\n+ * possible. There cannot be more than MAX_BIP125_REPLACEMENT_CANDIDATES potential entries.\n+ * @param[in]   iters_conflicting   The set of iterators to mempool entries.\n+ * @param[out]  state               Used to return errors, if any.\n+ * @param[out]  all_conflicts       Populated with all the mempool entries that would be replaced,\n+ *                                  which includes descendants of iters_conflicting. Not cleared at\n+ *                                  the start; any existing mempool entries will remain in the set.\n+ * @returns false if Rule 5 is broken.\n+ */\n+bool GetEntriesForRBF(const CTransaction& tx, CTxMemPool& pool,\n+                      const CTxMemPool::setEntries& iters_conflicting, TxValidationState& state,\n+                      CTxMemPool::setEntries& all_conflicts) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n+\n+/** Enforce BIP125 Rule 2: a replacement transaction must not add any new unconfirmed inputs. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r693926118",
      "id" : 693926118,
      "in_reply_to_id" : 691690916,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MzkyNjExOA==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 52,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/policy/rbf.h",
      "position" : null,
      "pull_request_review_id" : 736059365,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-23T12:28:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/693926118",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r694020472"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694020472"
         }
      },
      "author_association" : "MEMBER",
      "body" : "sort plz",
      "commit_id" : "7d9fc8153cddec24e90f75662b37e4e46baa7469",
      "created_at" : "2021-08-23T14:24:38Z",
      "diff_hunk" : "@@ -3,13 +3,17 @@\n // file COPYING or http://www.opensource.org/licenses/mit-license.php.\n \n #include <policy/rbf.h>\n+\n+#include <policy/settings.h>\n+#include <util/moneystr.h>\n #include <util/rbf.h>\n+#include <tinyformat.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r694020472",
      "id" : 694020472,
      "line" : 10,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NDAyMDQ3Mg==",
      "original_commit_id" : "7d9fc8153cddec24e90f75662b37e4e46baa7469",
      "original_line" : 10,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/policy/rbf.cpp",
      "position" : 8,
      "pull_request_review_id" : 736188540,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-23T15:07:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694020472",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r694045328"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694045328"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You lost the `m_reject_reason`:\r\n\r\n```suggestion\r\n            return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"too many replacement transactions\", err_string);\r\n```\r\n\r\n(this is why default arguments are evil, especially when you have multiple default arguments of the same type or of types that can be implicitly cast to each other)",
      "commit_id" : "7d9fc8153cddec24e90f75662b37e4e46baa7469",
      "created_at" : "2021-08-23T14:51:16Z",
      "diff_hunk" : "@@ -784,130 +770,45 @@ bool MemPoolAccept::PreChecks(ATMPArgs& args, Workspace& ws)\n     // that we have the set of all ancestors we can detect this\n     // pathological case by making sure setConflicts and setAncestors don't\n     // intersect.\n-    for (CTxMemPool::txiter ancestorIt : setAncestors)\n-    {\n-        const uint256 &hashAncestor = ancestorIt->GetTx().GetHash();\n-        if (setConflicts.count(hashAncestor))\n-        {\n-            return state.Invalid(TxValidationResult::TX_CONSENSUS, \"bad-txns-spends-conflicting-tx\",\n-                    strprintf(\"%s spends conflicting transaction %s\",\n-                        hash.ToString(),\n-                        hashAncestor.ToString()));\n-        }\n+    if (!SpendsAndConflictsDisjoint(setAncestors, setConflicts, hash, errString)) {\n+        // We classify this as a consensus error because a transaction depending on something it\n+        // conflicts with would be inconsistent.\n+        return state.Invalid(TxValidationResult::TX_CONSENSUS, \"bad-txns-spends-conflicting-tx\", errString);\n     }\n \n-    // Check if it's economically rational to mine this transaction rather\n-    // than the ones it replaces.\n-    nConflictingFees = 0;\n-    nConflictingSize = 0;\n-    uint64_t nConflictingCount = 0;\n \n-    // If we don't hold the lock allConflicting might be incomplete; the\n-    // subsequent RemoveStaged() and addUnchecked() calls don't guarantee\n-    // mempool consistency for us.\n     fReplacementTransaction = setConflicts.size();\n     if (fReplacementTransaction)\n     {\n+        std::string err_string;\n         CFeeRate newFeeRate(nModifiedFees, nSize);\n-        std::set<uint256> setConflictsParents;\n-        const int maxDescendantsToVisit = 100;\n-        for (const auto& mi : setIterConflicting) {\n-            // Don't allow the replacement to reduce the feerate of the\n-            // mempool.\n-            //\n-            // We usually don't want to accept replacements with lower\n-            // feerates than what they replaced as that would lower the\n-            // feerate of the next block. Requiring that the feerate always\n-            // be increased is also an easy-to-reason about way to prevent\n-            // DoS attacks via replacements.\n-            //\n-            // We only consider the feerates of transactions being directly\n-            // replaced, not their indirect descendants. While that does\n-            // mean high feerate children are ignored when deciding whether\n-            // or not to replace, we do require the replacement to pay more\n-            // overall fees too, mitigating most cases.\n-            CFeeRate oldFeeRate(mi->GetModifiedFee(), mi->GetTxSize());\n-            if (newFeeRate <= oldFeeRate)\n-            {\n-                return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"insufficient fee\",\n-                        strprintf(\"rejecting replacement %s; new feerate %s <= old feerate %s\",\n-                            hash.ToString(),\n-                            newFeeRate.ToString(),\n-                            oldFeeRate.ToString()));\n-            }\n-\n-            for (const CTxIn &txin : mi->GetTx().vin)\n-            {\n-                setConflictsParents.insert(txin.prevout.hash);\n-            }\n-\n-            nConflictingCount += mi->GetCountWithDescendants();\n-        }\n-        // This potentially overestimates the number of actual descendants\n-        // but we just want to be conservative to avoid doing too much\n-        // work.\n-        if (nConflictingCount <= maxDescendantsToVisit) {\n-            // If not too many to replace, then calculate the set of\n-            // transactions that would have to be evicted\n-            for (CTxMemPool::txiter it : setIterConflicting) {\n-                m_pool.CalculateDescendants(it, allConflicting);\n-            }\n-            for (CTxMemPool::txiter it : allConflicting) {\n-                nConflictingFees += it->GetModifiedFee();\n-                nConflictingSize += it->GetTxSize();\n-            }\n-        } else {\n-            return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"too many potential replacements\",\n-                    strprintf(\"rejecting replacement %s; too many potential replacements (%d > %d)\\n\",\n-                        hash.ToString(),\n-                        nConflictingCount,\n-                        maxDescendantsToVisit));\n+        // It's possible that the replacement pays more fees than its direct conflicts but not more\n+        // than all conflicts (i.e. the direct conflicts have high-fee descendants). However, if the\n+        // replacement doesn't pay more fees than its direct conflicts, then we can be sure it's not\n+        // more economically rational to mine. Before we go digging through the mempool for all\n+        // transactions that would need to be removed (direct conflicts and all descendants), check\n+        // that the replacement transaction pays more than its direct conflicts.\n+        if (!PaysMoreThanConflicts(setIterConflicting, newFeeRate, hash, err_string)) {\n+            return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"insufficient fee\", err_string);\n         }\n \n-        for (unsigned int j = 0; j < tx.vin.size(); j++)\n-        {\n-            // We don't want to accept replacements that require low\n-            // feerate junk to be mined first. Ideally we'd keep track of\n-            // the ancestor feerates and make the decision based on that,\n-            // but for now requiring all new inputs to be confirmed works.\n-            //\n-            // Note that if you relax this to make RBF a little more useful,\n-            // this may break the CalculateMempoolAncestors RBF relaxation,\n-            // above. See the comment above the first CalculateMempoolAncestors\n-            // call for more info.\n-            if (!setConflictsParents.count(tx.vin[j].prevout.hash))\n-            {\n-                // Rather than check the UTXO set - potentially expensive -\n-                // it's cheaper to just check if the new input refers to a\n-                // tx that's in the mempool.\n-                if (m_pool.exists(tx.vin[j].prevout.hash)) {\n-                    return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"replacement-adds-unconfirmed\",\n-                            strprintf(\"replacement %s adds unconfirmed input, idx %d\",\n-                                hash.ToString(), j));\n-                }\n-            }\n+        // Calculate all conflicting entries and enforce Rule #5.\n+        if (!GetEntriesForConflicts(tx, m_pool, setIterConflicting, allConflicting, err_string)) {\n+            return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, err_string);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r694045328",
      "id" : 694045328,
      "line" : 797,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NDA0NTMyOA==",
      "original_commit_id" : "7d9fc8153cddec24e90f75662b37e4e46baa7469",
      "original_line" : 797,
      "original_position" : 175,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 175,
      "pull_request_review_id" : 736188540,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-23T15:07:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694045328",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r694057353"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694057353"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'd personally prefer fewer surprise tools that help us later, since it's easy enough to update comments/rename parameters when you actually need that functionality. No big deal either way though!",
      "commit_id" : "7d9fc8153cddec24e90f75662b37e4e46baa7469",
      "created_at" : "2021-08-23T15:04:38Z",
      "diff_hunk" : "@@ -31,4 +36,51 @@ enum class RBFTransactionState {\n RBFTransactionState IsRBFOptIn(const CTransaction& tx, const CTxMemPool& pool) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx);\n \n+/** Get all descendants of iters_conflicting. Also enforce BIP125 Rule 5 and quit as early as\n+ * possible. There cannot be more than MAX_BIP125_REPLACEMENT_CANDIDATES potential entries.\n+ * @param[in]   iters_conflicting   The set of iterators to mempool entries.\n+ * @param[out]  state               Used to return errors, if any.\n+ * @param[out]  all_conflicts       Populated with all the mempool entries that would be replaced,\n+ *                                  which includes descendants of iters_conflicting. Not cleared at\n+ *                                  the start; any existing mempool entries will remain in the set.\n+ * @returns false if Rule 5 is broken.\n+ */\n+bool GetEntriesForRBF(const CTransaction& tx, CTxMemPool& pool,\n+                      const CTxMemPool::setEntries& iters_conflicting, TxValidationState& state,\n+                      CTxMemPool::setEntries& all_conflicts) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n+\n+/** Enforce BIP125 Rule 2: a replacement transaction must not add any new unconfirmed inputs. */\n+bool HasNoNewUnconfirmed(const CTransaction& tx, const CTxMemPool& pool,\n+                         const CTxMemPool::setEntries& iters_conflicting,\n+                         TxValidationState& state) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n+\n+/** Check the intersection between two sets of mempool entries to make sure they are disjoint.\n+ * @param[in]   ancestors           Set of mempool entries corresponding to ancestors of the\n+ *                                  replacement transactions.\n+ * @param[in]   direct_conflicts    Set of mempool entries corresponding to the mempool conflicts\n+ *                                  (candidates to be replaced).\n+ * @param[in]   hash                Transaction ID, included in the error message if violation occurs.\n+ * returns true if the two sets are disjoint (i.e. intersection is empty), false if otherwise.\n+ */\n+bool SpendsAndConflictsDisjoint(const CTxMemPool::setEntries& ancestors,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r694057353",
      "id" : 694057353,
      "in_reply_to_id" : 691695502,
      "line" : 68,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NDA1NzM1Mw==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 68,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/policy/rbf.h",
      "position" : 45,
      "pull_request_review_id" : 736188540,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-23T15:07:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694057353",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r694062053"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694062053"
         }
      },
      "author_association" : "MEMBER",
      "body" : "(not addressed)",
      "commit_id" : "7d9fc8153cddec24e90f75662b37e4e46baa7469",
      "created_at" : "2021-08-23T15:10:04Z",
      "diff_hunk" : "@@ -42,3 +46,133 @@ RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx)\n     // If we don't have a local mempool we can only check the transaction itself.\n     return SignalsOptInRBF(tx) ? RBFTransactionState::REPLACEABLE_BIP125 : RBFTransactionState::UNKNOWN;\n }\n+\n+bool GetEntriesForRBF(const CTransaction& tx, CTxMemPool& pool,\n+                      const CTxMemPool::setEntries& iters_conflicting,\n+                      TxValidationState& state, CTxMemPool::setEntries& all_conflicts)\n+{\n+    AssertLockHeld(pool.cs);\n+    const uint256 hash = tx.GetHash();\n+    uint64_t nConflictingCount = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r694062053",
      "id" : 694062053,
      "in_reply_to_id" : 692897400,
      "line" : 58,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NDA2MjA1Mw==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 58,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/policy/rbf.cpp",
      "position" : 44,
      "pull_request_review_id" : 736243422,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-23T15:10:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694062053",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r694063942"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694063942"
         }
      },
      "author_association" : "MEMBER",
      "body" : "(not addressed - this comment still refers to \"two sets of mempool entries\")",
      "commit_id" : "7d9fc8153cddec24e90f75662b37e4e46baa7469",
      "created_at" : "2021-08-23T15:12:22Z",
      "diff_hunk" : "@@ -31,4 +36,51 @@ enum class RBFTransactionState {\n RBFTransactionState IsRBFOptIn(const CTransaction& tx, const CTxMemPool& pool) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx);\n \n+/** Get all descendants of iters_conflicting. Also enforce BIP125 Rule 5 and quit as early as\n+ * possible. There cannot be more than MAX_BIP125_REPLACEMENT_CANDIDATES potential entries.\n+ * @param[in]   iters_conflicting   The set of iterators to mempool entries.\n+ * @param[out]  state               Used to return errors, if any.\n+ * @param[out]  all_conflicts       Populated with all the mempool entries that would be replaced,\n+ *                                  which includes descendants of iters_conflicting. Not cleared at\n+ *                                  the start; any existing mempool entries will remain in the set.\n+ * @returns false if Rule 5 is broken.\n+ */\n+bool GetEntriesForRBF(const CTransaction& tx, CTxMemPool& pool,\n+                      const CTxMemPool::setEntries& iters_conflicting, TxValidationState& state,\n+                      CTxMemPool::setEntries& all_conflicts) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n+\n+/** Enforce BIP125 Rule 2: a replacement transaction must not add any new unconfirmed inputs. */\n+bool HasNoNewUnconfirmed(const CTransaction& tx, const CTxMemPool& pool,\n+                         const CTxMemPool::setEntries& iters_conflicting,\n+                         TxValidationState& state) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n+\n+/** Check the intersection between two sets of mempool entries to make sure they are disjoint.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r694063942",
      "id" : 694063942,
      "in_reply_to_id" : 692912827,
      "line" : 60,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NDA2Mzk0Mg==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 60,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/policy/rbf.h",
      "position" : 37,
      "pull_request_review_id" : 736246036,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-23T15:12:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694063942",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r694947697"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694947697"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "renamed to txid",
      "commit_id" : "a33fdd0b981965982754b39586eedb7ae456ba57",
      "created_at" : "2021-08-24T15:11:32Z",
      "diff_hunk" : "@@ -31,4 +36,51 @@ enum class RBFTransactionState {\n RBFTransactionState IsRBFOptIn(const CTransaction& tx, const CTxMemPool& pool) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx);\n \n+/** Get all descendants of iters_conflicting. Also enforce BIP125 Rule 5 and quit as early as\n+ * possible. There cannot be more than MAX_BIP125_REPLACEMENT_CANDIDATES potential entries.\n+ * @param[in]   iters_conflicting   The set of iterators to mempool entries.\n+ * @param[out]  state               Used to return errors, if any.\n+ * @param[out]  all_conflicts       Populated with all the mempool entries that would be replaced,\n+ *                                  which includes descendants of iters_conflicting. Not cleared at\n+ *                                  the start; any existing mempool entries will remain in the set.\n+ * @returns false if Rule 5 is broken.\n+ */\n+bool GetEntriesForRBF(const CTransaction& tx, CTxMemPool& pool,\n+                      const CTxMemPool::setEntries& iters_conflicting, TxValidationState& state,\n+                      CTxMemPool::setEntries& all_conflicts) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n+\n+/** Enforce BIP125 Rule 2: a replacement transaction must not add any new unconfirmed inputs. */\n+bool HasNoNewUnconfirmed(const CTransaction& tx, const CTxMemPool& pool,\n+                         const CTxMemPool::setEntries& iters_conflicting,\n+                         TxValidationState& state) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n+\n+/** Check the intersection between two sets of mempool entries to make sure they are disjoint.\n+ * @param[in]   ancestors           Set of mempool entries corresponding to ancestors of the\n+ *                                  replacement transactions.\n+ * @param[in]   direct_conflicts    Set of mempool entries corresponding to the mempool conflicts\n+ *                                  (candidates to be replaced).\n+ * @param[in]   hash                Transaction ID, included in the error message if violation occurs.\n+ * returns true if the two sets are disjoint (i.e. intersection is empty), false if otherwise.\n+ */\n+bool SpendsAndConflictsDisjoint(const CTxMemPool::setEntries& ancestors,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r694947697",
      "id" : 694947697,
      "in_reply_to_id" : 691695502,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NDk0NzY5Nw==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 68,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/policy/rbf.h",
      "position" : null,
      "pull_request_review_id" : 737357548,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-24T15:11:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694947697",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r694948488"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694948488"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixt",
      "commit_id" : "a33fdd0b981965982754b39586eedb7ae456ba57",
      "created_at" : "2021-08-24T15:12:22Z",
      "diff_hunk" : "@@ -3,13 +3,17 @@\n // file COPYING or http://www.opensource.org/licenses/mit-license.php.\n \n #include <policy/rbf.h>\n+\n+#include <policy/settings.h>\n+#include <util/moneystr.h>\n #include <util/rbf.h>\n+#include <tinyformat.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r694948488",
      "id" : 694948488,
      "in_reply_to_id" : 694020472,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NDk0ODQ4OA==",
      "original_commit_id" : "7d9fc8153cddec24e90f75662b37e4e46baa7469",
      "original_line" : 10,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/policy/rbf.cpp",
      "position" : null,
      "pull_request_review_id" : 737358547,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-24T15:12:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694948488",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r694948699"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694948699"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : ":pleading_face: Added it back",
      "commit_id" : "a33fdd0b981965982754b39586eedb7ae456ba57",
      "created_at" : "2021-08-24T15:12:38Z",
      "diff_hunk" : "@@ -784,130 +770,45 @@ bool MemPoolAccept::PreChecks(ATMPArgs& args, Workspace& ws)\n     // that we have the set of all ancestors we can detect this\n     // pathological case by making sure setConflicts and setAncestors don't\n     // intersect.\n-    for (CTxMemPool::txiter ancestorIt : setAncestors)\n-    {\n-        const uint256 &hashAncestor = ancestorIt->GetTx().GetHash();\n-        if (setConflicts.count(hashAncestor))\n-        {\n-            return state.Invalid(TxValidationResult::TX_CONSENSUS, \"bad-txns-spends-conflicting-tx\",\n-                    strprintf(\"%s spends conflicting transaction %s\",\n-                        hash.ToString(),\n-                        hashAncestor.ToString()));\n-        }\n+    if (!SpendsAndConflictsDisjoint(setAncestors, setConflicts, hash, errString)) {\n+        // We classify this as a consensus error because a transaction depending on something it\n+        // conflicts with would be inconsistent.\n+        return state.Invalid(TxValidationResult::TX_CONSENSUS, \"bad-txns-spends-conflicting-tx\", errString);\n     }\n \n-    // Check if it's economically rational to mine this transaction rather\n-    // than the ones it replaces.\n-    nConflictingFees = 0;\n-    nConflictingSize = 0;\n-    uint64_t nConflictingCount = 0;\n \n-    // If we don't hold the lock allConflicting might be incomplete; the\n-    // subsequent RemoveStaged() and addUnchecked() calls don't guarantee\n-    // mempool consistency for us.\n     fReplacementTransaction = setConflicts.size();\n     if (fReplacementTransaction)\n     {\n+        std::string err_string;\n         CFeeRate newFeeRate(nModifiedFees, nSize);\n-        std::set<uint256> setConflictsParents;\n-        const int maxDescendantsToVisit = 100;\n-        for (const auto& mi : setIterConflicting) {\n-            // Don't allow the replacement to reduce the feerate of the\n-            // mempool.\n-            //\n-            // We usually don't want to accept replacements with lower\n-            // feerates than what they replaced as that would lower the\n-            // feerate of the next block. Requiring that the feerate always\n-            // be increased is also an easy-to-reason about way to prevent\n-            // DoS attacks via replacements.\n-            //\n-            // We only consider the feerates of transactions being directly\n-            // replaced, not their indirect descendants. While that does\n-            // mean high feerate children are ignored when deciding whether\n-            // or not to replace, we do require the replacement to pay more\n-            // overall fees too, mitigating most cases.\n-            CFeeRate oldFeeRate(mi->GetModifiedFee(), mi->GetTxSize());\n-            if (newFeeRate <= oldFeeRate)\n-            {\n-                return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"insufficient fee\",\n-                        strprintf(\"rejecting replacement %s; new feerate %s <= old feerate %s\",\n-                            hash.ToString(),\n-                            newFeeRate.ToString(),\n-                            oldFeeRate.ToString()));\n-            }\n-\n-            for (const CTxIn &txin : mi->GetTx().vin)\n-            {\n-                setConflictsParents.insert(txin.prevout.hash);\n-            }\n-\n-            nConflictingCount += mi->GetCountWithDescendants();\n-        }\n-        // This potentially overestimates the number of actual descendants\n-        // but we just want to be conservative to avoid doing too much\n-        // work.\n-        if (nConflictingCount <= maxDescendantsToVisit) {\n-            // If not too many to replace, then calculate the set of\n-            // transactions that would have to be evicted\n-            for (CTxMemPool::txiter it : setIterConflicting) {\n-                m_pool.CalculateDescendants(it, allConflicting);\n-            }\n-            for (CTxMemPool::txiter it : allConflicting) {\n-                nConflictingFees += it->GetModifiedFee();\n-                nConflictingSize += it->GetTxSize();\n-            }\n-        } else {\n-            return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"too many potential replacements\",\n-                    strprintf(\"rejecting replacement %s; too many potential replacements (%d > %d)\\n\",\n-                        hash.ToString(),\n-                        nConflictingCount,\n-                        maxDescendantsToVisit));\n+        // It's possible that the replacement pays more fees than its direct conflicts but not more\n+        // than all conflicts (i.e. the direct conflicts have high-fee descendants). However, if the\n+        // replacement doesn't pay more fees than its direct conflicts, then we can be sure it's not\n+        // more economically rational to mine. Before we go digging through the mempool for all\n+        // transactions that would need to be removed (direct conflicts and all descendants), check\n+        // that the replacement transaction pays more than its direct conflicts.\n+        if (!PaysMoreThanConflicts(setIterConflicting, newFeeRate, hash, err_string)) {\n+            return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"insufficient fee\", err_string);\n         }\n \n-        for (unsigned int j = 0; j < tx.vin.size(); j++)\n-        {\n-            // We don't want to accept replacements that require low\n-            // feerate junk to be mined first. Ideally we'd keep track of\n-            // the ancestor feerates and make the decision based on that,\n-            // but for now requiring all new inputs to be confirmed works.\n-            //\n-            // Note that if you relax this to make RBF a little more useful,\n-            // this may break the CalculateMempoolAncestors RBF relaxation,\n-            // above. See the comment above the first CalculateMempoolAncestors\n-            // call for more info.\n-            if (!setConflictsParents.count(tx.vin[j].prevout.hash))\n-            {\n-                // Rather than check the UTXO set - potentially expensive -\n-                // it's cheaper to just check if the new input refers to a\n-                // tx that's in the mempool.\n-                if (m_pool.exists(tx.vin[j].prevout.hash)) {\n-                    return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"replacement-adds-unconfirmed\",\n-                            strprintf(\"replacement %s adds unconfirmed input, idx %d\",\n-                                hash.ToString(), j));\n-                }\n-            }\n+        // Calculate all conflicting entries and enforce Rule #5.\n+        if (!GetEntriesForConflicts(tx, m_pool, setIterConflicting, allConflicting, err_string)) {\n+            return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, err_string);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r694948699",
      "id" : 694948699,
      "in_reply_to_id" : 694045328,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NDk0ODY5OQ==",
      "original_commit_id" : "7d9fc8153cddec24e90f75662b37e4e46baa7469",
      "original_line" : 797,
      "original_position" : 175,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 737358881,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-24T15:12:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694948699",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r694949052"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694949052"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "now calling it \"two sets of transactions (a set of mempool entries and a set of txids)\"",
      "commit_id" : "a33fdd0b981965982754b39586eedb7ae456ba57",
      "created_at" : "2021-08-24T15:13:04Z",
      "diff_hunk" : "@@ -31,4 +36,51 @@ enum class RBFTransactionState {\n RBFTransactionState IsRBFOptIn(const CTransaction& tx, const CTxMemPool& pool) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx);\n \n+/** Get all descendants of iters_conflicting. Also enforce BIP125 Rule 5 and quit as early as\n+ * possible. There cannot be more than MAX_BIP125_REPLACEMENT_CANDIDATES potential entries.\n+ * @param[in]   iters_conflicting   The set of iterators to mempool entries.\n+ * @param[out]  state               Used to return errors, if any.\n+ * @param[out]  all_conflicts       Populated with all the mempool entries that would be replaced,\n+ *                                  which includes descendants of iters_conflicting. Not cleared at\n+ *                                  the start; any existing mempool entries will remain in the set.\n+ * @returns false if Rule 5 is broken.\n+ */\n+bool GetEntriesForRBF(const CTransaction& tx, CTxMemPool& pool,\n+                      const CTxMemPool::setEntries& iters_conflicting, TxValidationState& state,\n+                      CTxMemPool::setEntries& all_conflicts) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n+\n+/** Enforce BIP125 Rule 2: a replacement transaction must not add any new unconfirmed inputs. */\n+bool HasNoNewUnconfirmed(const CTransaction& tx, const CTxMemPool& pool,\n+                         const CTxMemPool::setEntries& iters_conflicting,\n+                         TxValidationState& state) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n+\n+/** Check the intersection between two sets of mempool entries to make sure they are disjoint.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r694949052",
      "id" : 694949052,
      "in_reply_to_id" : 692912827,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NDk0OTA1Mg==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 60,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/policy/rbf.h",
      "position" : null,
      "pull_request_review_id" : 737359382,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-24T15:13:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694949052",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r694949459"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694949459"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "(will fix in a later PR when scripted-diffing the validation.cpp file)",
      "commit_id" : "a33fdd0b981965982754b39586eedb7ae456ba57",
      "created_at" : "2021-08-24T15:13:29Z",
      "diff_hunk" : "@@ -42,3 +46,133 @@ RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx)\n     // If we don't have a local mempool we can only check the transaction itself.\n     return SignalsOptInRBF(tx) ? RBFTransactionState::REPLACEABLE_BIP125 : RBFTransactionState::UNKNOWN;\n }\n+\n+bool GetEntriesForRBF(const CTransaction& tx, CTxMemPool& pool,\n+                      const CTxMemPool::setEntries& iters_conflicting,\n+                      TxValidationState& state, CTxMemPool::setEntries& all_conflicts)\n+{\n+    AssertLockHeld(pool.cs);\n+    const uint256 hash = tx.GetHash();\n+    uint64_t nConflictingCount = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r694949459",
      "id" : 694949459,
      "in_reply_to_id" : 692897400,
      "line" : 58,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NDk0OTQ1OQ==",
      "original_commit_id" : "192193c7c420ebbbac6bb0a60778e6a352b3d67c",
      "original_line" : 58,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/policy/rbf.cpp",
      "position" : 44,
      "pull_request_review_id" : 737359910,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-24T15:13:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694949459",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Addressed @jnewbery comments",
      "created_at" : "2021-08-24T15:14:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#issuecomment-904732562",
      "id" : 904732562,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22675",
      "node_id" : "IC_kwDOABII58417R-S",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-24T15:14:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/904732562",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I tend to agree with @ariard that splitting this PR into different ones would make a lot of sense here:\r\n\r\n> I think the changes proposed by this PR are sizeable enough to be splitted off in different PRs. Especially about the replace-by-fee check rules, beyond the better-feerate-than-directly-replaced transaction present in the code but not in the spec, iirc they're still minor discrepancies worthy to be documented.\r\n> \r\n> One PRs-split-offs could be :\r\n> \r\n> * `IsRBFOptOut()` : the replacement signaling, introducing `src/policy/rbf.h`\r\n> * `SpendsAndConflictsDisjoint` : the replacement candidate sanitization\r\n> * `PaysMoreThanConflicts`/... : the replacement check rules\r\n\r\nMaybe it's my lousy git skills, but I just tried to re-review the changes since my last ACK via `git range-diff` and the results are rather long (> 800 LOC) and confusing (e.g. some commits have been completely removed), to a point that a complete new review is probably quicker. \r\n\r\n",
      "created_at" : "2021-08-25T11:44:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#issuecomment-905425602",
      "id" : 905425602,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22675",
      "node_id" : "IC_kwDOABII584197LC",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-25T11:44:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/905425602",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Code review ACK a33fdd0b981965982754b39586eedb7ae456ba57\r\n\r\nI'm very happy to review any new PRs if you split this up.",
      "created_at" : "2021-08-25T12:19:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#issuecomment-905450118",
      "id" : 905450118,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22675",
      "node_id" : "IC_kwDOABII5841-BKG",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-25T12:19:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/905450118",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I've split off the first few commits into #22796.",
      "created_at" : "2021-08-25T13:31:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#issuecomment-905504286",
      "id" : 905504286,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22675",
      "node_id" : "IC_kwDOABII5841-OYe",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-25T13:31:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/905504286",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased and split off the documentation changes. Ready for review.\r\nPlease note that this is move-only, and I'm happy to add any doc suggestions to #22855.",
      "created_at" : "2021-09-01T09:08:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#issuecomment-910090999",
      "id" : 910090999,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22675",
      "node_id" : "IC_kwDOABII5842PuL3",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-01T09:08:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/910090999",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Changed the functions to return `std::optional<std::string>` instead of `bool` in response to https://github.com/bitcoin/bitcoin/pull/22796#discussion_r700944084",
      "created_at" : "2021-09-02T15:42:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#issuecomment-911820767",
      "id" : 911820767,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22675",
      "node_id" : "IC_kwDOABII5842WUff",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-02T15:42:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/911820767",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "ACK 32748da0f47f7aa9fba78dfb29aa426b14f15624\r\n\r\nI tested this again by running some additional test coverage around BIP125 (this PR #22867) on this branch. All good â",
      "created_at" : "2021-09-03T01:46:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#issuecomment-912188277",
      "id" : 912188277,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22675",
      "node_id" : "IC_kwDOABII5842XuN1",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-03T01:46:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/912188277",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r702737511"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702737511"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ac761f0a23c9c469fa00885edf3d5c9ae7c6a2b3: Would be nice to not use a global here. Testability is one of the motivations in OP, but using globals makes testing actually harder.",
      "commit_id" : "32748da0f47f7aa9fba78dfb29aa426b14f15624",
      "created_at" : "2021-09-06T09:09:37Z",
      "diff_hunk" : "@@ -161,3 +161,29 @@ std::optional<std::string> PaysMoreThanConflicts(const CTxMemPool::setEntries& s\n     return std::nullopt;\n }\n \n+std::optional<std::string> PaysForRBF(CAmount nConflictingFees,\n+                                      CAmount nModifiedFees,\n+                                      size_t nSize,\n+                                      const uint256& hash)\n+{\n+    // The replacement must pay greater fees than the transactions it\n+    // replaces - if we did the bandwidth used by those conflicting\n+    // transactions would not be paid for.\n+    if (nModifiedFees < nConflictingFees)\n+    {\n+        return strprintf(\"rejecting replacement %s, less fees than conflicting txs; %s < %s\",\n+                         hash.ToString(), FormatMoney(nModifiedFees), FormatMoney(nConflictingFees));\n+    }\n+\n+    // Finally in addition to paying more fees than the conflicts the\n+    // new transaction must pay for its own bandwidth.\n+    CAmount nDeltaFees = nModifiedFees - nConflictingFees;\n+    if (nDeltaFees < ::incrementalRelayFee.GetFee(nSize))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r702737511",
      "id" : 702737511,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMjczNzUxMQ==",
      "original_commit_id" : "ac761f0a23c9c469fa00885edf3d5c9ae7c6a2b3",
      "original_line" : 181,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/policy/rbf.cpp",
      "position" : null,
      "pull_request_review_id" : 747002094,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-06T09:15:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702737511",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r702820423"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702820423"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes definitely agree - I can do this in the followup PR.",
      "commit_id" : "32748da0f47f7aa9fba78dfb29aa426b14f15624",
      "created_at" : "2021-09-06T11:15:52Z",
      "diff_hunk" : "@@ -161,3 +161,29 @@ std::optional<std::string> PaysMoreThanConflicts(const CTxMemPool::setEntries& s\n     return std::nullopt;\n }\n \n+std::optional<std::string> PaysForRBF(CAmount nConflictingFees,\n+                                      CAmount nModifiedFees,\n+                                      size_t nSize,\n+                                      const uint256& hash)\n+{\n+    // The replacement must pay greater fees than the transactions it\n+    // replaces - if we did the bandwidth used by those conflicting\n+    // transactions would not be paid for.\n+    if (nModifiedFees < nConflictingFees)\n+    {\n+        return strprintf(\"rejecting replacement %s, less fees than conflicting txs; %s < %s\",\n+                         hash.ToString(), FormatMoney(nModifiedFees), FormatMoney(nConflictingFees));\n+    }\n+\n+    // Finally in addition to paying more fees than the conflicts the\n+    // new transaction must pay for its own bandwidth.\n+    CAmount nDeltaFees = nModifiedFees - nConflictingFees;\n+    if (nDeltaFees < ::incrementalRelayFee.GetFee(nSize))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r702820423",
      "id" : 702820423,
      "in_reply_to_id" : 702737511,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMjgyMDQyMw==",
      "original_commit_id" : "ac761f0a23c9c469fa00885edf3d5c9ae7c6a2b3",
      "original_line" : 181,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/policy/rbf.cpp",
      "position" : null,
      "pull_request_review_id" : 747112548,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-06T11:15:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702820423",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r704195620"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/704195620"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done in https://github.com/bitcoin/bitcoin/pull/22855/commits/7ccaac6c5332b8a93c9b5c7103f846854ee595d5",
      "commit_id" : "32748da0f47f7aa9fba78dfb29aa426b14f15624",
      "created_at" : "2021-09-08T08:57:41Z",
      "diff_hunk" : "@@ -161,3 +161,29 @@ std::optional<std::string> PaysMoreThanConflicts(const CTxMemPool::setEntries& s\n     return std::nullopt;\n }\n \n+std::optional<std::string> PaysForRBF(CAmount nConflictingFees,\n+                                      CAmount nModifiedFees,\n+                                      size_t nSize,\n+                                      const uint256& hash)\n+{\n+    // The replacement must pay greater fees than the transactions it\n+    // replaces - if we did the bandwidth used by those conflicting\n+    // transactions would not be paid for.\n+    if (nModifiedFees < nConflictingFees)\n+    {\n+        return strprintf(\"rejecting replacement %s, less fees than conflicting txs; %s < %s\",\n+                         hash.ToString(), FormatMoney(nModifiedFees), FormatMoney(nConflictingFees));\n+    }\n+\n+    // Finally in addition to paying more fees than the conflicts the\n+    // new transaction must pay for its own bandwidth.\n+    CAmount nDeltaFees = nModifiedFees - nConflictingFees;\n+    if (nDeltaFees < ::incrementalRelayFee.GetFee(nSize))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r704195620",
      "id" : 704195620,
      "in_reply_to_id" : 702737511,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNDE5NTYyMA==",
      "original_commit_id" : "ac761f0a23c9c469fa00885edf3d5c9ae7c6a2b3",
      "original_line" : 181,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/policy/rbf.cpp",
      "position" : null,
      "pull_request_review_id" : 748862561,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-08T08:57:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/704195620",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r706498561"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706498561"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Note, as previously mentioned, I think this is where we do have additional divergences w.r.t to bip125.\r\n\r\nRule 3 says \"The replacement transaction pays an absolute fee of at least the sum paid by the original transactions\".\r\n\r\nI think original transactions as to be interpreted as the set of directly conflicted transactions, i.e sharing inputs with the replacement transaction. At least Rule 5 explicitly dissociates \"original transactions to be replaced and their descendant transactions\".\r\n\r\nHowever our RBF implementation computes the `original_fees` from iterating on `allConflicting` which is built from `CalculateDescendants`. So to-be-replaced descendants fees are also added to the sum paid checked.\r\n\r\nThis means our implementation is more conservative than BIP125, as the replacement threshold is higher. I think this is preferable, at least without deeper thinking.\r\n\r\nAFAIK, this is mental model shared by most developers when they reason about our RBF logic (e.g in pinning discussions). Though it might create surprises if a user submits replacement transactions to Core and other full-node like bcoin, btcd (I don't know their behaviors), they might be refused by Core but accepted in other implems.\r\n\r\nIf I'm correct, good to make this point more known.",
      "commit_id" : "32748da0f47f7aa9fba78dfb29aa426b14f15624",
      "created_at" : "2021-09-10T22:19:22Z",
      "diff_hunk" : "@@ -35,19 +35,61 @@ enum class RBFTransactionState {\n RBFTransactionState IsRBFOptIn(const CTransaction& tx, const CTxMemPool& pool) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx);\n \n-/** Get all descendants of setIterConflicting. Also enforce BIP125 Rule #5, \"The number of original\n+/** Get all descendants of iters_conflicting. Also enforce BIP125 Rule #5, \"The number of original\n  * transactions to be replaced and their descendant transactions which will be evicted from the\n  * mempool must not exceed a total of 100 transactions.\" Quit as early as possible. There cannot be\n  * more than MAX_BIP125_REPLACEMENT_CANDIDATES potential entries.\n- * @param[in]   setIterConflicting  The set of iterators to mempool entries.\n- * @param[out]  err_string          Used to return errors, if any.\n- * @param[out]  allConflicting      Populated with all the mempool entries that would be replaced,\n- *                                  which includes descendants of setIterConflicting. Not cleared at\n+ * @param[in]   iters_conflicting   The set of iterators to mempool entries.\n+ * @param[out]  all_conflicts       Populated with all the mempool entries that would be replaced,\n+ *                                  which includes descendants of iters_conflicting. Not cleared at\n  *                                  the start; any existing mempool entries will remain in the set.\n- * @returns false if Rule 5 is broken.\n+ * @returns an error message if Rule #5 is broken, otherwise a std::nullopt.\n  */\n-bool GetEntriesForConflicts(const CTransaction& tx, CTxMemPool& m_pool,\n-                            const CTxMemPool::setEntries& setIterConflicting,\n-                            CTxMemPool::setEntries& allConflicting,\n-                            std::string& err_string) EXCLUSIVE_LOCKS_REQUIRED(m_pool.cs);\n+std::optional<std::string> GetEntriesForConflicts(const CTransaction& tx, CTxMemPool& pool,\n+                                                  const CTxMemPool::setEntries& iters_conflicting,\n+                                                  CTxMemPool::setEntries& all_conflicts)\n+                                                  EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n+\n+/** BIP125 Rule #2: \"The replacement transaction may only include an unconfirmed input if that input\n+ * was included in one of the original transactions.\"\n+ * @returns error message if Rule #2 is broken, otherwise std::nullopt. */\n+std::optional<std::string> HasNoNewUnconfirmed(const CTransaction& tx, const CTxMemPool& pool,\n+                                               const CTxMemPool::setEntries& iters_conflicting)\n+                                               EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n+\n+/** Check the intersection between two sets of transactions (a set of mempool entries and a set of\n+ * txids) to make sure they are disjoint.\n+ * @param[in]   ancestors           Set of mempool entries corresponding to ancestors of the\n+ *                                  replacement transactions.\n+ * @param[in]   direct_conflicts    Set of txids corresponding to the mempool conflicts\n+ *                                  (candidates to be replaced).\n+ * @param[in]   txid                Transaction ID, included in the error message if violation occurs.\n+ * @returns error message if the sets intersect, std::nullopt if they are disjoint.\n+ */\n+std::optional<std::string> EntriesAndTxidsDisjoint(const CTxMemPool::setEntries& ancestors,\n+                                                   const std::set<uint256>& direct_conflicts,\n+                                                   const uint256& txid);\n+\n+/** Check that the feerate of the replacement transaction(s) is higher than the feerate of each\n+ * of the transactions in iters_conflicting.\n+ * @param[in]   iters_conflicting  The set of mempool entries.\n+ * @returns error message if fees insufficient, otherwise std::nullopt.\n+ */\n+std::optional<std::string> PaysMoreThanConflicts(const CTxMemPool::setEntries& iters_conflicting,\n+                                                 CFeeRate replacement_feerate, const uint256& txid);\n+\n+/** Enforce BIP125 Rule #3 \"The replacement transaction pays an absolute fee of at least the sum\n+ * paid by the original transactions.\" Enforce BIP125 Rule #4 \"The replacement transaction must also\n+ * pay for its own bandwidth at or above the rate set by the node's minimum relay fee setting.\"\n+ * @param[in]   original_fees       Total modified fees of original transaction(s).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r706498561",
      "id" : 706498561,
      "line" : 84,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNjQ5ODU2MQ==",
      "original_commit_id" : "32748da0f47f7aa9fba78dfb29aa426b14f15624",
      "original_line" : 84,
      "original_position" : 60,
      "original_start_line" : null,
      "path" : "src/policy/rbf.h",
      "position" : 60,
      "pull_request_review_id" : 751832799,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-10T22:21:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706498561",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r706498920"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706498920"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In case of code relocation like this one, I think it could ease understanding if a reference to `PreChecks` is added, where the calls to `CalculateMempoolAncestors` happen. ",
      "commit_id" : "32748da0f47f7aa9fba78dfb29aa426b14f15624",
      "created_at" : "2021-09-10T22:20:41Z",
      "diff_hunk" : "@@ -47,33 +47,127 @@ RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx)\n     return SignalsOptInRBF(tx) ? RBFTransactionState::REPLACEABLE_BIP125 : RBFTransactionState::UNKNOWN;\n }\n \n-bool GetEntriesForConflicts(const CTransaction& tx,\n-                            CTxMemPool& m_pool,\n-                            const CTxMemPool::setEntries& setIterConflicting,\n-                            CTxMemPool::setEntries& allConflicting,\n-                            std::string& err_string)\n+std::optional<std::string> GetEntriesForConflicts(const CTransaction& tx,\n+                            CTxMemPool& pool,\n+                            const CTxMemPool::setEntries& iters_conflicting,\n+                            CTxMemPool::setEntries& all_conflicts)\n {\n-    AssertLockHeld(m_pool.cs);\n-    const uint256 hash = tx.GetHash();\n+    AssertLockHeld(pool.cs);\n+    const uint256 txid = tx.GetHash();\n     uint64_t nConflictingCount = 0;\n-    for (const auto& mi : setIterConflicting) {\n+    for (const auto& mi : iters_conflicting) {\n         nConflictingCount += mi->GetCountWithDescendants();\n-        // This potentially overestimates the number of actual descendants\n-        // but we just want to be conservative to avoid doing too much\n-        // work.\n+        // This potentially overestimates the number of actual descendants but we just want to be\n+        // conservative to avoid doing too much work.\n         if (nConflictingCount > MAX_BIP125_REPLACEMENT_CANDIDATES) {\n-            err_string = strprintf(\"rejecting replacement %s; too many potential replacements (%d > %d)\\n\",\n-                        hash.ToString(),\n-                        nConflictingCount,\n-                        MAX_BIP125_REPLACEMENT_CANDIDATES);\n-            return false;\n+            return strprintf(\"rejecting replacement %s; too many potential replacements (%d > %d)\\n\",\n+                             txid.ToString(),\n+                             nConflictingCount,\n+                             MAX_BIP125_REPLACEMENT_CANDIDATES);\n         }\n     }\n     // If not too many to replace, then calculate the set of\n     // transactions that would have to be evicted\n-    for (CTxMemPool::txiter it : setIterConflicting) {\n-        m_pool.CalculateDescendants(it, allConflicting);\n+    for (CTxMemPool::txiter it : iters_conflicting) {\n+        pool.CalculateDescendants(it, all_conflicts);\n     }\n-    return true;\n+    return std::nullopt;\n }\n \n+std::optional<std::string> HasNoNewUnconfirmed(const CTransaction& tx,\n+                                               const CTxMemPool& pool,\n+                                               const CTxMemPool::setEntries& iters_conflicting)\n+{\n+    AssertLockHeld(pool.cs);\n+    std::set<uint256> parents_of_conflicts;\n+    for (const auto& mi : iters_conflicting) {\n+        for (const CTxIn &txin : mi->GetTx().vin) {\n+            parents_of_conflicts.insert(txin.prevout.hash);\n+        }\n+    }\n+\n+    for (unsigned int j = 0; j < tx.vin.size(); j++) {\n+        // We don't want to accept replacements that require low feerate junk to be mined first.\n+        // Ideally we'd keep track of the ancestor feerates and make the decision based on that, but\n+        // for now requiring all new inputs to be confirmed works.\n+        //\n+        // Note that if you relax this to make RBF a little more useful, this may break the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r706498920",
      "id" : 706498920,
      "line" : 94,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNjQ5ODkyMA==",
      "original_commit_id" : "32748da0f47f7aa9fba78dfb29aa426b14f15624",
      "original_line" : 94,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "src/policy/rbf.cpp",
      "position" : 88,
      "pull_request_review_id" : 751832799,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-10T22:21:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706498920",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r708265563"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/708265563"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You are correct with regard to the implementation. However BIP125 says:\r\n> The replacement transaction pays an absolute fee of at least the sum paid by the original transactions\r\n\r\nWhich is plural, so i think the implementation is in line with this rule.\r\nOf course, i agree that it would be a nice place to look for bugs in re-implementations :)",
      "commit_id" : "32748da0f47f7aa9fba78dfb29aa426b14f15624",
      "created_at" : "2021-09-14T13:24:46Z",
      "diff_hunk" : "@@ -35,19 +35,61 @@ enum class RBFTransactionState {\n RBFTransactionState IsRBFOptIn(const CTransaction& tx, const CTxMemPool& pool) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx);\n \n-/** Get all descendants of setIterConflicting. Also enforce BIP125 Rule #5, \"The number of original\n+/** Get all descendants of iters_conflicting. Also enforce BIP125 Rule #5, \"The number of original\n  * transactions to be replaced and their descendant transactions which will be evicted from the\n  * mempool must not exceed a total of 100 transactions.\" Quit as early as possible. There cannot be\n  * more than MAX_BIP125_REPLACEMENT_CANDIDATES potential entries.\n- * @param[in]   setIterConflicting  The set of iterators to mempool entries.\n- * @param[out]  err_string          Used to return errors, if any.\n- * @param[out]  allConflicting      Populated with all the mempool entries that would be replaced,\n- *                                  which includes descendants of setIterConflicting. Not cleared at\n+ * @param[in]   iters_conflicting   The set of iterators to mempool entries.\n+ * @param[out]  all_conflicts       Populated with all the mempool entries that would be replaced,\n+ *                                  which includes descendants of iters_conflicting. Not cleared at\n  *                                  the start; any existing mempool entries will remain in the set.\n- * @returns false if Rule 5 is broken.\n+ * @returns an error message if Rule #5 is broken, otherwise a std::nullopt.\n  */\n-bool GetEntriesForConflicts(const CTransaction& tx, CTxMemPool& m_pool,\n-                            const CTxMemPool::setEntries& setIterConflicting,\n-                            CTxMemPool::setEntries& allConflicting,\n-                            std::string& err_string) EXCLUSIVE_LOCKS_REQUIRED(m_pool.cs);\n+std::optional<std::string> GetEntriesForConflicts(const CTransaction& tx, CTxMemPool& pool,\n+                                                  const CTxMemPool::setEntries& iters_conflicting,\n+                                                  CTxMemPool::setEntries& all_conflicts)\n+                                                  EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n+\n+/** BIP125 Rule #2: \"The replacement transaction may only include an unconfirmed input if that input\n+ * was included in one of the original transactions.\"\n+ * @returns error message if Rule #2 is broken, otherwise std::nullopt. */\n+std::optional<std::string> HasNoNewUnconfirmed(const CTransaction& tx, const CTxMemPool& pool,\n+                                               const CTxMemPool::setEntries& iters_conflicting)\n+                                               EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n+\n+/** Check the intersection between two sets of transactions (a set of mempool entries and a set of\n+ * txids) to make sure they are disjoint.\n+ * @param[in]   ancestors           Set of mempool entries corresponding to ancestors of the\n+ *                                  replacement transactions.\n+ * @param[in]   direct_conflicts    Set of txids corresponding to the mempool conflicts\n+ *                                  (candidates to be replaced).\n+ * @param[in]   txid                Transaction ID, included in the error message if violation occurs.\n+ * @returns error message if the sets intersect, std::nullopt if they are disjoint.\n+ */\n+std::optional<std::string> EntriesAndTxidsDisjoint(const CTxMemPool::setEntries& ancestors,\n+                                                   const std::set<uint256>& direct_conflicts,\n+                                                   const uint256& txid);\n+\n+/** Check that the feerate of the replacement transaction(s) is higher than the feerate of each\n+ * of the transactions in iters_conflicting.\n+ * @param[in]   iters_conflicting  The set of mempool entries.\n+ * @returns error message if fees insufficient, otherwise std::nullopt.\n+ */\n+std::optional<std::string> PaysMoreThanConflicts(const CTxMemPool::setEntries& iters_conflicting,\n+                                                 CFeeRate replacement_feerate, const uint256& txid);\n+\n+/** Enforce BIP125 Rule #3 \"The replacement transaction pays an absolute fee of at least the sum\n+ * paid by the original transactions.\" Enforce BIP125 Rule #4 \"The replacement transaction must also\n+ * pay for its own bandwidth at or above the rate set by the node's minimum relay fee setting.\"\n+ * @param[in]   original_fees       Total modified fees of original transaction(s).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r708265563",
      "id" : 708265563,
      "in_reply_to_id" : 706498561,
      "line" : 84,
      "node_id" : "PRRC_kwDOABII584qN0Zb",
      "original_commit_id" : "32748da0f47f7aa9fba78dfb29aa426b14f15624",
      "original_line" : 84,
      "original_position" : 60,
      "original_start_line" : null,
      "path" : "src/policy/rbf.h",
      "position" : 60,
      "pull_request_review_id" : 753940442,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-14T13:25:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/708265563",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22457751?v=4",
         "events_url" : "https://api.github.com/users/darosior/events{/privacy}",
         "followers_url" : "https://api.github.com/users/darosior/followers",
         "following_url" : "https://api.github.com/users/darosior/following{/other_user}",
         "gists_url" : "https://api.github.com/users/darosior/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/darosior",
         "id" : 22457751,
         "login" : "darosior",
         "node_id" : "MDQ6VXNlcjIyNDU3NzUx",
         "organizations_url" : "https://api.github.com/users/darosior/orgs",
         "received_events_url" : "https://api.github.com/users/darosior/received_events",
         "repos_url" : "https://api.github.com/users/darosior/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/darosior/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/darosior/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/darosior"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r709062666"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/709062666"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "At least wrt fees, it wouldn't make much sense to not consider the descendants of direct conflicts. You can very easily end up replacing higher-fee packages with lower-fee ones. As such, I don't expect that other implementations are interpreting the BIP wording as excluding descendants. Good shout, though, since that would be a pretty juicy bug! :bug:\r\n\r\nwrt wording used in these comments, I have been trying to use \"direct conflicts\" as the mempool transactions that a transaction conflicts with, and \"original transactions\" as all of the mempool transactions that would need to be evicted, i.e. direct conflicts and their descendants. I hope that's clear enough - welcome any feedback on that",
      "commit_id" : "32748da0f47f7aa9fba78dfb29aa426b14f15624",
      "created_at" : "2021-09-15T10:41:37Z",
      "diff_hunk" : "@@ -35,19 +35,61 @@ enum class RBFTransactionState {\n RBFTransactionState IsRBFOptIn(const CTransaction& tx, const CTxMemPool& pool) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx);\n \n-/** Get all descendants of setIterConflicting. Also enforce BIP125 Rule #5, \"The number of original\n+/** Get all descendants of iters_conflicting. Also enforce BIP125 Rule #5, \"The number of original\n  * transactions to be replaced and their descendant transactions which will be evicted from the\n  * mempool must not exceed a total of 100 transactions.\" Quit as early as possible. There cannot be\n  * more than MAX_BIP125_REPLACEMENT_CANDIDATES potential entries.\n- * @param[in]   setIterConflicting  The set of iterators to mempool entries.\n- * @param[out]  err_string          Used to return errors, if any.\n- * @param[out]  allConflicting      Populated with all the mempool entries that would be replaced,\n- *                                  which includes descendants of setIterConflicting. Not cleared at\n+ * @param[in]   iters_conflicting   The set of iterators to mempool entries.\n+ * @param[out]  all_conflicts       Populated with all the mempool entries that would be replaced,\n+ *                                  which includes descendants of iters_conflicting. Not cleared at\n  *                                  the start; any existing mempool entries will remain in the set.\n- * @returns false if Rule 5 is broken.\n+ * @returns an error message if Rule #5 is broken, otherwise a std::nullopt.\n  */\n-bool GetEntriesForConflicts(const CTransaction& tx, CTxMemPool& m_pool,\n-                            const CTxMemPool::setEntries& setIterConflicting,\n-                            CTxMemPool::setEntries& allConflicting,\n-                            std::string& err_string) EXCLUSIVE_LOCKS_REQUIRED(m_pool.cs);\n+std::optional<std::string> GetEntriesForConflicts(const CTransaction& tx, CTxMemPool& pool,\n+                                                  const CTxMemPool::setEntries& iters_conflicting,\n+                                                  CTxMemPool::setEntries& all_conflicts)\n+                                                  EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n+\n+/** BIP125 Rule #2: \"The replacement transaction may only include an unconfirmed input if that input\n+ * was included in one of the original transactions.\"\n+ * @returns error message if Rule #2 is broken, otherwise std::nullopt. */\n+std::optional<std::string> HasNoNewUnconfirmed(const CTransaction& tx, const CTxMemPool& pool,\n+                                               const CTxMemPool::setEntries& iters_conflicting)\n+                                               EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n+\n+/** Check the intersection between two sets of transactions (a set of mempool entries and a set of\n+ * txids) to make sure they are disjoint.\n+ * @param[in]   ancestors           Set of mempool entries corresponding to ancestors of the\n+ *                                  replacement transactions.\n+ * @param[in]   direct_conflicts    Set of txids corresponding to the mempool conflicts\n+ *                                  (candidates to be replaced).\n+ * @param[in]   txid                Transaction ID, included in the error message if violation occurs.\n+ * @returns error message if the sets intersect, std::nullopt if they are disjoint.\n+ */\n+std::optional<std::string> EntriesAndTxidsDisjoint(const CTxMemPool::setEntries& ancestors,\n+                                                   const std::set<uint256>& direct_conflicts,\n+                                                   const uint256& txid);\n+\n+/** Check that the feerate of the replacement transaction(s) is higher than the feerate of each\n+ * of the transactions in iters_conflicting.\n+ * @param[in]   iters_conflicting  The set of mempool entries.\n+ * @returns error message if fees insufficient, otherwise std::nullopt.\n+ */\n+std::optional<std::string> PaysMoreThanConflicts(const CTxMemPool::setEntries& iters_conflicting,\n+                                                 CFeeRate replacement_feerate, const uint256& txid);\n+\n+/** Enforce BIP125 Rule #3 \"The replacement transaction pays an absolute fee of at least the sum\n+ * paid by the original transactions.\" Enforce BIP125 Rule #4 \"The replacement transaction must also\n+ * pay for its own bandwidth at or above the rate set by the node's minimum relay fee setting.\"\n+ * @param[in]   original_fees       Total modified fees of original transaction(s).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r709062666",
      "id" : 709062666,
      "in_reply_to_id" : 706498561,
      "line" : 84,
      "node_id" : "PRRC_kwDOABII584qQ3AK",
      "original_commit_id" : "32748da0f47f7aa9fba78dfb29aa426b14f15624",
      "original_line" : 84,
      "original_position" : 60,
      "original_start_line" : null,
      "path" : "src/policy/rbf.h",
      "position" : 60,
      "pull_request_review_id" : 754953865,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-15T10:41:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/709062666",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r716263536"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/716263536"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Which is plural, so i think the implementation is in line with this rule.\r\n\r\nYes \"original transactions\" is plural though Rule 5 explicitly dissociates \"original transactions to be replaced and their descendant transactions\". Like the directly-replaced transactions _and_ their descendants as two different things :) ?\r\n\r\nI still think this is confusing and our implementation is _not_ in line with this rule. Though I think this is the best behavior for the reason underscored by Gloria.\r\n\r\nI'll let someone else checking other full-node implementations if they have bugs around that!",
      "commit_id" : "32748da0f47f7aa9fba78dfb29aa426b14f15624",
      "created_at" : "2021-09-26T21:20:48Z",
      "diff_hunk" : "@@ -35,19 +35,61 @@ enum class RBFTransactionState {\n RBFTransactionState IsRBFOptIn(const CTransaction& tx, const CTxMemPool& pool) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n RBFTransactionState IsRBFOptInEmptyMempool(const CTransaction& tx);\n \n-/** Get all descendants of setIterConflicting. Also enforce BIP125 Rule #5, \"The number of original\n+/** Get all descendants of iters_conflicting. Also enforce BIP125 Rule #5, \"The number of original\n  * transactions to be replaced and their descendant transactions which will be evicted from the\n  * mempool must not exceed a total of 100 transactions.\" Quit as early as possible. There cannot be\n  * more than MAX_BIP125_REPLACEMENT_CANDIDATES potential entries.\n- * @param[in]   setIterConflicting  The set of iterators to mempool entries.\n- * @param[out]  err_string          Used to return errors, if any.\n- * @param[out]  allConflicting      Populated with all the mempool entries that would be replaced,\n- *                                  which includes descendants of setIterConflicting. Not cleared at\n+ * @param[in]   iters_conflicting   The set of iterators to mempool entries.\n+ * @param[out]  all_conflicts       Populated with all the mempool entries that would be replaced,\n+ *                                  which includes descendants of iters_conflicting. Not cleared at\n  *                                  the start; any existing mempool entries will remain in the set.\n- * @returns false if Rule 5 is broken.\n+ * @returns an error message if Rule #5 is broken, otherwise a std::nullopt.\n  */\n-bool GetEntriesForConflicts(const CTransaction& tx, CTxMemPool& m_pool,\n-                            const CTxMemPool::setEntries& setIterConflicting,\n-                            CTxMemPool::setEntries& allConflicting,\n-                            std::string& err_string) EXCLUSIVE_LOCKS_REQUIRED(m_pool.cs);\n+std::optional<std::string> GetEntriesForConflicts(const CTransaction& tx, CTxMemPool& pool,\n+                                                  const CTxMemPool::setEntries& iters_conflicting,\n+                                                  CTxMemPool::setEntries& all_conflicts)\n+                                                  EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n+\n+/** BIP125 Rule #2: \"The replacement transaction may only include an unconfirmed input if that input\n+ * was included in one of the original transactions.\"\n+ * @returns error message if Rule #2 is broken, otherwise std::nullopt. */\n+std::optional<std::string> HasNoNewUnconfirmed(const CTransaction& tx, const CTxMemPool& pool,\n+                                               const CTxMemPool::setEntries& iters_conflicting)\n+                                               EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n+\n+/** Check the intersection between two sets of transactions (a set of mempool entries and a set of\n+ * txids) to make sure they are disjoint.\n+ * @param[in]   ancestors           Set of mempool entries corresponding to ancestors of the\n+ *                                  replacement transactions.\n+ * @param[in]   direct_conflicts    Set of txids corresponding to the mempool conflicts\n+ *                                  (candidates to be replaced).\n+ * @param[in]   txid                Transaction ID, included in the error message if violation occurs.\n+ * @returns error message if the sets intersect, std::nullopt if they are disjoint.\n+ */\n+std::optional<std::string> EntriesAndTxidsDisjoint(const CTxMemPool::setEntries& ancestors,\n+                                                   const std::set<uint256>& direct_conflicts,\n+                                                   const uint256& txid);\n+\n+/** Check that the feerate of the replacement transaction(s) is higher than the feerate of each\n+ * of the transactions in iters_conflicting.\n+ * @param[in]   iters_conflicting  The set of mempool entries.\n+ * @returns error message if fees insufficient, otherwise std::nullopt.\n+ */\n+std::optional<std::string> PaysMoreThanConflicts(const CTxMemPool::setEntries& iters_conflicting,\n+                                                 CFeeRate replacement_feerate, const uint256& txid);\n+\n+/** Enforce BIP125 Rule #3 \"The replacement transaction pays an absolute fee of at least the sum\n+ * paid by the original transactions.\" Enforce BIP125 Rule #4 \"The replacement transaction must also\n+ * pay for its own bandwidth at or above the rate set by the node's minimum relay fee setting.\"\n+ * @param[in]   original_fees       Total modified fees of original transaction(s).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r716263536",
      "id" : 716263536,
      "in_reply_to_id" : 706498561,
      "line" : 84,
      "node_id" : "PRRC_kwDOABII584qsVBw",
      "original_commit_id" : "32748da0f47f7aa9fba78dfb29aa426b14f15624",
      "original_line" : 84,
      "original_position" : 60,
      "original_start_line" : null,
      "path" : "src/policy/rbf.h",
      "position" : 60,
      "pull_request_review_id" : 763734513,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22675",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-26T21:20:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/716263536",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   }
]
