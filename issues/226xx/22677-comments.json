[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Hmm I'm mildly concept NACK on this refactoring; removeForReorg really feels like internal mempool functionality.\r\n\r\nAnother tactic to remove the module links would be to make removeForReorg generic to any T ChainState class. Then you don't need to have the specifics of the implementation of T known within mempool.\r\n\r\n(Circular deps within `.cpp` are not *that* bad IMO)",
      "created_at" : "2021-08-10T17:48:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-896190244",
      "id" : 896190244,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
      "node_id" : "IC_kwDOABII5841asck",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-10T17:48:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/896190244",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#22282](https://github.com/bitcoin/bitcoin/pull/22282) (refactor: CheckFinalTx pass by reference instead of pointer by klementtan)\n* [#10443](https://github.com/bitcoin/bitcoin/pull/10443) (Add fee_est tool for debugging fee estimation code by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-08-10T18:51:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-896232272",
      "id" : 896232272,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
      "node_id" : "IC_kwDOABII5841a2tQ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/896232272/reactions"
      },
      "updated_at" : "2021-11-02T01:50:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/896232272",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "```bash\r\nvalidation.cpp:338:25: error: calling function 'TestLockPointValidity' requires holding mutex 'cs_main' exclusively [-Werror,-Wthread-safety-analysis]\r\n        bool validLP =  TestLockPointValidity(m_chain, &lp);\r\n                        ^\r\nvalidation.cpp:339:41: error: calling function 'CoinsTip' requires holding mutex 'cs_main' exclusively [-Werror,-Wthread-safety-analysis]\r\n        CCoinsViewMemPool view_mempool(&CoinsTip(), pool);\r\n                                        ^\r\nvalidation.cpp:340:14: error: calling function 'CheckFinalTx' requires holding mutex 'cs_main' exclusively [-Werror,-Wthread-safety-analysis]\r\n        if (!CheckFinalTx(m_chain.Tip(), tx, flags)\r\n             ^\r\nvalidation.cpp:350:36: error: calling function 'CoinsTip' requires holding mutex 'cs_main' exclusively [-Werror,-Wthread-safety-analysis]\r\n                const Coin &coin = CoinsTip().AccessCoin(txin.prevout);\r\n                                   ^\r\nvalidation.cpp:5113:5: error: calling function 'AssertLockHeldInternal<AnnotatedMixin<std::__1::recursive_mutex> >' requires holding mutex 'cs_main' exclusively [-Werror,-Wthread-safety-analysis]\r\n    AssertLockHeld(::cs_main);\r\n    ^\r\n./sync.h:81:28: note: expanded from macro 'AssertLockHeld'\r\n#define AssertLockHeld(cs) AssertLockHeldInternal(#cs, __FILE__, __LINE__, &cs)\r\n                           ^\r\nvalidation.cpp:5117:10: error: calling function 'check' requires holding mutex 'cs_main' exclusively [-Werror,-Wthread-safety-analysis]\r\n    pool.check();\r\n         ^\r\nvalidation.cpp:5119:41: error: calling function 'CoinsTip' requires holding mutex 'cs_main' exclusively [-Werror,-Wthread-safety-analysis]\r\n    CCoinsViewCache& active_coins_tip = CoinsTip();\r\n                                        ^\r\n7 errors generated.\r\n```",
      "created_at" : "2021-08-11T02:44:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-896456577",
      "id" : 896456577,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
      "node_id" : "IC_kwDOABII5841bteB",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-11T02:44:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/896456577",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> removeForReorg really feels like internal mempool functionality. Another tactic to remove the module links would be to make removeForReorg generic to any T ChainState class. Then you don't need to have the specifics of the implementation of T known within mempool.\r\n\r\nYeah, I see this. Perhaps the function could instead be parametrized by tip, coins cache, etc?",
      "created_at" : "2021-08-11T10:06:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-896691512",
      "id" : 896691512,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
      "node_id" : "IC_kwDOABII5841cm04",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-11T10:06:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/896691512",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I've pushed a version that splits out the finality checking part of removeForReorg (parts that require validation functions CheckSequenceLocks and CheckFinalTx) into validation, but leaves most of it in txmempool. Perhaps a better separation?",
      "created_at" : "2021-08-18T20:34:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-901412474",
      "id" : 901412474,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
      "node_id" : "IC_kwDOABII5841unZ6",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-18T20:34:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/901412474",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "i don't think so :/\r\n\r\nedit: it still feels like an abstraction layer leak, the for loop is inner functionality. Have you given parametrizing by CChainState. a try? ",
      "created_at" : "2021-08-18T21:30:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-901443258",
      "id" : 901443258,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
      "node_id" : "IC_kwDOABII5841uu66",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-18T21:31:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/901443258",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@JeremyRubin `CChainState` is what it's currently parametrized by - it's what causes the dependency on validation.h",
      "created_at" : "2021-08-19T08:43:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-901726060",
      "id" : 901726060,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
      "node_id" : "IC_kwDOABII5841vz9s",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-19T08:43:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/901726060",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Ok new approach. I added something similar to the `CConnman.ForEachNode` so we can pass in a lambda that captures what we need from chainstate. Validation isn't looking through `mapTx` anymore. The mempool gets a callable object and applies it to the entries internally.",
      "created_at" : "2021-08-19T14:01:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-901941089",
      "id" : 901941089,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
      "node_id" : "IC_kwDOABII5841wodh",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-19T14:01:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/901941089",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "i meant template paramterized by a generic ChainStateProvider type, that way it's clean depedency wise.. will check out the new approach later.",
      "created_at" : "2021-08-19T21:24:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-902258227",
      "id" : 902258227,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
      "node_id" : "IC_kwDOABII5841x14z",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-19T21:24:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/902258227",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "What's the latest on this PR? Am I right in thinking that an approach hasn't been settled on to avoid the circular dependency and that #22675 should be reviewed instead?\r\n\r\nedit: I guess this is just a RFC and draft PR so it is here in case an alternative approach is sketched out.",
      "created_at" : "2021-09-02T16:05:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-911839931",
      "id" : 911839931,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
      "node_id" : "IC_kwDOABII5842WZK7",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-02T17:17:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/911839931",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/16323900?v=4",
         "events_url" : "https://api.github.com/users/michaelfolkson/events{/privacy}",
         "followers_url" : "https://api.github.com/users/michaelfolkson/followers",
         "following_url" : "https://api.github.com/users/michaelfolkson/following{/other_user}",
         "gists_url" : "https://api.github.com/users/michaelfolkson/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/michaelfolkson",
         "id" : 16323900,
         "login" : "michaelfolkson",
         "node_id" : "MDQ6VXNlcjE2MzIzOTAw",
         "organizations_url" : "https://api.github.com/users/michaelfolkson/orgs",
         "received_events_url" : "https://api.github.com/users/michaelfolkson/received_events",
         "repos_url" : "https://api.github.com/users/michaelfolkson/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/michaelfolkson/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/michaelfolkson/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/michaelfolkson"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed the CI issue. Ready for review.",
      "created_at" : "2021-09-10T13:31:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-916906730",
      "id" : 916906730,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
      "node_id" : "IC_kwDOABII5842puLq",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-10T13:31:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/916906730",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r714068419"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714068419"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I wonder if this function should be made more generic, into `RemoveWithDescendants(const setEntries& txToRemove, MemPoolRemovalReason reason)`, and then be called with `MemPoolRemovalReason::REORG` when removing transactions for a reorg. That'd deduplicate some of the code above in `removeRecursive()`.",
      "commit_id" : "ab3fef71edf2a9e3a36a15c1af6a360cccfa5b30",
      "created_at" : "2021-09-22T15:35:18Z",
      "diff_hunk" : "@@ -563,39 +562,11 @@ void CTxMemPool::removeRecursive(const CTransaction &origTx, MemPoolRemovalReaso\n         RemoveStaged(setAllRemoves, false, reason);\n }\n \n-void CTxMemPool::removeForReorg(CChainState& active_chainstate, int flags)\n+void CTxMemPool::removeForReorg(const setEntries& txToRemove)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r714068419",
      "id" : 714068419,
      "line" : 565,
      "node_id" : "PRRC_kwDOABII584qj9HD",
      "original_commit_id" : "ab3fef71edf2a9e3a36a15c1af6a360cccfa5b30",
      "original_line" : 565,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 13,
      "pull_request_review_id" : 761087292,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-22T16:15:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714068419",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r714077176"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714077176"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`TestLockPointValidity()` can now be static in validation.cpp, since it's not used outside of that translation unit.",
      "commit_id" : "ab3fef71edf2a9e3a36a15c1af6a360cccfa5b30",
      "created_at" : "2021-09-22T15:44:54Z",
      "diff_hunk" : "@@ -366,8 +366,40 @@ void CChainState::MaybeUpdateMempoolForReorg(\n     // the disconnectpool that were added back and cleans up the mempool state.\n     m_mempool->UpdateTransactionsFromBlock(vHashUpdate);\n \n-    // We also need to remove any now-immature transactions\n-    m_mempool->removeForReorg(*this, STANDARD_LOCKTIME_VERIFY_FLAGS);\n+    // Remove transactions spending a coinbase which are now immature and no-longer-final transactions\n+    const auto filter_immature_nonfinal = [this, flags=STANDARD_LOCKTIME_VERIFY_FLAGS]\n+        (CTxMemPool::txiter it) EXCLUSIVE_LOCKS_REQUIRED(cs_main, m_mempool->cs)\n+    {\n+        AssertLockHeld(cs_main);\n+        AssertLockHeld(m_mempool->cs);\n+        const CTransaction& tx = it->GetTx();\n+        LockPoints lp = it->GetLockPoints();\n+        bool validLP =  TestLockPointValidity(m_chain, &lp);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r714077176",
      "id" : 714077176,
      "line" : 377,
      "node_id" : "PRRC_kwDOABII584qj_P4",
      "original_commit_id" : "ab3fef71edf2a9e3a36a15c1af6a360cccfa5b30",
      "original_line" : 377,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 14,
      "pull_request_review_id" : 761087292,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-22T16:15:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714077176",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r714078655"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714078655"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This line has now been replaced by `return true;` in the lambda, which means that the `if (!validLP)` conditional below is not executed if we enter this branch. Is that intentional? If so, can you justify why it's safe to make that change?",
      "commit_id" : "ab3fef71edf2a9e3a36a15c1af6a360cccfa5b30",
      "created_at" : "2021-09-22T15:46:45Z",
      "diff_hunk" : "@@ -563,39 +562,11 @@ void CTxMemPool::removeRecursive(const CTransaction &origTx, MemPoolRemovalReaso\n         RemoveStaged(setAllRemoves, false, reason);\n }\n \n-void CTxMemPool::removeForReorg(CChainState& active_chainstate, int flags)\n+void CTxMemPool::removeForReorg(const setEntries& txToRemove)\n {\n-    // Remove transactions spending a coinbase which are now immature and no-longer-final transactions\n     AssertLockHeld(cs);\n-    setEntries txToRemove;\n-    for (indexed_transaction_set::const_iterator it = mapTx.begin(); it != mapTx.end(); it++) {\n-        const CTransaction& tx = it->GetTx();\n-        LockPoints lp = it->GetLockPoints();\n-        bool validLP =  TestLockPointValidity(active_chainstate.m_chain, &lp);\n-        CCoinsViewMemPool view_mempool(&active_chainstate.CoinsTip(), *this);\n-        if (!CheckFinalTx(active_chainstate.m_chain.Tip(), tx, flags)\n-            || !CheckSequenceLocks(active_chainstate.m_chain.Tip(), view_mempool, tx, flags, &lp, validLP)) {\n-            // Note if CheckSequenceLocks fails the LockPoints may still be invalid\n-            // So it's critical that we remove the tx and not depend on the LockPoints.\n-            txToRemove.insert(it);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r714078655",
      "id" : 714078655,
      "line" : 580,
      "node_id" : "PRRC_kwDOABII584qj_m_",
      "original_commit_id" : "ab3fef71edf2a9e3a36a15c1af6a360cccfa5b30",
      "original_line" : 580,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 27,
      "pull_request_review_id" : 761087292,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-22T16:15:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714078655",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r714080918"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714080918"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This seems like a behaviour change. Since `CTxMemPool::check()` is now called by `CChainState::CheckMempool()`, which itself has `if (GetRand(check_ratio) >= 1) return;`, then these checks will only get run 1/n^2 times.",
      "commit_id" : "ab3fef71edf2a9e3a36a15c1af6a360cccfa5b30",
      "created_at" : "2021-09-22T15:49:13Z",
      "diff_hunk" : "@@ -671,19 +642,9 @@ void CTxMemPool::clear()\n     _clear();\n }\n \n-static void CheckInputsAndUpdateCoins(const CTransaction& tx, CCoinsViewCache& mempoolDuplicate, const int64_t spendheight)\n-{\n-    TxValidationState dummy_state; // Not used. CheckTxInputs() should always pass\n-    CAmount txfee = 0;\n-    bool fCheckResult = tx.IsCoinBase() || Consensus::CheckTxInputs(tx, dummy_state, mempoolDuplicate, spendheight, txfee);\n-    assert(fCheckResult);\n-    UpdateCoins(tx, mempoolDuplicate, std::numeric_limits<int>::max());\n-}\n-\n-void CTxMemPool::check(CChainState& active_chainstate) const\n+void CTxMemPool::check() const\n {\n     if (m_check_ratio == 0) return;\n-\n     if (GetRand(m_check_ratio) >= 1) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r714080918",
      "id" : 714080918,
      "line" : 648,
      "node_id" : "PRRC_kwDOABII584qkAKW",
      "original_commit_id" : "ab3fef71edf2a9e3a36a15c1af6a360cccfa5b30",
      "original_line" : 648,
      "original_position" : 69,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 69,
      "pull_request_review_id" : 761087292,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-22T16:15:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714080918",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r714097289"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714097289"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It'd be nice to remove these calls to mempool.check() from net_processing. It shouldn't be the client's responsibility to call into validation/mempool to check its invariants.\r\n\r\nThe diff is really easy:\r\n\r\n```diff\r\niff --git a/src/net_processing.cpp b/src/net_processing.cpp\r\nindex 80655c61e7..636b4d1102 100644\r\n--- a/src/net_processing.cpp\r\n+++ b/src/net_processing.cpp\r\n@@ -2288,7 +2288,6 @@ void PeerManagerImpl::ProcessOrphanTx(std::set<uint256>& orphan_work_set)\r\n             break;\r\n         }\r\n     }\r\n-    m_mempool.check(m_chainman.ActiveChainstate());\r\n }\r\n \r\n bool PeerManagerImpl::PrepareBlockFilterRequest(CNode& peer,\r\n@@ -3250,7 +3249,6 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\r\n         const TxValidationState& state = result.m_state;\r\n \r\n         if (result.m_result_type == MempoolAcceptResult::ResultType::VALID) {\r\n-            m_mempool.check(m_chainman.ActiveChainstate());\r\n             // As this version of the transaction was acceptable, we can forget about any\r\n             // requests for it.\r\n             m_txrequest.ForgetTxHash(tx.GetHash());\r\ndiff --git a/src/validation.cpp b/src/validation.cpp\r\nindex 2a66d96f22..8f1f33782b 100644\r\n--- a/src/validation.cpp\r\n+++ b/src/validation.cpp\r\n@@ -1041,7 +1041,9 @@ static MempoolAcceptResult AcceptToMemoryPoolWithTime(const CChainParams& chainp\r\n MempoolAcceptResult AcceptToMemoryPool(CChainState& active_chainstate, CTxMemPool& pool, const CTransactionRef& tx,\r\n                                        bool bypass_limits, bool test_accept)\r\n {\r\n-    return AcceptToMemoryPoolWithTime(Params(), pool, active_chainstate, tx, GetTime(), bypass_limits, test_accept);\r\n+    auto ret = AcceptToMemoryPoolWithTime(Params(), pool, active_chainstate, tx, GetTime(), bypass_limits, test_accept);\r\n+    pool.check(active_chainstate);\r\n+    return ret;\r\n }\r\n \r\n PackageMempoolAcceptResult ProcessNewPackage(CChainState& active_chainstate, CTxMemPool& pool,\r\n```\r\nbranch here: https://github.com/jnewbery/bitcoin/tree/2021-09-no-mempool-check-in-net-processing\r\n\r\nThat's a _slight_ behaviour change since check() will get called a little more often, so it doesn't fit inside this PR, but by doing it first, this PR wouldn't need to touch net_processing. Thoughts?",
      "commit_id" : "ab3fef71edf2a9e3a36a15c1af6a360cccfa5b30",
      "created_at" : "2021-09-22T16:07:27Z",
      "diff_hunk" : "@@ -2288,7 +2288,7 @@ void PeerManagerImpl::ProcessOrphanTx(std::set<uint256>& orphan_work_set)\n             break;\n         }\n     }\n-    m_mempool.check(m_chainman.ActiveChainstate());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r714097289",
      "id" : 714097289,
      "line" : 2291,
      "node_id" : "PRRC_kwDOABII584qkEKJ",
      "original_commit_id" : "ab3fef71edf2a9e3a36a15c1af6a360cccfa5b30",
      "original_line" : 2291,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 4,
      "pull_request_review_id" : 761087292,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-22T16:15:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714097289",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r718853068"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718853068"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Good catch, switched it to be updating a `bool should_remove` and returning at the end instead :)",
      "commit_id" : "392ac4783e3e442478e08b727e47a864678b4d4f",
      "created_at" : "2021-09-29T20:17:42Z",
      "diff_hunk" : "@@ -563,39 +562,11 @@ void CTxMemPool::removeRecursive(const CTransaction &origTx, MemPoolRemovalReaso\n         RemoveStaged(setAllRemoves, false, reason);\n }\n \n-void CTxMemPool::removeForReorg(CChainState& active_chainstate, int flags)\n+void CTxMemPool::removeForReorg(const setEntries& txToRemove)\n {\n-    // Remove transactions spending a coinbase which are now immature and no-longer-final transactions\n     AssertLockHeld(cs);\n-    setEntries txToRemove;\n-    for (indexed_transaction_set::const_iterator it = mapTx.begin(); it != mapTx.end(); it++) {\n-        const CTransaction& tx = it->GetTx();\n-        LockPoints lp = it->GetLockPoints();\n-        bool validLP =  TestLockPointValidity(active_chainstate.m_chain, &lp);\n-        CCoinsViewMemPool view_mempool(&active_chainstate.CoinsTip(), *this);\n-        if (!CheckFinalTx(active_chainstate.m_chain.Tip(), tx, flags)\n-            || !CheckSequenceLocks(active_chainstate.m_chain.Tip(), view_mempool, tx, flags, &lp, validLP)) {\n-            // Note if CheckSequenceLocks fails the LockPoints may still be invalid\n-            // So it's critical that we remove the tx and not depend on the LockPoints.\n-            txToRemove.insert(it);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r718853068",
      "id" : 718853068,
      "in_reply_to_id" : 714078655,
      "line" : 580,
      "node_id" : "PRRC_kwDOABII584q2NPM",
      "original_commit_id" : "ab3fef71edf2a9e3a36a15c1af6a360cccfa5b30",
      "original_line" : 580,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 37,
      "pull_request_review_id" : 767146915,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-29T20:17:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718853068",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r718853463"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718853463"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "keeping `check_ratio` checking inside the mempool function now",
      "commit_id" : "392ac4783e3e442478e08b727e47a864678b4d4f",
      "created_at" : "2021-09-29T20:18:16Z",
      "diff_hunk" : "@@ -671,19 +642,9 @@ void CTxMemPool::clear()\n     _clear();\n }\n \n-static void CheckInputsAndUpdateCoins(const CTransaction& tx, CCoinsViewCache& mempoolDuplicate, const int64_t spendheight)\n-{\n-    TxValidationState dummy_state; // Not used. CheckTxInputs() should always pass\n-    CAmount txfee = 0;\n-    bool fCheckResult = tx.IsCoinBase() || Consensus::CheckTxInputs(tx, dummy_state, mempoolDuplicate, spendheight, txfee);\n-    assert(fCheckResult);\n-    UpdateCoins(tx, mempoolDuplicate, std::numeric_limits<int>::max());\n-}\n-\n-void CTxMemPool::check(CChainState& active_chainstate) const\n+void CTxMemPool::check() const\n {\n     if (m_check_ratio == 0) return;\n-\n     if (GetRand(m_check_ratio) >= 1) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r718853463",
      "id" : 718853463,
      "in_reply_to_id" : 714080918,
      "line" : 655,
      "node_id" : "PRRC_kwDOABII584q2NVX",
      "original_commit_id" : "ab3fef71edf2a9e3a36a15c1af6a360cccfa5b30",
      "original_line" : 655,
      "original_position" : 69,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 77,
      "pull_request_review_id" : 767147448,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-29T20:18:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718853463",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r718855206"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718855206"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Didn't end up taking this change, though I tried to at first, because I agree that it _should_ be the mempool, or at the very least, chainstate manager's job to sanity check the mempool, not net processing.\r\n\r\nThe problem is that we call ATMP from the reorg code, and we shouldn't call `check()` then because the mempool can temporarily be in a state where not all inputs are available from the chainstate coins cache. This causes the `check()` assertions to fail.",
      "commit_id" : "392ac4783e3e442478e08b727e47a864678b4d4f",
      "created_at" : "2021-09-29T20:20:49Z",
      "diff_hunk" : "@@ -2288,7 +2288,7 @@ void PeerManagerImpl::ProcessOrphanTx(std::set<uint256>& orphan_work_set)\n             break;\n         }\n     }\n-    m_mempool.check(m_chainman.ActiveChainstate());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r718855206",
      "id" : 718855206,
      "in_reply_to_id" : 714097289,
      "line" : 2291,
      "node_id" : "PRRC_kwDOABII584q2Nwm",
      "original_commit_id" : "ab3fef71edf2a9e3a36a15c1af6a360cccfa5b30",
      "original_line" : 2291,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 4,
      "pull_request_review_id" : 767149786,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-29T20:20:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718855206",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r718855938"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718855938"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Agree about consolidating duplicate code, but I don't think it helps much with this PR - maybe for a followup?",
      "commit_id" : "392ac4783e3e442478e08b727e47a864678b4d4f",
      "created_at" : "2021-09-29T20:21:59Z",
      "diff_hunk" : "@@ -563,39 +562,11 @@ void CTxMemPool::removeRecursive(const CTransaction &origTx, MemPoolRemovalReaso\n         RemoveStaged(setAllRemoves, false, reason);\n }\n \n-void CTxMemPool::removeForReorg(CChainState& active_chainstate, int flags)\n+void CTxMemPool::removeForReorg(const setEntries& txToRemove)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r718855938",
      "id" : 718855938,
      "in_reply_to_id" : 714068419,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584q2N8C",
      "original_commit_id" : "ab3fef71edf2a9e3a36a15c1af6a360cccfa5b30",
      "original_line" : 565,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 767150766,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-29T20:22:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718855938",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I've changed the circular dependency-breaking to be as minimal as possible. The `check()` function is now parametrized by a coins cache and spend height rather than chainstate. The `removeForReorg()` function now takes a callable object to apply to each mempool entry, removing the ones for which it returns true.\r\n\r\nI've also written a bench for these 2 functions and taken the opportunity to speed `check()` up by eliminating the need to check mempool entries more than once. My bench results show a 35% speedup. Hopefully the performance improvement + circular dependency break is good enough to motivate these changes.\r\n\r\nBench at commit when the benchmark is first introduced:\r\n![image](https://user-images.githubusercontent.com/25183001/135457316-3829cabf-10fe-4b18-bf37-f411e24b3011.png)\r\n\r\n\r\nBench at HEAD of this PR:\r\n![image](https://user-images.githubusercontent.com/25183001/135457337-da5bd713-401e-4ef2-a2db-2de37120a910.png)\r\n",
      "created_at" : "2021-09-30T12:49:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-931290980",
      "id" : 931290980,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
      "node_id" : "IC_kwDOABII5843gl9k",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/931290980/reactions"
      },
      "updated_at" : "2021-09-30T12:49:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/931290980",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r719508493"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719508493"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`TestLockPointValidity()` can now be static since it's not called from outside this translation unit.",
      "commit_id" : "48a5b1b3eb57c100cc49b58d8f38f2ca7786d837",
      "created_at" : "2021-09-30T15:13:00Z",
      "diff_hunk" : "@@ -367,8 +367,42 @@ void CChainState::MaybeUpdateMempoolForReorg(\n     // the disconnectpool that were added back and cleans up the mempool state.\n     m_mempool->UpdateTransactionsFromBlock(vHashUpdate);\n \n+    const auto check_validity_and_lp = [this, flags=STANDARD_LOCKTIME_VERIFY_FLAGS](CTxMemPool::txiter it)\n+        EXCLUSIVE_LOCKS_REQUIRED(m_mempool->cs, ::cs_main) {\n+        bool should_remove = false;\n+        AssertLockHeld(m_mempool->cs);\n+        AssertLockHeld(::cs_main);\n+        const CTransaction& tx = it->GetTx();\n+        LockPoints lp = it->GetLockPoints();\n+        bool validLP = TestLockPointValidity(m_chain, &lp);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r719508493",
      "id" : 719508493,
      "line" : 377,
      "node_id" : "PRRC_kwDOABII584q4tQN",
      "original_commit_id" : "48a5b1b3eb57c100cc49b58d8f38f2ca7786d837",
      "original_line" : 377,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 11,
      "pull_request_review_id" : 768002466,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719508493/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-30T15:13:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719508493",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r719513233"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719513233"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> The problem is that we call ATMP from the reorg code, and we shouldn't call check() then because the mempool can temporarily be in a state where not all inputs are available from the chainstate coins cache. This causes the check() assertions to fail.\r\n\r\nYes, I'd forgotten that ATMP could be called while the mempool is in an inconsistent state.\r\n\r\nThe fix is to only call `check()` after ATMP has been called from outside validation. I have a branch that implements a `ChainstateManager.ProcessTransaction()` interface method which does exactly that: https://github.com/jnewbery/bitcoin/tree/2021-09-process-transaction. I'll probably go ahead and PR that soon unless you think it should wait until after this PR.",
      "commit_id" : "48a5b1b3eb57c100cc49b58d8f38f2ca7786d837",
      "created_at" : "2021-09-30T15:18:10Z",
      "diff_hunk" : "@@ -2288,7 +2288,7 @@ void PeerManagerImpl::ProcessOrphanTx(std::set<uint256>& orphan_work_set)\n             break;\n         }\n     }\n-    m_mempool.check(m_chainman.ActiveChainstate());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r719513233",
      "id" : 719513233,
      "in_reply_to_id" : 714097289,
      "line" : 2291,
      "node_id" : "PRRC_kwDOABII584q4uaR",
      "original_commit_id" : "ab3fef71edf2a9e3a36a15c1af6a360cccfa5b30",
      "original_line" : 2291,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 4,
      "pull_request_review_id" : 768008993,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719513233/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-30T15:18:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719513233",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased, addressed @jnewbery's comment, and separated the benches because it's a bit misleading to group them.",
      "created_at" : "2021-10-01T11:44:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-932156870",
      "id" : 932156870,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
      "node_id" : "IC_kwDOABII5843j5XG",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/932156870/reactions"
      },
      "updated_at" : "2021-10-01T11:44:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/932156870",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r720207046"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/720207046"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "3ee359e326f62f5ada6819765ebff3451c53259e",
      "created_at" : "2021-10-01T12:32:40Z",
      "diff_hunk" : "@@ -367,8 +367,42 @@ void CChainState::MaybeUpdateMempoolForReorg(\n     // the disconnectpool that were added back and cleans up the mempool state.\n     m_mempool->UpdateTransactionsFromBlock(vHashUpdate);\n \n+    const auto check_validity_and_lp = [this, flags=STANDARD_LOCKTIME_VERIFY_FLAGS](CTxMemPool::txiter it)\n+        EXCLUSIVE_LOCKS_REQUIRED(m_mempool->cs, ::cs_main) {\n+        bool should_remove = false;\n+        AssertLockHeld(m_mempool->cs);\n+        AssertLockHeld(::cs_main);\n+        const CTransaction& tx = it->GetTx();\n+        LockPoints lp = it->GetLockPoints();\n+        bool validLP = TestLockPointValidity(m_chain, &lp);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r720207046",
      "id" : 720207046,
      "in_reply_to_id" : 719508493,
      "line" : 381,
      "node_id" : "PRRC_kwDOABII584q7XzG",
      "original_commit_id" : "48a5b1b3eb57c100cc49b58d8f38f2ca7786d837",
      "original_line" : 381,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 24,
      "pull_request_review_id" : 768904131,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/720207046/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-01T12:32:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/720207046",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Split the PR up - first half is in #23157.",
      "created_at" : "2021-10-01T16:09:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-932362098",
      "id" : 932362098,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
      "node_id" : "IC_kwDOABII5843krdy",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/932362098/reactions"
      },
      "updated_at" : "2021-10-01T16:09:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/932362098",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased",
      "created_at" : "2021-10-25T13:44:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-950944753",
      "id" : 950944753,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
      "node_id" : "IC_kwDOABII5844rkPx",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/950944753/reactions"
      },
      "updated_at" : "2021-10-25T13:44:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/950944753",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Needs rebase?",
      "created_at" : "2021-11-12T16:08:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-967232495",
      "id" : 967232495,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
      "node_id" : "IC_kwDOABII5845psvv",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/967232495/reactions"
      },
      "updated_at" : "2021-11-12T16:08:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/967232495",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks @MarcoFalke! silent merge conflict with #23211. Need to rethink approach since it's no longer possible to modify lockpoints from outside txmempool...",
      "created_at" : "2021-11-15T16:23:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-969079001",
      "id" : 969079001,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
      "node_id" : "IC_kwDOABII5845wvjZ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/969079001/reactions"
      },
      "updated_at" : "2021-11-15T16:23:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/969079001",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "That was a move-only, so can be reverted if needed. Maybe a `struct update_lock_points;` forward decl is enough?",
      "created_at" : "2021-11-15T16:33:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-969088560",
      "id" : 969088560,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
      "node_id" : "IC_kwDOABII5845wx4w",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/969088560/reactions"
      },
      "updated_at" : "2021-11-15T16:33:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/969088560",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> That was a move-only, so can be reverted if needed. Maybe a `struct update_lock_points;` forward decl is enough?\r\n\r\nForward decl isn't enough because we need the constructor in order to call `update_lock_points(lp)`.\r\n\r\nCurrently, I'm leaning towards splitting `removeForReorg` into 2 loops: `CheckLockPoints` (leave inside txmempool) and `RemoveNonFinalAndPremature` (move to validation). There shouldn't be a performance penalty.\r\n\r\nReverting is also an option. I'm currently trying to figure out whether that's better. AFAICT, the `update_*` structs help provide an interface to modifying mempool entries while keeping the `txiter` type const (txmempool passes `txiters` and `setEntries`s to outside callers pretty freely). But since all modifications to entries should be done through txmempool's public member functions, perhaps it's better for them to be private. Will investigate further.",
      "created_at" : "2021-11-15T16:47:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-969102524",
      "id" : 969102524,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
      "node_id" : "IC_kwDOABII5845w1S8",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/969102524/reactions"
      },
      "updated_at" : "2021-11-15T16:47:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/969102524",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased. If you have time, please take another look @mjdietzx @theStack @MarcoFalke?",
      "created_at" : "2021-11-30T12:30:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-982592235",
      "id" : 982592235,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
      "node_id" : "IC_kwDOABII5846kSrr",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/982592235/reactions"
      },
      "updated_at" : "2021-11-30T12:30:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/982592235",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Code review ACK a64078e38563ef3ac5e5ec20c07569441c87eeee",
      "created_at" : "2021-11-30T17:52:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-982876145",
      "id" : 982876145,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
      "node_id" : "IC_kwDOABII5846lX_x",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/982876145/reactions"
      },
      "updated_at" : "2021-11-30T17:52:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/982876145",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r760049185"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760049185"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: could use the forward-declaration `class CChain;` instead to reduce header dependencies",
      "commit_id" : "a64078e38563ef3ac5e5ec20c07569441c87eeee",
      "created_at" : "2021-12-01T10:27:25Z",
      "diff_hunk" : "@@ -14,6 +14,7 @@\n #include <utility>\n #include <vector>\n \n+#include <chain.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r760049185",
      "id" : 760049185,
      "line" : 17,
      "node_id" : "PRRC_kwDOABII584tTW4h",
      "original_commit_id" : "1b3a11e126b258fba975ed7c452221608f2c5472",
      "original_line" : 17,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : 4,
      "pull_request_review_id" : 820071220,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760049185/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-01T10:37:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760049185",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "reACK a64078e38563ef3ac5e5ec20c07569441c87eeee",
      "created_at" : "2021-12-01T14:53:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-983719401",
      "id" : 983719401,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
      "node_id" : "IC_kwDOABII5846ol3p",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/983719401/reactions"
      },
      "updated_at" : "2021-12-01T14:53:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/983719401",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r760400537"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760400537"
         }
      },
      "author_association" : "MEMBER",
      "body" : "bedf246f1e2497a3641093c6e8fa11fb34dddac4:\r\n\r\nIs this creating a copy of a vector holding 1kk elements for no reason?",
      "commit_id" : "a64078e38563ef3ac5e5ec20c07569441c87eeee",
      "created_at" : "2021-12-01T17:19:27Z",
      "diff_hunk" : "@@ -663,15 +663,19 @@ void CTxMemPool::removeForReorg(CChainState& active_chainstate, int flags)\n                 }\n             }\n         }\n-        if (!validLP) {\n-            mapTx.modify(it, update_lock_points(lp));\n-        }\n     }\n     setEntries setAllRemoves;\n     for (txiter it : txToRemove) {\n         CalculateDescendants(it, setAllRemoves);\n     }\n     RemoveStaged(setAllRemoves, false, MemPoolRemovalReason::REORG);\n+    auto chain = active_chainstate.m_chain;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r760400537",
      "id" : 760400537,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584tUsqZ",
      "original_commit_id" : "bedf246f1e2497a3641093c6e8fa11fb34dddac4",
      "original_line" : 672,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 820587394,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760400537/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-01T17:42:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760400537",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r760401836"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760401836"
         }
      },
      "author_association" : "MEMBER",
      "body" : "unrelated: Seems a bit confusing to pass a pointer here. Usually this means the memory it points to will be modified. However, in this case `lp` can be const.",
      "commit_id" : "a64078e38563ef3ac5e5ec20c07569441c87eeee",
      "created_at" : "2021-12-01T17:20:27Z",
      "diff_hunk" : "@@ -663,15 +663,19 @@ void CTxMemPool::removeForReorg(CChainState& active_chainstate, int flags)\n                 }\n             }\n         }\n-        if (!validLP) {\n-            mapTx.modify(it, update_lock_points(lp));\n-        }\n     }\n     setEntries setAllRemoves;\n     for (txiter it : txToRemove) {\n         CalculateDescendants(it, setAllRemoves);\n     }\n     RemoveStaged(setAllRemoves, false, MemPoolRemovalReason::REORG);\n+    auto chain = active_chainstate.m_chain;\n+    for (indexed_transaction_set::const_iterator it = mapTx.begin(); it != mapTx.end(); it++) {\n+        LockPoints lp = it->GetLockPoints();\n+        if (!TestLockPointValidity(chain, &lp)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r760401836",
      "id" : 760401836,
      "line" : 653,
      "node_id" : "PRRC_kwDOABII584tUs-s",
      "original_commit_id" : "bedf246f1e2497a3641093c6e8fa11fb34dddac4",
      "original_line" : 675,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 81,
      "pull_request_review_id" : 820587394,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760401836/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-01T17:42:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760401836",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r760402607"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760402607"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: Could use `{}` instead of `=` to enable more compile time checks.",
      "commit_id" : "a64078e38563ef3ac5e5ec20c07569441c87eeee",
      "created_at" : "2021-12-01T17:21:03Z",
      "diff_hunk" : "@@ -642,7 +642,7 @@ void CTxMemPool::removeForReorg(CChainState& active_chainstate, int flags)\n     for (indexed_transaction_set::const_iterator it = mapTx.begin(); it != mapTx.end(); it++) {\n         const CTransaction& tx = it->GetTx();\n         LockPoints lp = it->GetLockPoints();\n-        bool validLP =  TestLockPointValidity(active_chainstate.m_chain, &lp);\n+        const bool validLP = TestLockPointValidity(active_chainstate.m_chain, &lp);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r760402607",
      "id" : 760402607,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584tUtKv",
      "original_commit_id" : "bedf246f1e2497a3641093c6e8fa11fb34dddac4",
      "original_line" : 645,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 820587394,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760402607/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-01T17:42:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760402607",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r760425954"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760425954"
         }
      },
      "author_association" : "MEMBER",
      "body" : "why add a `const` first and then remove it again?",
      "commit_id" : "a64078e38563ef3ac5e5ec20c07569441c87eeee",
      "created_at" : "2021-12-01T17:39:09Z",
      "diff_hunk" : "@@ -350,8 +350,39 @@ void CChainState::MaybeUpdateMempoolForReorg(\n     // the disconnectpool that were added back and cleans up the mempool state.\n     m_mempool->UpdateTransactionsFromBlock(vHashUpdate);\n \n+    const auto check_final_and_mature = [this, flags=STANDARD_LOCKTIME_VERIFY_FLAGS](CTxMemPool::txiter it)\n+        EXCLUSIVE_LOCKS_REQUIRED(m_mempool->cs, ::cs_main) {\n+        bool should_remove = false;\n+        AssertLockHeld(m_mempool->cs);\n+        AssertLockHeld(::cs_main);\n+        const CTransaction& tx = it->GetTx();\n+        LockPoints lp = it->GetLockPoints();\n+        bool validLP = TestLockPointValidity(m_chain, &lp);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r760425954",
      "id" : 760425954,
      "line" : 360,
      "node_id" : "PRRC_kwDOABII584tUy3i",
      "original_commit_id" : "a64078e38563ef3ac5e5ec20c07569441c87eeee",
      "original_line" : 360,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 36,
      "pull_request_review_id" : 820587394,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760425954/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-01T17:42:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760425954",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r760430487"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760430487"
         }
      },
      "author_association" : "MEMBER",
      "body" : "unrelated, but it seems a bit odd to have an integer and cast it three times for no reason. `int`->`unsigned`->`signed long`",
      "commit_id" : "a64078e38563ef3ac5e5ec20c07569441c87eeee",
      "created_at" : "2021-12-01T17:42:36Z",
      "diff_hunk" : "@@ -350,8 +350,39 @@ void CChainState::MaybeUpdateMempoolForReorg(\n     // the disconnectpool that were added back and cleans up the mempool state.\n     m_mempool->UpdateTransactionsFromBlock(vHashUpdate);\n \n+    const auto check_final_and_mature = [this, flags=STANDARD_LOCKTIME_VERIFY_FLAGS](CTxMemPool::txiter it)\n+        EXCLUSIVE_LOCKS_REQUIRED(m_mempool->cs, ::cs_main) {\n+        bool should_remove = false;\n+        AssertLockHeld(m_mempool->cs);\n+        AssertLockHeld(::cs_main);\n+        const CTransaction& tx = it->GetTx();\n+        LockPoints lp = it->GetLockPoints();\n+        bool validLP = TestLockPointValidity(m_chain, &lp);\n+        CCoinsViewMemPool view_mempool(&CoinsTip(), *m_mempool);\n+        if (!CheckFinalTx(m_chain.Tip(), tx, flags)\n+            || !CheckSequenceLocks(m_chain.Tip(), view_mempool, tx, flags, &lp, validLP)) {\n+            // Note if CheckSequenceLocks fails the LockPoints may still be invalid\n+            // So it's critical that we remove the tx and not depend on the LockPoints.\n+            should_remove = true;\n+        } else if (it->GetSpendsCoinbase()) {\n+            for (const CTxIn& txin : tx.vin) {\n+                auto it2 = m_mempool->mapTx.find(txin.prevout.hash);\n+                if (it2 != m_mempool->mapTx.end())\n+                    continue;\n+                const Coin &coin = CoinsTip().AccessCoin(txin.prevout);\n+                assert(!coin.IsSpent());\n+                unsigned int nMemPoolHeight = m_chain.Tip()->nHeight + 1;\n+                if (coin.IsSpent() || (coin.IsCoinBase() && ((signed long)nMemPoolHeight) - coin.nHeight < COINBASE_MATURITY)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r760430487",
      "id" : 760430487,
      "line" : 375,
      "node_id" : "PRRC_kwDOABII584tUz-X",
      "original_commit_id" : "a64078e38563ef3ac5e5ec20c07569441c87eeee",
      "original_line" : 375,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 51,
      "pull_request_review_id" : 820587394,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760430487/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-01T17:42:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760430487",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r760994972"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760994972"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "woop, should have declared as `auto&`. The good thing is it's removed in the last commit?",
      "commit_id" : "a64078e38563ef3ac5e5ec20c07569441c87eeee",
      "created_at" : "2021-12-02T11:16:37Z",
      "diff_hunk" : "@@ -663,15 +663,19 @@ void CTxMemPool::removeForReorg(CChainState& active_chainstate, int flags)\n                 }\n             }\n         }\n-        if (!validLP) {\n-            mapTx.modify(it, update_lock_points(lp));\n-        }\n     }\n     setEntries setAllRemoves;\n     for (txiter it : txToRemove) {\n         CalculateDescendants(it, setAllRemoves);\n     }\n     RemoveStaged(setAllRemoves, false, MemPoolRemovalReason::REORG);\n+    auto chain = active_chainstate.m_chain;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r760994972",
      "id" : 760994972,
      "in_reply_to_id" : 760400537,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584tW9yc",
      "original_commit_id" : "bedf246f1e2497a3641093c6e8fa11fb34dddac4",
      "original_line" : 672,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 821364546,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760994972/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-02T11:16:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/760994972",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r761030880"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/761030880"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done in #23649",
      "commit_id" : "a64078e38563ef3ac5e5ec20c07569441c87eeee",
      "created_at" : "2021-12-02T12:07:29Z",
      "diff_hunk" : "@@ -350,8 +350,39 @@ void CChainState::MaybeUpdateMempoolForReorg(\n     // the disconnectpool that were added back and cleans up the mempool state.\n     m_mempool->UpdateTransactionsFromBlock(vHashUpdate);\n \n+    const auto check_final_and_mature = [this, flags=STANDARD_LOCKTIME_VERIFY_FLAGS](CTxMemPool::txiter it)\n+        EXCLUSIVE_LOCKS_REQUIRED(m_mempool->cs, ::cs_main) {\n+        bool should_remove = false;\n+        AssertLockHeld(m_mempool->cs);\n+        AssertLockHeld(::cs_main);\n+        const CTransaction& tx = it->GetTx();\n+        LockPoints lp = it->GetLockPoints();\n+        bool validLP = TestLockPointValidity(m_chain, &lp);\n+        CCoinsViewMemPool view_mempool(&CoinsTip(), *m_mempool);\n+        if (!CheckFinalTx(m_chain.Tip(), tx, flags)\n+            || !CheckSequenceLocks(m_chain.Tip(), view_mempool, tx, flags, &lp, validLP)) {\n+            // Note if CheckSequenceLocks fails the LockPoints may still be invalid\n+            // So it's critical that we remove the tx and not depend on the LockPoints.\n+            should_remove = true;\n+        } else if (it->GetSpendsCoinbase()) {\n+            for (const CTxIn& txin : tx.vin) {\n+                auto it2 = m_mempool->mapTx.find(txin.prevout.hash);\n+                if (it2 != m_mempool->mapTx.end())\n+                    continue;\n+                const Coin &coin = CoinsTip().AccessCoin(txin.prevout);\n+                assert(!coin.IsSpent());\n+                unsigned int nMemPoolHeight = m_chain.Tip()->nHeight + 1;\n+                if (coin.IsSpent() || (coin.IsCoinBase() && ((signed long)nMemPoolHeight) - coin.nHeight < COINBASE_MATURITY)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r761030880",
      "id" : 761030880,
      "in_reply_to_id" : 760430487,
      "line" : 375,
      "node_id" : "PRRC_kwDOABII584tXGjg",
      "original_commit_id" : "a64078e38563ef3ac5e5ec20c07569441c87eeee",
      "original_line" : 375,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 51,
      "pull_request_review_id" : 821414192,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/761030880/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-02T12:07:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/761030880",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r761174522"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/761174522"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "taken in #23649",
      "commit_id" : "a64078e38563ef3ac5e5ec20c07569441c87eeee",
      "created_at" : "2021-12-02T14:57:43Z",
      "diff_hunk" : "@@ -14,6 +14,7 @@\n #include <utility>\n #include <vector>\n \n+#include <chain.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r761174522",
      "id" : 761174522,
      "in_reply_to_id" : 760049185,
      "line" : 17,
      "node_id" : "PRRC_kwDOABII584tXpn6",
      "original_commit_id" : "1b3a11e126b258fba975ed7c452221608f2c5472",
      "original_line" : 17,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : 4,
      "pull_request_review_id" : 821614841,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/761174522/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-02T14:57:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/761174522",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r762040101"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762040101"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Actually bedf246f1e2497a3641093c6e8fa11fb34dddac4 is wrong.\r\n\r\n`CheckSequenceLocks` modifies `lp`, so dropping it and using a fresh `lp` here from `GetLockPoints` is illegal.",
      "commit_id" : "a64078e38563ef3ac5e5ec20c07569441c87eeee",
      "created_at" : "2021-12-03T15:39:10Z",
      "diff_hunk" : "@@ -663,15 +663,19 @@ void CTxMemPool::removeForReorg(CChainState& active_chainstate, int flags)\n                 }\n             }\n         }\n-        if (!validLP) {\n-            mapTx.modify(it, update_lock_points(lp));\n-        }\n     }\n     setEntries setAllRemoves;\n     for (txiter it : txToRemove) {\n         CalculateDescendants(it, setAllRemoves);\n     }\n     RemoveStaged(setAllRemoves, false, MemPoolRemovalReason::REORG);\n+    auto chain = active_chainstate.m_chain;\n+    for (indexed_transaction_set::const_iterator it = mapTx.begin(); it != mapTx.end(); it++) {\n+        LockPoints lp = it->GetLockPoints();\n+        if (!TestLockPointValidity(chain, &lp)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r762040101",
      "id" : 762040101,
      "in_reply_to_id" : 760401836,
      "line" : 653,
      "node_id" : "PRRC_kwDOABII584ta88l",
      "original_commit_id" : "bedf246f1e2497a3641093c6e8fa11fb34dddac4",
      "original_line" : 675,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 81,
      "pull_request_review_id" : 822799759,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762040101/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-03T15:39:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762040101",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This is not refactoring, but introducing a bug: https://github.com/bitcoin/bitcoin/pull/22677#discussion_r762040101",
      "created_at" : "2021-12-03T15:40:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-985620586",
      "id" : 985620586,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
      "node_id" : "IC_kwDOABII5846v2Bq",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/985620586/reactions"
      },
      "updated_at" : "2021-12-03T15:40:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/985620586",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r762130704"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762130704"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Oof, that's not good. Can be fixed by moving `update_lock_points` back to txmempool.h and updating lockpoints within the lambda (original approach in b5de6cc10bfbc8174936c3e8ae9418dedfb60000). Should I open a pull with that?",
      "commit_id" : "a64078e38563ef3ac5e5ec20c07569441c87eeee",
      "created_at" : "2021-12-03T17:44:41Z",
      "diff_hunk" : "@@ -663,15 +663,19 @@ void CTxMemPool::removeForReorg(CChainState& active_chainstate, int flags)\n                 }\n             }\n         }\n-        if (!validLP) {\n-            mapTx.modify(it, update_lock_points(lp));\n-        }\n     }\n     setEntries setAllRemoves;\n     for (txiter it : txToRemove) {\n         CalculateDescendants(it, setAllRemoves);\n     }\n     RemoveStaged(setAllRemoves, false, MemPoolRemovalReason::REORG);\n+    auto chain = active_chainstate.m_chain;\n+    for (indexed_transaction_set::const_iterator it = mapTx.begin(); it != mapTx.end(); it++) {\n+        LockPoints lp = it->GetLockPoints();\n+        if (!TestLockPointValidity(chain, &lp)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r762130704",
      "id" : 762130704,
      "in_reply_to_id" : 760401836,
      "line" : 653,
      "node_id" : "PRRC_kwDOABII584tbTEQ",
      "original_commit_id" : "bedf246f1e2497a3641093c6e8fa11fb34dddac4",
      "original_line" : 675,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 81,
      "pull_request_review_id" : 822927192,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762130704/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-03T17:44:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762130704",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r776467278"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/776467278"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Actually [bedf246](https://github.com/bitcoin/bitcoin/commit/bedf246f1e2497a3641093c6e8fa11fb34dddac4) is wrong.\r\n> \r\n> `CheckSequenceLocks` modifies `lp`, so dropping it and using a fresh `lp` here from `GetLockPoints` is illegal.\r\n\r\n#23897 aims to make it less fragile in the future.",
      "commit_id" : "a64078e38563ef3ac5e5ec20c07569441c87eeee",
      "created_at" : "2021-12-29T19:30:34Z",
      "diff_hunk" : "@@ -663,15 +663,19 @@ void CTxMemPool::removeForReorg(CChainState& active_chainstate, int flags)\n                 }\n             }\n         }\n-        if (!validLP) {\n-            mapTx.modify(it, update_lock_points(lp));\n-        }\n     }\n     setEntries setAllRemoves;\n     for (txiter it : txToRemove) {\n         CalculateDescendants(it, setAllRemoves);\n     }\n     RemoveStaged(setAllRemoves, false, MemPoolRemovalReason::REORG);\n+    auto chain = active_chainstate.m_chain;\n+    for (indexed_transaction_set::const_iterator it = mapTx.begin(); it != mapTx.end(); it++) {\n+        LockPoints lp = it->GetLockPoints();\n+        if (!TestLockPointValidity(chain, &lp)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r776467278",
      "id" : 776467278,
      "in_reply_to_id" : 760401836,
      "line" : 653,
      "node_id" : "PRRC_kwDOABII584uR_NO",
      "original_commit_id" : "bedf246f1e2497a3641093c6e8fa11fb34dddac4",
      "original_line" : 675,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 81,
      "pull_request_review_id" : 841587796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/776467278/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-29T19:30:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/776467278",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   }
]
