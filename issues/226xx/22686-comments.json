[
   {
      "author_association" : "MEMBER",
      "body" : "For 22.0 backport (this bug may cause other issues that are not as immediately obvious).",
      "created_at" : "2021-08-12T02:16:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22686#issuecomment-897294749",
      "id" : 897294749,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22686",
      "node_id" : "IC_kwDOABII5841e6Gd",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-12T02:16:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/897294749",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Failure in the [previous releases CI](https://cirrus-ci.com/task/6498169006587904?logs=ci#L3632). Similar to #18737 / #18737:\r\n```bash\r\n test  2021-08-12T02:39:40.038000Z TestFramework (ERROR): Assertion failed \r\n                                   Traceback (most recent call last):\r\n                                     File \"/tmp/cirrus-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/test/functional/test_framework/test_framework.py\", line 131, in main\r\n                                       self.run_test()\r\n                                     File \"/tmp/cirrus-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/test/functional/feature_fee_estimation.py\", line 271, in run_test\r\n                                       check_estimates(self.nodes[1], self.fees_per_kb)\r\n                                     File \"/tmp/cirrus-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/test/functional/feature_fee_estimation.py\", line 155, in check_estimates\r\n                                       check_smart_estimates(node, fees_seen)\r\n                                     File \"/tmp/cirrus-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/test/functional/feature_fee_estimation.py\", line 145, in check_smart_estimates\r\n                                       % (feerate, last_feerate))\r\n                                   AssertionError: Estimated fee (0.000238) larger than last fee (0.000201) for lower number of confirms\r\n test  2021-08-12T02:39:40.040000Z TestFramework (DEBUG): Closing down network thread \r\n test  2021-08-12T02:39:40.041000Z TestFramework (INFO): Stopping nodes \r\n test  2021-08-12T02:39:40.041000Z TestFramework.node0 (DEBUG): Stopping node \r\n```",
      "created_at" : "2021-08-12T03:11:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22686#issuecomment-897313647",
      "id" : 897313647,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22686",
      "node_id" : "IC_kwDOABII5841e-tv",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-12T03:11:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/897313647",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#22049](https://github.com/bitcoin/bitcoin/pull/22049) (rpc: allow specifying min chain depth for inputs in fund calls by champo)\n* [#17211](https://github.com/bitcoin/bitcoin/pull/17211) (Allow fundrawtransaction and walletcreatefundedpsbt to take external inputs by achow101)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-08-12T19:18:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22686#issuecomment-897903241",
      "id" : 897903241,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22686",
      "node_id" : "IC_kwDOABII5841hOqJ",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-12T19:18:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/897903241",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "cc @Xekyo ",
      "created_at" : "2021-08-13T00:30:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22686#issuecomment-898062892",
      "id" : 898062892,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22686",
      "node_id" : "IC_kwDOABII5841h1os",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-13T00:30:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/898062892",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22686#discussion_r688196526"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22686"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/688196526"
         }
      },
      "author_association" : "MEMBER",
      "body" : "can this be done programmatically? \r\n\r\nblocks of comments means the chances of the description and/or the test going stale quite high\r\n\r\nin other words, can we get size estimations, calculate the final total, round properly, using python rather than english? ",
      "commit_id" : "5a89197a22bf806ff0ad7b514c037efcfb08bffe",
      "created_at" : "2021-08-13T02:09:32Z",
      "diff_hunk" : "@@ -969,6 +970,44 @@ def test_include_unsafe(self):\n         signedtx = wallet.signrawtransactionwithwallet(fundedtx['hex'])\n         wallet.sendrawtransaction(signedtx['hex'])\n \n+    def test_22670(self):\n+        # In issue #22670, it was observed that ApproximateBestSubset may\n+        # choose enough value to cover the target amount but not enough to cover the transaction fees.\n+        # This leads to a transaction whose actual transaction feerate is lower than expected.\n+        # However at normal feerates, the difference between the effective value and the real value\n+        # that this bug is not detected. It is most easily observed when the minimum relay fee is set to\n+        # an extremely high value (0.1 BTC/kvB in this test).\n+        self.log.info(\"Test issue 22670 ApproximateBestSubset bug\")\n+        # Make sure the default wallet will not be loaded when restarted with a high minrelaytxfee\n+        self.nodes[0].unloadwallet(self.default_wallet_name, False)\n+        self.restart_node(0, [\"-minrelaytxfee=0.1\", \"-changetype=bech32\"])\n+\n+        self.nodes[0].loadwallet(self.default_wallet_name, True)\n+        funds = self.nodes[0].get_wallet_rpc(self.default_wallet_name)\n+        self.nodes[0].createwallet(wallet_name=\"tester\")\n+        tester = self.nodes[0].get_wallet_rpc(\"tester\")\n+\n+        # Because this test is specifically for ApproximateBestSubset, the target value must be greater\n+        # than any single input available, and require more than 1 input. So we make 3 outputs\n+        for i in range(0, 3):\n+            funds.sendtoaddress(tester.getnewaddress(address_type=\"bech32\"), 1)\n+        self.nodes[0].generate(1)\n+\n+        # With 3 outputs of 1 BTC, the target value must between 1 and 2 BTC. We choose a value where with 2 inputs, the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22686#discussion_r688196526",
      "id" : 688196526,
      "line" : 996,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4ODE5NjUyNg==",
      "original_commit_id" : "5a89197a22bf806ff0ad7b514c037efcfb08bffe",
      "original_line" : 996,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "test/functional/rpc_fundrawtransaction.py",
      "position" : 35,
      "pull_request_review_id" : 729208250,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22686",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-13T02:21:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/688196526",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22686#discussion_r688197443"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22686"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/688197443"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe create `DEFAULT_MAX_RAW_TX_FEE_RATE` constant and use that so you can refer to it later as well?",
      "commit_id" : "5a89197a22bf806ff0ad7b514c037efcfb08bffe",
      "created_at" : "2021-08-13T02:12:43Z",
      "diff_hunk" : "@@ -969,6 +970,44 @@ def test_include_unsafe(self):\n         signedtx = wallet.signrawtransactionwithwallet(fundedtx['hex'])\n         wallet.sendrawtransaction(signedtx['hex'])\n \n+    def test_22670(self):\n+        # In issue #22670, it was observed that ApproximateBestSubset may\n+        # choose enough value to cover the target amount but not enough to cover the transaction fees.\n+        # This leads to a transaction whose actual transaction feerate is lower than expected.\n+        # However at normal feerates, the difference between the effective value and the real value\n+        # that this bug is not detected. It is most easily observed when the minimum relay fee is set to\n+        # an extremely high value (0.1 BTC/kvB in this test).\n+        self.log.info(\"Test issue 22670 ApproximateBestSubset bug\")\n+        # Make sure the default wallet will not be loaded when restarted with a high minrelaytxfee\n+        self.nodes[0].unloadwallet(self.default_wallet_name, False)\n+        self.restart_node(0, [\"-minrelaytxfee=0.1\", \"-changetype=bech32\"])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22686#discussion_r688197443",
      "id" : 688197443,
      "line" : 983,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4ODE5NzQ0Mw==",
      "original_commit_id" : "5a89197a22bf806ff0ad7b514c037efcfb08bffe",
      "original_line" : 983,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "test/functional/rpc_fundrawtransaction.py",
      "position" : 22,
      "pull_request_review_id" : 729208250,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22686",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-13T02:21:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/688197443",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22686#discussion_r688199891"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22686"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/688199891"
         }
      },
      "author_association" : "MEMBER",
      "body" : "am I correct in noting that `change_and_fee - change_amount` may be non-zero in `coin_selection_params.m_subtract_fee_outputs` instance in the case where change is dropped to fee?\r\n\r\njust thinking if any tighter assertion can be placed.",
      "commit_id" : "5a89197a22bf806ff0ad7b514c037efcfb08bffe",
      "created_at" : "2021-08-13T02:21:07Z",
      "diff_hunk" : "@@ -778,6 +778,10 @@ bool CWallet::CreateTransactionInternal(\n         fee_needed = coin_selection_params.m_effective_feerate.GetFee(nBytes);\n     }\n \n+    // The only time that fee_needed should be less than the amount available for fees (in change_and_fee - change_amount) is when\n+    // we are subtracting the fee from the outputs. If this occurs at any other time, it is a bug.\n+    assert(coin_selection_params.m_subtract_fee_outputs || fee_needed <= change_and_fee - change_amount);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22686#discussion_r688199891",
      "id" : 688199891,
      "line" : 783,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4ODE5OTg5MQ==",
      "original_commit_id" : "fdf2111ab5d9e57139d9512d0c5487c3eeb54e44",
      "original_line" : 783,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 6,
      "pull_request_review_id" : 729208250,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22686",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-13T02:21:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/688199891",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22686#discussion_r688206940"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22686"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/688206940"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes. If `m_subtract_fee_outputs`, `change_and_fee - change_amount` can be positive, negative, or 0. It's pretty much a useless value in that case.",
      "commit_id" : "5a89197a22bf806ff0ad7b514c037efcfb08bffe",
      "created_at" : "2021-08-13T02:45:47Z",
      "diff_hunk" : "@@ -778,6 +778,10 @@ bool CWallet::CreateTransactionInternal(\n         fee_needed = coin_selection_params.m_effective_feerate.GetFee(nBytes);\n     }\n \n+    // The only time that fee_needed should be less than the amount available for fees (in change_and_fee - change_amount) is when\n+    // we are subtracting the fee from the outputs. If this occurs at any other time, it is a bug.\n+    assert(coin_selection_params.m_subtract_fee_outputs || fee_needed <= change_and_fee - change_amount);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22686#discussion_r688206940",
      "id" : 688206940,
      "in_reply_to_id" : 688199891,
      "line" : 783,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4ODIwNjk0MA==",
      "original_commit_id" : "fdf2111ab5d9e57139d9512d0c5487c3eeb54e44",
      "original_line" : 783,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 6,
      "pull_request_review_id" : 729220228,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22686",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-13T02:45:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/688206940",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> To be clear, the bug is that it is using the output value, even if we're not subtracting fee from outputs. We use `GetSelectionAmount` to switch between effective and output value as our target based on subtracting fee from outputs or not.\r\n> \r\n> This explanation should go in the commit message, or at least the OP to get pulled in on merge.\r\n\r\nI've added a specific explanation in the first commit",
      "created_at" : "2021-08-13T04:35:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22686#issuecomment-898185311",
      "id" : 898185311,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22686",
      "node_id" : "IC_kwDOABII5841iThf",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-13T04:35:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/898185311",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22686#discussion_r688236670"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22686"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/688236670"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "92885c4f69a5e6fc4989677d6e5be8a666fbff0d",
      "created_at" : "2021-08-13T04:35:21Z",
      "diff_hunk" : "@@ -969,6 +970,44 @@ def test_include_unsafe(self):\n         signedtx = wallet.signrawtransactionwithwallet(fundedtx['hex'])\n         wallet.sendrawtransaction(signedtx['hex'])\n \n+    def test_22670(self):\n+        # In issue #22670, it was observed that ApproximateBestSubset may\n+        # choose enough value to cover the target amount but not enough to cover the transaction fees.\n+        # This leads to a transaction whose actual transaction feerate is lower than expected.\n+        # However at normal feerates, the difference between the effective value and the real value\n+        # that this bug is not detected. It is most easily observed when the minimum relay fee is set to\n+        # an extremely high value (0.1 BTC/kvB in this test).\n+        self.log.info(\"Test issue 22670 ApproximateBestSubset bug\")\n+        # Make sure the default wallet will not be loaded when restarted with a high minrelaytxfee\n+        self.nodes[0].unloadwallet(self.default_wallet_name, False)\n+        self.restart_node(0, [\"-minrelaytxfee=0.1\", \"-changetype=bech32\"])\n+\n+        self.nodes[0].loadwallet(self.default_wallet_name, True)\n+        funds = self.nodes[0].get_wallet_rpc(self.default_wallet_name)\n+        self.nodes[0].createwallet(wallet_name=\"tester\")\n+        tester = self.nodes[0].get_wallet_rpc(\"tester\")\n+\n+        # Because this test is specifically for ApproximateBestSubset, the target value must be greater\n+        # than any single input available, and require more than 1 input. So we make 3 outputs\n+        for i in range(0, 3):\n+            funds.sendtoaddress(tester.getnewaddress(address_type=\"bech32\"), 1)\n+        self.nodes[0].generate(1)\n+\n+        # With 3 outputs of 1 BTC, the target value must between 1 and 2 BTC. We choose a value where with 2 inputs, the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22686#discussion_r688236670",
      "id" : 688236670,
      "in_reply_to_id" : 688196526,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4ODIzNjY3MA==",
      "original_commit_id" : "5a89197a22bf806ff0ad7b514c037efcfb08bffe",
      "original_line" : 996,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "test/functional/rpc_fundrawtransaction.py",
      "position" : null,
      "pull_request_review_id" : 729254481,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22686",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-13T04:35:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/688236670",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22686#discussion_r688236735"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22686"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/688236735"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.. ish",
      "commit_id" : "92885c4f69a5e6fc4989677d6e5be8a666fbff0d",
      "created_at" : "2021-08-13T04:35:31Z",
      "diff_hunk" : "@@ -969,6 +970,44 @@ def test_include_unsafe(self):\n         signedtx = wallet.signrawtransactionwithwallet(fundedtx['hex'])\n         wallet.sendrawtransaction(signedtx['hex'])\n \n+    def test_22670(self):\n+        # In issue #22670, it was observed that ApproximateBestSubset may\n+        # choose enough value to cover the target amount but not enough to cover the transaction fees.\n+        # This leads to a transaction whose actual transaction feerate is lower than expected.\n+        # However at normal feerates, the difference between the effective value and the real value\n+        # that this bug is not detected. It is most easily observed when the minimum relay fee is set to\n+        # an extremely high value (0.1 BTC/kvB in this test).\n+        self.log.info(\"Test issue 22670 ApproximateBestSubset bug\")\n+        # Make sure the default wallet will not be loaded when restarted with a high minrelaytxfee\n+        self.nodes[0].unloadwallet(self.default_wallet_name, False)\n+        self.restart_node(0, [\"-minrelaytxfee=0.1\", \"-changetype=bech32\"])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22686#discussion_r688236735",
      "id" : 688236735,
      "in_reply_to_id" : 688197443,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4ODIzNjczNQ==",
      "original_commit_id" : "5a89197a22bf806ff0ad7b514c037efcfb08bffe",
      "original_line" : 983,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "test/functional/rpc_fundrawtransaction.py",
      "position" : null,
      "pull_request_review_id" : 729254540,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22686",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-13T04:35:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/688236735",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "utACK https://github.com/bitcoin/bitcoin/pull/22686/commits/92885c4f69a5e6fc4989677d6e5be8a666fbff0d",
      "created_at" : "2021-08-15T07:12:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22686#issuecomment-899007444",
      "id" : 899007444,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22686",
      "node_id" : "IC_kwDOABII5841lcPU",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-15T07:12:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/899007444",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Post-merge utACK 92885c4f69a5e6fc4989677d6e5be8a666fbff0d",
      "created_at" : "2021-08-18T19:18:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22686#issuecomment-901367159",
      "id" : 901367159,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22686",
      "node_id" : "IC_kwDOABII5841ucV3",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-18T19:18:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/901367159",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@Xekyo thanks for following up.",
      "created_at" : "2021-08-19T00:00:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22686#issuecomment-901506462",
      "id" : 901506462,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22686",
      "node_id" : "IC_kwDOABII5841u-We",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-19T00:00:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/901506462",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Backported in #22629.",
      "created_at" : "2021-08-19T07:51:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22686#issuecomment-901691019",
      "id" : 901691019,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22686",
      "node_id" : "IC_kwDOABII5841vraL",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-19T07:51:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/901691019",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22686#discussion_r691888435"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22686"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/691888435"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Why do we divide by 2 here?",
      "commit_id" : "92885c4f69a5e6fc4989677d6e5be8a666fbff0d",
      "created_at" : "2021-08-19T08:14:06Z",
      "diff_hunk" : "@@ -969,6 +970,62 @@ def test_include_unsafe(self):\n         signedtx = wallet.signrawtransactionwithwallet(fundedtx['hex'])\n         wallet.sendrawtransaction(signedtx['hex'])\n \n+    def test_22670(self):\n+        # In issue #22670, it was observed that ApproximateBestSubset may\n+        # choose enough value to cover the target amount but not enough to cover the transaction fees.\n+        # This leads to a transaction whose actual transaction feerate is lower than expected.\n+        # However at normal feerates, the difference between the effective value and the real value\n+        # that this bug is not detected because the transaction fee must be at least 0.01 BTC (the minimum change value).\n+        # Otherwise the targeted minimum change value will be enough to cover the transaction fees that were not\n+        # being accounted for. So the minimum relay fee is set to 0.1 BTC/kvB in this test.\n+        self.log.info(\"Test issue 22670 ApproximateBestSubset bug\")\n+        # Make sure the default wallet will not be loaded when restarted with a high minrelaytxfee\n+        self.nodes[0].unloadwallet(self.default_wallet_name, False)\n+        feerate = Decimal(\"0.1\")\n+        self.restart_node(0, [f\"-minrelaytxfee={feerate}\", \"-discardfee=0\"]) # Set high minrelayfee, set discardfee to 0 for easier calculation\n+\n+        self.nodes[0].loadwallet(self.default_wallet_name, True)\n+        funds = self.nodes[0].get_wallet_rpc(self.default_wallet_name)\n+        self.nodes[0].createwallet(wallet_name=\"tester\")\n+        tester = self.nodes[0].get_wallet_rpc(\"tester\")\n+\n+        # Because this test is specifically for ApproximateBestSubset, the target value must be greater\n+        # than any single input available, and require more than 1 input. So we make 3 outputs\n+        for i in range(0, 3):\n+            funds.sendtoaddress(tester.getnewaddress(address_type=\"bech32\"), 1)\n+        self.nodes[0].generate(1)\n+\n+        # Create transactions in order to calculate fees for the target bounds that can trigger this bug\n+        change_tx = tester.fundrawtransaction(tester.createrawtransaction([], [{funds.getnewaddress(): 1.5}]))\n+        tx = tester.createrawtransaction([], [{funds.getnewaddress(): 2}])\n+        no_change_tx = tester.fundrawtransaction(tx, {\"subtractFeeFromOutputs\": [0]})\n+\n+        overhead_fees = feerate * len(tx) / 2 / 1000",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22686#discussion_r691888435",
      "id" : 691888435,
      "line" : 1003,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MTg4ODQzNQ==",
      "original_commit_id" : "92885c4f69a5e6fc4989677d6e5be8a666fbff0d",
      "original_line" : 1003,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "test/functional/rpc_fundrawtransaction.py",
      "position" : 42,
      "pull_request_review_id" : 733693856,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22686",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-19T08:14:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/691888435",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22686#discussion_r691888763"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22686"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/691888763"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The test also passes with much higher upper_bound.",
      "commit_id" : "92885c4f69a5e6fc4989677d6e5be8a666fbff0d",
      "created_at" : "2021-08-19T08:14:33Z",
      "diff_hunk" : "@@ -969,6 +970,62 @@ def test_include_unsafe(self):\n         signedtx = wallet.signrawtransactionwithwallet(fundedtx['hex'])\n         wallet.sendrawtransaction(signedtx['hex'])\n \n+    def test_22670(self):\n+        # In issue #22670, it was observed that ApproximateBestSubset may\n+        # choose enough value to cover the target amount but not enough to cover the transaction fees.\n+        # This leads to a transaction whose actual transaction feerate is lower than expected.\n+        # However at normal feerates, the difference between the effective value and the real value\n+        # that this bug is not detected because the transaction fee must be at least 0.01 BTC (the minimum change value).\n+        # Otherwise the targeted minimum change value will be enough to cover the transaction fees that were not\n+        # being accounted for. So the minimum relay fee is set to 0.1 BTC/kvB in this test.\n+        self.log.info(\"Test issue 22670 ApproximateBestSubset bug\")\n+        # Make sure the default wallet will not be loaded when restarted with a high minrelaytxfee\n+        self.nodes[0].unloadwallet(self.default_wallet_name, False)\n+        feerate = Decimal(\"0.1\")\n+        self.restart_node(0, [f\"-minrelaytxfee={feerate}\", \"-discardfee=0\"]) # Set high minrelayfee, set discardfee to 0 for easier calculation\n+\n+        self.nodes[0].loadwallet(self.default_wallet_name, True)\n+        funds = self.nodes[0].get_wallet_rpc(self.default_wallet_name)\n+        self.nodes[0].createwallet(wallet_name=\"tester\")\n+        tester = self.nodes[0].get_wallet_rpc(\"tester\")\n+\n+        # Because this test is specifically for ApproximateBestSubset, the target value must be greater\n+        # than any single input available, and require more than 1 input. So we make 3 outputs\n+        for i in range(0, 3):\n+            funds.sendtoaddress(tester.getnewaddress(address_type=\"bech32\"), 1)\n+        self.nodes[0].generate(1)\n+\n+        # Create transactions in order to calculate fees for the target bounds that can trigger this bug\n+        change_tx = tester.fundrawtransaction(tester.createrawtransaction([], [{funds.getnewaddress(): 1.5}]))\n+        tx = tester.createrawtransaction([], [{funds.getnewaddress(): 2}])\n+        no_change_tx = tester.fundrawtransaction(tx, {\"subtractFeeFromOutputs\": [0]})\n+\n+        overhead_fees = feerate * len(tx) / 2 / 1000\n+        cost_of_change = change_tx[\"fee\"] - no_change_tx[\"fee\"]\n+        fees = no_change_tx[\"fee\"]\n+        assert_greater_than(fees, 0.01)\n+\n+        def do_fund_send(target):\n+            create_tx = tester.createrawtransaction([], [{funds.getnewaddress(): lower_bound}])\n+            funded_tx = tester.fundrawtransaction(create_tx)\n+            signed_tx = tester.signrawtransactionwithwallet(funded_tx[\"hex\"])\n+            assert signed_tx[\"complete\"]\n+            decoded_tx = tester.decoderawtransaction(signed_tx[\"hex\"])\n+            assert_equal(len(decoded_tx[\"vin\"]), 3)\n+            assert tester.testmempoolaccept([signed_tx[\"hex\"]])[0][\"allowed\"]\n+\n+        # We want to choose more value than is available in 2 inputs when considering the fee,\n+        # but not enough to need 3 inputs when not considering the fee.\n+        # So the target value must be at least 2.00000001 - fee.\n+        lower_bound = Decimal(\"2.00000001\") - fees\n+        # The target value must be at most 2 - cost_of_change - not_input_fees - min_change (these are all\n+        # included in the target before ApproximateBestSubset).\n+        upper_bound = Decimal(\"2.0\") - cost_of_change - overhead_fees - Decimal(\"0.01\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22686#discussion_r691888763",
      "id" : 691888763,
      "line" : 1023,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MTg4ODc2Mw==",
      "original_commit_id" : "92885c4f69a5e6fc4989677d6e5be8a666fbff0d",
      "original_line" : 1023,
      "original_position" : 62,
      "original_start_line" : null,
      "path" : "test/functional/rpc_fundrawtransaction.py",
      "position" : 62,
      "pull_request_review_id" : 733693856,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22686",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-19T08:14:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/691888763",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22686#discussion_r692268515"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22686"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692268515"
         }
      },
      "author_association" : "MEMBER",
      "body" : "To get the byte length of the hex string.",
      "commit_id" : "92885c4f69a5e6fc4989677d6e5be8a666fbff0d",
      "created_at" : "2021-08-19T16:02:57Z",
      "diff_hunk" : "@@ -969,6 +970,62 @@ def test_include_unsafe(self):\n         signedtx = wallet.signrawtransactionwithwallet(fundedtx['hex'])\n         wallet.sendrawtransaction(signedtx['hex'])\n \n+    def test_22670(self):\n+        # In issue #22670, it was observed that ApproximateBestSubset may\n+        # choose enough value to cover the target amount but not enough to cover the transaction fees.\n+        # This leads to a transaction whose actual transaction feerate is lower than expected.\n+        # However at normal feerates, the difference between the effective value and the real value\n+        # that this bug is not detected because the transaction fee must be at least 0.01 BTC (the minimum change value).\n+        # Otherwise the targeted minimum change value will be enough to cover the transaction fees that were not\n+        # being accounted for. So the minimum relay fee is set to 0.1 BTC/kvB in this test.\n+        self.log.info(\"Test issue 22670 ApproximateBestSubset bug\")\n+        # Make sure the default wallet will not be loaded when restarted with a high minrelaytxfee\n+        self.nodes[0].unloadwallet(self.default_wallet_name, False)\n+        feerate = Decimal(\"0.1\")\n+        self.restart_node(0, [f\"-minrelaytxfee={feerate}\", \"-discardfee=0\"]) # Set high minrelayfee, set discardfee to 0 for easier calculation\n+\n+        self.nodes[0].loadwallet(self.default_wallet_name, True)\n+        funds = self.nodes[0].get_wallet_rpc(self.default_wallet_name)\n+        self.nodes[0].createwallet(wallet_name=\"tester\")\n+        tester = self.nodes[0].get_wallet_rpc(\"tester\")\n+\n+        # Because this test is specifically for ApproximateBestSubset, the target value must be greater\n+        # than any single input available, and require more than 1 input. So we make 3 outputs\n+        for i in range(0, 3):\n+            funds.sendtoaddress(tester.getnewaddress(address_type=\"bech32\"), 1)\n+        self.nodes[0].generate(1)\n+\n+        # Create transactions in order to calculate fees for the target bounds that can trigger this bug\n+        change_tx = tester.fundrawtransaction(tester.createrawtransaction([], [{funds.getnewaddress(): 1.5}]))\n+        tx = tester.createrawtransaction([], [{funds.getnewaddress(): 2}])\n+        no_change_tx = tester.fundrawtransaction(tx, {\"subtractFeeFromOutputs\": [0]})\n+\n+        overhead_fees = feerate * len(tx) / 2 / 1000",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22686#discussion_r692268515",
      "id" : 692268515,
      "in_reply_to_id" : 691888435,
      "line" : 1003,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MjI2ODUxNQ==",
      "original_commit_id" : "92885c4f69a5e6fc4989677d6e5be8a666fbff0d",
      "original_line" : 1003,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "test/functional/rpc_fundrawtransaction.py",
      "position" : 42,
      "pull_request_review_id" : 734198379,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22686",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-19T16:02:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692268515",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22686#discussion_r692269478"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22686"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692269478"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The lower and upper bounds are the minimum and maximum values that cause this test to fail prior to this PR. So a higher upper bound should still pass after this PR, and all values in between should pass after this PR.",
      "commit_id" : "92885c4f69a5e6fc4989677d6e5be8a666fbff0d",
      "created_at" : "2021-08-19T16:04:11Z",
      "diff_hunk" : "@@ -969,6 +970,62 @@ def test_include_unsafe(self):\n         signedtx = wallet.signrawtransactionwithwallet(fundedtx['hex'])\n         wallet.sendrawtransaction(signedtx['hex'])\n \n+    def test_22670(self):\n+        # In issue #22670, it was observed that ApproximateBestSubset may\n+        # choose enough value to cover the target amount but not enough to cover the transaction fees.\n+        # This leads to a transaction whose actual transaction feerate is lower than expected.\n+        # However at normal feerates, the difference between the effective value and the real value\n+        # that this bug is not detected because the transaction fee must be at least 0.01 BTC (the minimum change value).\n+        # Otherwise the targeted minimum change value will be enough to cover the transaction fees that were not\n+        # being accounted for. So the minimum relay fee is set to 0.1 BTC/kvB in this test.\n+        self.log.info(\"Test issue 22670 ApproximateBestSubset bug\")\n+        # Make sure the default wallet will not be loaded when restarted with a high minrelaytxfee\n+        self.nodes[0].unloadwallet(self.default_wallet_name, False)\n+        feerate = Decimal(\"0.1\")\n+        self.restart_node(0, [f\"-minrelaytxfee={feerate}\", \"-discardfee=0\"]) # Set high minrelayfee, set discardfee to 0 for easier calculation\n+\n+        self.nodes[0].loadwallet(self.default_wallet_name, True)\n+        funds = self.nodes[0].get_wallet_rpc(self.default_wallet_name)\n+        self.nodes[0].createwallet(wallet_name=\"tester\")\n+        tester = self.nodes[0].get_wallet_rpc(\"tester\")\n+\n+        # Because this test is specifically for ApproximateBestSubset, the target value must be greater\n+        # than any single input available, and require more than 1 input. So we make 3 outputs\n+        for i in range(0, 3):\n+            funds.sendtoaddress(tester.getnewaddress(address_type=\"bech32\"), 1)\n+        self.nodes[0].generate(1)\n+\n+        # Create transactions in order to calculate fees for the target bounds that can trigger this bug\n+        change_tx = tester.fundrawtransaction(tester.createrawtransaction([], [{funds.getnewaddress(): 1.5}]))\n+        tx = tester.createrawtransaction([], [{funds.getnewaddress(): 2}])\n+        no_change_tx = tester.fundrawtransaction(tx, {\"subtractFeeFromOutputs\": [0]})\n+\n+        overhead_fees = feerate * len(tx) / 2 / 1000\n+        cost_of_change = change_tx[\"fee\"] - no_change_tx[\"fee\"]\n+        fees = no_change_tx[\"fee\"]\n+        assert_greater_than(fees, 0.01)\n+\n+        def do_fund_send(target):\n+            create_tx = tester.createrawtransaction([], [{funds.getnewaddress(): lower_bound}])\n+            funded_tx = tester.fundrawtransaction(create_tx)\n+            signed_tx = tester.signrawtransactionwithwallet(funded_tx[\"hex\"])\n+            assert signed_tx[\"complete\"]\n+            decoded_tx = tester.decoderawtransaction(signed_tx[\"hex\"])\n+            assert_equal(len(decoded_tx[\"vin\"]), 3)\n+            assert tester.testmempoolaccept([signed_tx[\"hex\"]])[0][\"allowed\"]\n+\n+        # We want to choose more value than is available in 2 inputs when considering the fee,\n+        # but not enough to need 3 inputs when not considering the fee.\n+        # So the target value must be at least 2.00000001 - fee.\n+        lower_bound = Decimal(\"2.00000001\") - fees\n+        # The target value must be at most 2 - cost_of_change - not_input_fees - min_change (these are all\n+        # included in the target before ApproximateBestSubset).\n+        upper_bound = Decimal(\"2.0\") - cost_of_change - overhead_fees - Decimal(\"0.01\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22686#discussion_r692269478",
      "id" : 692269478,
      "in_reply_to_id" : 691888763,
      "line" : 1023,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MjI2OTQ3OA==",
      "original_commit_id" : "92885c4f69a5e6fc4989677d6e5be8a666fbff0d",
      "original_line" : 1023,
      "original_position" : 62,
      "original_start_line" : null,
      "path" : "test/functional/rpc_fundrawtransaction.py",
      "position" : 62,
      "pull_request_review_id" : 734199703,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22686",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-19T16:04:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/692269478",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22686#discussion_r938263704"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22686"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/938263704"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: this logic looks a little bit funny now. I think it might make more sense to have modified this `if` block as\r\n```\r\nï¿¼    if (fee_needed <= change_and_fee - change_amount) {\r\nï¿¼        nFeeRet = change_and_fee - change_amount;\r\n    } else {\r\n    ï¿¼    // The only time that fee_needed should be less than the amount available for fees (in change_and_fee - change_amount) is when\r\n    ï¿¼    // we are subtracting the fee from the outputs. If this occurs at any other time, it is a bug.\r\nï¿¼        assert(coin_selection_params.m_subtract_fee_outputs);\r\n    }\r\n```\r\nwhich is logically equivalent but doesn't do the same check twice",
      "commit_id" : "92885c4f69a5e6fc4989677d6e5be8a666fbff0d",
      "created_at" : "2022-08-04T21:31:45Z",
      "diff_hunk" : "@@ -778,6 +778,10 @@ bool CWallet::CreateTransactionInternal(\n         fee_needed = coin_selection_params.m_effective_feerate.GetFee(nBytes);\n     }\n \n+    // The only time that fee_needed should be less than the amount available for fees (in change_and_fee - change_amount) is when\n+    // we are subtracting the fee from the outputs. If this occurs at any other time, it is a bug.\n+    assert(coin_selection_params.m_subtract_fee_outputs || fee_needed <= change_and_fee - change_amount);\n+\n     // Update nFeeRet in case fee_needed changed due to dropping the change output\n     if (fee_needed <= change_and_fee - change_amount) {\n         nFeeRet = change_and_fee - change_amount;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22686#discussion_r938263704",
      "id" : 938263704,
      "line" : 787,
      "node_id" : "PRRC_kwDOABII58437MSY",
      "original_commit_id" : "d9262324e80da32725e21d4e0fbfee56f25490b1",
      "original_line" : 787,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 10,
      "pull_request_review_id" : 1062610782,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22686",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/938263704/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-04T21:31:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/938263704",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1351933?v=4",
         "events_url" : "https://api.github.com/users/apoelstra/events{/privacy}",
         "followers_url" : "https://api.github.com/users/apoelstra/followers",
         "following_url" : "https://api.github.com/users/apoelstra/following{/other_user}",
         "gists_url" : "https://api.github.com/users/apoelstra/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/apoelstra",
         "id" : 1351933,
         "login" : "apoelstra",
         "node_id" : "MDQ6VXNlcjEzNTE5MzM=",
         "organizations_url" : "https://api.github.com/users/apoelstra/orgs",
         "received_events_url" : "https://api.github.com/users/apoelstra/received_events",
         "repos_url" : "https://api.github.com/users/apoelstra/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/apoelstra/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/apoelstra/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/apoelstra"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22686#discussion_r939865238"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22686"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/939865238"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "JFYI #25647 changes these lines",
      "commit_id" : "92885c4f69a5e6fc4989677d6e5be8a666fbff0d",
      "created_at" : "2022-08-08T06:29:49Z",
      "diff_hunk" : "@@ -778,6 +778,10 @@ bool CWallet::CreateTransactionInternal(\n         fee_needed = coin_selection_params.m_effective_feerate.GetFee(nBytes);\n     }\n \n+    // The only time that fee_needed should be less than the amount available for fees (in change_and_fee - change_amount) is when\n+    // we are subtracting the fee from the outputs. If this occurs at any other time, it is a bug.\n+    assert(coin_selection_params.m_subtract_fee_outputs || fee_needed <= change_and_fee - change_amount);\n+\n     // Update nFeeRet in case fee_needed changed due to dropping the change output\n     if (fee_needed <= change_and_fee - change_amount) {\n         nFeeRet = change_and_fee - change_amount;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22686#discussion_r939865238",
      "id" : 939865238,
      "in_reply_to_id" : 938263704,
      "line" : 787,
      "node_id" : "PRRC_kwDOABII5844BTSW",
      "original_commit_id" : "d9262324e80da32725e21d4e0fbfee56f25490b1",
      "original_line" : 787,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 10,
      "pull_request_review_id" : 1064657491,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22686",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/939865238/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-08T06:29:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/939865238",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   }
]
