{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "MEMBER",
   "body" : "I performed a bit of hand-rolled static analysis on the Bitcoin source to check for potential deadlocks, by examining partial lock orders (like DEBUG_LOCKORDER but more thorough). I found a few, which I checked manually.\n\nThis list is not comprehensive, as indirect calls (functions pointers, virtual functions, such as in the RPC dispatcher) are currently ignored by my static checker.\n\nThese cases are the exceptions. The cases under \"counterexample\" are the \"normal\" order, or at least the most common one.\n\nCase 4 involves TRY_LOCKs, so it is probably OK.\n\n**1.**\n\n`SendMessages` **LOCK**s cs_inventory lock on a node\nâ `CWallet::GetTransaction` **LOCK**s the cs_wallet lock.\n\n_Counterexample_:\n`CWallet::ResendWalletTransactions` **LOCK**s cs_wallet lock\nâ `CWallet::RelayWalletTransaction`\nâ `RelayMessage`\nâ `RelayInventory`\nâ `CNode::PushInventory` which **LOCK**s the cs_inventory lock\n\n**2.**\n\n`CTxMemPool::accept(CTxDB&, CTransaction&, bool, bool*)` **LOCK**s local static lock for rate-limit\nâ `CWallet::GetDebit(CTransaction const&) const`\nâ`CWallet::GetDebit(CTxIn const&) const` **LOCK**s CWallet lock\n\n_Counterexample_:\n`CWallet::CommitTransaction(CWalletTx&, CReserveKey&)` **LOCK**s CWallet lock\nâ `CMerkleTx::AcceptToMemoryPool()`\nâ `CTxMemPool::accept(CTxDB&, CTransaction&, bool, bool*)` **LOCK**s local static lock for rate-limit\n\n**3.**\n\n`CWalletTx::AcceptWalletTransaction(CTxDB&, bool)` **LOCK**s CTxMemPool:cs\nâ `CTxMemPool::accept(CTxDB&, CTransaction&, bool, bool*)`\nâ`CWallet::GetDebit(CTransaction const&)`\nâ`CWallet::GetDebit(CTxIn const&)` **LOCK**s CWallet:cs_wallet\n\n`CreateNewBlock(CReserveKey&)` **LOCK**s CTxMemPool:cs\nâ `CBlock::ConnectBlock(CTxDB&, CBlockIndex*, bool)` \nâ `CWallet::AddToWalletIfInvolvingMe(CTransaction const&, CBlock const*, bool, bool)` **LOCK**s CWallet:cs_wallet\n\n_Counterexample_:\n`CWallet::CommitTransaction(CWalletTx&, CReserveKey&)` **LOCK**s CWallet:cs_wallet\nâ `CMerkleTx::AcceptToMemoryPool()` \nâ `CTransaction::ClientConnectInputs()` **LOCK**s CTxMemPool:cs\n\n**4.**\n\n`ThreadSocketHandler2(void*)` **LOCK**s cs_vNodes, then **TRYLOCK**s CNode:cs_vSend (when disconnecting nodes)\n\n_Counterexample_:\n`ThreadMessageHandler2(void*)` **TRYLOCK**s CNode:cs_vSend\nâ `SendMessages(CNode*, bool)` **LOCK**s cs_vNodes (for address refresh broadcast)\n",
   "closed_at" : "2014-01-10T15:21:10Z",
   "closed_by" : {
      "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
      "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
      "followers_url" : "https://api.github.com/users/laanwj/followers",
      "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/laanwj",
      "id" : 126646,
      "login" : "laanwj",
      "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
      "organizations_url" : "https://api.github.com/users/laanwj/orgs",
      "received_events_url" : "https://api.github.com/users/laanwj/received_events",
      "repos_url" : "https://api.github.com/users/laanwj/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/laanwj"
   },
   "comments" : 1,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1801/comments",
   "created_at" : "2012-09-08T11:22:29Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1801/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/1801",
   "id" : 6730648,
   "labels" : [
      {
         "color" : "FBBAAB",
         "default" : false,
         "id" : 64585,
         "name" : "Bug",
         "node_id" : "MDU6TGFiZWw2NDU4NQ==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Bug"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1801/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDU6SXNzdWU2NzMwNjQ4",
   "number" : 1801,
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "Potential deadlocks",
   "updated_at" : "2014-01-10T15:21:10Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1801",
   "user" : {
      "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
      "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
      "followers_url" : "https://api.github.com/users/laanwj/followers",
      "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/laanwj",
      "id" : 126646,
      "login" : "laanwj",
      "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
      "organizations_url" : "https://api.github.com/users/laanwj/orgs",
      "received_events_url" : "https://api.github.com/users/laanwj/received_events",
      "repos_url" : "https://api.github.com/users/laanwj/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/laanwj"
   }
}
