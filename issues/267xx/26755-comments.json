[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#26326](https://github.com/bitcoin/bitcoin/pull/26326) (net: don't lock cs_main while reading blocks in net processing by andrewtoth)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2022-12-26T20:29:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26755#issuecomment-1365448876",
      "id" : 1365448876,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26755",
      "node_id" : "IC_kwDOABII585RYxis",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1365448876/reactions"
      },
      "updated_at" : "2022-12-26T23:52:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1365448876",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26755#discussion_r1058259907"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26755"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1058259907"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not sure how useful this is. Won't this massively elevate the duration of the first call compared to all following ones?\r\n\r\nThe speed-up I reported in https://github.com/bitcoin/bitcoin/pull/23880#issuecomment-1086043016 is obviously dependent on the number of peers you send the message to. If there is only one peer, it will be slower, because the duration is `Ser+Copy*1`, which is more work than just `Ser*1`. However with sufficient peers `N`, there is a speed-up because `Ser+Copy*N` is faster than `Ser*N`.",
      "commit_id" : "6947ca3f9664f3fa089760ede09e44caa7b8b80f",
      "created_at" : "2022-12-28T10:52:46Z",
      "diff_hunk" : "@@ -50,5 +54,43 @@ static void DeserializeAndCheckBlockTest(benchmark::Bench& bench)\n     });\n }\n \n+static void SerializeNetMsg(benchmark::Bench& bench)\n+{\n+    CDataStream stream(benchmark::data::block413567, SER_NETWORK, PROTOCOL_VERSION);\n+    std::byte a{0};\n+    stream.write({&a, 1});\n+    CBlock block;\n+    stream >> block;\n+    auto pcmpctblock = std::make_shared<const CBlockHeaderAndShortTxIDs>(block);\n+    const CNetMsgMaker msgMaker(PROTOCOL_VERSION);\n+    bench.run([&] {\n+        CSerializedNetMsg msg{msgMaker.Make(NetMsgType::CMPCTBLOCK, *pcmpctblock)};\n+        ankerl::nanobench::doNotOptimizeAway(msg);\n+    });\n+}\n+\n+static void CacheSerializeNetMsg(benchmark::Bench& bench)\n+{\n+    CDataStream stream(benchmark::data::block413567, SER_NETWORK, PROTOCOL_VERSION);\n+    std::byte a{0};\n+    stream.write({&a, 1});\n+    CBlock block;\n+    stream >> block;\n+    auto pcmpctblock = std::make_unique<const CBlockHeaderAndShortTxIDs>(block);\n+    const std::shared_future<CSerializedNetMsg> lazy_ser{\n+        std::async(std::launch::deferred, [pcmpctblock = move(pcmpctblock)] {\n+            const CNetMsgMaker msgMaker(PROTOCOL_VERSION);\n+            return msgMaker.Make(NetMsgType::CMPCTBLOCK, *pcmpctblock);\n+        }\n+    )};\n+\n+    bench.run([&] {\n+        CSerializedNetMsg msg{lazy_ser.get().Copy()};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26755#discussion_r1058259907",
      "id" : 1058259907,
      "line" : 88,
      "node_id" : "PRRC_kwDOABII584_E8PD",
      "original_commit_id" : "6947ca3f9664f3fa089760ede09e44caa7b8b80f",
      "original_line" : 88,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/bench/checkblock.cpp",
      "position" : 51,
      "pull_request_review_id" : 1231486696,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26755",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1058259907/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-28T10:52:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1058259907",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26755#discussion_r1058477239"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26755"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1058477239"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hmm I suppose a better benchmark would be time it takes to copy to see what `N` needs to be for this optimization to make sense. I was making the assumption here that `Copy` is always faster than `Ser`, so if there's at least one high bandwidth peer we relayed too already then it makes sense to just `Copy` for any low bandwidth requests that come in rather than `Ser`.",
      "commit_id" : "6947ca3f9664f3fa089760ede09e44caa7b8b80f",
      "created_at" : "2022-12-28T16:58:12Z",
      "diff_hunk" : "@@ -50,5 +54,43 @@ static void DeserializeAndCheckBlockTest(benchmark::Bench& bench)\n     });\n }\n \n+static void SerializeNetMsg(benchmark::Bench& bench)\n+{\n+    CDataStream stream(benchmark::data::block413567, SER_NETWORK, PROTOCOL_VERSION);\n+    std::byte a{0};\n+    stream.write({&a, 1});\n+    CBlock block;\n+    stream >> block;\n+    auto pcmpctblock = std::make_shared<const CBlockHeaderAndShortTxIDs>(block);\n+    const CNetMsgMaker msgMaker(PROTOCOL_VERSION);\n+    bench.run([&] {\n+        CSerializedNetMsg msg{msgMaker.Make(NetMsgType::CMPCTBLOCK, *pcmpctblock)};\n+        ankerl::nanobench::doNotOptimizeAway(msg);\n+    });\n+}\n+\n+static void CacheSerializeNetMsg(benchmark::Bench& bench)\n+{\n+    CDataStream stream(benchmark::data::block413567, SER_NETWORK, PROTOCOL_VERSION);\n+    std::byte a{0};\n+    stream.write({&a, 1});\n+    CBlock block;\n+    stream >> block;\n+    auto pcmpctblock = std::make_unique<const CBlockHeaderAndShortTxIDs>(block);\n+    const std::shared_future<CSerializedNetMsg> lazy_ser{\n+        std::async(std::launch::deferred, [pcmpctblock = move(pcmpctblock)] {\n+            const CNetMsgMaker msgMaker(PROTOCOL_VERSION);\n+            return msgMaker.Make(NetMsgType::CMPCTBLOCK, *pcmpctblock);\n+        }\n+    )};\n+\n+    bench.run([&] {\n+        CSerializedNetMsg msg{lazy_ser.get().Copy()};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26755#discussion_r1058477239",
      "id" : 1058477239,
      "in_reply_to_id" : 1058259907,
      "line" : 88,
      "node_id" : "PRRC_kwDOABII584_FxS3",
      "original_commit_id" : "6947ca3f9664f3fa089760ede09e44caa7b8b80f",
      "original_line" : 88,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/bench/checkblock.cpp",
      "position" : 51,
      "pull_request_review_id" : 1231795119,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26755",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1058477239/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-28T16:58:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1058477239",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Benefit doesn't seem to be worth the change here.",
      "created_at" : "2022-12-28T18:19:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26755#issuecomment-1366837227",
      "id" : 1366837227,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26755",
      "node_id" : "IC_kwDOABII585ReEfr",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1366837227/reactions"
      },
      "updated_at" : "2022-12-28T18:19:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1366837227",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26755#discussion_r1058601226"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26755"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1058601226"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think the confusion is that this PR was changing the first low bandwidth response to use a lazy serializer and copy. This is actually using a copy of the same lazy future that is used for the high bandwidth peers. So as long as there's at least one high bandwidth peer then this optimization makes sense because the serialization will already have been done.",
      "commit_id" : "6947ca3f9664f3fa089760ede09e44caa7b8b80f",
      "created_at" : "2022-12-28T21:21:32Z",
      "diff_hunk" : "@@ -50,5 +54,43 @@ static void DeserializeAndCheckBlockTest(benchmark::Bench& bench)\n     });\n }\n \n+static void SerializeNetMsg(benchmark::Bench& bench)\n+{\n+    CDataStream stream(benchmark::data::block413567, SER_NETWORK, PROTOCOL_VERSION);\n+    std::byte a{0};\n+    stream.write({&a, 1});\n+    CBlock block;\n+    stream >> block;\n+    auto pcmpctblock = std::make_shared<const CBlockHeaderAndShortTxIDs>(block);\n+    const CNetMsgMaker msgMaker(PROTOCOL_VERSION);\n+    bench.run([&] {\n+        CSerializedNetMsg msg{msgMaker.Make(NetMsgType::CMPCTBLOCK, *pcmpctblock)};\n+        ankerl::nanobench::doNotOptimizeAway(msg);\n+    });\n+}\n+\n+static void CacheSerializeNetMsg(benchmark::Bench& bench)\n+{\n+    CDataStream stream(benchmark::data::block413567, SER_NETWORK, PROTOCOL_VERSION);\n+    std::byte a{0};\n+    stream.write({&a, 1});\n+    CBlock block;\n+    stream >> block;\n+    auto pcmpctblock = std::make_unique<const CBlockHeaderAndShortTxIDs>(block);\n+    const std::shared_future<CSerializedNetMsg> lazy_ser{\n+        std::async(std::launch::deferred, [pcmpctblock = move(pcmpctblock)] {\n+            const CNetMsgMaker msgMaker(PROTOCOL_VERSION);\n+            return msgMaker.Make(NetMsgType::CMPCTBLOCK, *pcmpctblock);\n+        }\n+    )};\n+\n+    bench.run([&] {\n+        CSerializedNetMsg msg{lazy_ser.get().Copy()};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26755#discussion_r1058601226",
      "id" : 1058601226,
      "in_reply_to_id" : 1058259907,
      "line" : 88,
      "node_id" : "PRRC_kwDOABII584_GPkK",
      "original_commit_id" : "6947ca3f9664f3fa089760ede09e44caa7b8b80f",
      "original_line" : 88,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/bench/checkblock.cpp",
      "position" : 51,
      "pull_request_review_id" : 1232024857,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26755",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1058601226/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-28T21:21:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1058601226",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   }
]
