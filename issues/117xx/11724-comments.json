[
   {
      "author_association" : "MEMBER",
      "body" : "It's probably due to the large dbcache. If the dbcache didn't flush before the shutdown, then the database would not have updated with the state stored in the dbcache.",
      "created_at" : "2017-11-18T20:30:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/11724#issuecomment-345469157",
      "id" : 345469157,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11724",
      "updated_at" : "2017-11-18T20:30:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/345469157",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I think so too. I wonder if it deducts dbcache from \"disk space remaining\" when it determines when to shut down. It seems https://github.com/bitcoin/bitcoin/blob/0.15/src/validation.cpp#L3435 initiates shutdown at 50MB remaining.\r\nAnother thing I wonder about is if there are some scheduled \"write cache flush\" index checkpoint events that didn't kick in on time due to my node's fast speed of syncing (30 MB/s).\r\n\r\nEdit: \r\nI forgot to mention one important point: I had another write-dominant workload running on the system, which probably messed up the calculation. \r\nI just did a test of shutdown time with dbcache=1000 vs dbcache=8000 and it was 0m20s vs 6m00s (in both cases, there was no other workload). \r\nIt's possible that the other workload combined with the long shutdown time made bitcoind unable to shutdown while there was still some free space on disk. If this is a situation that makes this issue invalid, I'll close it.",
      "created_at" : "2017-11-18T20:36:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/11724#issuecomment-345469501",
      "id" : 345469501,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11724",
      "updated_at" : "2017-11-18T21:42:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/345469501",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/13134193?v=4",
         "events_url" : "https://api.github.com/users/unsystemizer/events{/privacy}",
         "followers_url" : "https://api.github.com/users/unsystemizer/followers",
         "following_url" : "https://api.github.com/users/unsystemizer/following{/other_user}",
         "gists_url" : "https://api.github.com/users/unsystemizer/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/unsystemizer",
         "id" : 13134193,
         "login" : "unsystemizer",
         "organizations_url" : "https://api.github.com/users/unsystemizer/orgs",
         "received_events_url" : "https://api.github.com/users/unsystemizer/received_events",
         "repos_url" : "https://api.github.com/users/unsystemizer/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/unsystemizer/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/unsystemizer/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/unsystemizer"
      }
   },
   {
      "author_association" : "OWNER",
      "body" : "> wonder if it deducts dbcache from \"disk space remaining\" when it determines when to shut down.\r\n\r\nIt doesn't. Although it'd be nice to take database growth into account, that heuristic wouldn't be correct in most cases, because just as likely data in the dbcache exists on disk already.\r\n\r\nI do think the 50MB threshold is on the low side.\r\n\r\n> Another thing I wonder about is if there are some scheduled \"write cache flush\" index checkpoint events that didn't kick in on time due to my node's fast speed of syncing (30 MB/s).\r\n\r\nThere are no such events. To achieve the highest possible speed, it flushes to disk only when the dbcache is full or the node is shut down. To flush more often, set a lower dbcache.",
      "created_at" : "2017-11-19T11:13:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/11724#issuecomment-345508738",
      "id" : 345508738,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11724",
      "updated_at" : "2017-11-19T11:13:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/345508738",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I see. Considering the 50MB advance notice and a 30MB/s download speed, there's basically no time left to flush DB cache of any meaningful size (but as you say at least I can limit my losses at the cost of a slower sync speed). \r\nIt'd be nice to have this value exposed as a config/runtime parameter or hardcoded to a higher value (such as dbcache + 300 MB).",
      "created_at" : "2017-11-19T13:58:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/11724#issuecomment-345518865",
      "id" : 345518865,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11724",
      "updated_at" : "2017-11-19T13:59:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/345518865",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/13134193?v=4",
         "events_url" : "https://api.github.com/users/unsystemizer/events{/privacy}",
         "followers_url" : "https://api.github.com/users/unsystemizer/followers",
         "following_url" : "https://api.github.com/users/unsystemizer/following{/other_user}",
         "gists_url" : "https://api.github.com/users/unsystemizer/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/unsystemizer",
         "id" : 13134193,
         "login" : "unsystemizer",
         "organizations_url" : "https://api.github.com/users/unsystemizer/orgs",
         "received_events_url" : "https://api.github.com/users/unsystemizer/received_events",
         "repos_url" : "https://api.github.com/users/unsystemizer/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/unsystemizer/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/unsystemizer/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/unsystemizer"
      }
   }
]
