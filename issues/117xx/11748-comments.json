[
   {
      "author_association" : "OWNER",
      "body" : "> blockchain.cpp has low unit test coverage.\r\n\r\nIs that statement only about the unit tests as such, or does it include coverage from the RPC functional tests? As rpc/blockchain.cpp is an externally visible RPC interface implementation, I would expect most of its testing to happen through functional tests. Of course, I'm not opposed to improving unit tests too, where possible.",
      "created_at" : "2017-11-22T01:39:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11748#issuecomment-346216831",
      "id" : 346216831,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11748",
      "updated_at" : "2017-11-22T01:39:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/346216831",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "@sipa I've only checked the results of \"make cov\". I don't know anything about the RPC functional test coverage.",
      "created_at" : "2017-11-22T01:43:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11748#issuecomment-346217384",
      "id" : 346217384,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11748",
      "updated_at" : "2017-11-22T01:43:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/346217384",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/180403?v=4",
         "events_url" : "https://api.github.com/users/merehap/events{/privacy}",
         "followers_url" : "https://api.github.com/users/merehap/followers",
         "following_url" : "https://api.github.com/users/merehap/following{/other_user}",
         "gists_url" : "https://api.github.com/users/merehap/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/merehap",
         "id" : 180403,
         "login" : "merehap",
         "organizations_url" : "https://api.github.com/users/merehap/orgs",
         "received_events_url" : "https://api.github.com/users/merehap/received_events",
         "repos_url" : "https://api.github.com/users/merehap/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/merehap/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/merehap/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/merehap"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "I'm unable to reproduce locally the errors that Travis is seeing with \"make -j3 check VERBOSE=1\".\r\n\r\nIt appears that either CChain.SetTip() or GetDifficulty() has undefined behavior in certain cases, such that my tests succeed on certain build targets but fail on others. For my new test get_difficulty_for_null_block_index, GetDifficulty() is returning 0.0 for Travis jobs X.4 and X.6, but returning the correct value of 0.00402 for all of the other Travis Jobs.\r\n\r\nI'll keep looking.",
      "created_at" : "2017-11-22T03:25:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11748#issuecomment-346232467",
      "id" : 346232467,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11748",
      "updated_at" : "2017-11-22T07:42:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/346232467",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/180403?v=4",
         "events_url" : "https://api.github.com/users/merehap/events{/privacy}",
         "followers_url" : "https://api.github.com/users/merehap/followers",
         "following_url" : "https://api.github.com/users/merehap/following{/other_user}",
         "gists_url" : "https://api.github.com/users/merehap/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/merehap",
         "id" : 180403,
         "login" : "merehap",
         "organizations_url" : "https://api.github.com/users/merehap/orgs",
         "received_events_url" : "https://api.github.com/users/merehap/received_events",
         "repos_url" : "https://api.github.com/users/merehap/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/merehap/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/merehap/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/merehap"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11748#discussion_r152613717"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11748"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/152613717"
         }
      },
      "author_association" : "MEMBER",
      "body" : "That pointer will most likely point to something unwanted after `return` in the line below.",
      "commit_id" : "3e1ee310437f4c93113f6121425beffdc94702c2",
      "created_at" : "2017-11-22T16:20:47Z",
      "diff_hunk" : "@@ -0,0 +1,118 @@\n+#include <boost/test/unit_test.hpp>\n+\n+#include \"stdlib.h\"\n+\n+#include \"rpc/blockchain.cpp\"\n+#include \"test/test_bitcoin.h\"\n+\n+/* Equality between doubles is imprecise. Comparison should be done\n+ * with a small threshold of tolerance, rather than exact equality.\n+ */\n+bool DoubleEquals(double a, double b, double epsilon)\n+{\n+    return std::abs(a - b) < epsilon;\n+}\n+\n+CBlockIndex CreateBlockIndexWithNbits(uint32_t nbits)\n+{\n+    CBlockIndex block_index;\n+    block_index.nHeight = 46367;\n+    block_index.nTime = 1269211443;\n+    block_index.nBits = nbits;\n+    return block_index;\n+}\n+\n+CChain CreateChainWithNbits(uint32_t nbits)\n+{\n+    CBlockIndex block_index = CreateBlockIndexWithNbits(nbits);\n+    CChain chain;\n+    chain.SetTip(&block_index);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11748#discussion_r152613717",
      "id" : 152613717,
      "original_commit_id" : "9992424a129b8881c2d34c2ca7c1fdceeb32e71c",
      "original_position" : 29,
      "path" : "src/test/blockchain_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 78502540,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11748",
      "updated_at" : "2017-11-22T23:49:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/152613717",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "We have two targets for coverage builds: `test_bitcoin` (just the unit tests) and `total` (including functional tests). See for example here: https://marcofalke.github.io/btc_cov/",
      "created_at" : "2017-11-22T16:22:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11748#issuecomment-346400758",
      "id" : 346400758,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11748",
      "updated_at" : "2017-11-22T16:22:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/346400758",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11748#discussion_r152704894"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11748"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/152704894"
         }
      },
      "author_association" : "NONE",
      "body" : "Yep, you're right! That was the cause of the non-deterministic test failures. Please forgive my C++ inexperience. Fixed.",
      "commit_id" : "3e1ee310437f4c93113f6121425beffdc94702c2",
      "created_at" : "2017-11-23T00:09:19Z",
      "diff_hunk" : "@@ -0,0 +1,118 @@\n+#include <boost/test/unit_test.hpp>\n+\n+#include \"stdlib.h\"\n+\n+#include \"rpc/blockchain.cpp\"\n+#include \"test/test_bitcoin.h\"\n+\n+/* Equality between doubles is imprecise. Comparison should be done\n+ * with a small threshold of tolerance, rather than exact equality.\n+ */\n+bool DoubleEquals(double a, double b, double epsilon)\n+{\n+    return std::abs(a - b) < epsilon;\n+}\n+\n+CBlockIndex CreateBlockIndexWithNbits(uint32_t nbits)\n+{\n+    CBlockIndex block_index;\n+    block_index.nHeight = 46367;\n+    block_index.nTime = 1269211443;\n+    block_index.nBits = nbits;\n+    return block_index;\n+}\n+\n+CChain CreateChainWithNbits(uint32_t nbits)\n+{\n+    CBlockIndex block_index = CreateBlockIndexWithNbits(nbits);\n+    CChain chain;\n+    chain.SetTip(&block_index);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11748#discussion_r152704894",
      "id" : 152704894,
      "in_reply_to_id" : 152613717,
      "original_commit_id" : "9992424a129b8881c2d34c2ca7c1fdceeb32e71c",
      "original_position" : 29,
      "path" : "src/test/blockchain_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 78607261,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11748",
      "updated_at" : "2017-11-23T00:09:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/152704894",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/180403?v=4",
         "events_url" : "https://api.github.com/users/merehap/events{/privacy}",
         "followers_url" : "https://api.github.com/users/merehap/followers",
         "following_url" : "https://api.github.com/users/merehap/following{/other_user}",
         "gists_url" : "https://api.github.com/users/merehap/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/merehap",
         "id" : 180403,
         "login" : "merehap",
         "organizations_url" : "https://api.github.com/users/merehap/orgs",
         "received_events_url" : "https://api.github.com/users/merehap/received_events",
         "repos_url" : "https://api.github.com/users/merehap/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/merehap/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/merehap/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/merehap"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "@MarcoFalke It looks like the test coverage with functional tests included is almost 70%, but is still missing some functions entirely. For the time being I'll only be working on unit test coverage though.",
      "created_at" : "2017-11-23T00:11:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11748#issuecomment-346506096",
      "id" : 346506096,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11748",
      "updated_at" : "2017-11-23T00:11:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/346506096",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/180403?v=4",
         "events_url" : "https://api.github.com/users/merehap/events{/privacy}",
         "followers_url" : "https://api.github.com/users/merehap/followers",
         "following_url" : "https://api.github.com/users/merehap/following{/other_user}",
         "gists_url" : "https://api.github.com/users/merehap/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/merehap",
         "id" : 180403,
         "login" : "merehap",
         "organizations_url" : "https://api.github.com/users/merehap/orgs",
         "received_events_url" : "https://api.github.com/users/merehap/received_events",
         "repos_url" : "https://api.github.com/users/merehap/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/merehap/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/merehap/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/merehap"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@merehap That is fine. Unit test run way quicker and are probably run more often (compared to the extended functional tests).",
      "created_at" : "2017-11-23T00:21:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11748#issuecomment-346507262",
      "id" : 346507262,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11748",
      "updated_at" : "2017-11-23T00:21:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/346507262",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "@MarcoFalke @sipa As far as I know I've done everything needed for this PR. Is there anything else I need to do to move this along? Or just wait until someone else has time to review and test this?\r\n\r\nThanks! And apologies if I'm being overly impatient.",
      "created_at" : "2017-11-29T21:24:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11748#issuecomment-348000981",
      "id" : 348000981,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11748",
      "updated_at" : "2017-11-29T21:24:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/348000981",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/180403?v=4",
         "events_url" : "https://api.github.com/users/merehap/events{/privacy}",
         "followers_url" : "https://api.github.com/users/merehap/followers",
         "following_url" : "https://api.github.com/users/merehap/following{/other_user}",
         "gists_url" : "https://api.github.com/users/merehap/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/merehap",
         "id" : 180403,
         "login" : "merehap",
         "organizations_url" : "https://api.github.com/users/merehap/orgs",
         "received_events_url" : "https://api.github.com/users/merehap/received_events",
         "repos_url" : "https://api.github.com/users/merehap/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/merehap/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/merehap/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/merehap"
      }
   },
   {
      "author_association" : "OWNER",
      "body" : "utACK 3e1ee31, thanks for adding tests.",
      "created_at" : "2017-12-23T10:15:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11748#issuecomment-353718293",
      "id" : 353718293,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11748",
      "updated_at" : "2017-12-23T10:15:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/353718293",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "OWNER",
      "body" : "Regarding future direction, I think it's ok to add unit tests for utility functions used by RPC functions, such as this `GetDifficulty`. It is not directly testable externally.\r\n\r\nBut for really testing RPC functions, it is better to do so in the functional test framework than in unit tests as this directly tests API usability.",
      "created_at" : "2017-12-23T10:18:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11748#issuecomment-353718429",
      "id" : 353718429,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11748",
      "updated_at" : "2017-12-23T10:18:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/353718429",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   }
]
