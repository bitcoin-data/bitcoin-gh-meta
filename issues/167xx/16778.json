{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "NONE",
   "body" : "This is a continue of previously opened issue [Unable to stop bitcoin-qt. ThreadDNSAddressSeed hangs. #16642](https://github.com/bitcoin/bitcoin/issues/16642#issue-481935673). Now hardware problems are sorted out. Single consumer-grade HDD on USB3.0 is changed for RAID1 of HGST UltrastarÂ® 7K4000 on SATA. Database was changed for know working archived version. Except already repaired HDD problem, hardware is stable, none failures or glitches was found for several month of operation under different operating systems.\r\n\r\nThe problem is sometimes Bitcoin Core, particularly bitcoin-qt, unable to finish it's operation on close.\r\nI'm expecting normal bitcoin-qt application finishing after clicking \"close\" sign at top right corner of main GUI window.\r\nActual behavior: after several successful application shutdowns, the application remains to hang with a message \"Bitcoin Core is shutting down... Don't shut down the computer until this window dissapears.\"\r\nNatively compiled 01 Sep 2019 for arm-linux-gnueabihf, master branch.\r\n\r\nDebug output:\r\n```\r\n2019-09-01T07:44:54Z GUI: requestShutdown : Requesting shutdown\r\n2019-09-01T07:44:54Z GUI: shutdown : Running Shutdown in thread\r\n2019-09-01T07:44:54Z Interrupting HTTP server\r\n2019-09-01T07:44:54Z Interrupting HTTP RPC server\r\n2019-09-01T07:44:54Z Interrupting RPC\r\n2019-09-01T07:44:54Z addcon thread exit\r\n2019-09-01T07:44:54Z opencon thread exit\r\n2019-09-01T07:44:54Z msghand thread exit\r\n2019-09-01T07:44:54Z Shutdown: In progress...\r\n2019-09-01T07:44:54Z Stopping HTTP RPC server\r\n2019-09-01T07:44:54Z Stopping RPC\r\n2019-09-01T07:44:54Z Stopping HTTP server\r\n2019-09-01T07:44:54Z Stopped HTTP server\r\n2019-09-01T07:44:54Z net thread exit\r\n2019-09-01T07:44:54Z BerkeleyEnvironment::Flush: [/bdb] Flush(false)\r\n2019-09-01T07:44:54Z BerkeleyEnvironment::Flush: Flushing wallet.dat (refcount = 0)...\r\n2019-09-01T07:44:55Z BerkeleyEnvironment::Flush: wallet.dat checkpoint\r\n2019-09-01T07:44:55Z BerkeleyEnvironment::Flush: wallet.dat detach\r\n2019-09-01T07:44:55Z BerkeleyEnvironment::Flush: wallet.dat closed\r\n2019-09-01T07:44:55Z BerkeleyEnvironment::Flush: Flush(false) took             271ms\r\n2019-09-01T07:58:54Z Flushed 64452 addresses to peers.dat  1854ms\r\n2019-09-01T08:13:56Z Flushed 64452 addresses to peers.dat  2216ms\r\n2019-09-01T08:22:11Z Potential stale tip detected, will try using extra outbound peer (last tip update: 2245 seconds ago)\r\n2019-09-01T08:22:11Z net: setting try another outbound peer=true\r\n2019-09-01T08:28:58Z Flushed 64452 addresses to peers.dat  1895ms\r\n\r\n```\r\n\r\nThreads after shutdown request:\r\n```\r\nrock@Debian-Desktop:~$ ps -eLl\r\n...\r\nF S   UID   PID  PPID   LWP  C PRI  NI ADDR SZ WCHAN  TTY          TIME CMD\r\n0 S  1000  3094  1336  3094  4  80   0 - 139807 poll_s pts/0   00:02:43 bitcoin-main\r\n1 S  1000  3094  1336  3095  0  80   0 - 139807 poll_s pts/0   00:00:01 QXcbEventReader\r\n1 S  1000  3094  1336  3097  0  80   0 - 139807 futex_ pts/0   00:00:00 mali-mem-purge\r\n1 S  1000  3094  1336  3098  0  80   0 - 139807 futex_ pts/0   00:00:00 mali-utility-wo\r\n1 S  1000  3094  1336  3099  0  80   0 - 139807 futex_ pts/0   00:00:00 mali-utility-wo\r\n1 S  1000  3094  1336  3100  0  80   0 - 139807 futex_ pts/0   00:00:00 mali-utility-wo\r\n1 S  1000  3094  1336  3101  0  80   0 - 139807 futex_ pts/0   00:00:00 mali-utility-wo\r\n1 S  1000  3094  1336  3102  0  80   0 - 139807 futex_ pts/0   00:00:00 mali-utility-wo\r\n1 S  1000  3094  1336  3103  0  80   0 - 139807 futex_ pts/0   00:00:00 mali-utility-wo\r\n1 S  1000  3094  1336  3104  0  80   0 - 139807 poll_s pts/0   00:00:00 mali-cmar-backe\r\n1 S  1000  3094  1336  3105  0  80   0 - 139807 futex_ pts/0   00:00:00 mali-hist-dump\r\n1 S  1000  3094  1336  3106  0  80   0 - 139807 poll_s pts/0   00:00:00 QDBusConnection\r\n1 S  1000  3094  1336  3112  3  80   0 - 139807 futex_ pts/0   00:01:54 bitcoin-shutoff\r\n1 S  1000  3094  1336  3117  0  80   0 - 139807 futex_ pts/0   00:00:26 bitcoin-scriptc\r\n1 S  1000  3094  1336  3118  0  80   0 - 139807 futex_ pts/0   00:00:17 bitcoin-schedul\r\n1 S  1000  3094  1336  3122 17  80   0 - 139807 futex_ pts/0   00:09:23 bitcoin-qt-init\r\n1 S  1000  3094  1336  3151  0  80   0 - 139807 sk_wai pts/0   00:00:00 bitcoin-dnsseed\r\n1 S  1000  3094  1336  3156  0  80   0 - 139807 poll_s pts/0   00:00:00 QThread\r\n1 S  1000  3094  1336  3157  0  80   0 - 139807 poll_s pts/0   00:00:00 Qt bearer threa\r\n...\r\n```\r\nThe issue is reproducing quite reliable. With 0.18 versions on different computers, different builds I had this problem at least three times even after DB rescan. For some time the Core works normally but at some point, usually after network disturbance, it hangs on shutdown.\r\n\r\nNow it is self-compiled from https://github.com/bitcoin/bitcoin.git\r\nBitcoin Core version v0.18.99.0-495db72ee-dirty\r\nThe machine is ROCKPro64, RK3399 CPU, 4GB RAM.\r\nConfigure command was:\r\n```\r\n./configure --enable-debug --enable-werror BDB_LIBS=\"-L${BDB_PREFIX}/lib -ldb_cxx-4.8\" BDB_CFLAGS=\"-I${BDB_PREFIX}/include\" --with-boost-libdir=/usr/lib/arm-linux-gnueabihf\r\n```\r\nThis time I compiled the Core with debug enabled. If being provided with more debug instructions I will try to investigate it deeper.\r\nAfter the compilation and installation, test_bitcoin was completed with none errors.\r\n\r\nAs I wrote in #16642 before, the problem persist not only at mine ARM CPU but on an Intel CPU too.\r\n\r\nThank you.",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 0,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16778/comments",
   "created_at" : "2019-09-01T08:48:23Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16778/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/16778",
   "id" : 487859064,
   "labels" : [
      {
         "color" : "006b75",
         "default" : false,
         "id" : 98298007,
         "name" : "P2P",
         "node_id" : "MDU6TGFiZWw5ODI5ODAwNw==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/P2P"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16778/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDU6SXNzdWU0ODc4NTkwNjQ=",
   "number" : 16778,
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "title" : "ThreadDNSAddressSeed hangs on sk_wait_data and doesn't stop on exit",
   "updated_at" : "2019-09-01T08:52:59Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16778",
   "user" : {
      "avatar_url" : "https://avatars2.githubusercontent.com/u/54221205?v=4",
      "events_url" : "https://api.github.com/users/Nikolay-Po/events{/privacy}",
      "followers_url" : "https://api.github.com/users/Nikolay-Po/followers",
      "following_url" : "https://api.github.com/users/Nikolay-Po/following{/other_user}",
      "gists_url" : "https://api.github.com/users/Nikolay-Po/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/Nikolay-Po",
      "id" : 54221205,
      "login" : "Nikolay-Po",
      "node_id" : "MDQ6VXNlcjU0MjIxMjA1",
      "organizations_url" : "https://api.github.com/users/Nikolay-Po/orgs",
      "received_events_url" : "https://api.github.com/users/Nikolay-Po/received_events",
      "repos_url" : "https://api.github.com/users/Nikolay-Po/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/Nikolay-Po/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/Nikolay-Po/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/Nikolay-Po"
   }
}
