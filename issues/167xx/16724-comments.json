[
   {
      "author_association" : "NONE",
      "body" : "`feature_fee_estimation.py` passes locally, and doesn't seem related.",
      "created_at" : "2019-08-26T03:00:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16724#issuecomment-524697669",
      "id" : 524697669,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16724",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyNDY5NzY2OQ==",
      "updated_at" : "2019-08-26T03:00:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/524697669",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/938827?v=4",
         "events_url" : "https://api.github.com/users/bhinesley/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bhinesley/followers",
         "following_url" : "https://api.github.com/users/bhinesley/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bhinesley/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bhinesley",
         "id" : 938827,
         "login" : "bhinesley",
         "node_id" : "MDQ6VXNlcjkzODgyNw==",
         "organizations_url" : "https://api.github.com/users/bhinesley/orgs",
         "received_events_url" : "https://api.github.com/users/bhinesley/received_events",
         "repos_url" : "https://api.github.com/users/bhinesley/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bhinesley/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bhinesley/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bhinesley"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK\r\n\r\n> CWallet::ImportPrivKeys() in previous code block already imports the\r\nwpkh script\r\n\r\nDo you know where this happens? That function doesn't seem to do it directly, at least.",
      "created_at" : "2019-08-26T10:04:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16724#issuecomment-524802368",
      "id" : 524802368,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16724",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyNDgwMjM2OA==",
      "updated_at" : "2019-08-26T10:04:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/524802368",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "It's done by `FillableSigningProvider::ImplicitlyLearnRelatedKeyScripts()`:\r\nhttps://github.com/bitcoin/bitcoin/blob/adff8fe32101b2c007a85415c3ec565a7f137252/src/script/signingprovider.cpp#L87-L92\r\n\r\nHere's a stack trace showing how it's called by `CWallet::ImportPrivKeys()`:\r\n```\r\n(gdb) bt\r\n#0  FillableSigningProvider::ImplicitlyLearnRelatedKeyScripts (this=0x555556634590, pubkey=...) at script/signingprovider.cpp:73\r\n#1  0x0000555555c4319f in FillableSigningProvider::AddKeyPubKey (this=0x555556634590, key=..., pubkey=...) at script/signingprovider.cpp:109\r\n#2  0x0000555555ae8454 in CWallet::AddKeyPubKeyInner (this=0x555556634590, key=..., pubkey=...) at wallet/wallet.cpp:4913\r\n#3  0x0000555555ac5ba4 in CWallet::AddKeyPubKeyWithDB (this=0x555556634590, batch=..., secret=..., pubkey=...) at wallet/wallet.cpp:370\r\n#4  0x0000555555acfb9c in CWallet::ImportPrivKeys (this=0x555556634590, privkey_map=std::map with 1 element = {...}, timestamp=1)\r\n    at wallet/wallet.cpp:1820\r\n#5  0x0000555555b80e99 in importprivkey (request=...) at wallet/rpcdump.cpp:189\r\n```",
      "created_at" : "2019-08-26T20:37:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16724#issuecomment-525022017",
      "id" : 525022017,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16724",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyNTAyMjAxNw==",
      "updated_at" : "2019-08-26T20:42:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/525022017",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/938827?v=4",
         "events_url" : "https://api.github.com/users/bhinesley/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bhinesley/followers",
         "following_url" : "https://api.github.com/users/bhinesley/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bhinesley/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bhinesley",
         "id" : 938827,
         "login" : "bhinesley",
         "node_id" : "MDQ6VXNlcjkzODgyNw==",
         "organizations_url" : "https://api.github.com/users/bhinesley/orgs",
         "received_events_url" : "https://api.github.com/users/bhinesley/received_events",
         "repos_url" : "https://api.github.com/users/bhinesley/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bhinesley/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bhinesley/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bhinesley"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks! That's pretty sneaky, I was indeed searching for `AddCScript` or something similar, not something that bypasses everything and adds directly to the map.\r\n\r\nLooks good to me then. Code review ACK b6e7aa8c4c0162a3515a4efa93c2898a2c4d24b4",
      "created_at" : "2019-08-29T17:35:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16724#issuecomment-526286583",
      "id" : 526286583,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16724",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyNjI4NjU4Mw==",
      "updated_at" : "2019-08-29T17:35:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/526286583",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "It _is_ sneaky. The author of these lines obviously didn't see it either. Thanks for the review!",
      "created_at" : "2019-08-29T18:18:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16724#issuecomment-526302760",
      "id" : 526302760,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16724",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyNjMwMjc2MA==",
      "updated_at" : "2019-08-29T18:18:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/526302760",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/938827?v=4",
         "events_url" : "https://api.github.com/users/bhinesley/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bhinesley/followers",
         "following_url" : "https://api.github.com/users/bhinesley/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bhinesley/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bhinesley",
         "id" : 938827,
         "login" : "bhinesley",
         "node_id" : "MDQ6VXNlcjkzODgyNw==",
         "organizations_url" : "https://api.github.com/users/bhinesley/orgs",
         "received_events_url" : "https://api.github.com/users/bhinesley/received_events",
         "repos_url" : "https://api.github.com/users/bhinesley/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bhinesley/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bhinesley/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bhinesley"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK, the fix makes sense, haven't checked that the behaviour of ImplicitlyLearnRelatedKeyScripts behaves in the same way as ImportScripts though (with respect to writing to the wallet).\r\n\r\nI think this is fine?",
      "created_at" : "2019-08-30T01:46:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16724#issuecomment-526422797",
      "id" : 526422797,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16724",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyNjQyMjc5Nw==",
      "updated_at" : "2019-09-09T23:44:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/526422797",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/3211283?v=4",
         "events_url" : "https://api.github.com/users/meshcollider/events{/privacy}",
         "followers_url" : "https://api.github.com/users/meshcollider/followers",
         "following_url" : "https://api.github.com/users/meshcollider/following{/other_user}",
         "gists_url" : "https://api.github.com/users/meshcollider/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/meshcollider",
         "id" : 3211283,
         "login" : "meshcollider",
         "node_id" : "MDQ6VXNlcjMyMTEyODM=",
         "organizations_url" : "https://api.github.com/users/meshcollider/orgs",
         "received_events_url" : "https://api.github.com/users/meshcollider/received_events",
         "repos_url" : "https://api.github.com/users/meshcollider/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/meshcollider/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/meshcollider/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/meshcollider"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This will prevent the segwit output script from being written to the wallet file. While `ImplicitlyLoadRelatedScripts` allowed for those same scripts to be loaded, if the wallet were to be loaded into an older version of Bitcoin Core (without segwit I think, don't remember when this was added, but probably with segwit), outputs involving such scripts will not be recognized as they won't be loaded into the wallet in any way.",
      "created_at" : "2019-08-30T01:56:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16724#issuecomment-526424873",
      "id" : 526424873,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16724",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyNjQyNDg3Mw==",
      "updated_at" : "2019-08-30T01:56:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/526424873",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "@achow101 That's a good point, I think you're right.\r\n\r\nHere's another idea. The original code, for reference:\r\nhttps://github.com/bitcoin/bitcoin/blob/f5db3f2128f0b293432a5a36cb0314b501019a06/src/wallet/rpcdump.cpp#L188-L196\r\n\r\nIf we switch the order of these two blocks, like so:\r\n```\r\n// Add the wpkh script for this key if possible \r\nif (pubkey.IsCompressed()) { \r\n    pwallet->ImportScripts({GetScriptForDestination(WitnessV0KeyHash(vchAddress))}, 0 /* timestamp */); \r\n} \r\n\r\n// Use timestamp of 1 to scan the whole chain \r\nif (!pwallet->ImportPrivKeys({{vchAddress, key}}, 1)) {\r\n    throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding key to wallet\"); \r\n} \r\n```\r\nthe warning referenced in #16711 goes away, because `ImplicitlyLoadRelatedScripts` doesn't show a warning when the key already exists. Yes it's being written to the map twice in quick succession, but that shouldn't be an issue.",
      "created_at" : "2019-08-30T20:29:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16724#issuecomment-526739091",
      "id" : 526739091,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16724",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyNjczOTA5MQ==",
      "updated_at" : "2019-08-30T20:32:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/526739091",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/938827?v=4",
         "events_url" : "https://api.github.com/users/bhinesley/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bhinesley/followers",
         "following_url" : "https://api.github.com/users/bhinesley/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bhinesley/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bhinesley",
         "id" : 938827,
         "login" : "bhinesley",
         "node_id" : "MDQ6VXNlcjkzODgyNw==",
         "organizations_url" : "https://api.github.com/users/bhinesley/orgs",
         "received_events_url" : "https://api.github.com/users/bhinesley/received_events",
         "repos_url" : "https://api.github.com/users/bhinesley/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bhinesley/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bhinesley/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bhinesley"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Actually, the above would work, but this highlights a bigger problem. `ImportScripts()` relies on `FillableSigningProvider::HaveKey()` to determine whether to write the script to the wallet or not. However, as @achow101 just noted, a script appearing in the map doesn't mean it's written to the wallet. Thus, `ImplicitlyLoadRelatedScripts` can prevent scripts from being written.\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/e9ef1b2c2ec229be1974c0c2413af53cc804542e/src/wallet/wallet.cpp#L1778-L1781\r\n\r\nSo perhaps instead, the conditional statement above could be changed to read from the actual wallet to determine if a script exists.",
      "created_at" : "2019-08-31T05:21:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16724#issuecomment-526801033",
      "id" : 526801033,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16724",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyNjgwMTAzMw==",
      "updated_at" : "2019-08-31T05:22:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/526801033",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/938827?v=4",
         "events_url" : "https://api.github.com/users/bhinesley/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bhinesley/followers",
         "following_url" : "https://api.github.com/users/bhinesley/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bhinesley/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bhinesley",
         "id" : 938827,
         "login" : "bhinesley",
         "node_id" : "MDQ6VXNlcjkzODgyNw==",
         "organizations_url" : "https://api.github.com/users/bhinesley/orgs",
         "received_events_url" : "https://api.github.com/users/bhinesley/received_events",
         "repos_url" : "https://api.github.com/users/bhinesley/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bhinesley/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bhinesley/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bhinesley"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@achow101 @meshcollider did you want to follow up with approach thoughts here?",
      "created_at" : "2019-09-10T00:45:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16724#issuecomment-529720603",
      "id" : 529720603,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16724",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyOTcyMDYwMw==",
      "updated_at" : "2019-09-10T00:45:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/529720603",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "IMO places where the map is edited directly without writing (other than the initial read of the wallet) are going to be dangerous, that behavior should be changed instead of adding more checks that the script is in the wallet. I think we should make it not possible to add to the map without adding to the wallet file.\r\n\r\nEDIT: Thinking about this more, I think it is okay to just make ImportScripts check the database rather than just the map. Just make sure FillableSigningProvider doesn't have to worry about the database. Approach ACK ð \r\n\r\nThis is actually a bugfix",
      "created_at" : "2019-09-10T01:20:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16724#issuecomment-529727686",
      "id" : 529727686,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16724",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyOTcyNzY4Ng==",
      "updated_at" : "2019-09-10T04:26:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/529727686",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/3211283?v=4",
         "events_url" : "https://api.github.com/users/meshcollider/events{/privacy}",
         "followers_url" : "https://api.github.com/users/meshcollider/followers",
         "following_url" : "https://api.github.com/users/meshcollider/following{/other_user}",
         "gists_url" : "https://api.github.com/users/meshcollider/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/meshcollider",
         "id" : 3211283,
         "login" : "meshcollider",
         "node_id" : "MDQ6VXNlcjMyMTEyODM=",
         "organizations_url" : "https://api.github.com/users/meshcollider/orgs",
         "received_events_url" : "https://api.github.com/users/meshcollider/received_events",
         "repos_url" : "https://api.github.com/users/meshcollider/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/meshcollider/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/meshcollider/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/meshcollider"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Are there any legit reasons to not even try to write to DB?",
      "created_at" : "2019-09-10T13:08:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16724#issuecomment-529926135",
      "id" : 529926135,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16724",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyOTkyNjEzNQ==",
      "updated_at" : "2019-09-10T13:08:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/529926135",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "I'm now leaning towards a write to the wallet after `ImplicitlyLoadRelatedScripts()`. It's not safe to have addresses in the map that are never written to the wallet. Changing `HaveKeys()` to check from the wallet directly instead of the map defeats the purpose of the map _and_ `ImplicitlyLoadRelatedScripts`. After all, what's the point of implicitly loading anything if it's going to be ignored?\r\n\r\nMy initial understanding of the map is that it's just a cache to avoid repeated disk reads. Is that accurate? If that's true, 1) it should always write through immediately and 2) reads should almost always be done from the map (other than initially populating the map).\r\n\r\nThanks for your patience, everyone! I'm still wrapping my head around the codebase.",
      "created_at" : "2019-09-12T23:23:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16724#issuecomment-531043272",
      "id" : 531043272,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16724",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUzMTA0MzI3Mg==",
      "updated_at" : "2019-09-12T23:23:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/531043272",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/938827?v=4",
         "events_url" : "https://api.github.com/users/bhinesley/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bhinesley/followers",
         "following_url" : "https://api.github.com/users/bhinesley/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bhinesley/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bhinesley",
         "id" : 938827,
         "login" : "bhinesley",
         "node_id" : "MDQ6VXNlcjkzODgyNw==",
         "organizations_url" : "https://api.github.com/users/bhinesley/orgs",
         "received_events_url" : "https://api.github.com/users/bhinesley/received_events",
         "repos_url" : "https://api.github.com/users/bhinesley/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bhinesley/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bhinesley/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bhinesley"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "To reiterate, there is a more significant bug here than the superfluous warning this was initially submitted for:\r\n\r\n`ImplicitlyLoadRelatedScripts()` is adding scripts to the map but not the wallet. `HaveKeys()` (which works by checking only the map) is used to determine whether a key should be added to the wallet. So scripts that have been implicitly loaded can never be written to the wallet, even if done later via `AddCScript()`.",
      "created_at" : "2019-09-12T23:33:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16724#issuecomment-531045104",
      "id" : 531045104,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16724",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUzMTA0NTEwNA==",
      "updated_at" : "2019-09-12T23:33:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/531045104",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/938827?v=4",
         "events_url" : "https://api.github.com/users/bhinesley/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bhinesley/followers",
         "following_url" : "https://api.github.com/users/bhinesley/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bhinesley/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bhinesley",
         "id" : 938827,
         "login" : "bhinesley",
         "node_id" : "MDQ6VXNlcjkzODgyNw==",
         "organizations_url" : "https://api.github.com/users/bhinesley/orgs",
         "received_events_url" : "https://api.github.com/users/bhinesley/received_events",
         "repos_url" : "https://api.github.com/users/bhinesley/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bhinesley/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bhinesley/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bhinesley"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I think it is okay to just make ImportScripts check the database rather than just the map.\r\n\r\nI'm not really a fan of that. It's going to be a ton of disk reads and slow down large imports even further (we recently improved it with batched writes).\r\n\r\n***\r\n\r\n> To reiterate, there is a more significant bug here than the superfluous warning this was initially submitted for:\r\n> \r\n> `ImplicitlyLoadRelatedScripts()` is adding scripts to the map but not the wallet. `HaveKeys()` (which works by checking only the map) is used to determine whether a key should be added to the wallet. So scripts that have been implicitly loaded can never be written to the wallet, even if done later via `AddCScript()`.\r\n\r\nI'm not sure that that's necessarily a bug. IIRC, the point of `ImplicitlyLoadRelatedScripts()` is to let keys in the keypool be detected as used when their p2sh-p2wpkh were used. This would really only effect backups. Those scripts are later written to the wallet to allow for downgrading to non-segwit versions without losing the ability to spend used coins.\r\n\r\nPerhaps @sipa can provide some more insights about that as he wrote the code.\r\n\r\n***\r\n\r\nIf the intention of writing the scripts to the wallet was just to allow downgrading, we can actually just check the wallet version number to decide whether to write or not as recent wallet versions are too new to be downgraded anyways.",
      "created_at" : "2019-09-12T23:58:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16724#issuecomment-531049987",
      "id" : 531049987,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16724",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUzMTA0OTk4Nw==",
      "updated_at" : "2019-09-12T23:58:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/531049987",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "NONE",
      "body" : ">Those scripts are later written to the wallet to allow for downgrading to non-segwit versions without losing the ability to spend used coins.\r\n\r\nScripts in the map are written to the wallet somewhere?\r\n\r\n>If the intention of writing the scripts to the wallet was just to allow downgrading, we can actually just check the wallet version number to decide whether to write or not as recent wallet versions are too new to be downgraded anyways.\r\n\r\nYes, I was trying to account for your earlier comment that loading the wallet into older versions of bitcoin core would not carry the segwit scripts loaded implicitly with it.",
      "created_at" : "2019-09-13T00:18:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16724#issuecomment-531053970",
      "id" : 531053970,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16724",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUzMTA1Mzk3MA==",
      "updated_at" : "2019-09-13T00:18:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/531053970",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/938827?v=4",
         "events_url" : "https://api.github.com/users/bhinesley/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bhinesley/followers",
         "following_url" : "https://api.github.com/users/bhinesley/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bhinesley/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bhinesley",
         "id" : 938827,
         "login" : "bhinesley",
         "node_id" : "MDQ6VXNlcjkzODgyNw==",
         "organizations_url" : "https://api.github.com/users/bhinesley/orgs",
         "received_events_url" : "https://api.github.com/users/bhinesley/received_events",
         "repos_url" : "https://api.github.com/users/bhinesley/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bhinesley/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bhinesley/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bhinesley"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Scripts in the map are written to the wallet somewhere?\r\n\r\nKeys in the keypool don't have their scripts written to the wallet. Instead those scripts are loaded into memory via `ImplicitlyLearnRelatedScripts`. However once a key leaves the keypool, it's scripts are written to the wallet.",
      "created_at" : "2019-09-13T00:21:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16724#issuecomment-531054534",
      "id" : 531054534,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16724",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUzMTA1NDUzNA==",
      "updated_at" : "2019-09-13T00:21:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/531054534",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   }
]
