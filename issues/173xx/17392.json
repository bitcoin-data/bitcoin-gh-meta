{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "MEMBER",
   "body" : "<!-- Describe the issue -->\r\n\r\n**Expected behavior**\r\n\r\nNot run out of disk space, or:\r\n\r\nRun out of disk space, shut down. Free up disk space, start up again, continue IBD.\r\n\r\n**Actual behavior**\r\n\r\nQT says it ran out of disk space, but I suspect it was a permission issue due to the host and/or guest machine going into power saving (there was still 20 GB left).\r\n\r\nIt waited until I unlocked the computer, and only then shut down.\r\n\r\nI reduced the prune size and started up again, and got an `Error opening block database.`\r\n\r\nI freed up some space on the guest machine (I didn't realize yet that it actually had plenty). Started again, but got the same error.\r\n\r\nI suspend the guest machine and unsuspended it and tried again. It happily continued IBD.\r\n\r\n**To reproduce**\r\n\r\nHaven't tried.\r\n\r\n**System information**\r\n\r\nBitcoin Qt v0.19.3rc3 running on Windows 10 in a Virtual Box. Unlike #9482 I did not use a shared folder. The host machine (macOS) was locked, so it's possible some sort of power saving messd with it.\r\n\r\nLog when \"running out of space\":\r\n\r\n```\r\n2019-11-05T21:59:29Z UpdateTip: new best=000000000000000000175173c6fe40dd7cd74612e7b844be0419d8eac86c8375 height=517248 version=0x20000000 log2_work=88.539759 tx=309055810 date='2018-04-08T16:27:04Z' progress=0.654537 cache=2307.7MiB(16942461txo)\r\n2019-11-05T21:59:30Z UpdateTip: new best=0000000000000000003e0453ef04d9e17818ec3718d1811f1c0b295887828870 height=517249 version=0x20000000 log2_work=88.539807 tx=309058752 date='2018-04-08T16:54:07Z' progress=0.654543 cache=2308.0MiB(16945096txo)\r\n2019-11-05T21:59:30Z *** Disk space is too low!\r\n2019-11-05T21:59:30Z Error: Disk space is too low!\r\n2019-11-05T22:19:31Z socket sending timeout: 1201s\r\n2019-11-06T06:51:51Z ERROR: SaveBlockToDisk: FindBlockPos failed\r\n2019-11-06T06:51:51Z ERROR: ProcessNewBlock: AcceptBlock FAILED (AcceptBlock: Failed to find position to write new block to disk (code 0))\r\n2019-11-06T06:51:51Z ERROR: SerializeDB: Serialize or I/O error - CAutoFile::write: write failed: iostream error\r\n2019-11-06T06:51:51Z Shutdown: In progress...\r\n2019-11-06T06:51:51Z net thread exit\r\n2019-11-06T06:51:51Z addcon thread exit\r\n2019-11-06T06:51:51Z opencon thread exit\r\n2019-11-06T06:51:52Z msghand thread exit\r\n2019-11-06T06:51:52Z ERROR: SerializeDB: Serialize or I/O error - CAutoFile::write: write failed: iostream error\r\n2019-11-06T06:51:52Z scheduler thread interrupt\r\n2019-11-06T06:51:52Z Dumped mempool: 0s to copy, 0s to dump\r\n2019-11-06T06:51:52Z CBlockPolicyEstimator::Write(): unable to write policy estimator data (non-fatal)\r\n2019-11-06T06:51:52Z *** Disk space is too low!\r\n2019-11-06T06:51:52Z Error: Disk space is too low!\r\n2019-11-06T06:51:52Z ForceFlushStateToDisk: failed to flush state (Disk space is too low! (code 0))\r\n2019-11-06T06:51:52Z *** Disk space is too low!\r\n2019-11-06T06:51:52Z Error: Disk space is too low!\r\n2019-11-06T06:51:52Z ForceFlushStateToDisk: failed to flush state (Disk space is too low! (code 0))\r\n2019-11-06T06:52:04Z Shutdown: done\r\n```\r\n\r\nNote the time gap before `SaveBlockToDisk`, which was when I unlocked the host macOS as well as the guest Windows 10 machine.\r\n\r\nLog upon restart. I reduced prune size, but that's generally not enough.\r\n\r\n```\r\n2019-11-06T06:52:29Z Bitcoin Core version v0.19.0rc3 (release build)\r\n2019-11-06T06:52:29Z InitParameterInteraction: parameter interaction: -connect set -> setting -dnsseed=0\r\n2019-11-06T06:52:29Z InitParameterInteraction: parameter interaction: -listen=0 -> setting -upnp=0\r\n2019-11-06T06:52:29Z InitParameterInteraction: parameter interaction: -listen=0 -> setting -discover=0\r\n2019-11-06T06:52:29Z InitParameterInteraction: parameter interaction: -listen=0 -> setting -listenonion=0\r\n2019-11-06T06:52:30Z Assuming ancestors of block 00000000000000000005f8920febd3925f8272a6a71237563d78c2edfdd09ddf have valid signatures.\r\n2019-11-06T06:52:30Z Setting nMinimumChainWork=000000000000000000000000000000000000000008ea3cf107ae0dec57f03fe8\r\n2019-11-06T06:52:30Z Prune configured to target 10000 MiB on disk for block and undo files.\r\n2019-11-06T06:52:30Z Using the 'sse4(1way),sse41(4way),avx2(8way)' SHA256 implementation\r\n2019-11-06T06:52:30Z Using RdSeed as additional entropy source\r\n2019-11-06T06:52:30Z Using RdRand as an additional entropy source\r\n2019-11-06T06:52:30Z GUI: \"registerShutdownBlockReason: Successfully registered: Bitcoin Core didn't yet exit safely...\"\r\n2019-11-06T06:52:30Z Default data directory C:\\Users\\sjors\\AppData\\Roaming\\Bitcoin\r\n2019-11-06T06:52:30Z Using data directory C:\\Users\\sjors\\AppData\\Roaming\\Bitcoin\r\n2019-11-06T06:52:30Z Config file: C:\\Users\\sjors\\AppData\\Roaming\\Bitcoin\\bitcoin.conf\r\n2019-11-06T06:52:30Z Using at most 125 automatic connections (2048 file descriptors available)\r\n2019-11-06T06:52:30Z Using 16 MiB out of 32/2 requested for signature cache, able to store 524288 elements\r\n2019-11-06T06:52:30Z Using 16 MiB out of 32/2 requested for script execution cache, able to store 524288 elements\r\n2019-11-06T06:52:30Z Using 6 threads for script verification\r\n2019-11-06T06:52:30Z Using wallet directory C:\\Users\\sjors\\AppData\\Roaming\\Bitcoin\\wallets\r\n2019-11-06T06:52:30Z scheduler thread start\r\n2019-11-06T06:52:30Z init message: Verifying wallet(s)...\r\n2019-11-06T06:52:30Z init message: Loading banlist...\r\n2019-11-06T06:52:30Z Cache configuration:\r\n2019-11-06T06:52:30Z * Using 2.0 MiB for block index database\r\n2019-11-06T06:52:30Z * Using 8.0 MiB for chain state database\r\n2019-11-06T06:52:30Z * Using 6990.0 MiB for in-memory UTXO set (plus up to 286.1 MiB of unused mempool space)\r\n2019-11-06T06:52:30Z init message: Loading block index...\r\n2019-11-06T06:52:30Z Opening LevelDB in C:\\Users\\sjors\\AppData\\Roaming\\Bitcoin\\blocks\\index\r\n2019-11-06T06:52:30Z Fatal LevelDB error: IO error: Win32WritableFile.Append::WriteFile: C:\\Users\\sjors\\AppData\\Roaming\\Bitcoin\\blocks\\index\\000932.ldb: There is not enough space on the disk.\\x0d\r\n\r\n2019-11-06T06:52:30Z You can use -debug=leveldb to get more complete diagnostic messages\r\n2019-11-06T06:52:30Z Fatal LevelDB error: IO error: Win32WritableFile.Append::WriteFile: C:\\Users\\sjors\\AppData\\Roaming\\Bitcoin\\blocks\\index\\000932.ldb: There is not enough space on the disk.\\x0d\r\n\r\n2019-11-06T06:52:30Z : Error opening block database.\r\nPlease restart with -reindex or -reindex-chainstate to recover.\r\n2019-11-06T06:52:58Z Aborted block database rebuild. Exiting.\r\n2019-11-06T06:52:58Z Shutdown: In progress...\r\n2019-11-06T06:52:58Z scheduler thread interrupt\r\n2019-11-06T06:52:58Z Shutdown: done\r\n```\r\n\r\nI freed some space and tried again:\r\n\r\n```\r\n2019-11-06T06:53:27Z Bitcoin Core version v0.19.0rc3 (release build)\r\n2019-11-06T06:53:27Z InitParameterInteraction: parameter interaction: -connect set -> setting -dnsseed=0\r\n2019-11-06T06:53:27Z InitParameterInteraction: parameter interaction: -listen=0 -> setting -upnp=0\r\n2019-11-06T06:53:27Z InitParameterInteraction: parameter interaction: -listen=0 -> setting -discover=0\r\n2019-11-06T06:53:27Z InitParameterInteraction: parameter interaction: -listen=0 -> setting -listenonion=0\r\n2019-11-06T06:53:27Z Assuming ancestors of block 00000000000000000005f8920febd3925f8272a6a71237563d78c2edfdd09ddf have valid signatures.\r\n2019-11-06T06:53:27Z Setting nMinimumChainWork=000000000000000000000000000000000000000008ea3cf107ae0dec57f03fe8\r\n2019-11-06T06:53:27Z Prune configured to target 10000 MiB on disk for block and undo files.\r\n2019-11-06T06:53:27Z Using the 'sse4(1way),sse41(4way),avx2(8way)' SHA256 implementation\r\n2019-11-06T06:53:28Z scheduler thread start\r\n2019-11-06T06:53:36Z Aborted block database rebuild. Exiting.\r\n2019-11-06T06:53:37Z Shutdown: In progress...\r\n2019-11-06T06:53:37Z scheduler thread interrupt\r\n2019-11-06T06:53:37Z Shutdown: done\r\n```",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 0,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17392/comments",
   "created_at" : "2019-11-06T07:27:18Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17392/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/17392",
   "id" : 518290577,
   "labels" : [
      {
         "color" : "FBBAAB",
         "default" : false,
         "id" : 64585,
         "name" : "Bug",
         "node_id" : "MDU6TGFiZWw2NDU4NQ==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Bug"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17392/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDU6SXNzdWU1MTgyOTA1Nzc=",
   "number" : 17392,
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "title" : "Fake data corruption after not really running out of disk space during IBD (pruned, Windows VM on macOS)",
   "updated_at" : "2019-11-06T07:27:18Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17392",
   "user" : {
      "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
      "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
      "followers_url" : "https://api.github.com/users/Sjors/followers",
      "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
      "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/Sjors",
      "id" : 10217,
      "login" : "Sjors",
      "node_id" : "MDQ6VXNlcjEwMjE3",
      "organizations_url" : "https://api.github.com/users/Sjors/orgs",
      "received_events_url" : "https://api.github.com/users/Sjors/received_events",
      "repos_url" : "https://api.github.com/users/Sjors/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/Sjors"
   }
}
