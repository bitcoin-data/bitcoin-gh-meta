[
   {
      "author_association" : "MEMBER",
      "body" : "Thank you @MarcoFalke @promag @jonatack @dongcarl @ariard @theuni @fjahr @hebasto @troygiorshev for reviewing the prerequisite PRs! This is the first PR in the cs_main_split sequence where we start getting benefit by reducing cs_main scope in net processing. It also introduces the new structure and locking model, so it's the PR that requires the most conceptual/approach review in the sequence. If this gets merged, then it's a long procession of PRs to slowly move data into the new `Peer` object.",
      "created_at" : "2020-07-28T09:24:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#issuecomment-664914956",
      "id" : 664914956,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19607",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2NDkxNDk1Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-28T09:24:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/664914956",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r461660871"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/461660871"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    const NodeId m_id;\r\n```\r\n\r\nin commit d60a16bb3f58fcb9422c277256b3c3a31cab3b2f\r\n\r\nAny reason to not make this const? Having this mutable would violate the assumption that the id is unique per peer.",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-07-28T15:12:42Z",
      "diff_hunk" : "@@ -468,6 +468,44 @@ static CNodeState *State(NodeId pnode) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     return &it->second;\n }\n \n+/**\n+ * Data stucture for an individual peer. This struct is not protected by\n+ * cs_main since it does not contain validation-critical data.\n+ *\n+ * Memory is owned by shared pointers and this object is destructed when\n+ * the refcount drops to zero (in FinalizeNode()).\n+ *\n+ * TODO: move most members from CNodeState to this structure.\n+ * TODO: move remaining application-layer data members from CNode to this structure.\n+ */\n+struct Peer {\n+    /** Same id as the CNode object for this peer */\n+    NodeId m_id;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r461660871",
      "id" : 461660871,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTY2MDg3MQ==",
      "original_commit_id" : "d60a16bb3f58fcb9422c277256b3c3a31cab3b2f",
      "original_line" : 483,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 456737279,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/461660871",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r461661767"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/461661767"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit in commit d60a16bb3f58fcb9422c277256b3c3a31cab3b2f\r\n```suggestion\r\n * the refcount drops to zero.\r\n```\r\n\r\nFinalizeNode only decreases the refcount by one. It can still be larger than one (as long as someone is holding a PeerRef, e.g. `getpeerinfo` or similar)",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-07-28T15:13:51Z",
      "diff_hunk" : "@@ -468,6 +468,44 @@ static CNodeState *State(NodeId pnode) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     return &it->second;\n }\n \n+/**\n+ * Data stucture for an individual peer. This struct is not protected by\n+ * cs_main since it does not contain validation-critical data.\n+ *\n+ * Memory is owned by shared pointers and this object is destructed when\n+ * the refcount drops to zero (in FinalizeNode()).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r461661767",
      "id" : 461661767,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTY2MTc2Nw==",
      "original_commit_id" : "d60a16bb3f58fcb9422c277256b3c3a31cab3b2f",
      "original_line" : 476,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 456737279,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/461661767",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r461664437"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/461664437"
         }
      },
      "author_association" : "MEMBER",
      "body" : "\r\nnit in same commit:\r\n\r\nCan be written with one less line ;)\r\n\r\n```suggestion\r\n    if (it != g_peer_map.end()) return it->second;\r\n    return {}; // ( or return nullptr; )\r\n```",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-07-28T15:17:32Z",
      "diff_hunk" : "@@ -468,6 +468,44 @@ static CNodeState *State(NodeId pnode) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     return &it->second;\n }\n \n+/**\n+ * Data stucture for an individual peer. This struct is not protected by\n+ * cs_main since it does not contain validation-critical data.\n+ *\n+ * Memory is owned by shared pointers and this object is destructed when\n+ * the refcount drops to zero (in FinalizeNode()).\n+ *\n+ * TODO: move most members from CNodeState to this structure.\n+ * TODO: move remaining application-layer data members from CNode to this structure.\n+ */\n+struct Peer {\n+    /** Same id as the CNode object for this peer */\n+    NodeId m_id;\n+\n+    Peer(NodeId id) : m_id(id) {}\n+};\n+\n+using PeerRef = std::shared_ptr<Peer>;\n+\n+/**\n+ * Map of all Peer objects, keyed by peer id. This map is protected\n+ * by the global g_peer_mutex. Once a shared pointer reference is\n+ * taken, the lock may be released. Individual fields are protected by\n+ * their own locks.\n+ */\n+Mutex g_peer_mutex;\n+static std::map<NodeId, PeerRef> g_peer_map GUARDED_BY(g_peer_mutex);\n+\n+/** Get a shared pointer to the Peer object.\n+ *  May return nullptr if the Peer object can't be found. */\n+static PeerRef GetPeer(NodeId id) {\n+    PeerRef ret;\n+    LOCK(g_peer_mutex);\n+    auto it = g_peer_map.find(id);\n+    if (it != g_peer_map.end()) ret = it->second;\n+    return ret;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r461664437",
      "id" : 461664437,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTY2NDQzNw==",
      "original_commit_id" : "d60a16bb3f58fcb9422c277256b3c3a31cab3b2f",
      "original_line" : 506,
      "original_position" : 39,
      "original_start_line" : 505,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 456737279,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/461664437",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r461695156"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/461695156"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This may be a rare case where a ternary makes things clearer.\r\n```suggestion\r\n    return (it != g_peer_map.end()) ? it->second : nullptr;\r\n```",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-07-28T16:00:34Z",
      "diff_hunk" : "@@ -468,6 +468,44 @@ static CNodeState *State(NodeId pnode) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     return &it->second;\n }\n \n+/**\n+ * Data stucture for an individual peer. This struct is not protected by\n+ * cs_main since it does not contain validation-critical data.\n+ *\n+ * Memory is owned by shared pointers and this object is destructed when\n+ * the refcount drops to zero (in FinalizeNode()).\n+ *\n+ * TODO: move most members from CNodeState to this structure.\n+ * TODO: move remaining application-layer data members from CNode to this structure.\n+ */\n+struct Peer {\n+    /** Same id as the CNode object for this peer */\n+    NodeId m_id;\n+\n+    Peer(NodeId id) : m_id(id) {}\n+};\n+\n+using PeerRef = std::shared_ptr<Peer>;\n+\n+/**\n+ * Map of all Peer objects, keyed by peer id. This map is protected\n+ * by the global g_peer_mutex. Once a shared pointer reference is\n+ * taken, the lock may be released. Individual fields are protected by\n+ * their own locks.\n+ */\n+Mutex g_peer_mutex;\n+static std::map<NodeId, PeerRef> g_peer_map GUARDED_BY(g_peer_mutex);\n+\n+/** Get a shared pointer to the Peer object.\n+ *  May return nullptr if the Peer object can't be found. */\n+static PeerRef GetPeer(NodeId id) {\n+    PeerRef ret;\n+    LOCK(g_peer_mutex);\n+    auto it = g_peer_map.find(id);\n+    if (it != g_peer_map.end()) ret = it->second;\n+    return ret;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r461695156",
      "id" : 461695156,
      "in_reply_to_id" : 461664437,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTY5NTE1Ng==",
      "original_commit_id" : "d60a16bb3f58fcb9422c277256b3c3a31cab3b2f",
      "original_line" : 506,
      "original_position" : 39,
      "original_start_line" : 505,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 456782646,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/461695156",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #19791 ([net processing] Move Misbehaving() to PeerManager by jnewbery)\n* #19723 (Ignore unknown messages before VERACK by sdaftuar)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-07-28T17:04:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#issuecomment-665160859",
      "id" : 665160859,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19607",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2NTE2MDg1OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-24T23:01:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/665160859",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r461860798"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/461860798"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "ACK on the removal of the unused `CNodeState.name`, however it's kinda hidden here and makes the misbehaving moves in 53a2978b5ea27852f7bfab337ccec83feee4e72e harder to follow.  Maybe it should be done in its own commit?",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-07-28T20:33:02Z",
      "diff_hunk" : "@@ -270,12 +270,6 @@ struct CNodeState {\n     const CService address;\n     //! Whether we have a fully established connection.\n     bool fCurrentlyConnected;\n-    //! Accumulated misbehaviour score for this peer.\n-    int nMisbehavior;\n-    //! Whether this peer should be disconnected and marked as discouraged (unless it has the noban permission).\n-    bool m_should_discourage;\n-    //! String name of this peer (debugging/logging purposes).\n-    const std::string name;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r461860798",
      "id" : 461860798,
      "line" : 284,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg2MDc5OA==",
      "original_commit_id" : "3fa130da3ad7960f9ece4d34ff6e108b64b6f957",
      "original_line" : 284,
      "original_position" : 9,
      "original_start_line" : 277,
      "path" : "src/net_processing.cpp",
      "position" : 9,
      "pull_request_review_id" : 456989502,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "LEFT",
      "start_line" : 283,
      "start_side" : "LEFT",
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/461860798",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r461862887"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/461862887"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: `GetPeer` is already in the codebase as `CService::GetPeer`.  Suggest `GetPeerRef` instead",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-07-28T20:37:00Z",
      "diff_hunk" : "@@ -468,6 +459,51 @@ static CNodeState *State(NodeId pnode) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     return &it->second;\n }\n \n+/**\n+ * Data stucture for an individual peer. This struct is not protected by\n+ * cs_main since it does not contain validation-critical data.\n+ *\n+ * Memory is owned by shared pointers and this object is destructed when\n+ * the refcount drops to zero (in FinalizeNode()).\n+ *\n+ * TODO: move most members from CNodeState to this structure.\n+ * TODO: move remaining application-layer data members from CNode to this structure.\n+ */\n+struct Peer {\n+    /** Same id as the CNode object for this peer */\n+    NodeId m_id;\n+\n+    /** Protects misbehavior data members */\n+    Mutex m_misbehavior_mutex;\n+    /** Accumulated misbehavior score for this peer */\n+    int m_misbehavior_score GUARDED_BY(m_misbehavior_mutex) {0};\n+    /** Whether this peer should be disconnected and banned (unless it has the noban permission) */\n+    bool m_should_discourage GUARDED_BY(m_misbehavior_mutex) {false};\n+\n+    Peer(NodeId id) : m_id(id) {}\n+};\n+\n+using PeerRef = std::shared_ptr<Peer>;\n+\n+/**\n+ * Map of all Peer objects, keyed by peer id. This map is protected\n+ * by the global g_peer_mutex. Once a shared pointer reference is\n+ * taken, the lock may be released. Individual fields are protected by\n+ * their own locks.\n+ */\n+Mutex g_peer_mutex;\n+static std::map<NodeId, PeerRef> g_peer_map GUARDED_BY(g_peer_mutex);\n+\n+/** Get a shared pointer to the Peer object.\n+ *  May return nullptr if the Peer object can't be found. */\n+static PeerRef GetPeer(NodeId id) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r461862887",
      "id" : 461862887,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg2Mjg4Nw==",
      "original_commit_id" : "3fa130da3ad7960f9ece4d34ff6e108b64b6f957",
      "original_line" : 499,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 456989502,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/461862887",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r461871291"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/461871291"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "s/stucture/structure/",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-07-28T20:52:05Z",
      "diff_hunk" : "@@ -468,6 +459,51 @@ static CNodeState *State(NodeId pnode) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     return &it->second;\n }\n \n+/**\n+ * Data stucture for an individual peer. This struct is not protected by",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r461871291",
      "id" : 461871291,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg3MTI5MQ==",
      "original_commit_id" : "3fa130da3ad7960f9ece4d34ff6e108b64b6f957",
      "original_line" : 463,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 456989502,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/461871291",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462032894"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462032894"
         }
      },
      "author_association" : "MEMBER",
      "body" : "in commit d60a16b\r\n\r\nIs there any reason to make this a global? This map gets populated in `PeerLogicValidation::InitializeNode`, which is called by connman. `PeerLogicValidation` keeps a pointer to this connman, so it would seem natural to me that it also keeps track of the peer map, e.g. in a (private) member.",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-07-29T04:36:54Z",
      "diff_hunk" : "@@ -468,6 +468,44 @@ static CNodeState *State(NodeId pnode) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     return &it->second;\n }\n \n+/**\n+ * Data stucture for an individual peer. This struct is not protected by\n+ * cs_main since it does not contain validation-critical data.\n+ *\n+ * Memory is owned by shared pointers and this object is destructed when\n+ * the refcount drops to zero (in FinalizeNode()).\n+ *\n+ * TODO: move most members from CNodeState to this structure.\n+ * TODO: move remaining application-layer data members from CNode to this structure.\n+ */\n+struct Peer {\n+    /** Same id as the CNode object for this peer */\n+    NodeId m_id;\n+\n+    Peer(NodeId id) : m_id(id) {}\n+};\n+\n+using PeerRef = std::shared_ptr<Peer>;\n+\n+/**\n+ * Map of all Peer objects, keyed by peer id. This map is protected\n+ * by the global g_peer_mutex. Once a shared pointer reference is\n+ * taken, the lock may be released. Individual fields are protected by\n+ * their own locks.\n+ */\n+Mutex g_peer_mutex;\n+static std::map<NodeId, PeerRef> g_peer_map GUARDED_BY(g_peer_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462032894",
      "id" : 462032894,
      "line" : 501,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAzMjg5NA==",
      "original_commit_id" : "d60a16bb3f58fcb9422c277256b3c3a31cab3b2f",
      "original_line" : 501,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 66,
      "pull_request_review_id" : 457188186,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462032894",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462108444"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462108444"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This was mostly just following the convention of net_processing having its data stored in globals. I've had a look at what would be involved in moving `g_peer_map` and `GetPeer()` to be members of `PeerLogicValidation`. The main problem is that in future commits I want to be able to call `GetPeer()` from functions all across net_processing, and many of those aren't member functions of PLV. That means I'd need to either pass a reference to PLV down to those functions, or make them members of PLV.\r\n\r\nDoing that (and moving more of the state currently stored as globals into PLV) seems like a reasonable thing to do, but feels a bit separate from the immediate goal of moving data into `Peer` so I'm inclined to leave it for later. What do you think?",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-07-29T07:54:07Z",
      "diff_hunk" : "@@ -468,6 +468,44 @@ static CNodeState *State(NodeId pnode) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     return &it->second;\n }\n \n+/**\n+ * Data stucture for an individual peer. This struct is not protected by\n+ * cs_main since it does not contain validation-critical data.\n+ *\n+ * Memory is owned by shared pointers and this object is destructed when\n+ * the refcount drops to zero (in FinalizeNode()).\n+ *\n+ * TODO: move most members from CNodeState to this structure.\n+ * TODO: move remaining application-layer data members from CNode to this structure.\n+ */\n+struct Peer {\n+    /** Same id as the CNode object for this peer */\n+    NodeId m_id;\n+\n+    Peer(NodeId id) : m_id(id) {}\n+};\n+\n+using PeerRef = std::shared_ptr<Peer>;\n+\n+/**\n+ * Map of all Peer objects, keyed by peer id. This map is protected\n+ * by the global g_peer_mutex. Once a shared pointer reference is\n+ * taken, the lock may be released. Individual fields are protected by\n+ * their own locks.\n+ */\n+Mutex g_peer_mutex;\n+static std::map<NodeId, PeerRef> g_peer_map GUARDED_BY(g_peer_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462108444",
      "id" : 462108444,
      "in_reply_to_id" : 462032894,
      "line" : 501,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjEwODQ0NA==",
      "original_commit_id" : "d60a16bb3f58fcb9422c277256b3c3a31cab3b2f",
      "original_line" : 501,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 66,
      "pull_request_review_id" : 457278769,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462108444",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462115462"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462115462"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You're right. This should be const. Fixed",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-07-29T08:06:22Z",
      "diff_hunk" : "@@ -468,6 +468,44 @@ static CNodeState *State(NodeId pnode) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     return &it->second;\n }\n \n+/**\n+ * Data stucture for an individual peer. This struct is not protected by\n+ * cs_main since it does not contain validation-critical data.\n+ *\n+ * Memory is owned by shared pointers and this object is destructed when\n+ * the refcount drops to zero (in FinalizeNode()).\n+ *\n+ * TODO: move most members from CNodeState to this structure.\n+ * TODO: move remaining application-layer data members from CNode to this structure.\n+ */\n+struct Peer {\n+    /** Same id as the CNode object for this peer */\n+    NodeId m_id;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462115462",
      "id" : 462115462,
      "in_reply_to_id" : 461660871,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjExNTQ2Mg==",
      "original_commit_id" : "d60a16bb3f58fcb9422c277256b3c3a31cab3b2f",
      "original_line" : 483,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 457287424,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462115462",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462115511"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462115511"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-07-29T08:06:29Z",
      "diff_hunk" : "@@ -468,6 +468,44 @@ static CNodeState *State(NodeId pnode) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     return &it->second;\n }\n \n+/**\n+ * Data stucture for an individual peer. This struct is not protected by\n+ * cs_main since it does not contain validation-critical data.\n+ *\n+ * Memory is owned by shared pointers and this object is destructed when\n+ * the refcount drops to zero (in FinalizeNode()).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462115511",
      "id" : 462115511,
      "in_reply_to_id" : 461661767,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjExNTUxMQ==",
      "original_commit_id" : "d60a16bb3f58fcb9422c277256b3c3a31cab3b2f",
      "original_line" : 476,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 457287501,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462115511",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462115635"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462115635"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done with Troy's ternary. Thanks!",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-07-29T08:06:43Z",
      "diff_hunk" : "@@ -468,6 +468,44 @@ static CNodeState *State(NodeId pnode) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     return &it->second;\n }\n \n+/**\n+ * Data stucture for an individual peer. This struct is not protected by\n+ * cs_main since it does not contain validation-critical data.\n+ *\n+ * Memory is owned by shared pointers and this object is destructed when\n+ * the refcount drops to zero (in FinalizeNode()).\n+ *\n+ * TODO: move most members from CNodeState to this structure.\n+ * TODO: move remaining application-layer data members from CNode to this structure.\n+ */\n+struct Peer {\n+    /** Same id as the CNode object for this peer */\n+    NodeId m_id;\n+\n+    Peer(NodeId id) : m_id(id) {}\n+};\n+\n+using PeerRef = std::shared_ptr<Peer>;\n+\n+/**\n+ * Map of all Peer objects, keyed by peer id. This map is protected\n+ * by the global g_peer_mutex. Once a shared pointer reference is\n+ * taken, the lock may be released. Individual fields are protected by\n+ * their own locks.\n+ */\n+Mutex g_peer_mutex;\n+static std::map<NodeId, PeerRef> g_peer_map GUARDED_BY(g_peer_mutex);\n+\n+/** Get a shared pointer to the Peer object.\n+ *  May return nullptr if the Peer object can't be found. */\n+static PeerRef GetPeer(NodeId id) {\n+    PeerRef ret;\n+    LOCK(g_peer_mutex);\n+    auto it = g_peer_map.find(id);\n+    if (it != g_peer_map.end()) ret = it->second;\n+    return ret;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462115635",
      "id" : 462115635,
      "in_reply_to_id" : 461664437,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjExNTYzNQ==",
      "original_commit_id" : "d60a16bb3f58fcb9422c277256b3c3a31cab3b2f",
      "original_line" : 506,
      "original_position" : 39,
      "original_start_line" : 505,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 457287671,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462115635",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462117635"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462117635"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It absolutely should. When I wrote the original branch, I moved `name` to `Peer` as well, but since then, I removed all uses of `name` in #19472 and #19583 but failed to remove it as a member. I've now separated its removal into a separate commit.",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-07-29T08:10:19Z",
      "diff_hunk" : "@@ -270,12 +270,6 @@ struct CNodeState {\n     const CService address;\n     //! Whether we have a fully established connection.\n     bool fCurrentlyConnected;\n-    //! Accumulated misbehaviour score for this peer.\n-    int nMisbehavior;\n-    //! Whether this peer should be disconnected and marked as discouraged (unless it has the noban permission).\n-    bool m_should_discourage;\n-    //! String name of this peer (debugging/logging purposes).\n-    const std::string name;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462117635",
      "id" : 462117635,
      "in_reply_to_id" : 461860798,
      "line" : 284,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjExNzYzNQ==",
      "original_commit_id" : "3fa130da3ad7960f9ece4d34ff6e108b64b6f957",
      "original_line" : 284,
      "original_position" : 9,
      "original_start_line" : 277,
      "path" : "src/net_processing.cpp",
      "position" : 9,
      "pull_request_review_id" : 457290198,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "LEFT",
      "start_line" : 283,
      "start_side" : "LEFT",
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462117635",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462120803"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462120803"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ok, changed to `GetPeerRef()`",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-07-29T08:15:35Z",
      "diff_hunk" : "@@ -468,6 +459,51 @@ static CNodeState *State(NodeId pnode) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     return &it->second;\n }\n \n+/**\n+ * Data stucture for an individual peer. This struct is not protected by\n+ * cs_main since it does not contain validation-critical data.\n+ *\n+ * Memory is owned by shared pointers and this object is destructed when\n+ * the refcount drops to zero (in FinalizeNode()).\n+ *\n+ * TODO: move most members from CNodeState to this structure.\n+ * TODO: move remaining application-layer data members from CNode to this structure.\n+ */\n+struct Peer {\n+    /** Same id as the CNode object for this peer */\n+    NodeId m_id;\n+\n+    /** Protects misbehavior data members */\n+    Mutex m_misbehavior_mutex;\n+    /** Accumulated misbehavior score for this peer */\n+    int m_misbehavior_score GUARDED_BY(m_misbehavior_mutex) {0};\n+    /** Whether this peer should be disconnected and banned (unless it has the noban permission) */\n+    bool m_should_discourage GUARDED_BY(m_misbehavior_mutex) {false};\n+\n+    Peer(NodeId id) : m_id(id) {}\n+};\n+\n+using PeerRef = std::shared_ptr<Peer>;\n+\n+/**\n+ * Map of all Peer objects, keyed by peer id. This map is protected\n+ * by the global g_peer_mutex. Once a shared pointer reference is\n+ * taken, the lock may be released. Individual fields are protected by\n+ * their own locks.\n+ */\n+Mutex g_peer_mutex;\n+static std::map<NodeId, PeerRef> g_peer_map GUARDED_BY(g_peer_mutex);\n+\n+/** Get a shared pointer to the Peer object.\n+ *  May return nullptr if the Peer object can't be found. */\n+static PeerRef GetPeer(NodeId id) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462120803",
      "id" : 462120803,
      "in_reply_to_id" : 461862887,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjEyMDgwMw==",
      "original_commit_id" : "3fa130da3ad7960f9ece4d34ff6e108b64b6f957",
      "original_line" : 499,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 457294113,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462120803",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462120869"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462120869"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-07-29T08:15:41Z",
      "diff_hunk" : "@@ -468,6 +459,51 @@ static CNodeState *State(NodeId pnode) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     return &it->second;\n }\n \n+/**\n+ * Data stucture for an individual peer. This struct is not protected by",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462120869",
      "id" : 462120869,
      "in_reply_to_id" : 461871291,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjEyMDg2OQ==",
      "original_commit_id" : "3fa130da3ad7960f9ece4d34ff6e108b64b6f957",
      "original_line" : 463,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 457294188,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462120869",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Is the plan to lock every member of Peer behind its own mutex? Why not give each Peer its own mutex instead?\r\n\r\nCurrently the plan is to have related members behind a single mutex, eg all tx relay fields behind the same mutex. The main reason is that that model maps most closely to what exists already (look at the various locks inside CNode). Once everything has moved to `Peer` then it should be much easier to change the locking model, but I didn't want to add a debate about what the ideal locking model is to this project.\r\n \r\n> Misbehaving's cs_main locks can be removed from denialofservice_tests.cpp: around here. I looked and couldn't find any further places.\r\n\r\nFixed. Thanks!\r\n\r\n> clang-format complains a bit on each commit.\r\n\r\nCan you expand a bit. What am I supposed to be looking for here?",
      "created_at" : "2020-07-29T08:34:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#issuecomment-665521734",
      "id" : 665521734,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19607",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2NTUyMTczNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-29T08:34:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/665521734",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> clang-format complains a bit on each commit.\r\n\r\nok, I've taken clang-format's suggestions, except one that joins an initializer list onto the same line as the function and parameter list (which makes a really long line), and one which would break the scripted-diff linter.",
      "created_at" : "2020-07-29T13:48:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#issuecomment-665675090",
      "id" : 665675090,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19607",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2NTY3NTA5MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-29T13:48:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/665675090",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@jnewbery it looks like there is an incomplete rebase-in-progress in the last commit 123bba3b03a6b0f9d791758cb5dfc2e5468bf193; will review on next push.",
      "created_at" : "2020-07-30T06:55:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#issuecomment-666167075",
      "id" : 666167075,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19607",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2NjE2NzA3NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-30T06:55:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/666167075",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462813973"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462813973"
         }
      },
      "author_association" : "MEMBER",
      "body" : "dumb style nit in commit 730ad2ee4026ab47daf6c35e8dd4d5a665a5442e:\r\n\r\nColon goes on next line to avoid clang-format complaint:\r\n\r\n```diff\r\ndiff --git a/src/net_processing.cpp b/src/net_processing.cpp\r\nindex e64215c7d5..ca36daabf6 100644\r\n--- a/src/net_processing.cpp\r\n+++ b/src/net_processing.cpp\r\n@@ -422,8 +422,8 @@ struct CNodeState {\r\n     //! Whether this peer relays txs via wtxid\r\n     bool m_wtxid_relay{false};\r\n \r\n-    CNodeState(CAddress addrIn, bool is_inbound, bool is_manual) :\r\n-        address(addrIn), m_is_inbound(is_inbound), m_is_manual_connection (is_manual)\r\n+    CNodeState(CAddress addrIn, bool is_inbound, bool is_manual)\r\n+        : address(addrIn), m_is_inbound(is_inbound), m_is_manual_connection(is_manual)\r\n     {\r\n         fCurrentlyConnected = false;\r\n         nMisbehavior = 0;\r\n",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-07-30T07:50:22Z",
      "diff_hunk" : "@@ -424,9 +422,8 @@ struct CNodeState {\n     //! Whether this peer relays txs via wtxid\n     bool m_wtxid_relay{false};\n \n-    CNodeState(CAddress addrIn, std::string addrNameIn, bool is_inbound, bool is_manual) :\n-        address(addrIn), name(std::move(addrNameIn)), m_is_inbound(is_inbound),\n-        m_is_manual_connection (is_manual)\n+    CNodeState(CAddress addrIn, bool is_inbound, bool is_manual) :\n+        address(addrIn), m_is_inbound(is_inbound), m_is_manual_connection (is_manual)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462813973",
      "id" : 462813973,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjgxMzk3Mw==",
      "original_commit_id" : "730ad2ee4026ab47daf6c35e8dd4d5a665a5442e",
      "original_line" : 426,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 458163458,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462813973",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@jonatack oops. Fixed. Thanks!",
      "created_at" : "2020-07-30T08:23:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#issuecomment-666221786",
      "id" : 666221786,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19607",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2NjIyMTc4Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-30T08:23:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/666221786",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462894529"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462894529"
         }
      },
      "author_association" : "MEMBER",
      "body" : "337528b ISTM this type is an `int64_t` defined in net.h; should we initialize a default here for safety, like for the other members `m_misbehavior_score{0}` and `m_should_discourage{false}` added in 36ac41a  (edit: similar to net.h:L415 `std::atomic<NodeId> nLastNodeId{0};`)",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-07-30T10:12:07Z",
      "diff_hunk" : "@@ -468,6 +459,50 @@ static CNodeState *State(NodeId pnode) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     return &it->second;\n }\n \n+/**\n+ * Data structure for an individual peer. This struct is not protected by\n+ * cs_main since it does not contain validation-critical data.\n+ *\n+ * Memory is owned by shared pointers and this object is destructed when\n+ * the refcount drops to zero.\n+ *\n+ * TODO: move most members from CNodeState to this structure.\n+ * TODO: move remaining application-layer data members from CNode to this structure.\n+ */\n+struct Peer {\n+    /** Same id as the CNode object for this peer */\n+    const NodeId m_id;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462894529",
      "id" : 462894529,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg5NDUyOQ==",
      "original_commit_id" : "afe3604f5e1a7eae5c38543147f55900569c9908",
      "original_line" : 474,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 458267788,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462894529",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462897076"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462897076"
         }
      },
      "author_association" : "MEMBER",
      "body" : "36ac41a seems safer to initialize `misbehavior` with a value, even if set ATM a few lines further down",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-07-30T10:16:54Z",
      "diff_hunk" : "@@ -867,6 +907,13 @@ void PeerLogicValidation::ReattemptInitialBroadcast(CScheduler& scheduler) const\n }\n \n void PeerLogicValidation::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTime) {\n+    int misbehavior;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462897076",
      "id" : 462897076,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg5NzA3Ng==",
      "original_commit_id" : "afe3604f5e1a7eae5c38543147f55900569c9908",
      "original_line" : 910,
      "original_position" : 98,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 458267788,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462897076",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462899594"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462899594"
         }
      },
      "author_association" : "MEMBER",
      "body" : "36ac41a should we add an `if (peer == nullptr) return false;` check here as well",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-07-30T10:22:02Z",
      "diff_hunk" : "@@ -867,6 +907,13 @@ void PeerLogicValidation::ReattemptInitialBroadcast(CScheduler& scheduler) const\n }\n \n void PeerLogicValidation::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTime) {\n+    int misbehavior;\n+    {\n+        PeerRef peer = GetPeerRef(nodeid);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462899594",
      "id" : 462899594,
      "line" : 913,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg5OTU5NA==",
      "original_commit_id" : "afe3604f5e1a7eae5c38543147f55900569c9908",
      "original_line" : 913,
      "original_position" : 100,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 100,
      "pull_request_review_id" : 458267788,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462899594",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462902684"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462902684"
         }
      },
      "author_association" : "MEMBER",
      "body" : "36ac41a\r\n\r\n- perhaps this line inside the inner block (beginning with the following line), like the three cases above\r\n\r\n- should we add an `if (peer == nullptr) return false;` check here as well?",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-07-30T10:28:09Z",
      "diff_hunk" : "@@ -3720,15 +3754,15 @@ void ProcessMessage(\n bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\n {\n     const NodeId peer_id{pnode.GetId()};\n+    PeerRef peer = GetPeerRef(peer_id);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462902684",
      "id" : 462902684,
      "line" : 3805,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkwMjY4NA==",
      "original_commit_id" : "afe3604f5e1a7eae5c38543147f55900569c9908",
      "original_line" : 3805,
      "original_position" : 311,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 310,
      "pull_request_review_id" : 458267788,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462902684",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462904094"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462904094"
         }
      },
      "author_association" : "MEMBER",
      "body" : "337528b not sure here, `s/insert/emplace/` to construct rather than copy?",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-07-30T10:30:57Z",
      "diff_hunk" : "@@ -840,7 +875,12 @@ void PeerLogicValidation::InitializeNode(CNode *pnode) {\n     NodeId nodeid = pnode->GetId();\n     {\n         LOCK(cs_main);\n-        mapNodeState.emplace_hint(mapNodeState.end(), std::piecewise_construct, std::forward_as_tuple(nodeid), std::forward_as_tuple(addr, std::move(addrName), pnode->fInbound, pnode->m_manual_connection));\n+        mapNodeState.emplace_hint(mapNodeState.end(), std::piecewise_construct, std::forward_as_tuple(nodeid), std::forward_as_tuple(addr, pnode->fInbound, pnode->m_manual_connection));\n+    }\n+    {\n+        PeerRef peer = std::make_shared<Peer>(nodeid);\n+        LOCK(g_peer_mutex);\n+        g_peer_map.insert(std::make_pair(nodeid, std::move(peer)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462904094",
      "id" : 462904094,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkwNDA5NA==",
      "original_commit_id" : "afe3604f5e1a7eae5c38543147f55900569c9908",
      "original_line" : 883,
      "original_position" : 90,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 458267788,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462904094",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462924953"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462924953"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Sure. This gets set in the initializer list of the only ctor, but there's no harm in adding this.",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-07-30T11:15:00Z",
      "diff_hunk" : "@@ -468,6 +459,50 @@ static CNodeState *State(NodeId pnode) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     return &it->second;\n }\n \n+/**\n+ * Data structure for an individual peer. This struct is not protected by\n+ * cs_main since it does not contain validation-critical data.\n+ *\n+ * Memory is owned by shared pointers and this object is destructed when\n+ * the refcount drops to zero.\n+ *\n+ * TODO: move most members from CNodeState to this structure.\n+ * TODO: move remaining application-layer data members from CNode to this structure.\n+ */\n+struct Peer {\n+    /** Same id as the CNode object for this peer */\n+    const NodeId m_id;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462924953",
      "id" : 462924953,
      "in_reply_to_id" : 462894529,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkyNDk1Mw==",
      "original_commit_id" : "afe3604f5e1a7eae5c38543147f55900569c9908",
      "original_line" : 474,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 458305938,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462924953",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462928140"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462928140"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ok, I've changed this to `emplace_hint` since the new peers are always added to the end of the map (same as for CNodeStates in mapNodeState)",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-07-30T11:21:58Z",
      "diff_hunk" : "@@ -840,7 +875,12 @@ void PeerLogicValidation::InitializeNode(CNode *pnode) {\n     NodeId nodeid = pnode->GetId();\n     {\n         LOCK(cs_main);\n-        mapNodeState.emplace_hint(mapNodeState.end(), std::piecewise_construct, std::forward_as_tuple(nodeid), std::forward_as_tuple(addr, std::move(addrName), pnode->fInbound, pnode->m_manual_connection));\n+        mapNodeState.emplace_hint(mapNodeState.end(), std::piecewise_construct, std::forward_as_tuple(nodeid), std::forward_as_tuple(addr, pnode->fInbound, pnode->m_manual_connection));\n+    }\n+    {\n+        PeerRef peer = std::make_shared<Peer>(nodeid);\n+        LOCK(g_peer_mutex);\n+        g_peer_map.insert(std::make_pair(nodeid, std::move(peer)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462928140",
      "id" : 462928140,
      "in_reply_to_id" : 462904094,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkyODE0MA==",
      "original_commit_id" : "afe3604f5e1a7eae5c38543147f55900569c9908",
      "original_line" : 883,
      "original_position" : 90,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 458305938,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462928140",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462930470"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462930470"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ok. Done.",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-07-30T11:26:47Z",
      "diff_hunk" : "@@ -867,6 +907,13 @@ void PeerLogicValidation::ReattemptInitialBroadcast(CScheduler& scheduler) const\n }\n \n void PeerLogicValidation::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTime) {\n+    int misbehavior;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462930470",
      "id" : 462930470,
      "in_reply_to_id" : 462897076,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkzMDQ3MA==",
      "original_commit_id" : "afe3604f5e1a7eae5c38543147f55900569c9908",
      "original_line" : 910,
      "original_position" : 98,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 458305938,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462930470",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462930737"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462930737"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've added an assert, like for CNodeState. The Peer object should always exist when we try to remove the peer.",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-07-30T11:27:20Z",
      "diff_hunk" : "@@ -867,6 +907,13 @@ void PeerLogicValidation::ReattemptInitialBroadcast(CScheduler& scheduler) const\n }\n \n void PeerLogicValidation::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTime) {\n+    int misbehavior;\n+    {\n+        PeerRef peer = GetPeerRef(nodeid);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462930737",
      "id" : 462930737,
      "in_reply_to_id" : 462899594,
      "line" : 913,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkzMDczNw==",
      "original_commit_id" : "afe3604f5e1a7eae5c38543147f55900569c9908",
      "original_line" : 913,
      "original_position" : 100,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 100,
      "pull_request_review_id" : 458313085,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462930737",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462931580"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462931580"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It is impossible to not initialize a const member, so I'd prefer to keep it as is, but not strong opinion",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-07-30T11:29:04Z",
      "diff_hunk" : "@@ -468,6 +459,50 @@ static CNodeState *State(NodeId pnode) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     return &it->second;\n }\n \n+/**\n+ * Data structure for an individual peer. This struct is not protected by\n+ * cs_main since it does not contain validation-critical data.\n+ *\n+ * Memory is owned by shared pointers and this object is destructed when\n+ * the refcount drops to zero.\n+ *\n+ * TODO: move most members from CNodeState to this structure.\n+ * TODO: move remaining application-layer data members from CNode to this structure.\n+ */\n+struct Peer {\n+    /** Same id as the CNode object for this peer */\n+    const NodeId m_id;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462931580",
      "id" : 462931580,
      "in_reply_to_id" : 462894529,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkzMTU4MA==",
      "original_commit_id" : "afe3604f5e1a7eae5c38543147f55900569c9908",
      "original_line" : 474,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 458314162,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462931580",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462932043"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462932043"
         }
      },
      "author_association" : "MEMBER",
      "body" : "A reference to the node exists (`CNode& pnode`) so it should be impossible for the peer ref to be deleted already",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-07-30T11:30:01Z",
      "diff_hunk" : "@@ -3720,15 +3754,15 @@ void ProcessMessage(\n bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\n {\n     const NodeId peer_id{pnode.GetId()};\n+    PeerRef peer = GetPeerRef(peer_id);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462932043",
      "id" : 462932043,
      "in_reply_to_id" : 462902684,
      "line" : 3805,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkzMjA0Mw==",
      "original_commit_id" : "afe3604f5e1a7eae5c38543147f55900569c9908",
      "original_line" : 3805,
      "original_position" : 311,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 310,
      "pull_request_review_id" : 458314730,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462932043",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462932478"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462932478"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ah! Thank you!",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-07-30T11:30:56Z",
      "diff_hunk" : "@@ -424,9 +422,8 @@ struct CNodeState {\n     //! Whether this peer relays txs via wtxid\n     bool m_wtxid_relay{false};\n \n-    CNodeState(CAddress addrIn, std::string addrNameIn, bool is_inbound, bool is_manual) :\n-        address(addrIn), name(std::move(addrNameIn)), m_is_inbound(is_inbound),\n-        m_is_manual_connection (is_manual)\n+    CNodeState(CAddress addrIn, bool is_inbound, bool is_manual) :\n+        address(addrIn), m_is_inbound(is_inbound), m_is_manual_connection (is_manual)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462932478",
      "id" : 462932478,
      "in_reply_to_id" : 462813973,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkzMjQ3OA==",
      "original_commit_id" : "730ad2ee4026ab47daf6c35e8dd4d5a665a5442e",
      "original_line" : 426,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 458315273,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462932478",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462934690"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462934690"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> perhaps this line inside the block like the three cases above\r\n\r\nI don't think this is required. The block is to limit the scope of the lock. Putting the `peer` variable in there is fine, but I don't think it's consistent with project style.\r\n\r\nThe block in `GetNodeStateStats()` was left over from a previous iteration of this branch. I've removed it. The block in `FinalizeNode()` is to force the `PeerRef` object to go out of scope, which will generally cause the underlying `Peer` object to be destructed, since that's usually the last reference.\r\n\r\n> should we add an if (peer == nullptr) return false; check here as well?\r\n\r\nYes we should. Thank you!",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-07-30T11:35:47Z",
      "diff_hunk" : "@@ -3720,15 +3754,15 @@ void ProcessMessage(\n bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\n {\n     const NodeId peer_id{pnode.GetId()};\n+    PeerRef peer = GetPeerRef(peer_id);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462934690",
      "id" : 462934690,
      "in_reply_to_id" : 462902684,
      "line" : 3805,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkzNDY5MA==",
      "original_commit_id" : "afe3604f5e1a7eae5c38543147f55900569c9908",
      "original_line" : 3805,
      "original_position" : 311,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 310,
      "pull_request_review_id" : 458318048,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462934690",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review @jonatack and @MarcoFalke . All your latest review comments are addressed.",
      "created_at" : "2020-07-30T11:41:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#issuecomment-666315046",
      "id" : 666315046,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19607",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2NjMxNTA0Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-30T11:41:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/666315046",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "reACK 951093884be4b6e48d2850dfc667c298f85afe9c",
      "created_at" : "2020-07-30T12:11:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#issuecomment-666327255",
      "id" : 666327255,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19607",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2NjMyNzI1NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-30T12:11:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/666327255",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462962065"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462962065"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Interesting, TIL thanks, and there were only two `emplace_hint` statements in the codebase, one of which is in the same function. From https://en.cppreference.com/w/cpp/container/map/emplace_hint it looks like a good choice for lower complexity and better perf in this case. ",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-07-30T12:32:15Z",
      "diff_hunk" : "@@ -840,7 +875,12 @@ void PeerLogicValidation::InitializeNode(CNode *pnode) {\n     NodeId nodeid = pnode->GetId();\n     {\n         LOCK(cs_main);\n-        mapNodeState.emplace_hint(mapNodeState.end(), std::piecewise_construct, std::forward_as_tuple(nodeid), std::forward_as_tuple(addr, std::move(addrName), pnode->fInbound, pnode->m_manual_connection));\n+        mapNodeState.emplace_hint(mapNodeState.end(), std::piecewise_construct, std::forward_as_tuple(nodeid), std::forward_as_tuple(addr, pnode->fInbound, pnode->m_manual_connection));\n+    }\n+    {\n+        PeerRef peer = std::make_shared<Peer>(nodeid);\n+        LOCK(g_peer_mutex);\n+        g_peer_map.insert(std::make_pair(nodeid, std::move(peer)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462962065",
      "id" : 462962065,
      "in_reply_to_id" : 462904094,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk2MjA2NQ==",
      "original_commit_id" : "afe3604f5e1a7eae5c38543147f55900569c9908",
      "original_line" : 883,
      "original_position" : 90,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 458354198,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462962065",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Code review ACK 8e35bf59062b3a823182588e0bf809b3367c2be0\r\n~~951093884be4b6e48d2850dfc667c298f85afe9c~~\r\n\r\n@theuni As you made the `CNode` and `CNodeState` separation originally can you take a look here please.",
      "created_at" : "2020-07-30T14:49:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#issuecomment-666418841",
      "id" : 666418841,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19607",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2NjQxODg0MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-28T18:29:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/666418841",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "re-ACK 951093884be4b6e48d2850dfc667c298f85afe9c per `git diff afe3604 9510938`",
      "created_at" : "2020-07-30T15:23:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#issuecomment-666452034",
      "id" : 666452034,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19607",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2NjQ1MjAzNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-30T15:23:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/666452034",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Code review ACK 951093884be4b6e48d2850dfc667c298f85afe9c\r\n\r\nStill testing a bit but everything looks good!",
      "created_at" : "2020-07-30T19:46:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#issuecomment-666643073",
      "id" : 666643073,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19607",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2NjY0MzA3Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-30T19:46:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/666643073",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Note for maintainers: please don't merge this yet. It has 4 ACKs, but going down this path is quite an important design decision. I'd like @theuni, @sipa or @sdaftuar to weight in before we move forward.",
      "created_at" : "2020-07-30T20:04:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#issuecomment-666655471",
      "id" : 666655471,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19607",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2NjY1NTQ3MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-30T20:04:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/666655471",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r463328886"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/463328886"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Have you considered std::atomic ? It has API to read/add atomically and it might there fit as we don't control flow on union of both values. I guess it's a bit faster than library mutex, but surely not worthy the complexity, maybe for next moved values.",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-07-30T23:38:46Z",
      "diff_hunk" : "@@ -479,6 +473,13 @@ struct Peer {\n     /** Same id as the CNode object for this peer */\n     const NodeId m_id{0};\n \n+    /** Protects misbehavior data members */\n+    Mutex m_misbehavior_mutex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r463328886",
      "id" : 463328886,
      "line" : 483,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMyODg4Ng==",
      "original_commit_id" : "cdba96b9fc47cf03c6fb29f908d0dc1a03ff3965",
      "original_line" : 483,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 48,
      "pull_request_review_id" : 458832474,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/463328886",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r463329398"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/463329398"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Banned or discouraged ? I thought we banned the former to avoid people being discouraged to understand this logic.",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-07-30T23:40:22Z",
      "diff_hunk" : "@@ -479,6 +473,13 @@ struct Peer {\n     /** Same id as the CNode object for this peer */\n     const NodeId m_id{0};\n \n+    /** Protects misbehavior data members */\n+    Mutex m_misbehavior_mutex;\n+    /** Accumulated misbehavior score for this peer */\n+    int nMisbehavior GUARDED_BY(m_misbehavior_mutex){0};\n+    /** Whether this peer should be disconnected and banned (unless it has the noban permission) */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r463329398",
      "id" : 463329398,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMyOTM5OA==",
      "original_commit_id" : "cdba96b9fc47cf03c6fb29f908d0dc1a03ff3965",
      "original_line" : 480,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 458832474,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/463329398",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r466560976"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466560976"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think it's easier to reason about having both misbehavior fields (`m_misbehavior_score` and `m_should_discourage`) under the same mutex since they're so closely related.",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-08-06T17:12:08Z",
      "diff_hunk" : "@@ -479,6 +473,13 @@ struct Peer {\n     /** Same id as the CNode object for this peer */\n     const NodeId m_id{0};\n \n+    /** Protects misbehavior data members */\n+    Mutex m_misbehavior_mutex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r466560976",
      "id" : 466560976,
      "in_reply_to_id" : 463328886,
      "line" : 483,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU2MDk3Ng==",
      "original_commit_id" : "cdba96b9fc47cf03c6fb29f908d0dc1a03ff3965",
      "original_line" : 483,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 48,
      "pull_request_review_id" : 462713866,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466560976",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r466562495"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466562495"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks. This was a bad rebase. Now fixed.",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-08-06T17:14:58Z",
      "diff_hunk" : "@@ -479,6 +473,13 @@ struct Peer {\n     /** Same id as the CNode object for this peer */\n     const NodeId m_id{0};\n \n+    /** Protects misbehavior data members */\n+    Mutex m_misbehavior_mutex;\n+    /** Accumulated misbehavior score for this peer */\n+    int nMisbehavior GUARDED_BY(m_misbehavior_mutex){0};\n+    /** Whether this peer should be disconnected and banned (unless it has the noban permission) */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r466562495",
      "id" : 466562495,
      "in_reply_to_id" : 463329398,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU2MjQ5NQ==",
      "original_commit_id" : "cdba96b9fc47cf03c6fb29f908d0dc1a03ff3965",
      "original_line" : 480,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 462719141,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466562495",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r466608735"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466608735"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think that if you agree it makes sense to put it in PLV, then now is probably the best time to do it, unless there's something that would break if you did?  In which case I'd say deferring until we do a bigger PLV cleanup would make sense too.",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-08-06T18:33:47Z",
      "diff_hunk" : "@@ -468,6 +468,44 @@ static CNodeState *State(NodeId pnode) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     return &it->second;\n }\n \n+/**\n+ * Data stucture for an individual peer. This struct is not protected by\n+ * cs_main since it does not contain validation-critical data.\n+ *\n+ * Memory is owned by shared pointers and this object is destructed when\n+ * the refcount drops to zero (in FinalizeNode()).\n+ *\n+ * TODO: move most members from CNodeState to this structure.\n+ * TODO: move remaining application-layer data members from CNode to this structure.\n+ */\n+struct Peer {\n+    /** Same id as the CNode object for this peer */\n+    NodeId m_id;\n+\n+    Peer(NodeId id) : m_id(id) {}\n+};\n+\n+using PeerRef = std::shared_ptr<Peer>;\n+\n+/**\n+ * Map of all Peer objects, keyed by peer id. This map is protected\n+ * by the global g_peer_mutex. Once a shared pointer reference is\n+ * taken, the lock may be released. Individual fields are protected by\n+ * their own locks.\n+ */\n+Mutex g_peer_mutex;\n+static std::map<NodeId, PeerRef> g_peer_map GUARDED_BY(g_peer_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r466608735",
      "id" : 466608735,
      "in_reply_to_id" : 462032894,
      "line" : 501,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwODczNQ==",
      "original_commit_id" : "d60a16bb3f58fcb9422c277256b3c3a31cab3b2f",
      "original_line" : 501,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 66,
      "pull_request_review_id" : 462777422,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466608735",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r466611577"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466611577"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I wonder if the `~CNetProcessing` destructor should be cleaning up this global map, if this isn't moved into PLV?  It looks like we don't clean up `mapNodeState` there, but that seems like an oversight -- unless there's some good reason I'm missing?",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-08-06T18:39:06Z",
      "diff_hunk" : "@@ -468,6 +468,44 @@ static CNodeState *State(NodeId pnode) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     return &it->second;\n }\n \n+/**\n+ * Data stucture for an individual peer. This struct is not protected by\n+ * cs_main since it does not contain validation-critical data.\n+ *\n+ * Memory is owned by shared pointers and this object is destructed when\n+ * the refcount drops to zero (in FinalizeNode()).\n+ *\n+ * TODO: move most members from CNodeState to this structure.\n+ * TODO: move remaining application-layer data members from CNode to this structure.\n+ */\n+struct Peer {\n+    /** Same id as the CNode object for this peer */\n+    NodeId m_id;\n+\n+    Peer(NodeId id) : m_id(id) {}\n+};\n+\n+using PeerRef = std::shared_ptr<Peer>;\n+\n+/**\n+ * Map of all Peer objects, keyed by peer id. This map is protected\n+ * by the global g_peer_mutex. Once a shared pointer reference is\n+ * taken, the lock may be released. Individual fields are protected by\n+ * their own locks.\n+ */\n+Mutex g_peer_mutex;\n+static std::map<NodeId, PeerRef> g_peer_map GUARDED_BY(g_peer_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r466611577",
      "id" : 466611577,
      "in_reply_to_id" : 462032894,
      "line" : 501,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYxMTU3Nw==",
      "original_commit_id" : "d60a16bb3f58fcb9422c277256b3c3a31cab3b2f",
      "original_line" : 501,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 66,
      "pull_request_review_id" : 462777422,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466611577",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r466617186"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466617186"
         }
      },
      "author_association" : "MEMBER",
      "body" : "So even apart from not using `cs_main`, there's another design change happening here in how we use these objects, when compared with `CNodeState` -- no lock on the map is maintained in order to have a shared_ptr to the peer object.\r\n\r\nThat means that our code needs to be able to handle having the entry in the map erased out from under it, correct?  That might be worth mentioning somewhere as a design consideration for future code.",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-08-06T18:49:46Z",
      "diff_hunk" : "@@ -465,6 +465,43 @@ static CNodeState *State(NodeId pnode) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     return &it->second;\n }\n \n+/**\n+ * Data structure for an individual peer. This struct is not protected by\n+ * cs_main since it does not contain validation-critical data.\n+ *\n+ * Memory is owned by shared pointers and this object is destructed when\n+ * the refcount drops to zero.\n+ *\n+ * TODO: move most members from CNodeState to this structure.\n+ * TODO: move remaining application-layer data members from CNode to this structure.\n+ */\n+struct Peer {\n+    /** Same id as the CNode object for this peer */\n+    const NodeId m_id{0};\n+\n+    Peer(NodeId id) : m_id(id) {}\n+};\n+\n+using PeerRef = std::shared_ptr<Peer>;\n+\n+/**\n+ * Map of all Peer objects, keyed by peer id. This map is protected\n+ * by the global g_peer_mutex. Once a shared pointer reference is\n+ * taken, the lock may be released. Individual fields are protected by\n+ * their own locks.\n+ */\n+Mutex g_peer_mutex;\n+static std::map<NodeId, PeerRef> g_peer_map GUARDED_BY(g_peer_mutex);\n+\n+/** Get a shared pointer to the Peer object.\n+ *  May return nullptr if the Peer object can't be found. */\n+static PeerRef GetPeerRef(NodeId id)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r466617186",
      "id" : 466617186,
      "line" : 505,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYxNzE4Ng==",
      "original_commit_id" : "28837a0a2d711515e77bea5d3080b4793d703c55",
      "original_line" : 505,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 70,
      "pull_request_review_id" : 462777422,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466617186",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r466618266"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466618266"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ACK spelling change",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-08-06T18:51:47Z",
      "diff_hunk" : "@@ -479,6 +473,13 @@ struct Peer {\n     /** Same id as the CNode object for this peer */\n     const NodeId m_id{0};\n \n+    /** Protects misbehavior data members */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r466618266",
      "id" : 466618266,
      "line" : 482,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYxODI2Ng==",
      "original_commit_id" : "c45a56d2fb8415c6322ad7632c72e0c264d28df6",
      "original_line" : 482,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 47,
      "pull_request_review_id" : 462777422,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466618266",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r466620612"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466620612"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is a mouthful; would it be reasonable to add accessor functions to the `Peer` class that handle the lock acquisitions themselves?",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-08-06T18:56:05Z",
      "diff_hunk" : "@@ -906,7 +907,11 @@ void PeerLogicValidation::ReattemptInitialBroadcast(CScheduler& scheduler) const\n }\n \n void PeerLogicValidation::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTime) {\n+    int misbehavior{0};\n     {\n+        PeerRef peer = GetPeerRef(nodeid);\n+        assert(peer != nullptr);\n+        misbehavior = WITH_LOCK(peer->m_misbehavior_mutex, return peer->nMisbehavior);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r466620612",
      "id" : 466620612,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYyMDYxMg==",
      "original_commit_id" : "c45a56d2fb8415c6322ad7632c72e0c264d28df6",
      "original_line" : 914,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 462777422,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466620612",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r466673202"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466673202"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If I can get buy-in here from everyone else to move a bunch of the static functions from net_processing into PLV, then I'm very happy to move `g_peer_map` into PLV and move those functions as needed in future PRs.",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-08-06T20:39:33Z",
      "diff_hunk" : "@@ -468,6 +468,44 @@ static CNodeState *State(NodeId pnode) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     return &it->second;\n }\n \n+/**\n+ * Data stucture for an individual peer. This struct is not protected by\n+ * cs_main since it does not contain validation-critical data.\n+ *\n+ * Memory is owned by shared pointers and this object is destructed when\n+ * the refcount drops to zero (in FinalizeNode()).\n+ *\n+ * TODO: move most members from CNodeState to this structure.\n+ * TODO: move remaining application-layer data members from CNode to this structure.\n+ */\n+struct Peer {\n+    /** Same id as the CNode object for this peer */\n+    NodeId m_id;\n+\n+    Peer(NodeId id) : m_id(id) {}\n+};\n+\n+using PeerRef = std::shared_ptr<Peer>;\n+\n+/**\n+ * Map of all Peer objects, keyed by peer id. This map is protected\n+ * by the global g_peer_mutex. Once a shared pointer reference is\n+ * taken, the lock may be released. Individual fields are protected by\n+ * their own locks.\n+ */\n+Mutex g_peer_mutex;\n+static std::map<NodeId, PeerRef> g_peer_map GUARDED_BY(g_peer_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r466673202",
      "id" : 466673202,
      "in_reply_to_id" : 462032894,
      "line" : 501,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY3MzIwMg==",
      "original_commit_id" : "d60a16bb3f58fcb9422c277256b3c3a31cab3b2f",
      "original_line" : 501,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 66,
      "pull_request_review_id" : 462860157,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466673202",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r466673988"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466673988"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, that's possible. Do you think the comment on the map needs expanding? It currently says \"Once a shared pointer reference is taken, the lock may be released. Individual fields are protected by their own locks.\"",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-08-06T20:41:11Z",
      "diff_hunk" : "@@ -465,6 +465,43 @@ static CNodeState *State(NodeId pnode) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     return &it->second;\n }\n \n+/**\n+ * Data structure for an individual peer. This struct is not protected by\n+ * cs_main since it does not contain validation-critical data.\n+ *\n+ * Memory is owned by shared pointers and this object is destructed when\n+ * the refcount drops to zero.\n+ *\n+ * TODO: move most members from CNodeState to this structure.\n+ * TODO: move remaining application-layer data members from CNode to this structure.\n+ */\n+struct Peer {\n+    /** Same id as the CNode object for this peer */\n+    const NodeId m_id{0};\n+\n+    Peer(NodeId id) : m_id(id) {}\n+};\n+\n+using PeerRef = std::shared_ptr<Peer>;\n+\n+/**\n+ * Map of all Peer objects, keyed by peer id. This map is protected\n+ * by the global g_peer_mutex. Once a shared pointer reference is\n+ * taken, the lock may be released. Individual fields are protected by\n+ * their own locks.\n+ */\n+Mutex g_peer_mutex;\n+static std::map<NodeId, PeerRef> g_peer_map GUARDED_BY(g_peer_mutex);\n+\n+/** Get a shared pointer to the Peer object.\n+ *  May return nullptr if the Peer object can't be found. */\n+static PeerRef GetPeerRef(NodeId id)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r466673988",
      "id" : 466673988,
      "in_reply_to_id" : 466617186,
      "line" : 505,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY3Mzk4OA==",
      "original_commit_id" : "28837a0a2d711515e77bea5d3080b4793d703c55",
      "original_line" : 505,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 70,
      "pull_request_review_id" : 462861170,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466673988",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review @sdaftuar!\r\n\r\n> I'm not strongly wedded to the design decisions here though, it's not obvious to me that going down this road of having fine-grain, per-peer locks really adds anything, compared to (say) having just one lock for a whole Peer object (which maybe is even held the whole time you're using it, for simplicity).\r\n\r\nI'm not strongly wedded to it either. My reason for doing it this way is that it most closely reflects the locking design in CNode, so the future PRs that move the remaining data to Peer should be easier to review. Once they're all in Peer, moving from fine-grained mutexes to coarser-grained mutexes should also be an easy change if it's desired, but moving the other way requires a bit more thought. So in summary: this is easier and leaves more flexibility later.",
      "created_at" : "2020-08-06T20:49:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#issuecomment-670185002",
      "id" : 670185002,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19607",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3MDE4NTAwMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-06T20:49:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/670185002",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r466678546"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466678546"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ðºð¸ ",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-08-06T20:50:15Z",
      "diff_hunk" : "@@ -479,6 +473,13 @@ struct Peer {\n     /** Same id as the CNode object for this peer */\n     const NodeId m_id{0};\n \n+    /** Protects misbehavior data members */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r466678546",
      "id" : 466678546,
      "in_reply_to_id" : 466618266,
      "line" : 482,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY3ODU0Ng==",
      "original_commit_id" : "c45a56d2fb8415c6322ad7632c72e0c264d28df6",
      "original_line" : 482,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 47,
      "pull_request_review_id" : 462866978,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466678546",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r466682760"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466682760"
         }
      },
      "author_association" : "MEMBER",
      "body" : "For functions that access multiple fields under the same lock, we'll need to hold the lock externally to the struct anyway (see `Misbehaving()` for example, which accesses both `m_misbehavior_score` and `m_should_discourage` while holding `m_misbehavior_score`). So I could add setters/getters which handle the locking, but the locks would still need to be public and it wouldn't help with encapsulating `Peer`.\r\n\r\nI like that `Peer` is a struct with all public members and no internal logic, and I also think the `WITH_LOCK` macro is pretty nifty so don't mind this pattern. If others also have a strong distaste for the WITH_LOCK pattern, I can look at adding getter methods.",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-08-06T20:58:49Z",
      "diff_hunk" : "@@ -906,7 +907,11 @@ void PeerLogicValidation::ReattemptInitialBroadcast(CScheduler& scheduler) const\n }\n \n void PeerLogicValidation::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTime) {\n+    int misbehavior{0};\n     {\n+        PeerRef peer = GetPeerRef(nodeid);\n+        assert(peer != nullptr);\n+        misbehavior = WITH_LOCK(peer->m_misbehavior_mutex, return peer->nMisbehavior);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r466682760",
      "id" : 466682760,
      "in_reply_to_id" : 466620612,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY4Mjc2MA==",
      "original_commit_id" : "c45a56d2fb8415c6322ad7632c72e0c264d28df6",
      "original_line" : 914,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 462872291,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466682760",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r466712303"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466712303"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm fond of WITH_LOCK.  Especially if we're going the way of many individual locks, it's much quicker this way to see what's locking what.\r\n\r\nThis does give me flashbacks to Java though... `Button button = new Button(\"button\");`",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-08-06T22:08:05Z",
      "diff_hunk" : "@@ -906,7 +907,11 @@ void PeerLogicValidation::ReattemptInitialBroadcast(CScheduler& scheduler) const\n }\n \n void PeerLogicValidation::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTime) {\n+    int misbehavior{0};\n     {\n+        PeerRef peer = GetPeerRef(nodeid);\n+        assert(peer != nullptr);\n+        misbehavior = WITH_LOCK(peer->m_misbehavior_mutex, return peer->nMisbehavior);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r466712303",
      "id" : 466712303,
      "in_reply_to_id" : 466620612,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjcxMjMwMw==",
      "original_commit_id" : "c45a56d2fb8415c6322ad7632c72e0c264d28df6",
      "original_line" : 914,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 462909153,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466712303",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r467062266"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/467062266"
         }
      },
      "author_association" : "MEMBER",
      "body" : "+1 on this. No preference whether it happens here or in a follow-up, but I agree PLV is a better home.",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-08-07T14:05:42Z",
      "diff_hunk" : "@@ -468,6 +468,44 @@ static CNodeState *State(NodeId pnode) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     return &it->second;\n }\n \n+/**\n+ * Data stucture for an individual peer. This struct is not protected by\n+ * cs_main since it does not contain validation-critical data.\n+ *\n+ * Memory is owned by shared pointers and this object is destructed when\n+ * the refcount drops to zero (in FinalizeNode()).\n+ *\n+ * TODO: move most members from CNodeState to this structure.\n+ * TODO: move remaining application-layer data members from CNode to this structure.\n+ */\n+struct Peer {\n+    /** Same id as the CNode object for this peer */\n+    NodeId m_id;\n+\n+    Peer(NodeId id) : m_id(id) {}\n+};\n+\n+using PeerRef = std::shared_ptr<Peer>;\n+\n+/**\n+ * Map of all Peer objects, keyed by peer id. This map is protected\n+ * by the global g_peer_mutex. Once a shared pointer reference is\n+ * taken, the lock may be released. Individual fields are protected by\n+ * their own locks.\n+ */\n+Mutex g_peer_mutex;\n+static std::map<NodeId, PeerRef> g_peer_map GUARDED_BY(g_peer_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r467062266",
      "id" : 467062266,
      "in_reply_to_id" : 462032894,
      "line" : 501,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA2MjI2Ng==",
      "original_commit_id" : "d60a16bb3f58fcb9422c277256b3c3a31cab3b2f",
      "original_line" : 501,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 66,
      "pull_request_review_id" : 463340526,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/467062266",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r467069263"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/467069263"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@sdaftuar This was my high-level feedback as well. I strongly prefer encapsulation as it's really really hard to screw up encapsulated locking, but it's a burden when multiple operations could otherwise be handled with a single lock. But as this work/PR is intended to break up locking that has grown unwieldy, I can see why @jnewbery went for this approach.\r\n\r\nAlso, just in terms of evolution of thinking... I have always preferred encapsulated locks because of the security guarantees. But I'm less against exposed mutexes these days due to our annotations and sanitizers.",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-08-07T14:17:13Z",
      "diff_hunk" : "@@ -906,7 +907,11 @@ void PeerLogicValidation::ReattemptInitialBroadcast(CScheduler& scheduler) const\n }\n \n void PeerLogicValidation::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTime) {\n+    int misbehavior{0};\n     {\n+        PeerRef peer = GetPeerRef(nodeid);\n+        assert(peer != nullptr);\n+        misbehavior = WITH_LOCK(peer->m_misbehavior_mutex, return peer->nMisbehavior);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r467069263",
      "id" : 467069263,
      "in_reply_to_id" : 466620612,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA2OTI2Mw==",
      "original_commit_id" : "c45a56d2fb8415c6322ad7632c72e0c264d28df6",
      "original_line" : 914,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 463340526,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/467069263",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r467071878"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/467071878"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is mostly a question for future stuff that gets moved in but... What if the refcount is more than 1 here? Do we continue tearing it down?\r\n\r\nAs a contrived (bad) example: what if someone bumps the misbehavior score after it's been evaluated here?",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-08-07T14:21:29Z",
      "diff_hunk" : "@@ -906,7 +907,11 @@ void PeerLogicValidation::ReattemptInitialBroadcast(CScheduler& scheduler) const\n }\n \n void PeerLogicValidation::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTime) {\n+    int misbehavior{0};\n     {\n+        PeerRef peer = GetPeerRef(nodeid);\n+        assert(peer != nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r467071878",
      "id" : 467071878,
      "line" : 914,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA3MTg3OA==",
      "original_commit_id" : "c45a56d2fb8415c6322ad7632c72e0c264d28df6",
      "original_line" : 914,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 101,
      "pull_request_review_id" : 463340526,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/467071878",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r467079107"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/467079107"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Should this and ```mapNodeState.erase(nodeid)``` happen at the same time, under the same cs_main lock?\r\n\r\nWhat are the consequences of them being out of sync? (Still reachable by ```State()``` but not by ```GetPeerRef()```)",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-08-07T14:33:00Z",
      "diff_hunk" : "@@ -864,6 +906,10 @@ void PeerLogicValidation::ReattemptInitialBroadcast(CScheduler& scheduler) const\n }\n \n void PeerLogicValidation::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTime) {\n+    {\n+        LOCK(g_peer_mutex);\n+        g_peer_map.erase(nodeid);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r467079107",
      "id" : 467079107,
      "line" : 917,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA3OTEwNw==",
      "original_commit_id" : "28837a0a2d711515e77bea5d3080b4793d703c55",
      "original_line" : 917,
      "original_position" : 62,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 104,
      "pull_request_review_id" : 463340526,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/467079107",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-08-12T02:42:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#issuecomment-672499649",
      "id" : 672499649,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19607",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3MjQ5OTY0OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-12T02:42:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/672499649",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r469139698"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469139698"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I started trying to do this, but it's an enormous change. `Misbehaving()` fetches the `PeerRef`, and `Misbehaving()` is called all over net_processing. Let's defer this change to its own PR (probably a series of PRs since it touches almost all of the functions in net_processing.",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-08-12T09:46:29Z",
      "diff_hunk" : "@@ -468,6 +468,44 @@ static CNodeState *State(NodeId pnode) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     return &it->second;\n }\n \n+/**\n+ * Data stucture for an individual peer. This struct is not protected by\n+ * cs_main since it does not contain validation-critical data.\n+ *\n+ * Memory is owned by shared pointers and this object is destructed when\n+ * the refcount drops to zero (in FinalizeNode()).\n+ *\n+ * TODO: move most members from CNodeState to this structure.\n+ * TODO: move remaining application-layer data members from CNode to this structure.\n+ */\n+struct Peer {\n+    /** Same id as the CNode object for this peer */\n+    NodeId m_id;\n+\n+    Peer(NodeId id) : m_id(id) {}\n+};\n+\n+using PeerRef = std::shared_ptr<Peer>;\n+\n+/**\n+ * Map of all Peer objects, keyed by peer id. This map is protected\n+ * by the global g_peer_mutex. Once a shared pointer reference is\n+ * taken, the lock may be released. Individual fields are protected by\n+ * their own locks.\n+ */\n+Mutex g_peer_mutex;\n+static std::map<NodeId, PeerRef> g_peer_map GUARDED_BY(g_peer_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r469139698",
      "id" : 469139698,
      "in_reply_to_id" : 462032894,
      "line" : 501,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTEzOTY5OA==",
      "original_commit_id" : "d60a16bb3f58fcb9422c277256b3c3a31cab3b2f",
      "original_line" : 501,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 66,
      "pull_request_review_id" : 465758635,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469139698",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r469143729"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469143729"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It seems like there are two different points here:\r\n\r\n- \"This is a mouthful\" (@sdaftuar) seems like a stylistic comment. I actually like the fact that the WITH_LOCK macro is explicit about the lock it's taking.\r\n- \"I strongly prefer encapsulation as it's really really hard to screw up encapsulated locking\" (@theuni) is a comment about locking design. Cory, correct me if I'm wrong, but I think your distaste here is informed by how cs_main has been (mis)used in the past, where it's locked the mutex for huge scopes unnecessarily. With lock annotations and fine-grained mutexes, I don't see a problem with exposing those mutexes outside the class/struct.",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-08-12T09:53:37Z",
      "diff_hunk" : "@@ -906,7 +907,11 @@ void PeerLogicValidation::ReattemptInitialBroadcast(CScheduler& scheduler) const\n }\n \n void PeerLogicValidation::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTime) {\n+    int misbehavior{0};\n     {\n+        PeerRef peer = GetPeerRef(nodeid);\n+        assert(peer != nullptr);\n+        misbehavior = WITH_LOCK(peer->m_misbehavior_mutex, return peer->nMisbehavior);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r469143729",
      "id" : 469143729,
      "in_reply_to_id" : 466620612,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTE0MzcyOQ==",
      "original_commit_id" : "c45a56d2fb8415c6322ad7632c72e0c264d28df6",
      "original_line" : 914,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 465763685,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469143729",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased (https://github.com/bitcoin/bitcoin/compare/8fe28ceb126dd3206f04f426aef8d067f538ec3f..3c56d2385e195d3de587df95f64ce97fc727b1a3)",
      "created_at" : "2020-08-12T09:54:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#issuecomment-672775226",
      "id" : 672775226,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19607",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3Mjc3NTIyNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-12T09:54:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/672775226",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r469150403"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469150403"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> I wonder if the ~CNetProcessing destructor should be cleaning up this global map, if this isn't moved into PLV? It looks like we don't clean up mapNodeState there, but that seems like an oversight -- unless there's some good reason I'm missing?\r\n\r\nAll nodes are cleaned up by `CConnman` during the Shutdown sequence (`Shutdown()` in init.cpp calls `CConnman.StopNodes()`, which calls `FinalizeNode()` for each node). When we come to destruct the `PeerLogicValidation` object both maps should already be empty.\r\n\r\nI could add a `PeerLogicValidation` dtor which asserts these maps are empty, but that seems a bit orthogonal to this PR (if we introduce a bug that means the nodes are finalized during shutdown, then they'll exist in both the CNodeState map and the Peer map.",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-08-12T10:06:00Z",
      "diff_hunk" : "@@ -468,6 +468,44 @@ static CNodeState *State(NodeId pnode) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     return &it->second;\n }\n \n+/**\n+ * Data stucture for an individual peer. This struct is not protected by\n+ * cs_main since it does not contain validation-critical data.\n+ *\n+ * Memory is owned by shared pointers and this object is destructed when\n+ * the refcount drops to zero (in FinalizeNode()).\n+ *\n+ * TODO: move most members from CNodeState to this structure.\n+ * TODO: move remaining application-layer data members from CNode to this structure.\n+ */\n+struct Peer {\n+    /** Same id as the CNode object for this peer */\n+    NodeId m_id;\n+\n+    Peer(NodeId id) : m_id(id) {}\n+};\n+\n+using PeerRef = std::shared_ptr<Peer>;\n+\n+/**\n+ * Map of all Peer objects, keyed by peer id. This map is protected\n+ * by the global g_peer_mutex. Once a shared pointer reference is\n+ * taken, the lock may be released. Individual fields are protected by\n+ * their own locks.\n+ */\n+Mutex g_peer_mutex;\n+static std::map<NodeId, PeerRef> g_peer_map GUARDED_BY(g_peer_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r469150403",
      "id" : 469150403,
      "in_reply_to_id" : 462032894,
      "line" : 501,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTE1MDQwMw==",
      "original_commit_id" : "d60a16bb3f58fcb9422c277256b3c3a31cab3b2f",
      "original_line" : 501,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 66,
      "pull_request_review_id" : 465772340,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469150403",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r469158507"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469158507"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We'll remove the `Peer` shared ptr from `g_peer_map`, but we don't destruct the object until the refcount drops to 0. Your contrived example is fine. There would have to be another thread currently in `Misbehaving()` holding a shared ptr to the `Peer` object. We'd remove it from the map, the other thread would increment the misbehaving score, and then the `Peer` object would be destructed when that thread left the `Misbehaving()` function.\r\n\r\nI've taken a look at the future commits in https://github.com/jnewbery/bitcoin/tree/2020-06-cs-main-split and I can't see any problems with this style of teardown.",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-08-12T10:21:42Z",
      "diff_hunk" : "@@ -906,7 +907,11 @@ void PeerLogicValidation::ReattemptInitialBroadcast(CScheduler& scheduler) const\n }\n \n void PeerLogicValidation::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTime) {\n+    int misbehavior{0};\n     {\n+        PeerRef peer = GetPeerRef(nodeid);\n+        assert(peer != nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r469158507",
      "id" : 469158507,
      "in_reply_to_id" : 467071878,
      "line" : 914,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTE1ODUwNw==",
      "original_commit_id" : "c45a56d2fb8415c6322ad7632c72e0c264d28df6",
      "original_line" : 914,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 101,
      "pull_request_review_id" : 465782571,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469158507",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r469161161"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469161161"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No bad consequences, but I've moved the Peer cleanup underneath the cs_main lock anyway to make this simpler to think about.",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-08-12T10:26:51Z",
      "diff_hunk" : "@@ -864,6 +906,10 @@ void PeerLogicValidation::ReattemptInitialBroadcast(CScheduler& scheduler) const\n }\n \n void PeerLogicValidation::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTime) {\n+    {\n+        LOCK(g_peer_mutex);\n+        g_peer_map.erase(nodeid);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r469161161",
      "id" : 469161161,
      "in_reply_to_id" : 467079107,
      "line" : 917,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTE2MTE2MQ==",
      "original_commit_id" : "28837a0a2d711515e77bea5d3080b4793d703c55",
      "original_line" : 917,
      "original_position" : 62,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 104,
      "pull_request_review_id" : 465785746,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T10:26:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469161161",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks everyone for review. I've rebased and addressed all comments from @sdaftuar and @theuni . This is ready for re-review.",
      "created_at" : "2020-08-12T10:27:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#issuecomment-672790288",
      "id" : 672790288,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19607",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3Mjc5MDI4OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-12T10:27:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/672790288",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r469261911"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469261911"
         }
      },
      "author_association" : "MEMBER",
      "body" : "My primary concern is that 5 years from now someone changes some code that interacts with a Peer and forgets to grab a lock. With encapsulated locking, that _can't_ happen.\r\n\r\nBut I'm now satisfied that even without the encapsulation, we have safeguards to prevent that.",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-08-12T13:32:37Z",
      "diff_hunk" : "@@ -906,7 +907,11 @@ void PeerLogicValidation::ReattemptInitialBroadcast(CScheduler& scheduler) const\n }\n \n void PeerLogicValidation::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTime) {\n+    int misbehavior{0};\n     {\n+        PeerRef peer = GetPeerRef(nodeid);\n+        assert(peer != nullptr);\n+        misbehavior = WITH_LOCK(peer->m_misbehavior_mutex, return peer->nMisbehavior);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r469261911",
      "id" : 469261911,
      "in_reply_to_id" : 466620612,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI2MTkxMQ==",
      "original_commit_id" : "c45a56d2fb8415c6322ad7632c72e0c264d28df6",
      "original_line" : 914,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 465919117,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-12T13:32:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469261911",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@troygiorshev @laanwj @fjahr @jonatack this PR is now rebased and updated to address @sdaftuar and @theuni review comments. Do you mind re-ACKing?",
      "created_at" : "2020-08-13T11:04:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#issuecomment-673412324",
      "id" : 673412324,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19607",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3MzQxMjMyNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-13T11:04:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/673412324",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "reACK 8e35bf59062b3a823182588e0bf809b3367c2be0 via `git range-diff master 9510938 8e35bf5`\r\n\r\nOnly minor changes.\r\n\r\nAnd, because I don't think I've seen it yet, ACK on the name of `g_peer_mutex`.  I like the `mutex` suffix better than the `cs` prefix, leaving the prefix open to only `g`, `m`, or nothing.",
      "created_at" : "2020-08-13T18:06:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#issuecomment-673629145",
      "id" : 673629145,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19607",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3MzYyOTE0NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-13T18:37:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/673629145",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r470173964"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/470173964"
         }
      },
      "author_association" : "MEMBER",
      "body" : "My point here was that calls to ```Misbehaving()``` might go unobserved, because the score may have already been evaluated before the other thread bumped it. This is not possible in with the current behavior because of cs_main: once we're in ```FinalizeNode```, we're guaranteed that no other thread is accessing it (unless they've cached the ```CNodeState*```, which would be a bug).\r\n\r\nObviously we don't have any threads doing that currently, so I'm wondering if we want to continue to enforce that invariant with a:\r\n```c++\r\n// This isn't a guarantee but it's close enough\r\nassert(peer.use_count() <= 1);\r\n```\r\n\r\nI'm not too bothered if there's a rare misbehaving bump that gets missed. My concern is that Peer's destructor may eventually gain some functionality, and we'll want to know if we need to keep track of which thread deletes it.\r\n\r\n\r\nEdit: Trying my point one more time. As I see it, this PR removes the guarantee that every call into ```Misbehaving()``` will be reflected upon evaluation in ```FinalizeNode()```. That's not a huge deal, but it should at least be noted in case more important guarantees are removed by future moves into Peer.",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-08-13T18:51:34Z",
      "diff_hunk" : "@@ -906,7 +907,11 @@ void PeerLogicValidation::ReattemptInitialBroadcast(CScheduler& scheduler) const\n }\n \n void PeerLogicValidation::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTime) {\n+    int misbehavior{0};\n     {\n+        PeerRef peer = GetPeerRef(nodeid);\n+        assert(peer != nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r470173964",
      "id" : 470173964,
      "in_reply_to_id" : 467071878,
      "line" : 914,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE3Mzk2NA==",
      "original_commit_id" : "c45a56d2fb8415c6322ad7632c72e0c264d28df6",
      "original_line" : 914,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 101,
      "pull_request_review_id" : 467041758,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-13T19:04:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/470173964",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.",
      "created_at" : "2020-08-15T14:57:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#issuecomment-674408122",
      "id" : 674408122,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19607",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3NDQwODEyMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-15T14:57:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/674408122",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r475771780"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/475771780"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@MarcoFalke @theuni @sdaftuar - I've made a branch that puts peer_map inside PeerLogicValidation here: https://github.com/jnewbery/bitcoin/tree/2020-08-peer-plv2. It builds on top of (merged) #19704 and (open) #19791. Let me know what you think. If that 19791 gets merged first, I'll switch this PR to use that branch. If not, I'm happy to do the follow-up work to move g_peer_map into PeerLogicValidation later.",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-08-24T17:18:52Z",
      "diff_hunk" : "@@ -468,6 +468,44 @@ static CNodeState *State(NodeId pnode) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     return &it->second;\n }\n \n+/**\n+ * Data stucture for an individual peer. This struct is not protected by\n+ * cs_main since it does not contain validation-critical data.\n+ *\n+ * Memory is owned by shared pointers and this object is destructed when\n+ * the refcount drops to zero (in FinalizeNode()).\n+ *\n+ * TODO: move most members from CNodeState to this structure.\n+ * TODO: move remaining application-layer data members from CNode to this structure.\n+ */\n+struct Peer {\n+    /** Same id as the CNode object for this peer */\n+    NodeId m_id;\n+\n+    Peer(NodeId id) : m_id(id) {}\n+};\n+\n+using PeerRef = std::shared_ptr<Peer>;\n+\n+/**\n+ * Map of all Peer objects, keyed by peer id. This map is protected\n+ * by the global g_peer_mutex. Once a shared pointer reference is\n+ * taken, the lock may be released. Individual fields are protected by\n+ * their own locks.\n+ */\n+Mutex g_peer_mutex;\n+static std::map<NodeId, PeerRef> g_peer_map GUARDED_BY(g_peer_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r475771780",
      "id" : 475771780,
      "in_reply_to_id" : 462032894,
      "line" : 501,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc3MTc4MA==",
      "original_commit_id" : "d60a16bb3f58fcb9422c277256b3c3a31cab3b2f",
      "original_line" : 501,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 66,
      "pull_request_review_id" : 473704175,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-24T17:18:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/475771780",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK 8e35bf59062b3a823182588e0bf809b3367c2be0.\r\n\r\nI think my [comment](https://github.com/bitcoin/bitcoin/pull/19607#discussion_r470173964) here is important for reviewers to keep in mind here and for future work on ```Peer```, but I don't see any issues introduced as part of this PR.",
      "created_at" : "2020-08-27T16:52:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#issuecomment-682068150",
      "id" : 682068150,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19607",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4MjA2ODE1MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-27T16:52:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/682068150",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r479385813"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479385813"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks @theuni. This is a very good point. I'll add a comment about not relying on this being the final state of `Peer` in a future commit.",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-08-28T15:41:50Z",
      "diff_hunk" : "@@ -906,7 +907,11 @@ void PeerLogicValidation::ReattemptInitialBroadcast(CScheduler& scheduler) const\n }\n \n void PeerLogicValidation::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTime) {\n+    int misbehavior{0};\n     {\n+        PeerRef peer = GetPeerRef(nodeid);\n+        assert(peer != nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r479385813",
      "id" : 479385813,
      "in_reply_to_id" : 467071878,
      "line" : 914,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTM4NTgxMw==",
      "original_commit_id" : "c45a56d2fb8415c6322ad7632c72e0c264d28df6",
      "original_line" : 914,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 101,
      "pull_request_review_id" : 477834129,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-28T15:41:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479385813",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.\n\n",
      "created_at" : "2020-08-28T18:16:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#issuecomment-683025972",
      "id" : 683025972,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19607",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4MzAyNTk3Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-28T18:16:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/683025972",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r484527708"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484527708"
         }
      },
      "author_association" : "MEMBER",
      "body" : "PR: #19910",
      "commit_id" : "8e35bf59062b3a823182588e0bf809b3367c2be0",
      "created_at" : "2020-09-07T17:18:20Z",
      "diff_hunk" : "@@ -468,6 +468,44 @@ static CNodeState *State(NodeId pnode) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     return &it->second;\n }\n \n+/**\n+ * Data stucture for an individual peer. This struct is not protected by\n+ * cs_main since it does not contain validation-critical data.\n+ *\n+ * Memory is owned by shared pointers and this object is destructed when\n+ * the refcount drops to zero (in FinalizeNode()).\n+ *\n+ * TODO: move most members from CNodeState to this structure.\n+ * TODO: move remaining application-layer data members from CNode to this structure.\n+ */\n+struct Peer {\n+    /** Same id as the CNode object for this peer */\n+    NodeId m_id;\n+\n+    Peer(NodeId id) : m_id(id) {}\n+};\n+\n+using PeerRef = std::shared_ptr<Peer>;\n+\n+/**\n+ * Map of all Peer objects, keyed by peer id. This map is protected\n+ * by the global g_peer_mutex. Once a shared pointer reference is\n+ * taken, the lock may be released. Individual fields are protected by\n+ * their own locks.\n+ */\n+Mutex g_peer_mutex;\n+static std::map<NodeId, PeerRef> g_peer_map GUARDED_BY(g_peer_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r484527708",
      "id" : 484527708,
      "in_reply_to_id" : 462032894,
      "line" : 501,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUyNzcwOA==",
      "original_commit_id" : "d60a16bb3f58fcb9422c277256b3c3a31cab3b2f",
      "original_line" : 501,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 66,
      "pull_request_review_id" : 483671937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-07T17:18:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484527708",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   }
]
