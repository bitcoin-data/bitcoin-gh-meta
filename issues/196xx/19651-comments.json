[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Could we change `BerkeleyBatch::WriteKey` to return an enum describing the error? that will be inconsistent with the current API though.\r\nbut it will allow us to print a good error for the user, as he should probably know he already have that descriptor ",
      "created_at" : "2020-08-03T12:09:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#issuecomment-667987452",
      "id" : 667987452,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19651",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2Nzk4NzQ1Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-03T12:09:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/667987452",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2167860?v=4",
         "events_url" : "https://api.github.com/users/elichai/events{/privacy}",
         "followers_url" : "https://api.github.com/users/elichai/followers",
         "following_url" : "https://api.github.com/users/elichai/following{/other_user}",
         "gists_url" : "https://api.github.com/users/elichai/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/elichai",
         "id" : 2167860,
         "login" : "elichai",
         "node_id" : "MDQ6VXNlcjIxNjc4NjA=",
         "organizations_url" : "https://api.github.com/users/elichai/orgs",
         "received_events_url" : "https://api.github.com/users/elichai/received_events",
         "repos_url" : "https://api.github.com/users/elichai/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/elichai/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/elichai/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/elichai"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I think we should go with option 2: To update the existing spkman. The keys should either already exist or are being imported at that time. I don't think it's good to add keys in memory and not write them to disk as this could potentially result in lost keys.",
      "created_at" : "2020-08-03T16:07:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#issuecomment-668107138",
      "id" : 668107138,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19651",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2ODEwNzEzOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-03T16:07:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/668107138",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Could we change `BerkeleyBatch::WriteKey` to return an enum describing the error? that will be inconsistent with the current API though.\r\n> but it will allow us to print a good error for the user, as he should probably know he already have that descriptor\r\n\r\n@elichai I believe it's better to process the command rather than just show better error message, because it allows to modify some meta data: for example descriptor's range. However I added a trivial commit to make error message less misleading.\r\n\r\n> I think we should go with option 2: To update the existing spkman. The keys should either already exist or are being imported at that time. I don't think it's good to add keys in memory and not write them to disk as this could potentially result in lost keys.\r\n\r\n@achow101 Indeed, this aligns with my intuition as well. I changed the implementation and it looks cleaner to me. Hope I got the update semantics correct for the `DescriptorScriptPubKeyMan`. Could you please check?\r\n\r\n\r\n\r\n",
      "created_at" : "2020-08-06T08:45:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#issuecomment-669798234",
      "id" : 669798234,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19651",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2OTc5ODIzNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-06T08:45:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/669798234",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #22345 by n0feer\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-08-06T13:36:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#issuecomment-669930910",
      "id" : 669930910,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19651",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2OTkzMDkxMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-27T01:49:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/669930910",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r466555962"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466555962"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We also need to check that new range_end >= old range_end.",
      "commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "created_at" : "2020-08-06T17:03:17Z",
      "diff_hunk" : "@@ -2254,3 +2254,22 @@ const std::vector<CScript> DescriptorScriptPubKeyMan::GetScriptPubKeys() const\n     }\n     return script_pub_keys;\n }\n+\n+void DescriptorScriptPubKeyMan::UpdateDescriptor(WalletDescriptor& descriptor)\n+{\n+    LOCK(cs_desc_man);\n+    if (!HasWalletDescriptor(descriptor)) {\n+        throw std::runtime_error(std::string(__func__) + \": can only update matching descriptor\");\n+    }\n+    if (descriptor.range_start > m_wallet_descriptor.range_start) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r466555962",
      "id" : 466555962,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU1NTk2Mg==",
      "original_commit_id" : "d95d9b706007ba83c6c355f4fdabcd16d0bbfdb3",
      "original_line" : 2264,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 462706376,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-09T20:14:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466555962",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> The commit adding the test should be after or be the same commit as the one adding the fix. This way all commits pass tests.\r\n> \r\n> It would be nice if the tests checked the update behavior (e.g. new ranges, changed active-ness, etc.) but we can do that in a followup.\r\n\r\n@achow101 I squashed the test and the fix commits into one and extracted new function `CanUpdateToWalletDescriptor` to avoid code duplication. I also added some tests to verify various update scenarios: label change, range change, next_index, internal flag change, descriptor activation. A minor change were required in `DescriptorScriptPubKeyMan::SetCache` to make the tests pass.\r\n\r\nPlease note, descriptor deactivation is not working right now so there is no test for it. I'm currently working on it and will do as a separate PR.",
      "created_at" : "2020-08-17T11:19:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#issuecomment-674822483",
      "id" : 674822483,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19651",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3NDgyMjQ4Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-17T11:19:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/674822483",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-08-18T13:00:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#issuecomment-675464019",
      "id" : 675464019,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19651",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3NTQ2NDAxOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-18T13:00:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/675464019",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased and removed 51ea4c6ad808f881d26ff99da620e09d9549163e as it was already added to master",
      "created_at" : "2020-08-19T10:52:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#issuecomment-676137952",
      "id" : 676137952,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19651",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3NjEzNzk1Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-19T10:52:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/676137952",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r474787294"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/474787294"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why? Usually being unable to `ExpandFromCache` is a bad thing as it means the cache is not the size we are expecting.",
      "commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "created_at" : "2020-08-21T15:58:55Z",
      "diff_hunk" : "@@ -2183,7 +2183,7 @@ void DescriptorScriptPubKeyMan::SetCache(const DescriptorCache& cache)\n         FlatSigningProvider out_keys;\n         std::vector<CScript> scripts_temp;\n         if (!m_wallet_descriptor.descriptor->ExpandFromCache(i, m_wallet_descriptor.cache, scripts_temp, out_keys)) {\n-            throw std::runtime_error(\"Error: Unable to expand wallet descriptor from cache\");\n+            continue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r474787294",
      "id" : 474787294,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc4NzI5NA==",
      "original_commit_id" : "c82033b415aaa58641cd5349a6036782b738479b",
      "original_line" : 2186,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 472609180,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-09T20:14:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/474787294",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r474788781"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/474788781"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What if a descriptor adds private keys that weren't there before?",
      "commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "created_at" : "2020-08-21T16:01:52Z",
      "diff_hunk" : "@@ -2254,3 +2254,41 @@ const std::vector<CScript> DescriptorScriptPubKeyMan::GetScriptPubKeys() const\n     }\n     return script_pub_keys;\n }\n+\n+void DescriptorScriptPubKeyMan::UpdateWalletDescriptor(WalletDescriptor& descriptor)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r474788781",
      "id" : 474788781,
      "line" : 2290,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc4ODc4MQ==",
      "original_commit_id" : "a2d7106a5b179414e186dbdc9befcc7c7a6ff255",
      "original_line" : 2290,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 18,
      "pull_request_review_id" : 472609180,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-09T20:14:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/474788781",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r474790348"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/474790348"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why? I don't think it is necessarily wrong for a `ScriptPubKeyMan` to serve both internal and external addresses. We do this in the legacy wallet. Also, it seems like this should break the legacy wallet.",
      "commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "created_at" : "2020-08-21T16:04:59Z",
      "diff_hunk" : "@@ -4478,10 +4478,15 @@ void CWallet::LoadActiveScriptPubKeyMan(uint256 id, OutputType type, bool intern\n {\n     WalletLogPrintf(\"Setting spkMan to active: id = %s, type = %d, internal = %d\\n\", id.ToString(), static_cast<int>(type), static_cast<int>(internal));\n     auto& spk_mans = internal ? m_internal_spk_managers : m_external_spk_managers;\n+    auto& spk_mans_other = internal ? m_external_spk_managers : m_internal_spk_managers;\n     auto spk_man = m_spk_managers.at(id).get();\n     spk_man->SetInternal(internal);\n     spk_mans[type] = spk_man;\n \n+    if (spk_mans_other[type] == spk_man) {\n+        spk_mans_other[type] = nullptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r474790348",
      "id" : 474790348,
      "line" : 4640,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc5MDM0OA==",
      "original_commit_id" : "b34664c1f480f0e75e8e2da9eb59128e0c4b734c",
      "original_line" : 4640,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 16,
      "pull_request_review_id" : 472609180,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-09T20:14:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/474790348",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r475058943"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/475058943"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I thought about it and concluded that shouldn't be possible. Here is how I reasoned about it.\r\n1) If private keys are disabled in the wallet we don't have to worry at all, afaik it's not possible to change the flag on existing wallet. \r\n2) Now, if keys are enabled and we add new keys I believe the descriptor would be a new one and won't match any existing descriptor. We find a matching descriptor to be updated by using `HasWalletDescriptor`. So it's only possible to update a wallet descriptor if and only if spring representation of the descriptor matches. I would say we can only update a meta-data of a descriptor: range, next_index, active, internal flags and so on. And if there are new private keys in the new descriptor that should lead to a different string representation with corresponding new public keys.\r\n\r\nI'm new to the codebase, so might miss something. Let me know.",
      "commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "created_at" : "2020-08-22T07:32:35Z",
      "diff_hunk" : "@@ -2254,3 +2254,41 @@ const std::vector<CScript> DescriptorScriptPubKeyMan::GetScriptPubKeys() const\n     }\n     return script_pub_keys;\n }\n+\n+void DescriptorScriptPubKeyMan::UpdateWalletDescriptor(WalletDescriptor& descriptor)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r475058943",
      "id" : 475058943,
      "in_reply_to_id" : 474788781,
      "line" : 2290,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA1ODk0Mw==",
      "original_commit_id" : "a2d7106a5b179414e186dbdc9befcc7c7a6ff255",
      "original_line" : 2290,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 18,
      "pull_request_review_id" : 472905008,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-09T20:14:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/475058943",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r475059774"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/475059774"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Otherwise we are not able to reuse cache when we extend the range for a descriptor. The test will fail at test/functional/wallet_importdescriptors.py:240. We will try to reuse existing cache and apply it to the new range of a bigger size.\r\n\r\nI can't see any downsides to just skipping over missing parts in provided cache. The blanks will be filled with `TopUp()` ad hoc.\r\n\r\nIf you have a strong feeling about this, we can skip cache reuse whatsoever when we update descriptor and expand from the descriptor itself and not from cache.",
      "commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "created_at" : "2020-08-22T07:42:42Z",
      "diff_hunk" : "@@ -2183,7 +2183,7 @@ void DescriptorScriptPubKeyMan::SetCache(const DescriptorCache& cache)\n         FlatSigningProvider out_keys;\n         std::vector<CScript> scripts_temp;\n         if (!m_wallet_descriptor.descriptor->ExpandFromCache(i, m_wallet_descriptor.cache, scripts_temp, out_keys)) {\n-            throw std::runtime_error(\"Error: Unable to expand wallet descriptor from cache\");\n+            continue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r475059774",
      "id" : 475059774,
      "in_reply_to_id" : 474787294,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA1OTc3NA==",
      "original_commit_id" : "c82033b415aaa58641cd5349a6036782b738479b",
      "original_line" : 2186,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 472905574,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-09T20:14:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/475059774",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r475065518"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/475065518"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Two reasons:\r\n1) If we don't do that, than semantics of `importdescriptors` changes. What I'm trying to achieve with this pull request is to make the command idempotent and allow for updates. In case when we don't remove specified SPK from previous map in the wallet (`m_internal_spk_managers`/`m_external_spk_managers`) than it's not really possible for a user to change `internal` flag. When she would try to do so, we would just register same descriptor in the second map. And it's not what I would expect.\r\n\r\n2) This is required to keep consistency when we move descriptor from internal to external and vice versa. `DescriptorScriptPubKeyMan` has `m_internal` flag. It begs for some bugs if this flag is inconsistent with the descriptor placements in the wallet. For example it will affects `KeypoolCountExternalKeys()` and as a consequence the reporting of internal/external key pool sizes.\r\n\r\nWhile this indeed goes against how legacy wallet operates it looks like it doesn't break it. The reason being is that legacy wallet is configured by `SetupLegacyScriptPubKeyMan` and don't use `LoadActiveScriptPubKeyMan`. I tried to verify by using a wallet from 0.16.3 and calling `getnewaddress` and `getrawchagneaddress` and both worked returning a key from the same `hdseedid`. Anyway, let me think how I can improve it. I'm also open from your suggestions.\r\n\r\nP.S. I also looked at the possibility of removing `m_internal` but that doesn't seems possible due to the public interface of SPK. My motivation was to completely illuminate possible inconsistency between wallet and SPK in terms of `internal` flag. Do you think this is an idea worth exploring? ",
      "commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "created_at" : "2020-08-22T08:54:08Z",
      "diff_hunk" : "@@ -4478,10 +4478,15 @@ void CWallet::LoadActiveScriptPubKeyMan(uint256 id, OutputType type, bool intern\n {\n     WalletLogPrintf(\"Setting spkMan to active: id = %s, type = %d, internal = %d\\n\", id.ToString(), static_cast<int>(type), static_cast<int>(internal));\n     auto& spk_mans = internal ? m_internal_spk_managers : m_external_spk_managers;\n+    auto& spk_mans_other = internal ? m_external_spk_managers : m_internal_spk_managers;\n     auto spk_man = m_spk_managers.at(id).get();\n     spk_man->SetInternal(internal);\n     spk_mans[type] = spk_man;\n \n+    if (spk_mans_other[type] == spk_man) {\n+        spk_mans_other[type] = nullptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r475065518",
      "id" : 475065518,
      "in_reply_to_id" : 474790348,
      "line" : 4640,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA2NTUxOA==",
      "original_commit_id" : "b34664c1f480f0e75e8e2da9eb59128e0c4b734c",
      "original_line" : 4640,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 16,
      "pull_request_review_id" : 472909325,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-09T20:14:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/475065518",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r475108102"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/475108102"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I believe this is unsafe when the wallet is encrypted and the descriptor uses hardened derivation. Such `DescriptorScriptPubKeyMan`s are entirely reliant on the cache when the wallet is locked and I think there should be an expectation that updating a such a descriptor should make the specified range available, i.e. the cache is filled.\r\n\r\nI think it's fine to regenerate the cache from scratch when updating a descriptor like this. It would be better if just the missing entries could be added, but that might be harder to do.",
      "commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "created_at" : "2020-08-22T16:44:34Z",
      "diff_hunk" : "@@ -2183,7 +2183,7 @@ void DescriptorScriptPubKeyMan::SetCache(const DescriptorCache& cache)\n         FlatSigningProvider out_keys;\n         std::vector<CScript> scripts_temp;\n         if (!m_wallet_descriptor.descriptor->ExpandFromCache(i, m_wallet_descriptor.cache, scripts_temp, out_keys)) {\n-            throw std::runtime_error(\"Error: Unable to expand wallet descriptor from cache\");\n+            continue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r475108102",
      "id" : 475108102,
      "in_reply_to_id" : 474787294,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwODEwMg==",
      "original_commit_id" : "c82033b415aaa58641cd5349a6036782b738479b",
      "original_line" : 2186,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 472937631,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-09T20:14:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/475108102",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r475108211"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/475108211"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The only current possibility for new private keys is a multisig descriptor. It should be possible to import a multisig descriptor that has only some of the private keys, then update the descriptor with more of the private keys in the multisig.",
      "commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "created_at" : "2020-08-22T16:45:41Z",
      "diff_hunk" : "@@ -2254,3 +2254,41 @@ const std::vector<CScript> DescriptorScriptPubKeyMan::GetScriptPubKeys() const\n     }\n     return script_pub_keys;\n }\n+\n+void DescriptorScriptPubKeyMan::UpdateWalletDescriptor(WalletDescriptor& descriptor)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r475108211",
      "id" : 475108211,
      "in_reply_to_id" : 474788781,
      "line" : 2290,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwODIxMQ==",
      "original_commit_id" : "a2d7106a5b179414e186dbdc9befcc7c7a6ff255",
      "original_line" : 2290,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 18,
      "pull_request_review_id" : 472937691,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-09T20:14:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/475108211",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r475109376"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/475109376"
         }
      },
      "author_association" : "MEMBER",
      "body" : "While legacy wallets do use `SetupLegacyScriptPubKeyMan`, they also have `externalspk` and `internalspk` entries which are handled by `LoadActiveScriptPubKeyMan`. So it should break legacy wallets, and I'm not sure why it doesn't. \r\n\r\nI would prefer that the changing of the activeness and internalness is handled by another function which should also have a comment about why it should remain separate from `LoadActiveScriptPubKeyMan`. As it is now, I think it makes the loading code more fragile and difficult to understand.",
      "commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "created_at" : "2020-08-22T16:57:42Z",
      "diff_hunk" : "@@ -4478,10 +4478,15 @@ void CWallet::LoadActiveScriptPubKeyMan(uint256 id, OutputType type, bool intern\n {\n     WalletLogPrintf(\"Setting spkMan to active: id = %s, type = %d, internal = %d\\n\", id.ToString(), static_cast<int>(type), static_cast<int>(internal));\n     auto& spk_mans = internal ? m_internal_spk_managers : m_external_spk_managers;\n+    auto& spk_mans_other = internal ? m_external_spk_managers : m_internal_spk_managers;\n     auto spk_man = m_spk_managers.at(id).get();\n     spk_man->SetInternal(internal);\n     spk_mans[type] = spk_man;\n \n+    if (spk_mans_other[type] == spk_man) {\n+        spk_mans_other[type] = nullptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r475109376",
      "id" : 475109376,
      "in_reply_to_id" : 474790348,
      "line" : 4640,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwOTM3Ng==",
      "original_commit_id" : "b34664c1f480f0e75e8e2da9eb59128e0c4b734c",
      "original_line" : 4640,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 16,
      "pull_request_review_id" : 472938332,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-09T20:14:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/475109376",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r478335849"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/478335849"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done. The cache is now regenerated on import.",
      "commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "created_at" : "2020-08-27T11:07:11Z",
      "diff_hunk" : "@@ -2183,7 +2183,7 @@ void DescriptorScriptPubKeyMan::SetCache(const DescriptorCache& cache)\n         FlatSigningProvider out_keys;\n         std::vector<CScript> scripts_temp;\n         if (!m_wallet_descriptor.descriptor->ExpandFromCache(i, m_wallet_descriptor.cache, scripts_temp, out_keys)) {\n-            throw std::runtime_error(\"Error: Unable to expand wallet descriptor from cache\");\n+            continue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r478335849",
      "id" : 478335849,
      "in_reply_to_id" : 474787294,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODMzNTg0OQ==",
      "original_commit_id" : "c82033b415aaa58641cd5349a6036782b738479b",
      "original_line" : 2186,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 476612307,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-09T20:14:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/478335849",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r478336183"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/478336183"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks. Changed the code to properly handle this case and added a test for it as well.",
      "commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "created_at" : "2020-08-27T11:07:50Z",
      "diff_hunk" : "@@ -2254,3 +2254,41 @@ const std::vector<CScript> DescriptorScriptPubKeyMan::GetScriptPubKeys() const\n     }\n     return script_pub_keys;\n }\n+\n+void DescriptorScriptPubKeyMan::UpdateWalletDescriptor(WalletDescriptor& descriptor)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r478336183",
      "id" : 478336183,
      "in_reply_to_id" : 474788781,
      "line" : 2290,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODMzNjE4Mw==",
      "original_commit_id" : "a2d7106a5b179414e186dbdc9befcc7c7a6ff255",
      "original_line" : 2290,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 18,
      "pull_request_review_id" : 476612716,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-09T20:14:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/478336183",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r478339994"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/478339994"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I analyzed the code and couldn't find any uses of `LoadActiveScriptPubKeyMan` for legacy wallets. The function is only called when 1) we create new wallet, 2) call `importdescriptors` command or 3) when loading a wallet from disk. But if I'm not mistaken there is no active SPKs on disk for legacy wallets. That makes me believe this function is only relevant for descriptor wallets. So I put a guard at the top to throw an exception when we call it for legacy wallet. And all wallet functional tests pass on my laptop for now. I'm happy to reproduce any scenario in which this code should break legacy wallet.\r\n\r\n",
      "commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "created_at" : "2020-08-27T11:15:55Z",
      "diff_hunk" : "@@ -4478,10 +4478,15 @@ void CWallet::LoadActiveScriptPubKeyMan(uint256 id, OutputType type, bool intern\n {\n     WalletLogPrintf(\"Setting spkMan to active: id = %s, type = %d, internal = %d\\n\", id.ToString(), static_cast<int>(type), static_cast<int>(internal));\n     auto& spk_mans = internal ? m_internal_spk_managers : m_external_spk_managers;\n+    auto& spk_mans_other = internal ? m_external_spk_managers : m_internal_spk_managers;\n     auto spk_man = m_spk_managers.at(id).get();\n     spk_man->SetInternal(internal);\n     spk_mans[type] = spk_man;\n \n+    if (spk_mans_other[type] == spk_man) {\n+        spk_mans_other[type] = nullptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r478339994",
      "id" : 478339994,
      "in_reply_to_id" : 474790348,
      "line" : 4640,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODMzOTk5NA==",
      "original_commit_id" : "b34664c1f480f0e75e8e2da9eb59128e0c4b734c",
      "original_line" : 4640,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 16,
      "pull_request_review_id" : 476617732,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-09T20:14:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/478339994",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Added `wallet: deactivate descriptor` commit from #19774",
      "created_at" : "2020-08-27T11:17:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#issuecomment-681885443",
      "id" : 681885443,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19651",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4MTg4NTQ0Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-27T11:17:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/681885443",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r478519589"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/478519589"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Hmm, `SetupLegacyScriptPubKeyMan` adds the `LegacySPKM` to the maps that track internal/external, but doesn't write them to disk. I thought it wrote them to disk and now I'm wondering whether not doing so is a bug. But since it doesn't, that's why this works.",
      "commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "created_at" : "2020-08-27T15:47:02Z",
      "diff_hunk" : "@@ -4478,10 +4478,15 @@ void CWallet::LoadActiveScriptPubKeyMan(uint256 id, OutputType type, bool intern\n {\n     WalletLogPrintf(\"Setting spkMan to active: id = %s, type = %d, internal = %d\\n\", id.ToString(), static_cast<int>(type), static_cast<int>(internal));\n     auto& spk_mans = internal ? m_internal_spk_managers : m_external_spk_managers;\n+    auto& spk_mans_other = internal ? m_external_spk_managers : m_internal_spk_managers;\n     auto spk_man = m_spk_managers.at(id).get();\n     spk_man->SetInternal(internal);\n     spk_mans[type] = spk_man;\n \n+    if (spk_mans_other[type] == spk_man) {\n+        spk_mans_other[type] = nullptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r478519589",
      "id" : 478519589,
      "in_reply_to_id" : 474790348,
      "line" : 4640,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODUxOTU4OQ==",
      "original_commit_id" : "b34664c1f480f0e75e8e2da9eb59128e0c4b734c",
      "original_line" : 4640,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 16,
      "pull_request_review_id" : 476854803,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-09T20:14:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/478519589",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r478559557"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/478559557"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think it would be better to have this inside of `AddDescriptorKeyWithDB`. Additionally, it needs to check `m_map_crypted_keys` otherwise this won't work when the wallet is encrypted.",
      "commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "created_at" : "2020-08-27T16:50:51Z",
      "diff_hunk" : "@@ -1836,6 +1836,10 @@ void DescriptorScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n void DescriptorScriptPubKeyMan::AddDescriptorKey(const CKey& key, const CPubKey &pubkey)\n {\n     LOCK(cs_desc_man);\n+    if (m_map_keys.find(pubkey.GetID()) != m_map_keys.end()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r478559557",
      "id" : 478559557,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU1OTU1Nw==",
      "original_commit_id" : "745c2a860fc05bc181bc50edbcb2f2a69a21b896",
      "original_line" : 1839,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 476907069,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-09T20:14:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/478559557",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r478561752"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/478561752"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think using `[]` for access here could be problematic if the `type` isn't already in the map (I think that can happen). I would prefer using `find` here and then if it works, checking that the returned object is not `nullptr`.",
      "commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "created_at" : "2020-08-27T16:54:44Z",
      "diff_hunk" : "@@ -4494,6 +4494,22 @@ void CWallet::LoadActiveScriptPubKeyMan(uint256 id, OutputType type, bool intern\n     NotifyCanGetAddressesChanged();\n }\n \n+void CWallet::DeactivateScriptPubKeyMan(uint256 id, OutputType type, bool internal)\n+{\n+    auto& spk_mans = internal ? m_internal_spk_managers : m_external_spk_managers;\n+    if (spk_mans[type] && spk_mans[type]->GetID() == id) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r478561752",
      "id" : 478561752,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU2MTc1Mg==",
      "original_commit_id" : "39e1c5a6c28e86ed7e831f096581ec8ed70ade7e",
      "original_line" : 4500,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 476909988,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-09T20:14:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/478561752",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r479037965"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479037965"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm not a cpp expert, but the docs say in case when there is no such key a default value will be inserted. \r\n> std::map<Key,T,Compare,Allocator>::operator[]\r\n> Returns a reference to the value that is mapped to a key equivalent to key, performing an insertion if such key does not already exist.\r\n\r\nSo I believe it's safe in this particular case.\r\n\r\nI still prefer `spk_mans[type]` over `spk_mans.find(type) != spk_mans.end() && spk_mans[type] != nullptr` but if that's going against the norms for the project I can change to whatever is considered standard way.\r\n",
      "commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "created_at" : "2020-08-28T09:43:41Z",
      "diff_hunk" : "@@ -4494,6 +4494,22 @@ void CWallet::LoadActiveScriptPubKeyMan(uint256 id, OutputType type, bool intern\n     NotifyCanGetAddressesChanged();\n }\n \n+void CWallet::DeactivateScriptPubKeyMan(uint256 id, OutputType type, bool internal)\n+{\n+    auto& spk_mans = internal ? m_internal_spk_managers : m_external_spk_managers;\n+    if (spk_mans[type] && spk_mans[type]->GetID() == id) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r479037965",
      "id" : 479037965,
      "in_reply_to_id" : 478561752,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTAzNzk2NQ==",
      "original_commit_id" : "39e1c5a6c28e86ed7e831f096581ec8ed70ade7e",
      "original_line" : 4500,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 477592807,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-09T20:14:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479037965",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r479043727"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479043727"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "created_at" : "2020-08-28T09:48:33Z",
      "diff_hunk" : "@@ -1836,6 +1836,10 @@ void DescriptorScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n void DescriptorScriptPubKeyMan::AddDescriptorKey(const CKey& key, const CPubKey &pubkey)\n {\n     LOCK(cs_desc_man);\n+    if (m_map_keys.find(pubkey.GetID()) != m_map_keys.end()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r479043727",
      "id" : 479043727,
      "in_reply_to_id" : 478559557,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTA0MzcyNw==",
      "original_commit_id" : "745c2a860fc05bc181bc50edbcb2f2a69a21b896",
      "original_line" : 1839,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 477595886,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-09T20:14:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479043727",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r479393567"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479393567"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Right, but the point is that we don't want a default value inserted.\r\n\r\nIt might be easier to just use `GetScriptPubKeyMan` here.",
      "commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "created_at" : "2020-08-28T15:56:31Z",
      "diff_hunk" : "@@ -4494,6 +4494,22 @@ void CWallet::LoadActiveScriptPubKeyMan(uint256 id, OutputType type, bool intern\n     NotifyCanGetAddressesChanged();\n }\n \n+void CWallet::DeactivateScriptPubKeyMan(uint256 id, OutputType type, bool internal)\n+{\n+    auto& spk_mans = internal ? m_internal_spk_managers : m_external_spk_managers;\n+    if (spk_mans[type] && spk_mans[type]->GetID() == id) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r479393567",
      "id" : 479393567,
      "in_reply_to_id" : 478561752,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTM5MzU2Nw==",
      "original_commit_id" : "39e1c5a6c28e86ed7e831f096581ec8ed70ade7e",
      "original_line" : 4500,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 477844400,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-09T20:14:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479393567",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r479751284"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479751284"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "created_at" : "2020-08-30T10:23:50Z",
      "diff_hunk" : "@@ -4494,6 +4494,22 @@ void CWallet::LoadActiveScriptPubKeyMan(uint256 id, OutputType type, bool intern\n     NotifyCanGetAddressesChanged();\n }\n \n+void CWallet::DeactivateScriptPubKeyMan(uint256 id, OutputType type, bool internal)\n+{\n+    auto& spk_mans = internal ? m_internal_spk_managers : m_external_spk_managers;\n+    if (spk_mans[type] && spk_mans[type]->GetID() == id) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r479751284",
      "id" : 479751284,
      "in_reply_to_id" : 478561752,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTc1MTI4NA==",
      "original_commit_id" : "39e1c5a6c28e86ed7e831f096581ec8ed70ade7e",
      "original_line" : 4500,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 478190533,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-09T20:14:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479751284",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@achow101 thanks for your time and review. I pushed changes as fixup commits for easier incremental review, when you believe the code is ready to be merged I'll squash them into original commits.",
      "created_at" : "2020-08-30T10:27:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#issuecomment-683403173",
      "id" : 683403173,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19651",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4MzQwMzE3Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-30T10:27:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/683403173",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK, please squash.",
      "created_at" : "2020-09-03T16:54:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#issuecomment-686622471",
      "id" : 686622471,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19651",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4NjYyMjQ3MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-03T16:54:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/686622471",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK 908e18e79847155144111bafa2e6e5dbd5c6511c",
      "created_at" : "2020-09-09T21:12:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#issuecomment-689824848",
      "id" : 689824848,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19651",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4OTgyNDg0OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-09T21:12:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/689824848",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-11-09T21:11:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#issuecomment-724280493",
      "id" : 724280493,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19651",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcyNDI4MDQ5Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-09T21:11:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/724280493",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-02-18T10:06:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#issuecomment-781231457",
      "id" : 781231457,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19651",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4MTIzMTQ1Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-18T10:06:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/781231457",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-05-03T05:03:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#issuecomment-831020502",
      "id" : 831020502,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19651",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgzMTAyMDUwMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-03T05:03:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/831020502",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "This should also fix #21716 ",
      "created_at" : "2021-05-10T19:10:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#issuecomment-837171679",
      "id" : 837171679,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19651",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgzNzE3MTY3OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-10T19:10:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/837171679",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "re-ACK 5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "created_at" : "2021-06-03T20:52:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#issuecomment-854171032",
      "id" : 854171032,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19651",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1NDE3MTAzMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-03T20:52:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/854171032",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r648852307"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/648852307"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I feel like the name of this function is confusing and could be improved.",
      "commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "created_at" : "2021-06-10T05:05:33Z",
      "diff_hunk" : "@@ -2280,3 +2286,38 @@ bool DescriptorScriptPubKeyMan::GetDescriptorString(std::string& out, bool priv)\n \n     return m_wallet_descriptor.descriptor->ToNormalizedString(provider, out, priv);\n }\n+\n+void DescriptorScriptPubKeyMan::UpdateWalletDescriptor(WalletDescriptor& descriptor)\n+{\n+    LOCK(cs_desc_man);\n+    std::string error;\n+    if (!CanUpdateToWalletDescriptor(descriptor, error)) {\n+        throw std::runtime_error(std::string(__func__) + \": \" + error);\n+    }\n+\n+    m_map_pubkeys.clear();\n+    m_map_script_pub_keys.clear();\n+    m_max_cached_index = -1;\n+    m_wallet_descriptor = descriptor;\n+}\n+\n+bool DescriptorScriptPubKeyMan::CanUpdateToWalletDescriptor(const WalletDescriptor& descriptor, std::string& error)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r648852307",
      "id" : 648852307,
      "line" : 2304,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0ODg1MjMwNw==",
      "original_commit_id" : "fed9eef48d53dd3256108b03248a08273a0f23b9",
      "original_line" : 2304,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 32,
      "pull_request_review_id" : 680345994,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-10T05:12:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/648852307",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3211283?v=4",
         "events_url" : "https://api.github.com/users/meshcollider/events{/privacy}",
         "followers_url" : "https://api.github.com/users/meshcollider/followers",
         "following_url" : "https://api.github.com/users/meshcollider/following{/other_user}",
         "gists_url" : "https://api.github.com/users/meshcollider/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/meshcollider",
         "id" : 3211283,
         "login" : "meshcollider",
         "node_id" : "MDQ6VXNlcjMyMTEyODM=",
         "organizations_url" : "https://api.github.com/users/meshcollider/orgs",
         "received_events_url" : "https://api.github.com/users/meshcollider/received_events",
         "repos_url" : "https://api.github.com/users/meshcollider/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/meshcollider/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/meshcollider/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/meshcollider"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I'll try to review this later today.",
      "created_at" : "2021-06-24T09:30:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#issuecomment-867488611",
      "id" : 867488611,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19651",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2NzQ4ODYxMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-24T09:30:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/867488611",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r657902265"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/657902265"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit, clang format\r\n```suggestion\r\n    auto range = strprintf(\"current range = [%d,%d]\", m_wallet_descriptor.range_start, m_wallet_descriptor.range_end - 1);\r\n```",
      "commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "created_at" : "2021-06-24T12:30:49Z",
      "diff_hunk" : "@@ -2280,3 +2286,38 @@ bool DescriptorScriptPubKeyMan::GetDescriptorString(std::string& out, bool priv)\n \n     return m_wallet_descriptor.descriptor->ToNormalizedString(provider, out, priv);\n }\n+\n+void DescriptorScriptPubKeyMan::UpdateWalletDescriptor(WalletDescriptor& descriptor)\n+{\n+    LOCK(cs_desc_man);\n+    std::string error;\n+    if (!CanUpdateToWalletDescriptor(descriptor, error)) {\n+        throw std::runtime_error(std::string(__func__) + \": \" + error);\n+    }\n+\n+    m_map_pubkeys.clear();\n+    m_map_script_pub_keys.clear();\n+    m_max_cached_index = -1;\n+    m_wallet_descriptor = descriptor;\n+}\n+\n+bool DescriptorScriptPubKeyMan::CanUpdateToWalletDescriptor(const WalletDescriptor& descriptor, std::string& error)\n+{\n+    LOCK(cs_desc_man);\n+    if (!HasWalletDescriptor(descriptor)) {\n+        error = \"can only update matching descriptor\";\n+        return false;\n+    }\n+    // Use inclusive range for error\n+    auto range = strprintf(\"current range = [%d,%d]\", m_wallet_descriptor.range_start, m_wallet_descriptor.range_end-1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r657902265",
      "id" : 657902265,
      "line" : 2312,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NzkwMjI2NQ==",
      "original_commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "original_line" : 2312,
      "original_position" : 40,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 40,
      "pull_request_review_id" : 691693379,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-24T13:29:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/657902265",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r657921395"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/657921395"
         }
      },
      "author_association" : "MEMBER",
      "body" : "cead7ed This doesn't seem to be covered by any tests?",
      "commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "created_at" : "2021-06-24T12:56:14Z",
      "diff_hunk" : "@@ -4625,12 +4625,38 @@ void CWallet::AddActiveScriptPubKeyMan(uint256 id, OutputType type, bool interna\n \n void CWallet::LoadActiveScriptPubKeyMan(uint256 id, OutputType type, bool internal)\n {\n+    if (!IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {\n+        throw std::runtime_error(\"Cannot LoadActiveScriptPubKeyMan to a non-descriptor wallet\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r657921395",
      "id" : 657921395,
      "line" : 4629,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NzkyMTM5NQ==",
      "original_commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "original_line" : 4629,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 5,
      "pull_request_review_id" : 691693379,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-24T13:29:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/657921395",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r657922805"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/657922805"
         }
      },
      "author_association" : "MEMBER",
      "body" : "c90f0279 can you extend the test coverage to show the descriptive errors and spec the change?",
      "commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "created_at" : "2021-06-24T12:57:58Z",
      "diff_hunk" : "@@ -1564,16 +1563,19 @@ static UniValue ProcessDescriptorImport(CWallet& wallet, const UniValue& data, c\n             } else {\n                 wallet.AddActiveScriptPubKeyMan(spk_manager->GetID(), *w_desc.descriptor->GetOutputType(), internal);\n             }\n+        } else {\n+            if (w_desc.descriptor->GetOutputType()) {\n+                wallet.DeactivateScriptPubKeyMan(spk_manager->GetID(), *w_desc.descriptor->GetOutputType(), internal);\n+            }\n         }\n \n         result.pushKV(\"success\", UniValue(true));\n     } catch (const UniValue& e) {\n         result.pushKV(\"success\", UniValue(false));\n         result.pushKV(\"error\", e);\n-    } catch (...) {\n+    } catch (const std::runtime_error& e) {\n         result.pushKV(\"success\", UniValue(false));\n-\n-        result.pushKV(\"error\", JSONRPCError(RPC_MISC_ERROR, \"Missing required fields\"));\n+        result.pushKV(\"error\", JSONRPCError(RPC_MISC_ERROR, e.what()));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r657922805",
      "id" : 657922805,
      "line" : 1578,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NzkyMjgwNQ==",
      "original_commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "original_line" : 1578,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 31,
      "pull_request_review_id" : 691693379,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-24T13:29:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/657922805",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r657926759"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/657926759"
         }
      },
      "author_association" : "MEMBER",
      "body" : "cead7ed ISTM this change should have test coverage (more so given the discussion) to spec the behavior and provide regression coverage. Edit: Ah, if I understand correctly some test coverage is added in the next commit b66b26a. ",
      "commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "created_at" : "2021-06-24T13:02:48Z",
      "diff_hunk" : "@@ -4478,10 +4478,15 @@ void CWallet::LoadActiveScriptPubKeyMan(uint256 id, OutputType type, bool intern\n {\n     WalletLogPrintf(\"Setting spkMan to active: id = %s, type = %d, internal = %d\\n\", id.ToString(), static_cast<int>(type), static_cast<int>(internal));\n     auto& spk_mans = internal ? m_internal_spk_managers : m_external_spk_managers;\n+    auto& spk_mans_other = internal ? m_external_spk_managers : m_internal_spk_managers;\n     auto spk_man = m_spk_managers.at(id).get();\n     spk_man->SetInternal(internal);\n     spk_mans[type] = spk_man;\n \n+    if (spk_mans_other[type] == spk_man) {\n+        spk_mans_other[type] = nullptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r657926759",
      "id" : 657926759,
      "in_reply_to_id" : 474790348,
      "line" : 4640,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NzkyNjc1OQ==",
      "original_commit_id" : "b34664c1f480f0e75e8e2da9eb59128e0c4b734c",
      "original_line" : 4640,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 16,
      "pull_request_review_id" : 691693379,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-24T13:29:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/657926759",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r657936021"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/657936021"
         }
      },
      "author_association" : "MEMBER",
      "body" : "5d96704 style nit\r\n```suggestion\r\n    const std::string key{internal ? DBKeys::ACTIVEINTERNALSPK : DBKeys::ACTIVEEXTERNALSPK};\r\n```",
      "commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "created_at" : "2021-06-24T13:14:16Z",
      "diff_hunk" : "@@ -209,6 +209,12 @@ bool WalletBatch::WriteActiveScriptPubKeyMan(uint8_t type, const uint256& id, bo\n     return WriteIC(make_pair(key, type), id);\n }\n \n+bool WalletBatch::EraseActiveScriptPubKeyMan(uint8_t type, bool internal)\n+{\n+    std::string key = internal ? DBKeys::ACTIVEINTERNALSPK : DBKeys::ACTIVEEXTERNALSPK;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r657936021",
      "id" : 657936021,
      "line" : 214,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NzkzNjAyMQ==",
      "original_commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "original_line" : 214,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 6,
      "pull_request_review_id" : 691693379,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-24T13:29:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/657936021",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r657939779"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/657939779"
         }
      },
      "author_association" : "MEMBER",
      "body" : "5d96704 test coverage?",
      "commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "created_at" : "2021-06-24T13:18:50Z",
      "diff_hunk" : "@@ -4625,12 +4625,38 @@ void CWallet::AddActiveScriptPubKeyMan(uint256 id, OutputType type, bool interna\n \n void CWallet::LoadActiveScriptPubKeyMan(uint256 id, OutputType type, bool internal)\n {\n+    if (!IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {\n+        throw std::runtime_error(\"Cannot LoadActiveScriptPubKeyMan to a non-descriptor wallet\\n\");\n+    }\n+\n     WalletLogPrintf(\"Setting spkMan to active: id = %s, type = %d, internal = %d\\n\", id.ToString(), static_cast<int>(type), static_cast<int>(internal));\n     auto& spk_mans = internal ? m_internal_spk_managers : m_external_spk_managers;\n+    auto& spk_mans_other = internal ? m_external_spk_managers : m_internal_spk_managers;\n     auto spk_man = m_spk_managers.at(id).get();\n     spk_man->SetInternal(internal);\n     spk_mans[type] = spk_man;\n \n+    if (spk_mans_other[type] == spk_man) {\n+        spk_mans_other[type] = nullptr;\n+    }\n+\n+    NotifyCanGetAddressesChanged();\n+}\n+\n+void CWallet::DeactivateScriptPubKeyMan(uint256 id, OutputType type, bool internal)\n+{\n+    auto spk_man = GetScriptPubKeyMan(type, internal);\n+    if (spk_man != nullptr && spk_man->GetID() == id) {\n+        WalletLogPrintf(\"Deactivate spkMan: id = %s, type = %d, internal = %d\\n\", id.ToString(), static_cast<int>(type), static_cast<int>(internal));\n+        WalletBatch batch(GetDatabase());\n+        if (!batch.EraseActiveScriptPubKeyMan(static_cast<uint8_t>(type), internal)) {\n+            throw std::runtime_error(std::string(__func__) + \": erasing active ScriptPubKeyMan id failed\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r657939779",
      "id" : 657939779,
      "line" : 4653,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NzkzOTc3OQ==",
      "original_commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "original_line" : 4653,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 29,
      "pull_request_review_id" : 691693379,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-24T13:29:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/657939779",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r657941768"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/657941768"
         }
      },
      "author_association" : "MEMBER",
      "body" : "5d9670462219b8c753516bfbdc5c7fa23046cd07 does this have test coverage? ",
      "commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "created_at" : "2021-06-24T13:21:10Z",
      "diff_hunk" : "@@ -1564,16 +1563,19 @@ static UniValue ProcessDescriptorImport(CWallet& wallet, const UniValue& data, c\n             } else {\n                 wallet.AddActiveScriptPubKeyMan(spk_manager->GetID(), *w_desc.descriptor->GetOutputType(), internal);\n             }\n+        } else {\n+            if (w_desc.descriptor->GetOutputType()) {\n+                wallet.DeactivateScriptPubKeyMan(spk_manager->GetID(), *w_desc.descriptor->GetOutputType(), internal);\n+            }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r657941768",
      "id" : 657941768,
      "line" : 1569,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1Nzk0MTc2OA==",
      "original_commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "original_line" : 1569,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 19,
      "pull_request_review_id" : 691693379,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-24T13:29:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/657941768",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r659156208"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659156208"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This could just be fixed in the previous commit where this line is added",
      "commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "created_at" : "2021-06-26T11:24:37Z",
      "diff_hunk" : "@@ -1546,7 +1546,7 @@ static UniValue ProcessDescriptorImport(CWallet& wallet, const UniValue& data, c\n         auto existing_spk_manager = wallet.GetDescriptorScriptPubKeyMan(w_desc);\n         if (existing_spk_manager) {\n             if (!existing_spk_manager->CanUpdateToWalletDescriptor(w_desc, error)) {\n-                throw JSONRPCError(RPC_INVALID_PARAMS, error);\n+                throw JSONRPCError(RPC_INVALID_PARAMETER, error);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r659156208",
      "id" : 659156208,
      "line" : 1549,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1OTE1NjIwOA==",
      "original_commit_id" : "c90f0279404477b697eefeebf064c3b089d7729c",
      "original_line" : 1549,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 8,
      "pull_request_review_id" : 693301643,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-26T11:52:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659156208",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r659156447"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659156447"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Is the newline needed here? Doesn't seem to be the standard.",
      "commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "created_at" : "2021-06-26T11:27:07Z",
      "diff_hunk" : "@@ -4625,12 +4625,38 @@ void CWallet::AddActiveScriptPubKeyMan(uint256 id, OutputType type, bool interna\n \n void CWallet::LoadActiveScriptPubKeyMan(uint256 id, OutputType type, bool internal)\n {\n+    if (!IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {\n+        throw std::runtime_error(\"Cannot LoadActiveScriptPubKeyMan to a non-descriptor wallet\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r659156447",
      "id" : 659156447,
      "in_reply_to_id" : 657921395,
      "line" : 4629,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1OTE1NjQ0Nw==",
      "original_commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "original_line" : 4629,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 5,
      "pull_request_review_id" : 693301643,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-26T11:52:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659156447",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r659158411"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659158411"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: I prefer to not create helper variables outside of error handling that are only used inside of error handling so I would inline this. I also think this code be reorganized slightly to make the error cumulative message, i.e. if both errors are hit the error message can include both messages about `range_start` and `range_end`.",
      "commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "created_at" : "2021-06-26T11:47:27Z",
      "diff_hunk" : "@@ -2280,3 +2286,38 @@ bool DescriptorScriptPubKeyMan::GetDescriptorString(std::string& out, bool priv)\n \n     return m_wallet_descriptor.descriptor->ToNormalizedString(provider, out, priv);\n }\n+\n+void DescriptorScriptPubKeyMan::UpdateWalletDescriptor(WalletDescriptor& descriptor)\n+{\n+    LOCK(cs_desc_man);\n+    std::string error;\n+    if (!CanUpdateToWalletDescriptor(descriptor, error)) {\n+        throw std::runtime_error(std::string(__func__) + \": \" + error);\n+    }\n+\n+    m_map_pubkeys.clear();\n+    m_map_script_pub_keys.clear();\n+    m_max_cached_index = -1;\n+    m_wallet_descriptor = descriptor;\n+}\n+\n+bool DescriptorScriptPubKeyMan::CanUpdateToWalletDescriptor(const WalletDescriptor& descriptor, std::string& error)\n+{\n+    LOCK(cs_desc_man);\n+    if (!HasWalletDescriptor(descriptor)) {\n+        error = \"can only update matching descriptor\";\n+        return false;\n+    }\n+    // Use inclusive range for error\n+    auto range = strprintf(\"current range = [%d,%d]\", m_wallet_descriptor.range_start, m_wallet_descriptor.range_end-1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r659158411",
      "id" : 659158411,
      "in_reply_to_id" : 657902265,
      "line" : 2312,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1OTE1ODQxMQ==",
      "original_commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "original_line" : 2312,
      "original_position" : 40,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 40,
      "pull_request_review_id" : 693301643,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-26T11:52:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659158411",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r660065213"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/660065213"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I've spent some time, but couldn't come up with anything better. Any suggestions?",
      "commit_id" : "3efaf83c75cd8dc2fa084537b8ed6715fb58c04d",
      "created_at" : "2021-06-28T19:38:48Z",
      "diff_hunk" : "@@ -2280,3 +2286,38 @@ bool DescriptorScriptPubKeyMan::GetDescriptorString(std::string& out, bool priv)\n \n     return m_wallet_descriptor.descriptor->ToNormalizedString(provider, out, priv);\n }\n+\n+void DescriptorScriptPubKeyMan::UpdateWalletDescriptor(WalletDescriptor& descriptor)\n+{\n+    LOCK(cs_desc_man);\n+    std::string error;\n+    if (!CanUpdateToWalletDescriptor(descriptor, error)) {\n+        throw std::runtime_error(std::string(__func__) + \": \" + error);\n+    }\n+\n+    m_map_pubkeys.clear();\n+    m_map_script_pub_keys.clear();\n+    m_max_cached_index = -1;\n+    m_wallet_descriptor = descriptor;\n+}\n+\n+bool DescriptorScriptPubKeyMan::CanUpdateToWalletDescriptor(const WalletDescriptor& descriptor, std::string& error)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r660065213",
      "id" : 660065213,
      "in_reply_to_id" : 648852307,
      "line" : 2326,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDA2NTIxMw==",
      "original_commit_id" : "fed9eef48d53dd3256108b03248a08273a0f23b9",
      "original_line" : 2326,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 32,
      "pull_request_review_id" : 694327034,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-28T19:38:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/660065213",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r660065396"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/660065396"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Restructured the code",
      "commit_id" : "3efaf83c75cd8dc2fa084537b8ed6715fb58c04d",
      "created_at" : "2021-06-28T19:39:09Z",
      "diff_hunk" : "@@ -2280,3 +2286,38 @@ bool DescriptorScriptPubKeyMan::GetDescriptorString(std::string& out, bool priv)\n \n     return m_wallet_descriptor.descriptor->ToNormalizedString(provider, out, priv);\n }\n+\n+void DescriptorScriptPubKeyMan::UpdateWalletDescriptor(WalletDescriptor& descriptor)\n+{\n+    LOCK(cs_desc_man);\n+    std::string error;\n+    if (!CanUpdateToWalletDescriptor(descriptor, error)) {\n+        throw std::runtime_error(std::string(__func__) + \": \" + error);\n+    }\n+\n+    m_map_pubkeys.clear();\n+    m_map_script_pub_keys.clear();\n+    m_max_cached_index = -1;\n+    m_wallet_descriptor = descriptor;\n+}\n+\n+bool DescriptorScriptPubKeyMan::CanUpdateToWalletDescriptor(const WalletDescriptor& descriptor, std::string& error)\n+{\n+    LOCK(cs_desc_man);\n+    if (!HasWalletDescriptor(descriptor)) {\n+        error = \"can only update matching descriptor\";\n+        return false;\n+    }\n+    // Use inclusive range for error\n+    auto range = strprintf(\"current range = [%d,%d]\", m_wallet_descriptor.range_start, m_wallet_descriptor.range_end-1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r660065396",
      "id" : 660065396,
      "in_reply_to_id" : 657902265,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDA2NTM5Ng==",
      "original_commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "original_line" : 2312,
      "original_position" : 40,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 694327278,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-28T19:39:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/660065396",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r660065977"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/660065977"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This is just a guard and should be never hit unless there is a logical error in the code.\r\nReplaced with Assert and added a comment",
      "commit_id" : "3efaf83c75cd8dc2fa084537b8ed6715fb58c04d",
      "created_at" : "2021-06-28T19:40:09Z",
      "diff_hunk" : "@@ -4625,12 +4625,38 @@ void CWallet::AddActiveScriptPubKeyMan(uint256 id, OutputType type, bool interna\n \n void CWallet::LoadActiveScriptPubKeyMan(uint256 id, OutputType type, bool internal)\n {\n+    if (!IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {\n+        throw std::runtime_error(\"Cannot LoadActiveScriptPubKeyMan to a non-descriptor wallet\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r660065977",
      "id" : 660065977,
      "in_reply_to_id" : 657921395,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDA2NTk3Nw==",
      "original_commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "original_line" : 4629,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 694328082,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-28T19:40:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/660065977",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r660066294"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/660066294"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hm... thanks for pointing to that. Now looked back at that piece, I decided it's better to just drop it.",
      "commit_id" : "3efaf83c75cd8dc2fa084537b8ed6715fb58c04d",
      "created_at" : "2021-06-28T19:40:43Z",
      "diff_hunk" : "@@ -1564,16 +1563,19 @@ static UniValue ProcessDescriptorImport(CWallet& wallet, const UniValue& data, c\n             } else {\n                 wallet.AddActiveScriptPubKeyMan(spk_manager->GetID(), *w_desc.descriptor->GetOutputType(), internal);\n             }\n+        } else {\n+            if (w_desc.descriptor->GetOutputType()) {\n+                wallet.DeactivateScriptPubKeyMan(spk_manager->GetID(), *w_desc.descriptor->GetOutputType(), internal);\n+            }\n         }\n \n         result.pushKV(\"success\", UniValue(true));\n     } catch (const UniValue& e) {\n         result.pushKV(\"success\", UniValue(false));\n         result.pushKV(\"error\", e);\n-    } catch (...) {\n+    } catch (const std::runtime_error& e) {\n         result.pushKV(\"success\", UniValue(false));\n-\n-        result.pushKV(\"error\", JSONRPCError(RPC_MISC_ERROR, \"Missing required fields\"));\n+        result.pushKV(\"error\", JSONRPCError(RPC_MISC_ERROR, e.what()));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r660066294",
      "id" : 660066294,
      "in_reply_to_id" : 657922805,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDA2NjI5NA==",
      "original_commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "original_line" : 1578,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 694328508,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-28T19:40:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/660066294",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r660066750"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/660066750"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This is covered in the test section under \"Check we can change descriptor internal flag\"",
      "commit_id" : "3efaf83c75cd8dc2fa084537b8ed6715fb58c04d",
      "created_at" : "2021-06-28T19:41:33Z",
      "diff_hunk" : "@@ -4478,10 +4478,15 @@ void CWallet::LoadActiveScriptPubKeyMan(uint256 id, OutputType type, bool intern\n {\n     WalletLogPrintf(\"Setting spkMan to active: id = %s, type = %d, internal = %d\\n\", id.ToString(), static_cast<int>(type), static_cast<int>(internal));\n     auto& spk_mans = internal ? m_internal_spk_managers : m_external_spk_managers;\n+    auto& spk_mans_other = internal ? m_external_spk_managers : m_internal_spk_managers;\n     auto spk_man = m_spk_managers.at(id).get();\n     spk_man->SetInternal(internal);\n     spk_mans[type] = spk_man;\n \n+    if (spk_mans_other[type] == spk_man) {\n+        spk_mans_other[type] = nullptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r660066750",
      "id" : 660066750,
      "in_reply_to_id" : 474790348,
      "line" : 3168,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDA2Njc1MA==",
      "original_commit_id" : "b34664c1f480f0e75e8e2da9eb59128e0c4b734c",
      "original_line" : 3168,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 16,
      "pull_request_review_id" : 694329108,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-28T19:41:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/660066750",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r660066894"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/660066894"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "done",
      "commit_id" : "3efaf83c75cd8dc2fa084537b8ed6715fb58c04d",
      "created_at" : "2021-06-28T19:41:46Z",
      "diff_hunk" : "@@ -209,6 +209,12 @@ bool WalletBatch::WriteActiveScriptPubKeyMan(uint8_t type, const uint256& id, bo\n     return WriteIC(make_pair(key, type), id);\n }\n \n+bool WalletBatch::EraseActiveScriptPubKeyMan(uint8_t type, bool internal)\n+{\n+    std::string key = internal ? DBKeys::ACTIVEINTERNALSPK : DBKeys::ACTIVEEXTERNALSPK;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r660066894",
      "id" : 660066894,
      "in_reply_to_id" : 657936021,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDA2Njg5NA==",
      "original_commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "original_line" : 214,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 694329258,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-28T19:41:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/660066894",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r660067321"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/660067321"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This is covered in the section \"Check can deactivate active descriptor\". You can try deleting this lines and the test will fail",
      "commit_id" : "3efaf83c75cd8dc2fa084537b8ed6715fb58c04d",
      "created_at" : "2021-06-28T19:42:23Z",
      "diff_hunk" : "@@ -1564,16 +1563,19 @@ static UniValue ProcessDescriptorImport(CWallet& wallet, const UniValue& data, c\n             } else {\n                 wallet.AddActiveScriptPubKeyMan(spk_manager->GetID(), *w_desc.descriptor->GetOutputType(), internal);\n             }\n+        } else {\n+            if (w_desc.descriptor->GetOutputType()) {\n+                wallet.DeactivateScriptPubKeyMan(spk_manager->GetID(), *w_desc.descriptor->GetOutputType(), internal);\n+            }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r660067321",
      "id" : 660067321,
      "in_reply_to_id" : 657941768,
      "line" : 1590,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDA2NzMyMQ==",
      "original_commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "original_line" : 1590,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 19,
      "pull_request_review_id" : 694329771,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-28T19:42:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/660067321",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r660067648"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/660067648"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Idk how to cover this. One need to introduce a low-level database error to hit this line. I'm not sure it's worth it",
      "commit_id" : "3efaf83c75cd8dc2fa084537b8ed6715fb58c04d",
      "created_at" : "2021-06-28T19:42:59Z",
      "diff_hunk" : "@@ -4625,12 +4625,38 @@ void CWallet::AddActiveScriptPubKeyMan(uint256 id, OutputType type, bool interna\n \n void CWallet::LoadActiveScriptPubKeyMan(uint256 id, OutputType type, bool internal)\n {\n+    if (!IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {\n+        throw std::runtime_error(\"Cannot LoadActiveScriptPubKeyMan to a non-descriptor wallet\\n\");\n+    }\n+\n     WalletLogPrintf(\"Setting spkMan to active: id = %s, type = %d, internal = %d\\n\", id.ToString(), static_cast<int>(type), static_cast<int>(internal));\n     auto& spk_mans = internal ? m_internal_spk_managers : m_external_spk_managers;\n+    auto& spk_mans_other = internal ? m_external_spk_managers : m_internal_spk_managers;\n     auto spk_man = m_spk_managers.at(id).get();\n     spk_man->SetInternal(internal);\n     spk_mans[type] = spk_man;\n \n+    if (spk_mans_other[type] == spk_man) {\n+        spk_mans_other[type] = nullptr;\n+    }\n+\n+    NotifyCanGetAddressesChanged();\n+}\n+\n+void CWallet::DeactivateScriptPubKeyMan(uint256 id, OutputType type, bool internal)\n+{\n+    auto spk_man = GetScriptPubKeyMan(type, internal);\n+    if (spk_man != nullptr && spk_man->GetID() == id) {\n+        WalletLogPrintf(\"Deactivate spkMan: id = %s, type = %d, internal = %d\\n\", id.ToString(), static_cast<int>(type), static_cast<int>(internal));\n+        WalletBatch batch(GetDatabase());\n+        if (!batch.EraseActiveScriptPubKeyMan(static_cast<uint8_t>(type), internal)) {\n+            throw std::runtime_error(std::string(__func__) + \": erasing active ScriptPubKeyMan id failed\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r660067648",
      "id" : 660067648,
      "in_reply_to_id" : 657939779,
      "line" : 3181,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDA2NzY0OA==",
      "original_commit_id" : "5d9670462219b8c753516bfbdc5c7fa23046cd07",
      "original_line" : 3181,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 29,
      "pull_request_review_id" : 694330191,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-28T19:42:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/660067648",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r660067782"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/660067782"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "3efaf83c75cd8dc2fa084537b8ed6715fb58c04d",
      "created_at" : "2021-06-28T19:43:14Z",
      "diff_hunk" : "@@ -1546,7 +1546,7 @@ static UniValue ProcessDescriptorImport(CWallet& wallet, const UniValue& data, c\n         auto existing_spk_manager = wallet.GetDescriptorScriptPubKeyMan(w_desc);\n         if (existing_spk_manager) {\n             if (!existing_spk_manager->CanUpdateToWalletDescriptor(w_desc, error)) {\n-                throw JSONRPCError(RPC_INVALID_PARAMS, error);\n+                throw JSONRPCError(RPC_INVALID_PARAMETER, error);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r660067782",
      "id" : 660067782,
      "in_reply_to_id" : 659156208,
      "line" : 1570,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDA2Nzc4Mg==",
      "original_commit_id" : "c90f0279404477b697eefeebf064c3b089d7729c",
      "original_line" : 1570,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 8,
      "pull_request_review_id" : 694330367,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-28T19:43:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/660067782",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "re-ACK 3efaf83c75cd8dc2fa084537b8ed6715fb58c04d",
      "created_at" : "2021-06-28T22:41:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#issuecomment-870093984",
      "id" : 870093984,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19651",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3MDA5Mzk4NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-28T22:41:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/870093984",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r660188858"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/660188858"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think a start could be to drop `To` from the name, so that it matches `UpdateWalletDescriptor` <-> `CanUpdateWalletDescriptor`",
      "commit_id" : "3efaf83c75cd8dc2fa084537b8ed6715fb58c04d",
      "created_at" : "2021-06-28T23:59:32Z",
      "diff_hunk" : "@@ -2280,3 +2286,38 @@ bool DescriptorScriptPubKeyMan::GetDescriptorString(std::string& out, bool priv)\n \n     return m_wallet_descriptor.descriptor->ToNormalizedString(provider, out, priv);\n }\n+\n+void DescriptorScriptPubKeyMan::UpdateWalletDescriptor(WalletDescriptor& descriptor)\n+{\n+    LOCK(cs_desc_man);\n+    std::string error;\n+    if (!CanUpdateToWalletDescriptor(descriptor, error)) {\n+        throw std::runtime_error(std::string(__func__) + \": \" + error);\n+    }\n+\n+    m_map_pubkeys.clear();\n+    m_map_script_pub_keys.clear();\n+    m_max_cached_index = -1;\n+    m_wallet_descriptor = descriptor;\n+}\n+\n+bool DescriptorScriptPubKeyMan::CanUpdateToWalletDescriptor(const WalletDescriptor& descriptor, std::string& error)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r660188858",
      "id" : 660188858,
      "in_reply_to_id" : 648852307,
      "line" : 2326,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDE4ODg1OA==",
      "original_commit_id" : "fed9eef48d53dd3256108b03248a08273a0f23b9",
      "original_line" : 2326,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 32,
      "pull_request_review_id" : 694483789,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-29T00:10:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/660188858",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3211283?v=4",
         "events_url" : "https://api.github.com/users/meshcollider/events{/privacy}",
         "followers_url" : "https://api.github.com/users/meshcollider/followers",
         "following_url" : "https://api.github.com/users/meshcollider/following{/other_user}",
         "gists_url" : "https://api.github.com/users/meshcollider/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/meshcollider",
         "id" : 3211283,
         "login" : "meshcollider",
         "node_id" : "MDQ6VXNlcjMyMTEyODM=",
         "organizations_url" : "https://api.github.com/users/meshcollider/orgs",
         "received_events_url" : "https://api.github.com/users/meshcollider/received_events",
         "repos_url" : "https://api.github.com/users/meshcollider/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/meshcollider/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/meshcollider/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/meshcollider"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r660681405"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/660681405"
         }
      },
      "author_association" : "MEMBER",
      "body" : "6737d965 suggestion, separate the salient from the redundant\r\n```diff\r\n-        self.test_importdesc({**range_request, \"range\": [5, 10]}, wallet=wpriv, success=False,\r\n-                             error_code=-8, error_message='new range must include current range = [0,20]')\r\n-        self.test_importdesc({**range_request, \"range\": [0, 10]}, wallet=wpriv, success=False,\r\n-                             error_code=-8, error_message='new range must include current range = [0,20]')\r\n-        self.test_importdesc({**range_request, \"range\": [5, 20]}, wallet=wpriv, success=False,\r\n-                             error_code=-8, error_message='new range must include current range = [0,20]')\r\n+        for r in [[5, 10], [0, 10], [5, 20]]:\r\n+            self.test_importdesc(req={**range_request, \"range\": r}, wallet=wpriv, success=False, error_code=-8, error_message=\"new range must include current range = [0,20]\")\r\n```\r\n",
      "commit_id" : "3efaf83c75cd8dc2fa084537b8ed6715fb58c04d",
      "created_at" : "2021-06-29T14:35:02Z",
      "diff_hunk" : "@@ -252,6 +255,39 @@ def run_test(self):\n         self.test_importdesc({\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": [0, 1000001]},\n                               success=False, error_code=-8, error_message='Range is too large')\n \n+        self.log.info(\"Verify we can only extend descriptor's range\")\n+        range_request = {\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": [5, 10], 'active': True}\n+        self.test_importdesc(range_request, wallet=wpriv, success=True)\n+        assert_equal(wpriv.getwalletinfo()['keypoolsize'], 6)\n+        self.test_importdesc({**range_request, \"range\": [0, 10]}, wallet=wpriv, success=True)\n+        assert_equal(wpriv.getwalletinfo()['keypoolsize'], 11)\n+        self.test_importdesc({**range_request, \"range\": [0, 20]}, wallet=wpriv, success=True)\n+        assert_equal(wpriv.getwalletinfo()['keypoolsize'], 21)\n+        # Can keep range the same\n+        self.test_importdesc({**range_request, \"range\": [0, 20]}, wallet=wpriv, success=True)\n+        assert_equal(wpriv.getwalletinfo()['keypoolsize'], 21)\n+\n+        self.test_importdesc({**range_request, \"range\": [5, 10]}, wallet=wpriv, success=False,\n+                             error_code=-8, error_message='new range must include current range = [0,20]')\n+        self.test_importdesc({**range_request, \"range\": [0, 10]}, wallet=wpriv, success=False,\n+                             error_code=-8, error_message='new range must include current range = [0,20]')\n+        self.test_importdesc({**range_request, \"range\": [5, 20]}, wallet=wpriv, success=False,\n+                             error_code=-8, error_message='new range must include current range = [0,20]')",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r660681405",
      "id" : 660681405,
      "line" : 275,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDY4MTQwNQ==",
      "original_commit_id" : "3efaf83c75cd8dc2fa084537b8ed6715fb58c04d",
      "original_line" : 275,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "test/functional/wallet_importdescriptors.py",
      "position" : 64,
      "pull_request_review_id" : 695122157,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-29T14:45:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/660681405",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r660686059"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/660686059"
         }
      },
      "author_association" : "MEMBER",
      "body" : "bf68ebc formatting nit\r\n\r\n```diff\r\n         import_request = {\"desc\": descsum_create(\"pkh(\" + key.pubkey + \")\"),\r\n-                 \"timestamp\": \"now\",\r\n-                 \"label\": \"Descriptor import test\"}\r\n+                          \"timestamp\": \"now\",\r\n+                          \"label\": \"Descriptor import test\"}\r\n```\r\n\r\nor\r\n\r\n```diff\r\n-        import_request = {\"desc\": descsum_create(\"pkh(\" + key.pubkey + \")\"),\r\n-                 \"timestamp\": \"now\",\r\n-                 \"label\": \"Descriptor import test\"}\r\n+        import_request = {\r\n+            \"desc\": descsum_create(\"pkh(\" + key.pubkey + \")\"),\r\n+            \"timestamp\": \"now\",\r\n+            \"label\": \"Descriptor import test\",\r\n+        }\r\n```\r\n",
      "commit_id" : "3efaf83c75cd8dc2fa084537b8ed6715fb58c04d",
      "created_at" : "2021-06-29T14:39:42Z",
      "diff_hunk" : "@@ -89,22 +88,26 @@ def run_test(self):\n         # # Test importing of a P2PKH descriptor\n         key = get_generate_key()\n         self.log.info(\"Should import a p2pkh descriptor\")\n-        self.test_importdesc({\"desc\": descsum_create(\"pkh(\" + key.pubkey + \")\"),\n-                              \"timestamp\": \"now\",\n-                              \"label\": \"Descriptor import test\"},\n-                             success=True)\n+        import_request = {\"desc\": descsum_create(\"pkh(\" + key.pubkey + \")\"),\n+                 \"timestamp\": \"now\",\n+                 \"label\": \"Descriptor import test\"}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r660686059",
      "id" : 660686059,
      "line" : 93,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDY4NjA1OQ==",
      "original_commit_id" : "3efaf83c75cd8dc2fa084537b8ed6715fb58c04d",
      "original_line" : 93,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "test/functional/wallet_importdescriptors.py",
      "position" : 18,
      "pull_request_review_id" : 695122157,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-29T14:45:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/660686059",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r660687203"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/660687203"
         }
      },
      "author_association" : "MEMBER",
      "body" : "6737d96 readability nit\r\n```diff\r\n         self.log.info(\"Verify we can only extend descriptor's range\")\r\n         range_request = {\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": [5, 10], 'active': True}\r\n+\r\n         self.test_importdesc(range_request, wallet=wpriv, success=True)\r\n         assert_equal(wpriv.getwalletinfo()['keypoolsize'], 6)\r\n+\r\n         self.test_importdesc({**range_request, \"range\": [0, 10]}, wallet=wpriv, success=True)\r\n         assert_equal(wpriv.getwalletinfo()['keypoolsize'], 11)\r\n+\r\n         self.test_importdesc({**range_request, \"range\": [0, 20]}, wallet=wpriv, success=True)\r\n         assert_equal(wpriv.getwalletinfo()['keypoolsize'], 21)\r\n+\r\n         # Can keep range the same\r\n         self.test_importdesc({**range_request, \"range\": [0, 20]}, wallet=wpriv, success=True)\r\n         assert_equal(wpriv.getwalletinfo()['keypoolsize'], 21)\r\n```\r\n",
      "commit_id" : "3efaf83c75cd8dc2fa084537b8ed6715fb58c04d",
      "created_at" : "2021-06-29T14:40:54Z",
      "diff_hunk" : "@@ -252,6 +255,39 @@ def run_test(self):\n         self.test_importdesc({\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": [0, 1000001]},\n                               success=False, error_code=-8, error_message='Range is too large')\n \n+        self.log.info(\"Verify we can only extend descriptor's range\")\n+        range_request = {\"desc\": descsum_create(desc), \"timestamp\": \"now\", \"range\": [5, 10], 'active': True}\n+        self.test_importdesc(range_request, wallet=wpriv, success=True)\n+        assert_equal(wpriv.getwalletinfo()['keypoolsize'], 6)\n+        self.test_importdesc({**range_request, \"range\": [0, 10]}, wallet=wpriv, success=True)\n+        assert_equal(wpriv.getwalletinfo()['keypoolsize'], 11)\n+        self.test_importdesc({**range_request, \"range\": [0, 20]}, wallet=wpriv, success=True)\n+        assert_equal(wpriv.getwalletinfo()['keypoolsize'], 21)\n+        # Can keep range the same\n+        self.test_importdesc({**range_request, \"range\": [0, 20]}, wallet=wpriv, success=True)\n+        assert_equal(wpriv.getwalletinfo()['keypoolsize'], 21)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r660687203",
      "id" : 660687203,
      "line" : 268,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDY4NzIwMw==",
      "original_commit_id" : "3efaf83c75cd8dc2fa084537b8ed6715fb58c04d",
      "original_line" : 268,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "test/functional/wallet_importdescriptors.py",
      "position" : 57,
      "pull_request_review_id" : 695122157,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-29T14:45:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/660687203",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   }
]
