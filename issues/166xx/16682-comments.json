[
   {
      "author_association" : "MEMBER",
      "body" : "Observed while testing #15759 and suggested by @ajtowns : https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-523733587",
      "created_at" : "2019-08-22T15:36:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16682#issuecomment-523958559",
      "id" : 523958559,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16682",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyMzk1ODU1OQ==",
      "updated_at" : "2019-08-22T15:36:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/523958559",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "tACK 0e7bc2fba706a8b2483e030eff137c20a61f7eb4",
      "created_at" : "2019-08-22T15:45:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16682#issuecomment-523962338",
      "id" : 523962338,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16682",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyMzk2MjMzOA==",
      "updated_at" : "2019-08-22T15:58:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/523962338",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Can you check for the `PF_NOBAN` permissions so you don't ban whitelisted peer?",
      "created_at" : "2019-08-22T16:04:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16682#issuecomment-523969971",
      "id" : 523969971,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16682",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyMzk2OTk3MQ==",
      "updated_at" : "2019-08-22T16:04:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/523969971",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/3020646?v=4",
         "events_url" : "https://api.github.com/users/NicolasDorier/events{/privacy}",
         "followers_url" : "https://api.github.com/users/NicolasDorier/followers",
         "following_url" : "https://api.github.com/users/NicolasDorier/following{/other_user}",
         "gists_url" : "https://api.github.com/users/NicolasDorier/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/NicolasDorier",
         "id" : 3020646,
         "login" : "NicolasDorier",
         "node_id" : "MDQ6VXNlcjMwMjA2NDY=",
         "organizations_url" : "https://api.github.com/users/NicolasDorier/orgs",
         "received_events_url" : "https://api.github.com/users/NicolasDorier/received_events",
         "repos_url" : "https://api.github.com/users/NicolasDorier/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/NicolasDorier/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/NicolasDorier/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/NicolasDorier"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Can you check for the `PF_NOBAN` permissions so you don't ban whitelisted peer?\r\n\r\n`Misbehaving` sets `fShouldBan`, which is checked in `PeerLogicValidation::SendRejectsAndCheckIfBanned`, and `PF_NOBAN` is checked before applying the ban.",
      "created_at" : "2019-08-22T16:07:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16682#issuecomment-523970959",
      "id" : 523970959,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16682",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyMzk3MDk1OQ==",
      "updated_at" : "2019-08-22T16:10:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/523970959",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Why would spy nodes claim to be blocksonly? To not get asked for txs?",
      "created_at" : "2019-08-22T16:23:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16682#issuecomment-523977294",
      "id" : 523977294,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16682",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyMzk3NzI5NA==",
      "updated_at" : "2019-08-22T16:23:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/523977294",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Why would spy nodes claim to be blocksonly? To not get asked for txs?\r\n\r\nSorry, my explanation was unclear. Let me try again:\r\n\r\n1. I start my node in `-blocksonly`\r\n2. I make up to 8 outbound connections, with [fRelay](https://github.com/bitcoin/bips/blob/master/bip-0037.mediawiki#Extensions_to_existing_messages) set to False.\r\n3. Most peers (including most Satoshi:0.18.0 peers) honor that relay=False request and don't send me tx INVs. However, some of my outbound connections *do* send me tx INVs in violation of my request to not relay transactions. Those peers also have subver set to Satoshi:0.18.0. Even if I disconnect and reconnect to those peers, they continue to send me tx INVs.\r\n\r\nExplanations:\r\n- there's a bug in Bitcoin Core v0.18 that under some circumstances makes them disregard fRelay=False. I've looked at the VERSION deserialization and net_processing logic and find this unlikely.\r\n- they aren't really Bitcoin Core 0.18 nodes and are just masquerading as such. They haven't implemented the relay logic properly.\r\n\r\nThe peers that I found that do this are on the spylist here: https://people.xiph.org/~greg/banlist.cli.txt",
      "created_at" : "2019-08-22T16:32:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16682#issuecomment-523980420",
      "id" : 523980420,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16682",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyMzk4MDQyMA==",
      "updated_at" : "2019-08-22T16:32:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/523980420",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I think the nomenclature is a bit messed up. The pull request title should probably read \"non-tx-relay\" instead of \"blocks-only\"?\r\n\r\nOr \"Disconnect peer that send us tx INVs when we opted out of tx relay\"",
      "created_at" : "2019-08-22T16:33:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16682#issuecomment-523980818",
      "id" : 523980818,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16682",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyMzk4MDgxOA==",
      "updated_at" : "2019-08-22T16:37:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/523980818",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I have negative feelings about this as it violates the robustness principle. If at some point in the future there is a bug which causes us to relay an occasional tx, it ends up disconnecting blocks only peers.",
      "created_at" : "2019-08-22T17:10:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16682#issuecomment-523994184",
      "id" : 523994184,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16682",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyMzk5NDE4NA==",
      "updated_at" : "2019-08-22T17:10:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/523994184",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> If at some point in the future there is a bug which causes us to relay an occasional tx\r\n\r\nThe main reason to run `-blocksonly` is to reduce bandwidth usage. If adversaries can waste our bandwidth by sending us (what is to us) garbage, then we should disconnect them.\r\n\r\nI think your argument could be made against any disconnect behaviour: if at some point in the future there's a bug that makes us send a bad message to a peer, then we might get disconnected.",
      "created_at" : "2019-08-22T17:40:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16682#issuecomment-524005629",
      "id" : 524005629,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16682",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyNDAwNTYyOQ==",
      "updated_at" : "2019-08-22T17:40:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/524005629",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't agree. The recent blocksonly changes as presented in https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-523733587 is as a topology privacy benefit. Modifying this logic doesn't just affect nodes running with blocksonly with that change in mind, it affects all nodes. (I'm not sure if you intend this PR to be standalone from that one or not)\r\n\r\nI think the right thing to do would be, for example, to downgrade the connection to a non-blocksonly connection rather than disconnect and try finding a new blocksonly peer.\r\n\r\n\r\nDisagreement nonwithstanding, IIRC there is software which will send unsolicited TX messages as well, so you may want to look into handling peers who send those as well.",
      "created_at" : "2019-08-22T18:08:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16682#issuecomment-524015909",
      "id" : 524015909,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16682",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyNDAxNTkwOQ==",
      "updated_at" : "2019-08-22T18:08:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/524015909",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Modifying this logic doesn't just affect nodes running with blocksonly with that change in mind, it affects all nodes. (I'm not sure if you intend this PR to be standalone from that one or not)\r\n\r\nCorrect, but it only affects the two outbound blocks-only peers in that PR. The new behaviour would be to disconnect those blocks-only peers that are misbehaving and make new blocks-only peers. Given that the part of the justification for that PR was that the additional blocks-only peers would not cause too much additional resource usage, I think it's reasonable to disconnect them if they're wasting our bandwidth\r\n\r\n> I think the right thing to do would be, for example, to downgrade the connection to a non-blocksonly connection rather than disconnect and try finding a new blocksonly peer.\r\n\r\nI disagree:\r\n- for a full `blocksonly` node, there are no non-blocksonly peers. Are you saying we should disregard the user's wishes and keep these connections as tx relay peers?\r\n- for 15759, the tx relay datastructures aren't initialized for blocks-only peers (to save memory). If we changed those blocks-only peers to be tx relay peers, we'd need to add those tx relay datastructures later. That makes the code more complex, and invalidates the resource-usage argument in that PR (since we might just end up with 10 full tx relay peers).\r\n\r\n> Disagreement nonwithstanding, IIRC there is software which will send unsolicited TX messages as well, so you may want to look into handling peers who send those as well.\r\n\r\nThanks! I've updated this PR to also ban peers which relay TX messages to us when we've set relay=False.",
      "created_at" : "2019-08-22T18:59:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16682#issuecomment-524033842",
      "id" : 524033842,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16682",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyNDAzMzg0Mg==",
      "updated_at" : "2019-08-22T18:59:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/524033842",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Only a quick github review, but looks fine to me; maybe mark blocksonly peers as misbehaving if they send a TX/WTX GETDATA as well though? Oh, per travis you need to hold cs_main before calling Misbehaving in the NetMsgType::TX case.\r\n\r\nI think I'd be more confident that this was a safe change to make if we merged #15759 first and could look through our logs to see how often the two blocks-only peers of any random node see this sort of misbehaviour?\r\n\r\nI think as much as avoiding wasting bandwidth, there's an argument for this sort of change from the POV of tolerating protocol misbehaviour isn't good for the quality of the software ecosystem, a la https://tools.ietf.org/html/draft-iab-protocol-maintenance-01 . Even if that only results in higher quality spy nodes, I guess that's still an improvement...\r\n\r\nAlternatively/longer-term, we could perhaps extend `m_protect` to support a \"keep working if things are at all recoverable, just in case everyone's failing in the same ways\" fallback behaviour. Something like:\r\n\r\n * mark your first four full outbound peers and first blocks only outbound peer as `m_protect`\r\n * when peers do something bad, but recoverable, if they're marked `m_protect` just set a `questionable` flag, rather than immediately disconnecting them\r\n * every ~60min on a poisson timer, if you've got a `questionable==true` peer, and have another `m_protect=false` peer of the same class that's been connected for >20min, disconnect the questionable peer and mark the other peer as `m_protect`\r\n\r\nThough even that only protects you from disconnecting your outbound nodes, it doesn't prevent them from disconnecting you as an inbound node if your client is misbehaving. But if it's your client misbehaving at least you have some chance of being able to fix that directly. Could protect some of your inbound nodes too, I guess, but that doesn't seem very robust to adversarial behaviour.",
      "created_at" : "2019-08-23T02:53:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16682#issuecomment-524152582",
      "id" : 524152582,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16682",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyNDE1MjU4Mg==",
      "updated_at" : "2019-08-23T02:53:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/524152582",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK - the discussion here makes sense to me, but I'm not as qualified as @ajtowns / @sdaftuar etc to comment on this.\r\n\r\nThis is failing to build on [Travis macOS](https://travis-ci.org/bitcoin/bitcoin/jobs/575487702):\r\n```bash\r\nnet_processing.cpp:2476:13: error: calling function 'Misbehaving' requires holding mutex 'cs_main' exclusively [-Werror,-Wthread-safety-analysis]\r\n\r\n            Misbehaving(pfrom->GetId(), 100, strprintf(\"Blocks-only peer %d sent us transaction in violation of protocol\\n\", pfrom->GetId()));\r\n            ^\r\nnet_processing.cpp:2476:13: error: calling function 'Misbehaving' requires holding mutex 'cs_main' exclusively [-Werror,-Wthread-safety-analysis]\r\n2 errors generated.\r\nMakefile:7563: recipe for target 'libbitcoin_server_a-net_processing.o' failed\r\n```",
      "created_at" : "2019-08-23T03:44:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16682#issuecomment-524161256",
      "id" : 524161256,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16682",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyNDE2MTI1Ng==",
      "updated_at" : "2019-08-23T04:15:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/524161256",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I think the bandwidth exhaustion argument is weak given that there's still numerous other messages (e.g., ping, pong, notfound, etc) which can be sent in blocksonly mode (unless you plan to block those too?). \r\n\r\nI'd much rather think about bandwidth issues as a more general concept and actually track the bandwidth usage from a node and disconnect if it exceeds a limit of 'not useful' data over a certain period... We can track the `nTotalBytesRecv` and then count the `nTotalBytesOfBlocksRecvEpoch` and `nTotalBytesRecvEpoch` or something, and ban if we have excess non-block messages.\r\n\r\nThis is more of a whitelist approach (we count how much good stuff we're getting) v.s. a blacklist approach counting INVs as being bad while ignoring PINGs.",
      "created_at" : "2019-08-23T04:08:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16682#issuecomment-524164856",
      "id" : 524164856,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16682",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyNDE2NDg1Ng==",
      "updated_at" : "2019-08-23T04:08:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/524164856",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16682#discussion_r317280802"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16682"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/317280802"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The peer isn't blocks-only, we are...",
      "commit_id" : "1c6fb2da6527531d6466aa8d1470e75a1ed28413",
      "created_at" : "2019-08-23T19:55:23Z",
      "diff_hunk" : "@@ -2254,7 +2254,7 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n             {\n                 pfrom->AddInventoryKnown(inv);\n                 if (fBlocksOnly) {\n-                    LogPrint(BCLog::NET, \"transaction (%s) inv sent in violation of protocol peer=%d\\n\", inv.hash.ToString(), pfrom->GetId());\n+                    Misbehaving(pfrom->GetId(), 100, strprintf(\"Blocks-only peer %d sent us transaction inv (%s) in violation of protocol\\n\", pfrom->GetId(), inv.hash.ToString()));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16682#discussion_r317280802",
      "id" : 317280802,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNzI4MDgwMg==",
      "original_commit_id" : "ae63975e9b276fafaead81dda30b33cac246bdff",
      "original_position" : 5,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 279194555,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16682",
      "updated_at" : "2019-10-29T21:08:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/317280802",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@ajtowns \r\n> per travis you need to hold cs_main before calling Misbehaving\r\n\r\nFixed.\r\n\r\n> I think I'd be more confident that this was a safe change to make if we merged #15759 first \r\n\r\nAgreed. This interacts with #15759 and it's more important for that to get in, so I'll mark this as WIP for now.\r\n\r\n> maybe mark blocksonly peers as misbehaving if they send a TX/WTX GETDATA as well though?\r\n\r\nDone.\r\n\r\n@ajtowns / @JeremyRubin \r\n> Alternatively/longer-term, we could perhaps...\r\n\r\n> I'd much rather think about bandwidth issues as a more general concept...\r\n\r\nI don't think this small, focused fix precludes us from doing anything smarter long term. Happy to have those discussions, but I think this PR should be judged on whether it makes a small, incremental improvement (which I argue it does).",
      "created_at" : "2019-08-23T22:14:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16682#issuecomment-524478834",
      "id" : 524478834,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16682",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyNDQ3ODgzNA==",
      "updated_at" : "2019-08-23T22:14:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/524478834",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#17303](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/17303.html) (p2p: Stop relaying non-mempool txs by MarcoFalke)\n* [#16890](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16890.html) (rpc: Don't allow to 'estimatesmartfee' in blocksonly mode by darosior)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2019-08-24T05:41:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16682#issuecomment-524522634",
      "id" : 524522634,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16682",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyNDUyMjYzNA==",
      "updated_at" : "2019-10-30T09:17:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/524522634",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2019-09-07T11:32:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16682#issuecomment-529099966",
      "id" : 529099966,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16682",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyOTA5OTk2Ng==",
      "updated_at" : "2019-09-07T11:32:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/529099966",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "#15759 implemented parts of this, tough I think a more wholesale cleanup of this logic is still required.",
      "created_at" : "2019-09-07T17:47:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16682#issuecomment-529129713",
      "id" : 529129713,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16682",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyOTEyOTcxMw==",
      "updated_at" : "2019-09-07T17:47:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/529129713",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased on master, which makes the first two commits test-only changes.\r\n\r\nNote the test change in the final commit. Previously, there was a test \"Check that txs from rpc are not rejected and relayed to other peers\". This is no longer possible, since when the node sends an INV to its peer, it'll be disconnected. Even if it isn't disconnected and the peer responds with a TX GETDATA, then the node will disconnect its peer for sending that GETDATA.",
      "created_at" : "2019-09-10T12:54:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16682#issuecomment-529920593",
      "id" : 529920593,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16682",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyOTkyMDU5Mw==",
      "updated_at" : "2019-09-10T12:54:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/529920593",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Commit message for first commit needs to be updated to reflect it's not a behaviour change anymore.\r\n\r\nWorth updating the test framework so we can have python-p2p nodes as block-relay-only outbound connections rather than just inbound connections as part of this PR? There's old commits from luke-jr that update the test framework in #10593 and I had an independant go at the same idea at https://github.com/ajtowns/bitcoin/commits/201909-p2poutbound.\r\n\r\nI'm not sure the \"txs from rpc not rejected and are relayed\" change makes sense -- this means you can't use a `-blocksonly` node for sending your own transactions, and worse if you tried that, it'll just silently fail without giving you any obvious errors? It might make sense to move the test into the `else` clause -- if you're in `-blocksonly` you'll only have RPC-submitted tx's in `mapRelay` anyway, so the `if` path should be fine, and this way you disconnect anyone prying pretty quickly?",
      "created_at" : "2019-09-11T07:18:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16682#issuecomment-530255072",
      "id" : 530255072,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16682",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUzMDI1NTA3Mg==",
      "updated_at" : "2019-09-11T07:18:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/530255072",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16682#discussion_r329357666"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16682"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/329357666"
         }
      },
      "author_association" : "MEMBER",
      "body" : "FWIW: after this removal `wait_for_tx` is no longer used.",
      "commit_id" : "1c6fb2da6527531d6466aa8d1470e75a1ed28413",
      "created_at" : "2019-09-29T15:17:54Z",
      "diff_hunk" : "@@ -39,24 +42,22 @@ def run_test(self):\n                 'scriptPubKey': prevtx['vout'][0]['scriptPubKey']['hex'],\n             }],\n         )['hex']\n-        assert_equal(self.nodes[0].getnetworkinfo()['localrelay'], False)\n-        with self.nodes[0].assert_debug_log(['transaction sent in violation of protocol peer=0']):\n-            self.nodes[0].p2p.send_message(msg_tx(FromHex(CTransaction(), sigtx)))\n-            self.nodes[0].p2p.wait_for_disconnect()\n-            assert_equal(self.nodes[0].getmempoolinfo()['size'], 0)\n-\n-        # Remove the disconnected peer and add a new one.\n-        del self.nodes[0].p2ps[0]\n-        self.nodes[0].add_p2p_connection(P2PInterface())\n-\n-        self.log.info('Check that txs from rpc are not rejected and relayed to other peers')\n-        assert_equal(self.nodes[0].getpeerinfo()[0]['relaytxes'], True)\n-        txid = self.nodes[0].testmempoolaccept([sigtx])[0]['txid']\n-        with self.nodes[0].assert_debug_log(['received getdata for: tx {} peer=1'.format(txid)]):\n-            self.nodes[0].sendrawtransaction(sigtx)\n-            self.nodes[0].p2p.wait_for_tx(txid)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16682#discussion_r329357666",
      "id" : 329357666,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMyOTM1NzY2Ng==",
      "original_commit_id" : "cff3323a7caec361ca37d7d98fcb9eca8d033266",
      "original_position" : 49,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : 65,
      "pull_request_review_id" : 294688411,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16682",
      "updated_at" : "2019-10-29T21:08:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/329357666",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@ajtowns \r\n> Commit message for first commit needs to be updated to reflect it's not a behaviour change anymore.\r\n\r\nDone. I thought the commit log gave more useful information than commit 0ba08020c9  that was merged, but you're right that it doesn't belong on this test-change-only commit.\r\n\r\n> Worth updating the test framework so we can have python-p2p nodes as block-relay-only outbound connections rather than just inbound connections as part of this PR?\r\n\r\nI think that's definitely worth doing, but it doesn't have to be as part of this PR. I'll happily review that change.\r\n\r\n> 'm not sure the \"txs from rpc not rejected and are relayed\" change makes sense [...] It might make sense to move the test into the else clause\r\n\r\nI've changed this so we only disconnect if the tx is not found in our mapRelay. Is that what you meant?",
      "created_at" : "2019-10-10T21:24:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16682#issuecomment-540805191",
      "id" : 540805191,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16682",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0MDgwNTE5MQ==",
      "updated_at" : "2019-10-10T21:24:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/540805191",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16682#discussion_r333742044"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16682"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/333742044"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've made some change to this PR, so `wait_for_tx` is still used.",
      "commit_id" : "1c6fb2da6527531d6466aa8d1470e75a1ed28413",
      "created_at" : "2019-10-10T21:24:41Z",
      "diff_hunk" : "@@ -39,24 +42,22 @@ def run_test(self):\n                 'scriptPubKey': prevtx['vout'][0]['scriptPubKey']['hex'],\n             }],\n         )['hex']\n-        assert_equal(self.nodes[0].getnetworkinfo()['localrelay'], False)\n-        with self.nodes[0].assert_debug_log(['transaction sent in violation of protocol peer=0']):\n-            self.nodes[0].p2p.send_message(msg_tx(FromHex(CTransaction(), sigtx)))\n-            self.nodes[0].p2p.wait_for_disconnect()\n-            assert_equal(self.nodes[0].getmempoolinfo()['size'], 0)\n-\n-        # Remove the disconnected peer and add a new one.\n-        del self.nodes[0].p2ps[0]\n-        self.nodes[0].add_p2p_connection(P2PInterface())\n-\n-        self.log.info('Check that txs from rpc are not rejected and relayed to other peers')\n-        assert_equal(self.nodes[0].getpeerinfo()[0]['relaytxes'], True)\n-        txid = self.nodes[0].testmempoolaccept([sigtx])[0]['txid']\n-        with self.nodes[0].assert_debug_log(['received getdata for: tx {} peer=1'.format(txid)]):\n-            self.nodes[0].sendrawtransaction(sigtx)\n-            self.nodes[0].p2p.wait_for_tx(txid)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16682#discussion_r333742044",
      "id" : 333742044,
      "in_reply_to_id" : 329357666,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMzMzc0MjA0NA==",
      "original_commit_id" : "cff3323a7caec361ca37d7d98fcb9eca8d033266",
      "original_position" : 49,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : 65,
      "pull_request_review_id" : 300360973,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16682",
      "updated_at" : "2019-10-29T21:08:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/333742044",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "The macos linter is complaining about a commit that isn't part of this PR and I have no idea why. Rebasing on master to try to resolve.",
      "created_at" : "2019-10-11T16:14:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16682#issuecomment-541128335",
      "id" : 541128335,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16682",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0MTEyODMzNQ==",
      "updated_at" : "2019-10-11T16:14:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/541128335",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I think the linter should be removed when it is causing issues. It was added only for experimentation.",
      "created_at" : "2019-10-11T17:26:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16682#issuecomment-541153055",
      "id" : 541153055,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16682",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0MTE1MzA1NQ==",
      "updated_at" : "2019-10-11T17:26:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/541153055",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Btcd or Lnd also does this, and `bitcoind -blocksonly` already disconnect in that case. ~~Even when whitelisted, which is odd.~~ (unless you give it `relay` whitelist, in addition to the default `noban` and `mempool`).\r\n\r\nI noticed this while opening a channel using Lnd that was connected to my local `bitcoind -blocksonly` instance via p2p. It tried to broadcast the channel opening: `transaction (...) inv sent in violation of protocol, disconnecting peer=10`. cc @Roasbeef \r\n\r\nThe macOS linter is being removed in #17176 ",
      "created_at" : "2019-10-23T11:00:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16682#issuecomment-545389359",
      "id" : 545389359,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16682",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0NTM4OTM1OQ==",
      "updated_at" : "2019-10-23T11:22:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/545389359",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "@Sjors how is a client mean to detect that a backing node is on blocks only mode on the RPC level?  On the p2p end, iirc there's no node/p2p level signalling so nodes have no idea if they're meant to relay to another node or not. ",
      "created_at" : "2019-10-28T23:34:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16682#issuecomment-547191191",
      "id" : 547191191,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16682",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0NzE5MTE5MQ==",
      "updated_at" : "2019-10-28T23:34:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/547191191",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/998190?v=4",
         "events_url" : "https://api.github.com/users/Roasbeef/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Roasbeef/followers",
         "following_url" : "https://api.github.com/users/Roasbeef/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Roasbeef/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Roasbeef",
         "id" : 998190,
         "login" : "Roasbeef",
         "node_id" : "MDQ6VXNlcjk5ODE5MA==",
         "organizations_url" : "https://api.github.com/users/Roasbeef/orgs",
         "received_events_url" : "https://api.github.com/users/Roasbeef/received_events",
         "repos_url" : "https://api.github.com/users/Roasbeef/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Roasbeef/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Roasbeef/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Roasbeef"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@roasbeef p2p nodes can use the `relay` field in the VERSION message to indicate that they want a peer to relay transactions. See https://btcinformation.org/en/developer-reference#version.",
      "created_at" : "2019-10-29T00:58:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16682#issuecomment-547209618",
      "id" : 547209618,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16682",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0NzIwOTYxOA==",
      "updated_at" : "2019-10-29T00:58:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/547209618",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "TIL! Fixed in https://github.com/lightninglabs/neutrino/pull/190",
      "created_at" : "2019-10-29T01:51:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16682#issuecomment-547220089",
      "id" : 547220089,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16682",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0NzIyMDA4OQ==",
      "updated_at" : "2019-10-29T01:51:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/547220089",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/998190?v=4",
         "events_url" : "https://api.github.com/users/Roasbeef/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Roasbeef/followers",
         "following_url" : "https://api.github.com/users/Roasbeef/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Roasbeef/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Roasbeef",
         "id" : 998190,
         "login" : "Roasbeef",
         "node_id" : "MDQ6VXNlcjk5ODE5MA==",
         "organizations_url" : "https://api.github.com/users/Roasbeef/orgs",
         "received_events_url" : "https://api.github.com/users/Roasbeef/received_events",
         "repos_url" : "https://api.github.com/users/Roasbeef/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Roasbeef/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Roasbeef/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Roasbeef"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16682#discussion_r339932231"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16682"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/339932231"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "But we'll have already tried relaying from the mempool and set push to true in that case, causing this code path to only work if we didn't have the tx at all? Am I missing something?",
      "commit_id" : "1c6fb2da6527531d6466aa8d1470e75a1ed28413",
      "created_at" : "2019-10-29T08:01:43Z",
      "diff_hunk" : "@@ -1542,6 +1542,14 @@ void static ProcessGetData(CNode* pfrom, const CChainParams& chainparams, CConnm\n                 }\n             }\n             if (!push) {\n+                if (!g_relay_txes && !pfrom->HasPermission(PF_RELAY)) {\n+                    // If a blocks-only peer requests a tx and its not in our mapRelay, then disconnect them.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16682#discussion_r339932231",
      "id" : 339932231,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMzOTkzMjIzMQ==",
      "original_commit_id" : "dc84c42a69557bff3d41baea498ceee822566423",
      "original_position" : 5,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 308324367,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16682",
      "updated_at" : "2019-10-29T21:08:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/339932231",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16682#discussion_r340322905"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16682"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340322905"
         }
      },
      "author_association" : "MEMBER",
      "body" : "no, you're not missing anything. You're completely right.\r\n\r\nI think this logic needs to be moved up between the `if (mi != mapRelay.end())` block and `else if (pfrom->m_tx_relay->m_last_mempool_req.load().count())`. I've done that in https://github.com/bitcoin/bitcoin/compare/dc84c42a69557bff3d41baea498ceee822566423..dffa26f05fca414ecd2e72c6c9a7efc953d54651. Let me know what you think.",
      "commit_id" : "1c6fb2da6527531d6466aa8d1470e75a1ed28413",
      "created_at" : "2019-10-29T21:00:58Z",
      "diff_hunk" : "@@ -1542,6 +1542,14 @@ void static ProcessGetData(CNode* pfrom, const CChainParams& chainparams, CConnm\n                 }\n             }\n             if (!push) {\n+                if (!g_relay_txes && !pfrom->HasPermission(PF_RELAY)) {\n+                    // If a blocks-only peer requests a tx and its not in our mapRelay, then disconnect them.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16682#discussion_r340322905",
      "id" : 340322905,
      "in_reply_to_id" : 339932231,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDMyMjkwNQ==",
      "original_commit_id" : "dc84c42a69557bff3d41baea498ceee822566423",
      "original_position" : 5,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 308831027,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16682",
      "updated_at" : "2019-10-29T21:08:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340322905",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "That change caused a conflict with master so I've rebased.",
      "created_at" : "2019-10-29T21:08:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16682#issuecomment-547630224",
      "id" : 547630224,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16682",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0NzYzMDIyNA==",
      "updated_at" : "2019-10-29T21:08:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/547630224",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16682#discussion_r341744179"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16682"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341744179"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I believe this is incorrect -- it should not be a protocol violation if we announce a transaction to a peer and it happens to wait more than 15 minutes to respond with a GETDATA.  This already happens for reasons that are benign (due to us not immediately requesting a transaction from all peers who announce it).  \r\n\r\nFor example: one way this can happen is if we announce a transaction to a peer, but it gets the announcement as well from other peers first and queues up a request to go to us far in the future, and in the meantime a block is found that includes the transaction as well as spends of its outputs, and then at some point when it's time for the peer to consider requesting the tx from us it has at that point forgotten about the tx completely and it'll re-request.  (This type of behavior is present in all the version of Bitcoin Core I can remember.)\r\n\r\nI think to do this right we would need to either track the tx's we've announced to a peer, or consider changing blocks-only behavior so that we never announce anything at all (which makes more logical sense to me, but I think others disagree, so probably a non-starter).",
      "commit_id" : "1c6fb2da6527531d6466aa8d1470e75a1ed28413",
      "created_at" : "2019-11-01T20:43:45Z",
      "diff_hunk" : "@@ -1538,6 +1538,13 @@ void static ProcessGetData(CNode* pfrom, const CChainParams& chainparams, CConnm\n             if (mi != mapRelay.end()) {\n                 connman->PushMessage(pfrom, msgMaker.Make(nSendFlags, NetMsgType::TX, *mi->second));\n                 push = true;\n+            } else if (!g_relay_txes && !pfrom->HasPermission(PF_RELAY)) {\n+                // If a blocks-only peer requests a tx and it isn't in our mapRelay, then disconnect them.\n+                // We allow blocks-only peers to request txs in our mapRelay so we can relay txs submitted\n+                // locally when in blocks-only mode.\n+                LogPrintf(\"Blocks-only peer %d sent us tx GETDATA in violation of protocol\\n\", pfrom->GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16682#discussion_r341744179",
      "id" : 341744179,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTc0NDE3OQ==",
      "original_commit_id" : "1c6fb2da6527531d6466aa8d1470e75a1ed28413",
      "original_position" : 8,
      "path" : "src/net_processing.cpp",
      "position" : 8,
      "pull_request_review_id" : 310686670,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16682",
      "updated_at" : "2019-11-01T20:43:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341744179",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ok, closing this. #15759 took the more important changes from this PR (disconnecting peers that send us TXs and tx INVs), and we can't seem to reach agreement on the remaining change:\r\n\r\n@ajtowns \r\n> I'm not sure the \"txs from rpc not rejected and are relayed\" change makes sense -- this means you can't use a -blocksonly node for sending your own transactions,\r\n\r\n@sdaftuar \r\n> changing blocks-only behavior so that we never announce anything at all (which makes more logical sense to me, but I think others disagree, so probably a non-starter).",
      "created_at" : "2019-11-01T20:52:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16682#issuecomment-548946770",
      "id" : 548946770,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16682",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0ODk0Njc3MA==",
      "updated_at" : "2019-11-01T20:52:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/548946770",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   }
]
