{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "MEMBER",
   "body" : "Following #17261, the way to sign transactions, PSBTs, and messages was to use `GetSigningProvider()` and get a `SigningProvider` containing the private keys. However this may not be feasible for future `ScriptPubKeyMan`s, such as for hardware wallets. Instead of exporting a `SigningProvider` containing private keys, we need to pass these things into the `ScriptPubKeyMan` (via `CWallet`) so that they can do whatever is needed internally to sign them. This is largely a refactor as the logic of processing transactions, PSBTs, and messages for is moved into `LegacyScriptPubKeyMan` and `CWallet` instead of being handled by the caller (e.g. `signrawtransaction`).\r\n\r\nTo help with this, I've refactored the 3(!) implementations of a `SignTransaction()` function into one generic one. This function will be called by `signrawtransactionwithkey` and `LegacyScriptPubKeyMan::SignTransaction()`. `CWallet::CreateTransaction()` is changed to call `CWallet::SignTransaction()` which in turn, calls `LegacyScriptPubKeyMan::SignTransaction()`. Other `ScriptPubKeyMan`s may implement `SignTransaction()` differently.\r\n\r\n`FillPSBT()` is moved to be a member function of `CWallet` and the `psbtwallet.cpp/h` files removed. It is further split so that `CWallet` handles filling the UTXOs while the `ScriptPubKeyMan` handles adding keys, derivation paths, scripts, and signatures. In the end `LegacyScriptPubKeyMan::FillPSBT` still calls `SignPSBTInput`, but the `SigningProvider` is internal to `LegacyScriptPubKeyMan`. Other `ScriptPubKeyMan`s may do something different.\r\n\r\nA new `SignMessage()` function is added to both `CWallet` and `ScriptPubKeyMan`. Instead of having the caller (i.e. `signmessage` or the sign message dialog) get the private key, hash the message, and sign, `ScriptPubKeyMan` will now handle that (`CWallet` passes through to the `ScriptPubKeyMan`s as it does for many functions). This signing code is thus consolidated into `LegacyScriptPubKeyMan::SignMessage()`, though other `ScriptPubKeyMan`s may implement it differently. Additionally, a `SigningError` enum is introduced for the different errors that we expect to see from `SignMessage()`.\r\n\r\nLastly, `GetSigningProvider()` is renamed to `GetPublicSigningProvider()`. It will now only provide pubkeys, key origins, and scripts. `LegacySigningProvider` has it's `GetKey` and `HaveKey` functions changed to only return false. Future implementations should return `HidingSigningProvider`s where private keys are hidden.\r\n\r\nOther things like `dumpprivkey` and `dumpwallet` are not changed because they directly need and access the `LegacyScriptPubKeyMan` so are not relevant to future changes.",
   "closed_at" : "2020-03-09T20:02:53Z",
   "closed_by" : {
      "avatar_url" : "https://avatars2.githubusercontent.com/u/3211283?v=4",
      "events_url" : "https://api.github.com/users/meshcollider/events{/privacy}",
      "followers_url" : "https://api.github.com/users/meshcollider/followers",
      "following_url" : "https://api.github.com/users/meshcollider/following{/other_user}",
      "gists_url" : "https://api.github.com/users/meshcollider/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/meshcollider",
      "id" : 3211283,
      "login" : "meshcollider",
      "node_id" : "MDQ6VXNlcjMyMTEyODM=",
      "organizations_url" : "https://api.github.com/users/meshcollider/orgs",
      "received_events_url" : "https://api.github.com/users/meshcollider/received_events",
      "repos_url" : "https://api.github.com/users/meshcollider/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/meshcollider/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/meshcollider/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/meshcollider"
   },
   "comments" : 21,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18115/comments",
   "created_at" : "2020-02-11T05:23:22Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18115/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/18115",
   "id" : 562984928,
   "labels" : [
      {
         "color" : "08a781",
         "default" : false,
         "description" : null,
         "id" : 149424,
         "name" : "Wallet",
         "node_id" : "MDU6TGFiZWwxNDk0MjQ=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Wallet"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18115/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDExOlB1bGxSZXF1ZXN0MzczNDc5NTA5",
   "number" : 18115,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/18115.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18115",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/18115.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18115"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "wallet: Pass in transactions and messages for signing instead of exporting the private keys",
   "updated_at" : "2020-03-09T20:02:53Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18115",
   "user" : {
      "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
      "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
      "followers_url" : "https://api.github.com/users/achow101/followers",
      "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/achow101",
      "id" : 3782274,
      "login" : "achow101",
      "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
      "organizations_url" : "https://api.github.com/users/achow101/orgs",
      "received_events_url" : "https://api.github.com/users/achow101/received_events",
      "repos_url" : "https://api.github.com/users/achow101/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/achow101"
   }
}
