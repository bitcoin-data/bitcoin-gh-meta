{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "MEMBER",
   "body" : "Kill the locale dependency bug class by not allowing Qt to mess with `LC_NUMERIC`.\r\n\r\nContext: #18124 (Recommended reading if you are unsure about how C and C++ locales work in C++)\r\n\r\n**Guaranteed locale settings before this PR:**\r\n\r\n| Program        | C locale category `LC_NUMERIC` | Global C++ locale (`std::locale`) |\r\n| ------------- | ------------- | ----- |\r\n| `bitcoind`      | `C` (classic) | `C` (classic) |\r\n| `bitcoin-qt`      | No guarantee - user-specified  | `C` (classic) |\r\n\r\n**Guaranteed locale settings after this PR:**\r\n\r\n| Program        | C locale category `LC_NUMERIC` | Global C++ locale (`std::locale`) |\r\n| ------------- | ------------- | ----- |\r\n| `bitcoind`      | `C` (classic) | `C` (classic) |\r\n| `bitcoin-qt`      | `C` (classic)  | `C` (classic) |\r\n\r\n**Background:**\r\n\r\nPerhaps surprisingly Qt runs `setlocale(LC_ALL, \"\")` on initialization. This installs the locale specified by the user's `LC_ALL` (or `LC_*`) environment variable as the new C locale.\r\n\r\nIn contrast `bitcoind` does not opt-in to localization -- no call to `setlocale(LC_ALL, \"\")` (or `std::locale::global(std::locale(\"\"))`) is made and the environment variables `LC_*` are thus ignored.\r\n\r\nThis results in an unfortunate situation where the `bitcoind` is guaranteed to be running with the classic locale (`\"C\"`) whereas the locale of `bitcoin-qt` will vary depending on the user's environment variables.\r\n\r\nAn example: Assuming the environment variable `LC_ALL=de_DE` then the call `std::to_string(1.23)` will return `\"1.230000\"` in `bitcoind` but `\"1,230000\"` in `bitcoin-qt`.\r\n\r\nFrom the [Qt documentation](https://doc.qt.io/qt-5/qcoreapplication.html):\r\n\r\n> \"On Unix/Linux Qt is configured to use the system locale settings by default. This can cause a conflict when using POSIX functions, for instance, when converting between data types such as floats and strings, since the notation may differ between locales. To get around this problem, call the POSIX function `setlocale(LC_NUMERIC,\"C\")` right after initializing `QApplication`, `QGuiApplication` or `QCoreApplication` to reset the locale that is used for number formatting to \"C\"-locale.\"\r\n\r\n---\r\n\r\nC and C++ locales 101:\r\n\r\n```c++\r\n#include <clocale>\r\n#include <cstdlib>\r\n#include <iostream>\r\n#include <locale>\r\n#include <sstream>\r\n#include <string>\r\n\r\nint main(void)\r\n{\r\n    std::cout << \"C locale at beginning of main: \" << std::string{setlocale(LC_ALL, nullptr)} << \"\\n\";\r\n    std::cout << \"C++ locale at beginning of main: \" << std::locale{}.name() << \"\\n\\n\";\r\n#if OPT_IN_TO_LOCALIZATION_USING_SET_LOCALE\r\n    setlocale(LC_ALL, \"\");\r\n#endif\r\n#if OPT_IN_TO_LOCALIZATION_USING_STD_LOCALE_GLOBAL\r\n    std::locale::global(std::locale(\"\"));\r\n#endif\r\n    std::ostringstream oss;\r\n    oss << 1000000;\r\n    std::cout << \"std::ostringstream oss; oss << 1000000; oss.str() equals \" << oss.str() << \"\\n\";\r\n    std::cout << \"std::to_string(1.23) equals \" << std::to_string(1.23) << \"\\n\\n\";\r\n    std::cout << \"C locale at end of main: \" << std::string{setlocale(LC_ALL, nullptr)} << \"\\n\";\r\n    std::cout << \"C++ locale at end of main: \" << std::locale{}.name() << \"\\n\\n\";\r\n    std::cout << \"setlocale(LC_COLLATE,  nullptr) (read-only operation) = \" << std::string{setlocale(LC_COLLATE, nullptr)} << \"\\n\";\r\n    std::cout << \"setlocale(LC_CTYPE,    nullptr) (read-only operation) = \" << std::string{setlocale(LC_CTYPE, nullptr)} << \"\\n\";\r\n    std::cout << \"setlocale(LC_MESSAGES, nullptr) (read-only operation) = \" << std::string{setlocale(LC_MESSAGES, nullptr)} << \"\\n\";\r\n    std::cout << \"setlocale(LC_MONETARY, nullptr) (read-only operation) = \" << std::string{setlocale(LC_MONETARY, nullptr)} << \"\\n\";\r\n    std::cout << \"setlocale(LC_NUMERIC,  nullptr) (read-only operation) = \" << std::string{setlocale(LC_NUMERIC, nullptr)} << \"\\n\";\r\n    std::cout << \"setlocale(LC_TIME,     nullptr) (read-only operation) = \" << std::string{setlocale(LC_TIME, nullptr)} << \"\\n\";\r\n}\r\n```\r\n\r\nLet's try with `LC_ALL=de_DE ./l8n` without any opt-in to locale dependence:\r\n\r\n```\r\n$ clang++ -o l8n l8n.cpp\r\n$ LC_ALL=de_DE ./l8n\r\nC locale at beginning of main: C\r\nC++ locale at beginning of main: C\r\n\r\nstd::ostringstream oss; oss << 1000000; oss.str() equals 1000000\r\nstd::to_string(1.23) equals 1.230000\r\n\r\nC locale at end of main: C\r\nC++ locale at end of main: C\r\n\r\nsetlocale(LC_COLLATE,  nullptr) (read-only operation) = C\r\nsetlocale(LC_CTYPE,    nullptr) (read-only operation) = C\r\nsetlocale(LC_MESSAGES, nullptr) (read-only operation) = C\r\nsetlocale(LC_MONETARY, nullptr) (read-only operation) = C\r\nsetlocale(LC_NUMERIC,  nullptr) (read-only operation) = C\r\nsetlocale(LC_TIME,     nullptr) (read-only operation) = C\r\n```\r\n\r\nLet's try with `LC_NUMERIC=de_DE ./l8n` without any opt-in to locale dependence:\r\n\r\n```\r\n$ clang++ -o l8n l8n.cpp\r\n$ LC_NUMERIC=de_DE ./l8n\r\nC locale at beginning of main: C\r\nC++ locale at beginning of main: C\r\n\r\nstd::ostringstream oss; oss << 1000000; oss.str() equals 1000000\r\nstd::to_string(1.23) equals 1.230000\r\n\r\nC locale at end of main: C\r\nC++ locale at end of main: C\r\n\r\nsetlocale(LC_COLLATE,  nullptr) (read-only operation) = C\r\nsetlocale(LC_CTYPE,    nullptr) (read-only operation) = C\r\nsetlocale(LC_MESSAGES, nullptr) (read-only operation) = C\r\nsetlocale(LC_MONETARY, nullptr) (read-only operation) = C\r\nsetlocale(LC_NUMERIC,  nullptr) (read-only operation) = C\r\nsetlocale(LC_TIME,     nullptr) (read-only operation) = C\r\n```\r\n\r\nLet's try `LC_ALL=de_DE ./l8n` with opt-in to locale dependence using `set_locale`:\r\n\r\n```\r\n$ clang++ -DOPT_IN_TO_LOCALIZATION_USING_SET_LOCALE -o l8n l8n.cpp\r\n$ LC_ALL=de_DE ./l8n\r\nC locale at beginning of main: C\r\nC++ locale at beginning of main: C\r\n\r\nstd::ostringstream oss; oss << 1000000; oss.str() equals 1000000\r\nstd::to_string(1.23) equals 1,230000\r\n\r\nC locale at end of main: de_DE\r\nC++ locale at end of main: C\r\n\r\nsetlocale(LC_COLLATE,  nullptr) (read-only operation) = de_DE\r\nsetlocale(LC_CTYPE,    nullptr) (read-only operation) = de_DE\r\nsetlocale(LC_MESSAGES, nullptr) (read-only operation) = de_DE\r\nsetlocale(LC_MONETARY, nullptr) (read-only operation) = de_DE\r\nsetlocale(LC_NUMERIC,  nullptr) (read-only operation) = de_DE\r\nsetlocale(LC_TIME,     nullptr) (read-only operation) = de_DE\r\n```\r\n\r\nLet's try `LC_ALL=de_DE ./l8n` with opt-in to locale dependence using `std::locale::global`:\r\n\r\n```\r\n$ clang++ -DOPT_IN_TO_LOCALIZATION_USING_STD_LOCALE_GLOBAL -o l8n l8n.cpp\r\n$ LC_ALL=de_DE ./l8n\r\nC locale at beginning of main: C\r\nC++ locale at beginning of main: C\r\n\r\nstd::ostringstream oss; oss << 1000000; oss.str() equals 1.000.000\r\nstd::to_string(1.23) equals 1,230000\r\n\r\nC locale at end of main: de_DE\r\nC++ locale at end of main: de_DE\r\n\r\nsetlocale(LC_COLLATE,  nullptr) (read-only operation) = de_DE\r\nsetlocale(LC_CTYPE,    nullptr) (read-only operation) = de_DE\r\nsetlocale(LC_MESSAGES, nullptr) (read-only operation) = de_DE\r\nsetlocale(LC_MONETARY, nullptr) (read-only operation) = de_DE\r\nsetlocale(LC_NUMERIC,  nullptr) (read-only operation) = de_DE\r\nsetlocale(LC_TIME,     nullptr) (read-only operation) = de_DE\r\n```",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 1,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18147/comments",
   "created_at" : "2020-02-14T15:33:16Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18147/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/18147",
   "id" : 565399058,
   "labels" : [
      {
         "color" : "02d7e1",
         "default" : false,
         "description" : null,
         "id" : 135946,
         "name" : "GUI",
         "node_id" : "MDU6TGFiZWwxMzU5NDY=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/GUI"
      },
      {
         "color" : "d4c5f9",
         "default" : false,
         "description" : null,
         "id" : 62963516,
         "name" : "Tests",
         "node_id" : "MDU6TGFiZWw2Mjk2MzUxNg==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Tests"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18147/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDExOlB1bGxSZXF1ZXN0Mzc1NDQ1MTgw",
   "number" : 18147,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/18147.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18147",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/18147.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18147"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "title" : "qt: Kill the locale dependency bug class by not allowing Qt to mess with LC_NUMERIC",
   "updated_at" : "2020-02-14T17:16:08Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18147",
   "user" : {
      "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
      "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
      "followers_url" : "https://api.github.com/users/practicalswift/followers",
      "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
      "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/practicalswift",
      "id" : 7826565,
      "login" : "practicalswift",
      "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
      "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
      "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
      "repos_url" : "https://api.github.com/users/practicalswift/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/practicalswift"
   }
}
