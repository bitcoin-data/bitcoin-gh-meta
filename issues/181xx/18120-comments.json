[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #18086 (Accurately account for mempool index memory by sipa)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-02-12T02:32:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18120#issuecomment-584988885",
      "id" : 584988885,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18120",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NDk4ODg4NQ==",
      "updated_at" : "2020-02-17T04:19:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/584988885",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18120#discussion_r381390270"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18120"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/381390270"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: This comment could be improved, for code readers not as familiar with the issues here.  Perhaps something like:\r\n```\r\nmark every direct child as visited, so that if we encounter one of these transactions again \r\n(as the descendant of some other direct child), we don't re-add them to the cache.\r\n```",
      "commit_id" : "057c8b4ce84c81e008d53b90ecddfa6d4f58cd9a",
      "created_at" : "2020-02-19T16:29:41Z",
      "diff_hunk" : "@@ -57,48 +57,70 @@ size_t CTxMemPoolEntry::GetTxSize() const\n // Update the given tx for any in-mempool descendants.\n // Assumes that setMemPoolChildren is correct for the given tx and all\n // descendants.\n-void CTxMemPool::UpdateForDescendants(txiter updateIt, cacheMap &cachedDescendants, const std::set<uint256> &setExclude)\n+void CTxMemPool::UpdateForDescendants(txiter update_it, cacheMap& cache, const std::set<uint256>& exclude)\n {\n-    setEntries stageEntries, setAllDescendants;\n-    stageEntries = GetMemPoolChildren(updateIt);\n-\n-    while (!stageEntries.empty()) {\n-        const txiter cit = *stageEntries.begin();\n-        setAllDescendants.insert(cit);\n-        stageEntries.erase(cit);\n-        const setEntries &setChildren = GetMemPoolChildren(cit);\n-        for (txiter childEntry : setChildren) {\n-            cacheMap::iterator cacheIt = cachedDescendants.find(childEntry);\n-            if (cacheIt != cachedDescendants.end()) {\n-                // We've already calculated this one, just add the entries for this set\n-                // but don't traverse again.\n-                for (txiter cacheEntry : cacheIt->second) {\n-                    setAllDescendants.insert(cacheEntry);\n+    const auto epoch = GetFreshEpoch();\n+    const CTxMemPool::setEntries& direct_children = GetMemPoolChildren(update_it);\n+    // set up the update_cache to contain all of our transaction's children (note --\n+    // already de-duplicated in case multiple outputs of ours are spent in one\n+    // transaction)\n+    vecEntries update_cache;\n+    update_cache.reserve(direct_children.size());\n+    // mark every direct_child as visited so that we don't accidentally re-add them\n+    // to the cache in the grandchild is child case",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18120#discussion_r381390270",
      "id" : 381390270,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM5MDI3MA==",
      "original_commit_id" : "057c8b4ce84c81e008d53b90ecddfa6d4f58cd9a",
      "original_position" : 30,
      "path" : "src/txmempool.cpp",
      "position" : 30,
      "pull_request_review_id" : 361240524,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18120",
      "updated_at" : "2020-02-19T16:46:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/381390270",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18120#discussion_r381477655"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18120"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/381477655"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Maybe adding an example helps?\r\n\r\n```\r\nmark every direct child as visited, so that if we encounter one of these transactions again \r\n(as the descendant of some other direct child), we don't re-add them to the cache. e.g.,\r\n\r\nTx A: L1 -> {O1, O2}\r\nTx B: {O1} -> {P1}\r\nTx C: {P1, O2} -> {Q1}\r\n\r\nIn this case transaction C is both a direct child of A and a grandchild via B.\r\n```\r\n\r\nI can improve the documentation with this in the follow up PR where we clean this up more (because maybe we'd just end up removing the caching anyways). ",
      "commit_id" : "057c8b4ce84c81e008d53b90ecddfa6d4f58cd9a",
      "created_at" : "2020-02-19T18:56:14Z",
      "diff_hunk" : "@@ -57,48 +57,70 @@ size_t CTxMemPoolEntry::GetTxSize() const\n // Update the given tx for any in-mempool descendants.\n // Assumes that setMemPoolChildren is correct for the given tx and all\n // descendants.\n-void CTxMemPool::UpdateForDescendants(txiter updateIt, cacheMap &cachedDescendants, const std::set<uint256> &setExclude)\n+void CTxMemPool::UpdateForDescendants(txiter update_it, cacheMap& cache, const std::set<uint256>& exclude)\n {\n-    setEntries stageEntries, setAllDescendants;\n-    stageEntries = GetMemPoolChildren(updateIt);\n-\n-    while (!stageEntries.empty()) {\n-        const txiter cit = *stageEntries.begin();\n-        setAllDescendants.insert(cit);\n-        stageEntries.erase(cit);\n-        const setEntries &setChildren = GetMemPoolChildren(cit);\n-        for (txiter childEntry : setChildren) {\n-            cacheMap::iterator cacheIt = cachedDescendants.find(childEntry);\n-            if (cacheIt != cachedDescendants.end()) {\n-                // We've already calculated this one, just add the entries for this set\n-                // but don't traverse again.\n-                for (txiter cacheEntry : cacheIt->second) {\n-                    setAllDescendants.insert(cacheEntry);\n+    const auto epoch = GetFreshEpoch();\n+    const CTxMemPool::setEntries& direct_children = GetMemPoolChildren(update_it);\n+    // set up the update_cache to contain all of our transaction's children (note --\n+    // already de-duplicated in case multiple outputs of ours are spent in one\n+    // transaction)\n+    vecEntries update_cache;\n+    update_cache.reserve(direct_children.size());\n+    // mark every direct_child as visited so that we don't accidentally re-add them\n+    // to the cache in the grandchild is child case",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18120#discussion_r381477655",
      "id" : 381477655,
      "in_reply_to_id" : 381390270,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQ3NzY1NQ==",
      "original_commit_id" : "057c8b4ce84c81e008d53b90ecddfa6d4f58cd9a",
      "original_position" : 30,
      "path" : "src/txmempool.cpp",
      "position" : 30,
      "pull_request_review_id" : 361351590,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18120",
      "updated_at" : "2020-02-19T18:56:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/381477655",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : " Dismaying but I noticed another flaw here; I don't think we ever check if the direct children of a transaction are in the cache. I'll fix this in the follow up PR for review there.",
      "created_at" : "2020-03-03T01:06:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18120#issuecomment-593712940",
      "id" : 593712940,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18120",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5MzcxMjk0MA==",
      "updated_at" : "2020-03-03T01:06:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/593712940",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   }
]
