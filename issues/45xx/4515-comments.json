[
   {
      "body" : "What if the first encountered block with file N doesn't have undo data, but the second one does? You'd skip checking it.\r\n\r\nEDIT: fixed",
      "created_at" : "2014-07-12T20:12:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4515#issuecomment-48822765",
      "id" : 48822765,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4515",
      "updated_at" : "2014-07-13T18:08:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48822765",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4515#discussion_r14859577"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/14859577"
         }
      },
      "body" : "Why the map and bool? Just a set for both suffices.",
      "commit_id" : "899cbc76b229a37c5a0b412d7f0cd84692ae0a5e",
      "created_at" : "2014-07-13T18:04:21Z",
      "diff_hunk" : "@@ -2984,19 +2984,30 @@ bool static LoadBlockIndexDB()\n \n     // Check presence of blk files\n     LogPrintf(\"Checking all blk files are present...\\n\");\n-    set<int> setBlkDataFiles;\n+    map<int, bool> mapBlkDataFileReadable,mapBlkUndoFileReadable;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4515#discussion_r14859577",
      "id" : 14859577,
      "original_commit_id" : "d000f7f0c761c94af994f42cd34b881520da693c",
      "original_position" : 5,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4515",
      "updated_at" : "2014-11-20T13:38:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/14859577",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4515#discussion_r14859594"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/14859594"
         }
      },
      "body" : "Because if we go the #4481 route, we'll have to expand the logic to better manage the cases when the files are missing without failing.",
      "commit_id" : "899cbc76b229a37c5a0b412d7f0cd84692ae0a5e",
      "created_at" : "2014-07-13T18:09:13Z",
      "diff_hunk" : "@@ -2984,19 +2984,30 @@ bool static LoadBlockIndexDB()\n \n     // Check presence of blk files\n     LogPrintf(\"Checking all blk files are present...\\n\");\n-    set<int> setBlkDataFiles;\n+    map<int, bool> mapBlkDataFileReadable,mapBlkUndoFileReadable;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4515#discussion_r14859594",
      "id" : 14859594,
      "original_commit_id" : "d000f7f0c761c94af994f42cd34b881520da693c",
      "original_position" : 5,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4515",
      "updated_at" : "2014-11-20T13:38:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/14859594",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1192483?v=3",
         "events_url" : "https://api.github.com/users/rdponticelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rdponticelli/followers",
         "following_url" : "https://api.github.com/users/rdponticelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rdponticelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rdponticelli",
         "id" : 1192483,
         "login" : "rdponticelli",
         "organizations_url" : "https://api.github.com/users/rdponticelli/orgs",
         "received_events_url" : "https://api.github.com/users/rdponticelli/received_events",
         "repos_url" : "https://api.github.com/users/rdponticelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rdponticelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rdponticelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rdponticelli"
      }
   },
   {
      "body" : "Closing this, as it has been rebased, refactored and pushed as part of #4481.",
      "created_at" : "2014-07-16T12:17:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4515#issuecomment-49156885",
      "id" : 49156885,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4515",
      "updated_at" : "2014-07-16T12:17:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/49156885",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1192483?v=3",
         "events_url" : "https://api.github.com/users/rdponticelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rdponticelli/followers",
         "following_url" : "https://api.github.com/users/rdponticelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rdponticelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rdponticelli",
         "id" : 1192483,
         "login" : "rdponticelli",
         "organizations_url" : "https://api.github.com/users/rdponticelli/orgs",
         "received_events_url" : "https://api.github.com/users/rdponticelli/received_events",
         "repos_url" : "https://api.github.com/users/rdponticelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rdponticelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rdponticelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rdponticelli"
      }
   },
   {
      "body" : "I simplified this code. Reopening.",
      "created_at" : "2014-07-17T22:13:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4515#issuecomment-49373835",
      "id" : 49373835,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4515",
      "updated_at" : "2014-07-17T22:13:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/49373835",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1192483?v=3",
         "events_url" : "https://api.github.com/users/rdponticelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rdponticelli/followers",
         "following_url" : "https://api.github.com/users/rdponticelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rdponticelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rdponticelli",
         "id" : 1192483,
         "login" : "rdponticelli",
         "organizations_url" : "https://api.github.com/users/rdponticelli/orgs",
         "received_events_url" : "https://api.github.com/users/rdponticelli/received_events",
         "repos_url" : "https://api.github.com/users/rdponticelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rdponticelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rdponticelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rdponticelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4515#discussion_r15762874"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15762874"
         }
      },
      "body" : "Now that this has been moved to the end of the function, consider factoring it out to a separate function (eg. `CheckForBlockFiles()`) and calling that separately. After all, this is not part of loading the block index DB.",
      "commit_id" : "899cbc76b229a37c5a0b412d7f0cd84692ae0a5e",
      "created_at" : "2014-08-04T15:54:32Z",
      "diff_hunk" : "@@ -3025,6 +3007,50 @@ bool static LoadBlockIndexDB()\n         DateTimeStrFormat(\"%Y-%m-%d %H:%M:%S\", chainActive.Tip()->GetBlockTime()),\n         Checkpoints::GuessVerificationProgress(chainActive.Tip()));\n \n+    // Check presence of essential data\n+    LogPrintf(\"Checking essential data is accesible...\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4515#discussion_r15762874",
      "id" : 15762874,
      "original_commit_id" : "18fe307de75a2b19d578d9c91033d753d2d4705b",
      "original_position" : 30,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4515",
      "updated_at" : "2014-11-20T13:38:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15762874",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4515#discussion_r15800207"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15800207"
         }
      },
      "body" : "Idea: ``Checking required block data is available...``?",
      "commit_id" : "899cbc76b229a37c5a0b412d7f0cd84692ae0a5e",
      "created_at" : "2014-08-05T08:32:23Z",
      "diff_hunk" : "@@ -2997,7 +2979,55 @@ bool static LoadBlockIndexDB()\n         chainActive.Tip()->GetBlockHash().ToString(), chainActive.Height(),\n         DateTimeStrFormat(\"%Y-%m-%d %H:%M:%S\", chainActive.Tip()->GetBlockTime()),\n         Checkpoints::GuessVerificationProgress(chainActive.Tip()));\n+    \n+    return true;\n+}\n \n+bool CheckBlockFiles()\n+{\n+    // Check presence of essential data\n+    LogPrintf(\"Checking essential data is accesible...\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4515#discussion_r15800207",
      "id" : 15800207,
      "original_commit_id" : "8b8d083039c68e894ad56bccffbdc128a0556f23",
      "original_position" : 36,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4515",
      "updated_at" : "2014-11-20T13:38:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15800207",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4515#discussion_r15800213"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15800213"
         }
      },
      "body" : "I would prepend an ``Error:`` and also log which file exactly is missing (also a suggestion for normal block files).\r\n",
      "commit_id" : "899cbc76b229a37c5a0b412d7f0cd84692ae0a5e",
      "created_at" : "2014-08-05T08:32:32Z",
      "diff_hunk" : "@@ -2997,7 +2979,55 @@ bool static LoadBlockIndexDB()\n         chainActive.Tip()->GetBlockHash().ToString(), chainActive.Height(),\n         DateTimeStrFormat(\"%Y-%m-%d %H:%M:%S\", chainActive.Tip()->GetBlockTime()),\n         Checkpoints::GuessVerificationProgress(chainActive.Tip()));\n+    \n+    return true;\n+}\n \n+bool CheckBlockFiles()\n+{\n+    // Check presence of essential data\n+    LogPrintf(\"Checking essential data is accesible...\\n\");\n+    LogPrintf(\"Checking active chain up to height: %i\\n\", chainActive.Height());\n+    set<int> setBlkDataFileReadable,setBlkUndoFileReadable;\n+    for(int i = 0 ; i < chainActive.Height() ; i++)\n+    {\n+        CBlockIndex* pindex = chainActive[i];\n+        CDiskBlockPos pos(pindex->nFile, 0);\n+        if (pindex->nStatus & BLOCK_HAVE_DATA )\n+        {\n+            if(!setBlkDataFileReadable.count(pindex->nFile))\n+            {\n+                if (CAutoFile(OpenBlockFile(pos, true), SER_DISK, CLIENT_VERSION))\n+                    setBlkDataFileReadable.insert(pindex->nFile);\n+                else\n+                    return false;\n+            }\n+        }\n+        else\n+        {\n+            LogPrintf(\"Missing data for block: %i\\n\", pindex->nHeight);\n+            return false;\n+        }\n+        if (pindex->nStatus & BLOCK_HAVE_UNDO )\n+        {\n+            if(!setBlkUndoFileReadable.count(pindex->nFile))\n+            {\n+                if (CAutoFile(OpenBlockFile(pos, true), SER_DISK, CLIENT_VERSION))\n+                    setBlkUndoFileReadable.insert(pindex->nFile);\n+                else\n+                    return false;\n+            }\n+        }\n+        else\n+        {\n+            // Block 0 doesn't have undo data.\n+            if (pindex->nHeight)\n+            {\n+                LogPrintf(\"Missing undo for block: %i\\n\", pindex->nHeight);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4515#discussion_r15800213",
      "id" : 15800213,
      "original_commit_id" : "8b8d083039c68e894ad56bccffbdc128a0556f23",
      "original_position" : 73,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4515",
      "updated_at" : "2014-11-20T13:38:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15800213",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4515#discussion_r15843624"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15843624"
         }
      },
      "body" : "\"Error:\" prepended, but notice that this condition doesn't mean a file is missing, but that we don't have the bit HAVE_UNDO set in the index for this block. If the file were missing, it would be logged by the function called in line 3015. So, there's no need to log a file name here, IMHO.",
      "commit_id" : "899cbc76b229a37c5a0b412d7f0cd84692ae0a5e",
      "created_at" : "2014-08-05T21:37:04Z",
      "diff_hunk" : "@@ -2997,7 +2979,55 @@ bool static LoadBlockIndexDB()\n         chainActive.Tip()->GetBlockHash().ToString(), chainActive.Height(),\n         DateTimeStrFormat(\"%Y-%m-%d %H:%M:%S\", chainActive.Tip()->GetBlockTime()),\n         Checkpoints::GuessVerificationProgress(chainActive.Tip()));\n+    \n+    return true;\n+}\n \n+bool CheckBlockFiles()\n+{\n+    // Check presence of essential data\n+    LogPrintf(\"Checking essential data is accesible...\\n\");\n+    LogPrintf(\"Checking active chain up to height: %i\\n\", chainActive.Height());\n+    set<int> setBlkDataFileReadable,setBlkUndoFileReadable;\n+    for(int i = 0 ; i < chainActive.Height() ; i++)\n+    {\n+        CBlockIndex* pindex = chainActive[i];\n+        CDiskBlockPos pos(pindex->nFile, 0);\n+        if (pindex->nStatus & BLOCK_HAVE_DATA )\n+        {\n+            if(!setBlkDataFileReadable.count(pindex->nFile))\n+            {\n+                if (CAutoFile(OpenBlockFile(pos, true), SER_DISK, CLIENT_VERSION))\n+                    setBlkDataFileReadable.insert(pindex->nFile);\n+                else\n+                    return false;\n+            }\n+        }\n+        else\n+        {\n+            LogPrintf(\"Missing data for block: %i\\n\", pindex->nHeight);\n+            return false;\n+        }\n+        if (pindex->nStatus & BLOCK_HAVE_UNDO )\n+        {\n+            if(!setBlkUndoFileReadable.count(pindex->nFile))\n+            {\n+                if (CAutoFile(OpenBlockFile(pos, true), SER_DISK, CLIENT_VERSION))\n+                    setBlkUndoFileReadable.insert(pindex->nFile);\n+                else\n+                    return false;\n+            }\n+        }\n+        else\n+        {\n+            // Block 0 doesn't have undo data.\n+            if (pindex->nHeight)\n+            {\n+                LogPrintf(\"Missing undo for block: %i\\n\", pindex->nHeight);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4515#discussion_r15843624",
      "id" : 15843624,
      "original_commit_id" : "8b8d083039c68e894ad56bccffbdc128a0556f23",
      "original_position" : 73,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4515",
      "updated_at" : "2014-11-20T13:38:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15843624",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1192483?v=3",
         "events_url" : "https://api.github.com/users/rdponticelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rdponticelli/followers",
         "following_url" : "https://api.github.com/users/rdponticelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rdponticelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rdponticelli",
         "id" : 1192483,
         "login" : "rdponticelli",
         "organizations_url" : "https://api.github.com/users/rdponticelli/orgs",
         "received_events_url" : "https://api.github.com/users/rdponticelli/received_events",
         "repos_url" : "https://api.github.com/users/rdponticelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rdponticelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rdponticelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rdponticelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4515#discussion_r15857369"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15857369"
         }
      },
      "body" : "Nit: ``undo data`` also fits better in here, but no need to add, if this is going to be merged soon.",
      "commit_id" : "899cbc76b229a37c5a0b412d7f0cd84692ae0a5e",
      "created_at" : "2014-08-06T06:06:33Z",
      "diff_hunk" : "@@ -2997,7 +2979,55 @@ bool static LoadBlockIndexDB()\n         chainActive.Tip()->GetBlockHash().ToString(), chainActive.Height(),\n         DateTimeStrFormat(\"%Y-%m-%d %H:%M:%S\", chainActive.Tip()->GetBlockTime()),\n         Checkpoints::GuessVerificationProgress(chainActive.Tip()));\n+    \n+    return true;\n+}\n \n+bool CheckBlockFiles()\n+{\n+    // Check presence of essential data\n+    LogPrintf(\"Checking required block data is available...\\n\");\n+    LogPrintf(\"Checking active chain up to height: %i\\n\", chainActive.Height());\n+    set<int> setBlkDataFileReadable,setBlkUndoFileReadable;\n+    for(int i = 0 ; i < chainActive.Height() ; i++)\n+    {\n+        CBlockIndex* pindex = chainActive[i];\n+        CDiskBlockPos pos(pindex->nFile, 0);\n+        if (pindex->nStatus & BLOCK_HAVE_DATA )\n+        {\n+            if(!setBlkDataFileReadable.count(pindex->nFile))\n+            {\n+                if (CAutoFile(OpenBlockFile(pos, true), SER_DISK, CLIENT_VERSION))\n+                    setBlkDataFileReadable.insert(pindex->nFile);\n+                else\n+                    return false;\n+            }\n+        }\n+        else\n+        {\n+            LogPrintf(\"Error: Missing data for block: %i\\n\", pindex->nHeight);\n+            return false;\n+        }\n+        if (pindex->nStatus & BLOCK_HAVE_UNDO )\n+        {\n+            if(!setBlkUndoFileReadable.count(pindex->nFile))\n+            {\n+                if (CAutoFile(OpenBlockFile(pos, true), SER_DISK, CLIENT_VERSION))\n+                    setBlkUndoFileReadable.insert(pindex->nFile);\n+                else\n+                    return false;\n+            }\n+        }\n+        else\n+        {\n+            // Block 0 doesn't have undo data.\n+            if (pindex->nHeight)\n+            {\n+                LogPrintf(\"Error: Missing undo for block: %i\\n\", pindex->nHeight);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4515#discussion_r15857369",
      "id" : 15857369,
      "original_commit_id" : "43795dff473f18e4c1f7343dcfb595322c3d4f27",
      "original_position" : 73,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4515",
      "updated_at" : "2014-11-20T13:38:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/15857369",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "body" : "Feedback addressed, and some bugs were fixed, and some things improved along the way. Would this be mergeable?",
      "created_at" : "2014-08-06T17:52:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4515#issuecomment-51371328",
      "id" : 51371328,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4515",
      "updated_at" : "2014-08-06T17:52:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/51371328",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1192483?v=3",
         "events_url" : "https://api.github.com/users/rdponticelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rdponticelli/followers",
         "following_url" : "https://api.github.com/users/rdponticelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rdponticelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rdponticelli",
         "id" : 1192483,
         "login" : "rdponticelli",
         "organizations_url" : "https://api.github.com/users/rdponticelli/orgs",
         "received_events_url" : "https://api.github.com/users/rdponticelli/received_events",
         "repos_url" : "https://api.github.com/users/rdponticelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rdponticelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rdponticelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rdponticelli"
      }
   },
   {
      "body" : "Code style fixed to adhere to current standards.",
      "created_at" : "2014-08-14T14:10:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4515#issuecomment-52187772",
      "id" : 52187772,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4515",
      "updated_at" : "2014-08-14T14:10:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/52187772",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1192483?v=3",
         "events_url" : "https://api.github.com/users/rdponticelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rdponticelli/followers",
         "following_url" : "https://api.github.com/users/rdponticelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rdponticelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rdponticelli",
         "id" : 1192483,
         "login" : "rdponticelli",
         "organizations_url" : "https://api.github.com/users/rdponticelli/orgs",
         "received_events_url" : "https://api.github.com/users/rdponticelli/received_events",
         "repos_url" : "https://api.github.com/users/rdponticelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rdponticelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rdponticelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rdponticelli"
      }
   },
   {
      "body" : "Automatic sanity-testing: PASSED, see http://jenkins.bluematt.me/pull-tester/p4515_bac3df7ed9c9627d54c9887702182adf9adf21df/ for binaries and test log.\nThis test script verifies pulls every time they are updated. It, however, dies sometimes and fails to test properly.  If you are waiting on a test, please check timestamps to verify that the test.log is moving at http://jenkins.bluematt.me/pull-tester/current/\nContact BlueMatt on freenode if something looks broken.",
      "created_at" : "2014-08-26T13:39:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4515#issuecomment-53421080",
      "id" : 53421080,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4515",
      "updated_at" : "2014-08-26T13:39:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/53421080",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2110907?v=3",
         "events_url" : "https://api.github.com/users/BitcoinPullTester/events{/privacy}",
         "followers_url" : "https://api.github.com/users/BitcoinPullTester/followers",
         "following_url" : "https://api.github.com/users/BitcoinPullTester/following{/other_user}",
         "gists_url" : "https://api.github.com/users/BitcoinPullTester/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/BitcoinPullTester",
         "id" : 2110907,
         "login" : "BitcoinPullTester",
         "organizations_url" : "https://api.github.com/users/BitcoinPullTester/orgs",
         "received_events_url" : "https://api.github.com/users/BitcoinPullTester/received_events",
         "repos_url" : "https://api.github.com/users/BitcoinPullTester/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/BitcoinPullTester/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/BitcoinPullTester/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/BitcoinPullTester"
      }
   },
   {
      "body" : "I guess this is too late for 0.10, but reopening this anyway as I don't expect this code to change (a lot) any further, and it feels like it would make sense merging this independently of #4701.",
      "created_at" : "2014-11-20T13:38:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4515#issuecomment-63808611",
      "id" : 63808611,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4515",
      "updated_at" : "2014-11-20T14:20:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/63808611",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1192483?v=3",
         "events_url" : "https://api.github.com/users/rdponticelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rdponticelli/followers",
         "following_url" : "https://api.github.com/users/rdponticelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rdponticelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rdponticelli",
         "id" : 1192483,
         "login" : "rdponticelli",
         "organizations_url" : "https://api.github.com/users/rdponticelli/orgs",
         "received_events_url" : "https://api.github.com/users/rdponticelli/received_events",
         "repos_url" : "https://api.github.com/users/rdponticelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rdponticelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rdponticelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rdponticelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4515#discussion_r26661335"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/26661335"
         }
      },
      "body" : "It's not clear to me why you switched from the two-pass solution to a single loop, but from a readability viewpoint I'd prefer something like:\r\n```c++\r\nstd::map<int,uint32_t> mapBlkDataFiles;\r\nBOOST_FOREACH(const PAIRTYPE(uint256, CBlockIndex*)& item, mapBlockIndex)\r\n{\r\n    CBlockIndex* pindex = item.second;\r\n    mapBlkDataFiles[pindex->nFile] |= pindex->nStatus;\r\n}\r\nfor (std::map<int,uint32_t>::iterator it = mapBlkDataFiles.begin(); it != mapBlkDataFiles.end(); it++)\r\n{\r\n    if ((it->second & BLOCK_HAVE_DATA) && !BlockFileIsOpenable(it->first)) {\r\n        LogPrintf(\"Error: Required block file %i can't be opened.\\n\", it->first);\r\n        return false;\r\n    }\r\n    if ((it->second & BLOCK_HAVE_UNDO) && !UndoFileIsOpenable(it->first)) {\r\n        LogPrintf(\"Error: Required undo file %i can't be opened.\\n\", it->first);\r\n        return false;\r\n    }\r\n}\r\n```\r\n\r\n",
      "commit_id" : "899cbc76b229a37c5a0b412d7f0cd84692ae0a5e",
      "created_at" : "2015-03-18T13:20:53Z",
      "diff_hunk" : "@@ -2891,6 +2873,48 @@ bool static LoadBlockIndexDB()\n     return true;\n }\n \n+bool BlockFileIsOpenable(int nFile)\n+{\n+    CDiskBlockPos pos(nFile, 0);\n+    return !CAutoFile(OpenBlockFile(pos, true), SER_DISK, CLIENT_VERSION).IsNull();\n+}\n+\n+bool UndoFileIsOpenable(int nFile)\n+{\n+    CDiskBlockPos pos(nFile, 0);\n+    return !CAutoFile(OpenUndoFile(pos, true), SER_DISK, CLIENT_VERSION).IsNull();\n+}\n+\n+bool DataFilesAreOpenable(int nFile)\n+{\n+    if (BlockFileIsOpenable(nFile) && UndoFileIsOpenable(nFile))\n+        return true;\n+    return false;\n+}\n+\n+bool CheckBlockFiles()\n+{\n+    // Check presence of blk files\n+    LogPrintf(\"Checking all blk files are present...\\n\");\n+    set<int> setRequiredDataFilesAreOpenable;\n+    for (CBlockIndex* pindex = chainActive.Tip(); pindex && pindex->pprev; pindex = pindex->pprev) {\n+        if (pindex->nStatus & BLOCK_HAVE_DATA && pindex->nStatus & BLOCK_HAVE_UNDO) {\n+            if (!setRequiredDataFilesAreOpenable.count(pindex->nFile)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4515#discussion_r26661335",
      "id" : 26661335,
      "original_commit_id" : "899cbc76b229a37c5a0b412d7f0cd84692ae0a5e",
      "original_position" : 55,
      "path" : "src/main.cpp",
      "position" : 55,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4515",
      "updated_at" : "2015-03-18T13:20:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/26661335",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4515#discussion_r26661351"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/26661351"
         }
      },
      "body" : "These functions can be static",
      "commit_id" : "899cbc76b229a37c5a0b412d7f0cd84692ae0a5e",
      "created_at" : "2015-03-18T13:21:04Z",
      "diff_hunk" : "@@ -2891,6 +2873,48 @@ bool static LoadBlockIndexDB()\n     return true;\n }\n \n+bool BlockFileIsOpenable(int nFile)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4515#discussion_r26661351",
      "id" : 26661351,
      "original_commit_id" : "899cbc76b229a37c5a0b412d7f0cd84692ae0a5e",
      "original_position" : 29,
      "path" : "src/main.cpp",
      "position" : 29,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4515",
      "updated_at" : "2015-03-18T13:21:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/26661351",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4515#discussion_r26661504"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/26661504"
         }
      },
      "body" : "    /** Check all required block and undo files are present */",
      "commit_id" : "899cbc76b229a37c5a0b412d7f0cd84692ae0a5e",
      "created_at" : "2015-03-18T13:23:05Z",
      "diff_hunk" : "@@ -173,6 +173,8 @@ bool LoadExternalBlockFile(FILE* fileIn, CDiskBlockPos *dbp = NULL);\n bool InitBlockIndex();\n /** Load the block tree and coins database from disk */\n bool LoadBlockIndex();\n+/** Check all required block files are present */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4515#discussion_r26661504",
      "id" : 26661504,
      "original_commit_id" : "899cbc76b229a37c5a0b412d7f0cd84692ae0a5e",
      "original_position" : 4,
      "path" : "src/main.h",
      "position" : 4,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4515",
      "updated_at" : "2015-03-18T13:23:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/26661504",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Looks like this is not necessary for the current autoprune (#5863), so I'm closing this. Let me know if I'm wrong.",
      "created_at" : "2015-03-24T17:04:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4515#issuecomment-85599214",
      "id" : 85599214,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4515",
      "updated_at" : "2015-03-24T17:04:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/85599214",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   }
]
