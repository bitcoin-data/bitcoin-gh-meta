[
   {
      "author_association" : "MEMBER",
      "body" : "This also makes the `CWallet` restructure simpler as the changes to `CWallet`'s import functions will then apply to all the `import*` RPCs.",
      "created_at" : "2019-06-28T00:55:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#issuecomment-506561519",
      "id" : 506561519,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16301",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUwNjU2MTUxOQ==",
      "updated_at" : "2019-06-28T00:55:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/506561519",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#16341](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16341.html) (WIP: Introduce ScriptPubKeyMan interface and use it for key and script management (aka wallet boxes) by achow101)\n* [#16037](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16037.html) (rpc: Early fail import(wallet,multi) when a required block is pruned by promag)\n* [#15414](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15414.html) ([wallet] allow adding pubkeys from imported private keys to keypool by Sjors)\n* [#15093](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15093.html) (rpc: Change importwallet to return additional errors by marcinja)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2019-06-28T04:19:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#issuecomment-506594028",
      "id" : 506594028,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16301",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUwNjU5NDAyOA==",
      "updated_at" : "2019-07-25T02:03:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/506594028",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Approach ACK",
      "created_at" : "2019-06-28T20:59:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#issuecomment-506875137",
      "id" : 506875137,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16301",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUwNjg3NTEzNw==",
      "updated_at" : "2019-06-28T20:59:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/506875137",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r298813022"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/298813022"
         }
      },
      "author_association" : "MEMBER",
      "body" : "e66ed3b84593bebd3550e18b5b3be3605e08ced1\r\n\r\nThese changes are kind of breaking change, the caller has no way to know if something went bad - as it is will always succeed.Is this the case just because `dumpwallet`/`importwallet` should not be used?",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-06-29T22:42:36Z",
      "diff_hunk" : "@@ -691,31 +691,20 @@ UniValue importwallet(const JSONRPCRequest& request)\n             const CScript& script = script_pair.first;\n             int64_t time = script_pair.second;\n             CScriptID id(script);\n-            if (pwallet->HaveCScript(id)) {\n-                pwallet->WalletLogPrintf(\"Skipping import of %s (script already present)\\n\", HexStr(script));\n-                continue;\n-            }\n-            if(!pwallet->AddCScript(script)) {\n-                pwallet->WalletLogPrintf(\"Error importing script %s\\n\", HexStr(script));\n-                fGood = false;\n+\n+            if (pwallet->ImportScripts({script}, time)) {\n+                pwallet->WalletLogPrintf(\"Skipping import of %s (script already present or an error occurred)\\n\", HexStr(script));\n                 continue;\n             }\n-            if (time > 0) {\n-                pwallet->m_script_metadata[id].nCreateTime = time;\n-                nTimeBegin = std::min(nTimeBegin, time);\n-            }\n+\n             progress++;\n         }\n         pwallet->chain().showProgress(\"\", 100, false); // hide progress dialog in GUI\n-        pwallet->UpdateTimeFirstKey(nTimeBegin);\n     }\n     pwallet->chain().showProgress(\"\", 100, false); // hide progress dialog in GUI\n     RescanWallet(*pwallet, reserver, nTimeBegin, false /* update */);\n     pwallet->MarkDirty();\n \n-    if (!fGood)\n-        throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding some keys/scripts to wallet\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r298813022",
      "id" : 298813022,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5ODgxMzAyMg==",
      "original_commit_id" : "e66ed3b84593bebd3550e18b5b3be3605e08ced1",
      "original_position" : 68,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 256052514,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/298813022",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r299092799"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299092799"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Have importprivkey use CWallet's ImportPrivKeys, ImportScripts, and ImportScriptPubKeys\" (ea665e323f76766def6c4f46a46c53e38365d179)\r\n\r\nFunction would be a simpler without the `privkey_map` variable. You could write `pwallet->ImportPrivKeys({{vchAddress, key}}, 1)`",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-01T15:14:09Z",
      "diff_hunk" : "@@ -175,31 +175,32 @@ UniValue importprivkey(const JSONRPCRequest& request)\n         CPubKey pubkey = key.GetPubKey();\n         assert(key.VerifyPubKey(pubkey));\n         CKeyID vchAddress = pubkey.GetID();\n+\n+        std::map<CKeyID, CKey> privkey_map;\n+        privkey_map.emplace(vchAddress, key);\n+\n         {\n             pwallet->MarkDirty();\n \n+            // Use timestamp of 1 to scan the whole chain\n+            if (!pwallet->ImportPrivKeys(privkey_map, 1)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r299092799",
      "id" : 299092799,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5OTA5Mjc5OQ==",
      "original_commit_id" : "ea665e323f76766def6c4f46a46c53e38365d179",
      "original_position" : 12,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 256401882,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299092799",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r299093825"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299093825"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Have importprivkey use CWallet's ImportPrivKeys, ImportScripts, and ImportScriptPubKeys\" (ea665e323f76766def6c4f46a46c53e38365d179)\r\n\r\nIt would be easier to understand what this call was doing if it included argument names: `..., /* have_solving_data= */ true, /* internal= */ false, /* timestamp= */ 1, /* apply_label= */ ...`",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-01T15:16:21Z",
      "diff_hunk" : "@@ -175,31 +175,32 @@ UniValue importprivkey(const JSONRPCRequest& request)\n         CPubKey pubkey = key.GetPubKey();\n         assert(key.VerifyPubKey(pubkey));\n         CKeyID vchAddress = pubkey.GetID();\n+\n+        std::map<CKeyID, CKey> privkey_map;\n+        privkey_map.emplace(vchAddress, key);\n+\n         {\n             pwallet->MarkDirty();\n \n+            // Use timestamp of 1 to scan the whole chain\n+            if (!pwallet->ImportPrivKeys(privkey_map, 1)) {\n+                throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding key to wallet\");\n+            }\n+\n             // We don't know which corresponding address will be used;\n             // label all new addresses, and label existing addresses if a\n             // label was passed.\n+            std::set<CScript> script_pub_keys;\n             for (const auto& dest : GetAllDestinationsForKey(pubkey)) {\n-                if (!request.params[1].isNull() || pwallet->mapAddressBook.count(dest) == 0) {\n-                    pwallet->SetAddressBook(dest, strLabel, \"receive\");\n-                }\n-            }\n-\n-            // Don't throw error in case a key is already there\n-            if (pwallet->HaveKey(vchAddress)) {\n-                return NullUniValue;\n+                CScript script = GetScriptForDestination(dest);\n+                script_pub_keys.insert(script);\n+                pwallet->ImportScriptPubKeys(strLabel, {script}, true, false, 1, (!request.params[1].isNull()) || pwallet->mapAddressBook.count(dest) == 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r299093825",
      "id" : 299093825,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5OTA5MzgyNQ==",
      "original_commit_id" : "ea665e323f76766def6c4f46a46c53e38365d179",
      "original_position" : 31,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 256401882,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299093825",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r299100352"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299100352"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Optionally apply labels to imported scriptPubKeys\" (12fd3a849c4be0879e48e65661ca1628c21308b2)\r\n\r\nHaving two `internal` and `apply_labels` parameters that both control the same behavior is unnecessarily confusing. I think it'd be best to drop `internal` and only keep `apply_labels` since it's more explicit, but you could just as easily not make any change here and just keep using `internal`.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-01T15:30:22Z",
      "diff_hunk" : "@@ -1717,7 +1717,7 @@ bool CWallet::ImportPubKeys(const std::vector<CKeyID>& ordered_pubkeys, const st\n     return true;\n }\n \n-bool CWallet::ImportScriptPubKeys(const std::string& label, const std::set<CScript>& script_pub_keys, const bool have_solving_data, const bool internal, const int64_t timestamp)\n+bool CWallet::ImportScriptPubKeys(const std::string& label, const std::set<CScript>& script_pub_keys, const bool have_solving_data, const bool internal, const int64_t timestamp, bool apply_label)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r299100352",
      "id" : 299100352,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5OTEwMDM1Mg==",
      "original_commit_id" : "12fd3a849c4be0879e48e65661ca1628c21308b2",
      "original_position" : 5,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 256401882,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299100352",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r299107507"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299107507"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Have importprivkey use CWallet's ImportPrivKeys, ImportScripts, and ImportScriptPubKeys\" (ea665e323f76766def6c4f46a46c53e38365d179)\r\n\r\nJust curious, but why is this replacing the `LearnAllRelatedScripts()` call with inlined code? The change seems fine but is duplicative, makes code longer, and seems like the opposite of the other changes here switching to higher level `ImportPrivKeys()` and `ImportScriptPubKeys()` calls.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-01T15:47:05Z",
      "diff_hunk" : "@@ -175,31 +175,32 @@ UniValue importprivkey(const JSONRPCRequest& request)\n         CPubKey pubkey = key.GetPubKey();\n         assert(key.VerifyPubKey(pubkey));\n         CKeyID vchAddress = pubkey.GetID();\n+\n+        std::map<CKeyID, CKey> privkey_map;\n+        privkey_map.emplace(vchAddress, key);\n+\n         {\n             pwallet->MarkDirty();\n \n+            // Use timestamp of 1 to scan the whole chain\n+            if (!pwallet->ImportPrivKeys(privkey_map, 1)) {\n+                throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding key to wallet\");\n+            }\n+\n             // We don't know which corresponding address will be used;\n             // label all new addresses, and label existing addresses if a\n             // label was passed.\n+            std::set<CScript> script_pub_keys;\n             for (const auto& dest : GetAllDestinationsForKey(pubkey)) {\n-                if (!request.params[1].isNull() || pwallet->mapAddressBook.count(dest) == 0) {\n-                    pwallet->SetAddressBook(dest, strLabel, \"receive\");\n-                }\n-            }\n-\n-            // Don't throw error in case a key is already there\n-            if (pwallet->HaveKey(vchAddress)) {\n-                return NullUniValue;\n+                CScript script = GetScriptForDestination(dest);\n+                script_pub_keys.insert(script);\n+                pwallet->ImportScriptPubKeys(strLabel, {script}, true, false, 1, (!request.params[1].isNull()) || pwallet->mapAddressBook.count(dest) == 0);\n             }\n \n-            // whenever a key is imported, we need to scan the whole chain\n-            pwallet->UpdateTimeFirstKey(1);\n-            pwallet->mapKeyMetadata[vchAddress].nCreateTime = 1;\n-\n-            if (!pwallet->AddKeyPubKey(key, pubkey)) {\n-                throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding key to wallet\");\n+            // Add the wpkh script for this key if possible\n+            if (pubkey.IsCompressed()) {\n+                pwallet->ImportScripts({GetScriptForDestination(WitnessV0KeyHash(vchAddress))});\n             }\n-            pwallet->LearnAllRelatedScripts(pubkey);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r299107507",
      "id" : 299107507,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5OTEwNzUwNw==",
      "original_commit_id" : "ea665e323f76766def6c4f46a46c53e38365d179",
      "original_position" : 44,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 22,
      "pull_request_review_id" : 256401882,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299107507",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r299109085"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299109085"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Have importpubkey use CWallet's ImportScriptPubKeys and ImportPubKeys functions\" (94ad6ad965ba6dfffaf7387b15ac659323fc85d0)\r\n\r\nAccidental change? (It's more verbose and less efficient.)",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-01T15:50:38Z",
      "diff_hunk" : "@@ -511,7 +511,7 @@ UniValue importpubkey(const JSONRPCRequest& request)\n             }.ToString());\n \n \n-    std::string strLabel;\n+    std::string strLabel = \"\";",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r299109085",
      "id" : 299109085,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5OTEwOTA4NQ==",
      "original_commit_id" : "94ad6ad965ba6dfffaf7387b15ac659323fc85d0",
      "original_position" : 5,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 256401882,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299109085",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r299110008"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299110008"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Have importpubkey use CWallet's ImportScriptPubKeys and ImportPubKeys functions\" (94ad6ad965ba6dfffaf7387b15ac659323fc85d0)\r\n\r\nWould be good to label arguments: `/* add_keypool= */ false, /*internal = */ false, /* timestamp= */ 1`",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-01T15:52:49Z",
      "diff_hunk" : "@@ -543,11 +543,20 @@ UniValue importpubkey(const JSONRPCRequest& request)\n         auto locked_chain = pwallet->chain().lock();\n         LOCK(pwallet->cs_wallet);\n \n+        std::set<CScript> script_pub_keys;\n         for (const auto& dest : GetAllDestinationsForKey(pubKey)) {\n-            ImportAddress(pwallet, dest, strLabel);\n+            script_pub_keys.insert(GetScriptForDestination(dest));\n         }\n-        ImportScript(pwallet, GetScriptForRawPubKey(pubKey), strLabel, false);\n-        pwallet->LearnAllRelatedScripts(pubKey);\n+\n+        pwallet->MarkDirty();\n+\n+        pwallet->ImportScriptPubKeys(strLabel, script_pub_keys, true, false, 1);\n+\n+        std::vector<CKeyID> ordered_pubkeys = {pubKey.GetID()};\n+        std::map<CKeyID, CPubKey> pubkey_map = {{pubKey.GetID(), pubKey}};\n+        std::map<CKeyID, std::pair<CPubKey, KeyOriginInfo>> key_origins;\n+\n+        pwallet->ImportPubKeys(ordered_pubkeys, pubkey_map, key_origins, false, false, 1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r299110008",
      "id" : 299110008,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5OTExMDAwOA==",
      "original_commit_id" : "94ad6ad965ba6dfffaf7387b15ac659323fc85d0",
      "original_position" : 29,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 256401882,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299110008",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r299115139"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299115139"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Have importpubkey use CWallet's ImportScriptPubKeys and ImportPubKeys functions\" (94ad6ad965ba6dfffaf7387b15ac659323fc85d0)\r\n\r\nWould be good to label arguments: `/* have_solving_data = */ true, /*internal = */ false, /* timestamp= */ 1`",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-01T16:04:43Z",
      "diff_hunk" : "@@ -543,11 +543,20 @@ UniValue importpubkey(const JSONRPCRequest& request)\n         auto locked_chain = pwallet->chain().lock();\n         LOCK(pwallet->cs_wallet);\n \n+        std::set<CScript> script_pub_keys;\n         for (const auto& dest : GetAllDestinationsForKey(pubKey)) {\n-            ImportAddress(pwallet, dest, strLabel);\n+            script_pub_keys.insert(GetScriptForDestination(dest));\n         }\n-        ImportScript(pwallet, GetScriptForRawPubKey(pubKey), strLabel, false);\n-        pwallet->LearnAllRelatedScripts(pubKey);\n+\n+        pwallet->MarkDirty();\n+\n+        pwallet->ImportScriptPubKeys(strLabel, script_pub_keys, true, false, 1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r299115139",
      "id" : 299115139,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5OTExNTEzOQ==",
      "original_commit_id" : "94ad6ad965ba6dfffaf7387b15ac659323fc85d0",
      "original_position" : 23,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 256401882,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299115139",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r299118862"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299118862"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Have importpubkey use CWallet's ImportScriptPubKeys and ImportPubKeys functions\" (94ad6ad965ba6dfffaf7387b15ac659323fc85d0)\r\n\r\nJust a note to other reviewers: this seems to happen in `ImportPubKeys` now",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-01T16:14:16Z",
      "diff_hunk" : "@@ -543,11 +543,20 @@ UniValue importpubkey(const JSONRPCRequest& request)\n         auto locked_chain = pwallet->chain().lock();\n         LOCK(pwallet->cs_wallet);\n \n+        std::set<CScript> script_pub_keys;\n         for (const auto& dest : GetAllDestinationsForKey(pubKey)) {\n-            ImportAddress(pwallet, dest, strLabel);\n+            script_pub_keys.insert(GetScriptForDestination(dest));\n         }\n-        ImportScript(pwallet, GetScriptForRawPubKey(pubKey), strLabel, false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r299118862",
      "id" : 299118862,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5OTExODg2Mg==",
      "original_commit_id" : "94ad6ad965ba6dfffaf7387b15ac659323fc85d0",
      "original_position" : 18,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 103,
      "pull_request_review_id" : 256401882,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299118862",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r299208965"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299208965"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Optionally allow ImportScripts to set script creation timestamp\" (92863d7de8cf0d7432bc47f36bf1aa4de257c548)\r\n\r\nI think it'd be better not to have a default parameter so callers will have a prompt to provide this information if it's available and not just drop it in the floor. There shouldn't be a lot of preexisting calls.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-01T20:40:40Z",
      "diff_hunk" : "@@ -1092,7 +1092,7 @@ class CWallet final : public CCryptoKeyStore, private interfaces::Chain::Notific\n     bool DummySignTx(CMutableTransaction &txNew, const std::vector<CTxOut> &txouts, bool use_max_sig = false) const;\n     bool DummySignInput(CTxIn &tx_in, const CTxOut &txout, bool use_max_sig = false) const;\n \n-    bool ImportScripts(const std::set<CScript> scripts) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet);\n+    bool ImportScripts(const std::set<CScript> scripts, int64_t time = -1) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r299208965",
      "id" : 299208965,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5OTIwODk2NQ==",
      "original_commit_id" : "92863d7de8cf0d7432bc47f36bf1aa4de257c548",
      "original_position" : 5,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 256401882,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299208965",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r299211190"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299211190"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Optionally allow ImportScripts to set script creation timestamp\" (92863d7de8cf0d7432bc47f36bf1aa4de257c548)\r\n\r\nThis is inconsistent with existing code which uses 0 to indicate an unknown time and 1 to indicate the earliest timestamp. \r\n\r\nWould suggesting replacing `(time >= 0)` to `(time > 0)` here and below and changing default to 0 instead of -1. (Or dropping the default entirely).",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-01T20:47:24Z",
      "diff_hunk" : "@@ -1661,14 +1661,22 @@ bool CWallet::DummySignTx(CMutableTransaction &txNew, const std::vector<CTxOut>\n     return true;\n }\n \n-bool CWallet::ImportScripts(const std::set<CScript> scripts)\n+bool CWallet::ImportScripts(const std::set<CScript> scripts, int64_t time)\n {\n     WalletBatch batch(*database);\n     for (const auto& entry : scripts) {\n         if (!HaveCScript(CScriptID(entry)) && !AddCScriptWithDB(batch, entry)) {\n             return false;\n         }\n+\n+        if (time >= 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r299211190",
      "id" : 299211190,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5OTIxMTE5MA==",
      "original_commit_id" : "92863d7de8cf0d7432bc47f36bf1aa4de257c548",
      "original_position" : 13,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 256401882,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299211190",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r299232069"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299232069"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This was done in preparation for the wallet restructure which causes `LearnAllRelatedScripts` to no longer be part of `CWallet`.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-01T21:55:19Z",
      "diff_hunk" : "@@ -175,31 +175,32 @@ UniValue importprivkey(const JSONRPCRequest& request)\n         CPubKey pubkey = key.GetPubKey();\n         assert(key.VerifyPubKey(pubkey));\n         CKeyID vchAddress = pubkey.GetID();\n+\n+        std::map<CKeyID, CKey> privkey_map;\n+        privkey_map.emplace(vchAddress, key);\n+\n         {\n             pwallet->MarkDirty();\n \n+            // Use timestamp of 1 to scan the whole chain\n+            if (!pwallet->ImportPrivKeys(privkey_map, 1)) {\n+                throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding key to wallet\");\n+            }\n+\n             // We don't know which corresponding address will be used;\n             // label all new addresses, and label existing addresses if a\n             // label was passed.\n+            std::set<CScript> script_pub_keys;\n             for (const auto& dest : GetAllDestinationsForKey(pubkey)) {\n-                if (!request.params[1].isNull() || pwallet->mapAddressBook.count(dest) == 0) {\n-                    pwallet->SetAddressBook(dest, strLabel, \"receive\");\n-                }\n-            }\n-\n-            // Don't throw error in case a key is already there\n-            if (pwallet->HaveKey(vchAddress)) {\n-                return NullUniValue;\n+                CScript script = GetScriptForDestination(dest);\n+                script_pub_keys.insert(script);\n+                pwallet->ImportScriptPubKeys(strLabel, {script}, true, false, 1, (!request.params[1].isNull()) || pwallet->mapAddressBook.count(dest) == 0);\n             }\n \n-            // whenever a key is imported, we need to scan the whole chain\n-            pwallet->UpdateTimeFirstKey(1);\n-            pwallet->mapKeyMetadata[vchAddress].nCreateTime = 1;\n-\n-            if (!pwallet->AddKeyPubKey(key, pubkey)) {\n-                throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding key to wallet\");\n+            // Add the wpkh script for this key if possible\n+            if (pubkey.IsCompressed()) {\n+                pwallet->ImportScripts({GetScriptForDestination(WitnessV0KeyHash(vchAddress))});\n             }\n-            pwallet->LearnAllRelatedScripts(pubkey);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r299232069",
      "id" : 299232069,
      "in_reply_to_id" : 299107507,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5OTIzMjA2OQ==",
      "original_commit_id" : "ea665e323f76766def6c4f46a46c53e38365d179",
      "original_position" : 44,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 22,
      "pull_request_review_id" : 256580104,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299232069",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r299260212"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299260212"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This change was because it `ImportScripts` and `ImportPrivKeys` doesn't return why it failed. It could fail because the script or privkey already exists in the wallet which would still be fine, or it could cail because something went wrong with writing the data to the wallet file which is bad. I suppose I could make them return an enum, but that's a larger change that I didn't really want to do.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-02T00:05:25Z",
      "diff_hunk" : "@@ -691,31 +691,20 @@ UniValue importwallet(const JSONRPCRequest& request)\n             const CScript& script = script_pair.first;\n             int64_t time = script_pair.second;\n             CScriptID id(script);\n-            if (pwallet->HaveCScript(id)) {\n-                pwallet->WalletLogPrintf(\"Skipping import of %s (script already present)\\n\", HexStr(script));\n-                continue;\n-            }\n-            if(!pwallet->AddCScript(script)) {\n-                pwallet->WalletLogPrintf(\"Error importing script %s\\n\", HexStr(script));\n-                fGood = false;\n+\n+            if (pwallet->ImportScripts({script}, time)) {\n+                pwallet->WalletLogPrintf(\"Skipping import of %s (script already present or an error occurred)\\n\", HexStr(script));\n                 continue;\n             }\n-            if (time > 0) {\n-                pwallet->m_script_metadata[id].nCreateTime = time;\n-                nTimeBegin = std::min(nTimeBegin, time);\n-            }\n+\n             progress++;\n         }\n         pwallet->chain().showProgress(\"\", 100, false); // hide progress dialog in GUI\n-        pwallet->UpdateTimeFirstKey(nTimeBegin);\n     }\n     pwallet->chain().showProgress(\"\", 100, false); // hide progress dialog in GUI\n     RescanWallet(*pwallet, reserver, nTimeBegin, false /* update */);\n     pwallet->MarkDirty();\n \n-    if (!fGood)\n-        throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding some keys/scripts to wallet\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r299260212",
      "id" : 299260212,
      "in_reply_to_id" : 298813022,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5OTI2MDIxMg==",
      "original_commit_id" : "e66ed3b84593bebd3550e18b5b3be3605e08ced1",
      "original_position" : 68,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 256613237,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299260212",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r299260358"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299260358"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-02T00:06:14Z",
      "diff_hunk" : "@@ -175,31 +175,32 @@ UniValue importprivkey(const JSONRPCRequest& request)\n         CPubKey pubkey = key.GetPubKey();\n         assert(key.VerifyPubKey(pubkey));\n         CKeyID vchAddress = pubkey.GetID();\n+\n+        std::map<CKeyID, CKey> privkey_map;\n+        privkey_map.emplace(vchAddress, key);\n+\n         {\n             pwallet->MarkDirty();\n \n+            // Use timestamp of 1 to scan the whole chain\n+            if (!pwallet->ImportPrivKeys(privkey_map, 1)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r299260358",
      "id" : 299260358,
      "in_reply_to_id" : 299092799,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5OTI2MDM1OA==",
      "original_commit_id" : "ea665e323f76766def6c4f46a46c53e38365d179",
      "original_position" : 12,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 256613413,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299260358",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r299260385"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299260385"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done everywhere",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-02T00:06:22Z",
      "diff_hunk" : "@@ -175,31 +175,32 @@ UniValue importprivkey(const JSONRPCRequest& request)\n         CPubKey pubkey = key.GetPubKey();\n         assert(key.VerifyPubKey(pubkey));\n         CKeyID vchAddress = pubkey.GetID();\n+\n+        std::map<CKeyID, CKey> privkey_map;\n+        privkey_map.emplace(vchAddress, key);\n+\n         {\n             pwallet->MarkDirty();\n \n+            // Use timestamp of 1 to scan the whole chain\n+            if (!pwallet->ImportPrivKeys(privkey_map, 1)) {\n+                throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding key to wallet\");\n+            }\n+\n             // We don't know which corresponding address will be used;\n             // label all new addresses, and label existing addresses if a\n             // label was passed.\n+            std::set<CScript> script_pub_keys;\n             for (const auto& dest : GetAllDestinationsForKey(pubkey)) {\n-                if (!request.params[1].isNull() || pwallet->mapAddressBook.count(dest) == 0) {\n-                    pwallet->SetAddressBook(dest, strLabel, \"receive\");\n-                }\n-            }\n-\n-            // Don't throw error in case a key is already there\n-            if (pwallet->HaveKey(vchAddress)) {\n-                return NullUniValue;\n+                CScript script = GetScriptForDestination(dest);\n+                script_pub_keys.insert(script);\n+                pwallet->ImportScriptPubKeys(strLabel, {script}, true, false, 1, (!request.params[1].isNull()) || pwallet->mapAddressBook.count(dest) == 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r299260385",
      "id" : 299260385,
      "in_reply_to_id" : 299093825,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5OTI2MDM4NQ==",
      "original_commit_id" : "ea665e323f76766def6c4f46a46c53e38365d179",
      "original_position" : 31,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 256613441,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299260385",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r299260434"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299260434"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Removed `apply_labels` and the commit that adds it.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-02T00:06:35Z",
      "diff_hunk" : "@@ -1717,7 +1717,7 @@ bool CWallet::ImportPubKeys(const std::vector<CKeyID>& ordered_pubkeys, const st\n     return true;\n }\n \n-bool CWallet::ImportScriptPubKeys(const std::string& label, const std::set<CScript>& script_pub_keys, const bool have_solving_data, const bool internal, const int64_t timestamp)\n+bool CWallet::ImportScriptPubKeys(const std::string& label, const std::set<CScript>& script_pub_keys, const bool have_solving_data, const bool internal, const int64_t timestamp, bool apply_label)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r299260434",
      "id" : 299260434,
      "in_reply_to_id" : 299100352,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5OTI2MDQzNA==",
      "original_commit_id" : "12fd3a849c4be0879e48e65661ca1628c21308b2",
      "original_position" : 5,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 256613498,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299260434",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r299260451"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299260451"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Reverted",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-02T00:06:42Z",
      "diff_hunk" : "@@ -511,7 +511,7 @@ UniValue importpubkey(const JSONRPCRequest& request)\n             }.ToString());\n \n \n-    std::string strLabel;\n+    std::string strLabel = \"\";",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r299260451",
      "id" : 299260451,
      "in_reply_to_id" : 299109085,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5OTI2MDQ1MQ==",
      "original_commit_id" : "94ad6ad965ba6dfffaf7387b15ac659323fc85d0",
      "original_position" : 5,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 256613515,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299260451",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r299260477"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299260477"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-02T00:06:51Z",
      "diff_hunk" : "@@ -1092,7 +1092,7 @@ class CWallet final : public CCryptoKeyStore, private interfaces::Chain::Notific\n     bool DummySignTx(CMutableTransaction &txNew, const std::vector<CTxOut> &txouts, bool use_max_sig = false) const;\n     bool DummySignInput(CTxIn &tx_in, const CTxOut &txout, bool use_max_sig = false) const;\n \n-    bool ImportScripts(const std::set<CScript> scripts) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet);\n+    bool ImportScripts(const std::set<CScript> scripts, int64_t time = -1) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r299260477",
      "id" : 299260477,
      "in_reply_to_id" : 299208965,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5OTI2MDQ3Nw==",
      "original_commit_id" : "92863d7de8cf0d7432bc47f36bf1aa4de257c548",
      "original_position" : 5,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 256613543,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299260477",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r299260488"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299260488"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-02T00:06:57Z",
      "diff_hunk" : "@@ -1661,14 +1661,22 @@ bool CWallet::DummySignTx(CMutableTransaction &txNew, const std::vector<CTxOut>\n     return true;\n }\n \n-bool CWallet::ImportScripts(const std::set<CScript> scripts)\n+bool CWallet::ImportScripts(const std::set<CScript> scripts, int64_t time)\n {\n     WalletBatch batch(*database);\n     for (const auto& entry : scripts) {\n         if (!HaveCScript(CScriptID(entry)) && !AddCScriptWithDB(batch, entry)) {\n             return false;\n         }\n+\n+        if (time >= 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r299260488",
      "id" : 299260488,
      "in_reply_to_id" : 299211190,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5OTI2MDQ4OA==",
      "original_commit_id" : "92863d7de8cf0d7432bc47f36bf1aa4de257c548",
      "original_position" : 13,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 256613558,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299260488",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r299487244"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299487244"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`id` seems to be unused?",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-02T13:38:00Z",
      "diff_hunk" : "@@ -699,31 +683,20 @@ UniValue importwallet(const JSONRPCRequest& request)\n             const CScript& script = script_pair.first;\n             int64_t time = script_pair.second;\n             CScriptID id(script);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r299487244",
      "id" : 299487244,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5OTQ4NzI0NA==",
      "original_commit_id" : "cf2d2945b99029cf4e59d158fc5b968370629b5a",
      "original_position" : 178,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 256898372,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299487244",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r299598438"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299598438"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Have importprivkey use CWallet's ImportPrivKeys, ImportScripts, and ImportScriptPubKeys\" (74ec96b601dd6417f01f4801d83e01eeb7dded18)\r\n\r\nIt's not really clear from context that this comment is referring to the `apply_label` argument passed to ImportScriptPubKeys below. Would suggest moving the comment or mentioning this explicitly.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-02T17:28:07Z",
      "diff_hunk" : "@@ -175,31 +175,29 @@ UniValue importprivkey(const JSONRPCRequest& request)\n         CPubKey pubkey = key.GetPubKey();\n         assert(key.VerifyPubKey(pubkey));\n         CKeyID vchAddress = pubkey.GetID();\n+\n         {\n             pwallet->MarkDirty();\n \n+            // Use timestamp of 1 to scan the whole chain\n+            if (!pwallet->ImportPrivKeys({{vchAddress, key}}, 1)) {\n+                throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding key to wallet\");\n+            }\n+\n             // We don't know which corresponding address will be used;\n             // label all new addresses, and label existing addresses if a\n             // label was passed.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r299598438",
      "id" : 299598438,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5OTU5ODQzOA==",
      "original_commit_id" : "e3cc8e102fc2736b3871869646f8d60599988f82",
      "original_position" : 15,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 257040771,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299598438",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r299603966"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299603966"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Have importprivkey use CWallet's ImportPrivKeys, ImportScripts, and ImportScriptPubKeys\" (e3cc8e102fc2736b3871869646f8d60599988f82)\r\n\r\nIs this ever going to add watch only scripts given the !IsMine check in ImportScriptPubKeys?\r\n\r\nIt'd be nice to have a succinct comment here saying when this will add a watch only script, and why it's necessary.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-02T17:41:35Z",
      "diff_hunk" : "@@ -175,31 +175,29 @@ UniValue importprivkey(const JSONRPCRequest& request)\n         CPubKey pubkey = key.GetPubKey();\n         assert(key.VerifyPubKey(pubkey));\n         CKeyID vchAddress = pubkey.GetID();\n+\n         {\n             pwallet->MarkDirty();\n \n+            // Use timestamp of 1 to scan the whole chain\n+            if (!pwallet->ImportPrivKeys({{vchAddress, key}}, 1)) {\n+                throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding key to wallet\");\n+            }\n+\n             // We don't know which corresponding address will be used;\n             // label all new addresses, and label existing addresses if a\n             // label was passed.\n+            std::set<CScript> script_pub_keys;\n             for (const auto& dest : GetAllDestinationsForKey(pubkey)) {\n-                if (!request.params[1].isNull() || pwallet->mapAddressBook.count(dest) == 0) {\n-                    pwallet->SetAddressBook(dest, strLabel, \"receive\");\n-                }\n+                CScript script = GetScriptForDestination(dest);\n+                script_pub_keys.insert(script);\n+                pwallet->ImportScriptPubKeys(strLabel, {script}, true /* have_solving_data */, (request.params[1].isNull()) && pwallet->mapAddressBook.count(dest) != 0 /* internal */ , 1 /* timestamp */ );",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r299603966",
      "id" : 299603966,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5OTYwMzk2Ng==",
      "original_commit_id" : "e3cc8e102fc2736b3871869646f8d60599988f82",
      "original_position" : 23,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 257040771,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/299603966",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r301676467"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301676467"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I actually find this slightly more readable than the previous `LearnAllRelatedScripts` -> `LearnRelatedScripts(key, OutputType::P2SH_SEGWIT);`. `...`. However it's hard to tell if it's really doing the same thing. Maybe add an extra commit to make that more clear?",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-09T16:19:38Z",
      "diff_hunk" : "@@ -175,31 +175,32 @@ UniValue importprivkey(const JSONRPCRequest& request)\n         CPubKey pubkey = key.GetPubKey();\n         assert(key.VerifyPubKey(pubkey));\n         CKeyID vchAddress = pubkey.GetID();\n+\n+        std::map<CKeyID, CKey> privkey_map;\n+        privkey_map.emplace(vchAddress, key);\n+\n         {\n             pwallet->MarkDirty();\n \n+            // Use timestamp of 1 to scan the whole chain\n+            if (!pwallet->ImportPrivKeys(privkey_map, 1)) {\n+                throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding key to wallet\");\n+            }\n+\n             // We don't know which corresponding address will be used;\n             // label all new addresses, and label existing addresses if a\n             // label was passed.\n+            std::set<CScript> script_pub_keys;\n             for (const auto& dest : GetAllDestinationsForKey(pubkey)) {\n-                if (!request.params[1].isNull() || pwallet->mapAddressBook.count(dest) == 0) {\n-                    pwallet->SetAddressBook(dest, strLabel, \"receive\");\n-                }\n-            }\n-\n-            // Don't throw error in case a key is already there\n-            if (pwallet->HaveKey(vchAddress)) {\n-                return NullUniValue;\n+                CScript script = GetScriptForDestination(dest);\n+                script_pub_keys.insert(script);\n+                pwallet->ImportScriptPubKeys(strLabel, {script}, true, false, 1, (!request.params[1].isNull()) || pwallet->mapAddressBook.count(dest) == 0);\n             }\n \n-            // whenever a key is imported, we need to scan the whole chain\n-            pwallet->UpdateTimeFirstKey(1);\n-            pwallet->mapKeyMetadata[vchAddress].nCreateTime = 1;\n-\n-            if (!pwallet->AddKeyPubKey(key, pubkey)) {\n-                throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding key to wallet\");\n+            // Add the wpkh script for this key if possible\n+            if (pubkey.IsCompressed()) {\n+                pwallet->ImportScripts({GetScriptForDestination(WitnessV0KeyHash(vchAddress))});\n             }\n-            pwallet->LearnAllRelatedScripts(pubkey);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r301676467",
      "id" : 301676467,
      "in_reply_to_id" : 299107507,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMTY3NjQ2Nw==",
      "original_commit_id" : "ea665e323f76766def6c4f46a46c53e38365d179",
      "original_position" : 44,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 22,
      "pull_request_review_id" : 259614803,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301676467",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r301678199"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301678199"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It's not obvious to me how dropping `SetAddressBook` doesn't change behavior, e.g. we're no longer calling `NotifyAddressBookChanged`.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-09T16:23:31Z",
      "diff_hunk" : "@@ -175,31 +175,29 @@ UniValue importprivkey(const JSONRPCRequest& request)\n         CPubKey pubkey = key.GetPubKey();\n         assert(key.VerifyPubKey(pubkey));\n         CKeyID vchAddress = pubkey.GetID();\n+\n         {\n             pwallet->MarkDirty();\n \n+            // Use timestamp of 1 to scan the whole chain\n+            if (!pwallet->ImportPrivKeys({{vchAddress, key}}, 1)) {\n+                throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding key to wallet\");\n+            }\n+\n             // We don't know which corresponding address will be used;\n             // label all new addresses, and label existing addresses if a\n             // label was passed.\n+            std::set<CScript> script_pub_keys;\n             for (const auto& dest : GetAllDestinationsForKey(pubkey)) {\n-                if (!request.params[1].isNull() || pwallet->mapAddressBook.count(dest) == 0) {\n-                    pwallet->SetAddressBook(dest, strLabel, \"receive\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r301678199",
      "id" : 301678199,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMTY3ODE5OQ==",
      "original_commit_id" : "e3cc8e102fc2736b3871869646f8d60599988f82",
      "original_position" : 19,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 259614803,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301678199",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r301713567"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301713567"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`SetAddressBook` happens in `ImportScriptPubKeys`",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-09T17:46:02Z",
      "diff_hunk" : "@@ -175,31 +175,29 @@ UniValue importprivkey(const JSONRPCRequest& request)\n         CPubKey pubkey = key.GetPubKey();\n         assert(key.VerifyPubKey(pubkey));\n         CKeyID vchAddress = pubkey.GetID();\n+\n         {\n             pwallet->MarkDirty();\n \n+            // Use timestamp of 1 to scan the whole chain\n+            if (!pwallet->ImportPrivKeys({{vchAddress, key}}, 1)) {\n+                throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding key to wallet\");\n+            }\n+\n             // We don't know which corresponding address will be used;\n             // label all new addresses, and label existing addresses if a\n             // label was passed.\n+            std::set<CScript> script_pub_keys;\n             for (const auto& dest : GetAllDestinationsForKey(pubkey)) {\n-                if (!request.params[1].isNull() || pwallet->mapAddressBook.count(dest) == 0) {\n-                    pwallet->SetAddressBook(dest, strLabel, \"receive\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r301713567",
      "id" : 301713567,
      "in_reply_to_id" : 301678199,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMTcxMzU2Nw==",
      "original_commit_id" : "e3cc8e102fc2736b3871869646f8d60599988f82",
      "original_position" : 19,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 259660424,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301713567",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r301747235"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301747235"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Removed it.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-09T19:04:43Z",
      "diff_hunk" : "@@ -699,31 +683,20 @@ UniValue importwallet(const JSONRPCRequest& request)\n             const CScript& script = script_pair.first;\n             int64_t time = script_pair.second;\n             CScriptID id(script);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r301747235",
      "id" : 301747235,
      "in_reply_to_id" : 299487244,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMTc0NzIzNQ==",
      "original_commit_id" : "cf2d2945b99029cf4e59d158fc5b968370629b5a",
      "original_position" : 178,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 259701686,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301747235",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r302071555"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/302071555"
         }
      },
      "author_association" : "MEMBER",
      "body" : "why 1 and not 0? No internal documentation I can find on this.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-10T13:42:43Z",
      "diff_hunk" : "@@ -175,31 +175,29 @@ UniValue importprivkey(const JSONRPCRequest& request)\n         CPubKey pubkey = key.GetPubKey();\n         assert(key.VerifyPubKey(pubkey));\n         CKeyID vchAddress = pubkey.GetID();\n+\n         {\n             pwallet->MarkDirty();\n \n+            // Use timestamp of 1 to scan the whole chain",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r302071555",
      "id" : 302071555,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMjA3MTU1NQ==",
      "original_commit_id" : "e3cc8e102fc2736b3871869646f8d60599988f82",
      "original_position" : 8,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 260100778,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/302071555",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r302073367"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/302073367"
         }
      },
      "author_association" : "MEMBER",
      "body" : "As long as the imported key is `!internal` and is valid destination, it does appear to `SetAddressBookWithDB` which in this RPC is true.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-10T13:46:06Z",
      "diff_hunk" : "@@ -175,31 +175,29 @@ UniValue importprivkey(const JSONRPCRequest& request)\n         CPubKey pubkey = key.GetPubKey();\n         assert(key.VerifyPubKey(pubkey));\n         CKeyID vchAddress = pubkey.GetID();\n+\n         {\n             pwallet->MarkDirty();\n \n+            // Use timestamp of 1 to scan the whole chain\n+            if (!pwallet->ImportPrivKeys({{vchAddress, key}}, 1)) {\n+                throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding key to wallet\");\n+            }\n+\n             // We don't know which corresponding address will be used;\n             // label all new addresses, and label existing addresses if a\n             // label was passed.\n+            std::set<CScript> script_pub_keys;\n             for (const auto& dest : GetAllDestinationsForKey(pubkey)) {\n-                if (!request.params[1].isNull() || pwallet->mapAddressBook.count(dest) == 0) {\n-                    pwallet->SetAddressBook(dest, strLabel, \"receive\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r302073367",
      "id" : 302073367,
      "in_reply_to_id" : 301678199,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMjA3MzM2Nw==",
      "original_commit_id" : "e3cc8e102fc2736b3871869646f8d60599988f82",
      "original_position" : 19,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 260100778,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/302073367",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r302076081"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/302076081"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> (request.params[1].isNull()) && pwallet->mapAddressBook.count(dest) != 0 /* internal */\r\n\r\nThis seems like an extreme abuse of the flag based on the name and confused me. This should be renamed `add_to_book_if_valid` or maybe even better just have the validity check inside `SetToAddressBook`(do we ever want to import invalid destinations?) and call it `add_to_addrbook`.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-10T13:51:30Z",
      "diff_hunk" : "@@ -175,31 +175,29 @@ UniValue importprivkey(const JSONRPCRequest& request)\n         CPubKey pubkey = key.GetPubKey();\n         assert(key.VerifyPubKey(pubkey));\n         CKeyID vchAddress = pubkey.GetID();\n+\n         {\n             pwallet->MarkDirty();\n \n+            // Use timestamp of 1 to scan the whole chain\n+            if (!pwallet->ImportPrivKeys({{vchAddress, key}}, 1)) {\n+                throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding key to wallet\");\n+            }\n+\n             // We don't know which corresponding address will be used;\n             // label all new addresses, and label existing addresses if a\n             // label was passed.\n+            std::set<CScript> script_pub_keys;\n             for (const auto& dest : GetAllDestinationsForKey(pubkey)) {\n-                if (!request.params[1].isNull() || pwallet->mapAddressBook.count(dest) == 0) {\n-                    pwallet->SetAddressBook(dest, strLabel, \"receive\");\n-                }\n+                CScript script = GetScriptForDestination(dest);\n+                script_pub_keys.insert(script);\n+                pwallet->ImportScriptPubKeys(strLabel, {script}, true /* have_solving_data */, (request.params[1].isNull()) && pwallet->mapAddressBook.count(dest) != 0 /* internal */ , 1 /* timestamp */ );",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r302076081",
      "id" : 302076081,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMjA3NjA4MQ==",
      "original_commit_id" : "e3cc8e102fc2736b3871869646f8d60599988f82",
      "original_position" : 23,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 260100778,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/302076081",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r302078575"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/302078575"
         }
      },
      "author_association" : "MEMBER",
      "body" : "? This is already done by `GetAllDestinationsForKey`",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-10T13:56:23Z",
      "diff_hunk" : "@@ -175,31 +175,29 @@ UniValue importprivkey(const JSONRPCRequest& request)\n         CPubKey pubkey = key.GetPubKey();\n         assert(key.VerifyPubKey(pubkey));\n         CKeyID vchAddress = pubkey.GetID();\n+\n         {\n             pwallet->MarkDirty();\n \n+            // Use timestamp of 1 to scan the whole chain\n+            if (!pwallet->ImportPrivKeys({{vchAddress, key}}, 1)) {\n+                throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding key to wallet\");\n+            }\n+\n             // We don't know which corresponding address will be used;\n             // label all new addresses, and label existing addresses if a\n             // label was passed.\n+            std::set<CScript> script_pub_keys;\n             for (const auto& dest : GetAllDestinationsForKey(pubkey)) {\n-                if (!request.params[1].isNull() || pwallet->mapAddressBook.count(dest) == 0) {\n-                    pwallet->SetAddressBook(dest, strLabel, \"receive\");\n-                }\n+                CScript script = GetScriptForDestination(dest);\n+                script_pub_keys.insert(script);\n+                pwallet->ImportScriptPubKeys(strLabel, {script}, true /* have_solving_data */, (request.params[1].isNull()) && pwallet->mapAddressBook.count(dest) != 0 /* internal */ , 1 /* timestamp */ );\n             }\n \n-            // Don't throw error in case a key is already there\n-            if (pwallet->HaveKey(vchAddress)) {\n-                return NullUniValue;\n-            }\n-\n-            // whenever a key is imported, we need to scan the whole chain\n-            pwallet->UpdateTimeFirstKey(1);\n-            pwallet->mapKeyMetadata[vchAddress].nCreateTime = 1;\n-\n-            if (!pwallet->AddKeyPubKey(key, pubkey)) {\n-                throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding key to wallet\");\n+            // Add the wpkh script for this key if possible",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r302078575",
      "id" : 302078575,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMjA3ODU3NQ==",
      "original_commit_id" : "e3cc8e102fc2736b3871869646f8d60599988f82",
      "original_position" : 37,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 18,
      "pull_request_review_id" : 260100778,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/302078575",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r302081493"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/302081493"
         }
      },
      "author_association" : "MEMBER",
      "body" : "more specifically here's the rough logic of `ImportScript`:\r\n\r\n```\r\nmark dirty \r\n\r\naddwatchonly\r\n\r\nif is redeem script:\r\n  addcscript\r\n  ImportAddress\r\nelse\r\n  SetAddressBook\r\n```\r\n\r\nAnd in this case it's not a redeemscript(last arg is false), so it marks dirty, adds watchonly, and sets address book. \r\n\r\nMark dirty is top-level now, `ImportScriptPubKeys` takes care of the `SetAddressBookWithDB`, and both `ImportScriptPubKeys` and `ImportPubKeys` adds watch only in specific situations(when pubkey is not already in wallet, or  the script is not in the wallet yet). Previously the watchonly script was added when ISMINE was not spendable. I'll leave it up to other reviewers to figure if this is desired/same semantics. ",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-10T14:01:48Z",
      "diff_hunk" : "@@ -543,11 +543,20 @@ UniValue importpubkey(const JSONRPCRequest& request)\n         auto locked_chain = pwallet->chain().lock();\n         LOCK(pwallet->cs_wallet);\n \n+        std::set<CScript> script_pub_keys;\n         for (const auto& dest : GetAllDestinationsForKey(pubKey)) {\n-            ImportAddress(pwallet, dest, strLabel);\n+            script_pub_keys.insert(GetScriptForDestination(dest));\n         }\n-        ImportScript(pwallet, GetScriptForRawPubKey(pubKey), strLabel, false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r302081493",
      "id" : 302081493,
      "in_reply_to_id" : 299118862,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMjA4MTQ5Mw==",
      "original_commit_id" : "94ad6ad965ba6dfffaf7387b15ac659323fc85d0",
      "original_position" : 18,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 103,
      "pull_request_review_id" : 260100778,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/302081493",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r302083185"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/302083185"
         }
      },
      "author_association" : "MEMBER",
      "body" : "can you annotate `key_origins` too?",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-10T14:05:05Z",
      "diff_hunk" : "@@ -540,11 +540,16 @@ UniValue importpubkey(const JSONRPCRequest& request)\n         auto locked_chain = pwallet->chain().lock();\n         LOCK(pwallet->cs_wallet);\n \n+        std::set<CScript> script_pub_keys;\n         for (const auto& dest : GetAllDestinationsForKey(pubKey)) {\n-            ImportAddress(pwallet, dest, strLabel);\n+            script_pub_keys.insert(GetScriptForDestination(dest));\n         }\n-        ImportScript(pwallet, GetScriptForRawPubKey(pubKey), strLabel, false);\n-        pwallet->LearnAllRelatedScripts(pubKey);\n+\n+        pwallet->MarkDirty();\n+\n+        pwallet->ImportScriptPubKeys(strLabel, script_pub_keys, true /* have_solving_data */, false /*internal */, 1 /* timestamp */);\n+\n+        pwallet->ImportPubKeys({pubKey.GetID()}, {{pubKey.GetID(), pubKey}}, {}, false /* add_keypool */, false /* internal */, 1 /* timestamp */);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r302083185",
      "id" : 302083185,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMjA4MzE4NQ==",
      "original_commit_id" : "28f30ca209749682c0e23f640946a2b3a12541e3",
      "original_position" : 16,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 260100778,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/302083185",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r302094189"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/302094189"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: `timestamp` since you're calling it that in other places and it matches better other args",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-10T14:25:26Z",
      "diff_hunk" : "@@ -1092,7 +1092,7 @@ class CWallet final : public CCryptoKeyStore, private interfaces::Chain::Notific\n     bool DummySignTx(CMutableTransaction &txNew, const std::vector<CTxOut> &txouts, bool use_max_sig = false) const;\n     bool DummySignInput(CTxIn &tx_in, const CTxOut &txout, bool use_max_sig = false) const;\n \n-    bool ImportScripts(const std::set<CScript> scripts) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet);\n+    bool ImportScripts(const std::set<CScript> scripts, int64_t time) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r302094189",
      "id" : 302094189,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMjA5NDE4OQ==",
      "original_commit_id" : "f9115eb2d657ad339d1bf7ac0a6f022820b2193d",
      "original_position" : 5,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 260100778,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/302094189",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r302096091"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/302096091"
         }
      },
      "author_association" : "MEMBER",
      "body" : "isn't this backwards?",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-10T14:28:46Z",
      "diff_hunk" : "@@ -663,51 +662,40 @@ UniValue importwallet(const JSONRPCRequest& request)\n             CPubKey pubkey = key.GetPubKey();\n             assert(key.VerifyPubKey(pubkey));\n             CKeyID keyid = pubkey.GetID();\n-            if (pwallet->HaveKey(keyid)) {\n-                pwallet->WalletLogPrintf(\"Skipping import of %s (key already present)\\n\", EncodeDestination(PKHash(keyid)));\n+\n+            std::map<CKeyID, CKey> privkey_map;\n+            privkey_map.emplace(keyid, key);\n+\n+            if (!pwallet->ImportPrivKeys(privkey_map, time)) {\n+                pwallet->WalletLogPrintf(\"Skipping import of %s (key already present or an error occurred)\\n\", EncodeDestination(PKHash(keyid)));\n                 continue;\n             }\n+\n             pwallet->WalletLogPrintf(\"Importing %s...\\n\", EncodeDestination(PKHash(keyid)));\n-            if (!pwallet->AddKeyPubKey(key, pubkey)) {\n-                fGood = false;\n-                continue;\n-            }\n-            pwallet->mapKeyMetadata[keyid].nCreateTime = time;\n-            if (has_label)\n-                pwallet->SetAddressBook(PKHash(keyid), label, \"receive\");\n+\n+            pwallet->ImportScriptPubKeys(label, {GetScriptForDestination(PKHash(keyid))}, true /* have_solving_data */, has_label, time);\n+\n             nTimeBegin = std::min(nTimeBegin, time);\n             progress++;\n         }\n         for (const auto& script_pair : scripts) {\n             pwallet->chain().showProgress(\"\", std::max(50, std::min(75, (int)((progress / total) * 100) + 50)), false);\n             const CScript& script = script_pair.first;\n             int64_t time = script_pair.second;\n-            CScriptID id(script);\n-            if (pwallet->HaveCScript(id)) {\n-                pwallet->WalletLogPrintf(\"Skipping import of %s (script already present)\\n\", HexStr(script));\n-                continue;\n-            }\n-            if(!pwallet->AddCScript(script)) {\n-                pwallet->WalletLogPrintf(\"Error importing script %s\\n\", HexStr(script));\n-                fGood = false;\n+\n+            if (pwallet->ImportScripts({script}, time)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r302096091",
      "id" : 302096091,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMjA5NjA5MQ==",
      "original_commit_id" : "041e65458e1a3ad729520682020f9a177125f97d",
      "original_position" : 50,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 260100778,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/302096091",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r302101694"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/302101694"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The errors reported as-is appear to at least be somewhat helpful.\r\n\r\n> It could fail because the script or privkey already exists in the wallet \r\n\r\nI don't think that's true. These two checks appear to be only reporting real errors. Perhaps I missed something.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-10T14:39:20Z",
      "diff_hunk" : "@@ -691,31 +691,20 @@ UniValue importwallet(const JSONRPCRequest& request)\n             const CScript& script = script_pair.first;\n             int64_t time = script_pair.second;\n             CScriptID id(script);\n-            if (pwallet->HaveCScript(id)) {\n-                pwallet->WalletLogPrintf(\"Skipping import of %s (script already present)\\n\", HexStr(script));\n-                continue;\n-            }\n-            if(!pwallet->AddCScript(script)) {\n-                pwallet->WalletLogPrintf(\"Error importing script %s\\n\", HexStr(script));\n-                fGood = false;\n+\n+            if (pwallet->ImportScripts({script}, time)) {\n+                pwallet->WalletLogPrintf(\"Skipping import of %s (script already present or an error occurred)\\n\", HexStr(script));\n                 continue;\n             }\n-            if (time > 0) {\n-                pwallet->m_script_metadata[id].nCreateTime = time;\n-                nTimeBegin = std::min(nTimeBegin, time);\n-            }\n+\n             progress++;\n         }\n         pwallet->chain().showProgress(\"\", 100, false); // hide progress dialog in GUI\n-        pwallet->UpdateTimeFirstKey(nTimeBegin);\n     }\n     pwallet->chain().showProgress(\"\", 100, false); // hide progress dialog in GUI\n     RescanWallet(*pwallet, reserver, nTimeBegin, false /* update */);\n     pwallet->MarkDirty();\n \n-    if (!fGood)\n-        throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding some keys/scripts to wallet\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r302101694",
      "id" : 302101694,
      "in_reply_to_id" : 298813022,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMjEwMTY5NA==",
      "original_commit_id" : "e66ed3b84593bebd3550e18b5b3be3605e08ced1",
      "original_position" : 68,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 260100778,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/302101694",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r302784011"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/302784011"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Dunno, it's just adapted from the changed code.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-11T23:51:55Z",
      "diff_hunk" : "@@ -175,31 +175,29 @@ UniValue importprivkey(const JSONRPCRequest& request)\n         CPubKey pubkey = key.GetPubKey();\n         assert(key.VerifyPubKey(pubkey));\n         CKeyID vchAddress = pubkey.GetID();\n+\n         {\n             pwallet->MarkDirty();\n \n+            // Use timestamp of 1 to scan the whole chain",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r302784011",
      "id" : 302784011,
      "in_reply_to_id" : 302071555,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMjc4NDAxMQ==",
      "original_commit_id" : "e3cc8e102fc2736b3871869646f8d60599988f82",
      "original_position" : 8,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 261006011,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/302784011",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r302785895"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/302785895"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`ImportScriptPubKeys` doesn't actually add the scripts to the wallet, so we add the script here.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-12T00:02:35Z",
      "diff_hunk" : "@@ -175,31 +175,29 @@ UniValue importprivkey(const JSONRPCRequest& request)\n         CPubKey pubkey = key.GetPubKey();\n         assert(key.VerifyPubKey(pubkey));\n         CKeyID vchAddress = pubkey.GetID();\n+\n         {\n             pwallet->MarkDirty();\n \n+            // Use timestamp of 1 to scan the whole chain\n+            if (!pwallet->ImportPrivKeys({{vchAddress, key}}, 1)) {\n+                throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding key to wallet\");\n+            }\n+\n             // We don't know which corresponding address will be used;\n             // label all new addresses, and label existing addresses if a\n             // label was passed.\n+            std::set<CScript> script_pub_keys;\n             for (const auto& dest : GetAllDestinationsForKey(pubkey)) {\n-                if (!request.params[1].isNull() || pwallet->mapAddressBook.count(dest) == 0) {\n-                    pwallet->SetAddressBook(dest, strLabel, \"receive\");\n-                }\n+                CScript script = GetScriptForDestination(dest);\n+                script_pub_keys.insert(script);\n+                pwallet->ImportScriptPubKeys(strLabel, {script}, true /* have_solving_data */, (request.params[1].isNull()) && pwallet->mapAddressBook.count(dest) != 0 /* internal */ , 1 /* timestamp */ );\n             }\n \n-            // Don't throw error in case a key is already there\n-            if (pwallet->HaveKey(vchAddress)) {\n-                return NullUniValue;\n-            }\n-\n-            // whenever a key is imported, we need to scan the whole chain\n-            pwallet->UpdateTimeFirstKey(1);\n-            pwallet->mapKeyMetadata[vchAddress].nCreateTime = 1;\n-\n-            if (!pwallet->AddKeyPubKey(key, pubkey)) {\n-                throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding key to wallet\");\n+            // Add the wpkh script for this key if possible",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r302785895",
      "id" : 302785895,
      "in_reply_to_id" : 302078575,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMjc4NTg5NQ==",
      "original_commit_id" : "e3cc8e102fc2736b3871869646f8d60599988f82",
      "original_position" : 37,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 18,
      "pull_request_review_id" : 261008171,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/302785895",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r302787015"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/302787015"
         }
      },
      "author_association" : "MEMBER",
      "body" : "How so?",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-12T00:09:23Z",
      "diff_hunk" : "@@ -663,51 +662,40 @@ UniValue importwallet(const JSONRPCRequest& request)\n             CPubKey pubkey = key.GetPubKey();\n             assert(key.VerifyPubKey(pubkey));\n             CKeyID keyid = pubkey.GetID();\n-            if (pwallet->HaveKey(keyid)) {\n-                pwallet->WalletLogPrintf(\"Skipping import of %s (key already present)\\n\", EncodeDestination(PKHash(keyid)));\n+\n+            std::map<CKeyID, CKey> privkey_map;\n+            privkey_map.emplace(keyid, key);\n+\n+            if (!pwallet->ImportPrivKeys(privkey_map, time)) {\n+                pwallet->WalletLogPrintf(\"Skipping import of %s (key already present or an error occurred)\\n\", EncodeDestination(PKHash(keyid)));\n                 continue;\n             }\n+\n             pwallet->WalletLogPrintf(\"Importing %s...\\n\", EncodeDestination(PKHash(keyid)));\n-            if (!pwallet->AddKeyPubKey(key, pubkey)) {\n-                fGood = false;\n-                continue;\n-            }\n-            pwallet->mapKeyMetadata[keyid].nCreateTime = time;\n-            if (has_label)\n-                pwallet->SetAddressBook(PKHash(keyid), label, \"receive\");\n+\n+            pwallet->ImportScriptPubKeys(label, {GetScriptForDestination(PKHash(keyid))}, true /* have_solving_data */, has_label, time);\n+\n             nTimeBegin = std::min(nTimeBegin, time);\n             progress++;\n         }\n         for (const auto& script_pair : scripts) {\n             pwallet->chain().showProgress(\"\", std::max(50, std::min(75, (int)((progress / total) * 100) + 50)), false);\n             const CScript& script = script_pair.first;\n             int64_t time = script_pair.second;\n-            CScriptID id(script);\n-            if (pwallet->HaveCScript(id)) {\n-                pwallet->WalletLogPrintf(\"Skipping import of %s (script already present)\\n\", HexStr(script));\n-                continue;\n-            }\n-            if(!pwallet->AddCScript(script)) {\n-                pwallet->WalletLogPrintf(\"Error importing script %s\\n\", HexStr(script));\n-                fGood = false;\n+\n+            if (pwallet->ImportScripts({script}, time)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r302787015",
      "id" : 302787015,
      "in_reply_to_id" : 302096091,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMjc4NzAxNQ==",
      "original_commit_id" : "041e65458e1a3ad729520682020f9a177125f97d",
      "original_position" : 50,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 261009564,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/302787015",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r302790286"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/302790286"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, but these checks are part of `ImportPrivKeys` and `ImportScripts` both of which can return false in non-error cases. Both have `HaveKey` and/or `HaveCScript` checks that can fail, but not cause the import to be bad. But there could also be an actual error which would result in the import being bad.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-12T00:29:55Z",
      "diff_hunk" : "@@ -691,31 +691,20 @@ UniValue importwallet(const JSONRPCRequest& request)\n             const CScript& script = script_pair.first;\n             int64_t time = script_pair.second;\n             CScriptID id(script);\n-            if (pwallet->HaveCScript(id)) {\n-                pwallet->WalletLogPrintf(\"Skipping import of %s (script already present)\\n\", HexStr(script));\n-                continue;\n-            }\n-            if(!pwallet->AddCScript(script)) {\n-                pwallet->WalletLogPrintf(\"Error importing script %s\\n\", HexStr(script));\n-                fGood = false;\n+\n+            if (pwallet->ImportScripts({script}, time)) {\n+                pwallet->WalletLogPrintf(\"Skipping import of %s (script already present or an error occurred)\\n\", HexStr(script));\n                 continue;\n             }\n-            if (time > 0) {\n-                pwallet->m_script_metadata[id].nCreateTime = time;\n-                nTimeBegin = std::min(nTimeBegin, time);\n-            }\n+\n             progress++;\n         }\n         pwallet->chain().showProgress(\"\", 100, false); // hide progress dialog in GUI\n-        pwallet->UpdateTimeFirstKey(nTimeBegin);\n     }\n     pwallet->chain().showProgress(\"\", 100, false); // hide progress dialog in GUI\n     RescanWallet(*pwallet, reserver, nTimeBegin, false /* update */);\n     pwallet->MarkDirty();\n \n-    if (!fGood)\n-        throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding some keys/scripts to wallet\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r302790286",
      "id" : 302790286,
      "in_reply_to_id" : 298813022,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMjc5MDI4Ng==",
      "original_commit_id" : "e66ed3b84593bebd3550e18b5b3be3605e08ced1",
      "original_position" : 68,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 261013590,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/302790286",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r302800794"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/302800794"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've renamed the flag to `apply_label`.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-12T01:44:56Z",
      "diff_hunk" : "@@ -175,31 +175,29 @@ UniValue importprivkey(const JSONRPCRequest& request)\n         CPubKey pubkey = key.GetPubKey();\n         assert(key.VerifyPubKey(pubkey));\n         CKeyID vchAddress = pubkey.GetID();\n+\n         {\n             pwallet->MarkDirty();\n \n+            // Use timestamp of 1 to scan the whole chain\n+            if (!pwallet->ImportPrivKeys({{vchAddress, key}}, 1)) {\n+                throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding key to wallet\");\n+            }\n+\n             // We don't know which corresponding address will be used;\n             // label all new addresses, and label existing addresses if a\n             // label was passed.\n+            std::set<CScript> script_pub_keys;\n             for (const auto& dest : GetAllDestinationsForKey(pubkey)) {\n-                if (!request.params[1].isNull() || pwallet->mapAddressBook.count(dest) == 0) {\n-                    pwallet->SetAddressBook(dest, strLabel, \"receive\");\n-                }\n+                CScript script = GetScriptForDestination(dest);\n+                script_pub_keys.insert(script);\n+                pwallet->ImportScriptPubKeys(strLabel, {script}, true /* have_solving_data */, (request.params[1].isNull()) && pwallet->mapAddressBook.count(dest) != 0 /* internal */ , 1 /* timestamp */ );",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r302800794",
      "id" : 302800794,
      "in_reply_to_id" : 302076081,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMjgwMDc5NA==",
      "original_commit_id" : "e3cc8e102fc2736b3871869646f8d60599988f82",
      "original_position" : 23,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 261026589,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/302800794",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r302800804"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/302800804"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-12T01:45:01Z",
      "diff_hunk" : "@@ -540,11 +540,16 @@ UniValue importpubkey(const JSONRPCRequest& request)\n         auto locked_chain = pwallet->chain().lock();\n         LOCK(pwallet->cs_wallet);\n \n+        std::set<CScript> script_pub_keys;\n         for (const auto& dest : GetAllDestinationsForKey(pubKey)) {\n-            ImportAddress(pwallet, dest, strLabel);\n+            script_pub_keys.insert(GetScriptForDestination(dest));\n         }\n-        ImportScript(pwallet, GetScriptForRawPubKey(pubKey), strLabel, false);\n-        pwallet->LearnAllRelatedScripts(pubKey);\n+\n+        pwallet->MarkDirty();\n+\n+        pwallet->ImportScriptPubKeys(strLabel, script_pub_keys, true /* have_solving_data */, false /*internal */, 1 /* timestamp */);\n+\n+        pwallet->ImportPubKeys({pubKey.GetID()}, {{pubKey.GetID(), pubKey}}, {}, false /* add_keypool */, false /* internal */, 1 /* timestamp */);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r302800804",
      "id" : 302800804,
      "in_reply_to_id" : 302083185,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMjgwMDgwNA==",
      "original_commit_id" : "28f30ca209749682c0e23f640946a2b3a12541e3",
      "original_position" : 16,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 261026604,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/302800804",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r302800820"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/302800820"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-12T01:45:06Z",
      "diff_hunk" : "@@ -1092,7 +1092,7 @@ class CWallet final : public CCryptoKeyStore, private interfaces::Chain::Notific\n     bool DummySignTx(CMutableTransaction &txNew, const std::vector<CTxOut> &txouts, bool use_max_sig = false) const;\n     bool DummySignInput(CTxIn &tx_in, const CTxOut &txout, bool use_max_sig = false) const;\n \n-    bool ImportScripts(const std::set<CScript> scripts) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet);\n+    bool ImportScripts(const std::set<CScript> scripts, int64_t time) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r302800820",
      "id" : 302800820,
      "in_reply_to_id" : 302094189,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMjgwMDgyMA==",
      "original_commit_id" : "f9115eb2d657ad339d1bf7ac0a6f022820b2193d",
      "original_position" : 5,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 261026620,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/302800820",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Travis sad\r\n<img width=\"1212\" alt=\"Schermafbeelding 2019-07-12 om 15 11 21\" src=\"https://user-images.githubusercontent.com/10217/61134332-54c9ea00-a4b7-11e9-8213-8202e004a94c.png\">\r\n",
      "created_at" : "2019-07-12T14:11:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#issuecomment-510901339",
      "id" : 510901339,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16301",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxMDkwMTMzOQ==",
      "updated_at" : "2019-07-12T14:11:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/510901339",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r303002376"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/303002376"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Might be useful to say as much",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-12T14:18:03Z",
      "diff_hunk" : "@@ -175,31 +175,29 @@ UniValue importprivkey(const JSONRPCRequest& request)\n         CPubKey pubkey = key.GetPubKey();\n         assert(key.VerifyPubKey(pubkey));\n         CKeyID vchAddress = pubkey.GetID();\n+\n         {\n             pwallet->MarkDirty();\n \n+            // Use timestamp of 1 to scan the whole chain\n+            if (!pwallet->ImportPrivKeys({{vchAddress, key}}, 1)) {\n+                throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding key to wallet\");\n+            }\n+\n             // We don't know which corresponding address will be used;\n             // label all new addresses, and label existing addresses if a\n             // label was passed.\n+            std::set<CScript> script_pub_keys;\n             for (const auto& dest : GetAllDestinationsForKey(pubkey)) {\n-                if (!request.params[1].isNull() || pwallet->mapAddressBook.count(dest) == 0) {\n-                    pwallet->SetAddressBook(dest, strLabel, \"receive\");\n-                }\n+                CScript script = GetScriptForDestination(dest);\n+                script_pub_keys.insert(script);\n+                pwallet->ImportScriptPubKeys(strLabel, {script}, true /* have_solving_data */, (request.params[1].isNull()) && pwallet->mapAddressBook.count(dest) != 0 /* internal */ , 1 /* timestamp */ );\n             }\n \n-            // Don't throw error in case a key is already there\n-            if (pwallet->HaveKey(vchAddress)) {\n-                return NullUniValue;\n-            }\n-\n-            // whenever a key is imported, we need to scan the whole chain\n-            pwallet->UpdateTimeFirstKey(1);\n-            pwallet->mapKeyMetadata[vchAddress].nCreateTime = 1;\n-\n-            if (!pwallet->AddKeyPubKey(key, pubkey)) {\n-                throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding key to wallet\");\n+            // Add the wpkh script for this key if possible",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r303002376",
      "id" : 303002376,
      "in_reply_to_id" : 302078575,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMzAwMjM3Ng==",
      "original_commit_id" : "e3cc8e102fc2736b3871869646f8d60599988f82",
      "original_position" : 37,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 18,
      "pull_request_review_id" : 261284842,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/303002376",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r303003172"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/303003172"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Because it's reporting errors when it returns true?",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-12T14:19:59Z",
      "diff_hunk" : "@@ -663,51 +662,40 @@ UniValue importwallet(const JSONRPCRequest& request)\n             CPubKey pubkey = key.GetPubKey();\n             assert(key.VerifyPubKey(pubkey));\n             CKeyID keyid = pubkey.GetID();\n-            if (pwallet->HaveKey(keyid)) {\n-                pwallet->WalletLogPrintf(\"Skipping import of %s (key already present)\\n\", EncodeDestination(PKHash(keyid)));\n+\n+            std::map<CKeyID, CKey> privkey_map;\n+            privkey_map.emplace(keyid, key);\n+\n+            if (!pwallet->ImportPrivKeys(privkey_map, time)) {\n+                pwallet->WalletLogPrintf(\"Skipping import of %s (key already present or an error occurred)\\n\", EncodeDestination(PKHash(keyid)));\n                 continue;\n             }\n+\n             pwallet->WalletLogPrintf(\"Importing %s...\\n\", EncodeDestination(PKHash(keyid)));\n-            if (!pwallet->AddKeyPubKey(key, pubkey)) {\n-                fGood = false;\n-                continue;\n-            }\n-            pwallet->mapKeyMetadata[keyid].nCreateTime = time;\n-            if (has_label)\n-                pwallet->SetAddressBook(PKHash(keyid), label, \"receive\");\n+\n+            pwallet->ImportScriptPubKeys(label, {GetScriptForDestination(PKHash(keyid))}, true /* have_solving_data */, has_label, time);\n+\n             nTimeBegin = std::min(nTimeBegin, time);\n             progress++;\n         }\n         for (const auto& script_pair : scripts) {\n             pwallet->chain().showProgress(\"\", std::max(50, std::min(75, (int)((progress / total) * 100) + 50)), false);\n             const CScript& script = script_pair.first;\n             int64_t time = script_pair.second;\n-            CScriptID id(script);\n-            if (pwallet->HaveCScript(id)) {\n-                pwallet->WalletLogPrintf(\"Skipping import of %s (script already present)\\n\", HexStr(script));\n-                continue;\n-            }\n-            if(!pwallet->AddCScript(script)) {\n-                pwallet->WalletLogPrintf(\"Error importing script %s\\n\", HexStr(script));\n-                fGood = false;\n+\n+            if (pwallet->ImportScripts({script}, time)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r303003172",
      "id" : 303003172,
      "in_reply_to_id" : 302096091,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMzAwMzE3Mg==",
      "original_commit_id" : "041e65458e1a3ad729520682020f9a177125f97d",
      "original_position" : 50,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 261285996,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/303003172",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Fixed travis hopefully.",
      "created_at" : "2019-07-12T20:32:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#issuecomment-511023868",
      "id" : 511023868,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16301",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxMTAyMzg2OA==",
      "updated_at" : "2019-07-12T20:32:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/511023868",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "utACK 991ecfdbbb289bd6e4c50fc63f9201edbca14f70",
      "created_at" : "2019-07-16T01:58:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#issuecomment-511633851",
      "id" : 511633851,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16301",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxMTYzMzg1MQ==",
      "updated_at" : "2019-07-16T01:58:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/511633851",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r303993511"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/303993511"
         }
      },
      "author_association" : "MEMBER",
      "body" : "1 was introduced in #7551... ",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-16T16:02:01Z",
      "diff_hunk" : "@@ -175,31 +175,29 @@ UniValue importprivkey(const JSONRPCRequest& request)\n         CPubKey pubkey = key.GetPubKey();\n         assert(key.VerifyPubKey(pubkey));\n         CKeyID vchAddress = pubkey.GetID();\n+\n         {\n             pwallet->MarkDirty();\n \n+            // Use timestamp of 1 to scan the whole chain",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r303993511",
      "id" : 303993511,
      "in_reply_to_id" : 302071555,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMzk5MzUxMQ==",
      "original_commit_id" : "e3cc8e102fc2736b3871869646f8d60599988f82",
      "original_position" : 8,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 262523701,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/303993511",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "node_id" : "MDQ6VXNlcjE3ODQ2NA==",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304028365"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304028365"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> why 1 and not 0? No internal documentation I can find on this.\r\n\r\nAs far as I know, there is no substantive difference anymore between 0 and 1, but I think it's good to keep using 1 here so this is a refactoring change, not a change in behavior.\r\n\r\nI do think in general it's better to use 1 as an _explicit_ request to rescan from the beginning of the chain as opposed to 0 which could indidcate we're dealing with an old wallet that didn't save metadata (see #9108, #9682), or an uninitialized variable, or some other undefined craziness from all the spaghetti code.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-16T17:22:03Z",
      "diff_hunk" : "@@ -175,31 +175,29 @@ UniValue importprivkey(const JSONRPCRequest& request)\n         CPubKey pubkey = key.GetPubKey();\n         assert(key.VerifyPubKey(pubkey));\n         CKeyID vchAddress = pubkey.GetID();\n+\n         {\n             pwallet->MarkDirty();\n \n+            // Use timestamp of 1 to scan the whole chain",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304028365",
      "id" : 304028365,
      "in_reply_to_id" : 302071555,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNDAyODM2NQ==",
      "original_commit_id" : "e3cc8e102fc2736b3871869646f8d60599988f82",
      "original_position" : 8,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 257040771,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304028365",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304064584"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304064584"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Have importprivkey use CWallet's ImportPrivKeys, ImportScripts, and ImportScriptPubKeys\" (74ec96b601dd6417f01f4801d83e01eeb7dded18)\r\n\r\nI don't understand why this is calling `ImportScriptPubKeys` instead of just `SetAddressBook` like before. This is  confusing because the code is first going out of its way to **remove** associated watch-only scripts from `setWatchOnly` (in AddKeyPubKeyWithDB via ImportPrivKeys):\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/74ec96b601dd6417f01f4801d83e01eeb7dded18/src/wallet/wallet.cpp#L310-L319\r\n\r\nAnd then after removing the scripts it **looks** like it goes out of its way to add them by calling ImportScriptPubKeys. But then the `ImportScriptPubKeys` call doesn't add the scripts because `have_solving_data` and `IsMine` are both `true` in the following check?\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/74ec96b601dd6417f01f4801d83e01eeb7dded18/src/wallet/wallet.cpp#L1724-L1727\r\n\r\nSomething seems wrong here. If scripts are meant to be added to `setWatchOnly` it seems like the removal code shouldn't be called and the adding code might need to be fixed. Of the scripts are meant to be removed, then it's misleading to call `ImportScriptPubKeys` instead of just `SetAddressBook` like before.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-16T18:45:16Z",
      "diff_hunk" : "@@ -175,31 +175,29 @@ UniValue importprivkey(const JSONRPCRequest& request)\n         CPubKey pubkey = key.GetPubKey();\n         assert(key.VerifyPubKey(pubkey));\n         CKeyID vchAddress = pubkey.GetID();\n+\n         {\n             pwallet->MarkDirty();\n \n+            // Use timestamp of 1 to scan the whole chain\n+            if (!pwallet->ImportPrivKeys({{vchAddress, key}}, 1)) {\n+                throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding key to wallet\");\n+            }\n+\n             // We don't know which corresponding address will be used;\n             // label all new addresses, and label existing addresses if a\n             // label was passed.\n+            std::set<CScript> script_pub_keys;\n             for (const auto& dest : GetAllDestinationsForKey(pubkey)) {\n-                if (!request.params[1].isNull() || pwallet->mapAddressBook.count(dest) == 0) {\n-                    pwallet->SetAddressBook(dest, strLabel, \"receive\");\n-                }\n+                CScript script = GetScriptForDestination(dest);\n+                script_pub_keys.insert(script);\n+                pwallet->ImportScriptPubKeys(strLabel, {script}, true /* have_solving_data */, (!request.params[1].isNull()) || pwallet->mapAddressBook.count(dest) == 0 /* apply_label */ , 1 /* timestamp */ );",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304064584",
      "id" : 304064584,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNDA2NDU4NA==",
      "original_commit_id" : "74ec96b601dd6417f01f4801d83e01eeb7dded18",
      "original_position" : 23,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 257040771,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304064584",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304075547"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304075547"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Have importprivkey use CWallet's ImportPrivKeys, ImportScripts, and ImportScriptPubKeys\" (74ec96b601dd6417f01f4801d83e01eeb7dded18)\r\n\r\nIt looks like there is a minor change in behavior here due to implementation of ImportPrivKeys:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/74ec96b601dd6417f01f4801d83e01eeb7dded18/src/wallet/wallet.cpp#L1683\r\n\r\nPreviously nCreateTime would not be updated if key already existed, and now it will be (in memory only, apparently the value is not written to disk on the next line).\r\n\r\nWould suggesting fixing up ImportPrivKeys to avoid this change in behavior, or documenting in the commit message here that there is a slight change in behavior.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-16T19:11:50Z",
      "diff_hunk" : "@@ -175,31 +175,29 @@ UniValue importprivkey(const JSONRPCRequest& request)\n         CPubKey pubkey = key.GetPubKey();\n         assert(key.VerifyPubKey(pubkey));\n         CKeyID vchAddress = pubkey.GetID();\n+\n         {\n             pwallet->MarkDirty();\n \n+            // Use timestamp of 1 to scan the whole chain\n+            if (!pwallet->ImportPrivKeys({{vchAddress, key}}, 1)) {\n+                throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding key to wallet\");\n+            }\n+\n             // We don't know which corresponding address will be used;\n             // label all new addresses, and label existing addresses if a\n             // label was passed.\n+            std::set<CScript> script_pub_keys;\n             for (const auto& dest : GetAllDestinationsForKey(pubkey)) {\n-                if (!request.params[1].isNull() || pwallet->mapAddressBook.count(dest) == 0) {\n-                    pwallet->SetAddressBook(dest, strLabel, \"receive\");\n-                }\n+                CScript script = GetScriptForDestination(dest);\n+                script_pub_keys.insert(script);\n+                pwallet->ImportScriptPubKeys(strLabel, {script}, true /* have_solving_data */, (!request.params[1].isNull()) || pwallet->mapAddressBook.count(dest) == 0 /* apply_label */ , 1 /* timestamp */ );\n             }\n \n-            // Don't throw error in case a key is already there\n-            if (pwallet->HaveKey(vchAddress)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304075547",
      "id" : 304075547,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNDA3NTU0Nw==",
      "original_commit_id" : "74ec96b601dd6417f01f4801d83e01eeb7dded18",
      "original_position" : 27,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 5,
      "pull_request_review_id" : 257040771,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304075547",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304083243"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304083243"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> I'll leave it up to other reviewers to figure if this is desired/same semantics.\r\n\r\n@achow101 could you clarify in commit message whether this causes a change in behavior or not? If you aren't sure, it'd at least be good to say if it potentially changes behavior. This is hurting my head to think about but it seems only potential difference is whether timestamp is overridden when key already exists?\r\n\r\nFor all these commits, it'd be really helpful to note in commit messages whether they do or don't or maybe change behavior and what the scope of the change is.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-16T19:32:22Z",
      "diff_hunk" : "@@ -543,11 +543,20 @@ UniValue importpubkey(const JSONRPCRequest& request)\n         auto locked_chain = pwallet->chain().lock();\n         LOCK(pwallet->cs_wallet);\n \n+        std::set<CScript> script_pub_keys;\n         for (const auto& dest : GetAllDestinationsForKey(pubKey)) {\n-            ImportAddress(pwallet, dest, strLabel);\n+            script_pub_keys.insert(GetScriptForDestination(dest));\n         }\n-        ImportScript(pwallet, GetScriptForRawPubKey(pubKey), strLabel, false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304083243",
      "id" : 304083243,
      "in_reply_to_id" : 299118862,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNDA4MzI0Mw==",
      "original_commit_id" : "94ad6ad965ba6dfffaf7387b15ac659323fc85d0",
      "original_position" : 18,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 103,
      "pull_request_review_id" : 257040771,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304083243",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304085906"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304085906"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Have importaddress use ImportScripts and ImportScriptPubKeys\" (d2b7db13b92391c87adf6db862593b311c7cbdee)\r\n\r\nSlight change of behavior here, if fP2SH is false and the provided scriptpubkey is spendable, this code used throw \"wallet already contains the private key\" error and now it doesn't. This seems like a good change.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-16T19:39:42Z",
      "diff_hunk" : "@@ -345,10 +309,27 @@ UniValue importaddress(const JSONRPCRequest& request)\n             if (fP2SH) {\n                 throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, \"Cannot use the p2sh flag with an address - use a script instead\");\n             }\n-            ImportAddress(pwallet, dest, strLabel);\n+\n+            CScript script = GetScriptForDestination(dest);\n+            if (::IsMine(*pwallet, script) == ISMINE_SPENDABLE) {\n+                throw JSONRPCError(RPC_WALLET_ERROR, \"The wallet already contains the private key for this address or script\");\n+            }\n+\n+            pwallet->MarkDirty();\n+\n+            pwallet->ImportScriptPubKeys(strLabel, {script}, false /* have_solving_data */, true /* apply_label */, 1 /* timestamp */);\n         } else if (IsHex(request.params[0].get_str())) {\n             std::vector<unsigned char> data(ParseHex(request.params[0].get_str()));\n-            ImportScript(pwallet, CScript(data.begin(), data.end()), strLabel, fP2SH);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304085906",
      "id" : 304085906,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNDA4NTkwNg==",
      "original_commit_id" : "d2b7db13b92391c87adf6db862593b311c7cbdee",
      "original_position" : 59,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 80,
      "pull_request_review_id" : 257040771,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304085906",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304090232"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304090232"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Have importaddress use ImportScripts and ImportScriptPubKeys\" (d2b7db13b92391c87adf6db862593b311c7cbdee):\r\n\r\nMaybe call `ImportScripts({redeem_script})` here to avoid needing to share `scripts` variable and have its value change between the two calls.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-16T19:51:59Z",
      "diff_hunk" : "@@ -345,10 +309,27 @@ UniValue importaddress(const JSONRPCRequest& request)\n             if (fP2SH) {\n                 throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, \"Cannot use the p2sh flag with an address - use a script instead\");\n             }\n-            ImportAddress(pwallet, dest, strLabel);\n+\n+            CScript script = GetScriptForDestination(dest);\n+            if (::IsMine(*pwallet, script) == ISMINE_SPENDABLE) {\n+                throw JSONRPCError(RPC_WALLET_ERROR, \"The wallet already contains the private key for this address or script\");\n+            }\n+\n+            pwallet->MarkDirty();\n+\n+            pwallet->ImportScriptPubKeys(strLabel, {script}, false /* have_solving_data */, true /* apply_label */, 1 /* timestamp */);\n         } else if (IsHex(request.params[0].get_str())) {\n             std::vector<unsigned char> data(ParseHex(request.params[0].get_str()));\n-            ImportScript(pwallet, CScript(data.begin(), data.end()), strLabel, fP2SH);\n+            CScript redeem_script(data.begin(), data.end());\n+\n+            std::set<CScript> scripts = {redeem_script};\n+            pwallet->ImportScripts(scripts);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304090232",
      "id" : 304090232,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNDA5MDIzMg==",
      "original_commit_id" : "d2b7db13b92391c87adf6db862593b311c7cbdee",
      "original_position" : 63,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 257040771,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304090232",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304093482"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304093482"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Optionally allow ImportScripts to set script creation timestamp\" (ace5d082034cbaa52f596689433381a2226a21dc)\r\n\r\nCan you clairfy in the commit message whether this is a change in behavior for the `importmulti` RPC. Seems like a minor bugfix?",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-16T20:00:30Z",
      "diff_hunk" : "@@ -1258,7 +1258,7 @@ static UniValue ProcessImport(CWallet * const pwallet, const UniValue& data, con\n \n         // All good, time to import\n         pwallet->MarkDirty();\n-        if (!pwallet->ImportScripts(import_data.import_scripts)) {\n+        if (!pwallet->ImportScripts(import_data.import_scripts, timestamp)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304093482",
      "id" : 304093482,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNDA5MzQ4Mg==",
      "original_commit_id" : "ace5d082034cbaa52f596689433381a2226a21dc",
      "original_position" : 23,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 172,
      "pull_request_review_id" : 257040771,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304093482",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304098499"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304098499"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Have importwallet use ImportPrivKeys and ImportScripts\" (991ecfdbbb289bd6e4c50fc63f9201edbca14f70)\r\n\r\nIMO, would be clearer to call `ImportPrivKeys({keyid, key}}, time)` than have the extra map variable.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-16T20:14:23Z",
      "diff_hunk" : "@@ -663,51 +662,40 @@ UniValue importwallet(const JSONRPCRequest& request)\n             CPubKey pubkey = key.GetPubKey();\n             assert(key.VerifyPubKey(pubkey));\n             CKeyID keyid = pubkey.GetID();\n-            if (pwallet->HaveKey(keyid)) {\n-                pwallet->WalletLogPrintf(\"Skipping import of %s (key already present)\\n\", EncodeDestination(PKHash(keyid)));\n+\n+            std::map<CKeyID, CKey> privkey_map;\n+            privkey_map.emplace(keyid, key);\n+\n+            if (!pwallet->ImportPrivKeys(privkey_map, time)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304098499",
      "id" : 304098499,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNDA5ODQ5OQ==",
      "original_commit_id" : "991ecfdbbb289bd6e4c50fc63f9201edbca14f70",
      "original_position" : 18,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 257040771,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304098499",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304099129"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304099129"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Have importwallet use ImportPrivKeys and ImportScripts\" (991ecfdbbb289bd6e4c50fc63f9201edbca14f70)\r\n\r\nThs doesn't seem right, if HaveKey is true, ImportPrivKeys returns true.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-16T20:15:50Z",
      "diff_hunk" : "@@ -663,51 +662,40 @@ UniValue importwallet(const JSONRPCRequest& request)\n             CPubKey pubkey = key.GetPubKey();\n             assert(key.VerifyPubKey(pubkey));\n             CKeyID keyid = pubkey.GetID();\n-            if (pwallet->HaveKey(keyid)) {\n-                pwallet->WalletLogPrintf(\"Skipping import of %s (key already present)\\n\", EncodeDestination(PKHash(keyid)));\n+\n+            std::map<CKeyID, CKey> privkey_map;\n+            privkey_map.emplace(keyid, key);\n+\n+            if (!pwallet->ImportPrivKeys(privkey_map, time)) {\n+                pwallet->WalletLogPrintf(\"Skipping import of %s (key already present or an error occurred)\\n\", EncodeDestination(PKHash(keyid)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304099129",
      "id" : 304099129,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNDA5OTEyOQ==",
      "original_commit_id" : "991ecfdbbb289bd6e4c50fc63f9201edbca14f70",
      "original_position" : 19,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 257040771,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304099129",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304099688"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304099688"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Have importwallet use ImportPrivKeys and ImportScripts\" (991ecfdbbb289bd6e4c50fc63f9201edbca14f70)\r\n\r\nThis print statement should precede the import above...",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-16T20:17:24Z",
      "diff_hunk" : "@@ -663,51 +662,40 @@ UniValue importwallet(const JSONRPCRequest& request)\n             CPubKey pubkey = key.GetPubKey();\n             assert(key.VerifyPubKey(pubkey));\n             CKeyID keyid = pubkey.GetID();\n-            if (pwallet->HaveKey(keyid)) {\n-                pwallet->WalletLogPrintf(\"Skipping import of %s (key already present)\\n\", EncodeDestination(PKHash(keyid)));\n+\n+            std::map<CKeyID, CKey> privkey_map;\n+            privkey_map.emplace(keyid, key);\n+\n+            if (!pwallet->ImportPrivKeys(privkey_map, time)) {\n+                pwallet->WalletLogPrintf(\"Skipping import of %s (key already present or an error occurred)\\n\", EncodeDestination(PKHash(keyid)));\n                 continue;\n             }\n+\n             pwallet->WalletLogPrintf(\"Importing %s...\\n\", EncodeDestination(PKHash(keyid)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304099688",
      "id" : 304099688,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNDA5OTY4OA==",
      "original_commit_id" : "991ecfdbbb289bd6e4c50fc63f9201edbca14f70",
      "original_position" : 23,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 257040771,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304099688",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304101655"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304101655"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Have importwallet use ImportPrivKeys and ImportScripts\" (991ecfdbbb289bd6e4c50fc63f9201edbca14f70)\r\n\r\n> Both have HaveKey and/or HaveCScript checks that can fail, but not cause the import to be bad. \r\n\r\nWhat's this referring to? Import methods seem to return true if imported data was already found. But maybe I'm misinterpreting. Might help to refer to a specific example.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-16T20:22:13Z",
      "diff_hunk" : "@@ -691,31 +691,20 @@ UniValue importwallet(const JSONRPCRequest& request)\n             const CScript& script = script_pair.first;\n             int64_t time = script_pair.second;\n             CScriptID id(script);\n-            if (pwallet->HaveCScript(id)) {\n-                pwallet->WalletLogPrintf(\"Skipping import of %s (script already present)\\n\", HexStr(script));\n-                continue;\n-            }\n-            if(!pwallet->AddCScript(script)) {\n-                pwallet->WalletLogPrintf(\"Error importing script %s\\n\", HexStr(script));\n-                fGood = false;\n+\n+            if (pwallet->ImportScripts({script}, time)) {\n+                pwallet->WalletLogPrintf(\"Skipping import of %s (script already present or an error occurred)\\n\", HexStr(script));\n                 continue;\n             }\n-            if (time > 0) {\n-                pwallet->m_script_metadata[id].nCreateTime = time;\n-                nTimeBegin = std::min(nTimeBegin, time);\n-            }\n+\n             progress++;\n         }\n         pwallet->chain().showProgress(\"\", 100, false); // hide progress dialog in GUI\n-        pwallet->UpdateTimeFirstKey(nTimeBegin);\n     }\n     pwallet->chain().showProgress(\"\", 100, false); // hide progress dialog in GUI\n     RescanWallet(*pwallet, reserver, nTimeBegin, false /* update */);\n     pwallet->MarkDirty();\n \n-    if (!fGood)\n-        throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding some keys/scripts to wallet\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304101655",
      "id" : 304101655,
      "in_reply_to_id" : 298813022,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNDEwMTY1NQ==",
      "original_commit_id" : "e66ed3b84593bebd3550e18b5b3be3605e08ced1",
      "original_position" : 68,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 257040771,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304101655",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304144659"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304144659"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It won't ever add the scripts as watch only because we import the private keys earlier.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-16T22:12:02Z",
      "diff_hunk" : "@@ -175,31 +175,29 @@ UniValue importprivkey(const JSONRPCRequest& request)\n         CPubKey pubkey = key.GetPubKey();\n         assert(key.VerifyPubKey(pubkey));\n         CKeyID vchAddress = pubkey.GetID();\n+\n         {\n             pwallet->MarkDirty();\n \n+            // Use timestamp of 1 to scan the whole chain\n+            if (!pwallet->ImportPrivKeys({{vchAddress, key}}, 1)) {\n+                throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding key to wallet\");\n+            }\n+\n             // We don't know which corresponding address will be used;\n             // label all new addresses, and label existing addresses if a\n             // label was passed.\n+            std::set<CScript> script_pub_keys;\n             for (const auto& dest : GetAllDestinationsForKey(pubkey)) {\n-                if (!request.params[1].isNull() || pwallet->mapAddressBook.count(dest) == 0) {\n-                    pwallet->SetAddressBook(dest, strLabel, \"receive\");\n-                }\n+                CScript script = GetScriptForDestination(dest);\n+                script_pub_keys.insert(script);\n+                pwallet->ImportScriptPubKeys(strLabel, {script}, true /* have_solving_data */, (request.params[1].isNull()) && pwallet->mapAddressBook.count(dest) != 0 /* internal */ , 1 /* timestamp */ );",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304144659",
      "id" : 304144659,
      "in_reply_to_id" : 299603966,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNDE0NDY1OQ==",
      "original_commit_id" : "e3cc8e102fc2736b3871869646f8d60599988f82",
      "original_position" : 23,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 262716589,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304144659",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304155425"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304155425"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't see the benefit of doing that.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-16T22:38:58Z",
      "diff_hunk" : "@@ -345,10 +309,27 @@ UniValue importaddress(const JSONRPCRequest& request)\n             if (fP2SH) {\n                 throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, \"Cannot use the p2sh flag with an address - use a script instead\");\n             }\n-            ImportAddress(pwallet, dest, strLabel);\n+\n+            CScript script = GetScriptForDestination(dest);\n+            if (::IsMine(*pwallet, script) == ISMINE_SPENDABLE) {\n+                throw JSONRPCError(RPC_WALLET_ERROR, \"The wallet already contains the private key for this address or script\");\n+            }\n+\n+            pwallet->MarkDirty();\n+\n+            pwallet->ImportScriptPubKeys(strLabel, {script}, false /* have_solving_data */, true /* apply_label */, 1 /* timestamp */);\n         } else if (IsHex(request.params[0].get_str())) {\n             std::vector<unsigned char> data(ParseHex(request.params[0].get_str()));\n-            ImportScript(pwallet, CScript(data.begin(), data.end()), strLabel, fP2SH);\n+            CScript redeem_script(data.begin(), data.end());\n+\n+            std::set<CScript> scripts = {redeem_script};\n+            pwallet->ImportScripts(scripts);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304155425",
      "id" : 304155425,
      "in_reply_to_id" : 304090232,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNDE1NTQyNQ==",
      "original_commit_id" : "d2b7db13b92391c87adf6db862593b311c7cbdee",
      "original_position" : 63,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 262725253,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304155425",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304156641"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304156641"
         }
      },
      "author_association" : "MEMBER",
      "body" : "~~No?~~\r\n\r\nnvm, looking at a change that I had locally",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-16T22:43:29Z",
      "diff_hunk" : "@@ -663,51 +662,40 @@ UniValue importwallet(const JSONRPCRequest& request)\n             CPubKey pubkey = key.GetPubKey();\n             assert(key.VerifyPubKey(pubkey));\n             CKeyID keyid = pubkey.GetID();\n-            if (pwallet->HaveKey(keyid)) {\n-                pwallet->WalletLogPrintf(\"Skipping import of %s (key already present)\\n\", EncodeDestination(PKHash(keyid)));\n+\n+            std::map<CKeyID, CKey> privkey_map;\n+            privkey_map.emplace(keyid, key);\n+\n+            if (!pwallet->ImportPrivKeys(privkey_map, time)) {\n+                pwallet->WalletLogPrintf(\"Skipping import of %s (key already present or an error occurred)\\n\", EncodeDestination(PKHash(keyid)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304156641",
      "id" : 304156641,
      "in_reply_to_id" : 304099129,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNDE1NjY0MQ==",
      "original_commit_id" : "991ecfdbbb289bd6e4c50fc63f9201edbca14f70",
      "original_position" : 19,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 262726648,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304156641",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304162432"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304162432"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Turns out I was having a hard time with the negations.\r\n\r\nI've pushed another commit that makes it more explicit when something is being skipped because we already have it, as well as logging when this happens.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-16T23:06:43Z",
      "diff_hunk" : "@@ -691,31 +691,20 @@ UniValue importwallet(const JSONRPCRequest& request)\n             const CScript& script = script_pair.first;\n             int64_t time = script_pair.second;\n             CScriptID id(script);\n-            if (pwallet->HaveCScript(id)) {\n-                pwallet->WalletLogPrintf(\"Skipping import of %s (script already present)\\n\", HexStr(script));\n-                continue;\n-            }\n-            if(!pwallet->AddCScript(script)) {\n-                pwallet->WalletLogPrintf(\"Error importing script %s\\n\", HexStr(script));\n-                fGood = false;\n+\n+            if (pwallet->ImportScripts({script}, time)) {\n+                pwallet->WalletLogPrintf(\"Skipping import of %s (script already present or an error occurred)\\n\", HexStr(script));\n                 continue;\n             }\n-            if (time > 0) {\n-                pwallet->m_script_metadata[id].nCreateTime = time;\n-                nTimeBegin = std::min(nTimeBegin, time);\n-            }\n+\n             progress++;\n         }\n         pwallet->chain().showProgress(\"\", 100, false); // hide progress dialog in GUI\n-        pwallet->UpdateTimeFirstKey(nTimeBegin);\n     }\n     pwallet->chain().showProgress(\"\", 100, false); // hide progress dialog in GUI\n     RescanWallet(*pwallet, reserver, nTimeBegin, false /* update */);\n     pwallet->MarkDirty();\n \n-    if (!fGood)\n-        throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding some keys/scripts to wallet\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304162432",
      "id" : 304162432,
      "in_reply_to_id" : 298813022,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNDE2MjQzMg==",
      "original_commit_id" : "e66ed3b84593bebd3550e18b5b3be3605e08ced1",
      "original_position" : 68,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 262733441,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304162432",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304162676"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304162676"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've added a note to each commit indicating what behavior changes in it.\r\n\r\nHere, the only behavior change is that the timestamp for the key will be set to 1 if we already have it.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-16T23:07:49Z",
      "diff_hunk" : "@@ -543,11 +543,20 @@ UniValue importpubkey(const JSONRPCRequest& request)\n         auto locked_chain = pwallet->chain().lock();\n         LOCK(pwallet->cs_wallet);\n \n+        std::set<CScript> script_pub_keys;\n         for (const auto& dest : GetAllDestinationsForKey(pubKey)) {\n-            ImportAddress(pwallet, dest, strLabel);\n+            script_pub_keys.insert(GetScriptForDestination(dest));\n         }\n-        ImportScript(pwallet, GetScriptForRawPubKey(pubKey), strLabel, false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304162676",
      "id" : 304162676,
      "in_reply_to_id" : 299118862,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNDE2MjY3Ng==",
      "original_commit_id" : "94ad6ad965ba6dfffaf7387b15ac659323fc85d0",
      "original_position" : 18,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 103,
      "pull_request_review_id" : 262733775,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304162676",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304162769"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304162769"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oh, whoops. Fixed.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-16T23:08:16Z",
      "diff_hunk" : "@@ -663,51 +662,40 @@ UniValue importwallet(const JSONRPCRequest& request)\n             CPubKey pubkey = key.GetPubKey();\n             assert(key.VerifyPubKey(pubkey));\n             CKeyID keyid = pubkey.GetID();\n-            if (pwallet->HaveKey(keyid)) {\n-                pwallet->WalletLogPrintf(\"Skipping import of %s (key already present)\\n\", EncodeDestination(PKHash(keyid)));\n+\n+            std::map<CKeyID, CKey> privkey_map;\n+            privkey_map.emplace(keyid, key);\n+\n+            if (!pwallet->ImportPrivKeys(privkey_map, time)) {\n+                pwallet->WalletLogPrintf(\"Skipping import of %s (key already present or an error occurred)\\n\", EncodeDestination(PKHash(keyid)));\n                 continue;\n             }\n+\n             pwallet->WalletLogPrintf(\"Importing %s...\\n\", EncodeDestination(PKHash(keyid)));\n-            if (!pwallet->AddKeyPubKey(key, pubkey)) {\n-                fGood = false;\n-                continue;\n-            }\n-            pwallet->mapKeyMetadata[keyid].nCreateTime = time;\n-            if (has_label)\n-                pwallet->SetAddressBook(PKHash(keyid), label, \"receive\");\n+\n+            pwallet->ImportScriptPubKeys(label, {GetScriptForDestination(PKHash(keyid))}, true /* have_solving_data */, has_label, time);\n+\n             nTimeBegin = std::min(nTimeBegin, time);\n             progress++;\n         }\n         for (const auto& script_pair : scripts) {\n             pwallet->chain().showProgress(\"\", std::max(50, std::min(75, (int)((progress / total) * 100) + 50)), false);\n             const CScript& script = script_pair.first;\n             int64_t time = script_pair.second;\n-            CScriptID id(script);\n-            if (pwallet->HaveCScript(id)) {\n-                pwallet->WalletLogPrintf(\"Skipping import of %s (script already present)\\n\", HexStr(script));\n-                continue;\n-            }\n-            if(!pwallet->AddCScript(script)) {\n-                pwallet->WalletLogPrintf(\"Error importing script %s\\n\", HexStr(script));\n-                fGood = false;\n+\n+            if (pwallet->ImportScripts({script}, time)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304162769",
      "id" : 304162769,
      "in_reply_to_id" : 302096091,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNDE2Mjc2OQ==",
      "original_commit_id" : "041e65458e1a3ad729520682020f9a177125f97d",
      "original_position" : 50,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 262733890,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304162769",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304162832"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304162832"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Reverted the below change entirely.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-16T23:08:32Z",
      "diff_hunk" : "@@ -175,31 +175,29 @@ UniValue importprivkey(const JSONRPCRequest& request)\n         CPubKey pubkey = key.GetPubKey();\n         assert(key.VerifyPubKey(pubkey));\n         CKeyID vchAddress = pubkey.GetID();\n+\n         {\n             pwallet->MarkDirty();\n \n+            // Use timestamp of 1 to scan the whole chain\n+            if (!pwallet->ImportPrivKeys({{vchAddress, key}}, 1)) {\n+                throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding key to wallet\");\n+            }\n+\n             // We don't know which corresponding address will be used;\n             // label all new addresses, and label existing addresses if a\n             // label was passed.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304162832",
      "id" : 304162832,
      "in_reply_to_id" : 299598438,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNDE2MjgzMg==",
      "original_commit_id" : "e3cc8e102fc2736b3871869646f8d60599988f82",
      "original_position" : 15,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 262733972,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304162832",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304162862"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304162862"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Reverted this change",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-16T23:08:39Z",
      "diff_hunk" : "@@ -175,31 +175,29 @@ UniValue importprivkey(const JSONRPCRequest& request)\n         CPubKey pubkey = key.GetPubKey();\n         assert(key.VerifyPubKey(pubkey));\n         CKeyID vchAddress = pubkey.GetID();\n+\n         {\n             pwallet->MarkDirty();\n \n+            // Use timestamp of 1 to scan the whole chain\n+            if (!pwallet->ImportPrivKeys({{vchAddress, key}}, 1)) {\n+                throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding key to wallet\");\n+            }\n+\n             // We don't know which corresponding address will be used;\n             // label all new addresses, and label existing addresses if a\n             // label was passed.\n+            std::set<CScript> script_pub_keys;\n             for (const auto& dest : GetAllDestinationsForKey(pubkey)) {\n-                if (!request.params[1].isNull() || pwallet->mapAddressBook.count(dest) == 0) {\n-                    pwallet->SetAddressBook(dest, strLabel, \"receive\");\n-                }\n+                CScript script = GetScriptForDestination(dest);\n+                script_pub_keys.insert(script);\n+                pwallet->ImportScriptPubKeys(strLabel, {script}, true /* have_solving_data */, (request.params[1].isNull()) && pwallet->mapAddressBook.count(dest) != 0 /* internal */ , 1 /* timestamp */ );",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304162862",
      "id" : 304162862,
      "in_reply_to_id" : 299603966,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNDE2Mjg2Mg==",
      "original_commit_id" : "e3cc8e102fc2736b3871869646f8d60599988f82",
      "original_position" : 23,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 262734004,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304162862",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304162880"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304162880"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Reverted this change",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-16T23:08:43Z",
      "diff_hunk" : "@@ -175,31 +175,29 @@ UniValue importprivkey(const JSONRPCRequest& request)\n         CPubKey pubkey = key.GetPubKey();\n         assert(key.VerifyPubKey(pubkey));\n         CKeyID vchAddress = pubkey.GetID();\n+\n         {\n             pwallet->MarkDirty();\n \n+            // Use timestamp of 1 to scan the whole chain\n+            if (!pwallet->ImportPrivKeys({{vchAddress, key}}, 1)) {\n+                throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding key to wallet\");\n+            }\n+\n             // We don't know which corresponding address will be used;\n             // label all new addresses, and label existing addresses if a\n             // label was passed.\n+            std::set<CScript> script_pub_keys;\n             for (const auto& dest : GetAllDestinationsForKey(pubkey)) {\n-                if (!request.params[1].isNull() || pwallet->mapAddressBook.count(dest) == 0) {\n-                    pwallet->SetAddressBook(dest, strLabel, \"receive\");\n-                }\n+                CScript script = GetScriptForDestination(dest);\n+                script_pub_keys.insert(script);\n+                pwallet->ImportScriptPubKeys(strLabel, {script}, true /* have_solving_data */, (!request.params[1].isNull()) || pwallet->mapAddressBook.count(dest) == 0 /* apply_label */ , 1 /* timestamp */ );",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304162880",
      "id" : 304162880,
      "in_reply_to_id" : 304064584,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNDE2Mjg4MA==",
      "original_commit_id" : "74ec96b601dd6417f01f4801d83e01eeb7dded18",
      "original_position" : 23,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 262734026,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304162880",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304162946"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304162946"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed `ImportPrivKeys`",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-16T23:09:01Z",
      "diff_hunk" : "@@ -175,31 +175,29 @@ UniValue importprivkey(const JSONRPCRequest& request)\n         CPubKey pubkey = key.GetPubKey();\n         assert(key.VerifyPubKey(pubkey));\n         CKeyID vchAddress = pubkey.GetID();\n+\n         {\n             pwallet->MarkDirty();\n \n+            // Use timestamp of 1 to scan the whole chain\n+            if (!pwallet->ImportPrivKeys({{vchAddress, key}}, 1)) {\n+                throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding key to wallet\");\n+            }\n+\n             // We don't know which corresponding address will be used;\n             // label all new addresses, and label existing addresses if a\n             // label was passed.\n+            std::set<CScript> script_pub_keys;\n             for (const auto& dest : GetAllDestinationsForKey(pubkey)) {\n-                if (!request.params[1].isNull() || pwallet->mapAddressBook.count(dest) == 0) {\n-                    pwallet->SetAddressBook(dest, strLabel, \"receive\");\n-                }\n+                CScript script = GetScriptForDestination(dest);\n+                script_pub_keys.insert(script);\n+                pwallet->ImportScriptPubKeys(strLabel, {script}, true /* have_solving_data */, (!request.params[1].isNull()) || pwallet->mapAddressBook.count(dest) == 0 /* apply_label */ , 1 /* timestamp */ );\n             }\n \n-            // Don't throw error in case a key is already there\n-            if (pwallet->HaveKey(vchAddress)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304162946",
      "id" : 304162946,
      "in_reply_to_id" : 304075547,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNDE2Mjk0Ng==",
      "original_commit_id" : "74ec96b601dd6417f01f4801d83e01eeb7dded18",
      "original_position" : 27,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 5,
      "pull_request_review_id" : 262734103,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304162946",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304163174"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304163174"
         }
      },
      "author_association" : "MEMBER",
      "body" : "To be consistent, I've also removed the fail if `HaveKey` above. This results in labels being updated if things already existed.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-16T23:10:03Z",
      "diff_hunk" : "@@ -345,10 +309,27 @@ UniValue importaddress(const JSONRPCRequest& request)\n             if (fP2SH) {\n                 throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, \"Cannot use the p2sh flag with an address - use a script instead\");\n             }\n-            ImportAddress(pwallet, dest, strLabel);\n+\n+            CScript script = GetScriptForDestination(dest);\n+            if (::IsMine(*pwallet, script) == ISMINE_SPENDABLE) {\n+                throw JSONRPCError(RPC_WALLET_ERROR, \"The wallet already contains the private key for this address or script\");\n+            }\n+\n+            pwallet->MarkDirty();\n+\n+            pwallet->ImportScriptPubKeys(strLabel, {script}, false /* have_solving_data */, true /* apply_label */, 1 /* timestamp */);\n         } else if (IsHex(request.params[0].get_str())) {\n             std::vector<unsigned char> data(ParseHex(request.params[0].get_str()));\n-            ImportScript(pwallet, CScript(data.begin(), data.end()), strLabel, fP2SH);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304163174",
      "id" : 304163174,
      "in_reply_to_id" : 304085906,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNDE2MzE3NA==",
      "original_commit_id" : "d2b7db13b92391c87adf6db862593b311c7cbdee",
      "original_position" : 59,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 80,
      "pull_request_review_id" : 262734388,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304163174",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304163243"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304163243"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-16T23:10:23Z",
      "diff_hunk" : "@@ -1258,7 +1258,7 @@ static UniValue ProcessImport(CWallet * const pwallet, const UniValue& data, con\n \n         // All good, time to import\n         pwallet->MarkDirty();\n-        if (!pwallet->ImportScripts(import_data.import_scripts)) {\n+        if (!pwallet->ImportScripts(import_data.import_scripts, timestamp)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304163243",
      "id" : 304163243,
      "in_reply_to_id" : 304093482,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNDE2MzI0Mw==",
      "original_commit_id" : "ace5d082034cbaa52f596689433381a2226a21dc",
      "original_position" : 23,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 172,
      "pull_request_review_id" : 262734469,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304163243",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304163256"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304163256"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-16T23:10:27Z",
      "diff_hunk" : "@@ -663,51 +662,40 @@ UniValue importwallet(const JSONRPCRequest& request)\n             CPubKey pubkey = key.GetPubKey();\n             assert(key.VerifyPubKey(pubkey));\n             CKeyID keyid = pubkey.GetID();\n-            if (pwallet->HaveKey(keyid)) {\n-                pwallet->WalletLogPrintf(\"Skipping import of %s (key already present)\\n\", EncodeDestination(PKHash(keyid)));\n+\n+            std::map<CKeyID, CKey> privkey_map;\n+            privkey_map.emplace(keyid, key);\n+\n+            if (!pwallet->ImportPrivKeys(privkey_map, time)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304163256",
      "id" : 304163256,
      "in_reply_to_id" : 304098499,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNDE2MzI1Ng==",
      "original_commit_id" : "991ecfdbbb289bd6e4c50fc63f9201edbca14f70",
      "original_position" : 18,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 262734489,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304163256",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304163311"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304163311"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've restored `fGood` and the error messages.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-16T23:10:45Z",
      "diff_hunk" : "@@ -663,51 +662,40 @@ UniValue importwallet(const JSONRPCRequest& request)\n             CPubKey pubkey = key.GetPubKey();\n             assert(key.VerifyPubKey(pubkey));\n             CKeyID keyid = pubkey.GetID();\n-            if (pwallet->HaveKey(keyid)) {\n-                pwallet->WalletLogPrintf(\"Skipping import of %s (key already present)\\n\", EncodeDestination(PKHash(keyid)));\n+\n+            std::map<CKeyID, CKey> privkey_map;\n+            privkey_map.emplace(keyid, key);\n+\n+            if (!pwallet->ImportPrivKeys(privkey_map, time)) {\n+                pwallet->WalletLogPrintf(\"Skipping import of %s (key already present or an error occurred)\\n\", EncodeDestination(PKHash(keyid)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304163311",
      "id" : 304163311,
      "in_reply_to_id" : 304099129,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNDE2MzMxMQ==",
      "original_commit_id" : "991ecfdbbb289bd6e4c50fc63f9201edbca14f70",
      "original_position" : 19,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 262734561,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304163311",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304163340"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304163340"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-16T23:10:53Z",
      "diff_hunk" : "@@ -663,51 +662,40 @@ UniValue importwallet(const JSONRPCRequest& request)\n             CPubKey pubkey = key.GetPubKey();\n             assert(key.VerifyPubKey(pubkey));\n             CKeyID keyid = pubkey.GetID();\n-            if (pwallet->HaveKey(keyid)) {\n-                pwallet->WalletLogPrintf(\"Skipping import of %s (key already present)\\n\", EncodeDestination(PKHash(keyid)));\n+\n+            std::map<CKeyID, CKey> privkey_map;\n+            privkey_map.emplace(keyid, key);\n+\n+            if (!pwallet->ImportPrivKeys(privkey_map, time)) {\n+                pwallet->WalletLogPrintf(\"Skipping import of %s (key already present or an error occurred)\\n\", EncodeDestination(PKHash(keyid)));\n                 continue;\n             }\n+\n             pwallet->WalletLogPrintf(\"Importing %s...\\n\", EncodeDestination(PKHash(keyid)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304163340",
      "id" : 304163340,
      "in_reply_to_id" : 304099688,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNDE2MzM0MA==",
      "original_commit_id" : "991ecfdbbb289bd6e4c50fc63f9201edbca14f70",
      "original_position" : 23,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 262734595,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304163340",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304316207"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304316207"
         }
      },
      "author_association" : "MEMBER",
      "body" : "7a58ad5624b2ea9c2d2c661446cc6e046a222fca\r\n\r\n`nTimeBegin` is not being updated, the rescan below could miss wallet transactions?",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-17T09:54:08Z",
      "diff_hunk" : "@@ -656,43 +656,34 @@ UniValue importwallet(const JSONRPCRequest& request)\n             CPubKey pubkey = key.GetPubKey();\n             assert(key.VerifyPubKey(pubkey));\n             CKeyID keyid = pubkey.GetID();\n-            if (pwallet->HaveKey(keyid)) {\n-                pwallet->WalletLogPrintf(\"Skipping import of %s (key already present)\\n\", EncodeDestination(PKHash(keyid)));\n-                continue;\n-            }\n+\n             pwallet->WalletLogPrintf(\"Importing %s...\\n\", EncodeDestination(PKHash(keyid)));\n-            if (!pwallet->AddKeyPubKey(key, pubkey)) {\n+\n+            if (!pwallet->ImportPrivKeys({{keyid, key}}, time)) {\n+                pwallet->WalletLogPrintf(\"Error importing key for %s\\n\", EncodeDestination(PKHash(keyid)));\n                 fGood = false;\n                 continue;\n             }\n-            pwallet->mapKeyMetadata[keyid].nCreateTime = time;\n-            if (has_label)\n-                pwallet->SetAddressBook(PKHash(keyid), label, \"receive\");\n+\n+            pwallet->ImportScriptPubKeys(label, {GetScriptForDestination(PKHash(keyid))}, true /* have_solving_data */, has_label /* apply_label */, time /* timestamp */);\n+\n             nTimeBegin = std::min(nTimeBegin, time);\n             progress++;\n         }\n         for (const auto& script_pair : scripts) {\n             pwallet->chain().showProgress(\"\", std::max(50, std::min(75, (int)((progress / total) * 100) + 50)), false);\n             const CScript& script = script_pair.first;\n             int64_t time = script_pair.second;\n-            CScriptID id(script);\n-            if (pwallet->HaveCScript(id)) {\n-                pwallet->WalletLogPrintf(\"Skipping import of %s (script already present)\\n\", HexStr(script));\n-                continue;\n-            }\n-            if(!pwallet->AddCScript(script)) {\n+\n+            if (!pwallet->ImportScripts({script}, time)) {\n                 pwallet->WalletLogPrintf(\"Error importing script %s\\n\", HexStr(script));\n                 fGood = false;\n                 continue;\n             }\n-            if (time > 0) {\n-                pwallet->m_script_metadata[id].nCreateTime = time;\n-                nTimeBegin = std::min(nTimeBegin, time);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304316207",
      "id" : 304316207,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNDMxNjIwNw==",
      "original_commit_id" : "7a58ad5624b2ea9c2d2c661446cc6e046a222fca",
      "original_position" : 44,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 262920886,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304316207",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304319552"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304319552"
         }
      },
      "author_association" : "MEMBER",
      "body" : "7a58ad5624b2ea9c2d2c661446cc6e046a222fca\r\n\r\nnit, this wouldn't be logged if the key is present.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-17T10:01:49Z",
      "diff_hunk" : "@@ -656,43 +656,34 @@ UniValue importwallet(const JSONRPCRequest& request)\n             CPubKey pubkey = key.GetPubKey();\n             assert(key.VerifyPubKey(pubkey));\n             CKeyID keyid = pubkey.GetID();\n-            if (pwallet->HaveKey(keyid)) {\n-                pwallet->WalletLogPrintf(\"Skipping import of %s (key already present)\\n\", EncodeDestination(PKHash(keyid)));\n-                continue;\n-            }\n+\n             pwallet->WalletLogPrintf(\"Importing %s...\\n\", EncodeDestination(PKHash(keyid)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304319552",
      "id" : 304319552,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNDMxOTU1Mg==",
      "original_commit_id" : "7a58ad5624b2ea9c2d2c661446cc6e046a222fca",
      "original_position" : 9,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 123,
      "pull_request_review_id" : 262920886,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304319552",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304470270"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304470270"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added the `nTimeBegin` update back.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-17T15:21:54Z",
      "diff_hunk" : "@@ -656,43 +656,34 @@ UniValue importwallet(const JSONRPCRequest& request)\n             CPubKey pubkey = key.GetPubKey();\n             assert(key.VerifyPubKey(pubkey));\n             CKeyID keyid = pubkey.GetID();\n-            if (pwallet->HaveKey(keyid)) {\n-                pwallet->WalletLogPrintf(\"Skipping import of %s (key already present)\\n\", EncodeDestination(PKHash(keyid)));\n-                continue;\n-            }\n+\n             pwallet->WalletLogPrintf(\"Importing %s...\\n\", EncodeDestination(PKHash(keyid)));\n-            if (!pwallet->AddKeyPubKey(key, pubkey)) {\n+\n+            if (!pwallet->ImportPrivKeys({{keyid, key}}, time)) {\n+                pwallet->WalletLogPrintf(\"Error importing key for %s\\n\", EncodeDestination(PKHash(keyid)));\n                 fGood = false;\n                 continue;\n             }\n-            pwallet->mapKeyMetadata[keyid].nCreateTime = time;\n-            if (has_label)\n-                pwallet->SetAddressBook(PKHash(keyid), label, \"receive\");\n+\n+            pwallet->ImportScriptPubKeys(label, {GetScriptForDestination(PKHash(keyid))}, true /* have_solving_data */, has_label /* apply_label */, time /* timestamp */);\n+\n             nTimeBegin = std::min(nTimeBegin, time);\n             progress++;\n         }\n         for (const auto& script_pair : scripts) {\n             pwallet->chain().showProgress(\"\", std::max(50, std::min(75, (int)((progress / total) * 100) + 50)), false);\n             const CScript& script = script_pair.first;\n             int64_t time = script_pair.second;\n-            CScriptID id(script);\n-            if (pwallet->HaveCScript(id)) {\n-                pwallet->WalletLogPrintf(\"Skipping import of %s (script already present)\\n\", HexStr(script));\n-                continue;\n-            }\n-            if(!pwallet->AddCScript(script)) {\n+\n+            if (!pwallet->ImportScripts({script}, time)) {\n                 pwallet->WalletLogPrintf(\"Error importing script %s\\n\", HexStr(script));\n                 fGood = false;\n                 continue;\n             }\n-            if (time > 0) {\n-                pwallet->m_script_metadata[id].nCreateTime = time;\n-                nTimeBegin = std::min(nTimeBegin, time);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304470270",
      "id" : 304470270,
      "in_reply_to_id" : 304316207,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNDQ3MDI3MA==",
      "original_commit_id" : "7a58ad5624b2ea9c2d2c661446cc6e046a222fca",
      "original_position" : 44,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 263130719,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304470270",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304470399"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304470399"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added a note in the commit message that this happens.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-17T15:22:05Z",
      "diff_hunk" : "@@ -656,43 +656,34 @@ UniValue importwallet(const JSONRPCRequest& request)\n             CPubKey pubkey = key.GetPubKey();\n             assert(key.VerifyPubKey(pubkey));\n             CKeyID keyid = pubkey.GetID();\n-            if (pwallet->HaveKey(keyid)) {\n-                pwallet->WalletLogPrintf(\"Skipping import of %s (key already present)\\n\", EncodeDestination(PKHash(keyid)));\n-                continue;\n-            }\n+\n             pwallet->WalletLogPrintf(\"Importing %s...\\n\", EncodeDestination(PKHash(keyid)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304470399",
      "id" : 304470399,
      "in_reply_to_id" : 304319552,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNDQ3MDM5OQ==",
      "original_commit_id" : "7a58ad5624b2ea9c2d2c661446cc6e046a222fca",
      "original_position" : 9,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 123,
      "pull_request_review_id" : 263130838,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304470399",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304545403"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304545403"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Log when an import is being skipped because we already have it\" (8bd426d238a526f8cfa4e8dd567fb3ccadb40cf7)\r\n\r\nNote: Beyond adding the log, this commit also changes behavior of ImportPrivKeys to not update the nCreateTime when the key already exists. This is a good change, so just wanted to point it out.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-17T17:08:25Z",
      "diff_hunk" : "@@ -1680,9 +1685,14 @@ bool CWallet::ImportPrivKeys(const std::map<CKeyID, CKey>& privkey_map, const in\n         CPubKey pubkey = key.GetPubKey();\n         const CKeyID& id = entry.first;\n         assert(key.VerifyPubKey(pubkey));\n+        // Skip if we already have the key\n+        if (HaveKey(id)) {\n+            WalletLogPrintf(\"Already have key with pubkey %s, skipping\\n\", HexStr(pubkey));\n+            continue;\n+        }\n         mapKeyMetadata[id].nCreateTime = timestamp;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304545403",
      "id" : 304545403,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNDU0NTQwMw==",
      "original_commit_id" : "8bd426d238a526f8cfa4e8dd567fb3ccadb40cf7",
      "original_position" : 23,
      "path" : "src/wallet/wallet.cpp",
      "position" : 39,
      "pull_request_review_id" : 263194978,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304545403",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304548365"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304548365"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Have importprivkey use CWallet's ImportPrivKeys, ImportScripts, and ImportScriptPubKeys\" (5776e6d72e76e03251d346588035fcdb0423440c)\r\n\r\nNice! From ea665e323f76766def6c4f46a46c53e38365d179 to 5776e6d72e76e03251d346588035fcdb0423440c this commit is so much simpler now. The ImportScriptPubKeys stuff was so confusing to me before.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-17T17:15:34Z",
      "diff_hunk" : "@@ -187,19 +187,15 @@ UniValue importprivkey(const JSONRPCRequest& request)\n                 }\n             }\n \n-            // Don't throw error in case a key is already there\n-            if (pwallet->HaveKey(vchAddress)) {\n-                return NullUniValue;\n+            // Use timestamp of 1 to scan the whole chain\n+            if (!pwallet->ImportPrivKeys({{vchAddress, key}}, 1)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304548365",
      "id" : 304548365,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNDU0ODM2NQ==",
      "original_commit_id" : "5776e6d72e76e03251d346588035fcdb0423440c",
      "original_position" : 8,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 8,
      "pull_request_review_id" : 263194978,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304548365",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304550340"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304550340"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Have importprivkey use CWallet's ImportPrivKeys, ImportScripts, and ImportScriptPubKeys\" (5776e6d72e76e03251d346588035fcdb0423440c)\r\n\r\nJust for the record, I like Sjors idea of putting the AddKeyPubKey->ImportPrivKeys and LearnAllRelatedScripts->ImportScripts in two separate commits, since they are independent changes. But it's not very important.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-17T17:20:42Z",
      "diff_hunk" : "@@ -175,31 +175,32 @@ UniValue importprivkey(const JSONRPCRequest& request)\n         CPubKey pubkey = key.GetPubKey();\n         assert(key.VerifyPubKey(pubkey));\n         CKeyID vchAddress = pubkey.GetID();\n+\n+        std::map<CKeyID, CKey> privkey_map;\n+        privkey_map.emplace(vchAddress, key);\n+\n         {\n             pwallet->MarkDirty();\n \n+            // Use timestamp of 1 to scan the whole chain\n+            if (!pwallet->ImportPrivKeys(privkey_map, 1)) {\n+                throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding key to wallet\");\n+            }\n+\n             // We don't know which corresponding address will be used;\n             // label all new addresses, and label existing addresses if a\n             // label was passed.\n+            std::set<CScript> script_pub_keys;\n             for (const auto& dest : GetAllDestinationsForKey(pubkey)) {\n-                if (!request.params[1].isNull() || pwallet->mapAddressBook.count(dest) == 0) {\n-                    pwallet->SetAddressBook(dest, strLabel, \"receive\");\n-                }\n-            }\n-\n-            // Don't throw error in case a key is already there\n-            if (pwallet->HaveKey(vchAddress)) {\n-                return NullUniValue;\n+                CScript script = GetScriptForDestination(dest);\n+                script_pub_keys.insert(script);\n+                pwallet->ImportScriptPubKeys(strLabel, {script}, true, false, 1, (!request.params[1].isNull()) || pwallet->mapAddressBook.count(dest) == 0);\n             }\n \n-            // whenever a key is imported, we need to scan the whole chain\n-            pwallet->UpdateTimeFirstKey(1);\n-            pwallet->mapKeyMetadata[vchAddress].nCreateTime = 1;\n-\n-            if (!pwallet->AddKeyPubKey(key, pubkey)) {\n-                throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding key to wallet\");\n+            // Add the wpkh script for this key if possible\n+            if (pubkey.IsCompressed()) {\n+                pwallet->ImportScripts({GetScriptForDestination(WitnessV0KeyHash(vchAddress))});\n             }\n-            pwallet->LearnAllRelatedScripts(pubkey);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304550340",
      "id" : 304550340,
      "in_reply_to_id" : 299107507,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNDU1MDM0MA==",
      "original_commit_id" : "ea665e323f76766def6c4f46a46c53e38365d179",
      "original_position" : 44,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 22,
      "pull_request_review_id" : 263194978,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/304550340",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r305025193"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/305025193"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Have importwallet use ImportPrivKeys and ImportScripts\" (35805ce74a780674c2a04259f98c8888906d7e91)\r\n\r\nAny particular reason this this is calling ImportScriptPubKeys to indirectly set the labels instead of just directly calling SetAddressBook like before? This seems to create same confusion around removing watch only scripts, and then appearing to add them again, but then not really adding them due to ismine, that was in a prior version of the importprivkey commit https://github.com/bitcoin/bitcoin/pull/16301#discussion_r304064584.\r\n\r\nWould suggest reverting here and just calling SetAddressBook instead of ImportScriptPubKeys like before. Or adding a comment about what ImportScriptPubKeys is intended to do in this context.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-18T17:08:57Z",
      "diff_hunk" : "@@ -656,43 +656,37 @@ UniValue importwallet(const JSONRPCRequest& request)\n             CPubKey pubkey = key.GetPubKey();\n             assert(key.VerifyPubKey(pubkey));\n             CKeyID keyid = pubkey.GetID();\n-            if (pwallet->HaveKey(keyid)) {\n-                pwallet->WalletLogPrintf(\"Skipping import of %s (key already present)\\n\", EncodeDestination(PKHash(keyid)));\n-                continue;\n-            }\n+\n             pwallet->WalletLogPrintf(\"Importing %s...\\n\", EncodeDestination(PKHash(keyid)));\n-            if (!pwallet->AddKeyPubKey(key, pubkey)) {\n+\n+            if (!pwallet->ImportPrivKeys({{keyid, key}}, time)) {\n+                pwallet->WalletLogPrintf(\"Error importing key for %s\\n\", EncodeDestination(PKHash(keyid)));\n                 fGood = false;\n                 continue;\n             }\n-            pwallet->mapKeyMetadata[keyid].nCreateTime = time;\n-            if (has_label)\n-                pwallet->SetAddressBook(PKHash(keyid), label, \"receive\");\n+\n+            pwallet->ImportScriptPubKeys(label, {GetScriptForDestination(PKHash(keyid))}, true /* have_solving_data */, has_label /* apply_label */, time /* timestamp */);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r305025193",
      "id" : 305025193,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNTAyNTE5Mw==",
      "original_commit_id" : "35805ce74a780674c2a04259f98c8888906d7e91",
      "original_position" : 21,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 263194978,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/305025193",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r305029269"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/305029269"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Have importwallet use ImportPrivKeys and ImportScripts\" (35805ce74a780674c2a04259f98c8888906d7e91)\r\n\r\nInteresting there is still a case that treats 0 and 1 key times differently. It might a be nice idea in a followup PR to replace all the 0's and 1's in the code with `SKIP_RESCAN = 0`, `FULL_RESCAN = 1` constants.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-18T17:19:41Z",
      "diff_hunk" : "@@ -656,43 +656,37 @@ UniValue importwallet(const JSONRPCRequest& request)\n             CPubKey pubkey = key.GetPubKey();\n             assert(key.VerifyPubKey(pubkey));\n             CKeyID keyid = pubkey.GetID();\n-            if (pwallet->HaveKey(keyid)) {\n-                pwallet->WalletLogPrintf(\"Skipping import of %s (key already present)\\n\", EncodeDestination(PKHash(keyid)));\n-                continue;\n-            }\n+\n             pwallet->WalletLogPrintf(\"Importing %s...\\n\", EncodeDestination(PKHash(keyid)));\n-            if (!pwallet->AddKeyPubKey(key, pubkey)) {\n+\n+            if (!pwallet->ImportPrivKeys({{keyid, key}}, time)) {\n+                pwallet->WalletLogPrintf(\"Error importing key for %s\\n\", EncodeDestination(PKHash(keyid)));\n                 fGood = false;\n                 continue;\n             }\n-            pwallet->mapKeyMetadata[keyid].nCreateTime = time;\n-            if (has_label)\n-                pwallet->SetAddressBook(PKHash(keyid), label, \"receive\");\n+\n+            pwallet->ImportScriptPubKeys(label, {GetScriptForDestination(PKHash(keyid))}, true /* have_solving_data */, has_label /* apply_label */, time /* timestamp */);\n+\n             nTimeBegin = std::min(nTimeBegin, time);\n             progress++;\n         }\n         for (const auto& script_pair : scripts) {\n             pwallet->chain().showProgress(\"\", std::max(50, std::min(75, (int)((progress / total) * 100) + 50)), false);\n             const CScript& script = script_pair.first;\n             int64_t time = script_pair.second;\n-            CScriptID id(script);\n-            if (pwallet->HaveCScript(id)) {\n-                pwallet->WalletLogPrintf(\"Skipping import of %s (script already present)\\n\", HexStr(script));\n-                continue;\n-            }\n-            if(!pwallet->AddCScript(script)) {\n+\n+            if (!pwallet->ImportScripts({script}, time)) {\n                 pwallet->WalletLogPrintf(\"Error importing script %s\\n\", HexStr(script));\n                 fGood = false;\n                 continue;\n             }\n             if (time > 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r305029269",
      "id" : 305029269,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNTAyOTI2OQ==",
      "original_commit_id" : "35805ce74a780674c2a04259f98c8888906d7e91",
      "original_position" : 42,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 155,
      "pull_request_review_id" : 263194978,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/305029269",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r305095534"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/305095534"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Log when an import is being skipped because we already have it\" (8bd426d238a526f8cfa4e8dd567fb3ccadb40cf7)\r\n\r\nNoting another change in behavior: This will now avoid adding the key to the keypool if add_keypool is true and the public key already exists. Could potentially be documented in the commit message or add_keypool description.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-18T20:13:12Z",
      "diff_hunk" : "@@ -1703,7 +1713,12 @@ bool CWallet::ImportPubKeys(const std::vector<CKeyID>& ordered_pubkeys, const st\n         }\n         const CPubKey& pubkey = entry->second;\n         CPubKey temp;\n-        if (!GetPubKey(id, temp) && !AddWatchOnlyWithDB(batch, GetScriptForRawPubKey(pubkey), timestamp)) {\n+        if (GetPubKey(id, temp)) {\n+            // Already have pubkey, skipping\n+            WalletLogPrintf(\"Already have pubkey %s, skipping\\n\", HexStr(temp));\n+            continue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r305095534",
      "id" : 305095534,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNTA5NTUzNA==",
      "original_commit_id" : "8bd426d238a526f8cfa4e8dd567fb3ccadb40cf7",
      "original_position" : 38,
      "path" : "src/wallet/wallet.cpp",
      "position" : 54,
      "pull_request_review_id" : 263194978,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/305095534",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r305164723"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/305164723"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Reverted.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-19T00:36:07Z",
      "diff_hunk" : "@@ -656,43 +656,37 @@ UniValue importwallet(const JSONRPCRequest& request)\n             CPubKey pubkey = key.GetPubKey();\n             assert(key.VerifyPubKey(pubkey));\n             CKeyID keyid = pubkey.GetID();\n-            if (pwallet->HaveKey(keyid)) {\n-                pwallet->WalletLogPrintf(\"Skipping import of %s (key already present)\\n\", EncodeDestination(PKHash(keyid)));\n-                continue;\n-            }\n+\n             pwallet->WalletLogPrintf(\"Importing %s...\\n\", EncodeDestination(PKHash(keyid)));\n-            if (!pwallet->AddKeyPubKey(key, pubkey)) {\n+\n+            if (!pwallet->ImportPrivKeys({{keyid, key}}, time)) {\n+                pwallet->WalletLogPrintf(\"Error importing key for %s\\n\", EncodeDestination(PKHash(keyid)));\n                 fGood = false;\n                 continue;\n             }\n-            pwallet->mapKeyMetadata[keyid].nCreateTime = time;\n-            if (has_label)\n-                pwallet->SetAddressBook(PKHash(keyid), label, \"receive\");\n+\n+            pwallet->ImportScriptPubKeys(label, {GetScriptForDestination(PKHash(keyid))}, true /* have_solving_data */, has_label /* apply_label */, time /* timestamp */);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r305164723",
      "id" : 305164723,
      "in_reply_to_id" : 305025193,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNTE2NDcyMw==",
      "original_commit_id" : "35805ce74a780674c2a04259f98c8888906d7e91",
      "original_position" : 21,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 263968851,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/305164723",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r305164748"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/305164748"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added a note in the commit message",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-19T00:36:16Z",
      "diff_hunk" : "@@ -1703,7 +1713,12 @@ bool CWallet::ImportPubKeys(const std::vector<CKeyID>& ordered_pubkeys, const st\n         }\n         const CPubKey& pubkey = entry->second;\n         CPubKey temp;\n-        if (!GetPubKey(id, temp) && !AddWatchOnlyWithDB(batch, GetScriptForRawPubKey(pubkey), timestamp)) {\n+        if (GetPubKey(id, temp)) {\n+            // Already have pubkey, skipping\n+            WalletLogPrintf(\"Already have pubkey %s, skipping\\n\", HexStr(temp));\n+            continue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r305164748",
      "id" : 305164748,
      "in_reply_to_id" : 305095534,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNTE2NDc0OA==",
      "original_commit_id" : "8bd426d238a526f8cfa4e8dd567fb3ccadb40cf7",
      "original_position" : 38,
      "path" : "src/wallet/wallet.cpp",
      "position" : 54,
      "pull_request_review_id" : 263968881,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/305164748",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r305164872"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/305164872"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think the use of `0` and `1` is kind of inconsistent and all of the the timestamp stuff needs to be cleaned up. But that should be done in a followup PR.",
      "commit_id" : "40ad2f6a58228c72c655e3061a19a63640419378",
      "created_at" : "2019-07-19T00:37:15Z",
      "diff_hunk" : "@@ -656,43 +656,37 @@ UniValue importwallet(const JSONRPCRequest& request)\n             CPubKey pubkey = key.GetPubKey();\n             assert(key.VerifyPubKey(pubkey));\n             CKeyID keyid = pubkey.GetID();\n-            if (pwallet->HaveKey(keyid)) {\n-                pwallet->WalletLogPrintf(\"Skipping import of %s (key already present)\\n\", EncodeDestination(PKHash(keyid)));\n-                continue;\n-            }\n+\n             pwallet->WalletLogPrintf(\"Importing %s...\\n\", EncodeDestination(PKHash(keyid)));\n-            if (!pwallet->AddKeyPubKey(key, pubkey)) {\n+\n+            if (!pwallet->ImportPrivKeys({{keyid, key}}, time)) {\n+                pwallet->WalletLogPrintf(\"Error importing key for %s\\n\", EncodeDestination(PKHash(keyid)));\n                 fGood = false;\n                 continue;\n             }\n-            pwallet->mapKeyMetadata[keyid].nCreateTime = time;\n-            if (has_label)\n-                pwallet->SetAddressBook(PKHash(keyid), label, \"receive\");\n+\n+            pwallet->ImportScriptPubKeys(label, {GetScriptForDestination(PKHash(keyid))}, true /* have_solving_data */, has_label /* apply_label */, time /* timestamp */);\n+\n             nTimeBegin = std::min(nTimeBegin, time);\n             progress++;\n         }\n         for (const auto& script_pair : scripts) {\n             pwallet->chain().showProgress(\"\", std::max(50, std::min(75, (int)((progress / total) * 100) + 50)), false);\n             const CScript& script = script_pair.first;\n             int64_t time = script_pair.second;\n-            CScriptID id(script);\n-            if (pwallet->HaveCScript(id)) {\n-                pwallet->WalletLogPrintf(\"Skipping import of %s (script already present)\\n\", HexStr(script));\n-                continue;\n-            }\n-            if(!pwallet->AddCScript(script)) {\n+\n+            if (!pwallet->ImportScripts({script}, time)) {\n                 pwallet->WalletLogPrintf(\"Error importing script %s\\n\", HexStr(script));\n                 fGood = false;\n                 continue;\n             }\n             if (time > 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#discussion_r305164872",
      "id" : 305164872,
      "in_reply_to_id" : 305029269,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNTE2NDg3Mg==",
      "original_commit_id" : "35805ce74a780674c2a04259f98c8888906d7e91",
      "original_position" : 42,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 155,
      "pull_request_review_id" : 263969042,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16301",
      "updated_at" : "2019-07-24T15:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/305164872",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "utACK https://github.com/bitcoin/bitcoin/pull/16301/commits/bc8ecc056ffa42c758b04d5bcae32c1354c3fbe1\r\n\r\nChecked diff from https://github.com/bitcoin/bitcoin/commit/991ecfdbbb289bd6e4c50fc63f9201edbca14f70 , was reversions that were discussed and some logging/error reporting improvements.",
      "created_at" : "2019-07-20T01:35:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#issuecomment-513424397",
      "id" : 513424397,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16301",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxMzQyNDM5Nw==",
      "updated_at" : "2019-07-20T01:35:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/513424397",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "partial ACK up to af6dced944\r\n\r\nSome questions:\r\n* In commit af6dced944, there seems to be a behavior change that is not\r\n  mentioned in the commit body: Previously, if the privkey already existed,\r\n  we'd error out. Now, we'd overwrite the label?\r\n\r\n* In commit af6dced944. Previously, there was a call to\r\n  AddCScript(GetScriptForDestination(WitnessV0KeyHash(pubKey.GetId())));\r\n  (via LearnAllRelatedScripts). I don't see why this is no longer required\r\n  or where an equivalent call is made. Mind to explain?\r\n\r\n<details><summary>Show signature and timestamp</summary>\r\n\r\nSignature:\r\n\r\n```\r\n-----BEGIN PGP SIGNED MESSAGE-----\r\nHash: SHA512\r\n\r\npartial ACK up to af6dced944\r\n\r\nSome questions:\r\n* In commit af6dced944, there seems to be a behavior change that is not\r\n  mentioned in the commit body: Previously, if the privkey already existed,\r\n  we'd error out. Now, we'd overwrite the label?\r\n\r\n* In commit af6dced944. Previously, there was a call to\r\n  AddCScript(GetScriptForDestination(WitnessV0KeyHash(pubKey.GetId())));\r\n  (via LearnAllRelatedScripts). I don't see why this is no longer required\r\n  or where an equivalent call is made. Mind to explain?\r\n-----BEGIN PGP SIGNATURE-----\r\n\r\niQGzBAEBCgAdFiEE+rVPoUahrI9sLGYTzit1aX5ppUgFAlwqrYAACgkQzit1aX5p\r\npUiFywv+Oc9kV/FPwgRVxvIEVgUQpEE4d/DcPiZ205RzdTEOXh7DxzootgnwZSzC\r\nS8obDJGqDy26JSpCr4R6JevUl2gTYVeKMph9G2hlEHZW4pdiAxAY4/xQ8KvoAwBZ\r\nb+u2ovlq6A8uTCQzPYkJ1KAZHHKVwd32PAYllJshilLpdVo5rqXbDwoR322/XoV2\r\nmEeKCjnHBhQDRY4wFQ5g+2onN1oqf2Rw9fELtXqbBR7SM5EjTF79rTfkwLWmDReu\r\niK92/AQHfQGSrdbILz9VJ9gJE+OCco7dvi/sqMQmXKk9q3aNAY+zDgnQRvvbKkUX\r\np/yZrBXH8ExN7Fd89D8sb6L/h/floJM0EMQ8Ccc7cVEou77VHLC08NRiLTP5lTzH\r\nnmmd7Br4LqZOQuVPZ9iZCRbUpu+jGPbM0uIqtYDeqO+elSnepWYTwZlCVEfjCwpX\r\nRSaimg4I08v0cpWicoVQcFAB3DxpU0OCJZZEy4/rS5ZwkxVmyorFSy6+Hvh97oCJ\r\n964kzylV\r\n=2JyL\r\n-----END PGP SIGNATURE-----\r\n```\r\n\r\n[Timestamp of file with hash `14e6ca5a72d68fc23e91e6eecdf4294ca99ad0e7ce1478ca529dfbbda4ec2d21  -`](https://opentimestamps.org/info/?004f70656e54696d657374616d7073000050726f6f6600bf89e2e884e89294010814e6ca5a72d68fc23e91e6eecdf4294ca99ad0e7ce1478ca529dfbbda4ec2d21f01085223bda921e7fa9c0636535469853e308fff010255f28c7ae1ca633fafa8289c55bf6a308f1045d385a83f0084b7a56bc8156ac6d0083dfe30d2ef90c8e2e2d68747470733a2f2f616c6963652e6274632e63616c656e6461722e6f70656e74696d657374616d70732e6f7267fff01056369d3f01bc0788d0d690c0d22e7aa208f0208c50c64a97d95c8a0014e7fe7667a0bedd26be62df2765762df0efbacfab2fce08f1045d385a84f008e9d6172419665d990083dfe30d2ef90c8e292868747470733a2f2f66696e6e65792e63616c656e6461722e657465726e69747977616c6c2e636f6dfff010bb346891011321f051a2976c5a31f2b408f1045d385a84f008c79e78c1f97ff31d0083dfe30d2ef90c8e232268747470733a2f2f6274632e63616c656e6461722e636174616c6c6178792e636f6df010ed7b66c19c538915fe9e7beba80b320008f1045d385a83f0085599d140b6d02aa00083dfe30d2ef90c8e2c2b68747470733a2f2f626f622e6274632e63616c656e6461722e6f70656e74696d657374616d70732e6f7267)\r\n\r\n</details>\r\n",
      "created_at" : "2019-07-24T13:18:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#issuecomment-514628180",
      "id" : 514628180,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16301",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxNDYyODE4MA==",
      "updated_at" : "2019-07-24T13:18:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/514628180",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : ">     * In commit [af6dced](https://github.com/bitcoin/bitcoin/commit/af6dced9446eca4a67429e07b3216ae7f3d08c16), there seems to be a behavior change that is not\r\n>       mentioned in the commit body: Previously, if the privkey already existed,\r\n>       we'd error out. Now, we'd overwrite the label?\r\n\r\nUpdated the commit message\r\n\r\n>     * In commit [af6dced](https://github.com/bitcoin/bitcoin/commit/af6dced9446eca4a67429e07b3216ae7f3d08c16). Previously, there was a call to\r\n>       AddCScript(GetScriptForDestination(WitnessV0KeyHash(pubKey.GetId())));\r\n>       (via LearnAllRelatedScripts). I don't see why this is no longer required\r\n>       or where an equivalent call is made. Mind to explain?\r\n\r\n`ImportPubKeys` will add the public key to `mapWatchKeys`. In doing so, it calls `ImplicitlyLearnRelatedKeyScripts` which will find that script and add it to `mapScripts` in memory. Every time this key is loaded, this script will always be found and loaded into memory. The only difference is that that script is not persisted to disk.\r\n\r\n",
      "created_at" : "2019-07-24T15:44:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#issuecomment-514687776",
      "id" : 514687776,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16301",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxNDY4Nzc3Ng==",
      "updated_at" : "2019-07-24T15:44:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/514687776",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK 40ad2f6a58228c72c655e3061a19a63640419378 (checked that behavior changes are mentioned in the commit body)\r\n\r\n<details><summary>Show signature and timestamp</summary>\r\n\r\nSignature:\r\n\r\n```\r\n-----BEGIN PGP SIGNED MESSAGE-----\r\nHash: SHA512\r\n\r\nACK 40ad2f6a58228c72c655e3061a19a63640419378 (checked that behavior changes are mentioned in the commit body)\r\n-----BEGIN PGP SIGNATURE-----\r\n\r\niQGzBAEBCgAdFiEE+rVPoUahrI9sLGYTzit1aX5ppUgFAlwqrYAACgkQzit1aX5p\r\npUjR+gwAwyGbOiN9UTB3m8zLjyxSUA/7k1gKPVpx2H9kX9dVAuKDzZ/9UD08dks0\r\nM4LkQ1gHA+cvEzkEyEo4sSRcPjRajGrGIAG1TmmRR+ZexTPa8lxYd+1p7NYKu1V/\r\nmxlee39ntChoxXfwHFj9+QiSpGFAf91/C4YnFZoZ5AfktaKPe1ZXKW2LH+lSZbKl\r\n9dP5aL5yBIasVt9tMhLswLXZhPMUNQFQeRpev9KuM0lauiV1dN4MlyuLNg7Iops/\r\nKK9xTth5OQIXn99KLLjnxkyZUXFlu1jjUBOOXeNXa5h9x/wJateBi/8M/Yt9YYRe\r\nI5Rn97agU44ObjEQobsNiXusHWNGF8mv5NZlbh+iibCDnQb6MJXR1DWLgSaYx8Hf\r\nFUtY3yhQt+2oa/wkXWhOz7jLYopT2DhmwKareWgvemscwO9rsdaO02RbdiWE4lnQ\r\nPbf9q3NlNdGk7KlUqt6ehGlYx9sj5cHeJl0VnH7JwibonZIznbEGf4Ej24RE8L6z\r\nbkboCr7U\r\n=1+uy\r\n-----END PGP SIGNATURE-----\r\n```\r\n\r\n[Timestamp of file with hash `bb77b117482794207771d1571ca4e73ac19a12b52c18a1c489b86f8600c76c0b  -`](https://opentimestamps.org/info/?004f70656e54696d657374616d7073000050726f6f6600bf89e2e884e892940108bb77b117482794207771d1571ca4e73ac19a12b52c18a1c489b86f8600c76c0bf01044778683d1c49730367ec433469bc42108fff010037d05b55a6eabcde9f0ad35f85fe61c08f1045d39b196f008cf721522b6719cf30083dfe30d2ef90c8e2e2d68747470733a2f2f616c6963652e6274632e63616c656e6461722e6f70656e74696d657374616d70732e6f7267fff0105231ba3ec8f39a3727718b94b71250b708f1045d39b196f00880e522477d9b77970083dfe30d2ef90c8e2c2b68747470733a2f2f626f622e6274632e63616c656e6461722e6f70656e74696d657374616d70732e6f7267fff0105ee05a4df0ef4f2f50838177888077fb08f1045d39b197f0082777f6573e952cb70083dfe30d2ef90c8e292868747470733a2f2f66696e6e65792e63616c656e6461722e657465726e69747977616c6c2e636f6df010c50b676fbffa8334b7a172d83998946808f1045d39b196f0082ebad96f2c28fe400083dfe30d2ef90c8e232268747470733a2f2f6274632e63616c656e6461722e636174616c6c6178792e636f6d)\r\n\r\n</details>\r\n",
      "created_at" : "2019-07-25T13:41:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#issuecomment-515048254",
      "id" : 515048254,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16301",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxNTA0ODI1NA==",
      "updated_at" : "2019-07-25T13:41:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/515048254",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've written some tests in  #16465",
      "created_at" : "2019-07-25T21:06:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16301#issuecomment-515214493",
      "id" : 515214493,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16301",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxNTIxNDQ5Mw==",
      "updated_at" : "2019-07-25T21:06:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/515214493",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
