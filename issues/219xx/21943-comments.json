[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#22829](https://github.com/bitcoin/bitcoin/pull/22829) (refactor: various RecursiveMutex replacements in CConnman by theStack)\n* [#21879](https://github.com/bitcoin/bitcoin/pull/21879) (Wrap accept() and extend usage of Sock by vasild)\n* [#21878](https://github.com/bitcoin/bitcoin/pull/21878) (Make all networking code mockable by vasild)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-05-13T15:17:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-840631813",
      "id" : 840631813,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21943",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0MDYzMTgxMw==",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/840631813/reactions"
      },
      "updated_at" : "2021-11-19T11:16:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/840631813",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632150326"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632150326"
         }
      },
      "author_association" : "MEMBER",
      "body" : "157674ef213e6329215d1b7eb85dacbc23c468db\r\n\r\nThis snap catches nodes added in the above `AcceptConnection` where the new snap at the beginning doesn't. Is this intentional?",
      "commit_id" : "644726117a0102feac2e150c6dd10fd8bcb88bc0",
      "created_at" : "2021-05-13T22:50:29Z",
      "diff_hunk" : "@@ -1467,8 +1467,6 @@ void CConnman::SocketHandler()\n         }\n     }\n \n-    NodesSnapshot snap{*this};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632150326",
      "id" : 632150326,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMjE1MDMyNg==",
      "original_commit_id" : "157674ef213e6329215d1b7eb85dacbc23c468db",
      "original_line" : 1470,
      "original_position" : 61,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 659359605,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-13T22:50:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632150326",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632355737"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632355737"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hmm, good catch! No, that is not intentional.\r\n\r\nSo, the previous code did:\r\n\r\n1. `SocketEvents()`, adding ready sockets from `vNodes` to `{recv,send,error}_set`.\r\n2. `AcceptConnection()`, adding new entries to `vNodes`.\r\n3. Loop over `vNodes`, for each node:\r\n3.1. Check whether its socket is in one of `{recv,send,error}_set`. Observation - the sockets of nodes that were added in 2. will not be in any of `{recv,send,error}_set`, so for them all of `recvSet`, `sendSet` and `errorSet` will be `false`.\r\n3.2. `InactivityCheck()` - will also be done for nodes added in 2.\r\n\r\nThe new code will skip nodes added in 2. in the 3. loop. That's the same as the old code with respect to 3.1. The only difference is that the new code will not do `InactivityCheck()` for newly accepted nodes. I think that is ok because it is unlikely that a newly accepted peer would be considered inactive. In the rare case where this might have happened in the old code and will not happen in the new code, the new code will do the check on the next call to `SocketHandler()`.\r\n\r\nWhat do you think? Leave it as is or somehow ensure that new and old behave in an identical way?",
      "commit_id" : "644726117a0102feac2e150c6dd10fd8bcb88bc0",
      "created_at" : "2021-05-14T08:01:48Z",
      "diff_hunk" : "@@ -1467,8 +1467,6 @@ void CConnman::SocketHandler()\n         }\n     }\n \n-    NodesSnapshot snap{*this};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632355737",
      "id" : 632355737,
      "in_reply_to_id" : 632150326,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMjM1NTczNw==",
      "original_commit_id" : "157674ef213e6329215d1b7eb85dacbc23c468db",
      "original_line" : 1470,
      "original_position" : 61,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 659612587,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-14T08:01:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632355737",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632360108"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632360108"
         }
      },
      "author_association" : "MEMBER",
      "body" : "if `InactivityCheck` for new nodes is pointless then maybe move `// Accept new connections` to the end?",
      "commit_id" : "644726117a0102feac2e150c6dd10fd8bcb88bc0",
      "created_at" : "2021-05-14T08:08:49Z",
      "diff_hunk" : "@@ -1467,8 +1467,6 @@ void CConnman::SocketHandler()\n         }\n     }\n \n-    NodesSnapshot snap{*this};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632360108",
      "id" : 632360108,
      "in_reply_to_id" : 632150326,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMjM2MDEwOA==",
      "original_commit_id" : "157674ef213e6329215d1b7eb85dacbc23c468db",
      "original_line" : 1470,
      "original_position" : 61,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 659617416,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-14T08:08:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632360108",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2021-05-14T09:31:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-841130784",
      "id" : 841130784,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21943",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0MTEzMDc4NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-14T09:31:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/841130784",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632451114"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632451114"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Added an explicit commit (a71b3f426) to show the intention. Putting the accept at the end somehow looked strange to me.\r\n\r\nMaybe these two actions deserve to be split in separate functions (ie split `SocketHandler()`): 1. checking which of the listening sockets are ready for IO and accepting connections on them and 2. checking which of the already connected sockets are ready for IO and processing them. Would require even more changes.",
      "commit_id" : "92f62d9ea43c6861409916256a403417d80c0932",
      "created_at" : "2021-05-14T10:58:33Z",
      "diff_hunk" : "@@ -1467,8 +1467,6 @@ void CConnman::SocketHandler()\n         }\n     }\n \n-    NodesSnapshot snap{*this};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632451114",
      "id" : 632451114,
      "in_reply_to_id" : 632150326,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMjQ1MTExNA==",
      "original_commit_id" : "157674ef213e6329215d1b7eb85dacbc23c468db",
      "original_line" : 1470,
      "original_position" : 61,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 659736046,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-14T10:58:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632451114",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "`644726117...92f62d9ea`: add an explicit commit that shows we intentionally don't process newly accepted nodes, as discussed in https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632150326",
      "created_at" : "2021-05-14T11:00:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-841173328",
      "id" : 841173328,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21943",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0MTE3MzMyOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-14T11:00:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/841173328",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632622357"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632622357"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Since you are not splitting maybe add a comment for now like `// Take a snapshot of current nodes before acceptation new ones - new nodes are irrelevant below` or something like that.",
      "commit_id" : "92f62d9ea43c6861409916256a403417d80c0932",
      "created_at" : "2021-05-14T15:45:27Z",
      "diff_hunk" : "@@ -1467,8 +1467,6 @@ void CConnman::SocketHandler()\n         }\n     }\n \n-    NodesSnapshot snap{*this};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632622357",
      "id" : 632622357,
      "in_reply_to_id" : 632150326,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMjYyMjM1Nw==",
      "original_commit_id" : "157674ef213e6329215d1b7eb85dacbc23c468db",
      "original_line" : 1470,
      "original_position" : 61,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 659968284,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-14T15:45:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632622357",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632651133"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632651133"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Could we move this call to `SocketEvents()` to below the _Accept new connections_ logic? I think it's simpler to reason about if we're not holding the nodes snapshot across the _Accept new connections_ logic.",
      "commit_id" : "92f62d9ea43c6861409916256a403417d80c0932",
      "created_at" : "2021-05-14T16:30:39Z",
      "diff_hunk" : "@@ -1451,8 +1447,10 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n+    NodesSnapshot snap{*this};\n+\n     std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(recv_set, send_set, error_set);\n+    SocketEvents(snap.Nodes(), recv_set, send_set, error_set);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632651133",
      "id" : 632651133,
      "line" : 1453,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMjY1MTEzMw==",
      "original_commit_id" : "92f62d9ea43c6861409916256a403417d80c0932",
      "original_line" : 1453,
      "original_position" : 109,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 109,
      "pull_request_review_id" : 660007293,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-14T16:30:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632651133",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2021-05-15T07:51:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-841617954",
      "id" : 841617954,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21943",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0MTYxNzk1NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-15T07:51:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/841617954",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632966401"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632966401"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Sorry, ignore this. I've just realized that the _Accept new connections_ logic is using the `recv_set` that's populated by `SocketEvents()`.",
      "commit_id" : "92f62d9ea43c6861409916256a403417d80c0932",
      "created_at" : "2021-05-15T14:58:09Z",
      "diff_hunk" : "@@ -1451,8 +1447,10 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n+    NodesSnapshot snap{*this};\n+\n     std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(recv_set, send_set, error_set);\n+    SocketEvents(snap.Nodes(), recv_set, send_set, error_set);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632966401",
      "id" : 632966401,
      "in_reply_to_id" : 632651133,
      "line" : 1453,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMjk2NjQwMQ==",
      "original_commit_id" : "92f62d9ea43c6861409916256a403417d80c0932",
      "original_line" : 1453,
      "original_position" : 109,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 109,
      "pull_request_review_id" : 660365073,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-15T14:58:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632966401",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632972362"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632972362"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm guessing you've defined this class within `CConnman` to enable access to the private members. You could instead define the class in `net.cpp` as a standalone by making `vNodes` and `cs_vNodes` protected & declaring `friend class NodesSnapshot` here. Seems nice to keep this mechanism that's only used internally out of the header file.\r\n\r\ndiff ðð½\r\n(also includes constifying `m_nodes_copy`)\r\n```diff \r\ndiff --git a/src/net.cpp b/src/net.cpp\r\nindex 5fd1bf754d..6040ee86be 100644\r\n--- a/src/net.cpp\r\n+++ b/src/net.cpp\r\n@@ -110,6 +110,39 @@ std::map<CNetAddr, LocalServiceInfo> mapLocalHost GUARDED_BY(cs_mapLocalHost);\r\n static bool vfLimited[NET_MAX] GUARDED_BY(cs_mapLocalHost) = {};\r\n std::string strSubVersion;\r\n\r\n+/**\r\n+ * RAII helper to atomically create a copy of `vNodes` and add a reference\r\n+ * to each of the nodes. The nodes are released when this object is destroyed.\r\n+ */\r\n+class NodesSnapshot\r\n+{\r\n+    public:\r\n+        explicit NodesSnapshot(const CConnman& connman) : m_connman{connman}, m_nodes_copy{m_connman.vNodes}\r\n+        {\r\n+            LOCK(m_connman.cs_vNodes);\r\n+            for (auto& node : m_nodes_copy) {\r\n+                node->AddRef();\r\n+            }\r\n+        }\r\n+\r\n+        ~NodesSnapshot()\r\n+        {\r\n+            LOCK(m_connman.cs_vNodes);\r\n+            for (auto& node : m_nodes_copy) {\r\n+                node->Release();\r\n+            }\r\n+        }\r\n+\r\n+        const std::vector<CNode*>& Nodes() const\r\n+        {\r\n+            return m_nodes_copy;\r\n+        }\r\n+\r\n+    private:\r\n+        const CConnman& m_connman;\r\n+        const CConnman& m_connman;\r\n+        const std::vector<CNode*> m_nodes_copy;\r\n+};\r\n+\r\n void CConnman::AddAddrFetch(const std::string& strDest)\r\n {\r\n     LOCK(m_addr_fetches_mutex);\r\ndiff --git a/src/net.h b/src/net.h\r\nindex 846c4c0ece..f39c46c166 100644\r\n--- a/src/net.h\r\n+++ b/src/net.h\r\n@@ -1021,6 +1021,10 @@ public:\r\n     /** Return true if we should disconnect the peer for failing an inactivity check. */\r\n     bool ShouldRunInactivityChecks(const CNode& node, std::optional<int64_t> now=std::nullopt) const;\r\n\r\n+protected:\r\n+    std::vector<CNode*> vNodes GUARDED_BY(cs_vNodes);\r\n+    mutable RecursiveMutex cs_vNodes;\r\n+\r\n private:\r\n     struct ListenSocket {\r\n     public:\r\n@@ -1153,9 +1157,7 @@ private:\r\n     RecursiveMutex m_addr_fetches_mutex;\r\n     std::vector<std::string> vAddedNodes GUARDED_BY(cs_vAddedNodes);\r\n     mutable RecursiveMutex cs_vAddedNodes;\r\n-    std::vector<CNode*> vNodes GUARDED_BY(cs_vNodes);\r\n     std::list<CNode*> vNodesDisconnected;\r\n-    mutable RecursiveMutex cs_vNodes;\r\n     std::atomic<NodeId> nLastNodeId{0};\r\n     unsigned int nPrevNodeCount{0};\r\n\r\n@@ -1276,40 +1278,7 @@ private:\r\n      */\r\n     std::vector<CService> m_onion_binds;\r\n\r\n-    /**\r\n-     * RAII helper to atomically create a copy of `vNodes` and add a reference\r\n-     * to each of the nodes. The nodes are released when this object is destroyed.\r\n-     */\r\n-    class NodesSnapshot\r\n-    {\r\n-    public:\r\n-        explicit NodesSnapshot(const CConnman& connman) : m_connman{connman}\r\n-        {\r\n-            LOCK(m_connman.cs_vNodes);\r\n-            m_nodes_copy = m_connman.vNodes;\r\n-            for (auto& node : m_nodes_copy) {\r\n-                node->AddRef();\r\n-            }\r\n-        }\r\n-\r\n-        ~NodesSnapshot()\r\n-        {\r\n-            LOCK(m_connman.cs_vNodes);\r\n-            for (auto& node : m_nodes_copy) {\r\n-                node->Release();\r\n-            }\r\n-        }\r\n-\r\n-        const std::vector<CNode*>& Nodes() const\r\n-        {\r\n-            return m_nodes_copy;\r\n-        }\r\n-\r\n-    private:\r\n-        const CConnman& m_connman;\r\n-        std::vector<CNode*> m_nodes_copy;\r\n-    };\r\n-\r\n+    friend class NodesSnapshot;\r\n     friend struct CConnmanTest;\r\n     friend struct ConnmanTestMsg;\r\n };\r\n```",
      "commit_id" : "92f62d9ea43c6861409916256a403417d80c0932",
      "created_at" : "2021-05-15T15:20:46Z",
      "diff_hunk" : "@@ -1257,6 +1276,40 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632972362",
      "id" : 632972362,
      "line" : 1283,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMjk3MjM2Mg==",
      "original_commit_id" : "92f62d9ea43c6861409916256a403417d80c0932",
      "original_line" : 1283,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 38,
      "pull_request_review_id" : 660366732,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-15T15:49:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632972362",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632972531"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632972531"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    const NodesSnapshot snap{*this};\r\n```",
      "commit_id" : "92f62d9ea43c6861409916256a403417d80c0932",
      "created_at" : "2021-05-15T15:22:20Z",
      "diff_hunk" : "@@ -1451,8 +1447,10 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n+    NodesSnapshot snap{*this};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632972531",
      "id" : 632972531,
      "line" : 1450,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMjk3MjUzMQ==",
      "original_commit_id" : "92f62d9ea43c6861409916256a403417d80c0932",
      "original_line" : 1450,
      "original_position" : 105,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 105,
      "pull_request_review_id" : 660366732,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-15T15:48:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632972531",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632972552"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632972552"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n            const NodesSnapshot snap{*this};\r\n```",
      "commit_id" : "92f62d9ea43c6861409916256a403417d80c0932",
      "created_at" : "2021-05-15T15:22:32Z",
      "diff_hunk" : "@@ -2174,41 +2159,29 @@ void CConnman::ThreadMessageHandler()\n {\n     while (!flagInterruptMsgProc)\n     {\n-        std::vector<CNode*> vNodesCopy;\n-        {\n-            LOCK(cs_vNodes);\n-            vNodesCopy = vNodes;\n-            for (CNode* pnode : vNodesCopy) {\n-                pnode->AddRef();\n-            }\n-        }\n-\n         bool fMoreWork = false;\n \n-        for (CNode* pnode : vNodesCopy)\n         {\n-            if (pnode->fDisconnect)\n-                continue;\n+            NodesSnapshot snap{*this};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632972552",
      "id" : 632972552,
      "line" : 2165,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMjk3MjU1Mg==",
      "original_commit_id" : "92f62d9ea43c6861409916256a403417d80c0932",
      "original_line" : 2165,
      "original_position" : 161,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 161,
      "pull_request_review_id" : 660366732,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-15T15:48:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632972552",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632973688"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632973688"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n        const std::vector<CNode*> m_nodes_copy;\r\n```\r\n\r\nCan `const` this if you add the constructor assignment to the initializer list (done in https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632972362 diff) ",
      "commit_id" : "92f62d9ea43c6861409916256a403417d80c0932",
      "created_at" : "2021-05-15T15:33:32Z",
      "diff_hunk" : "@@ -1257,6 +1276,40 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot\n+    {\n+    public:\n+        explicit NodesSnapshot(const CConnman& connman) : m_connman{connman}\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            m_nodes_copy = m_connman.vNodes;\n+            for (auto& node : m_nodes_copy) {\n+                node->AddRef();\n+            }\n+        }\n+\n+        ~NodesSnapshot()\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            for (auto& node : m_nodes_copy) {\n+                node->Release();\n+            }\n+        }\n+\n+        const std::vector<CNode*>& Nodes() const\n+        {\n+            return m_nodes_copy;\n+        }\n+\n+    private:\n+        const CConnman& m_connman;\n+        std::vector<CNode*> m_nodes_copy;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632973688",
      "id" : 632973688,
      "line" : 1310,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMjk3MzY4OA==",
      "original_commit_id" : "92f62d9ea43c6861409916256a403417d80c0932",
      "original_line" : 1310,
      "original_position" : 65,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 65,
      "pull_request_review_id" : 660366732,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-15T15:49:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632973688",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632974904"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632974904"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I see that you haven't changed the behavior here, but I'm curious about the pre-existing logic: \r\n\r\nIs it necessary for `Release()` to be under the lock? \r\n\r\nIt makes sense that `AddRef` has to be under the lock so there isn't a race between a thread that is trying to operate on the node, and a thread that is evaluating for disconnect. However, with `Release`, I don't think there is actually potential for a race.. if `GetRefCount` returns > 0, `DisconnectNodes` will delay processing it. And since `nRefCount` is atomic, it shouldn't be a problem if multiple threads are trying to increment / decrement at the same time. Does this reasoning seem sound? Am I missing something? \r\n\r\ncc @narula ",
      "commit_id" : "92f62d9ea43c6861409916256a403417d80c0932",
      "created_at" : "2021-05-15T15:44:42Z",
      "diff_hunk" : "@@ -1257,6 +1276,40 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot\n+    {\n+    public:\n+        explicit NodesSnapshot(const CConnman& connman) : m_connman{connman}\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            m_nodes_copy = m_connman.vNodes;\n+            for (auto& node : m_nodes_copy) {\n+                node->AddRef();\n+            }\n+        }\n+\n+        ~NodesSnapshot()\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            for (auto& node : m_nodes_copy) {\n+                node->Release();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632974904",
      "id" : 632974904,
      "line" : 1299,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMjk3NDkwNA==",
      "original_commit_id" : "92f62d9ea43c6861409916256a403417d80c0932",
      "original_line" : 1299,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 54,
      "pull_request_review_id" : 660366732,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-15T16:03:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632974904",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632986434"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632986434"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I like this. A few notes:\r\n\r\n- the diff as shown is corrupted (contains the `+        const CConnman& m_connman;` line twice) and so doesn't apply with `git apply`.\r\n- `vNodes` and `cs_vNodes` don't need to change to be protected. Friend classes have access to private members.\r\n- `NodesSnapshot` can be in the unnamed namespace since it's only needed in the net.cpp translation unit.",
      "commit_id" : "92f62d9ea43c6861409916256a403417d80c0932",
      "created_at" : "2021-05-15T17:38:06Z",
      "diff_hunk" : "@@ -1257,6 +1276,40 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632986434",
      "id" : 632986434,
      "in_reply_to_id" : 632972362,
      "line" : 1283,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMjk4NjQzNA==",
      "original_commit_id" : "92f62d9ea43c6861409916256a403417d80c0932",
      "original_line" : 1283,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 38,
      "pull_request_review_id" : 660376603,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-15T17:38:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632986434",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632987235"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632987235"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The `m_nodes_copy{m_connman.vNodes}` in the initializer list is accessing `vNodes` without the `cs_vNodes` lock. You could update it to take the lock:\r\n\r\n```diff\r\ndiff --git a/src/net.cpp b/src/net.cpp\r\nindex 6040ee86be..d39aa14b20 100644\r\n--- a/src/net.cpp\r\n+++ b/src/net.cpp\r\n@@ -117,7 +117,9 @@ std::string strSubVersion;\r\n class NodesSnapshot\r\n {\r\n     public:\r\n-        explicit NodesSnapshot(const CConnman& connman) : m_connman{connman}, m_nodes_copy{m_connman.vNodes}\r\n+        explicit NodesSnapshot(const CConnman& connman) :\r\n+            m_connman{connman},\r\n+            m_nodes_copy{WITH_LOCK(m_connman.cs_vNodes, return m_connman.vNodes;)}\r\n         {\r\n             LOCK(m_connman.cs_vNodes);\r\n             for (auto& node : m_nodes_copy) {\r\n```\r\n\r\nBut that would introduce a race condition if another thread deleted a node between the initializer list and the ctor being run.\r\n\r\nI think better just to assign `m_nodes_copy` in the ctor.",
      "commit_id" : "92f62d9ea43c6861409916256a403417d80c0932",
      "created_at" : "2021-05-15T17:47:12Z",
      "diff_hunk" : "@@ -1257,6 +1276,40 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632987235",
      "id" : 632987235,
      "in_reply_to_id" : 632972362,
      "line" : 1283,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMjk4NzIzNQ==",
      "original_commit_id" : "92f62d9ea43c6861409916256a403417d80c0932",
      "original_line" : 1283,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 38,
      "pull_request_review_id" : 660377240,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-15T17:47:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632987235",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632987838"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632987838"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this is correct. There's no need to hold `cs_vNodes` when calling `node->Release();`\r\n\r\nRemoving this lock means that the `m_connman` member is no longer required.",
      "commit_id" : "92f62d9ea43c6861409916256a403417d80c0932",
      "created_at" : "2021-05-15T17:52:59Z",
      "diff_hunk" : "@@ -1257,6 +1276,40 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot\n+    {\n+    public:\n+        explicit NodesSnapshot(const CConnman& connman) : m_connman{connman}\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            m_nodes_copy = m_connman.vNodes;\n+            for (auto& node : m_nodes_copy) {\n+                node->AddRef();\n+            }\n+        }\n+\n+        ~NodesSnapshot()\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            for (auto& node : m_nodes_copy) {\n+                node->Release();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632987838",
      "id" : 632987838,
      "in_reply_to_id" : 632974904,
      "line" : 1299,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMjk4NzgzOA==",
      "original_commit_id" : "92f62d9ea43c6861409916256a403417d80c0932",
      "original_line" : 1299,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 54,
      "pull_request_review_id" : 660377592,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-15T17:52:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632987838",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632989196"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632989196"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What do you think about just wrapping the m_nodes_copy `begin()` and `end()` functions:\r\n\r\n```diff\r\ndiff --git a/src/net.cpp b/src/net.cpp\r\nindex 6040ee86be..5388af02e3 100644\r\n--- a/src/net.cpp\r\n+++ b/src/net.cpp\r\n@@ -116,6 +116,10 @@ std::string strSubVersion;\r\n  */\r\n class NodesSnapshot\r\n {\r\n+    private:\r\n+        const CConnman& m_connman;\r\n+        const std::vector<CNode*> m_nodes_copy;\r\n+\r\n     public:\r\n         explicit NodesSnapshot(const CConnman& connman) : m_connman{connman}, m_nodes_copy{m_connman.vNodes}\r\n         {\r\n@@ -133,14 +137,18 @@ class NodesSnapshot\r\n             }\r\n         }\r\n \r\n-        const std::vector<CNode*>& Nodes() const\r\n+        using iterator = decltype(m_nodes_copy.begin());\r\n+\r\n+        iterator begin()\r\n         {\r\n-            return m_nodes_copy;\r\n+            return m_nodes_copy.begin();\r\n+        }\r\n+\r\n+        iterator end()\r\n+        {\r\n+            return m_nodes_copy.end();\r\n         }\r\n \r\n-    private:\r\n-        const CConnman& m_connman;\r\n-        const std::vector<CNode*> m_nodes_copy;\r\n };\r\n```\r\n\r\nand then the client code can use a `NodeSnapshot` in range-based loops, eg:\r\n\r\n```diff\r\nâ git d\r\ndiff --git a/src/net.cpp b/src/net.cpp\r\nindex 6040ee86be..5388af02e3 100644\r\n--- a/src/net.cpp\r\n+++ b/src/net.cpp\r\n@@ -1501,7 +1509,7 @@ void CConnman::SocketHandler()\r\n     //\r\n     // Service each socket\r\n     //\r\n-    for (CNode* pnode : snap.Nodes()) {\r\n+    for (CNode* pnode : snap) {\r\n         if (interruptNet)\r\n             return;\r\n \r\n```",
      "commit_id" : "00a8c943d7df3e5a58e55928a8600e062c5b4ad5",
      "created_at" : "2021-05-15T18:07:45Z",
      "diff_hunk" : "@@ -1257,6 +1276,40 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot\n+    {\n+    public:\n+        explicit NodesSnapshot(const CConnman& connman) : m_connman{connman}\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            m_nodes_copy = m_connman.vNodes;\n+            for (auto& node : m_nodes_copy) {\n+                node->AddRef();\n+            }\n+        }\n+\n+        ~NodesSnapshot()\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            for (auto& node : m_nodes_copy) {\n+                node->Release();\n+            }\n+        }\n+\n+        const std::vector<CNode*>& Nodes() const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632989196",
      "id" : 632989196,
      "line" : 1302,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMjk4OTE5Ng==",
      "original_commit_id" : "92f62d9ea43c6861409916256a403417d80c0932",
      "original_line" : 1302,
      "original_position" : 58,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 57,
      "pull_request_review_id" : 660378433,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-15T18:07:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632989196",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r633599186"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633599186"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Right, a comment is warranted. Added:\r\n\r\n```cpp\r\n    // Accept new connections. Done after taking a snapshot of the nodes because\r\n    // `AcceptConnection()` will add new entries to `vNodes` which are unwanted\r\n    // in the loop below because:\r\n    // - all of `recvSet`, `sendSet` and `errorSet` will be `false` for them\r\n    // - `InactivityCheck()` will either be a noop or will wrongly command to\r\n    //   disconnect the node before we have tried sending or receiving anything\r\n    //   to it.\r\n```",
      "commit_id" : "00a8c943d7df3e5a58e55928a8600e062c5b4ad5",
      "created_at" : "2021-05-17T14:48:38Z",
      "diff_hunk" : "@@ -1467,8 +1467,6 @@ void CConnman::SocketHandler()\n         }\n     }\n \n-    NodesSnapshot snap{*this};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r633599186",
      "id" : 633599186,
      "in_reply_to_id" : 632150326,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMzU5OTE4Ng==",
      "original_commit_id" : "157674ef213e6329215d1b7eb85dacbc23c468db",
      "original_line" : 1470,
      "original_position" : 61,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 661060828,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-17T14:48:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633599186",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r633613085"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633613085"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> I'm guessing you've defined this class within CConnman to enable access to the private members.\r\n\r\nNo, I did it to minimize the scope of the newly added class.\r\n\r\n> Seems nice to keep this mechanism that's only used internally out of the header file.\r\n\r\nWhy? It is used internally by `CConnman` and is defined in its `private:` section. If defined in `net.cpp` that would broaden its scope unnecessary.",
      "commit_id" : "00a8c943d7df3e5a58e55928a8600e062c5b4ad5",
      "created_at" : "2021-05-17T15:04:40Z",
      "diff_hunk" : "@@ -1257,6 +1276,40 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r633613085",
      "id" : 633613085,
      "in_reply_to_id" : 632972362,
      "line" : 1283,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMzYxMzA4NQ==",
      "original_commit_id" : "92f62d9ea43c6861409916256a403417d80c0932",
      "original_line" : 1283,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 38,
      "pull_request_review_id" : 661079909,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-17T15:04:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633613085",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r633614762"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633614762"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done.",
      "commit_id" : "00a8c943d7df3e5a58e55928a8600e062c5b4ad5",
      "created_at" : "2021-05-17T15:06:47Z",
      "diff_hunk" : "@@ -1451,8 +1447,10 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n+    NodesSnapshot snap{*this};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r633614762",
      "id" : 633614762,
      "in_reply_to_id" : 632972531,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMzYxNDc2Mg==",
      "original_commit_id" : "92f62d9ea43c6861409916256a403417d80c0932",
      "original_line" : 1450,
      "original_position" : 105,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 661082288,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-17T15:06:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633614762",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r633614896"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633614896"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done.",
      "commit_id" : "00a8c943d7df3e5a58e55928a8600e062c5b4ad5",
      "created_at" : "2021-05-17T15:06:57Z",
      "diff_hunk" : "@@ -2174,41 +2159,29 @@ void CConnman::ThreadMessageHandler()\n {\n     while (!flagInterruptMsgProc)\n     {\n-        std::vector<CNode*> vNodesCopy;\n-        {\n-            LOCK(cs_vNodes);\n-            vNodesCopy = vNodes;\n-            for (CNode* pnode : vNodesCopy) {\n-                pnode->AddRef();\n-            }\n-        }\n-\n         bool fMoreWork = false;\n \n-        for (CNode* pnode : vNodesCopy)\n         {\n-            if (pnode->fDisconnect)\n-                continue;\n+            NodesSnapshot snap{*this};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r633614896",
      "id" : 633614896,
      "in_reply_to_id" : 632972552,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMzYxNDg5Ng==",
      "original_commit_id" : "92f62d9ea43c6861409916256a403417d80c0932",
      "original_line" : 2165,
      "original_position" : 161,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 661082490,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-17T15:06:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633614896",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r633616340"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633616340"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The copying and `AddRef()` should be done under the lock.",
      "commit_id" : "00a8c943d7df3e5a58e55928a8600e062c5b4ad5",
      "created_at" : "2021-05-17T15:08:39Z",
      "diff_hunk" : "@@ -1257,6 +1276,40 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot\n+    {\n+    public:\n+        explicit NodesSnapshot(const CConnman& connman) : m_connman{connman}\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            m_nodes_copy = m_connman.vNodes;\n+            for (auto& node : m_nodes_copy) {\n+                node->AddRef();\n+            }\n+        }\n+\n+        ~NodesSnapshot()\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            for (auto& node : m_nodes_copy) {\n+                node->Release();\n+            }\n+        }\n+\n+        const std::vector<CNode*>& Nodes() const\n+        {\n+            return m_nodes_copy;\n+        }\n+\n+    private:\n+        const CConnman& m_connman;\n+        std::vector<CNode*> m_nodes_copy;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r633616340",
      "id" : 633616340,
      "in_reply_to_id" : 632973688,
      "line" : 1308,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMzYxNjM0MA==",
      "original_commit_id" : "92f62d9ea43c6861409916256a403417d80c0932",
      "original_line" : 1308,
      "original_position" : 65,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 63,
      "pull_request_review_id" : 661084484,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-17T15:08:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633616340",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r633617646"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633617646"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> Is it necessary for `Release()` to be under the lock?\r\n\r\nThe lock has two effects:\r\n* All `Release()`s happen atomically together. If removed, then other threads could observe some nodes from the snapshot released and some not yet released. I think that is ok.\r\n* No memory reordering can happen. The `nRefCount--` on the atomic variable has the same effect because `--` is equivalent to [`fetch_sub()`](https://en.cppreference.com/w/cpp/atomic/atomic/fetch_sub) which uses [`memory_order_seq_cst`](https://en.cppreference.com/w/cpp/atomic/memory_order) by default.\r\n\r\n\r\nRemoved the lock and simplified `NodesSnapshot`, thanks!",
      "commit_id" : "00a8c943d7df3e5a58e55928a8600e062c5b4ad5",
      "created_at" : "2021-05-17T15:10:02Z",
      "diff_hunk" : "@@ -1257,6 +1276,40 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot\n+    {\n+    public:\n+        explicit NodesSnapshot(const CConnman& connman) : m_connman{connman}\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            m_nodes_copy = m_connman.vNodes;\n+            for (auto& node : m_nodes_copy) {\n+                node->AddRef();\n+            }\n+        }\n+\n+        ~NodesSnapshot()\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            for (auto& node : m_nodes_copy) {\n+                node->Release();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r633617646",
      "id" : 633617646,
      "in_reply_to_id" : 632974904,
      "line" : 1298,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMzYxNzY0Ng==",
      "original_commit_id" : "92f62d9ea43c6861409916256a403417d80c0932",
      "original_line" : 1298,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 53,
      "pull_request_review_id" : 661087509,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-17T15:10:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633617646",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r633625021"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633625021"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think both ways would work.\r\n\r\nThe begin/end variant seems to be a bit more code - it saves just `.Nodes()` from the callers but has two methods and is also less friendly to grepping and code navigation - now I can point my \"IDE\" to `Nodes()` on the line `for (CNode* pnode : snap.Nodes()) {` and see what it returns or its definition. Not so with the `for (CNode* pnode : snap) {` line.\r\n\r\nThat said, I am fine either way but have a slight preference for the `.Nodes()` variant.",
      "commit_id" : "00a8c943d7df3e5a58e55928a8600e062c5b4ad5",
      "created_at" : "2021-05-17T15:17:35Z",
      "diff_hunk" : "@@ -1257,6 +1276,40 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot\n+    {\n+    public:\n+        explicit NodesSnapshot(const CConnman& connman) : m_connman{connman}\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            m_nodes_copy = m_connman.vNodes;\n+            for (auto& node : m_nodes_copy) {\n+                node->AddRef();\n+            }\n+        }\n+\n+        ~NodesSnapshot()\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            for (auto& node : m_nodes_copy) {\n+                node->Release();\n+            }\n+        }\n+\n+        const std::vector<CNode*>& Nodes() const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r633625021",
      "id" : 633625021,
      "in_reply_to_id" : 632989196,
      "line" : 1302,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMzYyNTAyMQ==",
      "original_commit_id" : "92f62d9ea43c6861409916256a403417d80c0932",
      "original_line" : 1302,
      "original_position" : 58,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 57,
      "pull_request_review_id" : 661096340,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-17T15:17:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633625021",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "`92f62d9...00a8c94`: address review suggestions",
      "created_at" : "2021-05-17T15:19:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-842411377",
      "id" : 842411377,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21943",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0MjQxMTM3Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-17T15:19:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/842411377",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r633628981"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633628981"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No strong preference. Just pointing out an alternative. I'll mark this as resolved.",
      "commit_id" : "00a8c943d7df3e5a58e55928a8600e062c5b4ad5",
      "created_at" : "2021-05-17T15:22:19Z",
      "diff_hunk" : "@@ -1257,6 +1276,40 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot\n+    {\n+    public:\n+        explicit NodesSnapshot(const CConnman& connman) : m_connman{connman}\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            m_nodes_copy = m_connman.vNodes;\n+            for (auto& node : m_nodes_copy) {\n+                node->AddRef();\n+            }\n+        }\n+\n+        ~NodesSnapshot()\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            for (auto& node : m_nodes_copy) {\n+                node->Release();\n+            }\n+        }\n+\n+        const std::vector<CNode*>& Nodes() const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r633628981",
      "id" : 633628981,
      "in_reply_to_id" : 632989196,
      "line" : 1302,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMzYyODk4MQ==",
      "original_commit_id" : "92f62d9ea43c6861409916256a403417d80c0932",
      "original_line" : 1302,
      "original_position" : 58,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 57,
      "pull_request_review_id" : 661101634,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-17T15:22:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633628981",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r633891308"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633891308"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why `AddRef`? @amitiuttarwar suggestion can be accomplished with\r\n```diff\r\n         explicit NodesSnapshot(const CConnman& connman)\r\n+            : m_nodes_copy(WITH_LOCK(connman.cs_vNodes, return connman.vNodes))\r\n         {\r\n-            LOCK(connman.cs_vNodes);\r\n-            m_nodes_copy = connman.vNodes;\r\n             for (auto& node : m_nodes_copy) {\r\n                 node->AddRef();\r\n             }\r\n@@ -1305,7 +1304,7 @@ private:\r\n         }\r\n\r\n     private:\r\n-        std::vector<CNode*> m_nodes_copy;\r\n+        const std::vector<CNode*> m_nodes_copy;\r\n     };\r\n```\r\n\r\nNever mind, I see why `AddRef` needs to be under the lock. It's still possible to use the `WITH_LOCK` approach so `m_nodes_copy` could be is const, but not worth it IMO.",
      "commit_id" : "00a8c943d7df3e5a58e55928a8600e062c5b4ad5",
      "created_at" : "2021-05-17T21:50:41Z",
      "diff_hunk" : "@@ -1257,6 +1276,40 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot\n+    {\n+    public:\n+        explicit NodesSnapshot(const CConnman& connman) : m_connman{connman}\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            m_nodes_copy = m_connman.vNodes;\n+            for (auto& node : m_nodes_copy) {\n+                node->AddRef();\n+            }\n+        }\n+\n+        ~NodesSnapshot()\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            for (auto& node : m_nodes_copy) {\n+                node->Release();\n+            }\n+        }\n+\n+        const std::vector<CNode*>& Nodes() const\n+        {\n+            return m_nodes_copy;\n+        }\n+\n+    private:\n+        const CConnman& m_connman;\n+        std::vector<CNode*> m_nodes_copy;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r633891308",
      "id" : 633891308,
      "in_reply_to_id" : 632973688,
      "line" : 1308,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMzg5MTMwOA==",
      "original_commit_id" : "92f62d9ea43c6861409916256a403417d80c0932",
      "original_line" : 1308,
      "original_position" : 65,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 63,
      "pull_request_review_id" : 661454158,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-17T21:53:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633891308",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r634141685"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634141685"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yeah :) `AddRef()` needs to be under the same lock that did the copy (without release in between) because otherwise some of the copied elements may be destroyed in the meantime and `node->` to try to dereference a dangling pointer while trying to call `AddRef()`.\r\n\r\nIt should work with something like\r\n```cpp\r\nexplicit NodesSnapshot(const CConnman& connman)\r\n            : m_nodes_copy(WITH_LOCK(connman.cs_vNodes, for (auto& node : connman.vNodes) { node->AddRef(); } ; return connman.vNodes))\r\n```\r\n\r\nbut that is not worth it indeed :)",
      "commit_id" : "00a8c943d7df3e5a58e55928a8600e062c5b4ad5",
      "created_at" : "2021-05-18T08:04:05Z",
      "diff_hunk" : "@@ -1257,6 +1276,40 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot\n+    {\n+    public:\n+        explicit NodesSnapshot(const CConnman& connman) : m_connman{connman}\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            m_nodes_copy = m_connman.vNodes;\n+            for (auto& node : m_nodes_copy) {\n+                node->AddRef();\n+            }\n+        }\n+\n+        ~NodesSnapshot()\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            for (auto& node : m_nodes_copy) {\n+                node->Release();\n+            }\n+        }\n+\n+        const std::vector<CNode*>& Nodes() const\n+        {\n+            return m_nodes_copy;\n+        }\n+\n+    private:\n+        const CConnman& m_connman;\n+        std::vector<CNode*> m_nodes_copy;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r634141685",
      "id" : 634141685,
      "in_reply_to_id" : 632973688,
      "line" : 1308,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNDE0MTY4NQ==",
      "original_commit_id" : "92f62d9ea43c6861409916256a403417d80c0932",
      "original_line" : 1308,
      "original_position" : 65,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 63,
      "pull_request_review_id" : 661765027,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-18T08:04:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634141685",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r634196764"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634196764"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> > Seems nice to keep this mechanism that's only used internally out of the header file.\r\n\r\n> Why?\r\n\r\nBecause it's good to keep header files limited to what's required to be included into other translation units (as far as is possible). That's beneficial for both build time and code management reasons.\r\n\r\nI think both ways are fine, and that eventually we'll want to virtualize both `CNode`'s and `CConnman`'s public interfaces so that they can be mocked out for testing, at which point the private methods could all be moved to the implementation file.",
      "commit_id" : "00a8c943d7df3e5a58e55928a8600e062c5b4ad5",
      "created_at" : "2021-05-18T09:15:34Z",
      "diff_hunk" : "@@ -1257,6 +1276,40 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r634196764",
      "id" : 634196764,
      "in_reply_to_id" : 632972362,
      "line" : 1283,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNDE5Njc2NA==",
      "original_commit_id" : "92f62d9ea43c6861409916256a403417d80c0932",
      "original_line" : 1283,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 38,
      "pull_request_review_id" : 661837870,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-18T09:15:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634196764",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r634254981"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634254981"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> That's beneficial for both build time...\r\n\r\nI do not think it is justified to put private class members as globals in the `.cpp` file in order to minimize the header file so that it compiles faster.\r\n\r\n> ... and code management reasons.\r\n\r\nUnnecessary broadened scope has an adverse effect on code management.",
      "commit_id" : "00a8c943d7df3e5a58e55928a8600e062c5b4ad5",
      "created_at" : "2021-05-18T10:35:22Z",
      "diff_hunk" : "@@ -1257,6 +1276,40 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r634254981",
      "id" : 634254981,
      "in_reply_to_id" : 632972362,
      "line" : 1283,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNDI1NDk4MQ==",
      "original_commit_id" : "92f62d9ea43c6861409916256a403417d80c0932",
      "original_line" : 1283,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 38,
      "pull_request_review_id" : 661915095,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-18T10:35:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634254981",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r634777026"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634777026"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If `NodesSnapshot` was defined as a standalone class in `net.cpp`, it could be added to the unnamed namespace so it would only be accessible within the same translation unit, but it would broaden the scope beyond `CConnman` to within the translation unit. \r\n\r\nMy preference for it to be in the `.cpp` is because I find it easier to understand responsibilities & maneuver the files when the headers capture the way the classes interact with external callers. But I totally understand the point about broadening scope, and think this ultimately comes down to a preference.\r\n\r\nI'm going to resolve this conversation, thanks for the feedback @vasild & @jnewbery :) ",
      "commit_id" : "00a8c943d7df3e5a58e55928a8600e062c5b4ad5",
      "created_at" : "2021-05-18T22:00:44Z",
      "diff_hunk" : "@@ -1257,6 +1276,40 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r634777026",
      "id" : 634777026,
      "in_reply_to_id" : 632972362,
      "line" : 1283,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNDc3NzAyNg==",
      "original_commit_id" : "92f62d9ea43c6861409916256a403417d80c0932",
      "original_line" : 1283,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 38,
      "pull_request_review_id" : 662612291,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-18T22:00:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634777026",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r635077910"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/635077910"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "@amitiuttarwar, maybe you would like the following pattern to be more widespread:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/1ed859e90e18384376e3a1ff0cb76f3e9ab11c2d/src/txrequest.h#L96-L101",
      "commit_id" : "00a8c943d7df3e5a58e55928a8600e062c5b4ad5",
      "created_at" : "2021-05-19T09:40:06Z",
      "diff_hunk" : "@@ -1257,6 +1276,40 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r635077910",
      "id" : 635077910,
      "in_reply_to_id" : 632972362,
      "line" : 1283,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNTA3NzkxMA==",
      "original_commit_id" : "92f62d9ea43c6861409916256a403417d80c0932",
      "original_line" : 1283,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 38,
      "pull_request_review_id" : 662980191,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-19T09:40:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/635077910",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r635470619"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/635470619"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yeah, I'm def a fan of the pimpl / related patterns. Another example is how its used in `net_processing` since #20811.",
      "commit_id" : "00a8c943d7df3e5a58e55928a8600e062c5b4ad5",
      "created_at" : "2021-05-19T18:03:51Z",
      "diff_hunk" : "@@ -1257,6 +1276,40 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r635470619",
      "id" : 635470619,
      "in_reply_to_id" : 632972362,
      "line" : 1283,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNTQ3MDYxOQ==",
      "original_commit_id" : "92f62d9ea43c6861409916256a403417d80c0932",
      "original_line" : 1283,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 38,
      "pull_request_review_id" : 663513225,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-19T18:03:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/635470619",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-06-16T04:16:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-862025714",
      "id" : 862025714,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21943",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2MjAyNTcxNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-16T04:16:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/862025714",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "`00a8c943d7...072896b7cf`: rebase due to conflicts",
      "created_at" : "2021-06-22T09:25:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-865809778",
      "id" : 865809778,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21943",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2NTgwOTc3OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-22T09:25:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/865809778",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK, particularly if this can reduce `vNodes` lock contentions in these areas that are among the most frequent and long-lasting of those I'm seeing on my nodes with `-debug=lock`.\r\n\r\nIt looks like the CI stalled out on the last push. In any case, it rebases cleanly onto current master, the debug build is clean, and the unit/functional test suite is green for me locally. Reviewing.",
      "created_at" : "2021-09-19T17:08:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-922506073",
      "id" : 922506073,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21943",
      "node_id" : "IC_kwDOABII5842_FNZ",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-19T17:08:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/922506073",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r711994001"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711994001"
         }
      },
      "author_association" : "MEMBER",
      "body" : "0d706a6 if you retouch or have to rebase\r\n```suggestion\r\n    const NodesSnapshot snap{*this, /* shuffle=*/ false};\r\n```",
      "commit_id" : "a4fbf1ba594b03379a65e780892b70bb7d4c1e4e",
      "created_at" : "2021-09-20T09:08:22Z",
      "diff_hunk" : "@@ -1492,13 +1488,21 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n+    const NodesSnapshot snap{*this, false};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r711994001",
      "id" : 711994001,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584qcCqR",
      "original_commit_id" : "072896b7cf5e69c11a2e6d9e7163df4e0472f504",
      "original_line" : 1491,
      "original_position" : 105,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 758400122,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-20T10:14:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711994001",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r711994365"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711994365"
         }
      },
      "author_association" : "MEMBER",
      "body" : "0d706a6 if you retouch or have to rebase, I think the comment about randomizing makes more sense with a named arg for `shuffle` \r\n```suggestion\r\n            const NodesSnapshot snap{*this, /* shuffle=*/ true};\r\n```",
      "commit_id" : "a4fbf1ba594b03379a65e780892b70bb7d4c1e4e",
      "created_at" : "2021-09-20T09:08:52Z",
      "diff_hunk" : "@@ -2213,49 +2204,34 @@ void CConnman::OpenNetworkConnection(const CAddress& addrConnect, bool fCountFai\n \n void CConnman::ThreadMessageHandler()\n {\n-    FastRandomContext rng;\n     while (!flagInterruptMsgProc)\n     {\n-        std::vector<CNode*> vNodesCopy;\n-        {\n-            LOCK(cs_vNodes);\n-            vNodesCopy = vNodes;\n-            for (CNode* pnode : vNodesCopy) {\n-                pnode->AddRef();\n-            }\n-        }\n-\n         bool fMoreWork = false;\n \n-        // Randomize the order in which we process messages from/to our peers.\n-        // This prevents attacks in which an attacker exploits having multiple\n-        // consecutive connections in the vNodes list.\n-        Shuffle(vNodesCopy.begin(), vNodesCopy.end(), rng);\n-\n-        for (CNode* pnode : vNodesCopy)\n         {\n-            if (pnode->fDisconnect)\n-                continue;\n+            // Randomize the order in which we process messages from/to our peers.\n+            // This prevents attacks in which an attacker exploits having multiple\n+            // consecutive connections in the vNodes list.\n+            const NodesSnapshot snap{*this, true};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r711994365",
      "id" : 711994365,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584qcCv9",
      "original_commit_id" : "072896b7cf5e69c11a2e6d9e7163df4e0472f504",
      "original_line" : 2215,
      "original_position" : 184,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 758400122,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-20T10:14:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711994365",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r712014389"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/712014389"
         }
      },
      "author_association" : "MEMBER",
      "body" : "bf0dc73 nit doc suggestion, `s/readiness for IO/IO readiness/` or the pithier\r\n\r\n```suggestion\r\n     * Generate a collection of sockets to check for IO readiness.\r\n```",
      "commit_id" : "a4fbf1ba594b03379a65e780892b70bb7d4c1e4e",
      "created_at" : "2021-09-20T09:39:04Z",
      "diff_hunk" : "@@ -992,8 +992,27 @@ class CConnman\n     void NotifyNumConnectionsChanged();\n     /** Return true if the peer is inactive and should be disconnected. */\n     bool InactivityCheck(const CNode& node) const;\n-    bool GenerateSelectSet(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set);\n-    void SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set);\n+\n+    /**\n+     * Generate a collection of sockets that we want to be checked for readiness for IO.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r712014389",
      "id" : 712014389,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584qcHo1",
      "original_commit_id" : "072896b7cf5e69c11a2e6d9e7163df4e0472f504",
      "original_line" : 997,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 758400122,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-20T10:14:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/712014389",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r712022174"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/712022174"
         }
      },
      "author_association" : "MEMBER",
      "body" : "072896b these braces were needed to define the scope for the `LOCK(cs_vNodes);` mutex lock that is removed in the previous commit, so it may be a bit clearer to remove them at the same time as the lock. No strong opinion though. ",
      "commit_id" : "a4fbf1ba594b03379a65e780892b70bb7d4c1e4e",
      "created_at" : "2021-09-20T09:50:56Z",
      "diff_hunk" : "@@ -1326,57 +1326,53 @@ bool CConnman::InactivityCheck(const CNode& node) const\n     return false;\n }\n \n-bool CConnman::GenerateSelectSet(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set)\n+bool CConnman::GenerateSelectSet(const std::vector<CNode*>& nodes, std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set)\n {\n     for (const ListenSocket& hListenSocket : vhListenSocket) {\n         recv_set.insert(hListenSocket.socket);\n     }\n \n-    {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r712022174",
      "id" : 712022174,
      "line" : 1340,
      "node_id" : "PRRC_kwDOABII584qcJie",
      "original_commit_id" : "072896b7cf5e69c11a2e6d9e7163df4e0472f504",
      "original_line" : 1340,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 11,
      "pull_request_review_id" : 758400122,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-20T10:17:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/712022174",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "concept ACK ",
      "created_at" : "2021-09-25T09:46:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-927096514",
      "id" : 927096514,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21943",
      "node_id" : "IC_kwDOABII5843Ql7C",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-25T09:46:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/927096514",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=4",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "node_id" : "MDQ6VXNlcjE1MzAyODM=",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "`072896b7cf...a4fbf1ba59`: rebase and address review suggestions\r\n\r\nInvalidates ACK from @jonatack.",
      "created_at" : "2021-09-28T07:29:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-928930542",
      "id" : 928930542,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21943",
      "node_id" : "IC_kwDOABII5843Xlru",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-28T07:34:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/928930542",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r717301345"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717301345"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Added the comment. Some grepping showed the most common form of this is `func(/* description */ param);`",
      "commit_id" : "a4fbf1ba594b03379a65e780892b70bb7d4c1e4e",
      "created_at" : "2021-09-28T07:31:07Z",
      "diff_hunk" : "@@ -1492,13 +1488,21 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n+    const NodesSnapshot snap{*this, false};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r717301345",
      "id" : 717301345,
      "in_reply_to_id" : 711994001,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584qwSZh",
      "original_commit_id" : "072896b7cf5e69c11a2e6d9e7163df4e0472f504",
      "original_line" : 1491,
      "original_position" : 105,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 765069220,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-28T07:31:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717301345",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r717301455"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717301455"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Added the comment. Some grepping showed the most common form of this is `func(/* description */ param);`",
      "commit_id" : "a4fbf1ba594b03379a65e780892b70bb7d4c1e4e",
      "created_at" : "2021-09-28T07:31:14Z",
      "diff_hunk" : "@@ -2213,49 +2204,34 @@ void CConnman::OpenNetworkConnection(const CAddress& addrConnect, bool fCountFai\n \n void CConnman::ThreadMessageHandler()\n {\n-    FastRandomContext rng;\n     while (!flagInterruptMsgProc)\n     {\n-        std::vector<CNode*> vNodesCopy;\n-        {\n-            LOCK(cs_vNodes);\n-            vNodesCopy = vNodes;\n-            for (CNode* pnode : vNodesCopy) {\n-                pnode->AddRef();\n-            }\n-        }\n-\n         bool fMoreWork = false;\n \n-        // Randomize the order in which we process messages from/to our peers.\n-        // This prevents attacks in which an attacker exploits having multiple\n-        // consecutive connections in the vNodes list.\n-        Shuffle(vNodesCopy.begin(), vNodesCopy.end(), rng);\n-\n-        for (CNode* pnode : vNodesCopy)\n         {\n-            if (pnode->fDisconnect)\n-                continue;\n+            // Randomize the order in which we process messages from/to our peers.\n+            // This prevents attacks in which an attacker exploits having multiple\n+            // consecutive connections in the vNodes list.\n+            const NodesSnapshot snap{*this, true};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r717301455",
      "id" : 717301455,
      "in_reply_to_id" : 711994365,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584qwSbP",
      "original_commit_id" : "072896b7cf5e69c11a2e6d9e7163df4e0472f504",
      "original_line" : 2215,
      "original_position" : 184,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 765069330,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-28T07:31:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717301455",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r717301573"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717301573"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done.",
      "commit_id" : "a4fbf1ba594b03379a65e780892b70bb7d4c1e4e",
      "created_at" : "2021-09-28T07:31:24Z",
      "diff_hunk" : "@@ -992,8 +992,27 @@ class CConnman\n     void NotifyNumConnectionsChanged();\n     /** Return true if the peer is inactive and should be disconnected. */\n     bool InactivityCheck(const CNode& node) const;\n-    bool GenerateSelectSet(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set);\n-    void SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set);\n+\n+    /**\n+     * Generate a collection of sockets that we want to be checked for readiness for IO.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r717301573",
      "id" : 717301573,
      "in_reply_to_id" : 712014389,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584qwSdF",
      "original_commit_id" : "072896b7cf5e69c11a2e6d9e7163df4e0472f504",
      "original_line" : 997,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 765069500,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-28T07:31:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717301573",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r717303767"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717303767"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I deliberately did the white-space change in a separate commit to ease review which would be harder if logic changes are mixed with lots of white-space changes. I extended the commit message though, so that it is easier to answer \"how did we end up with those unnecessary braces\".",
      "commit_id" : "a4fbf1ba594b03379a65e780892b70bb7d4c1e4e",
      "created_at" : "2021-09-28T07:34:14Z",
      "diff_hunk" : "@@ -1326,57 +1326,53 @@ bool CConnman::InactivityCheck(const CNode& node) const\n     return false;\n }\n \n-bool CConnman::GenerateSelectSet(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set)\n+bool CConnman::GenerateSelectSet(const std::vector<CNode*>& nodes, std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set)\n {\n     for (const ListenSocket& hListenSocket : vhListenSocket) {\n         recv_set.insert(hListenSocket.socket);\n     }\n \n-    {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r717303767",
      "id" : 717303767,
      "in_reply_to_id" : 712022174,
      "line" : 1340,
      "node_id" : "PRRC_kwDOABII584qwS_X",
      "original_commit_id" : "072896b7cf5e69c11a2e6d9e7163df4e0472f504",
      "original_line" : 1340,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 11,
      "pull_request_review_id" : 765072250,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-28T07:34:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717303767",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r717379468"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717379468"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes. I've very recently started to switch to the `/*named_arg=*/` format for `bugprone-argument-comment` added in fa57fa1a2e7. Not sure how picky clang is about it though.\r\n\r\nhttps://releases.llvm.org/12.0.0/tools/clang/tools/extra/docs/clang-tidy/checks/bugprone-argument-comment.html.",
      "commit_id" : "99c1af5a8f95051e98ad4b9486eef70919ab2708",
      "created_at" : "2021-09-28T09:08:46Z",
      "diff_hunk" : "@@ -1492,13 +1488,21 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n+    const NodesSnapshot snap{*this, false};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r717379468",
      "id" : 717379468,
      "in_reply_to_id" : 711994001,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584qwleM",
      "original_commit_id" : "072896b7cf5e69c11a2e6d9e7163df4e0472f504",
      "original_line" : 1491,
      "original_position" : 105,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 765175113,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717379468/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-03T17:34:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717379468",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Diff-review ACK a4fbf1ba594b03379a65e780892b70bb7d4c1e4e per `git range-diff a9d0cec 072896b a4fbf1b` following my earlier full review (https://github.com/bitcoin/bitcoin/pull/21943#pullrequestreview-758400122) ",
      "created_at" : "2021-09-28T09:10:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-929004503",
      "id" : 929004503,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21943",
      "node_id" : "IC_kwDOABII5843X3vX",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-28T09:10:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/929004503",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r717384169"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717384169"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, no worries. Since some time now my `.gitconfig` has this set by default to simplify whitespace review (open to suggestions).\r\n```\r\n[diff]\r\n  renames = copies\r\n\tcolorMoved = dimmed-zebra\r\n\tcolorMovedWs = allow-indentation-change\r\n```\r\n",
      "commit_id" : "a4fbf1ba594b03379a65e780892b70bb7d4c1e4e",
      "created_at" : "2021-09-28T09:14:31Z",
      "diff_hunk" : "@@ -1326,57 +1326,53 @@ bool CConnman::InactivityCheck(const CNode& node) const\n     return false;\n }\n \n-bool CConnman::GenerateSelectSet(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set)\n+bool CConnman::GenerateSelectSet(const std::vector<CNode*>& nodes, std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set)\n {\n     for (const ListenSocket& hListenSocket : vhListenSocket) {\n         recv_set.insert(hListenSocket.socket);\n     }\n \n-    {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r717384169",
      "id" : 717384169,
      "in_reply_to_id" : 712022174,
      "line" : 1340,
      "node_id" : "PRRC_kwDOABII584qwmnp",
      "original_commit_id" : "072896b7cf5e69c11a2e6d9e7163df4e0472f504",
      "original_line" : 1340,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 11,
      "pull_request_review_id" : 765181441,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-28T09:14:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717384169",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r717405324"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717405324"
         }
      },
      "author_association" : "MEMBER",
      "body" : "My testing revealed that the `=` is needed for clang-tidy. I am likely going to use `(/*foo_bar=*/123, ` from now on (I think clang-format \"mirrors\" the whitespace, so clang-format valid options are `(/*foo_bar=*/123, /*bar_foor=*/321, ` or `(/* foo_bar = */ 123, /* bar_foor = */ 321, `",
      "commit_id" : "a4fbf1ba594b03379a65e780892b70bb7d4c1e4e",
      "created_at" : "2021-09-28T09:41:37Z",
      "diff_hunk" : "@@ -1492,13 +1488,21 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n+    const NodesSnapshot snap{*this, false};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r717405324",
      "id" : 717405324,
      "in_reply_to_id" : 711994001,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584qwryM",
      "original_commit_id" : "072896b7cf5e69c11a2e6d9e7163df4e0472f504",
      "original_line" : 1491,
      "original_position" : 105,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 765210141,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-28T09:41:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717405324",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r717427120"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717427120"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks, good to know.",
      "commit_id" : "40e0bc8de29eab1aec4464e93fb42eccb9a81f5d",
      "created_at" : "2021-09-28T10:09:46Z",
      "diff_hunk" : "@@ -1492,13 +1488,21 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n+    const NodesSnapshot snap{*this, false};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r717427120",
      "id" : 717427120,
      "in_reply_to_id" : 711994001,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584qwxGw",
      "original_commit_id" : "072896b7cf5e69c11a2e6d9e7163df4e0472f504",
      "original_line" : 1491,
      "original_position" : 105,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 765239667,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-28T10:09:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717427120",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r717530409"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717530409"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`/* bar_foor= */ 321` is also ok for clang-format (re-formatting that with clang-format leaves it unmodified). I don't care which one as long as it is consistent through the code. I will use `/*foo_bar=*/123` too.",
      "commit_id" : "40e0bc8de29eab1aec4464e93fb42eccb9a81f5d",
      "created_at" : "2021-09-28T12:37:04Z",
      "diff_hunk" : "@@ -1492,13 +1488,21 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n+    const NodesSnapshot snap{*this, false};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r717530409",
      "id" : 717530409,
      "in_reply_to_id" : 711994001,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584qxKUp",
      "original_commit_id" : "072896b7cf5e69c11a2e6d9e7163df4e0472f504",
      "original_line" : 1491,
      "original_position" : 105,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 765380171,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-28T12:37:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717530409",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "`a4fbf1ba59...40e0bc8de2`: rebase and switch to `/*description=*/123` following https://github.com/bitcoin/bitcoin/pull/21943#discussion_r711994001.\r\n\r\nSorry for the noise, I hope no more changes to this PR.\r\n\r\nInvalidates ACKs from @jonatack, @promag.",
      "created_at" : "2021-09-28T13:18:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-929201658",
      "id" : 929201658,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21943",
      "node_id" : "IC_kwDOABII5843Yn36",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-28T13:18:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/929201658",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "No need to invalidate ACKs. I was planning a scripted-diff some day to clean everything up, which would have covered this.",
      "created_at" : "2021-09-28T13:32:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-929213552",
      "id" : 929213552,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21943",
      "node_id" : "IC_kwDOABII5843Yqxw",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-28T13:32:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/929213552",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Diff-review re-ACK 40e0bc8de29eab1aec4464e93fb42eccb9a81f5d following my earlier full review (https://github.com/bitcoin/bitcoin/pull/21943#pullrequestreview-758400122) ",
      "created_at" : "2021-09-28T16:24:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-929384060",
      "id" : 929384060,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21943",
      "node_id" : "IC_kwDOABII5843ZUZ8",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-28T16:24:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/929384060",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-10-04T22:25:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-933902877",
      "id" : 933902877,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21943",
      "node_id" : "IC_kwDOABII5843qjod",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/933902877/reactions"
      },
      "updated_at" : "2021-10-04T22:25:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/933902877",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "`40e0bc8de2...99c1af5a8f`: rebase due to conflicts\r\n\r\nInvalidates ACK from @jonatack \r\n\r\nPreviously invalidated ACK from @promag \r\n",
      "created_at" : "2021-10-08T09:21:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-938488261",
      "id" : 938488261,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21943",
      "node_id" : "IC_kwDOABII58438DHF",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/938488261/reactions"
      },
      "updated_at" : "2021-10-08T09:21:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/938488261",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r725079584"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/725079584"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think the logical flow of this function would be clearer if this logic was either moved to the bottom of the function, or pulled out of `SocketHandler()` entirely and put in `ThreadSocketHandler()` (or a dedicated function for accepting new connections). It's difficult to get my head around creating a NodesSnapshot, receiving events for those nodes, then updating vNodes and finally processing the events for the nodes in the snapshot.",
      "commit_id" : "99c1af5a8f95051e98ad4b9486eef70919ab2708",
      "created_at" : "2021-10-08T14:50:21Z",
      "diff_hunk" : "@@ -1498,13 +1494,21 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n+    const NodesSnapshot snap{*this, /*shuffle=*/false};\n+\n     std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(recv_set, send_set, error_set);\n+    SocketEvents(snap.Nodes(), recv_set, send_set, error_set);\n \n     if (interruptNet) return;\n \n     //\n-    // Accept new connections\n+    // Accept new connections. Done after taking a snapshot of the nodes because",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r725079584",
      "id" : 725079584,
      "line" : 1505,
      "node_id" : "PRRC_kwDOABII584rN9Yg",
      "original_commit_id" : "99c1af5a8f95051e98ad4b9486eef70919ab2708",
      "original_line" : 1505,
      "original_position" : 115,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 115,
      "pull_request_review_id" : 775111135,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/725079584/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-08T14:50:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/725079584",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r725096927"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/725096927"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Alright, I think you are on the same page as @promag: https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632360108. I will move it to the bottom or see how many more changes to split it (pull it out). @jonatack, what do you think?",
      "commit_id" : "99c1af5a8f95051e98ad4b9486eef70919ab2708",
      "created_at" : "2021-10-08T15:12:15Z",
      "diff_hunk" : "@@ -1498,13 +1494,21 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n+    const NodesSnapshot snap{*this, /*shuffle=*/false};\n+\n     std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(recv_set, send_set, error_set);\n+    SocketEvents(snap.Nodes(), recv_set, send_set, error_set);\n \n     if (interruptNet) return;\n \n     //\n-    // Accept new connections\n+    // Accept new connections. Done after taking a snapshot of the nodes because",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r725096927",
      "id" : 725096927,
      "in_reply_to_id" : 725079584,
      "line" : 1505,
      "node_id" : "PRRC_kwDOABII584rOBnf",
      "original_commit_id" : "99c1af5a8f95051e98ad4b9486eef70919ab2708",
      "original_line" : 1505,
      "original_position" : 115,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 115,
      "pull_request_review_id" : 775135162,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/725096927/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-08T15:12:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/725096927",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r725119190"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/725119190"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Agree, I recall writing the same comment during my main review, moving the code to the end, then thinking it maybe made the most sense to make it a separate function, then deciding to not hold up this pull with that since it's been open a while and you have more steps in #21878. But yes.",
      "commit_id" : "99c1af5a8f95051e98ad4b9486eef70919ab2708",
      "created_at" : "2021-10-08T15:42:18Z",
      "diff_hunk" : "@@ -1498,13 +1494,21 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n+    const NodesSnapshot snap{*this, /*shuffle=*/false};\n+\n     std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(recv_set, send_set, error_set);\n+    SocketEvents(snap.Nodes(), recv_set, send_set, error_set);\n \n     if (interruptNet) return;\n \n     //\n-    // Accept new connections\n+    // Accept new connections. Done after taking a snapshot of the nodes because",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r725119190",
      "id" : 725119190,
      "in_reply_to_id" : 725079584,
      "line" : 1505,
      "node_id" : "PRRC_kwDOABII584rOHDW",
      "original_commit_id" : "99c1af5a8f95051e98ad4b9486eef70919ab2708",
      "original_line" : 1505,
      "original_position" : 115,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 115,
      "pull_request_review_id" : 775165468,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/725119190/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-08T15:42:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/725119190",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r728473929"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/728473929"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: since you're changing this line anyway, maybe reverse the space and `&` for the 3 set arguments (to conform to style convention)?\r\n(Same comment for `SocketEvents()` below, and also in `net.h`.)",
      "commit_id" : "99c1af5a8f95051e98ad4b9486eef70919ab2708",
      "created_at" : "2021-10-13T21:52:35Z",
      "diff_hunk" : "@@ -1332,57 +1332,53 @@ bool CConnman::InactivityCheck(const CNode& node) const\n     return false;\n }\n \n-bool CConnman::GenerateSelectSet(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set)\n+bool CConnman::GenerateSelectSet(const std::vector<CNode*>& nodes, std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r728473929",
      "id" : 728473929,
      "line" : 1335,
      "node_id" : "PRRC_kwDOABII584ra6FJ",
      "original_commit_id" : "99c1af5a8f95051e98ad4b9486eef70919ab2708",
      "original_line" : 1335,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 5,
      "pull_request_review_id" : 779123140,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/728473929/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-14T16:57:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/728473929",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r728483006"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/728483006"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Perhaps beyond the scope of this PR, but it may be better if [`Release()`](https://github.com/bitcoin/bitcoin/blob/71a85fbd09b5a450edc53a8ba4131f32e7136ca7/src/net.h#L630) asserted that the count is valid:\r\n```\r\nvoid Release()\r\n{\r\n    assert(nRefCount > 0);\r\n    nRefCount--;\r\n}\r\n```\r\nThe count validity is asserted in `GetRefCount()` but it would be better to catch the malefactor in the act :).",
      "commit_id" : "99c1af5a8f95051e98ad4b9486eef70919ab2708",
      "created_at" : "2021-10-13T22:10:01Z",
      "diff_hunk" : "@@ -1257,6 +1276,40 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot\n+    {\n+    public:\n+        explicit NodesSnapshot(const CConnman& connman) : m_connman{connman}\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            m_nodes_copy = m_connman.vNodes;\n+            for (auto& node : m_nodes_copy) {\n+                node->AddRef();\n+            }\n+        }\n+\n+        ~NodesSnapshot()\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            for (auto& node : m_nodes_copy) {\n+                node->Release();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r728483006",
      "id" : 728483006,
      "in_reply_to_id" : 632974904,
      "line" : 1224,
      "node_id" : "PRRC_kwDOABII584ra8S-",
      "original_commit_id" : "92f62d9ea43c6861409916256a403417d80c0932",
      "original_line" : 1224,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 59,
      "pull_request_review_id" : 779123140,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/728483006/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-14T16:57:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/728483006",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r729167321"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/729167321"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I would do this a little differently:\r\n```\r\nNodesSnapshot(const CConnman& connman)\r\n{\r\n    LOCK(connman.cs_vNodes);\r\n    m_nodes_copy = connman.vNodes;\r\n    for (auto& node : m_nodes_copy) {\r\n        node->AddRef();\r\n    }\r\n}\r\nstd::vector<CNode*>& Shuffle() {\r\n    FastRandomContext rng;\r\n    ::Shuffle(m_nodes_copy.begin(), m_nodes_copy.end(), rng);\r\n    return m_nodes_copy;\r\n}\r\n```",
      "commit_id" : "99c1af5a8f95051e98ad4b9486eef70919ab2708",
      "created_at" : "2021-10-14T16:48:48Z",
      "diff_hunk" : "@@ -1177,6 +1196,44 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot\n+    {\n+    public:\n+        explicit NodesSnapshot(const CConnman& connman, bool shuffle)\n+        {\n+            {\n+                LOCK(connman.cs_vNodes);\n+                m_nodes_copy = connman.vNodes;\n+                for (auto& node : m_nodes_copy) {\n+                    node->AddRef();\n+                }\n+            }\n+            if (shuffle) {\n+                FastRandomContext rng;\n+                Shuffle(m_nodes_copy.begin(), m_nodes_copy.end(), rng);\n+            }\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r729167321",
      "id" : 729167321,
      "line" : 1219,
      "node_id" : "PRRC_kwDOABII584rdjXZ",
      "original_commit_id" : "99c1af5a8f95051e98ad4b9486eef70919ab2708",
      "original_line" : 1219,
      "original_position" : 54,
      "original_start_line" : 1206,
      "path" : "src/net.h",
      "position" : 54,
      "pull_request_review_id" : 779123140,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/729167321/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1206,
      "start_side" : "RIGHT",
      "updated_at" : "2021-10-14T18:15:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/729167321",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r729170603"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/729170603"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Suggestion, this may be a little more elegant than the boolean shuffle argument (see suggested changes to `NodesSnapshot`)\r\n```suggestion\r\n    const NodesSnapshot snap{*this};\r\n```",
      "commit_id" : "99c1af5a8f95051e98ad4b9486eef70919ab2708",
      "created_at" : "2021-10-14T16:53:01Z",
      "diff_hunk" : "@@ -1498,13 +1494,21 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n+    const NodesSnapshot snap{*this, /*shuffle=*/false};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r729170603",
      "id" : 729170603,
      "line" : 1497,
      "node_id" : "PRRC_kwDOABII584rdkKr",
      "original_commit_id" : "99c1af5a8f95051e98ad4b9486eef70919ab2708",
      "original_line" : 1497,
      "original_position" : 105,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 105,
      "pull_request_review_id" : 779123140,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/729170603/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-14T16:57:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/729170603",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r730243473"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/730243473"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yup, what @jnewbery says makes sense to me as I previously stumbled on the same thing. I'd prefer to review that refactor in a follow-up but am also happy to review here.",
      "commit_id" : "99c1af5a8f95051e98ad4b9486eef70919ab2708",
      "created_at" : "2021-10-16T10:19:27Z",
      "diff_hunk" : "@@ -1498,13 +1494,21 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n+    const NodesSnapshot snap{*this, /*shuffle=*/false};\n+\n     std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(recv_set, send_set, error_set);\n+    SocketEvents(snap.Nodes(), recv_set, send_set, error_set);\n \n     if (interruptNet) return;\n \n     //\n-    // Accept new connections\n+    // Accept new connections. Done after taking a snapshot of the nodes because",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r730243473",
      "id" : 730243473,
      "in_reply_to_id" : 725079584,
      "line" : 1505,
      "node_id" : "PRRC_kwDOABII584rhqGR",
      "original_commit_id" : "99c1af5a8f95051e98ad4b9486eef70919ab2708",
      "original_line" : 1505,
      "original_position" : 115,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 115,
      "pull_request_review_id" : 781348101,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/730243473/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-16T10:19:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/730243473",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "`99c1af5a8f...8589c55e27`: rebase and reorganize `CConnMan::SocketHandler()`, following comments from above: [1](https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632150326) and [2](https://github.com/bitcoin/bitcoin/pull/21943#discussion_r725079584).\r\n\r\nAccepting new connections does not require the snapshot of the existing connected nodes, so make this explicit by accepting new connections after the snapshot has been destroyed, at the end of `CConnMan::SocketHandler()`. Move the pieces of code from `CConnMan::SocketHandler()` that handle existing connections and accept new ones into their own methods and call those methods from `CConnMan::SocketHandler()` to improve the readability.\r\n\r\nInvalidates ACK from @jonatack\r\n\r\nPreviously invalidated ACK from @promag",
      "created_at" : "2021-10-26T08:10:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-951672368",
      "id" : 951672368,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21943",
      "node_id" : "IC_kwDOABII5844uV4w",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/951672368/reactions"
      },
      "updated_at" : "2021-10-26T08:34:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/951672368",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r736268482"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/736268482"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This was changed, see https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-951672368",
      "commit_id" : "8589c55e2777d9fac169cfa52586d67c2a4c42b2",
      "created_at" : "2021-10-26T08:11:16Z",
      "diff_hunk" : "@@ -1467,8 +1467,6 @@ void CConnman::SocketHandler()\n         }\n     }\n \n-    NodesSnapshot snap{*this};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r736268482",
      "id" : 736268482,
      "in_reply_to_id" : 632150326,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584r4pDC",
      "original_commit_id" : "157674ef213e6329215d1b7eb85dacbc23c468db",
      "original_line" : 1470,
      "original_position" : 61,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 789009361,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/736268482/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-26T08:11:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/736268482",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r736278978"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/736278978"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I split the accepting of the new connections into its own method, that is independent of `CConnMan::SocketHandler()`, does its own socket polling and can be called independently from `CConnMan::SocketHandler()`. However after doing that, the following realization dawned on me (tldr: I ditched that):\r\n\r\n:bulb: We don't want to wait separately for incoming connections because that event is \"rare\", meaning most of the time we would just sleep for some time until `poll(2)` times out, signaling no socket is ready for IO (no new incoming connections). This would have an adverse effect on the throughput - even on busy nodes that constantly have incoming/outgoing data, we would needlessly sleep for a short while, frequently.\r\n\r\nSo, we want to `poll(2)` the already connected sockets and the listening ones together, in one `poll(2)` call.\r\n\r\nI made some changes to `CConnMan::SocketHander()` to (hopefully) make it easier to read, see https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-951672368",
      "commit_id" : "8589c55e2777d9fac169cfa52586d67c2a4c42b2",
      "created_at" : "2021-10-26T08:23:44Z",
      "diff_hunk" : "@@ -1498,13 +1494,21 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n+    const NodesSnapshot snap{*this, /*shuffle=*/false};\n+\n     std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(recv_set, send_set, error_set);\n+    SocketEvents(snap.Nodes(), recv_set, send_set, error_set);\n \n     if (interruptNet) return;\n \n     //\n-    // Accept new connections\n+    // Accept new connections. Done after taking a snapshot of the nodes because",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r736278978",
      "id" : 736278978,
      "in_reply_to_id" : 725079584,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584r4rnC",
      "original_commit_id" : "99c1af5a8f95051e98ad4b9486eef70919ab2708",
      "original_line" : 1505,
      "original_position" : 115,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 789024606,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/736278978/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-26T08:23:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/736278978",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r736283980"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/736283980"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This would require an extra call to `Shuffle()` right after construction. I don't see the benefit of it. It would require the snapshot variable to be non-`const`.",
      "commit_id" : "8589c55e2777d9fac169cfa52586d67c2a4c42b2",
      "created_at" : "2021-10-26T08:29:24Z",
      "diff_hunk" : "@@ -1177,6 +1196,44 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot\n+    {\n+    public:\n+        explicit NodesSnapshot(const CConnman& connman, bool shuffle)\n+        {\n+            {\n+                LOCK(connman.cs_vNodes);\n+                m_nodes_copy = connman.vNodes;\n+                for (auto& node : m_nodes_copy) {\n+                    node->AddRef();\n+                }\n+            }\n+            if (shuffle) {\n+                FastRandomContext rng;\n+                Shuffle(m_nodes_copy.begin(), m_nodes_copy.end(), rng);\n+            }\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r736283980",
      "id" : 736283980,
      "in_reply_to_id" : 729167321,
      "line" : 1242,
      "node_id" : "PRRC_kwDOABII584r4s1M",
      "original_commit_id" : "99c1af5a8f95051e98ad4b9486eef70919ab2708",
      "original_line" : 1242,
      "original_position" : 54,
      "original_start_line" : 1206,
      "path" : "src/net.h",
      "position" : 78,
      "pull_request_review_id" : 789031243,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/736283980/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1229,
      "start_side" : "RIGHT",
      "updated_at" : "2021-10-26T08:29:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/736283980",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r736287423"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/736287423"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think it is ok as it is now. We are not frowning upon boolean arguments, are we? If the boolean argument looks too bad, then a 2-value enum can be introduced so call sites look like:\r\n```cpp\r\nconst NodesSnapshot snap{*this, NodesSnapshot::SHUFFLE};\r\n// or\r\nconst NodesSnapshot snap{*this, NodesSnapshot::NO_SHUFFLE};\r\n```\r\nbut I think this would be an overkill.",
      "commit_id" : "8589c55e2777d9fac169cfa52586d67c2a4c42b2",
      "created_at" : "2021-10-26T08:33:30Z",
      "diff_hunk" : "@@ -1498,13 +1494,21 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n+    const NodesSnapshot snap{*this, /*shuffle=*/false};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r736287423",
      "id" : 736287423,
      "in_reply_to_id" : 729170603,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584r4tq_",
      "original_commit_id" : "99c1af5a8f95051e98ad4b9486eef70919ab2708",
      "original_line" : 1497,
      "original_position" : 105,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 789035914,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/736287423/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-26T08:33:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/736287423",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r738379450"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/738379450"
         }
      },
      "author_association" : "MEMBER",
      "body" : "3c8fcb94691584871edaa1a142bfa0ebadc01d67\r\n\r\nI think you can ditch this?",
      "commit_id" : "8589c55e2777d9fac169cfa52586d67c2a4c42b2",
      "created_at" : "2021-10-28T13:16:41Z",
      "diff_hunk" : "@@ -1495,28 +1495,33 @@ void CConnman::SocketEvents(const std::vector<CNode*>& nodes, std::set<SOCKET> &\n \n void CConnman::SocketHandler()\n {\n-    const NodesSnapshot snap{*this, /*shuffle=*/false};\n+    std::set<SOCKET> recv_set;\n+    std::set<SOCKET> send_set;\n+    std::set<SOCKET> error_set;\n \n-    std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(snap.Nodes(), recv_set, send_set, error_set);\n+    {\n+        const NodesSnapshot snap{*this, /*shuffle=*/false};\n \n-    if (interruptNet) return;\n+        // Check for readiness the already connected sockets and the listening sockets\n+        // in one call. If none is ready, wait for a short while and return empty sets.\n+        SocketEvents(snap.Nodes(), recv_set, send_set, error_set);\n \n-    //\n-    // Accept new connections\n-    //\n-    for (const ListenSocket& hListenSocket : vhListenSocket)\n-    {\n-        if (hListenSocket.socket != INVALID_SOCKET && recv_set.count(hListenSocket.socket) > 0)\n-        {\n-            AcceptConnection(hListenSocket);\n+        if (interruptNet) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r738379450",
      "id" : 738379450,
      "line" : 1507,
      "node_id" : "PRRC_kwDOABII584sAsa6",
      "original_commit_id" : "3c8fcb94691584871edaa1a142bfa0ebadc01d67",
      "original_line" : 1509,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 127,
      "pull_request_review_id" : 791851693,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/738379450/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-28T13:21:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/738379450",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r746951383"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/746951383"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think with the named argument this is fine.",
      "commit_id" : "8589c55e2777d9fac169cfa52586d67c2a4c42b2",
      "created_at" : "2021-11-10T20:12:51Z",
      "diff_hunk" : "@@ -1498,13 +1494,21 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n+    const NodesSnapshot snap{*this, /*shuffle=*/false};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r746951383",
      "id" : 746951383,
      "in_reply_to_id" : 729170603,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584shZLX",
      "original_commit_id" : "99c1af5a8f95051e98ad4b9486eef70919ab2708",
      "original_line" : 1497,
      "original_position" : 105,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 803098736,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/746951383/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-10T20:12:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/746951383",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r747639993"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/747639993"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "You are right - the surrounding `SocketEvents()` and `SocketHandlerConnected()` both contain a similar check and would quit \"quickly\" if `interruptNet` becomes true.\r\n\r\nMaybe the newly added `SocketHandlerListening()` deserves such a check too, once per each listening socket to be processed?",
      "commit_id" : "8589c55e2777d9fac169cfa52586d67c2a4c42b2",
      "created_at" : "2021-11-11T16:21:32Z",
      "diff_hunk" : "@@ -1495,28 +1495,33 @@ void CConnman::SocketEvents(const std::vector<CNode*>& nodes, std::set<SOCKET> &\n \n void CConnman::SocketHandler()\n {\n-    const NodesSnapshot snap{*this, /*shuffle=*/false};\n+    std::set<SOCKET> recv_set;\n+    std::set<SOCKET> send_set;\n+    std::set<SOCKET> error_set;\n \n-    std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(snap.Nodes(), recv_set, send_set, error_set);\n+    {\n+        const NodesSnapshot snap{*this, /*shuffle=*/false};\n \n-    if (interruptNet) return;\n+        // Check for readiness the already connected sockets and the listening sockets\n+        // in one call. If none is ready, wait for a short while and return empty sets.\n+        SocketEvents(snap.Nodes(), recv_set, send_set, error_set);\n \n-    //\n-    // Accept new connections\n-    //\n-    for (const ListenSocket& hListenSocket : vhListenSocket)\n-    {\n-        if (hListenSocket.socket != INVALID_SOCKET && recv_set.count(hListenSocket.socket) > 0)\n-        {\n-            AcceptConnection(hListenSocket);\n+        if (interruptNet) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r747639993",
      "id" : 747639993,
      "in_reply_to_id" : 738379450,
      "line" : 1507,
      "node_id" : "PRRC_kwDOABII584skBS5",
      "original_commit_id" : "3c8fcb94691584871edaa1a142bfa0ebadc01d67",
      "original_line" : 1509,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 127,
      "pull_request_review_id" : 803984837,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/747639993/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-11T16:21:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/747639993",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r747642620"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/747642620"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, doesn't hurt I guess.",
      "commit_id" : "8589c55e2777d9fac169cfa52586d67c2a4c42b2",
      "created_at" : "2021-11-11T16:24:54Z",
      "diff_hunk" : "@@ -1495,28 +1495,33 @@ void CConnman::SocketEvents(const std::vector<CNode*>& nodes, std::set<SOCKET> &\n \n void CConnman::SocketHandler()\n {\n-    const NodesSnapshot snap{*this, /*shuffle=*/false};\n+    std::set<SOCKET> recv_set;\n+    std::set<SOCKET> send_set;\n+    std::set<SOCKET> error_set;\n \n-    std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(snap.Nodes(), recv_set, send_set, error_set);\n+    {\n+        const NodesSnapshot snap{*this, /*shuffle=*/false};\n \n-    if (interruptNet) return;\n+        // Check for readiness the already connected sockets and the listening sockets\n+        // in one call. If none is ready, wait for a short while and return empty sets.\n+        SocketEvents(snap.Nodes(), recv_set, send_set, error_set);\n \n-    //\n-    // Accept new connections\n-    //\n-    for (const ListenSocket& hListenSocket : vhListenSocket)\n-    {\n-        if (hListenSocket.socket != INVALID_SOCKET && recv_set.count(hListenSocket.socket) > 0)\n-        {\n-            AcceptConnection(hListenSocket);\n+        if (interruptNet) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r747642620",
      "id" : 747642620,
      "in_reply_to_id" : 738379450,
      "line" : 1507,
      "node_id" : "PRRC_kwDOABII584skB78",
      "original_commit_id" : "3c8fcb94691584871edaa1a142bfa0ebadc01d67",
      "original_line" : 1509,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 127,
      "pull_request_review_id" : 803988240,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/747642620/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-11T16:24:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/747642620",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "`8589c55e27...db0a01e0d1`: remove unnecessary `interruptNet` check from `SocketEvents()`, add such a check to `SocketHandlerListening()`. Thanks, @promag, https://github.com/bitcoin/bitcoin/pull/21943#discussion_r738379450 !\r\n\r\nInvalidates ACK from @promag \r\n\r\nPreviously invalidated ACK from @jonatack ",
      "created_at" : "2021-11-12T09:54:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-966969216",
      "id" : 966969216,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21943",
      "node_id" : "IC_kwDOABII5845oseA",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/966969216/reactions"
      },
      "updated_at" : "2021-11-12T09:54:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/966969216",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r748117765"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/748117765"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done.",
      "commit_id" : "db0a01e0d1ab4462b70a44c255c602ea074b96ef",
      "created_at" : "2021-11-12T09:54:27Z",
      "diff_hunk" : "@@ -1495,28 +1495,33 @@ void CConnman::SocketEvents(const std::vector<CNode*>& nodes, std::set<SOCKET> &\n \n void CConnman::SocketHandler()\n {\n-    const NodesSnapshot snap{*this, /*shuffle=*/false};\n+    std::set<SOCKET> recv_set;\n+    std::set<SOCKET> send_set;\n+    std::set<SOCKET> error_set;\n \n-    std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(snap.Nodes(), recv_set, send_set, error_set);\n+    {\n+        const NodesSnapshot snap{*this, /*shuffle=*/false};\n \n-    if (interruptNet) return;\n+        // Check for readiness the already connected sockets and the listening sockets\n+        // in one call. If none is ready, wait for a short while and return empty sets.\n+        SocketEvents(snap.Nodes(), recv_set, send_set, error_set);\n \n-    //\n-    // Accept new connections\n-    //\n-    for (const ListenSocket& hListenSocket : vhListenSocket)\n-    {\n-        if (hListenSocket.socket != INVALID_SOCKET && recv_set.count(hListenSocket.socket) > 0)\n-        {\n-            AcceptConnection(hListenSocket);\n+        if (interruptNet) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r748117765",
      "id" : 748117765,
      "in_reply_to_id" : 738379450,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584sl18F",
      "original_commit_id" : "3c8fcb94691584871edaa1a142bfa0ebadc01d67",
      "original_line" : 1509,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 804595561,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/748117765/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-12T09:54:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/748117765",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r748339454"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/748339454"
         }
      },
      "author_association" : "MEMBER",
      "body" : "4097d14 `s/readiness/the readiness of/` ? Perhaps also clarify \"ready\". Also `s/none is/none are/`.",
      "commit_id" : "f52b6b2d9f482353821da0ef4c485c402a396c8d",
      "created_at" : "2021-11-12T14:40:58Z",
      "diff_hunk" : "@@ -1497,34 +1493,29 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n-    std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(recv_set, send_set, error_set);\n-\n-    if (interruptNet) return;\n+    std::set<SOCKET> recv_set;\n+    std::set<SOCKET> send_set;\n+    std::set<SOCKET> error_set;\n \n-    //\n-    // Accept new connections\n-    //\n-    for (const ListenSocket& hListenSocket : vhListenSocket)\n     {\n-        if (hListenSocket.socket != INVALID_SOCKET && recv_set.count(hListenSocket.socket) > 0)\n-        {\n-            AcceptConnection(hListenSocket);\n-        }\n-    }\n+        const NodesSnapshot snap{*this, /*shuffle=*/false};\n \n-    //\n-    // Service each socket\n-    //\n-    std::vector<CNode*> vNodesCopy;\n-    {\n-        LOCK(cs_vNodes);\n-        vNodesCopy = vNodes;\n-        for (CNode* pnode : vNodesCopy)\n-            pnode->AddRef();\n+        // Check for readiness the already connected sockets and the listening sockets",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r748339454",
      "id" : 748339454,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584smsD-",
      "original_commit_id" : "db0a01e0d1ab4462b70a44c255c602ea074b96ef",
      "original_line" : 1503,
      "original_position" : 134,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 804875630,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/748339454/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-17T12:44:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/748339454",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r748343811"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/748343811"
         }
      },
      "author_association" : "MEMBER",
      "body" : "9ca6dac0 naming nit: \"snap\" is a verb similar to \"break\"; if you retouch, `s/snap/snapshot/` would be clearer",
      "commit_id" : "f52b6b2d9f482353821da0ef4c485c402a396c8d",
      "created_at" : "2021-11-12T14:46:37Z",
      "diff_hunk" : "@@ -1497,34 +1493,29 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n-    std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(recv_set, send_set, error_set);\n-\n-    if (interruptNet) return;\n+    std::set<SOCKET> recv_set;\n+    std::set<SOCKET> send_set;\n+    std::set<SOCKET> error_set;\n \n-    //\n-    // Accept new connections\n-    //\n-    for (const ListenSocket& hListenSocket : vhListenSocket)\n     {\n-        if (hListenSocket.socket != INVALID_SOCKET && recv_set.count(hListenSocket.socket) > 0)\n-        {\n-            AcceptConnection(hListenSocket);\n-        }\n-    }\n+        const NodesSnapshot snap{*this, /*shuffle=*/false};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r748343811",
      "id" : 748343811,
      "line" : 1510,
      "node_id" : "PRRC_kwDOABII584smtID",
      "original_commit_id" : "db0a01e0d1ab4462b70a44c255c602ea074b96ef",
      "original_line" : 1510,
      "original_position" : 123,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 132,
      "pull_request_review_id" : 804875630,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/748343811/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-17T12:44:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/748343811",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r751165699"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/751165699"
         }
      },
      "author_association" : "MEMBER",
      "body" : "9ca6dac0 can omit localvar `rng`\r\n```diff\r\n             if (shuffle) {\r\n-                FastRandomContext rng;\r\n-                Shuffle(m_nodes_copy.begin(), m_nodes_copy.end(), rng);\r\n+                Shuffle(m_nodes_copy.begin(), m_nodes_copy.end(), FastRandomContext());\r\n             }\r\n```\r\n",
      "commit_id" : "f52b6b2d9f482353821da0ef4c485c402a396c8d",
      "created_at" : "2021-11-17T11:50:21Z",
      "diff_hunk" : "@@ -1177,6 +1219,44 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot\n+    {\n+    public:\n+        explicit NodesSnapshot(const CConnman& connman, bool shuffle)\n+        {\n+            {\n+                LOCK(connman.cs_vNodes);\n+                m_nodes_copy = connman.vNodes;\n+                for (auto& node : m_nodes_copy) {\n+                    node->AddRef();\n+                }\n+            }\n+            if (shuffle) {\n+                FastRandomContext rng;\n+                Shuffle(m_nodes_copy.begin(), m_nodes_copy.end(), rng);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r751165699",
      "id" : 751165699,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584sxeED",
      "original_commit_id" : "db0a01e0d1ab4462b70a44c255c602ea074b96ef",
      "original_line" : 1240,
      "original_position" : 76,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 804875630,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/751165699/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-17T12:44:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/751165699",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r751179588"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/751179588"
         }
      },
      "author_association" : "MEMBER",
      "body" : "4097d14 unneeded style change, would leave as-is (and as currently exists in both of the `SocketEvents()` functions)\r\n```diff\r\n-    std::set<SOCKET> recv_set;\r\n-    std::set<SOCKET> send_set;\r\n-    std::set<SOCKET> error_set;\r\n-\r\n+    std::set<SOCKET> recv_set, send_set, error_set;\r\n```\r\n",
      "commit_id" : "f52b6b2d9f482353821da0ef4c485c402a396c8d",
      "created_at" : "2021-11-17T12:10:10Z",
      "diff_hunk" : "@@ -1497,34 +1493,29 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n-    std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(recv_set, send_set, error_set);\n-\n-    if (interruptNet) return;\n+    std::set<SOCKET> recv_set;\n+    std::set<SOCKET> send_set;\n+    std::set<SOCKET> error_set;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r751179588",
      "id" : 751179588,
      "line" : 1507,
      "node_id" : "PRRC_kwDOABII584sxhdE",
      "original_commit_id" : "db0a01e0d1ab4462b70a44c255c602ea074b96ef",
      "original_line" : 1507,
      "original_position" : 111,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 120,
      "pull_request_review_id" : 804875630,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/751179588/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-17T12:44:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/751179588",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r751190044"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/751190044"
         }
      },
      "author_association" : "MEMBER",
      "body" : "4097d14 found these comments helpful, would keep\r\n```diff\r\n+        // Service each socket\r\n         SocketHandlerConnected(snap.Nodes(), recv_set, send_set, error_set);\r\n     }\r\n \r\n+    // Accept new connections\r\n     SocketHandlerListening(recv_set);\r\n```\r\n",
      "commit_id" : "f52b6b2d9f482353821da0ef4c485c402a396c8d",
      "created_at" : "2021-11-17T12:24:40Z",
      "diff_hunk" : "@@ -1497,34 +1493,29 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n-    std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(recv_set, send_set, error_set);\n-\n-    if (interruptNet) return;\n+    std::set<SOCKET> recv_set;\n+    std::set<SOCKET> send_set;\n+    std::set<SOCKET> error_set;\n \n-    //\n-    // Accept new connections\n-    //\n-    for (const ListenSocket& hListenSocket : vhListenSocket)\n     {\n-        if (hListenSocket.socket != INVALID_SOCKET && recv_set.count(hListenSocket.socket) > 0)\n-        {\n-            AcceptConnection(hListenSocket);\n-        }\n-    }\n+        const NodesSnapshot snap{*this, /*shuffle=*/false};\n \n-    //\n-    // Service each socket\n-    //\n-    std::vector<CNode*> vNodesCopy;\n-    {\n-        LOCK(cs_vNodes);\n-        vNodesCopy = vNodes;\n-        for (CNode* pnode : vNodesCopy)\n-            pnode->AddRef();\n+        // Check for readiness the already connected sockets and the listening sockets\n+        // in one call. If none is ready, wait for a short while and return empty sets.\n+        SocketEvents(snap.Nodes(), recv_set, send_set, error_set);\n+\n+        SocketHandlerConnected(snap.Nodes(), recv_set, send_set, error_set);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r751190044",
      "id" : 751190044,
      "line" : 1519,
      "node_id" : "PRRC_kwDOABII584sxkAc",
      "original_commit_id" : "db0a01e0d1ab4462b70a44c255c602ea074b96ef",
      "original_line" : 1519,
      "original_position" : 138,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 150,
      "pull_request_review_id" : 804875630,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/751190044/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-17T12:44:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/751190044",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r751192944"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/751192944"
         }
      },
      "author_association" : "MEMBER",
      "body" : "4097d14 the existing \"Accept incoming connections\" comment is an easier-to-understand description for me than this one. \r\n\r\nMaybe:\r\n```suggestion\r\n     * Accept incoming connections, i.e. one from each read-ready listening socket.\r\n```",
      "commit_id" : "f52b6b2d9f482353821da0ef4c485c402a396c8d",
      "created_at" : "2021-11-17T12:28:39Z",
      "diff_hunk" : "@@ -983,9 +983,51 @@ class CConnman\n     void NotifyNumConnectionsChanged();\n     /** Return true if the peer is inactive and should be disconnected. */\n     bool InactivityCheck(const CNode& node) const;\n-    bool GenerateSelectSet(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set);\n-    void SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set);\n+\n+    /**\n+     * Generate a collection of sockets to check for IO readiness.\n+     * @param[in] nodes Select from these nodes' sockets.\n+     * @param[out] recv_set Sockets to check for read readiness.\n+     * @param[out] send_set Sockets to check for write readiness.\n+     * @param[out] error_set Sockets to check for errors.\n+     * @return true if at least one socket is to be checked (the returned set is not empty)\n+     */\n+    bool GenerateSelectSet(const std::vector<CNode*>& nodes, std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set);\n+\n+    /**\n+     * Check which sockets are ready for IO.\n+     * @param[in] nodes Select from these nodes' sockets.\n+     * @param[out] recv_set Sockets which are ready for read.\n+     * @param[out] send_set Sockets which are ready for write.\n+     * @param[out] error_set Sockets which have errors.\n+     * This calls `GenerateSelectSet()` to gather a list of sockets to check.\n+     */\n+    void SocketEvents(const std::vector<CNode*>& nodes, std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set);\n+\n+    /**\n+     * Check connected and listening sockets for IO readiness and process them accordingly.\n+     */\n     void SocketHandler();\n+\n+    /**\n+     * Do the read/write for connected sockets that are ready for IO.\n+     * @param[in] nodes Nodes to process. The socket of each node is checked against\n+     * `recv_set`, `send_set` and `error_set`.\n+     * @param[in] recv_set Sockets that are ready for read.\n+     * @param[in] send_set Sockets that are ready for send.\n+     * @param[in] error_set Sockets that have an exceptional condition (error).\n+     */\n+    void SocketHandlerConnected(const std::vector<CNode*>& nodes,\n+                                const std::set<SOCKET>& recv_set,\n+                                const std::set<SOCKET>& send_set,\n+                                const std::set<SOCKET>& error_set);\n+\n+    /**\n+     * Accept an incoming connection from listening sockets that are ready for read.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r751192944",
      "id" : 751192944,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584sxktw",
      "original_commit_id" : "db0a01e0d1ab4462b70a44c255c602ea074b96ef",
      "original_line" : 1026,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 804875630,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/751192944/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-17T12:44:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/751192944",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "`db0a01e0d1...f52b6b2d9f`: pick nits\r\n\r\nInvalidates ACK from @promag\r\n\r\nPreviously invalidated ACK from @jonatack",
      "created_at" : "2021-11-18T12:41:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-972830829",
      "id" : 972830829,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21943",
      "node_id" : "IC_kwDOABII5845_Dht",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/972830829/reactions"
      },
      "updated_at" : "2021-11-18T12:51:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/972830829",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r752203361"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752203361"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done.",
      "commit_id" : "f52b6b2d9f482353821da0ef4c485c402a396c8d",
      "created_at" : "2021-11-18T12:41:58Z",
      "diff_hunk" : "@@ -983,9 +983,51 @@ class CConnman\n     void NotifyNumConnectionsChanged();\n     /** Return true if the peer is inactive and should be disconnected. */\n     bool InactivityCheck(const CNode& node) const;\n-    bool GenerateSelectSet(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set);\n-    void SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set);\n+\n+    /**\n+     * Generate a collection of sockets to check for IO readiness.\n+     * @param[in] nodes Select from these nodes' sockets.\n+     * @param[out] recv_set Sockets to check for read readiness.\n+     * @param[out] send_set Sockets to check for write readiness.\n+     * @param[out] error_set Sockets to check for errors.\n+     * @return true if at least one socket is to be checked (the returned set is not empty)\n+     */\n+    bool GenerateSelectSet(const std::vector<CNode*>& nodes, std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set);\n+\n+    /**\n+     * Check which sockets are ready for IO.\n+     * @param[in] nodes Select from these nodes' sockets.\n+     * @param[out] recv_set Sockets which are ready for read.\n+     * @param[out] send_set Sockets which are ready for write.\n+     * @param[out] error_set Sockets which have errors.\n+     * This calls `GenerateSelectSet()` to gather a list of sockets to check.\n+     */\n+    void SocketEvents(const std::vector<CNode*>& nodes, std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set);\n+\n+    /**\n+     * Check connected and listening sockets for IO readiness and process them accordingly.\n+     */\n     void SocketHandler();\n+\n+    /**\n+     * Do the read/write for connected sockets that are ready for IO.\n+     * @param[in] nodes Nodes to process. The socket of each node is checked against\n+     * `recv_set`, `send_set` and `error_set`.\n+     * @param[in] recv_set Sockets that are ready for read.\n+     * @param[in] send_set Sockets that are ready for send.\n+     * @param[in] error_set Sockets that have an exceptional condition (error).\n+     */\n+    void SocketHandlerConnected(const std::vector<CNode*>& nodes,\n+                                const std::set<SOCKET>& recv_set,\n+                                const std::set<SOCKET>& send_set,\n+                                const std::set<SOCKET>& error_set);\n+\n+    /**\n+     * Accept an incoming connection from listening sockets that are ready for read.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r752203361",
      "id" : 752203361,
      "in_reply_to_id" : 751192944,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584s1bZh",
      "original_commit_id" : "db0a01e0d1ab4462b70a44c255c602ea074b96ef",
      "original_line" : 1026,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 809869717,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752203361/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-18T12:41:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752203361",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r752203519"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752203519"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done.",
      "commit_id" : "f52b6b2d9f482353821da0ef4c485c402a396c8d",
      "created_at" : "2021-11-18T12:42:09Z",
      "diff_hunk" : "@@ -1497,34 +1493,29 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n-    std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(recv_set, send_set, error_set);\n-\n-    if (interruptNet) return;\n+    std::set<SOCKET> recv_set;\n+    std::set<SOCKET> send_set;\n+    std::set<SOCKET> error_set;\n \n-    //\n-    // Accept new connections\n-    //\n-    for (const ListenSocket& hListenSocket : vhListenSocket)\n     {\n-        if (hListenSocket.socket != INVALID_SOCKET && recv_set.count(hListenSocket.socket) > 0)\n-        {\n-            AcceptConnection(hListenSocket);\n-        }\n-    }\n+        const NodesSnapshot snap{*this, /*shuffle=*/false};\n \n-    //\n-    // Service each socket\n-    //\n-    std::vector<CNode*> vNodesCopy;\n-    {\n-        LOCK(cs_vNodes);\n-        vNodesCopy = vNodes;\n-        for (CNode* pnode : vNodesCopy)\n-            pnode->AddRef();\n+        // Check for readiness the already connected sockets and the listening sockets\n+        // in one call. If none is ready, wait for a short while and return empty sets.\n+        SocketEvents(snap.Nodes(), recv_set, send_set, error_set);\n+\n+        SocketHandlerConnected(snap.Nodes(), recv_set, send_set, error_set);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r752203519",
      "id" : 752203519,
      "in_reply_to_id" : 751190044,
      "line" : 1519,
      "node_id" : "PRRC_kwDOABII584s1bb_",
      "original_commit_id" : "db0a01e0d1ab4462b70a44c255c602ea074b96ef",
      "original_line" : 1519,
      "original_position" : 138,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 150,
      "pull_request_review_id" : 809869935,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752203519/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-18T12:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752203519",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r752205516"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752205516"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think it is good to always declare one variable per line.",
      "commit_id" : "f52b6b2d9f482353821da0ef4c485c402a396c8d",
      "created_at" : "2021-11-18T12:44:55Z",
      "diff_hunk" : "@@ -1497,34 +1493,29 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n-    std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(recv_set, send_set, error_set);\n-\n-    if (interruptNet) return;\n+    std::set<SOCKET> recv_set;\n+    std::set<SOCKET> send_set;\n+    std::set<SOCKET> error_set;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r752205516",
      "id" : 752205516,
      "in_reply_to_id" : 751179588,
      "line" : 1507,
      "node_id" : "PRRC_kwDOABII584s1b7M",
      "original_commit_id" : "db0a01e0d1ab4462b70a44c255c602ea074b96ef",
      "original_line" : 1507,
      "original_position" : 111,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 120,
      "pull_request_review_id" : 809872731,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752205516/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-18T12:44:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752205516",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r752205608"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752205608"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done.",
      "commit_id" : "f52b6b2d9f482353821da0ef4c485c402a396c8d",
      "created_at" : "2021-11-18T12:45:04Z",
      "diff_hunk" : "@@ -1177,6 +1219,44 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot\n+    {\n+    public:\n+        explicit NodesSnapshot(const CConnman& connman, bool shuffle)\n+        {\n+            {\n+                LOCK(connman.cs_vNodes);\n+                m_nodes_copy = connman.vNodes;\n+                for (auto& node : m_nodes_copy) {\n+                    node->AddRef();\n+                }\n+            }\n+            if (shuffle) {\n+                FastRandomContext rng;\n+                Shuffle(m_nodes_copy.begin(), m_nodes_copy.end(), rng);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r752205608",
      "id" : 752205608,
      "in_reply_to_id" : 751165699,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584s1b8o",
      "original_commit_id" : "db0a01e0d1ab4462b70a44c255c602ea074b96ef",
      "original_line" : 1240,
      "original_position" : 76,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 809872873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752205608/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-18T12:45:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752205608",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r752207151"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752207151"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`snap` is used as a short for `snapshot`, not in the \"verb\" sense. I have seen this elsewhere too. For example `zfs list -t snapshot` and `zfs list -t snap` both do the same thing.",
      "commit_id" : "f52b6b2d9f482353821da0ef4c485c402a396c8d",
      "created_at" : "2021-11-18T12:47:09Z",
      "diff_hunk" : "@@ -1497,34 +1493,29 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n-    std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(recv_set, send_set, error_set);\n-\n-    if (interruptNet) return;\n+    std::set<SOCKET> recv_set;\n+    std::set<SOCKET> send_set;\n+    std::set<SOCKET> error_set;\n \n-    //\n-    // Accept new connections\n-    //\n-    for (const ListenSocket& hListenSocket : vhListenSocket)\n     {\n-        if (hListenSocket.socket != INVALID_SOCKET && recv_set.count(hListenSocket.socket) > 0)\n-        {\n-            AcceptConnection(hListenSocket);\n-        }\n-    }\n+        const NodesSnapshot snap{*this, /*shuffle=*/false};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r752207151",
      "id" : 752207151,
      "in_reply_to_id" : 748343811,
      "line" : 1510,
      "node_id" : "PRRC_kwDOABII584s1cUv",
      "original_commit_id" : "db0a01e0d1ab4462b70a44c255c602ea074b96ef",
      "original_line" : 1510,
      "original_position" : 123,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 132,
      "pull_request_review_id" : 809874982,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752207151/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-18T12:47:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752207151",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r752207254"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752207254"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done.",
      "commit_id" : "f52b6b2d9f482353821da0ef4c485c402a396c8d",
      "created_at" : "2021-11-18T12:47:19Z",
      "diff_hunk" : "@@ -1497,34 +1493,29 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n-    std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(recv_set, send_set, error_set);\n-\n-    if (interruptNet) return;\n+    std::set<SOCKET> recv_set;\n+    std::set<SOCKET> send_set;\n+    std::set<SOCKET> error_set;\n \n-    //\n-    // Accept new connections\n-    //\n-    for (const ListenSocket& hListenSocket : vhListenSocket)\n     {\n-        if (hListenSocket.socket != INVALID_SOCKET && recv_set.count(hListenSocket.socket) > 0)\n-        {\n-            AcceptConnection(hListenSocket);\n-        }\n-    }\n+        const NodesSnapshot snap{*this, /*shuffle=*/false};\n \n-    //\n-    // Service each socket\n-    //\n-    std::vector<CNode*> vNodesCopy;\n-    {\n-        LOCK(cs_vNodes);\n-        vNodesCopy = vNodes;\n-        for (CNode* pnode : vNodesCopy)\n-            pnode->AddRef();\n+        // Check for readiness the already connected sockets and the listening sockets",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r752207254",
      "id" : 752207254,
      "in_reply_to_id" : 748339454,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584s1cWW",
      "original_commit_id" : "db0a01e0d1ab4462b70a44c255c602ea074b96ef",
      "original_line" : 1503,
      "original_position" : 134,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 809875138,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752207254/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-18T12:47:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752207254",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r752209237"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752209237"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Sometimes reviewers ask for minimal changes, without combining \"real\" changes with whitespace ones. So I refrained from running `clang-format` on this line. Done now.",
      "commit_id" : "f52b6b2d9f482353821da0ef4c485c402a396c8d",
      "created_at" : "2021-11-18T12:50:03Z",
      "diff_hunk" : "@@ -1332,57 +1332,53 @@ bool CConnman::InactivityCheck(const CNode& node) const\n     return false;\n }\n \n-bool CConnman::GenerateSelectSet(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set)\n+bool CConnman::GenerateSelectSet(const std::vector<CNode*>& nodes, std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r752209237",
      "id" : 752209237,
      "in_reply_to_id" : 728473929,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584s1c1V",
      "original_commit_id" : "99c1af5a8f95051e98ad4b9486eef70919ab2708",
      "original_line" : 1334,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 809877988,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752209237/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-18T12:50:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752209237",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r753523180"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753523180"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I guess it's just me, but I still don't like this boolean (but I do agree with you that it's better than an `enum`). In general, I dislike making a decision at run time (in this case, the constructor evaluating the `shuffle` argument) that is actually being decided at compile (in this case, all the callers pass a constant bool for this argument), if possible (sometimes it's not).\r\n\r\nWhat do you think about always shuffling? Just make that part of the semantics of this object? Could there ever be any harm (other than a very slight performance hit)?",
      "commit_id" : "f52b6b2d9f482353821da0ef4c485c402a396c8d",
      "created_at" : "2021-11-19T20:48:49Z",
      "diff_hunk" : "@@ -1513,18 +1513,12 @@ void CConnman::SocketHandler()\n         }\n     }\n \n+    const NodesSnapshot snap{*this, /*shuffle=*/false};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r753523180",
      "id" : 753523180,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584s6dns",
      "original_commit_id" : "75e8bf55f5a014faada7712a9640dc35e8c86f15",
      "original_line" : 1516,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 811664007,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753523180/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-19T21:26:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753523180",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r753539733"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753539733"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Consider:\r\n```cpp\r\nstruct SocketSets {\r\n    std::set<SOCKET> recv;\r\n    std::set<SOCKET> send;\r\n    std::set<SOCKET> error;\r\n}\r\n```",
      "commit_id" : "f52b6b2d9f482353821da0ef4c485c402a396c8d",
      "created_at" : "2021-11-19T21:22:21Z",
      "diff_hunk" : "@@ -1497,34 +1493,29 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n-    std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(recv_set, send_set, error_set);\n-\n-    if (interruptNet) return;\n+    std::set<SOCKET> recv_set;\n+    std::set<SOCKET> send_set;\n+    std::set<SOCKET> error_set;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r753539733",
      "id" : 753539733,
      "in_reply_to_id" : 751179588,
      "line" : 1507,
      "node_id" : "PRRC_kwDOABII584s6hqV",
      "original_commit_id" : "db0a01e0d1ab4462b70a44c255c602ea074b96ef",
      "original_line" : 1507,
      "original_position" : 111,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 120,
      "pull_request_review_id" : 811664007,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753539733/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-19T21:26:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753539733",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r755105857"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/755105857"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "@LarryRuane, something like this is coming as a subsequent change from https://github.com/bitcoin/bitcoin/pull/21878 (see commit `net: introduce Sock::WaitMany()` and the structures `WaitEvents` and `WaitData` introduced in that commit).\r\n\r\nThe current combination of sets stores the sockets in \"one pile of sockets that are ready for read\" and \"one pile of sockets that are ready for write\" (notice that a given socket may be in both). It is more convenient to have just one pile of sockets each one with attached ready-for-read and ready-for-write flags.",
      "commit_id" : "f52b6b2d9f482353821da0ef4c485c402a396c8d",
      "created_at" : "2021-11-23T13:08:25Z",
      "diff_hunk" : "@@ -1497,34 +1493,29 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n-    std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(recv_set, send_set, error_set);\n-\n-    if (interruptNet) return;\n+    std::set<SOCKET> recv_set;\n+    std::set<SOCKET> send_set;\n+    std::set<SOCKET> error_set;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r755105857",
      "id" : 755105857,
      "in_reply_to_id" : 751179588,
      "line" : 1507,
      "node_id" : "PRRC_kwDOABII584tAgBB",
      "original_commit_id" : "db0a01e0d1ab4462b70a44c255c602ea074b96ef",
      "original_line" : 1507,
      "original_position" : 111,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 120,
      "pull_request_review_id" : 813634796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/755105857/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-23T13:08:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/755105857",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r755114947"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/755114947"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> What do you think about always shuffling?\r\n\r\nI do not have a strong opinion. My main point with the current code is to preserve behavior - it was not shuffled before, it will not be shuffled with this PR. This PR has a different purpose.\r\n\r\nIn general, I try to avoid such unnecessary behavioral changes. _They may have very subtle effects._\r\n\r\nMaybe it is ok to always shuffle and remove the boolean argument from the `NodesSnapshot` constructor? What do other reviewers think?",
      "commit_id" : "f52b6b2d9f482353821da0ef4c485c402a396c8d",
      "created_at" : "2021-11-23T13:19:48Z",
      "diff_hunk" : "@@ -1513,18 +1513,12 @@ void CConnman::SocketHandler()\n         }\n     }\n \n+    const NodesSnapshot snap{*this, /*shuffle=*/false};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r755114947",
      "id" : 755114947,
      "in_reply_to_id" : 753523180,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584tAiPD",
      "original_commit_id" : "75e8bf55f5a014faada7712a9640dc35e8c86f15",
      "original_line" : 1516,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 813647737,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/755114947/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-23T13:19:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/755114947",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r755390067"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/755390067"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Slight preference to keep behavior here and simplify in a follow-up.",
      "commit_id" : "f52b6b2d9f482353821da0ef4c485c402a396c8d",
      "created_at" : "2021-11-23T18:09:16Z",
      "diff_hunk" : "@@ -1513,18 +1513,12 @@ void CConnman::SocketHandler()\n         }\n     }\n \n+    const NodesSnapshot snap{*this, /*shuffle=*/false};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r755390067",
      "id" : 755390067,
      "in_reply_to_id" : 753523180,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584tBlZz",
      "original_commit_id" : "75e8bf55f5a014faada7712a9640dc35e8c86f15",
      "original_line" : 1516,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 814021503,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/755390067/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-23T18:09:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/755390067",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK  f52b6b2d9f482353821da0ef4c485c402a396c8d changes since last review are reordered commits, removing an unneeded local variable, and code formatting and documentation improvements ",
      "created_at" : "2021-11-23T21:55:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-977201905",
      "id" : 977201905,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21943",
      "node_id" : "IC_kwDOABII5846Purx",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/977201905/reactions"
      },
      "updated_at" : "2021-11-23T21:56:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/977201905",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r756202735"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/756202735"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I like the idea of abstracting this but it seems out of scope of this PR.\r\n\r\n> It is more convenient to have just one pile of sockets each one with attached ready-for-read and ready-for-write flags.\r\n\r\nEventually it depends on the selection mechanism used isn't it? When it's abstracted, might as well store it in a format ready to feed to say, `poll()` or `select()` whatever is used.",
      "commit_id" : "f52b6b2d9f482353821da0ef4c485c402a396c8d",
      "created_at" : "2021-11-24T15:43:31Z",
      "diff_hunk" : "@@ -1497,34 +1493,29 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n-    std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(recv_set, send_set, error_set);\n-\n-    if (interruptNet) return;\n+    std::set<SOCKET> recv_set;\n+    std::set<SOCKET> send_set;\n+    std::set<SOCKET> error_set;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r756202735",
      "id" : 756202735,
      "in_reply_to_id" : 751179588,
      "line" : 1507,
      "node_id" : "PRRC_kwDOABII584tErzv",
      "original_commit_id" : "db0a01e0d1ab4462b70a44c255c602ea074b96ef",
      "original_line" : 1507,
      "original_position" : 111,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 120,
      "pull_request_review_id" : 815081452,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/756202735/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-24T15:43:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/756202735",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r756226265"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/756226265"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes, those 3 sets are dragged around as parameters to functions and as local variables. It is an obvious improvement to pack them together somehow. Not the purpose of this PR. Once this is PR is merged I will chop off another piece from #21878 into a smaller/manageable PR that will contain the commit which introduces such a packing `net: introduce Sock::WaitMany()`. We can discuss it there, I don't have a strong opinion on how they are packed exactly. Or if this PR is stuck we can move the discussion to #21878 where `WaitData` is introduced.",
      "commit_id" : "f52b6b2d9f482353821da0ef4c485c402a396c8d",
      "created_at" : "2021-11-24T16:06:25Z",
      "diff_hunk" : "@@ -1497,34 +1493,29 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n-    std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(recv_set, send_set, error_set);\n-\n-    if (interruptNet) return;\n+    std::set<SOCKET> recv_set;\n+    std::set<SOCKET> send_set;\n+    std::set<SOCKET> error_set;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r756226265",
      "id" : 756226265,
      "in_reply_to_id" : 751179588,
      "line" : 1507,
      "node_id" : "PRRC_kwDOABII584tExjZ",
      "original_commit_id" : "db0a01e0d1ab4462b70a44c255c602ea074b96ef",
      "original_line" : 1507,
      "original_position" : 111,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 120,
      "pull_request_review_id" : 815110132,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/756226265/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-24T16:06:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/756226265",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Looks like github didn't detect the merge, closing.",
      "created_at" : "2021-11-24T16:50:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-978053383",
      "id" : 978053383,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21943",
      "node_id" : "IC_kwDOABII5846S-kH",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/978053383/reactions"
      },
      "updated_at" : "2021-11-24T16:50:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/978053383",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r757474099"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/757474099"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> Once this is PR is merged I will chop off another piece from #21878 into a smaller/manageable PR that will contain the commit which introduces such a packing `net: introduce Sock::WaitMany()`\r\n\r\nThere are too many conflicts if I try to cherry-pick the `WaitMany()` stuff on top of bare `master` - it touches the same areas of code as the preceding commits from #21878. I chopped off those preceding commits in separate PRs instead: https://github.com/bitcoin/bitcoin/pull/23601 and https://github.com/bitcoin/bitcoin/pull/23604.\r\n\r\n```\r\nWaitMany | net: use Sock::WaitMany() instead of CConnman::SocketEvents()\r\nstuff    | net: introduce Sock::WaitMany()\r\n         | net: also wait for exceptional events in Sock::Wait()\r\n\r\n#23601   | net: don't check if the listening socket is valid\r\n\r\n         | scripted-diff: rename CNode::cs_hSocket to CNode::m_sock_mutex\r\n#23604   | net: use Sock in CNode\r\n         | fuzz: move FuzzedSock earlier in src/test/fuzz/util.h\r\n\r\n         | net: change CreateNodeFromAcceptedSocket() to take Sock\r\n#21879   | net: use Sock in CConnman::ListenSocket\r\n         | net: add new method Sock::Accept() that wraps accept()\r\n```\r\n",
      "commit_id" : "f52b6b2d9f482353821da0ef4c485c402a396c8d",
      "created_at" : "2021-11-26T12:49:31Z",
      "diff_hunk" : "@@ -1497,34 +1493,29 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n-    std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(recv_set, send_set, error_set);\n-\n-    if (interruptNet) return;\n+    std::set<SOCKET> recv_set;\n+    std::set<SOCKET> send_set;\n+    std::set<SOCKET> error_set;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r757474099",
      "id" : 757474099,
      "in_reply_to_id" : 751179588,
      "line" : 1507,
      "node_id" : "PRRC_kwDOABII584tJiMz",
      "original_commit_id" : "db0a01e0d1ab4462b70a44c255c602ea074b96ef",
      "original_line" : 1507,
      "original_position" : 111,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 120,
      "pull_request_review_id" : 816753105,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/757474099/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-26T12:49:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/757474099",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   }
]
