[
   {
      "author_association" : "NONE",
      "body" : "Welp, I did crazy thing and launched `bitcoind` as root, with:\r\n```\r\nsudo src/bitcoind -regtest -walletdir=/ -datadir=/tmp/datadir -server\r\n```\r\nCreated wallet, and then listed:\r\n```\r\n{\r\n  \"wallets\": [\r\n    {\r\n      \"name\": \"est\"\r\n    },\r\n    {\r\n      \"name\": \"ome/vincas/.bitcoin/regtest/wallets\"\r\n    },\r\n    {\r\n      \"name\": \"ome/vincas/code/eclair/eclair_recovery_tool.git/eclair-core/target/integration-8198c6f7-2f0b-4394-a92a-d4d738994f33/datadir-bitcoin/regtest/wallets\"\r\n    },\r\n    {\r\n      \"name\": \"ome/vincas/code/eclair/eclair_recovery_tool.git/eclair-core/target/integration-9063e6a5-c013-4127-a7dd-a10a3874ed18/datadir-bitcoin/regtest/wallets\"\r\n    },\r\n    {\r\n      \"name\": \"ome/vincas/code/eclair/eclair_recovery_tool.git/eclair-core/target/integration-e9783f5b-51ab-458f-ab57-31976e38bff8/datadir-bitcoin/regtest/wallets\"\r\n    },\r\n    {\r\n      \"name\": \"ome/vincas/code/eclair/eclair_recovery_tool.git/eclair-core/target/integration-f1c34eba-d63e-4379-a315-75056bbcc162/datadir-bitcoin/regtest/wallets\"\r\n    },\r\n    {\r\n      \"name\": \"ome/vincas/code/eclair/eclair_recovery_tool.git/eclair-core/target/integration-d4096df3-5adb-40dd-9425-6f80fb6fd07b/datadir-bitcoin/regtest/wallets\"\r\n    },\r\n    {\r\n      \"name\": \"ome/vincas/code/eclair/eclair_recovery_tool.git/eclair-core/target/integration-e6a27da9-a78e-48a5-a272-38a950ddfd41/datadir-bitcoin/regtest/wallets\"\r\n    },\r\n    {\r\n      \"name\": \"ome/vincas/code/bitcoin/123-bitcoin-core-gui.git/test/functional/data/wallets/high_minversion\"\r\n    },\r\n    {\r\n      \"name\": \"ome/vincas/code/bitcoin/149-bitcoin-core-gui.git/test/functional/data/wallets/high_minversion\"\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\nInteresting to see `bitcoind` scan whole system for wallets :D (log even printed `ListDatabases: Error scanning /sys/fs/bpf: boost::filesystem::status: Operation not permitted: \"/sys/fs/bpf/wallet.dat\"`).\r\n\r\nAnyhow, issue is the same on Linux, and this PR did fix that too:\r\n```\r\n{\r\n  \"wallets\": [\r\n    {\r\n      \"name\": \"test\"\r\n    },\r\n...same...\r\n```\r\n",
      "created_at" : "2021-05-13T18:34:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21944#issuecomment-840750672",
      "id" : 840750672,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21944",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0MDc1MDY3Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-13T18:34:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/840750672",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/292191?v=4",
         "events_url" : "https://api.github.com/users/Talkless/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Talkless/followers",
         "following_url" : "https://api.github.com/users/Talkless/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Talkless/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Talkless",
         "id" : 292191,
         "login" : "Talkless",
         "node_id" : "MDQ6VXNlcjI5MjE5MQ==",
         "organizations_url" : "https://api.github.com/users/Talkless/orgs",
         "received_events_url" : "https://api.github.com/users/Talkless/received_events",
         "repos_url" : "https://api.github.com/users/Talkless/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Talkless/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Talkless/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Talkless"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21944#discussion_r632029229"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21944"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632029229"
         }
      },
      "author_association" : "NONE",
      "body" : "You could still keep `path` const as before, by utilizing immediately-invoked lambda, as suggested in [ES.28: Use lambdas for complex initialization, especially of const variables](https://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Res-lambda-init) guideline, with something like this (also avoiding re-initializing `path` variable):\r\n\r\n```\r\n            const fs::path path = [&wallet_dir, &it, offset]() {\r\n\r\n                if (wallet_dir == wallet_dir.root_path()) {\r\n                   return it->path().string().substr(offset - 1);\r\n                }\r\n\r\n                return it->path().string().substr(offset);\r\n            }();\r\n```\r\nNot sure if this is the best way to do that overall, as I don't have basically any experience with boost/stl filesystem...",
      "commit_id" : "48a73833c27608b3302f0537bdbfbfb23e725c4e",
      "created_at" : "2021-05-13T18:50:09Z",
      "diff_hunk" : "@@ -25,7 +25,13 @@ std::vector<fs::path> ListDatabases(const fs::path& wallet_dir)\n         try {\n             // Get wallet path relative to walletdir by removing walletdir from the wallet path.\n             // This can be replaced by boost::filesystem::lexically_relative once boost is bumped to 1.60.\n-            const fs::path path = it->path().string().substr(offset);\n+            fs::path path = wallet_dir.string();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21944#discussion_r632029229",
      "id" : 632029229,
      "line" : 28,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMjAyOTIyOQ==",
      "original_commit_id" : "48a73833c27608b3302f0537bdbfbfb23e725c4e",
      "original_line" : 28,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/db.cpp",
      "position" : 5,
      "pull_request_review_id" : 659201602,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21944",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-13T18:50:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632029229",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/292191?v=4",
         "events_url" : "https://api.github.com/users/Talkless/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Talkless/followers",
         "following_url" : "https://api.github.com/users/Talkless/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Talkless/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Talkless",
         "id" : 292191,
         "login" : "Talkless",
         "node_id" : "MDQ6VXNlcjI5MjE5MQ==",
         "organizations_url" : "https://api.github.com/users/Talkless/orgs",
         "received_events_url" : "https://api.github.com/users/Talkless/received_events",
         "repos_url" : "https://api.github.com/users/Talkless/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Talkless/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Talkless/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Talkless"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Interesting to see bitcoind scan whole system for wallets :D (log even printed ListDatabases: Error scanning /sys/fs/bpf: boost::filesystem::status: Operation not permitted: \"/sys/fs/bpf/wallet.dat\").\r\n\r\nYes it recursively iterates path mentioned. How much time did this take?\r\n\r\n> Anyhow, issue is the same on Linux, and this PR did fix that too\r\n\r\nInteresting. Thanks for testing this on Linux. I will change name, description, commit message and comment after testing few more things.\r\n\r\nAlthough I think it's less likely someone will save wallet in root on Linux. But it's normal to save different folders in root of different partitions on Windows.",
      "created_at" : "2021-05-14T00:25:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21944#issuecomment-840913891",
      "id" : 840913891,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21944",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0MDkxMzg5MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-14T00:37:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/840913891",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/13405205?v=4",
         "events_url" : "https://api.github.com/users/prayank23/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prayank23/followers",
         "following_url" : "https://api.github.com/users/prayank23/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prayank23/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prayank23",
         "id" : 13405205,
         "login" : "prayank23",
         "node_id" : "MDQ6VXNlcjEzNDA1MjA1",
         "organizations_url" : "https://api.github.com/users/prayank23/orgs",
         "received_events_url" : "https://api.github.com/users/prayank23/received_events",
         "repos_url" : "https://api.github.com/users/prayank23/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prayank23/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prayank23/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prayank23"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21944#discussion_r632180545"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21944"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632180545"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Will try this approach ",
      "commit_id" : "48a73833c27608b3302f0537bdbfbfb23e725c4e",
      "created_at" : "2021-05-14T00:26:16Z",
      "diff_hunk" : "@@ -25,7 +25,13 @@ std::vector<fs::path> ListDatabases(const fs::path& wallet_dir)\n         try {\n             // Get wallet path relative to walletdir by removing walletdir from the wallet path.\n             // This can be replaced by boost::filesystem::lexically_relative once boost is bumped to 1.60.\n-            const fs::path path = it->path().string().substr(offset);\n+            fs::path path = wallet_dir.string();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21944#discussion_r632180545",
      "id" : 632180545,
      "in_reply_to_id" : 632029229,
      "line" : 28,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMjE4MDU0NQ==",
      "original_commit_id" : "48a73833c27608b3302f0537bdbfbfb23e725c4e",
      "original_line" : 28,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/db.cpp",
      "position" : 5,
      "pull_request_review_id" : 659394909,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21944",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-14T00:26:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632180545",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/13405205?v=4",
         "events_url" : "https://api.github.com/users/prayank23/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prayank23/followers",
         "following_url" : "https://api.github.com/users/prayank23/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prayank23/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prayank23",
         "id" : 13405205,
         "login" : "prayank23",
         "node_id" : "MDQ6VXNlcjEzNDA1MjA1",
         "organizations_url" : "https://api.github.com/users/prayank23/orgs",
         "received_events_url" : "https://api.github.com/users/prayank23/received_events",
         "repos_url" : "https://api.github.com/users/prayank23/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prayank23/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prayank23/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prayank23"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21944#discussion_r632923386"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21944"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632923386"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit, wrong indent",
      "commit_id" : "48a73833c27608b3302f0537bdbfbfb23e725c4e",
      "created_at" : "2021-05-15T09:43:37Z",
      "diff_hunk" : "@@ -25,7 +25,13 @@ std::vector<fs::path> ListDatabases(const fs::path& wallet_dir)\n         try {\n             // Get wallet path relative to walletdir by removing walletdir from the wallet path.\n             // This can be replaced by boost::filesystem::lexically_relative once boost is bumped to 1.60.\n-            const fs::path path = it->path().string().substr(offset);\n+            fs::path path = wallet_dir.string();\n+\n+            if (path == path.root_path()) { //If path is a 'root directory' for Windows\n+               path = it->path().string().substr(offset - 1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21944#discussion_r632923386",
      "id" : 632923386,
      "line" : 31,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMjkyMzM4Ng==",
      "original_commit_id" : "48a73833c27608b3302f0537bdbfbfb23e725c4e",
      "original_line" : 31,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/wallet/db.cpp",
      "position" : 8,
      "pull_request_review_id" : 660324716,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21944",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-15T09:59:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632923386",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nNo conflicts as of last run.",
      "created_at" : "2021-05-17T16:00:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21944#issuecomment-842443204",
      "id" : 842443204,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21944",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0MjQ0MzIwNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-29T05:40:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/842443204",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> Yes it recursively iterates path mentioned. How much time did this take?\r\n\r\nAbout 19s in a VM running on i7 laptop with SATA SSD.",
      "created_at" : "2021-05-19T17:42:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21944#issuecomment-844325744",
      "id" : 844325744,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21944",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0NDMyNTc0NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-19T17:42:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/844325744",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/292191?v=4",
         "events_url" : "https://api.github.com/users/Talkless/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Talkless/followers",
         "following_url" : "https://api.github.com/users/Talkless/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Talkless/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Talkless",
         "id" : 292191,
         "login" : "Talkless",
         "node_id" : "MDQ6VXNlcjI5MjE5MQ==",
         "organizations_url" : "https://api.github.com/users/Talkless/orgs",
         "received_events_url" : "https://api.github.com/users/Talkless/received_events",
         "repos_url" : "https://api.github.com/users/Talkless/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Talkless/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Talkless/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Talkless"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Not sure it's worth adding these cases considering #20744 unless we want to backport the fix.\r\n\r\nCc: @MarcoFalke @meshcollider ",
      "created_at" : "2021-05-20T16:34:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21944#issuecomment-845273555",
      "id" : 845273555,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21944",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0NTI3MzU1NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-20T16:34:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/845273555",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/13405205?v=4",
         "events_url" : "https://api.github.com/users/prayank23/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prayank23/followers",
         "following_url" : "https://api.github.com/users/prayank23/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prayank23/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prayank23",
         "id" : 13405205,
         "login" : "prayank23",
         "node_id" : "MDQ6VXNlcjEzNDA1MjA1",
         "organizations_url" : "https://api.github.com/users/prayank23/orgs",
         "received_events_url" : "https://api.github.com/users/prayank23/received_events",
         "repos_url" : "https://api.github.com/users/prayank23/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prayank23/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prayank23/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prayank23"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Definitely good to have a fix for this issue. Would welcome simplifying the PR though. I think the following would be a simpler short term fix than c5ee096d596766b5f9dd6e3f8d81c8e87c0e9c3a:\r\n\r\n```diff\r\ndiff --git a/src/wallet/db.cpp b/src/wallet/db.cpp\r\nindex cd49baeb786..993dd09b8b9 100644\r\n--- a/src/wallet/db.cpp\r\n+++ b/src/wallet/db.cpp\r\n@@ -12,7 +12,7 @@\r\n \r\n std::vector<fs::path> ListDatabases(const fs::path& wallet_dir)\r\n {\r\n-    const size_t offset = wallet_dir.string().size() + 1;\r\n+    const size_t offset = wallet_dir.string().size() + (wallet_dir == wallet_dir.root_name() ? 0 : 1);\r\n     std::vector<fs::path> paths;\r\n     boost::system::error_code ec;\r\n \r\n```\r\n\r\nThis:\r\n\r\n- avoids adding and then subtracting 1 unnecessarily\r\n- avoids doing the same comparison in a loop\r\n- avoids using an unnecessary lambda\r\n- uses root_name instead of root_path which should avoid triggering for `/` on linux according to https://www.boost.org/doc/libs/1_69_0/libs/filesystem/doc/reference.html#path-decomposition-table\r\n\r\nIn long term after we switch from boost (#20744) or update boost (#19667), a more robust fix also suggested https://github.com/bitcoin/bitcoin/issues/21501#issuecomment-807122155 would be:\r\n\r\n```diff\r\n--- a/src/wallet/db.cpp\r\n+++ b/src/wallet/db.cpp\r\n@@ -12,7 +12,6 @@\r\n \r\n std::vector<fs::path> ListDatabases(const fs::path& wallet_dir)\r\n {\r\n-    const size_t offset = wallet_dir.string().size() + 1;\r\n     std::vector<fs::path> paths;\r\n     boost::system::error_code ec;\r\n \r\n@@ -24,8 +23,7 @@ std::vector<fs::path> ListDatabases(const fs::path& wallet_dir)\r\n \r\n         try {\r\n             // Get wallet path relative to walletdir by removing walletdir from the wallet path.\r\n-            // This can be replaced by boost::filesystem::lexically_relative once boost is bumped to 1.60.\r\n-            const fs::path path = it->path().string().substr(offset);\r\n+            const fs::path path = fs::lexically_relative(it->path(), wallet_dir);\r\n \r\n             if (it->status().type() == fs::directory_file &&\r\n                 (IsBDBFile(BDBDataFile(it->path())) || IsSQLiteFile(SQLiteDataFile(it->path())))) {\r\n```\r\n\r\nIf we wanted to be really ambitious maybe we could write a unit test for the bug using [subst](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/subst) `subprocess.run(f\"subst {tempdir} x:\")`, `node.start([\"-walletdir=x:\"])`\r\n\r\n\r\n\r\n",
      "created_at" : "2021-05-28T00:13:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21944#issuecomment-850023110",
      "id" : 850023110,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21944",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1MDAyMzExMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-28T00:14:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/850023110",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for the review @ryanofsky \r\n\r\nMade changes in https://github.com/bitcoin/bitcoin/commit/d44a261acff40c1c8727d3cc0106bde65a6416d0\r\n\r\n> Would welcome simplifying the PR though. I think the following would be a simpler short term fix than c5ee096\r\n\r\nAgree\r\n",
      "created_at" : "2021-06-01T15:08:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21944#issuecomment-852203424",
      "id" : 852203424,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21944",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1MjIwMzQyNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-01T15:08:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/852203424",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/13405205?v=4",
         "events_url" : "https://api.github.com/users/prayank23/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prayank23/followers",
         "following_url" : "https://api.github.com/users/prayank23/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prayank23/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prayank23",
         "id" : 13405205,
         "login" : "prayank23",
         "node_id" : "MDQ6VXNlcjEzNDA1MjA1",
         "organizations_url" : "https://api.github.com/users/prayank23/orgs",
         "received_events_url" : "https://api.github.com/users/prayank23/received_events",
         "repos_url" : "https://api.github.com/users/prayank23/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prayank23/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prayank23/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prayank23"
      }
   }
]
