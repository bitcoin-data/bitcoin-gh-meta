{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "MEMBER",
   "body" : "When a non-empty wallet with the `WALLET_FLAG_EXTERNAL_SIGNER` flag is supposed to be auto-loaded, i.e., it is mentioned in the `settings.json` file, and binaries are built with the `--disable-external-signer` configure option, the `bitcoind` fails:\r\n```\r\n...\r\n2021-05-11T12:07:20Z [init] Using SQLite Version 3.31.1\r\n2021-05-11T12:07:20Z [init] Using wallet /home/hebasto/.bitcoin/testnet3/wallets/coldcard_t\r\n2021-05-11T12:07:20Z [init] init message: Loading walletâ¦\r\n2021-05-11T12:07:20Z [init] [coldcard_t] LoadDescriptorScriptPubKeyMan: Compiled without external signing support (required for external signing)\r\n2021-05-11T12:07:20Z [init] [coldcard_t] LoadDescriptorScriptPubKeyMan: Compiled without external signing support (required for external signing)\r\n2021-05-11T12:07:20Z [init] [coldcard_t] LoadDescriptorScriptPubKeyMan: Compiled without external signing support (required for external signing)\r\n2021-05-11T12:07:20Z [init] [coldcard_t] LoadDescriptorScriptPubKeyMan: Compiled without external signing support (required for external signing)\r\n2021-05-11T12:07:20Z [init] [coldcard_t] LoadDescriptorScriptPubKeyMan: Compiled without external signing support (required for external signing)\r\n2021-05-11T12:07:20Z [init] [coldcard_t] LoadDescriptorScriptPubKeyMan: Compiled without external signing support (required for external signing)\r\n2021-05-11T12:07:20Z [init] [coldcard_t] Setting spkMan to active: id = c2fe2eddfccf102a74da940e282062adc8c13fbd28d00477644d3fcd1f6efe5d, type = 0, internal = 0\r\n2021-05-11T12:07:20Z [init] [coldcard_t] Releasing wallet\r\n2021-05-11T12:07:20Z [init] \r\n\r\n************************\r\nEXCEPTION: St12out_of_range       \r\nmap::at       \r\nbitcoin in AppInit()       \r\n\r\n\r\n\r\n************************\r\nEXCEPTION: St12out_of_range       \r\nmap::at       \r\nbitcoin in AppInit()       \r\n\r\n2021-05-11T12:07:20Z [init] Shutdown: In progress...\r\n2021-05-11T12:07:20Z [scheduler] scheduler thread exit\r\n2021-05-11T12:07:21Z [shutoff] FlushStateToDisk: write coins cache to disk (0 coins, 0kB) started\r\n2021-05-11T12:07:21Z [shutoff] FlushStateToDisk: write coins cache to disk (0 coins, 0kB) completed (0.00s)\r\n2021-05-11T12:07:21Z [shutoff] FlushStateToDisk: write coins cache to disk (0 coins, 0kB) started\r\n2021-05-11T12:07:21Z [shutoff] FlushStateToDisk: write coins cache to disk (0 coins, 0kB) completed (0.00s)\r\n2021-05-11T12:07:21Z [shutoff] [w20191120] Releasing wallet\r\n2021-05-11T12:07:21Z [shutoff] [watch-only] Releasing wallet\r\n2021-05-11T12:07:21Z [shutoff] [default wallet] Releasing wallet\r\n2021-05-11T12:07:21Z [shutoff] Shutdown: done\r\n```\r\n\r\nThe reason is the `CWallet::Create` throws an exception that is not caught in https://github.com/bitcoin/bitcoin/blob/e175a20769b5a7b98ee3082d89f9d4f31a4503d6/src/wallet/load.cpp#L117-L120\r\n\r\nWith the following diff\r\n```diff\r\n--- a/src/wallet/load.cpp\r\n+++ b/src/wallet/load.cpp\r\n@@ -117,6 +117,9 @@ bool LoadWallets(interfaces::Chain& chain)\r\n     } catch (const std::runtime_error& e) {\r\n         chain.initError(Untranslated(e.what()));\r\n         return false;\r\n+    } catch (const std::exception& e) {\r\n+        chain.initError(Untranslated(e.what()));\r\n+        return false;\r\n     }\r\n }\r\n \r\n```\r\n\r\nthe `bitcoind` output is:\r\n```\r\n...\r\n2021-05-11T12:18:21Z [init] Using SQLite Version 3.31.1\r\n2021-05-11T12:18:21Z [init] Using wallet /home/hebasto/.bitcoin/testnet3/wallets/coldcard_t\r\n2021-05-11T12:18:21Z [init] init message: Loading walletâ¦\r\n2021-05-11T12:18:21Z [init] [coldcard_t] LoadDescriptorScriptPubKeyMan: Compiled without external signing support (required for external signing)\r\n2021-05-11T12:18:21Z [init] [coldcard_t] LoadDescriptorScriptPubKeyMan: Compiled without external signing support (required for external signing)\r\n2021-05-11T12:18:21Z [init] [coldcard_t] LoadDescriptorScriptPubKeyMan: Compiled without external signing support (required for external signing)\r\n2021-05-11T12:18:21Z [init] [coldcard_t] LoadDescriptorScriptPubKeyMan: Compiled without external signing support (required for external signing)\r\n2021-05-11T12:18:21Z [init] [coldcard_t] LoadDescriptorScriptPubKeyMan: Compiled without external signing support (required for external signing)\r\n2021-05-11T12:18:21Z [init] [coldcard_t] LoadDescriptorScriptPubKeyMan: Compiled without external signing support (required for external signing)\r\n2021-05-11T12:18:21Z [init] [coldcard_t] Setting spkMan to active: id = c2fe2eddfccf102a74da940e282062adc8c13fbd28d00477644d3fcd1f6efe5d, type = 0, internal = 0\r\n2021-05-11T12:18:21Z [init] [coldcard_t] Releasing wallet\r\n2021-05-11T12:18:21Z [init] Error: map::at\r\nError: map::at\r\n2021-05-11T12:18:21Z [init] Shutdown: In progress...\r\n2021-05-11T12:18:22Z [scheduler] scheduler thread exit\r\n2021-05-11T12:18:22Z [shutoff] FlushStateToDisk: write coins cache to disk (0 coins, 0kB) started\r\n2021-05-11T12:18:22Z [shutoff] FlushStateToDisk: write coins cache to disk (0 coins, 0kB) completed (0.00s)\r\n2021-05-11T12:18:22Z [shutoff] FlushStateToDisk: write coins cache to disk (0 coins, 0kB) started\r\n2021-05-11T12:18:22Z [shutoff] FlushStateToDisk: write coins cache to disk (0 coins, 0kB) completed (0.00s)\r\n2021-05-11T12:18:23Z [shutoff] [w20191120] Releasing wallet\r\n2021-05-11T12:18:23Z [shutoff] [watch-only] Releasing wallet\r\n2021-05-11T12:18:23Z [shutoff] [default wallet] Releasing wallet\r\n2021-05-11T12:18:23Z [shutoff] Shutdown: done\r\n```\r\n\r\n---\r\n\r\nNoted while reviewing https://github.com/bitcoin-core/gui/pull/4.",
   "closed_at" : "2021-06-09T21:04:11Z",
   "closed_by" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/3211283?v=4",
      "events_url" : "https://api.github.com/users/meshcollider/events{/privacy}",
      "followers_url" : "https://api.github.com/users/meshcollider/followers",
      "following_url" : "https://api.github.com/users/meshcollider/following{/other_user}",
      "gists_url" : "https://api.github.com/users/meshcollider/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/meshcollider",
      "id" : 3211283,
      "login" : "meshcollider",
      "node_id" : "MDQ6VXNlcjMyMTEyODM=",
      "organizations_url" : "https://api.github.com/users/meshcollider/orgs",
      "received_events_url" : "https://api.github.com/users/meshcollider/received_events",
      "repos_url" : "https://api.github.com/users/meshcollider/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/meshcollider/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/meshcollider/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/meshcollider"
   },
   "comments" : 6,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21919/comments",
   "created_at" : "2021-05-11T13:25:15Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21919/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/21919",
   "id" : 887277879,
   "labels" : [
      {
         "color" : "FBBAAB",
         "default" : false,
         "description" : null,
         "id" : 64585,
         "name" : "Bug",
         "node_id" : "MDU6TGFiZWw2NDU4NQ==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Bug"
      },
      {
         "color" : "08a781",
         "default" : false,
         "description" : null,
         "id" : 149424,
         "name" : "Wallet",
         "node_id" : "MDU6TGFiZWwxNDk0MjQ=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Wallet"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21919/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDU6SXNzdWU4ODcyNzc4Nzk=",
   "number" : 21919,
   "performed_via_github_app" : null,
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "wallet: bitcoind fails to auto-load a non-empty external-signer wallet",
   "updated_at" : "2021-06-09T21:04:12Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21919",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
      "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
      "followers_url" : "https://api.github.com/users/hebasto/followers",
      "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/hebasto",
      "id" : 32963518,
      "login" : "hebasto",
      "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
      "organizations_url" : "https://api.github.com/users/hebasto/orgs",
      "received_events_url" : "https://api.github.com/users/hebasto/received_events",
      "repos_url" : "https://api.github.com/users/hebasto/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/hebasto"
   }
}
