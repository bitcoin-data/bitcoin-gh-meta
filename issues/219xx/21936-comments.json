[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #21795 (fuzz: Terminate immediately if a fuzzing harness tries to perform a DNS lookup (belt and suspenders) by practicalswift)\n* #21538 (fuzz: Add fuzzing syscall sandbox: detect use of unexpected syscalls when fuzzing (\"syscall sanitizer\") by practicalswift)\n* #21496 (fuzz: execute each file in dir without fuzz engine by AnthonyRonning)\n* #20487 (Add syscall sandboxing using seccomp-bpf (Linux secure computing mode) by practicalswift)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-05-13T02:53:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21936#issuecomment-840251844",
      "id" : 840251844,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21936",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0MDI1MTg0NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-15T15:05:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/840251844",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK. Creating a TCP socket shouldn't happen accidentally :)\r\n\r\nIs this precautionary for future fuzzers added or something you stumbled on with current fuzzers? I'm interested in whether there needs to be many more of these kinds of footgun protections in case fuzzing goes down these uncontrolled paths. The alternative (I think) would be to say \"If you run experimental fuzzers you are on your own\". Protections such as the one introduced in this PR would just be there for the really dangerous paths.",
      "created_at" : "2021-05-13T09:44:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21936#issuecomment-840446528",
      "id" : 840446528,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21936",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0MDQ0NjUyOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-13T09:44:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/840446528",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/16323900?v=4",
         "events_url" : "https://api.github.com/users/michaelfolkson/events{/privacy}",
         "followers_url" : "https://api.github.com/users/michaelfolkson/followers",
         "following_url" : "https://api.github.com/users/michaelfolkson/following{/other_user}",
         "gists_url" : "https://api.github.com/users/michaelfolkson/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/michaelfolkson",
         "id" : 16323900,
         "login" : "michaelfolkson",
         "node_id" : "MDQ6VXNlcjE2MzIzOTAw",
         "organizations_url" : "https://api.github.com/users/michaelfolkson/orgs",
         "received_events_url" : "https://api.github.com/users/michaelfolkson/received_events",
         "repos_url" : "https://api.github.com/users/michaelfolkson/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/michaelfolkson/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/michaelfolkson/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/michaelfolkson"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Is this precautionary for future fuzzers added or something you stumbled on with current fuzzers? \r\n\r\nThis is added purely as a cheap precautionary measure.\r\n\r\nThe only \"surprising\" use of networking syscalls we've ever seen in the code base historically (AFAIK) is that the `socket` syscall is currently being invoked when formatting an IP address a string (`CNetAddr::ToString`). That is documented in issue #21466 and being resolved by PR #21756. Review welcome! :)\r\n\r\n> I'm interested in whether there needs to be many more of these kinds of footgun protections in case fuzzing goes down these uncontrolled paths.\r\n\r\nThe bullet proof approach to avoiding unexpected syscalls in Linux is to use [seccomp-bpf](https://en.wikipedia.org/wiki/Seccomp).\r\n\r\nPR #20487 adds syscall sandbox support to Bitcoin Core using seccomp-bpf (opt-in at compile-time via `--with-syscall-sandbox`), and PR #21538 extends that support to detect use of unexpected syscalls when fuzzing (\"syscall sanitizer\"). Review welcome for both! :)",
      "created_at" : "2021-05-15T08:38:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21936#issuecomment-841623469",
      "id" : 841623469,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21936",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0MTYyMzQ2OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-15T08:39:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/841623469",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21936#discussion_r633450381"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21936"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633450381"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "A call to `std::terminate()` was added, which is defined in `<exception>`.\r\n```suggestion\r\n#include <exception>\r\n#include <memory>\r\n```",
      "commit_id" : "5454c9febd9bd17d26119ada6ac3cba9c46d7a81",
      "created_at" : "2021-05-17T11:29:09Z",
      "diff_hunk" : "@@ -4,10 +4,14 @@\n \n #include <test/fuzz/fuzz.h>\n \n+#include <netaddress.h>\n+#include <netbase.h>\n #include <test/util/setup_common.h>\n #include <util/check.h>\n+#include <util/sock.h>\n \n #include <cstdint>\n+#include <memory>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21936#discussion_r633450381",
      "id" : 633450381,
      "line" : 14,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMzQ1MDM4MQ==",
      "original_commit_id" : "5454c9febd9bd17d26119ada6ac3cba9c46d7a81",
      "original_line" : 14,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/test/fuzz/fuzz.cpp",
      "position" : 11,
      "pull_request_review_id" : 660857163,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21936",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-17T11:33:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633450381",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21936#discussion_r635555653"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21936"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/635555653"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Oh, thanks! Now fixed.",
      "commit_id" : "39394d94591515b82f9bf3b086aa9b905cb006c9",
      "created_at" : "2021-05-19T20:17:53Z",
      "diff_hunk" : "@@ -4,10 +4,14 @@\n \n #include <test/fuzz/fuzz.h>\n \n+#include <netaddress.h>\n+#include <netbase.h>\n #include <test/util/setup_common.h>\n #include <util/check.h>\n+#include <util/sock.h>\n \n #include <cstdint>\n+#include <memory>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21936#discussion_r635555653",
      "id" : 635555653,
      "in_reply_to_id" : 633450381,
      "line" : 15,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNTU1NTY1Mw==",
      "original_commit_id" : "5454c9febd9bd17d26119ada6ac3cba9c46d7a81",
      "original_line" : 15,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/test/fuzz/fuzz.cpp",
      "position" : 12,
      "pull_request_review_id" : 663623673,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21936",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-19T20:17:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/635555653",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21936#discussion_r635986101"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21936"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/635986101"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can be removed if done with a simple one-line lambda:\r\n\r\n```diff\r\ndiff --git a/src/test/fuzz/fuzz.cpp b/src/test/fuzz/fuzz.cpp\r\nindex b6ba44fe21..631c861bb6 100644\r\n--- a/src/test/fuzz/fuzz.cpp\r\n+++ b/src/test/fuzz/fuzz.cpp\r\n@@ -32,15 +32,10 @@ void FuzzFrameworkRegisterTarget(std::string_view name, TypeTestOneInput target,\r\n \r\n static TypeTestOneInput* g_test_one_input{nullptr};\r\n \r\n-static std::unique_ptr<Sock> TerminateOnTCPSocketCreation(const CService&)\r\n-{\r\n-    std::terminate();\r\n-}\r\n-\r\n void initialize()\r\n {\r\n     // Terminate immediately if a fuzzing harness ever tries to create a TCP socket.\r\n-    CreateSock = TerminateOnTCPSocketCreation;\r\n+    CreateSock = [](const CService&) -> std::unique_ptr<Sock> { std::terminate(); };\r\n \r\n     bool should_abort{false};\r\n     if (std::getenv(\"PRINT_ALL_FUZZ_TARGETS_AND_ABORT\")) {\r\n",
      "commit_id" : "39394d94591515b82f9bf3b086aa9b905cb006c9",
      "created_at" : "2021-05-20T10:44:07Z",
      "diff_hunk" : "@@ -27,8 +32,16 @@ void FuzzFrameworkRegisterTarget(std::string_view name, TypeTestOneInput target,\n \n static TypeTestOneInput* g_test_one_input{nullptr};\n \n+static std::unique_ptr<Sock> TerminateOnTCPSocketCreation(const CService&)\n+{\n+    std::terminate();\n+}\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21936#discussion_r635986101",
      "id" : 635986101,
      "line" : 39,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNTk4NjEwMQ==",
      "original_commit_id" : "39394d94591515b82f9bf3b086aa9b905cb006c9",
      "original_line" : 39,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/test/fuzz/fuzz.cpp",
      "position" : 24,
      "pull_request_review_id" : 664223816,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21936",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-20T10:44:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/635986101",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21936#discussion_r636400468"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21936"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/636400468"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Sure, why not! Now addressed :)",
      "commit_id" : "393992b049d3bcf0b2a3439be128d13d6567f0b1",
      "created_at" : "2021-05-20T19:15:19Z",
      "diff_hunk" : "@@ -27,8 +32,16 @@ void FuzzFrameworkRegisterTarget(std::string_view name, TypeTestOneInput target,\n \n static TypeTestOneInput* g_test_one_input{nullptr};\n \n+static std::unique_ptr<Sock> TerminateOnTCPSocketCreation(const CService&)\n+{\n+    std::terminate();\n+}\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21936#discussion_r636400468",
      "id" : 636400468,
      "in_reply_to_id" : 635986101,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNjQwMDQ2OA==",
      "original_commit_id" : "39394d94591515b82f9bf3b086aa9b905cb006c9",
      "original_line" : 39,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/test/fuzz/fuzz.cpp",
      "position" : null,
      "pull_request_review_id" : 664802218,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21936",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-20T19:15:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/636400468",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK 393992b049d3bcf0b2a3439be128d13d6567f0b1",
      "created_at" : "2021-05-21T07:00:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21936#issuecomment-845709588",
      "id" : 845709588,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21936",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0NTcwOTU4OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-21T07:00:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/845709588",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
