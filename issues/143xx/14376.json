{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "CONTRIBUTOR",
   "body" : "<!-- Describe the issue -->\r\n# Description\r\nIt is possible to consistently cause a bitcoind process to be OOM killed on Linux (and probably termed on other operating systems) by making excessively large batched JSON RPC requests. There is currently no configurable way to limit batch sizes, so this can be done to any bitcoind instance providing the JSON RPC interfaces.\r\n\r\n<!--- What behavior did you expect? -->\r\n## Expected Behavior\r\nThe server responds with a \"batch too large\" error or equivalent whenever a configured batch size limit is reached.\r\n\r\n<!--- What was the actual behavior (provide screenshots if the issue is GUI-related)? -->\r\n## Actual Behavior\r\nBitcoind attempts to satisfy the request until it exhausts all available memory and is then OOM killed by the Linux kernel.\r\n\r\n<!--- How reliably can you reproduce the issue, what are the steps to do so? -->\r\n## Reproduction\r\nThis issue can be easily reproduced under the following conditions:\r\n\r\n* Create a fresh Bitcoin Docker image using Ubuntu Linux.\r\n* Run the image with `-p 8332:8332 -p 8333:8333 -m=100m` to restrict the available memory to 100MB and expose RPC and chatter protocols.\r\n* Run `bitcoind` with the following flags: `-testnet -rpcuser=<user> -rpcpassword=<pass> -rpcbind=0.0.0.0 -rpcallowip=0.0.0.0/0`\r\n* Wait for the first ~25,000 testnet blocks to sync.\r\n* Execute JSON RPC batch request to `getblockhash` for the first 20,000 block hashes\r\n* Execute JSON RPC batch request `getblock(<hash>, 2)` for the first 20,000 block hashes, requesting all 20,000 blocks and included transactions in one batch response.\r\n* Bitcoin process will eventually exhaust memory and be terminated.\r\n\r\nThe bitcoind process will be OOM killed by the Linux kernel:\r\n\r\n![screen shot 2018-10-02 at 8 23 31 pm](https://user-images.githubusercontent.com/69561/46388617-24306680-c682-11e8-9b3c-12685e5c36f6.png)\r\n\r\nThe socket on the RPC request will EOF:\r\n\r\n![screen shot 2018-10-02 at 8 32 25 pm](https://user-images.githubusercontent.com/69561/46388642-55a93200-c682-11e8-974d-1da4554c0246.png)\r\n\r\nLooking in the system logs you will see something like:\r\n\r\n```\r\nOut of memory: kill process 1984 (bitcoind) score 910 or sacrifice child\r\n<snip>\r\nbitcoin-httpwor invoked oom-killer: gfp_mask=0x14201ca(GFP_HIGHUSER_MOVABLE|__GFP_COLD), nodemask=(null),  order=0, oom_score_adj=0\r\n```\r\n\r\n<!-- What version of Bitcoin Core are you using, where did you get it (website, self-compiled, etc)? -->\r\n\r\n<!-- What type of machine are you observing the error on (OS/CPU and disk type)? -->\r\n## Machine Type\r\n\r\nThis works on all AWS instance types running Gentoo or Ubuntu Linux, and should be reproducible on any Linux instance type that has the OOM killer enabled.\r\n\r\n<!-- Any extra information that might be useful in the debugging process. -->\r\n<!--- This is normally the contents of a `debug.log` or `config.log` file. Raw text or a link to a pastebin type site are preferred. -->\r\n\r\n## References\r\n* [Respite from the OOM killer](https://lwn.net/Articles/104179/) - Good overview of the Linux OOM killer and the security issues it can cause.\r\n* [Slides: Avoid OOM On Embedded Linux](https://elinux.org/images/a/a3/CELF_AvoidOOM.pdf) - Overview of Linux kernel overcommit and issues it can cause in embedded systems.\r\n",
   "closed_at" : "2018-10-18T18:30:55Z",
   "closed_by" : {
      "avatar_url" : "https://avatars1.githubusercontent.com/u/69561?v=4",
      "events_url" : "https://api.github.com/users/etscrivner/events{/privacy}",
      "followers_url" : "https://api.github.com/users/etscrivner/followers",
      "following_url" : "https://api.github.com/users/etscrivner/following{/other_user}",
      "gists_url" : "https://api.github.com/users/etscrivner/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/etscrivner",
      "id" : 69561,
      "login" : "etscrivner",
      "node_id" : "MDQ6VXNlcjY5NTYx",
      "organizations_url" : "https://api.github.com/users/etscrivner/orgs",
      "received_events_url" : "https://api.github.com/users/etscrivner/received_events",
      "repos_url" : "https://api.github.com/users/etscrivner/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/etscrivner/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/etscrivner/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/etscrivner"
   },
   "comments" : 11,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14376/comments",
   "created_at" : "2018-10-03T03:56:03Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14376/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/14376",
   "id" : 366165627,
   "labels" : [
      {
         "color" : "ebd775",
         "default" : false,
         "id" : 64584,
         "name" : "Brainstorming",
         "node_id" : "MDU6TGFiZWw2NDU4NA==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Brainstorming"
      },
      {
         "color" : "0052cc",
         "default" : false,
         "id" : 98279177,
         "name" : "RPC/REST/ZMQ",
         "node_id" : "MDU6TGFiZWw5ODI3OTE3Nw==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/RPC/REST/ZMQ"
      },
      {
         "color" : "981023",
         "default" : false,
         "id" : 326918230,
         "name" : "Resource usage",
         "node_id" : "MDU6TGFiZWwzMjY5MTgyMzA=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Resource%20usage"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14376/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDU6SXNzdWUzNjYxNjU2Mjc=",
   "number" : 14376,
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "JSON RPC Batch Requests Can Consistently OOM Kill Bitcoin Process",
   "updated_at" : "2018-11-21T18:38:29Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14376",
   "user" : {
      "avatar_url" : "https://avatars1.githubusercontent.com/u/69561?v=4",
      "events_url" : "https://api.github.com/users/etscrivner/events{/privacy}",
      "followers_url" : "https://api.github.com/users/etscrivner/followers",
      "following_url" : "https://api.github.com/users/etscrivner/following{/other_user}",
      "gists_url" : "https://api.github.com/users/etscrivner/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/etscrivner",
      "id" : 69561,
      "login" : "etscrivner",
      "node_id" : "MDQ6VXNlcjY5NTYx",
      "organizations_url" : "https://api.github.com/users/etscrivner/orgs",
      "received_events_url" : "https://api.github.com/users/etscrivner/received_events",
      "repos_url" : "https://api.github.com/users/etscrivner/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/etscrivner/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/etscrivner/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/etscrivner"
   }
}
