[
   {
      "author_association" : "MEMBER",
      "body" : "The rpc interface is not hardened against attackers and should only be called from internal, well-behaving code and not exposed to the outside directly.",
      "created_at" : "2018-10-03T04:01:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14376#issuecomment-426504734",
      "id" : 426504734,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14376",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyNjUwNDczNA==",
      "updated_at" : "2018-10-03T04:01:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/426504734",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "@MarcoFalke Absolutely agree that RPC interfaces are quite risky to expose publicly, but one can never guarantee the code interfacing with a node - even if trusted - is \"well-behaving\". This issue was discovered when a trusted internal network user accidentally ran a script overnight requesting overly large batches of blocks from a Bitcoin node.",
      "created_at" : "2018-10-03T04:06:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14376#issuecomment-426505312",
      "id" : 426505312,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14376",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyNjUwNTMxMg==",
      "updated_at" : "2018-10-03T04:06:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/426505312",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/69561?v=4",
         "events_url" : "https://api.github.com/users/etscrivner/events{/privacy}",
         "followers_url" : "https://api.github.com/users/etscrivner/followers",
         "following_url" : "https://api.github.com/users/etscrivner/following{/other_user}",
         "gists_url" : "https://api.github.com/users/etscrivner/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/etscrivner",
         "id" : 69561,
         "login" : "etscrivner",
         "node_id" : "MDQ6VXNlcjY5NTYx",
         "organizations_url" : "https://api.github.com/users/etscrivner/orgs",
         "received_events_url" : "https://api.github.com/users/etscrivner/received_events",
         "repos_url" : "https://api.github.com/users/etscrivner/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/etscrivner/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/etscrivner/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/etscrivner"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Agree with @MarcoFalke that this is not a critical issue as RPC clients are assumed to be trusted.\n\nThat doesn't mean we shouldn't fix this issue, though.",
      "created_at" : "2018-10-03T05:09:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14376#issuecomment-426513274",
      "id" : 426513274,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14376",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyNjUxMzI3NA==",
      "updated_at" : "2018-10-03T05:09:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/426513274",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Sure, if there is a way to prevent the crash lets do it, but I am not sure if we can efficiently estimate memory usage for each request.",
      "created_at" : "2018-10-03T06:01:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14376#issuecomment-426521107",
      "id" : 426521107,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14376",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyNjUyMTEwNw==",
      "updated_at" : "2018-10-03T06:01:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/426521107",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Agree with @sipa and @MarcoFalke. There is no need for too much hand holding on the RPC interface. Its assumed authenticated/trusted,... you can \"shutdown\" bitcoind more efficient with a `stop` command then with sending 20k getblockhash requests in a single batch. :-)\r\n\r\nOf course we could make is more sane as @sipa said,... but I also don't see a pressing need for this.",
      "created_at" : "2018-10-03T09:08:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14376#issuecomment-426564512",
      "id" : 426564512,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14376",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyNjU2NDUxMg==",
      "updated_at" : "2018-10-03T09:08:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/426564512",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "node_id" : "MDQ6VXNlcjE3ODQ2NA==",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Yeah, I don't think this is urgent by any means, but I believe it could be improved without too much work. I'm happy to take a crack at a fix but wanted to leave room for some comments first.\r\n\r\nOne simple proposal I've considered that I'd be interested in feedback on:\r\n\r\n**PROPOSAL**\r\nAdd a new configuration option `-rpcmaxbatchsize=<numrequests>`:\r\n* Takes the maximum number of requests allowed in a single RPC batch request.\r\n* Default: unlimited `(-1)` - the current configuration.\r\n* When `0` - either disable batching entirely or trigger a configuration error, no preference here.\r\n* When `<-1` - Trigger a configuration error and ignore.\r\n\r\nWhen `rpcmaxbatchsize` is configured AND `# of requests in batch > rpcmaxbatchsize`:\r\n* Throw a `JSONRPCError` with type `RPC_INVAILD_PARAMETER` and message `Number of requests in batch exceeds rpcmaxbatchsize`.\r\n\r\nEnforcing this would be as simple as adding a guard clause at the top of [`JSONRPCExecBatch`](https://github.com/bitcoin/bitcoin/blob/master/src/rpc/server.cpp#L413) that checks `vReq.size()`.\r\n\r\n**UPSIDES**\r\n* Simple to implement and enforce.\r\n* Provides some degree of crash safety in the presence of malfunctioning or misconfigured software interacting with a node over RPC.\r\n\r\n**DOWNSIDES**\r\n* Because the enforcement is on batch request size and not on memory used, this would disallow some large batch requests that would otherwise be able to succeed. However, the equivalent information can always just be aggregated from multiple smaller batch requests.\r\n* Requires node administrators to do some back of the envelope math to configure a reasonable `rpcmaxbatchsize` based on available system memory and number of RPC threads.",
      "created_at" : "2018-10-03T16:02:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14376#issuecomment-426693841",
      "id" : 426693841,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14376",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyNjY5Mzg0MQ==",
      "updated_at" : "2018-10-12T18:50:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/426693841",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/69561?v=4",
         "events_url" : "https://api.github.com/users/etscrivner/events{/privacy}",
         "followers_url" : "https://api.github.com/users/etscrivner/followers",
         "following_url" : "https://api.github.com/users/etscrivner/following{/other_user}",
         "gists_url" : "https://api.github.com/users/etscrivner/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/etscrivner",
         "id" : 69561,
         "login" : "etscrivner",
         "node_id" : "MDQ6VXNlcjY5NTYx",
         "organizations_url" : "https://api.github.com/users/etscrivner/orgs",
         "received_events_url" : "https://api.github.com/users/etscrivner/received_events",
         "repos_url" : "https://api.github.com/users/etscrivner/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/etscrivner/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/etscrivner/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/etscrivner"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "The OOM happens because the batch is processed as a whole: the json batch is parsed in one go, the full response is written in one go. Instead it should be \"streamed\"?",
      "created_at" : "2018-10-12T00:39:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14376#issuecomment-429166482",
      "id" : 429166482,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14376",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyOTE2NjQ4Mg==",
      "updated_at" : "2018-10-12T00:39:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/429166482",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "@promag AFAICT there are several ways to tackle this with varying levels of complexity and therefore cost and inherited complexity:\r\n\r\n1. Use a simple cap on number of requests per batch (See my proposal above)\r\n2. Try to calculate exact memory usage and return an out of memory error if this is exceeded when answering a query.\r\n3. Figured out how to use [chunked transfer encoding](https://en.wikipedia.org/wiki/Chunked_transfer_encoding) which is [possible with libevent](https://www.monkey.org/~provos/libevent/doxygen-2.0.1/http_8h.html#3dd375d81eac9baabc53749ed025ec12) but entails some significant changes to the Bitcoin HTTP server.\r\n\r\nI'd be interested in additional ideas as well as what folks think about the trade-offs inherent in each.",
      "created_at" : "2018-10-12T18:48:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14376#issuecomment-429423803",
      "id" : 429423803,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14376",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyOTQyMzgwMw==",
      "updated_at" : "2018-10-18T17:56:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/429423803",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/69561?v=4",
         "events_url" : "https://api.github.com/users/etscrivner/events{/privacy}",
         "followers_url" : "https://api.github.com/users/etscrivner/followers",
         "following_url" : "https://api.github.com/users/etscrivner/following{/other_user}",
         "gists_url" : "https://api.github.com/users/etscrivner/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/etscrivner",
         "id" : 69561,
         "login" : "etscrivner",
         "node_id" : "MDQ6VXNlcjY5NTYx",
         "organizations_url" : "https://api.github.com/users/etscrivner/orgs",
         "received_events_url" : "https://api.github.com/users/etscrivner/received_events",
         "repos_url" : "https://api.github.com/users/etscrivner/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/etscrivner/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/etscrivner/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/etscrivner"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Possibly related #11322 and #11368?",
      "created_at" : "2018-10-14T10:22:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14376#issuecomment-429613022",
      "id" : 429613022,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14376",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyOTYxMzAyMg==",
      "updated_at" : "2018-10-14T10:22:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/429613022",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/3211283?v=4",
         "events_url" : "https://api.github.com/users/MeshCollider/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MeshCollider/followers",
         "following_url" : "https://api.github.com/users/MeshCollider/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MeshCollider/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MeshCollider",
         "id" : 3211283,
         "login" : "MeshCollider",
         "node_id" : "MDQ6VXNlcjMyMTEyODM=",
         "organizations_url" : "https://api.github.com/users/MeshCollider/orgs",
         "received_events_url" : "https://api.github.com/users/MeshCollider/received_events",
         "repos_url" : "https://api.github.com/users/MeshCollider/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MeshCollider/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MeshCollider/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MeshCollider"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@etscrivner of course, and to support streaming it would require changes to how the JSON is parsed.\r\n\r\nRegarding https://github.com/bitcoin/bitcoin/issues/14376#issuecomment-429423803:\r\n\r\n 1. Requires parsing the whole JSON request\r\n 2. I don't know how you could do that, and also the same as 1.\r\n 3. Maybe not worth the effort.\r\n\r\nMaybe with multi process separation, with RPC workers as separate processes, we could avoid OOM the main process.\r\n\r\nIMO we should not limit the batch size, it defeats the purpose of batches. If the node can handle consecutive requests it should also handle the same requests in a batch.",
      "created_at" : "2018-10-18T07:00:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14376#issuecomment-430897235",
      "id" : 430897235,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14376",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQzMDg5NzIzNQ==",
      "updated_at" : "2018-11-21T18:38:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/430897235",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "@promag Thanks for the thoughtful response here.\r\n\r\nOne small point of clarification here: As I see it, the issue here isn't really with JSON request parsing (since the requests here are very small, see original bug report). It is instead with the size of the response objects. Essentially, it is possible to make bitcoind consume 10+ GB of memory from ~1-2MB of request JSON. Though I take your point that the requests themselves could also be excessively large, causing the same issue, but this seems less likely given the trusted multi-user configuration described below. Instead it is this non-linear relationship between \r\n\r\nMany businesses deploy bitcoin nodes in a multi-user configuration - where one or several full nodes are accessed by trusted individuals across many departments. This simplifies deployment and maintenance of the nodes and also lowers costs by trading off trust for convenience.\r\n\r\nCapping the batch size helps indirectly prevent this explosion of memory usage for multi-user full clients may accidentally attempt to run request batches that are simply too large.\r\n\r\nP.S. Whoops accidentally closed this issue.",
      "created_at" : "2018-10-18T18:30:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14376#issuecomment-431114968",
      "id" : 431114968,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14376",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQzMTExNDk2OA==",
      "updated_at" : "2018-10-18T18:33:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/431114968",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/69561?v=4",
         "events_url" : "https://api.github.com/users/etscrivner/events{/privacy}",
         "followers_url" : "https://api.github.com/users/etscrivner/followers",
         "following_url" : "https://api.github.com/users/etscrivner/following{/other_user}",
         "gists_url" : "https://api.github.com/users/etscrivner/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/etscrivner",
         "id" : 69561,
         "login" : "etscrivner",
         "node_id" : "MDQ6VXNlcjY5NTYx",
         "organizations_url" : "https://api.github.com/users/etscrivner/orgs",
         "received_events_url" : "https://api.github.com/users/etscrivner/received_events",
         "repos_url" : "https://api.github.com/users/etscrivner/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/etscrivner/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/etscrivner/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/etscrivner"
      }
   }
]
