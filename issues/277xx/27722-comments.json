[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I think #27245 which uses `evhttp_connection_set_closecb` is needed to avoid this, but:\r\n- it doesn't seem to be slated for v25.0\r\n- I experience this in one of the libevent versions that #27245 doesn't address",
      "created_at" : "2023-05-23T13:05:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27722#issuecomment-1559296260",
      "id" : 1559296260,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27722",
      "node_id" : "IC_kwDOABII585c8PkE",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1559296260/reactions"
      },
      "updated_at" : "2023-05-23T13:19:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1559296260",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for reporting! I observed this issue sporadically, but were never able to reproduce it until now. With the help of your description (_\"... interrupting bitcoin-cli before it has received the reply ...\"_) I found it's actually quite trivial at least on my machine:\r\n\r\n1. startup `bitcoind -debug=http` (and any other desired flags; note that the hangup also happens without the debug flag, but this allows us to see where it's hanging)\r\n2. execute `bitcoin-cli waitforblockheight 1234567` (or any other RPC call which doesn't terminate immediately)\r\n3. terminate bitcoin-cli via CTRL-C\r\n4. terminate bitcoind via CTRL-C\r\n\r\nThe shutdown leads to the following messages and then hangs forever:\r\n```\r\n2023-05-23T13:58:01Z [http] Unregistering HTTP handler for / (exactmatch 1)\r\n2023-05-23T13:58:01Z [http] Unregistering HTTP handler for /wallet/ (exactmatch 0)\r\n2023-05-23T13:58:01Z [http] Stopping HTTP server\r\n2023-05-23T13:58:01Z [http] Waiting for HTTP worker threads to exit\r\n2023-05-23T13:58:01Z [http] Waiting for 1 requests to stop HTTP server\r\n2023-05-23T13:58:01Z [http] Exited http event loop\r\n2023-05-23T13:58:01Z msghand thread exit\r\n2023-05-23T13:58:01Z net thread exit\r\n2023-05-23T13:58:03Z opencon thread exit\r\n```\r\n\r\nTested on master branch (commit 5ef2c1ee7a7416907e0f9135dc0701a88d92a7f6) with default configuration, running OpenBSD 7.3 with libevent 2.1.12 here.",
      "created_at" : "2023-05-23T14:02:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27722#issuecomment-1559453982",
      "id" : 1559453982,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27722",
      "node_id" : "IC_kwDOABII585c82Ee",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1559453982/reactions"
      },
      "updated_at" : "2023-05-23T14:02:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1559453982",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   }
]
