[
   {
      "author_association" : "MEMBER",
      "body" : "@sipsorcery Any thoughts on this?\r\n\r\nAlso, unrelated, I was wondering how to enable C++17 in appveyor. I.e. how to pass down this option: https://docs.microsoft.com/en-us/cpp/build/reference/std-specify-language-standard-version?view=vs-2019",
      "created_at" : "2020-07-02T13:17:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19431#issuecomment-653000287",
      "id" : 653000287,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19431",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1MzAwMDI4Nw==",
      "updated_at" : "2020-07-02T13:17:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/653000287",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@MarcoFalke the appveyor cache is being used to store dependencies not the build results:\r\n\r\n````\r\ncache:\r\n- C:\\tools\\vcpkg\\installed -> build_msvc\\vcpkg-packages.txt\r\n- C:\\Qt5.9.8_x64_static_vs2019\r\n````\r\n\r\nIf the cache is wiped out by setting `APPVEYOR_SAVE_CACHE_ON_ERROR: false` then the next build after a failure will have to restore all the dependencies. This will more than likely result in the build never being able to complete since restoring dependencies, building Bitcoin Core and running the tests is unlikely to fit within the appveyor time limit (depending on what the time limit currently allocated to Bitcoin Core is). I'd strongly advise against merging this change. After the first failed build it's likely all subsequent appveyor builds will fail with a timeout.\r\n\r\nAt one point [clcache](https://github.com/frerich/clcache) was used to cache the build results but during my testing I was never convinced it reduced the build time (the project seems to be discontinued now so perhaps I wasn't the only one with that finding).\r\n\r\nFor the C++17 build it will need a compiler option set in `common.init.vcxproj`. I can test and submit a PR for that if you like? I can remove the `CLCACHE_SERVER: 1` variable at the same time.",
      "created_at" : "2020-07-02T20:46:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19431#issuecomment-653212928",
      "id" : 653212928,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19431",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1MzIxMjkyOA==",
      "updated_at" : "2020-07-02T20:46:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/653212928",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/197660?v=4",
         "events_url" : "https://api.github.com/users/sipsorcery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipsorcery/followers",
         "following_url" : "https://api.github.com/users/sipsorcery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipsorcery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipsorcery",
         "id" : 197660,
         "login" : "sipsorcery",
         "node_id" : "MDQ6VXNlcjE5NzY2MA==",
         "organizations_url" : "https://api.github.com/users/sipsorcery/orgs",
         "received_events_url" : "https://api.github.com/users/sipsorcery/received_events",
         "repos_url" : "https://api.github.com/users/sipsorcery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipsorcery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipsorcery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipsorcery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> This will more than likely result in the build never being able to complete\r\n\r\nI have concluded the opposite:\r\n\r\n* The same cache is wiped when `build_msvc/vcpkg-packages.txt` changes. So if builds never could succeed from scratch, then how did we get the first compilation to finish? Or how could we change packages in the future if the cache never gets invalidated?\r\n* If a build times out, why would there be any time to upload the cache? I think `APPVEYOR_SAVE_CACHE_ON_ERROR` refers to a build or test error, not a timeout.\r\n* This morning a pull request failed to build and seemingly corrupted the cache. See the picture and links below.\r\n\r\nFirst failure (pull): https://ci.appveyor.com/project/DrahtBot/bitcoin/builds/33856815\r\nFirst passing build (The pull that fixed it by removing the cache): https://ci.appveyor.com/project/DrahtBot/bitcoin/builds/33867492\r\n\r\nInterestingly the first passing build with the invalidated cache took the same time to build as it takes other builds to run, so maybe the cache is not needed after all?\r\n\r\n![Screenshot_2020-07-02 Bitcoin Core - AppVeyor](https://user-images.githubusercontent.com/6399679/86409390-c7af1080-bc86-11ea-8753-06e028bd8968.png)\r\n",
      "created_at" : "2020-07-02T21:15:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19431#issuecomment-653223434",
      "id" : 653223434,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19431",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1MzIyMzQzNA==",
      "updated_at" : "2020-07-02T21:15:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/653223434",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> The same cache is wiped when build_msvc/vcpkg-packages.txt changes. So if builds never could succeed from scratch, then how did we get the first compilation to finish? Or how could we change packages in the future if the cache never gets invalidated?\r\n\r\nIt is/was a juggling act. On my fork I have an [appveyor-force-refresh](https://github.com/sipsorcery/bitcoin/blob/appveyor-force-refresh/.appveyor.yml) branch (bit out of date now) that uses `Exit-AppveyorBuild` after the dependencies are installed that exits the job before the build solely to get the dependency cache set. After that run I'd switch back to `master` and do the build with the dependencies already in the cache.\r\n\r\n> If a build times out, why would there be any time to upload the cache? I think APPVEYOR_SAVE_CACHE_ON_ERROR refers to a build or test error, not a timeout.\r\n\r\nYes you are right my mistake. As per above I used to have to exit the job early to avoid a timeout in order to get the cache updated.\r\n\r\n> Interestingly the first passing build with the invalidated cache took the same time to build as it takes other builds to run, so maybe the cache is not needed after all?\r\n\r\nFrom a quick look at the appveyor job history there was a spike of jobs rebuilding the `vcpkg` dependencies. I suspect, but didn't verify, that a PR changed the `build_msvc\\vcpkg-packages.txt` file and thereby invalidated the `C:\\tools\\vcpkg\\installed` cache entry. The subsequent PR most likely had the original packages file causing it to also invalidate the cache.\r\n\r\nThe following jobs all use the `vcpkg` cache WITHOUT re-generating:\r\n\r\n - `master.22376` 45:21\r\n - `master.22375` 44:19\r\n - `master.22374` 45:27\r\n - `master.22373` 45:51\r\n\r\nThese jobs DID rebuild the `vcpkg` dependencies:\r\n\r\n - `master.22370` 60:04\r\n - `master.22369` 60:03\r\n - `master.22368` 60:02\r\n\r\nSo a consistent 15 minute difference if `vcpkg` dependencies need to be rebuilt. Also the Bitcoin Core appveyor jobs do seem to have more resources than free/personal appveyor accounts. My own appveyor account can't build + test Bitcoin core in under an hour even with the dependencies in the cache.\r\n\r\nBut I know where you're coming from, caches are always a pain precisely because of issues like this. I was obviously a bit melodramatic when I said all builds will fail if this PR is merged. The builds referenced above show they are still passing even when the `vcpkg` dependencies are rebuilt, they just take 15 minutes longer.\r\n\r\nI guess if the cache is causing issues AND the build can still be done under the appveyor time limit it does make sense to remove it. Waiting an hour for a CI job seems like it's too long but if there's a queue of jobs an extra 15 minutes is not noticeable. It would mean free/personal appveyor accounts are unlikely to ever be able to use this script successfully but that's the case now any way.\r\n\r\n",
      "created_at" : "2020-07-02T22:05:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19431#issuecomment-653238774",
      "id" : 653238774,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19431",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1MzIzODc3NA==",
      "updated_at" : "2020-07-02T22:05:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/653238774",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/197660?v=4",
         "events_url" : "https://api.github.com/users/sipsorcery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipsorcery/followers",
         "following_url" : "https://api.github.com/users/sipsorcery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipsorcery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipsorcery",
         "id" : 197660,
         "login" : "sipsorcery",
         "node_id" : "MDQ6VXNlcjE5NzY2MA==",
         "organizations_url" : "https://api.github.com/users/sipsorcery/orgs",
         "received_events_url" : "https://api.github.com/users/sipsorcery/received_events",
         "repos_url" : "https://api.github.com/users/sipsorcery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipsorcery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipsorcery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipsorcery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Oh, I see. I think we got our max timeout raised by staff at some point, which you can also raise in your forked repo.\r\n\r\nLets continue the C++17 discussion in https://github.com/bitcoin/bitcoin/issues/16684#issuecomment-653492781\r\n\r\nClosing this pull for now.",
      "created_at" : "2020-07-03T11:08:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19431#issuecomment-653493043",
      "id" : 653493043,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19431",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1MzQ5MzA0Mw==",
      "updated_at" : "2020-07-03T11:08:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/653493043",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "reopen per https://github.com/bitcoin/bitcoin/issues/19440#issuecomment-653733097",
      "created_at" : "2020-07-04T10:52:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19431#issuecomment-653750968",
      "id" : 653750968,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19431",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1Mzc1MDk2OA==",
      "updated_at" : "2020-07-04T10:52:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/653750968",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Going to merge this to see if it helps with https://github.com/bitcoin/bitcoin/issues/19440#issuecomment-653751251\r\n\r\nIf not, the cache should probably be removed altogether.",
      "created_at" : "2020-07-04T12:39:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19431#issuecomment-653760981",
      "id" : 653760981,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19431",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1Mzc2MDk4MQ==",
      "updated_at" : "2020-07-04T12:39:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/653760981",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK 666686f664b47fae4bf5900e8c4acb808ef73063.",
      "created_at" : "2020-07-04T12:40:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19431#issuecomment-653761111",
      "id" : 653761111,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19431",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1Mzc2MTExMQ==",
      "updated_at" : "2020-07-04T12:40:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/653761111",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/197660?v=4",
         "events_url" : "https://api.github.com/users/sipsorcery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipsorcery/followers",
         "following_url" : "https://api.github.com/users/sipsorcery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipsorcery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipsorcery",
         "id" : 197660,
         "login" : "sipsorcery",
         "node_id" : "MDQ6VXNlcjE5NzY2MA==",
         "organizations_url" : "https://api.github.com/users/sipsorcery/orgs",
         "received_events_url" : "https://api.github.com/users/sipsorcery/received_events",
         "repos_url" : "https://api.github.com/users/sipsorcery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipsorcery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipsorcery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipsorcery"
      }
   }
]
