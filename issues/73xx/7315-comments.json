[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Is this still an issue?",
      "created_at" : "2018-09-10T20:12:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/7315#issuecomment-420044571",
      "id" : 420044571,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyMDA0NDU3MQ==",
      "updated_at" : "2018-09-10T20:12:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/420044571",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/45598?v=4",
         "events_url" : "https://api.github.com/users/jb55/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jb55/followers",
         "following_url" : "https://api.github.com/users/jb55/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jb55/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jb55",
         "id" : 45598,
         "login" : "jb55",
         "node_id" : "MDQ6VXNlcjQ1NTk4",
         "organizations_url" : "https://api.github.com/users/jb55/orgs",
         "received_events_url" : "https://api.github.com/users/jb55/received_events",
         "repos_url" : "https://api.github.com/users/jb55/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jb55/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jb55/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jb55"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Would be nice to have a test case for this to know that either\r\n\r\n* the bug still exists and should be fixed\r\n* the bug is fixed and can not be reintroduced in the future",
      "created_at" : "2019-07-29T19:30:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/7315#issuecomment-516129933",
      "id" : 516129933,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxNjEyOTkzMw==",
      "updated_at" : "2019-07-29T19:30:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/516129933",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "I would like to try and take this on. First off, I'm a new contributor, I've been working at the application layer of bitcoin for a couple years now, but this is my first dive into the implementation details of core.\r\n\r\nAs such, if you have any suggestions about specific files to look at, or a clarification of the following terminology, it would help me immensely in being able to answer A. whether it exists still, and B. a test that can ensure it is not reintroduced.\r\n\r\n1. What is a \"conflicted transaction\" formally?\r\n2. What is a \"wallet tx\" and how/when would it not appear in the mempool?\r\n3. What does it mean to mark a transaction as \"dirty\"\r\n\r\nI will do my best to find out the answers to these questions on my own but any references to which files this logic is contained in or definitions for the terms above would jumpstart my ability to figure this out.",
      "created_at" : "2019-08-03T18:36:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/7315#issuecomment-517945730",
      "id" : 517945730,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxNzk0NTczMA==",
      "updated_at" : "2019-08-03T18:36:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/517945730",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/4033651?v=4",
         "events_url" : "https://api.github.com/users/CaptJakk/events{/privacy}",
         "followers_url" : "https://api.github.com/users/CaptJakk/followers",
         "following_url" : "https://api.github.com/users/CaptJakk/following{/other_user}",
         "gists_url" : "https://api.github.com/users/CaptJakk/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/CaptJakk",
         "id" : 4033651,
         "login" : "CaptJakk",
         "node_id" : "MDQ6VXNlcjQwMzM2NTE=",
         "organizations_url" : "https://api.github.com/users/CaptJakk/orgs",
         "received_events_url" : "https://api.github.com/users/CaptJakk/received_events",
         "repos_url" : "https://api.github.com/users/CaptJakk/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/CaptJakk/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/CaptJakk/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/CaptJakk"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Closing this issue. It still exists but behavior has changed in various ways. There are also different fixes possible other than the one suggested. Best current description of the problem and possible fixes is [*bug-reorg-spent*](https://github.com/bitcoin-core/bitcoin-devwiki/wiki/Wallet-Transaction-Conflict-Tracking#bug-reorg-spent).\r\n\r\nBelow is the original issue description annotated with details of what's changed since this was reported.\r\n\r\n---\r\n\r\nre: https://github.com/bitcoin/bitcoin/issues/7315#issue-125542715\r\n\r\n> In 0.12, a wallet tx thats not in the mempool does not free up its inputs.\r\n\r\nSpecifically, this started in #7105 with `GetDepthInMainChain` no longer returning -1 for transactions not in the mempool.\r\n\r\n> So if a tx spends the same inputs as a conflict tx included in a new block, its inputs are explicitly marked dirty so they will be recalculated as spendable again due to having no non-conflicted spends. However if the in-block conflict is reorged out, the wallet txs inputs should now be market spent again according to the 0.12 regime, but they are not marked dirty as the tx itself is not notified it is no longer conflicted.\r\n\r\nThis is because there's no code in the disconnect block notification handler to update the transaction state and clear the stale conflicting block pointer during the reorg. But there's no reason this code couldn't be written, and ideas for implementing it are suggested in [*bug-stale-conflicted*](https://github.com/bitcoin-core/bitcoin-devwiki/wiki/Wallet-Transaction-Conflict-Tracking#bug-stale-conflicted).\r\n\r\nSince this issue was first reported the problem was mitigated somewhat by https://github.com/bitcoin/bitcoin/pull/16624/commits/40ede992d97df38282919693dfe851c975c3b1d8 from #16624. There are still bugs immediately after the reorg, but they are fixed if the wallet is unloaded and reloaded.\r\n\r\n> This has the odd effect that the cached value is incorrect and so randomly they will be spendable or not depending on whether they have been recalculated.\r\n\r\nAt the time this issue was opened, the problem was limited to the stale cache issue described, because the `GetDepthInMainChain` implementation then would check that the conflicting block pointer was part of the active chain before trusting it. However in https://github.com/bitcoin/bitcoin/pull/15931/commits/0ff03871add000f8b4d8f82aeb168eed2fc9dc5f from https://github.com/bitcoin/bitcoin/pull/15931, this check was removed, so the problem now goes beyond cached balances and can affect non-cached balances and other wallet operations.\r\n\r\n> This is easy enough to fix by marking all inputs of all txs in SyncTransaction dirty regardless of whether AddToWalletIfInvolvingMe returns true or false. But I'm not sure the performance impact this will have, so I'm not proposing that change now.\r\n\r\nSome other fixes are possible now, and probably preferable. See [*bug-reorg-spent*](https://github.com/bitcoin-core/bitcoin-devwiki/wiki/Wallet-Transaction-Conflict-Tracking#bug-reorg-spent).\r\n\r\n> It's a minor issue, but I just thought I'd document that that the cached credit available in wallet txs may not always be correct.\r\n>\r\n> For reference, in 0.11, whenever a tx left the mempool it's inputs were respendable. So if a tx was removed due to a conflict in a block, any remaining inputs would be spendable again. If the in-block conflict was later reorged out, the wallet txs inputs would remain spendable unless and until the wallet tx reentered the mempool.",
      "created_at" : "2021-01-07T17:13:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/7315#issuecomment-756252923",
      "id" : 756252923,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1NjI1MjkyMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-07T17:13:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/756252923",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   }
]
