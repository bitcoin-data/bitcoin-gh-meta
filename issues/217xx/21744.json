{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "CONTRIBUTOR",
   "body" : "Adverse scenario:\r\n\r\n1. thread \"net\"\r\n```\r\nCConnman::ThreadSocketHandler()\r\n  CConnman::SocketHandler()\r\n    CConnman::SocketEvents()\r\n      CConnman::GenerateSelectSet()\r\n        Cycles through CConnman::vNodes and remembers some sockets to\r\n        be polled for readiness later by CConnman::SocketEvents().\r\n        Lets say socket (file descriptor) 10 is remembered.\r\n```\r\n\r\n2. thread \"msghand\"\r\n```\r\nCConnman::ThreadMessageHandler()\r\n  PeerManagerImpl::ProcessMessages()\r\n    PeerManagerImpl::ProcessMessage()\r\n      PeerManagerImpl::PushNodeVersion()\r\n        CConnman::PushMessage()\r\n          CConnman::SocketSendData()\r\n            CNode::CloseSocketDisconnect()\r\n              Closes socket 10.\r\n```\r\n\r\n3. thread \"opencon\"\r\n```\r\nCConnman::ThreadOpenConnections()\r\n  CConnman::OpenNetworkConnection()\r\n    CConnman::ConnectNode()\r\n      CreateSock()\r\n        Creates a new socket, reusing file descriptor 10.\r\n```\r\n\r\n4. thread \"net\"\r\n```\r\nCConnman::ThreadSocketHandler()\r\n  CConnman::SocketHandler()\r\n    CConnman::SocketEvents()\r\n      polls the remembered socket 10, which corresponds to a different\r\n      connection now (bug)\r\n```\r\n\r\nAs a result the following logic may not hold:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/e16f8720dca2de1040478968c9f3ca07644a04b7/src/net.cpp#L1306-L1315\r\n\r\nI think the severity of this is low and that it has a low chance of happening. However the pattern of \"remember a socket by its file descriptor number and use it later, concurrently with other threads that might close it\" better be avoided. That pattern could lead to closing or writing to the wrong socket which would be more severe.\r\n",
   "closed_at" : "2022-06-16T18:05:16Z",
   "closed_by" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
      "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
      "followers_url" : "https://api.github.com/users/laanwj/followers",
      "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/laanwj",
      "id" : 126646,
      "login" : "laanwj",
      "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
      "organizations_url" : "https://api.github.com/users/laanwj/orgs",
      "received_events_url" : "https://api.github.com/users/laanwj/received_events",
      "repos_url" : "https://api.github.com/users/laanwj/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/laanwj"
   },
   "comments" : 5,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21744/comments",
   "created_at" : "2021-04-21T15:13:18Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21744/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/21744",
   "id" : 863997737,
   "labels" : [
      {
         "color" : "FBBAAB",
         "default" : false,
         "description" : null,
         "id" : 64585,
         "name" : "Bug",
         "node_id" : "MDU6TGFiZWw2NDU4NQ==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Bug"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21744/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDU6SXNzdWU4NjM5OTc3Mzc=",
   "number" : 21744,
   "performed_via_github_app" : null,
   "reactions" : {
      "+1" : 0,
      "-1" : 0,
      "confused" : 0,
      "eyes" : 0,
      "heart" : 0,
      "hooray" : 0,
      "laugh" : 0,
      "rocket" : 0,
      "total_count" : 0,
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21744/reactions"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "state_reason" : "completed",
   "timeline_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21744/timeline",
   "title" : "CConnman::SocketEvents() may poll the wrong socket",
   "updated_at" : "2022-06-16T18:05:16Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21744",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
      "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
      "followers_url" : "https://api.github.com/users/vasild/followers",
      "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/vasild",
      "id" : 266751,
      "login" : "vasild",
      "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
      "organizations_url" : "https://api.github.com/users/vasild/orgs",
      "received_events_url" : "https://api.github.com/users/vasild/received_events",
      "repos_url" : "https://api.github.com/users/vasild/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/vasild"
   }
}
