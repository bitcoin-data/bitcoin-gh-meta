[
   {
      "author_association" : "MEMBER",
      "body" : "\"Flush\" is somewhat poor terminology here. The data is always flushed to disk after each write. When Bitcoin Core believes the data is written to disk, it is actually written disk somewhere. The \"flushing\" in this context is actually compacting the wallet database so that everything is in the main database file. Without this \"flushing\", some wallet data will be written to a database log file (BDB uses write ahead logging). In the event of a power loss or other sudden software abort, the data should remain in those files and can be retrieved if Bitcoin Core is started normally. There is only an issue if *only* the wallet.dat file is copied to somewhere else following the crash event. In that case, the database log files will be missing when the wallet.dat file is loaded and so data is lost. So long as you also copy (and backup) the database log files, then you will be fine to use `-flushwallet=0`.",
      "created_at" : "2021-04-22T23:14:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21760#issuecomment-825250830",
      "id" : 825250830,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21760",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyNTI1MDgzMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-22T23:14:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/825250830",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> \"Flush\" is somewhat poor terminology here. The data is always flushed to disk after each write. When Bitcoin Core believes the data is written to disk, it is actually written disk somewhere. The \"flushing\" in this context is actually compacting the wallet database so that everything is in the main database file. Without this \"flushing\", some wallet data will be written to a database log file (BDB uses write ahead logging). In the event of a power loss or other sudden software abort, the data should remain in those files and can be retrieved if Bitcoin Core is started normally. There is only an issue if _only_ the wallet.dat file is copied to somewhere else following the crash event. In that case, the database log files will be missing when the wallet.dat file is loaded and so data is lost. So long as you also copy (and backup) the database log files, then you will be fine to use `-flushwallet=0`.\r\n\r\nI make backups with restic and copy entire walletdir during backup (which includes wallet.dat and log files), however in some scenarios (like filesystem writeback cache, for example, log file can be corrupted during power loss), especially with #18923 (If I understand correctly, transactions will be accumulated in log files until wallet finishes normally) I would prefer to have less transactions in log files and more in wallet.dat (for example flush data to wallet.dat each 2-3-5 min would be great). I think that in case of big wallet write transactions to wallet.dat every 500ms is a bad idea, at same time not to write them at all is also bad practice ð¤·ââï¸ It's like MySQL which makes sql dump each 500ms or stores all data in binlog until restart)",
      "created_at" : "2021-04-22T23:27:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21760#issuecomment-825265609",
      "id" : 825265609,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21760",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyNTI2NTYwOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-22T23:48:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/825265609",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1939459?v=4",
         "events_url" : "https://api.github.com/users/Brightside56/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Brightside56/followers",
         "following_url" : "https://api.github.com/users/Brightside56/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Brightside56/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Brightside56",
         "id" : 1939459,
         "login" : "Brightside56",
         "node_id" : "MDQ6VXNlcjE5Mzk0NTk=",
         "organizations_url" : "https://api.github.com/users/Brightside56/orgs",
         "received_events_url" : "https://api.github.com/users/Brightside56/received_events",
         "repos_url" : "https://api.github.com/users/Brightside56/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Brightside56/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Brightside56/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Brightside56"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nNo conflicts as of last run.",
      "created_at" : "2021-04-23T04:16:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21760#issuecomment-825373304",
      "id" : 825373304,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21760",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyNTM3MzMwNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-27T17:29:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/825373304",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "I will send resolve commit for #19101 if merged",
      "created_at" : "2021-04-25T00:12:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21760#issuecomment-826170374",
      "id" : 826170374,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21760",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyNjE3MDM3NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-25T00:12:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/826170374",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1939459?v=4",
         "events_url" : "https://api.github.com/users/Brightside56/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Brightside56/followers",
         "following_url" : "https://api.github.com/users/Brightside56/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Brightside56/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Brightside56",
         "id" : 1939459,
         "login" : "Brightside56",
         "node_id" : "MDQ6VXNlcjE5Mzk0NTk=",
         "organizations_url" : "https://api.github.com/users/Brightside56/orgs",
         "received_events_url" : "https://api.github.com/users/Brightside56/received_events",
         "repos_url" : "https://api.github.com/users/Brightside56/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Brightside56/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Brightside56/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Brightside56"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "@achow101  I've built binaries and performed simple test:\r\n1. Run bitcoind node regtest built from my PR\r\n2. Mine some coins, create some addresses and sent some TX to have some data in wallet (to be able to create visible load during flushing), wallet is 70MB now (about 45K of blocks, 50K addresses).\r\n3. Run script which is creating new address every 5 sec. First pass with `-flushinterval=500` (500ms - default), second pass with `-flushinterval=120000` (120s)\r\n\r\n![Screenshot from 2021-04-26 01-02-09](https://user-images.githubusercontent.com/1939459/116011006-3e106b00-a62b-11eb-82c7-9f7aaa071303.png)\r\n\r\nDisk load is much lower, and I think it's much more acceptable behaviour (for my case of course, someone else can set anything else). In situation where last log file gets corrupted, it will be unpleasant, but nothing fatal will happen. ",
      "created_at" : "2021-04-25T22:07:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21760#issuecomment-826397531",
      "id" : 826397531,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21760",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyNjM5NzUzMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-25T22:13:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/826397531",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1939459?v=4",
         "events_url" : "https://api.github.com/users/Brightside56/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Brightside56/followers",
         "following_url" : "https://api.github.com/users/Brightside56/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Brightside56/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Brightside56",
         "id" : 1939459,
         "login" : "Brightside56",
         "node_id" : "MDQ6VXNlcjE5Mzk0NTk=",
         "organizations_url" : "https://api.github.com/users/Brightside56/orgs",
         "received_events_url" : "https://api.github.com/users/Brightside56/received_events",
         "repos_url" : "https://api.github.com/users/Brightside56/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Brightside56/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Brightside56/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Brightside56"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Hm... Even with `-flushwallet=0` DB is compacting from time to time. Where in sources can I find DB compaction logic?",
      "created_at" : "2021-04-25T23:23:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21760#issuecomment-826413037",
      "id" : 826413037,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21760",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyNjQxMzAzNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-25T23:23:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/826413037",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1939459?v=4",
         "events_url" : "https://api.github.com/users/Brightside56/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Brightside56/followers",
         "following_url" : "https://api.github.com/users/Brightside56/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Brightside56/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Brightside56",
         "id" : 1939459,
         "login" : "Brightside56",
         "node_id" : "MDQ6VXNlcjE5Mzk0NTk=",
         "organizations_url" : "https://api.github.com/users/Brightside56/orgs",
         "received_events_url" : "https://api.github.com/users/Brightside56/received_events",
         "repos_url" : "https://api.github.com/users/Brightside56/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Brightside56/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Brightside56/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Brightside56"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Yes, \"flush\" is a terrible name. It should really be called \"compact\", as the goal is to merge into one `.dat` file.\r\n\r\nThat said, the logic is in `MaybeCompactWalletDB()` which calls the unfortunately named `BerkeleyDatabase::PeriodicFlush()`. Mind that Sqlite has no equivalent functionality, so if you create a new-style wallet, you will get rid of this problem as well.",
      "created_at" : "2021-05-05T13:38:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21760#issuecomment-832694640",
      "id" : 832694640,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21760",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgzMjY5NDY0MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-05T13:38:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/832694640",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "@laanwj With my setup I have no option to create new wallet or migrate to SQLite( Also if I understand correctly, SQLite isn't production ready in bitcoind and needs massive investigation from point of performance, right? Are there additional options to manage `BerkeleyDatabase::PeriodicFlush()` intervals (when I set `-flushwallet=0`, compaction still happens from time to time)?",
      "created_at" : "2021-05-06T09:31:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21760#issuecomment-833382091",
      "id" : 833382091,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21760",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgzMzM4MjA5MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-08T00:18:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/833382091",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1939459?v=4",
         "events_url" : "https://api.github.com/users/Brightside56/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Brightside56/followers",
         "following_url" : "https://api.github.com/users/Brightside56/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Brightside56/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Brightside56",
         "id" : 1939459,
         "login" : "Brightside56",
         "node_id" : "MDQ6VXNlcjE5Mzk0NTk=",
         "organizations_url" : "https://api.github.com/users/Brightside56/orgs",
         "received_events_url" : "https://api.github.com/users/Brightside56/received_events",
         "repos_url" : "https://api.github.com/users/Brightside56/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Brightside56/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Brightside56/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Brightside56"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> (when I set -flushwallet=0, compaction still happens from time to time)?\r\n\r\nIt would be good to fix it instead of adding another option.\r\n#18923 was the last PR to touch that AFAIK",
      "created_at" : "2021-05-14T13:39:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21760#issuecomment-841250801",
      "id" : 841250801,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21760",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0MTI1MDgwMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-14T13:39:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/841250801",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> > (when I set -flushwallet=0, compaction still happens from time to time)?\r\n> \r\n> It would be good to fix it instead of adding another option.\r\n> #18923 was the last PR to touch that AFAIK\r\n\r\nI checked this PR and see that `MaybeCompactWalletDB` should work properly (never to be called with `-flushwallet=0`), but as I see, bdb has some kind of magic which can trigger log flush at any moment. \r\n\r\n![Screenshot from 2021-05-17 21-43-37](https://user-images.githubusercontent.com/1939459/118540243-1491bd80-b759-11eb-8534-887228a1a031.png)\r\n\r\nAs I see from bdb docs there are no configuration options to affect this behaviour safely.",
      "created_at" : "2021-05-17T18:49:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21760#issuecomment-842551391",
      "id" : 842551391,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21760",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0MjU1MTM5MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-17T18:49:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/842551391",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1939459?v=4",
         "events_url" : "https://api.github.com/users/Brightside56/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Brightside56/followers",
         "following_url" : "https://api.github.com/users/Brightside56/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Brightside56/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Brightside56",
         "id" : 1939459,
         "login" : "Brightside56",
         "node_id" : "MDQ6VXNlcjE5Mzk0NTk=",
         "organizations_url" : "https://api.github.com/users/Brightside56/orgs",
         "received_events_url" : "https://api.github.com/users/Brightside56/received_events",
         "repos_url" : "https://api.github.com/users/Brightside56/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Brightside56/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Brightside56/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Brightside56"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Closing this PR, as the conclusion was that there is no way to get around this behavior at all, so adding this option wouldn't fix the underlying issue.",
      "created_at" : "2021-06-03T15:12:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21760#issuecomment-853946099",
      "id" : 853946099,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21760",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1Mzk0NjA5OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-03T15:12:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/853946099",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   }
]
