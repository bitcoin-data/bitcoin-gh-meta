[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "This is surprisingly difficult to fix (without doing huge amount of changes). I see two ways to address it:\r\n\r\n1. Hold the socket mutex while `poll()`ing, so that other threads that want to close the socket would have to wait for the `poll()` to finish. Not acceptable IMO.\r\n2. Lazy close with reference counting. Increment the reference count of the socket during `poll()`. Whenever a thread wants to close the socket (disconnect a peer) it should disable the socket for send/recv (e.g. `shutdown(2)`) but not `close(2)` it if reference count is >0 and somebody else should close all disabled sockets with reference count of 0.",
      "created_at" : "2021-05-12T09:30:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/21744#issuecomment-839619709",
      "id" : 839619709,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21744",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgzOTYxOTcwOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-12T09:30:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/839619709",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@vasild \r\n\r\nInteresting find! Thanks for reporting.\r\n\r\nMay I ask how you found this issue?\r\n\r\nWas it found as part of the `Sock` encapsulation project, or a related fuzzing find? :)\r\n\r\nImpressive find either way.",
      "created_at" : "2021-05-12T09:43:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/21744#issuecomment-839632483",
      "id" : 839632483,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21744",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgzOTYzMjQ4Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-12T09:43:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/839632483",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Was it found as part of the `Sock` encapsulation project...\r\n\r\nCorrect! :)\r\n\r\nIn https://github.com/bitcoin/bitcoin/pull/21878, while replacing `SOCKET` with `Sock` in `CConnman::SocketEvents()` one option was to keep pointers to the `Sock` objects and close the sockets by destroying those objects, but (because of this bug) this would have ended up with dangling pointers, pointing to possibly-deleted-by-other-threads objects.\r\n\r\nThis is the reason that PR keeps the `Sock` objects alive and calls `Sock::Reset()` from `CNode::CloseSocketDisconnect()` instead of something like `delete m_sock`.",
      "created_at" : "2021-05-12T10:14:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/21744#issuecomment-839653043",
      "id" : 839653043,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21744",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgzOTY1MzA0Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-12T10:14:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/839653043",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Hmm, maybe the following changes in https://github.com/bitcoin/bitcoin/pull/21878 would fix this bug elegantly (doing the [lazy close](https://github.com/bitcoin/bitcoin/issues/21744#issuecomment-839619709) I mentioned above):\r\n* Change `CNode::m_sock` from `std::unique_ptr<Sock>` to `std::shared_ptr<Sock>`.\r\n* In `CNode::CloseSocketDisconnect()` do `m_sock.reset()` (reducing the ref count stored in the shared_ptr and destroying the `Sock` object if ref count is 0).\r\n* Take a copy of `std::shared_ptr<Sock>` in `CConnman::SocketEvents()` or its replacement `Sock::WaitMany()`. The copy will automatically keep the ref count >0 during `poll()`.\r\n\r\nI will consider this more carefully.",
      "created_at" : "2021-05-12T10:27:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/21744#issuecomment-839661385",
      "id" : 839661385,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21744",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgzOTY2MTM4NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-12T10:27:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/839661385",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> maybe the following changes in #21878 would fix this bug elegantly...\r\n\r\nDone. In addition to the above, `CConnman::ListenSocket::sock` also had to be changed from `unique_ptr` to `shared_ptr` because we feed those sockets to `Sock::WaitMany()` too.\r\n\r\nThis issue is now resolved by commit `net: use Sock::WaitMany() instead of CConnman::SocketEvents()` in https://github.com/bitcoin/bitcoin/pull/21878.",
      "created_at" : "2021-05-31T10:19:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/21744#issuecomment-851388148",
      "id" : 851388148,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21744",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1MTM4ODE0OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-31T10:19:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/851388148",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   }
]
