[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#17477](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/17477.html) (Remove the mempool's NotifyEntryAdded and NotifyEntryRemoved signals by jnewbery)\n* [#15606](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15606.html) ([experimental] UTXO snapshots by jamesob)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-01-17T17:28:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17951#issuecomment-575720638",
      "id" : 575720638,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17951",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3NTcyMDYzOA==",
      "updated_at" : "2020-01-17T17:28:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/575720638",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17951#discussion_r368078174"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17951"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/368078174"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: I presume this makes some kind of doc tools unhappy cause they will add docs to the cs and not the var.",
      "commit_id" : "a029e18c2bf67dd00552b0f4bbc85fa2fa5b973b",
      "created_at" : "2020-01-17T18:36:30Z",
      "diff_hunk" : "@@ -148,6 +148,14 @@ namespace {\n     std::unique_ptr<CRollingBloomFilter> recentRejects GUARDED_BY(cs_main);\n     uint256 hashRecentRejectsChainTip GUARDED_BY(cs_main);\n \n+    /**\n+     * Filter for transactions that have been recently confirmed.\n+     * We use this to avoid requesting transactions that have already been\n+     * confirnmed.\n+     */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17951#discussion_r368078174",
      "id" : 368078174,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA3ODE3NA==",
      "original_commit_id" : "1e9697bed83332f6aa1d2579dc7638fdb4785477",
      "original_position" : 8,
      "path" : "src/net_processing.cpp",
      "position" : 8,
      "pull_request_review_id" : 344765847,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17951",
      "updated_at" : "2020-01-29T14:38:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/368078174",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17951#discussion_r368246927"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17951"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/368246927"
         }
      },
      "author_association" : "NONE",
      "body" : "should the parameters to the bloom filter be tunnable with commandline args?",
      "commit_id" : "a029e18c2bf67dd00552b0f4bbc85fa2fa5b973b",
      "created_at" : "2020-01-18T20:30:01Z",
      "diff_hunk" : "@@ -1115,6 +1123,7 @@ PeerLogicValidation::PeerLogicValidation(CConnman* connmanIn, BanMan* banman, CS\n {\n     // Initialize global variables that cannot be constructed at startup.\n     recentRejects.reset(new CRollingBloomFilter(120000, 0.000001));\n+    recent_confirmed_transactions.reset(new CRollingBloomFilter(24000, 0.000001));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17951#discussion_r368246927",
      "id" : 368246927,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI0NjkyNw==",
      "original_commit_id" : "1e9697bed83332f6aa1d2579dc7638fdb4785477",
      "original_position" : 19,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 344961255,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17951",
      "updated_at" : "2020-01-29T14:38:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/368246927",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1986950?v=4",
         "events_url" : "https://api.github.com/users/paymog/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paymog/followers",
         "following_url" : "https://api.github.com/users/paymog/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paymog/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paymog",
         "id" : 1986950,
         "login" : "paymog",
         "node_id" : "MDQ6VXNlcjE5ODY5NTA=",
         "organizations_url" : "https://api.github.com/users/paymog/orgs",
         "received_events_url" : "https://api.github.com/users/paymog/received_events",
         "repos_url" : "https://api.github.com/users/paymog/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paymog/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paymog/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paymog"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17951#discussion_r368255598"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17951"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/368255598"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I can't imagine why anyone would need to customize this parameter (it's not like we offered the ability to customize how many outputs we'd check in the cache, or the ability to customize the recentRejects filter).",
      "commit_id" : "a029e18c2bf67dd00552b0f4bbc85fa2fa5b973b",
      "created_at" : "2020-01-19T00:01:52Z",
      "diff_hunk" : "@@ -1115,6 +1123,7 @@ PeerLogicValidation::PeerLogicValidation(CConnman* connmanIn, BanMan* banman, CS\n {\n     // Initialize global variables that cannot be constructed at startup.\n     recentRejects.reset(new CRollingBloomFilter(120000, 0.000001));\n+    recent_confirmed_transactions.reset(new CRollingBloomFilter(24000, 0.000001));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17951#discussion_r368255598",
      "id" : 368255598,
      "in_reply_to_id" : 368246927,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI1NTU5OA==",
      "original_commit_id" : "1e9697bed83332f6aa1d2579dc7638fdb4785477",
      "original_position" : 19,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 344968325,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17951",
      "updated_at" : "2020-01-29T14:38:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/368255598",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17951#discussion_r368259951"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17951"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/368259951"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: Globals should start with `g_` otherwise it might incorrectly look like they live on the stack (as opposed to the heap)",
      "commit_id" : "a029e18c2bf67dd00552b0f4bbc85fa2fa5b973b",
      "created_at" : "2020-01-19T02:10:34Z",
      "diff_hunk" : "@@ -148,6 +148,14 @@ namespace {\n     std::unique_ptr<CRollingBloomFilter> recentRejects GUARDED_BY(cs_main);\n     uint256 hashRecentRejectsChainTip GUARDED_BY(cs_main);\n \n+    /**\n+     * Filter for transactions that have been recently confirmed.\n+     * We use this to avoid requesting transactions that have already been\n+     * confirnmed.\n+     */\n+    RecursiveMutex cs_recent_confirmed_transactions;\n+    std::unique_ptr<CRollingBloomFilter> recent_confirmed_transactions GUARDED_BY(cs_recent_confirmed_transactions);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17951#discussion_r368259951",
      "id" : 368259951,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI1OTk1MQ==",
      "original_commit_id" : "1e9697bed83332f6aa1d2579dc7638fdb4785477",
      "original_position" : 10,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 344971755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17951",
      "updated_at" : "2020-01-29T14:38:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/368259951",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Is clearing when disconnecting necessary? The disconnected transactions are at least considered for re-inclusing into the mempool, so even if they don't make it in, wouldn't it make sense to keep considering them \"known\"?\r\n\r\nI agree that clearing when disconnecting is the safe bet if we're not entirely sure about this.",
      "created_at" : "2020-01-19T15:52:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17951#issuecomment-576018447",
      "id" : 576018447,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17951",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3NjAxODQ0Nw==",
      "updated_at" : "2020-01-19T15:52:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/576018447",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "A reorg might change MTP and some mempool checks might depend on that time. So if the reorg changes MTP and \"forgets\" to include a tx that was previously included in a block, it is now neither in the chain, nor in the mempool, nor can it be relayed.",
      "created_at" : "2020-01-19T16:37:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17951#issuecomment-576022423",
      "id" : 576022423,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17951",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3NjAyMjQyMw==",
      "updated_at" : "2020-01-19T16:37:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/576022423",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@sipa Yes I think something like @MarcoFalke's example is right, or even for a simple example of something that is added back to the mempool as part of the reorg but then evicted when the mempool is trimmed (due to feerate).  Unlike the recentRejects filter which is cleared every block, the recent_confirmed_transactions is (otherwise) never cleared, so something that gets inadvertently stuck in it will interfere with relay for an extended period of time, depending on the size of the filter.\r\n\r\nIt's worth noting that if there is a false positive, it may persist for many blocks (unlike in the recentRejects filter).  My thought was that because this would not be a synchronized event over the network that this is ok...  But perhaps the choice of false positive rate is worth further thought?",
      "created_at" : "2020-01-19T17:08:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17951#issuecomment-576025217",
      "id" : 576025217,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17951",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3NjAyNTIxNw==",
      "updated_at" : "2020-01-19T17:08:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/576025217",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17951#discussion_r369287532"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17951"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/369287532"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "To avoid the same false positive hitting most of the network at once, why not randomly clear `recent_confirmed_transactions` ? Or this should happen more or less with current rate of 1-block reorgs?",
      "commit_id" : "a029e18c2bf67dd00552b0f4bbc85fa2fa5b973b",
      "created_at" : "2020-01-21T22:53:35Z",
      "diff_hunk" : "@@ -1129,36 +1138,59 @@ PeerLogicValidation::PeerLogicValidation(CConnman* connmanIn, BanMan* banman, CS\n  * Evict orphan txn pool entries (EraseOrphanTx) based on a newly connected\n  * block. Also save the time of the last tip update.\n  */\n-void PeerLogicValidation::BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex* pindex, const std::vector<CTransactionRef>& vtxConflicted) {\n-    LOCK(g_cs_orphans);\n+void PeerLogicValidation::BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex* pindex, const std::vector<CTransactionRef>& vtxConflicted)\n+{\n+    {\n+        LOCK(g_cs_orphans);\n \n-    std::vector<uint256> vOrphanErase;\n+        std::vector<uint256> vOrphanErase;\n \n-    for (const CTransactionRef& ptx : pblock->vtx) {\n-        const CTransaction& tx = *ptx;\n+        for (const CTransactionRef& ptx : pblock->vtx) {\n+            const CTransaction& tx = *ptx;\n \n-        // Which orphan pool entries must we evict?\n-        for (const auto& txin : tx.vin) {\n-            auto itByPrev = mapOrphanTransactionsByPrev.find(txin.prevout);\n-            if (itByPrev == mapOrphanTransactionsByPrev.end()) continue;\n-            for (auto mi = itByPrev->second.begin(); mi != itByPrev->second.end(); ++mi) {\n-                const CTransaction& orphanTx = *(*mi)->second.tx;\n-                const uint256& orphanHash = orphanTx.GetHash();\n-                vOrphanErase.push_back(orphanHash);\n+            // Which orphan pool entries must we evict?\n+            for (const auto& txin : tx.vin) {\n+                auto itByPrev = mapOrphanTransactionsByPrev.find(txin.prevout);\n+                if (itByPrev == mapOrphanTransactionsByPrev.end()) continue;\n+                for (auto mi = itByPrev->second.begin(); mi != itByPrev->second.end(); ++mi) {\n+                    const CTransaction& orphanTx = *(*mi)->second.tx;\n+                    const uint256& orphanHash = orphanTx.GetHash();\n+                    vOrphanErase.push_back(orphanHash);\n+                }\n             }\n         }\n-    }\n \n-    // Erase orphan transactions included or precluded by this block\n-    if (vOrphanErase.size()) {\n-        int nErased = 0;\n-        for (const uint256& orphanHash : vOrphanErase) {\n-            nErased += EraseOrphanTx(orphanHash);\n+        // Erase orphan transactions included or precluded by this block\n+        if (vOrphanErase.size()) {\n+            int nErased = 0;\n+            for (const uint256& orphanHash : vOrphanErase) {\n+                nErased += EraseOrphanTx(orphanHash);\n+            }\n+            LogPrint(BCLog::MEMPOOL, \"Erased %d orphan tx included or conflicted by block\\n\", nErased);\n+        }\n+\n+        g_last_tip_update = GetTime();\n+    }\n+    {\n+        LOCK(cs_recent_confirmed_transactions);\n+        for (const auto ptx : pblock->vtx) {\n+            recent_confirmed_transactions->insert(ptx->GetHash());\n         }\n-        LogPrint(BCLog::MEMPOOL, \"Erased %d orphan tx included or conflicted by block\\n\", nErased);\n     }\n+}\n \n-    g_last_tip_update = GetTime();\n+void PeerLogicValidation::BlockDisconnected(const std::shared_ptr<const CBlock> &block, const CBlockIndex* pindex)\n+{\n+    // To avoid relay problems with transactions that were previously\n+    // confirmed, clear our filter of recently confirmed transactions whenever\n+    // there's a reorg.\n+    // This means that in a 1-block reorg (where 1 block is disconnected and\n+    // then another block reconnected), our filter will drop to having only one\n+    // block's worth of transactions in it, but that should be fine, since\n+    // presumably the most common case of relaying a confirmed transaction\n+    // should be just after a new block containing it is found.\n+    LOCK(cs_recent_confirmed_transactions);\n+    recent_confirmed_transactions->reset();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17951#discussion_r369287532",
      "id" : 369287532,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI4NzUzMg==",
      "original_commit_id" : "1e9697bed83332f6aa1d2579dc7638fdb4785477",
      "original_position" : 100,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 346248173,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17951",
      "updated_at" : "2020-01-29T14:38:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/369287532",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Discussed this a bit with @marcofalke yesterday, and after further thought, I think the false positive rate for this filter should be fine.  The only use case that I think could be somewhat materially impacted would be if you have a bitcoind node acting as a gateway to the network, and a wallet behind it that is broadcasting transactions through it, then it's possible that a false positive in this filter would prevent transaction relay for several blocks, which seems unfortunate.\r\n\r\nHowever, in thinking about this, transaction relay in this situation appears to already be broken in the case of a false positive in the recentRejects filter, because ever since #8082 I believe we never actually relay anything not in our mempool, breaking relay of transactions from whitelisted peers that are supposed to go out even if not accepted to our mempool.  So if we want this behavior, we should separately fix it for both the reject filter and this new filter.  (Note: I haven't actually tested to verify that claim, but just from looking at the code, I can't see how it could possibly work.  Maybe someone else can corroborate this view?) ",
      "created_at" : "2020-01-22T13:51:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17951#issuecomment-577190960",
      "id" : 577190960,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17951",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3NzE5MDk2MA==",
      "updated_at" : "2020-01-22T13:51:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/577190960",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17951#discussion_r369571564"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17951"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/369571564"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The goal is to not clear this filter, so that we have the last N (6-12?) blocks' worth of transactions in the filter, to avoid wasting bandwidth.\r\n\r\nFalse positives should already not be synchronized across the network because every filter is seeded with randomness, so no two nodes have the same filter calculations.",
      "commit_id" : "a029e18c2bf67dd00552b0f4bbc85fa2fa5b973b",
      "created_at" : "2020-01-22T13:55:16Z",
      "diff_hunk" : "@@ -1129,36 +1138,59 @@ PeerLogicValidation::PeerLogicValidation(CConnman* connmanIn, BanMan* banman, CS\n  * Evict orphan txn pool entries (EraseOrphanTx) based on a newly connected\n  * block. Also save the time of the last tip update.\n  */\n-void PeerLogicValidation::BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex* pindex, const std::vector<CTransactionRef>& vtxConflicted) {\n-    LOCK(g_cs_orphans);\n+void PeerLogicValidation::BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex* pindex, const std::vector<CTransactionRef>& vtxConflicted)\n+{\n+    {\n+        LOCK(g_cs_orphans);\n \n-    std::vector<uint256> vOrphanErase;\n+        std::vector<uint256> vOrphanErase;\n \n-    for (const CTransactionRef& ptx : pblock->vtx) {\n-        const CTransaction& tx = *ptx;\n+        for (const CTransactionRef& ptx : pblock->vtx) {\n+            const CTransaction& tx = *ptx;\n \n-        // Which orphan pool entries must we evict?\n-        for (const auto& txin : tx.vin) {\n-            auto itByPrev = mapOrphanTransactionsByPrev.find(txin.prevout);\n-            if (itByPrev == mapOrphanTransactionsByPrev.end()) continue;\n-            for (auto mi = itByPrev->second.begin(); mi != itByPrev->second.end(); ++mi) {\n-                const CTransaction& orphanTx = *(*mi)->second.tx;\n-                const uint256& orphanHash = orphanTx.GetHash();\n-                vOrphanErase.push_back(orphanHash);\n+            // Which orphan pool entries must we evict?\n+            for (const auto& txin : tx.vin) {\n+                auto itByPrev = mapOrphanTransactionsByPrev.find(txin.prevout);\n+                if (itByPrev == mapOrphanTransactionsByPrev.end()) continue;\n+                for (auto mi = itByPrev->second.begin(); mi != itByPrev->second.end(); ++mi) {\n+                    const CTransaction& orphanTx = *(*mi)->second.tx;\n+                    const uint256& orphanHash = orphanTx.GetHash();\n+                    vOrphanErase.push_back(orphanHash);\n+                }\n             }\n         }\n-    }\n \n-    // Erase orphan transactions included or precluded by this block\n-    if (vOrphanErase.size()) {\n-        int nErased = 0;\n-        for (const uint256& orphanHash : vOrphanErase) {\n-            nErased += EraseOrphanTx(orphanHash);\n+        // Erase orphan transactions included or precluded by this block\n+        if (vOrphanErase.size()) {\n+            int nErased = 0;\n+            for (const uint256& orphanHash : vOrphanErase) {\n+                nErased += EraseOrphanTx(orphanHash);\n+            }\n+            LogPrint(BCLog::MEMPOOL, \"Erased %d orphan tx included or conflicted by block\\n\", nErased);\n+        }\n+\n+        g_last_tip_update = GetTime();\n+    }\n+    {\n+        LOCK(cs_recent_confirmed_transactions);\n+        for (const auto ptx : pblock->vtx) {\n+            recent_confirmed_transactions->insert(ptx->GetHash());\n         }\n-        LogPrint(BCLog::MEMPOOL, \"Erased %d orphan tx included or conflicted by block\\n\", nErased);\n     }\n+}\n \n-    g_last_tip_update = GetTime();\n+void PeerLogicValidation::BlockDisconnected(const std::shared_ptr<const CBlock> &block, const CBlockIndex* pindex)\n+{\n+    // To avoid relay problems with transactions that were previously\n+    // confirmed, clear our filter of recently confirmed transactions whenever\n+    // there's a reorg.\n+    // This means that in a 1-block reorg (where 1 block is disconnected and\n+    // then another block reconnected), our filter will drop to having only one\n+    // block's worth of transactions in it, but that should be fine, since\n+    // presumably the most common case of relaying a confirmed transaction\n+    // should be just after a new block containing it is found.\n+    LOCK(cs_recent_confirmed_transactions);\n+    recent_confirmed_transactions->reset();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17951#discussion_r369571564",
      "id" : 369571564,
      "in_reply_to_id" : 369287532,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU3MTU2NA==",
      "original_commit_id" : "1e9697bed83332f6aa1d2579dc7638fdb4785477",
      "original_position" : 100,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 346602502,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17951",
      "updated_at" : "2020-01-29T14:38:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/369571564",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17951#discussion_r371026761"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17951"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/371026761"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yeah, if you want to make a non-doxygen generic comment, use \"/*\" rather than \"/**\".",
      "commit_id" : "a029e18c2bf67dd00552b0f4bbc85fa2fa5b973b",
      "created_at" : "2020-01-26T20:21:31Z",
      "diff_hunk" : "@@ -148,6 +148,14 @@ namespace {\n     std::unique_ptr<CRollingBloomFilter> recentRejects GUARDED_BY(cs_main);\n     uint256 hashRecentRejectsChainTip GUARDED_BY(cs_main);\n \n+    /**\n+     * Filter for transactions that have been recently confirmed.\n+     * We use this to avoid requesting transactions that have already been\n+     * confirnmed.\n+     */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17951#discussion_r371026761",
      "id" : 371026761,
      "in_reply_to_id" : 368078174,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAyNjc2MQ==",
      "original_commit_id" : "1e9697bed83332f6aa1d2579dc7638fdb4785477",
      "original_position" : 8,
      "path" : "src/net_processing.cpp",
      "position" : 8,
      "pull_request_review_id" : 348402601,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17951",
      "updated_at" : "2020-01-29T14:38:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/371026761",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17951#discussion_r371026944"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17951"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/371026944"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It seems possible to instead of wiping the filter entirely, there could be a way to \"eagerly\" delete the disconnected block's transactions from the filter (where eagerly implies that it will randomly delete too much - but that's still better than wiping entirely).\r\n\r\nI'm slightly uncomfortable still with reorgs having the ability to blow this cache away entirely, but don't see a way to use it in an attack, so not a blocker.",
      "commit_id" : "a029e18c2bf67dd00552b0f4bbc85fa2fa5b973b",
      "created_at" : "2020-01-26T20:25:02Z",
      "diff_hunk" : "@@ -1129,36 +1138,59 @@ PeerLogicValidation::PeerLogicValidation(CConnman* connmanIn, BanMan* banman, CS\n  * Evict orphan txn pool entries (EraseOrphanTx) based on a newly connected\n  * block. Also save the time of the last tip update.\n  */\n-void PeerLogicValidation::BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex* pindex, const std::vector<CTransactionRef>& vtxConflicted) {\n-    LOCK(g_cs_orphans);\n+void PeerLogicValidation::BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex* pindex, const std::vector<CTransactionRef>& vtxConflicted)\n+{\n+    {\n+        LOCK(g_cs_orphans);\n \n-    std::vector<uint256> vOrphanErase;\n+        std::vector<uint256> vOrphanErase;\n \n-    for (const CTransactionRef& ptx : pblock->vtx) {\n-        const CTransaction& tx = *ptx;\n+        for (const CTransactionRef& ptx : pblock->vtx) {\n+            const CTransaction& tx = *ptx;\n \n-        // Which orphan pool entries must we evict?\n-        for (const auto& txin : tx.vin) {\n-            auto itByPrev = mapOrphanTransactionsByPrev.find(txin.prevout);\n-            if (itByPrev == mapOrphanTransactionsByPrev.end()) continue;\n-            for (auto mi = itByPrev->second.begin(); mi != itByPrev->second.end(); ++mi) {\n-                const CTransaction& orphanTx = *(*mi)->second.tx;\n-                const uint256& orphanHash = orphanTx.GetHash();\n-                vOrphanErase.push_back(orphanHash);\n+            // Which orphan pool entries must we evict?\n+            for (const auto& txin : tx.vin) {\n+                auto itByPrev = mapOrphanTransactionsByPrev.find(txin.prevout);\n+                if (itByPrev == mapOrphanTransactionsByPrev.end()) continue;\n+                for (auto mi = itByPrev->second.begin(); mi != itByPrev->second.end(); ++mi) {\n+                    const CTransaction& orphanTx = *(*mi)->second.tx;\n+                    const uint256& orphanHash = orphanTx.GetHash();\n+                    vOrphanErase.push_back(orphanHash);\n+                }\n             }\n         }\n-    }\n \n-    // Erase orphan transactions included or precluded by this block\n-    if (vOrphanErase.size()) {\n-        int nErased = 0;\n-        for (const uint256& orphanHash : vOrphanErase) {\n-            nErased += EraseOrphanTx(orphanHash);\n+        // Erase orphan transactions included or precluded by this block\n+        if (vOrphanErase.size()) {\n+            int nErased = 0;\n+            for (const uint256& orphanHash : vOrphanErase) {\n+                nErased += EraseOrphanTx(orphanHash);\n+            }\n+            LogPrint(BCLog::MEMPOOL, \"Erased %d orphan tx included or conflicted by block\\n\", nErased);\n+        }\n+\n+        g_last_tip_update = GetTime();\n+    }\n+    {\n+        LOCK(cs_recent_confirmed_transactions);\n+        for (const auto ptx : pblock->vtx) {\n+            recent_confirmed_transactions->insert(ptx->GetHash());\n         }\n-        LogPrint(BCLog::MEMPOOL, \"Erased %d orphan tx included or conflicted by block\\n\", nErased);\n     }\n+}\n \n-    g_last_tip_update = GetTime();\n+void PeerLogicValidation::BlockDisconnected(const std::shared_ptr<const CBlock> &block, const CBlockIndex* pindex)\n+{\n+    // To avoid relay problems with transactions that were previously\n+    // confirmed, clear our filter of recently confirmed transactions whenever\n+    // there's a reorg.\n+    // This means that in a 1-block reorg (where 1 block is disconnected and",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17951#discussion_r371026944",
      "id" : 371026944,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAyNjk0NA==",
      "original_commit_id" : "1e9697bed83332f6aa1d2579dc7638fdb4785477",
      "original_position" : 94,
      "path" : "src/net_processing.cpp",
      "position" : 103,
      "pull_request_review_id" : 348402601,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17951",
      "updated_at" : "2020-01-29T14:38:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/371026944",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17951#discussion_r371027081"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17951"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/371027081"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Add some comments to explain the parameter selection?",
      "commit_id" : "a029e18c2bf67dd00552b0f4bbc85fa2fa5b973b",
      "created_at" : "2020-01-26T20:27:26Z",
      "diff_hunk" : "@@ -1115,6 +1123,7 @@ PeerLogicValidation::PeerLogicValidation(CConnman* connmanIn, BanMan* banman, CS\n {\n     // Initialize global variables that cannot be constructed at startup.\n     recentRejects.reset(new CRollingBloomFilter(120000, 0.000001));\n+    recent_confirmed_transactions.reset(new CRollingBloomFilter(24000, 0.000001));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17951#discussion_r371027081",
      "id" : 371027081,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAyNzA4MQ==",
      "original_commit_id" : "1e9697bed83332f6aa1d2579dc7638fdb4785477",
      "original_position" : 19,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 348402601,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17951",
      "updated_at" : "2020-01-29T14:38:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/371027081",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "These low FP rate bloom filters are pretty slow, how much does this slow down block acceptance?\r\n\r\nMight it just be better to keep a limited map of txids recently removed entirely from the txout set?",
      "created_at" : "2020-01-26T20:44:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17951#issuecomment-578541366",
      "id" : 578541366,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17951",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3ODU0MTM2Ng==",
      "updated_at" : "2020-01-26T20:46:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/578541366",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17951#discussion_r371294027"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17951"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/371294027"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Hm, I was trying to think what this might mean -- for a filter with N elements, I suppose one approach would be to just re-add the last (say) 1.5N transactions that appear in the most recent blocks leading to the tip back to the filter, in order to wipe the reorged block(s) out of the filter, without making the filter useless?\r\n\r\nIt'd be a bit annoying to do that, since only the last block is in memory; but I guess we could do this in the future if we felt like this was a problem.  Is there a smarter way to achieve this effect that I'm overlooking?",
      "commit_id" : "a029e18c2bf67dd00552b0f4bbc85fa2fa5b973b",
      "created_at" : "2020-01-27T15:07:51Z",
      "diff_hunk" : "@@ -1129,36 +1138,59 @@ PeerLogicValidation::PeerLogicValidation(CConnman* connmanIn, BanMan* banman, CS\n  * Evict orphan txn pool entries (EraseOrphanTx) based on a newly connected\n  * block. Also save the time of the last tip update.\n  */\n-void PeerLogicValidation::BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex* pindex, const std::vector<CTransactionRef>& vtxConflicted) {\n-    LOCK(g_cs_orphans);\n+void PeerLogicValidation::BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex* pindex, const std::vector<CTransactionRef>& vtxConflicted)\n+{\n+    {\n+        LOCK(g_cs_orphans);\n \n-    std::vector<uint256> vOrphanErase;\n+        std::vector<uint256> vOrphanErase;\n \n-    for (const CTransactionRef& ptx : pblock->vtx) {\n-        const CTransaction& tx = *ptx;\n+        for (const CTransactionRef& ptx : pblock->vtx) {\n+            const CTransaction& tx = *ptx;\n \n-        // Which orphan pool entries must we evict?\n-        for (const auto& txin : tx.vin) {\n-            auto itByPrev = mapOrphanTransactionsByPrev.find(txin.prevout);\n-            if (itByPrev == mapOrphanTransactionsByPrev.end()) continue;\n-            for (auto mi = itByPrev->second.begin(); mi != itByPrev->second.end(); ++mi) {\n-                const CTransaction& orphanTx = *(*mi)->second.tx;\n-                const uint256& orphanHash = orphanTx.GetHash();\n-                vOrphanErase.push_back(orphanHash);\n+            // Which orphan pool entries must we evict?\n+            for (const auto& txin : tx.vin) {\n+                auto itByPrev = mapOrphanTransactionsByPrev.find(txin.prevout);\n+                if (itByPrev == mapOrphanTransactionsByPrev.end()) continue;\n+                for (auto mi = itByPrev->second.begin(); mi != itByPrev->second.end(); ++mi) {\n+                    const CTransaction& orphanTx = *(*mi)->second.tx;\n+                    const uint256& orphanHash = orphanTx.GetHash();\n+                    vOrphanErase.push_back(orphanHash);\n+                }\n             }\n         }\n-    }\n \n-    // Erase orphan transactions included or precluded by this block\n-    if (vOrphanErase.size()) {\n-        int nErased = 0;\n-        for (const uint256& orphanHash : vOrphanErase) {\n-            nErased += EraseOrphanTx(orphanHash);\n+        // Erase orphan transactions included or precluded by this block\n+        if (vOrphanErase.size()) {\n+            int nErased = 0;\n+            for (const uint256& orphanHash : vOrphanErase) {\n+                nErased += EraseOrphanTx(orphanHash);\n+            }\n+            LogPrint(BCLog::MEMPOOL, \"Erased %d orphan tx included or conflicted by block\\n\", nErased);\n+        }\n+\n+        g_last_tip_update = GetTime();\n+    }\n+    {\n+        LOCK(cs_recent_confirmed_transactions);\n+        for (const auto ptx : pblock->vtx) {\n+            recent_confirmed_transactions->insert(ptx->GetHash());\n         }\n-        LogPrint(BCLog::MEMPOOL, \"Erased %d orphan tx included or conflicted by block\\n\", nErased);\n     }\n+}\n \n-    g_last_tip_update = GetTime();\n+void PeerLogicValidation::BlockDisconnected(const std::shared_ptr<const CBlock> &block, const CBlockIndex* pindex)\n+{\n+    // To avoid relay problems with transactions that were previously\n+    // confirmed, clear our filter of recently confirmed transactions whenever\n+    // there's a reorg.\n+    // This means that in a 1-block reorg (where 1 block is disconnected and",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17951#discussion_r371294027",
      "id" : 371294027,
      "in_reply_to_id" : 371026944,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTI5NDAyNw==",
      "original_commit_id" : "1e9697bed83332f6aa1d2579dc7638fdb4785477",
      "original_position" : 94,
      "path" : "src/net_processing.cpp",
      "position" : 103,
      "pull_request_review_id" : 348733143,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17951",
      "updated_at" : "2020-01-29T14:38:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/371294027",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> how much does this slow down block acceptance?\r\n\r\nShouldn't slow down block acceptance at all since this is being run on the validation interface thread.",
      "created_at" : "2020-01-27T15:15:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17951#issuecomment-578796182",
      "id" : 578796182,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17951",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3ODc5NjE4Mg==",
      "updated_at" : "2020-01-27T15:15:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/578796182",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> These low FP rate bloom filters are pretty slow, how much does this slow down block acceptance?\r\n\r\n@gmaxwell My thought was that the speed shouldn't be a big deal because the `BlockConnected` callback happens in a background thread, out of the critical path of block acceptance.\r\n\r\n> Might it just be better to keep a limited map of txids recently removed entirely from the txout set?\r\n\r\nPossibly, though I just want to clarify your suggestion -- this seems like an idea for a data structure that would be used in conjunction with the utxo cache for determining whether we've seen a transaction?  \r\n\r\nI'd like to remove querying the utxo set altogether from this logic, in preparation for proposing that we switch to wtxid-based INV messages (to solve the long-running problem we have that segwit transactions don't get added to our reject filter, due to possible malleability, see #8279 for background).  Using a data structure that completely captures the idea of \"is this transaction already confirmed\" seems preferable for moving in this direction, as my next proposal would be to expand the txid-based lookup in such data structure to have a wtxid-based lookup as well.  (However, I would not propose adding a wtxid-based lookup to the utxo cache itself, as that seems absurd to me.)\r\n\r\nSo rather than propose a limited map of recently fully spent transactions as an alternative here, I think I would say we could consider instead just using a limited map for all recently confirmed transactions (to which we could add a wtxid-based key as well in the future). \r\n\r\nI think that could be fine, and it seems to me the choice would be a memory tradeoff between a bloom filter and limited map.  I don't feel strongly what direction we go; I think the limited map approach is easier to reason about correctness of, because it's nice to eliminate any concerns about false positives interfering with relay, but I don't think this approach should be too bad either after giving it some thought.  \r\n\r\nBut I'd be happy to switch directions and use a limited map of all recently confirmed transactions instead if people think that makes more sense...",
      "created_at" : "2020-01-27T15:48:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17951#issuecomment-578811507",
      "id" : 578811507,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17951",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3ODgxMTUwNw==",
      "updated_at" : "2020-01-27T15:48:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/578811507",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17951#discussion_r371367704"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17951"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/371367704"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I mean going through the disconnected block's transaction, and setting all their bits to 0 in the filter.",
      "commit_id" : "a029e18c2bf67dd00552b0f4bbc85fa2fa5b973b",
      "created_at" : "2020-01-27T17:08:29Z",
      "diff_hunk" : "@@ -1129,36 +1138,59 @@ PeerLogicValidation::PeerLogicValidation(CConnman* connmanIn, BanMan* banman, CS\n  * Evict orphan txn pool entries (EraseOrphanTx) based on a newly connected\n  * block. Also save the time of the last tip update.\n  */\n-void PeerLogicValidation::BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex* pindex, const std::vector<CTransactionRef>& vtxConflicted) {\n-    LOCK(g_cs_orphans);\n+void PeerLogicValidation::BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex* pindex, const std::vector<CTransactionRef>& vtxConflicted)\n+{\n+    {\n+        LOCK(g_cs_orphans);\n \n-    std::vector<uint256> vOrphanErase;\n+        std::vector<uint256> vOrphanErase;\n \n-    for (const CTransactionRef& ptx : pblock->vtx) {\n-        const CTransaction& tx = *ptx;\n+        for (const CTransactionRef& ptx : pblock->vtx) {\n+            const CTransaction& tx = *ptx;\n \n-        // Which orphan pool entries must we evict?\n-        for (const auto& txin : tx.vin) {\n-            auto itByPrev = mapOrphanTransactionsByPrev.find(txin.prevout);\n-            if (itByPrev == mapOrphanTransactionsByPrev.end()) continue;\n-            for (auto mi = itByPrev->second.begin(); mi != itByPrev->second.end(); ++mi) {\n-                const CTransaction& orphanTx = *(*mi)->second.tx;\n-                const uint256& orphanHash = orphanTx.GetHash();\n-                vOrphanErase.push_back(orphanHash);\n+            // Which orphan pool entries must we evict?\n+            for (const auto& txin : tx.vin) {\n+                auto itByPrev = mapOrphanTransactionsByPrev.find(txin.prevout);\n+                if (itByPrev == mapOrphanTransactionsByPrev.end()) continue;\n+                for (auto mi = itByPrev->second.begin(); mi != itByPrev->second.end(); ++mi) {\n+                    const CTransaction& orphanTx = *(*mi)->second.tx;\n+                    const uint256& orphanHash = orphanTx.GetHash();\n+                    vOrphanErase.push_back(orphanHash);\n+                }\n             }\n         }\n-    }\n \n-    // Erase orphan transactions included or precluded by this block\n-    if (vOrphanErase.size()) {\n-        int nErased = 0;\n-        for (const uint256& orphanHash : vOrphanErase) {\n-            nErased += EraseOrphanTx(orphanHash);\n+        // Erase orphan transactions included or precluded by this block\n+        if (vOrphanErase.size()) {\n+            int nErased = 0;\n+            for (const uint256& orphanHash : vOrphanErase) {\n+                nErased += EraseOrphanTx(orphanHash);\n+            }\n+            LogPrint(BCLog::MEMPOOL, \"Erased %d orphan tx included or conflicted by block\\n\", nErased);\n+        }\n+\n+        g_last_tip_update = GetTime();\n+    }\n+    {\n+        LOCK(cs_recent_confirmed_transactions);\n+        for (const auto ptx : pblock->vtx) {\n+            recent_confirmed_transactions->insert(ptx->GetHash());\n         }\n-        LogPrint(BCLog::MEMPOOL, \"Erased %d orphan tx included or conflicted by block\\n\", nErased);\n     }\n+}\n \n-    g_last_tip_update = GetTime();\n+void PeerLogicValidation::BlockDisconnected(const std::shared_ptr<const CBlock> &block, const CBlockIndex* pindex)\n+{\n+    // To avoid relay problems with transactions that were previously\n+    // confirmed, clear our filter of recently confirmed transactions whenever\n+    // there's a reorg.\n+    // This means that in a 1-block reorg (where 1 block is disconnected and",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17951#discussion_r371367704",
      "id" : 371367704,
      "in_reply_to_id" : 371026944,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM2NzcwNA==",
      "original_commit_id" : "1e9697bed83332f6aa1d2579dc7638fdb4785477",
      "original_position" : 94,
      "path" : "src/net_processing.cpp",
      "position" : 103,
      "pull_request_review_id" : 348829077,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17951",
      "updated_at" : "2020-01-29T14:38:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/371367704",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17951#discussion_r371416581"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17951"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/371416581"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "a029e18c2bf67dd00552b0f4bbc85fa2fa5b973b",
      "created_at" : "2020-01-27T18:48:08Z",
      "diff_hunk" : "@@ -1115,6 +1123,7 @@ PeerLogicValidation::PeerLogicValidation(CConnman* connmanIn, BanMan* banman, CS\n {\n     // Initialize global variables that cannot be constructed at startup.\n     recentRejects.reset(new CRollingBloomFilter(120000, 0.000001));\n+    recent_confirmed_transactions.reset(new CRollingBloomFilter(24000, 0.000001));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17951#discussion_r371416581",
      "id" : 371416581,
      "in_reply_to_id" : 371027081,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQxNjU4MQ==",
      "original_commit_id" : "1e9697bed83332f6aa1d2579dc7638fdb4785477",
      "original_position" : 19,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 348891928,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17951",
      "updated_at" : "2020-01-29T14:38:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/371416581",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Pushed a fixup commit to address the comment nits (and a second commit to fix the naming nit, which I missed the first time).",
      "created_at" : "2020-01-27T18:48:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17951#issuecomment-578894659",
      "id" : 578894659,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17951",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3ODg5NDY1OQ==",
      "updated_at" : "2020-01-27T22:20:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/578894659",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17951#discussion_r371417051"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17951"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/371417051"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "a029e18c2bf67dd00552b0f4bbc85fa2fa5b973b",
      "created_at" : "2020-01-27T18:49:07Z",
      "diff_hunk" : "@@ -148,6 +148,14 @@ namespace {\n     std::unique_ptr<CRollingBloomFilter> recentRejects GUARDED_BY(cs_main);\n     uint256 hashRecentRejectsChainTip GUARDED_BY(cs_main);\n \n+    /**\n+     * Filter for transactions that have been recently confirmed.\n+     * We use this to avoid requesting transactions that have already been\n+     * confirnmed.\n+     */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17951#discussion_r371417051",
      "id" : 371417051,
      "in_reply_to_id" : 368078174,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQxNzA1MQ==",
      "original_commit_id" : "1e9697bed83332f6aa1d2579dc7638fdb4785477",
      "original_position" : 8,
      "path" : "src/net_processing.cpp",
      "position" : 8,
      "pull_request_review_id" : 348892550,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17951",
      "updated_at" : "2020-01-29T14:38:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/371417051",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17951#discussion_r371555566"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17951"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/371555566"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "You can do the thing where you store rank.s When you insert you increase the rank of each bit to the current. When you query you ignore bits whos rank is too low. When the rank counter wraps, you make a pass over to adjust the ranks. E.g. say your counter is 8 bits and you want to remember the last 10 blocks. You start with all the data zeros. You start on rank 11, so every value has too low a rank to be considered set.  Every block you increase your rank and only consider the last 10 to be set. When you overflow you map the last 10 ranks to 0-10 and you start again at 11.  There are a bunch of variations on this that amortize the erasure.",
      "commit_id" : "a029e18c2bf67dd00552b0f4bbc85fa2fa5b973b",
      "created_at" : "2020-01-28T00:23:34Z",
      "diff_hunk" : "@@ -1129,36 +1138,59 @@ PeerLogicValidation::PeerLogicValidation(CConnman* connmanIn, BanMan* banman, CS\n  * Evict orphan txn pool entries (EraseOrphanTx) based on a newly connected\n  * block. Also save the time of the last tip update.\n  */\n-void PeerLogicValidation::BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex* pindex, const std::vector<CTransactionRef>& vtxConflicted) {\n-    LOCK(g_cs_orphans);\n+void PeerLogicValidation::BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex* pindex, const std::vector<CTransactionRef>& vtxConflicted)\n+{\n+    {\n+        LOCK(g_cs_orphans);\n \n-    std::vector<uint256> vOrphanErase;\n+        std::vector<uint256> vOrphanErase;\n \n-    for (const CTransactionRef& ptx : pblock->vtx) {\n-        const CTransaction& tx = *ptx;\n+        for (const CTransactionRef& ptx : pblock->vtx) {\n+            const CTransaction& tx = *ptx;\n \n-        // Which orphan pool entries must we evict?\n-        for (const auto& txin : tx.vin) {\n-            auto itByPrev = mapOrphanTransactionsByPrev.find(txin.prevout);\n-            if (itByPrev == mapOrphanTransactionsByPrev.end()) continue;\n-            for (auto mi = itByPrev->second.begin(); mi != itByPrev->second.end(); ++mi) {\n-                const CTransaction& orphanTx = *(*mi)->second.tx;\n-                const uint256& orphanHash = orphanTx.GetHash();\n-                vOrphanErase.push_back(orphanHash);\n+            // Which orphan pool entries must we evict?\n+            for (const auto& txin : tx.vin) {\n+                auto itByPrev = mapOrphanTransactionsByPrev.find(txin.prevout);\n+                if (itByPrev == mapOrphanTransactionsByPrev.end()) continue;\n+                for (auto mi = itByPrev->second.begin(); mi != itByPrev->second.end(); ++mi) {\n+                    const CTransaction& orphanTx = *(*mi)->second.tx;\n+                    const uint256& orphanHash = orphanTx.GetHash();\n+                    vOrphanErase.push_back(orphanHash);\n+                }\n             }\n         }\n-    }\n \n-    // Erase orphan transactions included or precluded by this block\n-    if (vOrphanErase.size()) {\n-        int nErased = 0;\n-        for (const uint256& orphanHash : vOrphanErase) {\n-            nErased += EraseOrphanTx(orphanHash);\n+        // Erase orphan transactions included or precluded by this block\n+        if (vOrphanErase.size()) {\n+            int nErased = 0;\n+            for (const uint256& orphanHash : vOrphanErase) {\n+                nErased += EraseOrphanTx(orphanHash);\n+            }\n+            LogPrint(BCLog::MEMPOOL, \"Erased %d orphan tx included or conflicted by block\\n\", nErased);\n+        }\n+\n+        g_last_tip_update = GetTime();\n+    }\n+    {\n+        LOCK(cs_recent_confirmed_transactions);\n+        for (const auto ptx : pblock->vtx) {\n+            recent_confirmed_transactions->insert(ptx->GetHash());\n         }\n-        LogPrint(BCLog::MEMPOOL, \"Erased %d orphan tx included or conflicted by block\\n\", nErased);\n     }\n+}\n \n-    g_last_tip_update = GetTime();\n+void PeerLogicValidation::BlockDisconnected(const std::shared_ptr<const CBlock> &block, const CBlockIndex* pindex)\n+{\n+    // To avoid relay problems with transactions that were previously\n+    // confirmed, clear our filter of recently confirmed transactions whenever\n+    // there's a reorg.\n+    // This means that in a 1-block reorg (where 1 block is disconnected and",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17951#discussion_r371555566",
      "id" : 371555566,
      "in_reply_to_id" : 371026944,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU1NTU2Ng==",
      "original_commit_id" : "1e9697bed83332f6aa1d2579dc7638fdb4785477",
      "original_position" : 94,
      "path" : "src/net_processing.cpp",
      "position" : 103,
      "pull_request_review_id" : 349065636,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17951",
      "updated_at" : "2020-01-29T14:38:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/371555566",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Squashed the nit commits.  I'm inclined to leave the resetting of the filter on a reorg alone, as I think what is proposed here should be fine; please let me know if there's anything else I should address (particularly if the bloom filter approach seems problematic overall for some reason?).",
      "created_at" : "2020-01-29T14:40:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17951#issuecomment-579785582",
      "id" : 579785582,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17951",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3OTc4NTU4Mg==",
      "updated_at" : "2020-01-29T14:40:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/579785582",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Will try to test this a bit in the next week or so.\r\n\r\nre-ACK a029e18c2b only stylistic and comment fixups ð´\r\n\r\n<details><summary>Show signature and timestamp</summary>\r\n\r\nSignature:\r\n\r\n```\r\n-----BEGIN PGP SIGNED MESSAGE-----\r\nHash: SHA512\r\n\r\nre-ACK a029e18c2b only stylistic and comment fixups ð´\r\n-----BEGIN PGP SIGNATURE-----\r\n\r\niQGzBAEBCgAdFiEE+rVPoUahrI9sLGYTzit1aX5ppUgFAlwqrYEACgkQzit1aX5p\r\npUgiZQwAtpV52RF9r/SlcsB6JkwQsvDZ8L8v7NXTl6Yo+rwxn6S1Vw3njtEzhN04\r\nm1PkqFZ+jLsqY97OigTTDsv9gzbWcwBx1AIqWrQXhpfhl5F8tdLPbHJsTjJiFAw6\r\ncICd6LfHFBop+KkskBNlU43BX5DtRnYdM1LwvMgXuRDrGx86j8RBk6Ck7ZK/sWtO\r\nEMzXKJNJZVwccQu31DFU2JVP+ByYcn2CwocuwLPGvBiy3Na4Ir3so+bqOnEnY1JB\r\nvAmYc7OQkISTziEeh9xzajiseWnBUxofK5U5HTETlHN2seaYScLEIsUa7Dj8aw8E\r\n/m0EKiJWpFfAO5Dqu1GVx7XUMP7+w+TBU3hwUmEjbbf+ssm4N4lA7yDn2C0TvMdn\r\nSQVHCjULVjDWnb+om9K433lB6dMTbOLb6DnbZhcd8bNT/PGMyQmjoHlHiKNRPmR8\r\nCgE3st6tJh+CJwOjjMQOdjqACs6yhI/YYQwyPUZGS4c4po4FTfVbgDbB8rV1goY9\r\nwrKiCqLw\r\n=6HzK\r\n-----END PGP SIGNATURE-----\r\n```\r\n\r\n[Timestamp of file with hash `5c3cef17120e5f7c54fb4bc112dfe230bdc9da289456a63dcc006e7b806e1f36  -`](https://opentimestamps.org/info/?004f70656e54696d657374616d7073000050726f6f6600bf89e2e884e8929401085c3cef17120e5f7c54fb4bc112dfe230bdc9da289456a63dcc006e7b806e1f36f01021cf4f738e35ab02cc32652e19bbf2d608fff01016aa149968f0e7ab1dbc12aeaade545f08f1045e31d92bf00865fbb18057b35f650083dfe30d2ef90c8e2e2d68747470733a2f2f616c6963652e6274632e63616c656e6461722e6f70656e74696d657374616d70732e6f7267fff01019066ac638e0fedcaefa91eb9daabeb308f1045e31d92cf00810e0094930b299840083dfe30d2ef90c8e292868747470733a2f2f66696e6e65792e63616c656e6461722e657465726e69747977616c6c2e636f6dfff010756ee071e8102d9a7784bb674d0e1cbd08f1045e31d92af008b0c331dc028291120083dfe30d2ef90c8e232268747470733a2f2f6274632e63616c656e6461722e636174616c6c6178792e636f6df010c49a86c08b49c3648c7f0efe9bdfb96108f1045e31d92bf00827d6cdc142249be30083dfe30d2ef90c8e2c2b68747470733a2f2f626f622e6274632e63616c656e6461722e6f70656e74696d657374616d70732e6f7267)\r\n\r\n</details>\r\n",
      "created_at" : "2020-01-29T19:13:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17951#issuecomment-579913422",
      "id" : 579913422,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17951",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3OTkxMzQyMg==",
      "updated_at" : "2020-01-29T19:13:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/579913422",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17951#discussion_r373205735"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17951"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/373205735"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This computes to a size that is above the max filter size FYI (maybe we should have a typesafe CRollingBloomFilter that compile time checks this, or allow passing in a custom max).",
      "commit_id" : "a029e18c2bf67dd00552b0f4bbc85fa2fa5b973b",
      "created_at" : "2020-01-30T21:35:07Z",
      "diff_hunk" : "@@ -1116,6 +1124,16 @@ PeerLogicValidation::PeerLogicValidation(CConnman* connmanIn, BanMan* banman, CS\n     // Initialize global variables that cannot be constructed at startup.\n     recentRejects.reset(new CRollingBloomFilter(120000, 0.000001));\n \n+    // Blocks don't typically have more than 4000 transactions, so this should\n+    // be at least six blocks (~1 hr) worth of transactions that we can store.\n+    // If the number of transactions appearing in a block goes up, or if we are\n+    // seeing getdata requests more than an hour after initial announcement, we\n+    // can increase this number.\n+    // The false positive rate of 1/1M should come out to less than 1\n+    // transaction per day that would be inadvertently ignored (which is the\n+    // same probability that we have in the reject filter).\n+    g_recent_confirmed_transactions.reset(new CRollingBloomFilter(24000, 0.000001));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17951#discussion_r373205735",
      "id" : 373205735,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIwNTczNQ==",
      "original_commit_id" : "a029e18c2bf67dd00552b0f4bbc85fa2fa5b973b",
      "original_position" : 27,
      "path" : "src/net_processing.cpp",
      "position" : 27,
      "pull_request_review_id" : 351157853,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17951",
      "updated_at" : "2020-01-30T21:35:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/373205735",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17951#discussion_r373209225"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17951"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/373209225"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What max filter size are you talking about?",
      "commit_id" : "a029e18c2bf67dd00552b0f4bbc85fa2fa5b973b",
      "created_at" : "2020-01-30T21:43:14Z",
      "diff_hunk" : "@@ -1116,6 +1124,16 @@ PeerLogicValidation::PeerLogicValidation(CConnman* connmanIn, BanMan* banman, CS\n     // Initialize global variables that cannot be constructed at startup.\n     recentRejects.reset(new CRollingBloomFilter(120000, 0.000001));\n \n+    // Blocks don't typically have more than 4000 transactions, so this should\n+    // be at least six blocks (~1 hr) worth of transactions that we can store.\n+    // If the number of transactions appearing in a block goes up, or if we are\n+    // seeing getdata requests more than an hour after initial announcement, we\n+    // can increase this number.\n+    // The false positive rate of 1/1M should come out to less than 1\n+    // transaction per day that would be inadvertently ignored (which is the\n+    // same probability that we have in the reject filter).\n+    g_recent_confirmed_transactions.reset(new CRollingBloomFilter(24000, 0.000001));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17951#discussion_r373209225",
      "id" : 373209225,
      "in_reply_to_id" : 373205735,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIwOTIyNQ==",
      "original_commit_id" : "a029e18c2bf67dd00552b0f4bbc85fa2fa5b973b",
      "original_position" : 27,
      "path" : "src/net_processing.cpp",
      "position" : 27,
      "pull_request_review_id" : 351162462,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17951",
      "updated_at" : "2020-01-30T21:43:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/373209225",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "General concept ACK.\r\n\r\nTo address concerns with the RollingBloomFilter:\r\n\r\nIt would take up a bit more space, but this can also be a good place to reuse the cuckoocache. \r\n\r\nThe original uses ((ceil(-1.0 * 20 * (24000/2*3) / log(1.0 - exp(log(0.000001) / 20))) +63)>>6)<<1 = 32350 bytes\r\n\r\nCuckoocache would need:\r\n6*4000*32.25/(32350) = 24x more space, but still under a megabyte.\r\n\r\nUsing the cuckoocache would have a more graceful delete functionality and can also \"age\" things more gracefully if the filter looks full. We can then also use a read/write lock and:\r\n\r\nwrite when inserting\r\nread when reading\r\nread when erasing\r\n\r\nThis enables more concurrency down the line if we erase everything in parallel.\r\n\r\nIt should also be a fair bit faster because CuckooCache only needs to hash a single sha256 rather than a bunch of murmurs (if I calculated right, we're doing 20 hashes?).",
      "created_at" : "2020-01-30T21:46:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17951#issuecomment-580475601",
      "id" : 580475601,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17951",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MDQ3NTYwMQ==",
      "updated_at" : "2020-01-30T22:55:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/580475601",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17951#discussion_r373223850"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17951"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/373223850"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`static const unsigned int MAX_BLOOM_FILTER_SIZE = 36000; // bytes`",
      "commit_id" : "a029e18c2bf67dd00552b0f4bbc85fa2fa5b973b",
      "created_at" : "2020-01-30T22:17:18Z",
      "diff_hunk" : "@@ -1116,6 +1124,16 @@ PeerLogicValidation::PeerLogicValidation(CConnman* connmanIn, BanMan* banman, CS\n     // Initialize global variables that cannot be constructed at startup.\n     recentRejects.reset(new CRollingBloomFilter(120000, 0.000001));\n \n+    // Blocks don't typically have more than 4000 transactions, so this should\n+    // be at least six blocks (~1 hr) worth of transactions that we can store.\n+    // If the number of transactions appearing in a block goes up, or if we are\n+    // seeing getdata requests more than an hour after initial announcement, we\n+    // can increase this number.\n+    // The false positive rate of 1/1M should come out to less than 1\n+    // transaction per day that would be inadvertently ignored (which is the\n+    // same probability that we have in the reject filter).\n+    g_recent_confirmed_transactions.reset(new CRollingBloomFilter(24000, 0.000001));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17951#discussion_r373223850",
      "id" : 373223850,
      "in_reply_to_id" : 373205735,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIyMzg1MA==",
      "original_commit_id" : "a029e18c2bf67dd00552b0f4bbc85fa2fa5b973b",
      "original_position" : 27,
      "path" : "src/net_processing.cpp",
      "position" : 27,
      "pull_request_review_id" : 351181377,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17951",
      "updated_at" : "2020-01-30T22:17:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/373223850",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17951#discussion_r373225011"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17951"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/373225011"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "ooops, I based my review on CBloomFilter... need to go back and re-check the right class",
      "commit_id" : "a029e18c2bf67dd00552b0f4bbc85fa2fa5b973b",
      "created_at" : "2020-01-30T22:20:11Z",
      "diff_hunk" : "@@ -1116,6 +1124,16 @@ PeerLogicValidation::PeerLogicValidation(CConnman* connmanIn, BanMan* banman, CS\n     // Initialize global variables that cannot be constructed at startup.\n     recentRejects.reset(new CRollingBloomFilter(120000, 0.000001));\n \n+    // Blocks don't typically have more than 4000 transactions, so this should\n+    // be at least six blocks (~1 hr) worth of transactions that we can store.\n+    // If the number of transactions appearing in a block goes up, or if we are\n+    // seeing getdata requests more than an hour after initial announcement, we\n+    // can increase this number.\n+    // The false positive rate of 1/1M should come out to less than 1\n+    // transaction per day that would be inadvertently ignored (which is the\n+    // same probability that we have in the reject filter).\n+    g_recent_confirmed_transactions.reset(new CRollingBloomFilter(24000, 0.000001));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17951#discussion_r373225011",
      "id" : 373225011,
      "in_reply_to_id" : 373205735,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIyNTAxMQ==",
      "original_commit_id" : "a029e18c2bf67dd00552b0f4bbc85fa2fa5b973b",
      "original_position" : 27,
      "path" : "src/net_processing.cpp",
      "position" : 27,
      "pull_request_review_id" : 351182791,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17951",
      "updated_at" : "2020-01-30T22:20:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/373225011",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@sdaftuar okay, if its not on a critical path for mining a subsequent block my concern is withdrawn. I spent a half hour trying to figure out if it was but wasn't able to trace all the indirect control flow well enough to be confident.\r\n\r\n@JeremyRubin why not instantiate the the cuckoo filter with a more similar FP rate? then the memory overhead would be less and the other advantages would remain. I expect that in the long run the low FP rate bloom filters would all eventually get replaced with cuckoo filters because memory speeds increase slowly compared to cpu speed and memory capacity... and those low FP rate bloom filters make a lot of random memory accesses.",
      "created_at" : "2020-01-31T00:27:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17951#issuecomment-580525541",
      "id" : 580525541,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17951",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MDUyNTU0MQ==",
      "updated_at" : "2020-01-31T00:27:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/580525541",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "utACK a029e18c2bf67dd00552b0f4bbc85fa2fa5b973b",
      "created_at" : "2020-01-31T00:29:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17951#issuecomment-580526195",
      "id" : 580526195,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17951",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MDUyNjE5NQ==",
      "updated_at" : "2020-01-31T00:29:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/580526195",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@gmaxwell \r\n\r\nGood point. The cuckoo cache only does *at most* 8 memory accesses to read (and it's biased a bit towards it being less -- let's say EV is 2 or 3 rather than 4, v.s. 20 for the bloom. That seems like a win.\r\n\r\nTurning up the False Positive is not possible for the cuckoocache as a true response is always true. There isn't an obvious way to add false positives to the current design (we'd never want them for the signature cache).\r\n\r\nWhat you can tune up is the false negative rate, by just allocating a smaller table. But given your point, we may want to allocate a bigger table (say 1MB - 1.5MB) because the 3 Random Accesses are pretty cheap independent of size.\r\n\r\nSomeone could also implement an actual false-positive cuckoo filter, but I'm not as familiar with that data structure/it doesn't exist in core already.",
      "created_at" : "2020-01-31T00:57:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17951#issuecomment-580532366",
      "id" : 580532366,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17951",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MDUzMjM2Ng==",
      "updated_at" : "2020-01-31T00:57:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/580532366",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@JeremyRubin use a shorter hash, if it collides you have a FP.  You can also turn down the number of parallel memory access for this case, as there isn't so much need to run the table at 90% full esp if the entries are short. 32 bit cells should still give a massifly lower FP rate...",
      "created_at" : "2020-01-31T01:49:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17951#issuecomment-580545582",
      "id" : 580545582,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17951",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MDU0NTU4Mg==",
      "updated_at" : "2020-01-31T01:49:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/580545582",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   }
]
