{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "CONTRIBUTOR",
   "body" : "Importing a 1-of-2 multisig p2sh address into 0.19.0.1 testnet, the following script dies with a segfault:\r\n\r\n```\r\n#!/bin/bash\r\n\r\necho running createwallet\r\n./bitcoin-0.19.0.1/bin/bitcoin-cli -testnet createwallet \"whynokeys\"\r\n#sleep 4\r\n\r\necho running importprivkey 1\r\n./bitcoin-0.19.0.1/bin/bitcoin-cli -testnet -rpcwallet=whynokeys importprivkey \"cQkx6d2rpRJgrsAUT6sfctTbxSPD1CaTQ5Q6XMQojjZXK1ntjCvo\" \"addr1\" false\r\n#sleep 4\r\n\r\necho running importprivkey 2\r\n./bitcoin-0.19.0.1/bin/bitcoin-cli -testnet -rpcwallet=whynokeys importprivkey \"cPaQ8eEdhYbtSLX6t86eoWePqZcKB7ibAqH8zhqnA936k8ML8F1H\" \"addr2\" false\r\n#sleep 4\r\n\r\necho running importmulti\r\n./bitcoin-0.19.0.1/bin/bitcoin-cli -testnet -rpcwallet=whynokeys importmulti \\\r\n    '[\r\n      {\r\n        \"scriptPubKey\": { \"address\": \"2NBeG2myyAwSUCv1L21kTHAA3SdMELxdspi\" },\r\n        \"timestamp\":1578787441,\r\n        \"redeemscript\":\"512103b7e7e3dacb0ad6f1e2bee28a7a5e8842152a8232f36be55bba66243aee77b95c21039dd05437b699bf98ea32ed3217d0aeb5a5a5fd76a343bebeec6e56968aa9bf0d52ae\"\r\n      }]'\r\n#sleep 4\r\n\r\necho running listunspent\r\n./bitcoin-0.19.0.1/bin/bitcoin-cli -testnet -rpcwallet=whynokeys listunspent\r\n\r\necho all done\r\n```\r\n\r\nResults:\r\n```\r\nuser@host:~$ ./badimport.sh \r\nrunning createwallet\r\n{\r\n  \"name\": \"whynokeys\",\r\n  \"warning\": \"\"\r\n}\r\nrunning importprivkey 1\r\nrunning importprivkey 2\r\nrunning importmulti\r\nerror: Could not connect to the server 127.0.0.1:18332 (error code 1 - \"EOF reached\")\r\n\r\nMake sure the bitcoind server is running and that you are connecting to the correct RPC port.\r\nrunning listunspent\r\nerror: Could not connect to the server 127.0.0.1:18332\r\n\r\nMake sure the bitcoind server is running and that you are connecting to the correct RPC port.\r\nall done\r\n[1]+  Segmentation fault      ./bitcoin-0.19.0.1/bin/bitcoin-qt -server\r\n\r\n```\r\n\r\nThough sometimes the importmulti completes and the segfault doesn't occur until the listunspent.\r\n\r\nIf you uncomment all the `sleep 4` lines, this works every time without segfault, however the importmulti gives a bogus warning:\r\n\r\n```\r\nrunning createwallet\r\n{\r\n  \"name\": \"whynokeys\",\r\n  \"warning\": \"\"\r\n}\r\nrunning importprivkey 1\r\nrunning importprivkey 2\r\nrunning importmulti\r\n[\r\n  {\r\n    \"success\": true,\r\n    \"warnings\": [\r\n      \"Some private keys are missing, outputs will be considered watchonly. If this is intentional, specify the watchonly flag.\"\r\n    ]\r\n  }\r\n]\r\nrunning listunspent\r\n[\r\n  {\r\n    \"txid\": \"d322f58c03fab2526d9cd32baa3ab5e1719a6841a59b92494aa58d2fd2447be1\",\r\n    \"vout\": 1,\r\n    \"address\": \"2NBeG2myyAwSUCv1L21kTHAA3SdMELxdspi\",\r\n    \"label\": \"\",\r\n    \"redeemScript\": \"512103b7e7e3dacb0ad6f1e2bee28a7a5e8842152a8232f36be55bba66243aee77b95c21039dd05437b699bf98ea32ed3217d0aeb5a5a5fd76a343bebeec6e56968aa9bf0d52ae\",\r\n    \"scriptPubKey\": \"a914c9cd895fba08d0cfb13510fd8a4c6be8ad70bd6c87\",\r\n    \"amount\": 0.02100000,\r\n    \"confirmations\": 80,\r\n    \"spendable\": true,\r\n    \"solvable\": true,\r\n    \"desc\": \"sh(multi(1,[c9d3ec21]03b7e7e3dacb0ad6f1e2bee28a7a5e8842152a8232f36be55bba66243aee77b95c,[5e88ca09]039dd05437b699bf98ea32ed3217d0aeb5a5a5fd76a343bebeec6e56968aa9bf0d))#z2pgdmn0\",\r\n    \"safe\": true\r\n  }\r\n]\r\nall done\r\n```\r\n\r\nI doublechecked that the two privkeys imported do match the pubkeys in the redeem script. Also notice that listunspent claims they are spendable and solvable, as expected. Therefore the warning about missing private keys is bogus.\r\n\r\n\r\n**Expected behavior**\r\n\r\n* No segfault\r\n* No warning from importmulti\r\n\r\n**Actual behavior**\r\n\r\n* Segfault\r\n* (after adding delays to script) bogus warning from importmulti\r\n\r\n**To reproduce**\r\n\r\nSee above script. Segfault is not 100% reliable but probably 90%. The bogus warning is 100% reproducible.\r\n\r\n**System information**\r\n\r\nRunning Bitcoin Core 0.19.0.1 on Whonix 14. First noticed on my own build of 0.19.0.1, also reproduced on official download of bitcoin-0.19.0.1-x86_64-linux-gnu.tar.gz.\r\n\r\nDebug log from (successful, non-segfaulting) importmulti:\r\n```\r\n2020-01-12T04:24:07Z Using BerkeleyDB version Berkeley DB 4.8.30: (April  9, 2010)\r\n2020-01-12T04:24:07Z Using wallet /home/user/.bitcoin/testnet3/whynokeys\r\n2020-01-12T04:24:07Z BerkeleyEnvironment::Open: LogDir=/home/user/.bitcoin/testnet3/whynokeys/database ErrorFile=\r\n/home/user/.bitcoin/testnet3/whynokeys/db.log\r\n2020-01-12T04:24:07Z init message: Loading wallet...\r\n2020-01-12T04:24:07Z BerkeleyEnvironment::Open: LogDir=/home/user/.bitcoin/testnet3/whynokeys/database ErrorFile=/home/user/.bitcoin/testnet3/whynokeys/db.log\r\n2020-01-12T04:24:07Z [whynokeys] Wallet File Version = 10500\r\n2020-01-12T04:24:07Z [whynokeys] Keys: 0 plaintext, 0 encrypted, 0 w/ metadata, 0 total. Unknown wallet records: 0\r\n2020-01-12T04:24:07Z [whynokeys] Performing wallet upgrade to 169900\r\n2020-01-12T04:24:08Z [whynokeys] keypool added 2000 keys (1000 internal), size=2000 (1000 internal)\r\n2020-01-12T04:24:08Z [whynokeys] Wallet completed loading in            1476ms\r\n2020-01-12T04:24:08Z [whynokeys] setKeyPool.size() = 2000\r\n2020-01-12T04:24:08Z [whynokeys] mapWallet.size() = 0\r\n2020-01-12T04:24:08Z [whynokeys] mapAddressBook.size() = 0\r\n2020-01-12T04:24:08Z New outbound peer connected: version: 70015, blocks=1659728, peer=7 (full-relay)\r\n2020-01-12T04:24:09Z New outbound peer connected: version: 70015, blocks=1659728, peer=8 (full-relay)\r\n2020-01-12T04:24:09Z P2P peers available. Skipped DNS seeding.\r\n2020-01-12T04:24:09Z dnsseed thread exit\r\n2020-01-12T04:24:12Z [whynokeys] Already have script 0014c9d3ec21d7a7667dd8317255d9b604ca0a3b73d5, skipping\r\n2020-01-12T04:24:16Z [whynokeys] Already have script 00145e88ca0914a704056bc79b25a958d2d543900ef2, skipping\r\n2020-01-12T04:24:20Z [whynokeys] RescanFromTime: Rescanning last 140 blocks\r\n2020-01-12T04:24:20Z [whynokeys] Rescan started from block 00000000000007d256a92bfb67e59ecda20fc5728ce36f7404a2bc7c34853378...\r\n2020-01-12T04:24:20Z [whynokeys] AddToWallet d322f58c03fab2526d9cd32baa3ab5e1719a6841a59b92494aa58d2fd2447be1  new\r\n2020-01-12T04:24:20Z [whynokeys] Rescan completed in              32ms\r\n```",
   "closed_at" : "2020-02-06T06:43:49Z",
   "closed_by" : {
      "avatar_url" : "https://avatars2.githubusercontent.com/u/863730?v=4",
      "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
      "followers_url" : "https://api.github.com/users/fanquake/followers",
      "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
      "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/fanquake",
      "id" : 863730,
      "login" : "fanquake",
      "node_id" : "MDQ6VXNlcjg2MzczMA==",
      "organizations_url" : "https://api.github.com/users/fanquake/orgs",
      "received_events_url" : "https://api.github.com/users/fanquake/received_events",
      "repos_url" : "https://api.github.com/users/fanquake/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/fanquake"
   },
   "comments" : 6,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17911/comments",
   "created_at" : "2020-01-12T04:36:36Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17911/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/17911",
   "id" : 548520166,
   "labels" : [
      {
         "color" : "FBBAAB",
         "default" : false,
         "description" : null,
         "id" : 64585,
         "name" : "Bug",
         "node_id" : "MDU6TGFiZWw2NDU4NQ==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Bug"
      },
      {
         "color" : "02d7e1",
         "default" : false,
         "description" : null,
         "id" : 135946,
         "name" : "GUI",
         "node_id" : "MDU6TGFiZWwxMzU5NDY=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/GUI"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17911/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDU6SXNzdWU1NDg1MjAxNjY=",
   "number" : 17911,
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "segfault from importmulti",
   "updated_at" : "2020-02-06T06:43:49Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17911",
   "user" : {
      "avatar_url" : "https://avatars3.githubusercontent.com/u/31543633?v=4",
      "events_url" : "https://api.github.com/users/bitcoinhodler/events{/privacy}",
      "followers_url" : "https://api.github.com/users/bitcoinhodler/followers",
      "following_url" : "https://api.github.com/users/bitcoinhodler/following{/other_user}",
      "gists_url" : "https://api.github.com/users/bitcoinhodler/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/bitcoinhodler",
      "id" : 31543633,
      "login" : "bitcoinhodler",
      "node_id" : "MDQ6VXNlcjMxNTQzNjMz",
      "organizations_url" : "https://api.github.com/users/bitcoinhodler/orgs",
      "received_events_url" : "https://api.github.com/users/bitcoinhodler/received_events",
      "repos_url" : "https://api.github.com/users/bitcoinhodler/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/bitcoinhodler/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/bitcoinhodler/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/bitcoinhodler"
   }
}
