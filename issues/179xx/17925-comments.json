[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r366586660"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/366586660"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't see initializations for these variables anywhere?",
      "commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "created_at" : "2020-01-14T21:40:24Z",
      "diff_hunk" : "@@ -453,6 +454,8 @@ class CTxMemPool\n     mutable int64_t lastRollingFeeUpdate;\n     mutable bool blockSinceLastRollingFeeBump;\n     mutable double rollingMinimumFeeRate; //!< minimum fee to get into the pool, decreases exponentially\n+    mutable uint64_t m_epoch;\n+    mutable bool has_epoch_guard;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r366586660",
      "id" : 366586660,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjU4NjY2MA==",
      "original_commit_id" : "d63d1f3714d805574e23ca49402ed9a75691f0b3",
      "original_position" : 13,
      "path" : "src/txmempool.h",
      "position" : null,
      "pull_request_review_id" : 342856863,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925",
      "updated_at" : "2020-01-15T03:30:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/366586660",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r366591661"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/366591661"
         }
      },
      "author_association" : "MEMBER",
      "body" : "A bit confusing to have this comment (about a function) right before a class definition, I'm guessing it is leftover from something else (or should be moved a few lines down). \r\n\r\nActually I think it'd make sense to explain here a little bit about what these epochs are and why/how to use them?  (Also, as this would be the first introduction of epochs in the code, it'd be helpful for reviewers of the future PRs that will use it in more places to be able to remember/understand what this construction is.)  Perhaps something like:\r\n\r\n```\r\nEpochGuard: RAII-style guard for using epoch-based graph traversal algorithms\r\nWhen walking ancestors or descendants, we generally want to avoid visiting the \r\nsame transactions twice. In some places we use std::set (or setEntries) to deduplicate\r\n what we visit, but we can do (algorithmically) better by using a counter (\"epoch\") that \r\nwe set on each transaction and comparing against a global epoch to track whether \r\nwe've visited something already during a calculation.\r\n```\r\nOr something like that...",
      "commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "created_at" : "2020-01-14T21:52:02Z",
      "diff_hunk" : "@@ -736,6 +739,34 @@ class CTxMemPool\n      *  removal.\n      */\n     void removeUnchecked(txiter entry, MemPoolRemovalReason reason) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+public:\n+    // This function mutates mutable state!",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r366591661",
      "id" : 366591661,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjU5MTY2MQ==",
      "original_commit_id" : "d63d1f3714d805574e23ca49402ed9a75691f0b3",
      "original_position" : 22,
      "path" : "src/txmempool.h",
      "position" : null,
      "pull_request_review_id" : 342856863,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925",
      "updated_at" : "2020-01-15T03:30:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/366591661",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#17786](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/17786.html) (refactor: Nuke policy/fees->mempool circular dependencies by hebasto)\n* [#16910](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16910.html) (wallet: reduce loading time by using unordered maps by achow101)\n* [#10443](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/10443.html) (Add fee_est tool for debugging fee estimation code by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-01-14T22:27:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#issuecomment-574403928",
      "id" : 574403928,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17925",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3NDQwMzkyOA==",
      "updated_at" : "2020-01-16T21:06:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/574403928",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r366682083"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/366682083"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "great comment; rewrote it slightly to a format I think is more clear & also to emphasize that replacement with epochs is ongoing work :)",
      "commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "created_at" : "2020-01-15T03:31:01Z",
      "diff_hunk" : "@@ -736,6 +739,34 @@ class CTxMemPool\n      *  removal.\n      */\n     void removeUnchecked(txiter entry, MemPoolRemovalReason reason) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+public:\n+    // This function mutates mutable state!",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r366682083",
      "id" : 366682083,
      "in_reply_to_id" : 366591661,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjY4MjA4Mw==",
      "original_commit_id" : "d63d1f3714d805574e23ca49402ed9a75691f0b3",
      "original_position" : 22,
      "path" : "src/txmempool.h",
      "position" : null,
      "pull_request_review_id" : 342972129,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925",
      "updated_at" : "2020-01-15T03:31:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/366682083",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I don't know what's up with the appveyor build but I think this code is correct, it passes all tests for me locally.  \r\n\r\nAs a sanity check, I verified that this code does give a speedup in a simple scenario where it would be expected to improve things: create a transaction with 2000 outputs that is confirmed in a block; then spend each of those outputs in a separate transaction in the mempool; then disconnect the block and measure the time spent in UpdateTransactionsFromBlock (which must visit each of those 2000 children).  I observed a roughly 12% improvement in runtime in this simple test.\r\n\r\nACK bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "created_at" : "2020-01-16T15:32:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#issuecomment-575206318",
      "id" : 575206318,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17925",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3NTIwNjMxOA==",
      "updated_at" : "2020-01-16T15:32:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/575206318",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r369914044"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/369914044"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think this would be cleaner with the 'epoch' concept split out. I'm thinking:\r\n\r\n```c++\r\nclass Epoch {\r\npublic:\r\n    uint64_t m_epoch;\r\n    bool m_guarded;\r\n\r\n    Epoch() : m_epoch{0}, m_guarded{false} {}\r\n    Epoch(const Epoch&) = delete; // no copy constructor\r\n    Epoch& operator=(const Epoch&) = delete; // not assignable\r\n\r\n    class SCOPED_LOCKABLE Guard {\r\n        Epoch& m_epoch;\r\n    public:\r\n        Guard(Epoch& epoch) EXCLUSIVE_LOCK_FUNCTION(epoch) LOCKS_EXCLUDED(epoch);\r\n        ~Guard() UNLOCK_FUNCTION();\r\n    };\r\n};\r\n#define WITH_EPOCH(epoch) const Epoch::Guard PASTE2(epoch_guard_, __COUNTER__)(epoch)\r\n```\r\nand\r\n\r\n```c++\r\nclass CTxMemPool {\r\n    void UpdateTransactionsFromBlock(const std::vector<uint256>& vHashesToUpdate) EXCLUSIVE_LOCKS_REQUIRED(cs, cs_main) LOCKS_EXCLUDED(m_epoch);\r\n.\r\n    mutable Epoch m_epoch GUARDED_BY(cs);\r\n    bool visited(txiter it) const EXCLUSIVE_LOCKS_REQUIRED(cs, m_epoch) { .. }\r\n};\r\n```\r\n\r\nand\r\n\r\n```c++\r\n    WITH_EPOCH(m_epoch); // instead of const auto epoch = GetFreshEpoch()\r\n```\r\n\r\nThis lets clang check `visited()`  is only invoked within an epoch at compile time, which seems nice.\r\n\r\nUsing `LOCKS_EXCLUDED` gets part of the way to ensuring you're not doing `WITH_EPOCH` recursively at compile time (eg, holding it from UpdateTxsFromBlock while calling UpdateForDescendants once UpdForDesc has been epoch-ised), but only works as long as you don't have indirect invocations -- ie if A() calls B() and B() is marked with LOCKS_EXCLUDED, that doesn't cause A() to also be marked with LOCKS_EXCLUDED.\r\n\r\nThis also makes the mutability/constness stuff clearer -- in my opinion, anyway.",
      "commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "created_at" : "2020-01-23T03:06:51Z",
      "diff_hunk" : "@@ -736,6 +739,55 @@ class CTxMemPool\n      *  removal.\n      */\n     void removeUnchecked(txiter entry, MemPoolRemovalReason reason) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+public:\n+    /** EpochGuard: RAII-style guard for using epoch-based graph traversal algorithms.\n+     *     When walking ancestors or descendants, we generally want to avoid\n+     * visiting the same transactions twice. Some traversal algorithms use\n+     * std::set (or setEntries) to deduplicate the transaction we visit.\n+     * However, use of std::set is algorithmically undesirable because it both\n+     * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+     * more dynamic memory allocations.\n+     *     In many algorithms we can replace std::set with an internal mempool\n+     * counter to track the time (or, \"epoch\") that we began a traversal, and\n+     * check + update a per-transaction epoch for each transaction we look at to\n+     * determine if that transaction has not yet been visited during the current\n+     * traversal's epoch.\n+     *     Algorithms using std::set can be replaced on a one by one basis.\n+     * Both techniques are not fundamentally incomaptible across the codebase.\n+     * Generally speaking, however, the remaining use of std::set for mempool\n+     * traversal should be viewed as a TODO for replacement with an epoch based\n+     * traversal, rather than a preference for std::set over epochs in that\n+     * algorithm.\n+     */\n+    class EpochGuard {\n+        const CTxMemPool& pool;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r369914044",
      "id" : 369914044,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTkxNDA0NA==",
      "original_commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "original_position" : 42,
      "path" : "src/txmempool.h",
      "position" : 42,
      "pull_request_review_id" : 347037291,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925",
      "updated_at" : "2020-01-23T04:12:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/369914044",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r369914759"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/369914759"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This function doesn't seem to be needed yet; suggest deferring it until it is.",
      "commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "created_at" : "2020-01-23T03:11:07Z",
      "diff_hunk" : "@@ -736,6 +739,55 @@ class CTxMemPool\n      *  removal.\n      */\n     void removeUnchecked(txiter entry, MemPoolRemovalReason reason) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+public:\n+    /** EpochGuard: RAII-style guard for using epoch-based graph traversal algorithms.\n+     *     When walking ancestors or descendants, we generally want to avoid\n+     * visiting the same transactions twice. Some traversal algorithms use\n+     * std::set (or setEntries) to deduplicate the transaction we visit.\n+     * However, use of std::set is algorithmically undesirable because it both\n+     * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+     * more dynamic memory allocations.\n+     *     In many algorithms we can replace std::set with an internal mempool\n+     * counter to track the time (or, \"epoch\") that we began a traversal, and\n+     * check + update a per-transaction epoch for each transaction we look at to\n+     * determine if that transaction has not yet been visited during the current\n+     * traversal's epoch.\n+     *     Algorithms using std::set can be replaced on a one by one basis.\n+     * Both techniques are not fundamentally incomaptible across the codebase.\n+     * Generally speaking, however, the remaining use of std::set for mempool\n+     * traversal should be viewed as a TODO for replacement with an epoch based\n+     * traversal, rather than a preference for std::set over epochs in that\n+     * algorithm.\n+     */\n+    class EpochGuard {\n+        const CTxMemPool& pool;\n+        public:\n+        EpochGuard(const CTxMemPool& in);\n+        ~EpochGuard();\n+    };\n+    // N.B. GetFreshEpoch modifies mutable state via the EpochGuard construction\n+    // (and later destruction)\n+    EpochGuard GetFreshEpoch() const EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    /** visited marks a CTxMemPoolEntry as having been traversed\n+     * during the lifetime of the most recently created EpochGuard\n+     * and returns false if we are the first visitor, true otherwise.\n+     *\n+     * An EpochGuard must be held when visited is called or an assert will be\n+     * triggered.\n+     *\n+     */\n+    bool visited(txiter it) const EXCLUSIVE_LOCKS_REQUIRED(cs) {\n+        assert(m_has_epoch_guard);\n+        bool ret = it->m_epoch >= m_epoch;\n+        it->m_epoch = std::max(it->m_epoch, m_epoch);\n+        return ret;\n+    }\n+\n+    bool visited(Optional<txiter> it) const EXCLUSIVE_LOCKS_REQUIRED(cs) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r369914759",
      "id" : 369914759,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTkxNDc1OQ==",
      "original_commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "original_position" : 66,
      "path" : "src/txmempool.h",
      "position" : 66,
      "pull_request_review_id" : 347037291,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925",
      "updated_at" : "2020-01-23T04:12:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/369914759",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r369915441"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/369915441"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think:\r\n\r\n```c++\r\nbool visited(txiter it) const {\r\n    assert(m_has_epoch_guard);\r\n    bool visited = it->m_epoch == m_epoch; // only visits this epoch count\r\n    if (!visited) it->m_epoch = m_epoch;\r\n    return visited;\r\n}\r\n```\r\n\r\nwould be clearer. (Also, this could be `const txiter it` since you're only changing what the iter points at)",
      "commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "created_at" : "2020-01-23T03:15:24Z",
      "diff_hunk" : "@@ -736,6 +739,55 @@ class CTxMemPool\n      *  removal.\n      */\n     void removeUnchecked(txiter entry, MemPoolRemovalReason reason) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+public:\n+    /** EpochGuard: RAII-style guard for using epoch-based graph traversal algorithms.\n+     *     When walking ancestors or descendants, we generally want to avoid\n+     * visiting the same transactions twice. Some traversal algorithms use\n+     * std::set (or setEntries) to deduplicate the transaction we visit.\n+     * However, use of std::set is algorithmically undesirable because it both\n+     * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+     * more dynamic memory allocations.\n+     *     In many algorithms we can replace std::set with an internal mempool\n+     * counter to track the time (or, \"epoch\") that we began a traversal, and\n+     * check + update a per-transaction epoch for each transaction we look at to\n+     * determine if that transaction has not yet been visited during the current\n+     * traversal's epoch.\n+     *     Algorithms using std::set can be replaced on a one by one basis.\n+     * Both techniques are not fundamentally incomaptible across the codebase.\n+     * Generally speaking, however, the remaining use of std::set for mempool\n+     * traversal should be viewed as a TODO for replacement with an epoch based\n+     * traversal, rather than a preference for std::set over epochs in that\n+     * algorithm.\n+     */\n+    class EpochGuard {\n+        const CTxMemPool& pool;\n+        public:\n+        EpochGuard(const CTxMemPool& in);\n+        ~EpochGuard();\n+    };\n+    // N.B. GetFreshEpoch modifies mutable state via the EpochGuard construction\n+    // (and later destruction)\n+    EpochGuard GetFreshEpoch() const EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    /** visited marks a CTxMemPoolEntry as having been traversed\n+     * during the lifetime of the most recently created EpochGuard\n+     * and returns false if we are the first visitor, true otherwise.\n+     *\n+     * An EpochGuard must be held when visited is called or an assert will be\n+     * triggered.\n+     *\n+     */\n+    bool visited(txiter it) const EXCLUSIVE_LOCKS_REQUIRED(cs) {\n+        assert(m_has_epoch_guard);\n+        bool ret = it->m_epoch >= m_epoch;\n+        it->m_epoch = std::max(it->m_epoch, m_epoch);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r369915441",
      "id" : 369915441,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTkxNTQ0MQ==",
      "original_commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "original_position" : 62,
      "path" : "src/txmempool.h",
      "position" : 62,
      "pull_request_review_id" : 347037291,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925",
      "updated_at" : "2020-01-23T04:12:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/369915441",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r370418775"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/370418775"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hmm... I think that you're right that this code is somehow better, but TBH I don't really understand how the clang lock analyzing stuff works & don't know if I could personally maintain this code... Is there anything better to look at than http://releases.llvm.org/3.5.0/tools/clang/docs/ThreadSafetyAnalysis.html on how to understand this clang extension?\r\n\r\nAny objection to this being a follow on PR?\r\n\r\nI also have concern that this isn't compatible with future changes that may recursively use the epoch guard (there are algorithms that are recursive reuse safe, if you want to express a case where A has an epoch which calls B, and B creates a new Epoch which may re-traverse all of the mempool entries but A will not re-traverse anything traversed in B). You could imagine a use for this if I wanted to walk the whole mempool and traverse every connected component once, but at the same time.\r\n\r\nThis requires some modified behavior (e.g., making epoch guards aware of the epoch they are guarding), but can still work.\r\n\r\n```c++\r\nconst auto epoch = GetFreshEpoch();\r\nfor (auto& elt : mapTx) {\r\n    if (epoch.visited(elt)) continue;\r\n    const auto epoch = epoch.SubEpoch();\r\n    vector<txiter> component;\r\n    GetAllAncestorsEpochAlreadyHeld(elt, component);\r\n    GetAllDescendentsEpochAlreadyHeld(elt, component);\r\n    DoSomethingWithComponent(component);\r\n}\r\n```",
      "commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "created_at" : "2020-01-24T00:05:37Z",
      "diff_hunk" : "@@ -736,6 +739,55 @@ class CTxMemPool\n      *  removal.\n      */\n     void removeUnchecked(txiter entry, MemPoolRemovalReason reason) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+public:\n+    /** EpochGuard: RAII-style guard for using epoch-based graph traversal algorithms.\n+     *     When walking ancestors or descendants, we generally want to avoid\n+     * visiting the same transactions twice. Some traversal algorithms use\n+     * std::set (or setEntries) to deduplicate the transaction we visit.\n+     * However, use of std::set is algorithmically undesirable because it both\n+     * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+     * more dynamic memory allocations.\n+     *     In many algorithms we can replace std::set with an internal mempool\n+     * counter to track the time (or, \"epoch\") that we began a traversal, and\n+     * check + update a per-transaction epoch for each transaction we look at to\n+     * determine if that transaction has not yet been visited during the current\n+     * traversal's epoch.\n+     *     Algorithms using std::set can be replaced on a one by one basis.\n+     * Both techniques are not fundamentally incomaptible across the codebase.\n+     * Generally speaking, however, the remaining use of std::set for mempool\n+     * traversal should be viewed as a TODO for replacement with an epoch based\n+     * traversal, rather than a preference for std::set over epochs in that\n+     * algorithm.\n+     */\n+    class EpochGuard {\n+        const CTxMemPool& pool;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r370418775",
      "id" : 370418775,
      "in_reply_to_id" : 369914044,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQxODc3NQ==",
      "original_commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "original_position" : 42,
      "path" : "src/txmempool.h",
      "position" : 42,
      "pull_request_review_id" : 347688071,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925",
      "updated_at" : "2020-01-24T00:05:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/370418775",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r370419851"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/370419851"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "See above for note on future recursive locking -- given that this is a future concern, I agree it could be postponed, but I like that the current version of the code wouldn't have to change if modified.\r\n\r\nIn your version it's also not clear that if `it->m_epoch != m_epoch`, that `!(it->m_epoch > m_epoch)`, which violates the contract that `it->m_epoch` should be monotonic.\r\n\r\nIt's easier IMO to validate this by using std::max, then `it->m_epoch` is guaranteed to weakly increase.",
      "commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "created_at" : "2020-01-24T00:09:38Z",
      "diff_hunk" : "@@ -736,6 +739,55 @@ class CTxMemPool\n      *  removal.\n      */\n     void removeUnchecked(txiter entry, MemPoolRemovalReason reason) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+public:\n+    /** EpochGuard: RAII-style guard for using epoch-based graph traversal algorithms.\n+     *     When walking ancestors or descendants, we generally want to avoid\n+     * visiting the same transactions twice. Some traversal algorithms use\n+     * std::set (or setEntries) to deduplicate the transaction we visit.\n+     * However, use of std::set is algorithmically undesirable because it both\n+     * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+     * more dynamic memory allocations.\n+     *     In many algorithms we can replace std::set with an internal mempool\n+     * counter to track the time (or, \"epoch\") that we began a traversal, and\n+     * check + update a per-transaction epoch for each transaction we look at to\n+     * determine if that transaction has not yet been visited during the current\n+     * traversal's epoch.\n+     *     Algorithms using std::set can be replaced on a one by one basis.\n+     * Both techniques are not fundamentally incomaptible across the codebase.\n+     * Generally speaking, however, the remaining use of std::set for mempool\n+     * traversal should be viewed as a TODO for replacement with an epoch based\n+     * traversal, rather than a preference for std::set over epochs in that\n+     * algorithm.\n+     */\n+    class EpochGuard {\n+        const CTxMemPool& pool;\n+        public:\n+        EpochGuard(const CTxMemPool& in);\n+        ~EpochGuard();\n+    };\n+    // N.B. GetFreshEpoch modifies mutable state via the EpochGuard construction\n+    // (and later destruction)\n+    EpochGuard GetFreshEpoch() const EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    /** visited marks a CTxMemPoolEntry as having been traversed\n+     * during the lifetime of the most recently created EpochGuard\n+     * and returns false if we are the first visitor, true otherwise.\n+     *\n+     * An EpochGuard must be held when visited is called or an assert will be\n+     * triggered.\n+     *\n+     */\n+    bool visited(txiter it) const EXCLUSIVE_LOCKS_REQUIRED(cs) {\n+        assert(m_has_epoch_guard);\n+        bool ret = it->m_epoch >= m_epoch;\n+        it->m_epoch = std::max(it->m_epoch, m_epoch);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r370419851",
      "id" : 370419851,
      "in_reply_to_id" : 369915441,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQxOTg1MQ==",
      "original_commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "original_position" : 62,
      "path" : "src/txmempool.h",
      "position" : 62,
      "pull_request_review_id" : 347689397,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925",
      "updated_at" : "2020-01-24T00:09:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/370419851",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r370422247"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/370422247"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Correct; it's not needed yet. I'm indifferent on if it stays or goes. I figured it's better for it to live in the same commit as the introduction of it's non-optioned version, but unused functions aren't great to introduce.\r\n\r\nGiven that:\r\n1) It will be introduced in later work, relatively soon\r\n2) There's already an ack for this specific revision -- meaning both that this function has already been reviewed and doesn't require re-review in the future, but also that we won't make suhas have to re-ack this change.\r\n3) There's nothing detectable *wrong* with it\r\n\r\nI'd rather just keep it for now and focus on getting out the PR that depends on it sooner.",
      "commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "created_at" : "2020-01-24T00:19:04Z",
      "diff_hunk" : "@@ -736,6 +739,55 @@ class CTxMemPool\n      *  removal.\n      */\n     void removeUnchecked(txiter entry, MemPoolRemovalReason reason) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+public:\n+    /** EpochGuard: RAII-style guard for using epoch-based graph traversal algorithms.\n+     *     When walking ancestors or descendants, we generally want to avoid\n+     * visiting the same transactions twice. Some traversal algorithms use\n+     * std::set (or setEntries) to deduplicate the transaction we visit.\n+     * However, use of std::set is algorithmically undesirable because it both\n+     * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+     * more dynamic memory allocations.\n+     *     In many algorithms we can replace std::set with an internal mempool\n+     * counter to track the time (or, \"epoch\") that we began a traversal, and\n+     * check + update a per-transaction epoch for each transaction we look at to\n+     * determine if that transaction has not yet been visited during the current\n+     * traversal's epoch.\n+     *     Algorithms using std::set can be replaced on a one by one basis.\n+     * Both techniques are not fundamentally incomaptible across the codebase.\n+     * Generally speaking, however, the remaining use of std::set for mempool\n+     * traversal should be viewed as a TODO for replacement with an epoch based\n+     * traversal, rather than a preference for std::set over epochs in that\n+     * algorithm.\n+     */\n+    class EpochGuard {\n+        const CTxMemPool& pool;\n+        public:\n+        EpochGuard(const CTxMemPool& in);\n+        ~EpochGuard();\n+    };\n+    // N.B. GetFreshEpoch modifies mutable state via the EpochGuard construction\n+    // (and later destruction)\n+    EpochGuard GetFreshEpoch() const EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    /** visited marks a CTxMemPoolEntry as having been traversed\n+     * during the lifetime of the most recently created EpochGuard\n+     * and returns false if we are the first visitor, true otherwise.\n+     *\n+     * An EpochGuard must be held when visited is called or an assert will be\n+     * triggered.\n+     *\n+     */\n+    bool visited(txiter it) const EXCLUSIVE_LOCKS_REQUIRED(cs) {\n+        assert(m_has_epoch_guard);\n+        bool ret = it->m_epoch >= m_epoch;\n+        it->m_epoch = std::max(it->m_epoch, m_epoch);\n+        return ret;\n+    }\n+\n+    bool visited(Optional<txiter> it) const EXCLUSIVE_LOCKS_REQUIRED(cs) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r370422247",
      "id" : 370422247,
      "in_reply_to_id" : 369914759,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQyMjI0Nw==",
      "original_commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "original_position" : 66,
      "path" : "src/txmempool.h",
      "position" : 66,
      "pull_request_review_id" : 347692275,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925",
      "updated_at" : "2020-01-24T00:19:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/370422247",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r371514906"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/371514906"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "2ccb7cc\r\n\r\nI think you considered it but why not m_entry_epoch, to avoid names collision for reviewers?",
      "commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "created_at" : "2020-01-27T22:19:18Z",
      "diff_hunk" : "@@ -129,6 +129,7 @@ class CTxMemPoolEntry\n     int64_t GetSigOpCostWithAncestors() const { return nSigOpCostWithAncestors; }\n \n     mutable size_t vTxHashesIdx; //!< Index in mempool's vTxHashes\n+    mutable uint64_t m_epoch; //!< epoch when last touched, useful for graph algorithms",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r371514906",
      "id" : 371514906,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUxNDkwNg==",
      "original_commit_id" : "2ccb7cca4ac67198ac89bd58f5b4ae41a5163ceb",
      "original_position" : 4,
      "path" : "src/txmempool.h",
      "position" : 4,
      "pull_request_review_id" : 349015911,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925",
      "updated_at" : "2020-01-27T22:59:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/371514906",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r371523359"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/371523359"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "2ccb7cc\r\n\r\nWhat kind of stale scenario do you envision here ? \r\n\r\nIf taking twice the epoch is attempted, the assert will be hit and should be able to spot this kind of programming error. \r\n\r\nOtherwise, if you prevent `visited` returning true for past value, I think that's bettter than enforcing lock taking on epoch (because worst-case you reprocess an entry, which is better than taking a lock on the average-case, this maybe contrary to AJ opinion).",
      "commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "created_at" : "2020-01-27T22:40:23Z",
      "diff_hunk" : "@@ -1105,4 +1105,23 @@ void CTxMemPool::SetIsLoaded(bool loaded)\n     m_is_loaded = loaded;\n }\n \n+\n+CTxMemPool::EpochGuard CTxMemPool::GetFreshEpoch() const\n+{\n+    return EpochGuard(*this);\n+}\n+CTxMemPool::EpochGuard::EpochGuard(const CTxMemPool& in) : pool(in)\n+{\n+    assert(!pool.m_has_epoch_guard);\n+    ++pool.m_epoch;\n+    pool.m_has_epoch_guard = true;\n+}\n+\n+CTxMemPool::EpochGuard::~EpochGuard()\n+{\n+    // prevents stale results being used\n+    ++pool.m_epoch;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r371523359",
      "id" : 371523359,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUyMzM1OQ==",
      "original_commit_id" : "2ccb7cca4ac67198ac89bd58f5b4ae41a5163ceb",
      "original_position" : 37,
      "path" : "src/txmempool.cpp",
      "position" : 78,
      "pull_request_review_id" : 349015911,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925",
      "updated_at" : "2020-01-27T22:59:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/371523359",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r371589102"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/371589102"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If you're doing an \"already held\" thing, as far as clang goes that's just marking up the function with \"EXCLUSIVE_LOCKS_REQUIRED(epoch)\". I think something like:\r\n\r\n```c++\r\nclass SubEpoch { uint64_t subepoch; }\r\nclass TxMemPool {\r\n  ...\r\n  GetAllAncestorsEpochAlreadyHeld(elt, vector<txiter>& component, const SubEpoch& subepoch) EXCLUSIVE_LOCKS_REQUIRED(epoch);\r\n};\r\n```\r\n\r\nwould make things pretty typesafe.\r\n\r\nIn the example you give, if you had a tx graph: \r\n\r\n * A outputs A.0, A.1\r\n * B spends A.0, output B.0\r\n * C spends A.1, output C.0\r\n * D spends B.0, C.0\r\n\r\nthen if you traverse mapTx ordered as B,A,C,D you'll do {B,A,D} first, then {C,A,D} second; while if you'd traversed A or D first, you'd do {A,B,C,D} or {D,A,B,C} all in one go. I can't see why you'd end up with an algorithm like that.\r\n\r\nYeah, doing the refactor as a separate PR sounds fine",
      "commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "created_at" : "2020-01-28T02:55:51Z",
      "diff_hunk" : "@@ -736,6 +739,55 @@ class CTxMemPool\n      *  removal.\n      */\n     void removeUnchecked(txiter entry, MemPoolRemovalReason reason) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+public:\n+    /** EpochGuard: RAII-style guard for using epoch-based graph traversal algorithms.\n+     *     When walking ancestors or descendants, we generally want to avoid\n+     * visiting the same transactions twice. Some traversal algorithms use\n+     * std::set (or setEntries) to deduplicate the transaction we visit.\n+     * However, use of std::set is algorithmically undesirable because it both\n+     * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+     * more dynamic memory allocations.\n+     *     In many algorithms we can replace std::set with an internal mempool\n+     * counter to track the time (or, \"epoch\") that we began a traversal, and\n+     * check + update a per-transaction epoch for each transaction we look at to\n+     * determine if that transaction has not yet been visited during the current\n+     * traversal's epoch.\n+     *     Algorithms using std::set can be replaced on a one by one basis.\n+     * Both techniques are not fundamentally incomaptible across the codebase.\n+     * Generally speaking, however, the remaining use of std::set for mempool\n+     * traversal should be viewed as a TODO for replacement with an epoch based\n+     * traversal, rather than a preference for std::set over epochs in that\n+     * algorithm.\n+     */\n+    class EpochGuard {\n+        const CTxMemPool& pool;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r371589102",
      "id" : 371589102,
      "in_reply_to_id" : 369914044,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU4OTEwMg==",
      "original_commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "original_position" : 42,
      "path" : "src/txmempool.h",
      "position" : 42,
      "pull_request_review_id" : 349105816,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925",
      "updated_at" : "2020-01-28T02:55:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/371589102",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r371984087"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/371984087"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "@ajtowns so I think you're missing the algorithm that I suggested slightly, you'd actually in this case traverse all of {A, B, C, D} in the first sub-epoch, because you would be traversing all parents and children recursively.\r\n\r\nSo if you had another transaction E, with only confirmed inputs, and F which spends E.0, then you would output:\r\n\r\n{{A, B, C, D}, {E, F}}\r\n\r\nHence being able to traverse the mempool and pick out connected components.\r\n\r\nHowever, on further thought it occurs to me that this sort of algorithm would not require sub-epochs at all.",
      "commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "created_at" : "2020-01-28T18:37:47Z",
      "diff_hunk" : "@@ -736,6 +739,55 @@ class CTxMemPool\n      *  removal.\n      */\n     void removeUnchecked(txiter entry, MemPoolRemovalReason reason) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+public:\n+    /** EpochGuard: RAII-style guard for using epoch-based graph traversal algorithms.\n+     *     When walking ancestors or descendants, we generally want to avoid\n+     * visiting the same transactions twice. Some traversal algorithms use\n+     * std::set (or setEntries) to deduplicate the transaction we visit.\n+     * However, use of std::set is algorithmically undesirable because it both\n+     * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+     * more dynamic memory allocations.\n+     *     In many algorithms we can replace std::set with an internal mempool\n+     * counter to track the time (or, \"epoch\") that we began a traversal, and\n+     * check + update a per-transaction epoch for each transaction we look at to\n+     * determine if that transaction has not yet been visited during the current\n+     * traversal's epoch.\n+     *     Algorithms using std::set can be replaced on a one by one basis.\n+     * Both techniques are not fundamentally incomaptible across the codebase.\n+     * Generally speaking, however, the remaining use of std::set for mempool\n+     * traversal should be viewed as a TODO for replacement with an epoch based\n+     * traversal, rather than a preference for std::set over epochs in that\n+     * algorithm.\n+     */\n+    class EpochGuard {\n+        const CTxMemPool& pool;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r371984087",
      "id" : 371984087,
      "in_reply_to_id" : 369914044,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk4NDA4Nw==",
      "original_commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "original_position" : 42,
      "path" : "src/txmempool.h",
      "position" : 42,
      "pull_request_review_id" : 349609213,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925",
      "updated_at" : "2020-01-28T18:37:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/371984087",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r371986990"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/371986990"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It's not required for correctness, but I like that it enforces the invariant that if an epoch guard is not held that all mempool entries are \"younger\" than the mempool's m_epoch.\r\n\r\nBy \"prevents stale results being used\", I meant that if some nefarious caller wanted to manually check epochs outside of the context of an epoch guard, they wouldn't \"gain\" information about the previous traversal. Of course, this is false because they could just check if it->m_epoch == m_epoch-1, but I personally felt it was a nice way to communicate the intent. \r\n\r\nAlso uint64_t is big, so using an extra epochs count per interval isn't going to cause any sort of issue.",
      "commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "created_at" : "2020-01-28T18:43:40Z",
      "diff_hunk" : "@@ -1105,4 +1105,23 @@ void CTxMemPool::SetIsLoaded(bool loaded)\n     m_is_loaded = loaded;\n }\n \n+\n+CTxMemPool::EpochGuard CTxMemPool::GetFreshEpoch() const\n+{\n+    return EpochGuard(*this);\n+}\n+CTxMemPool::EpochGuard::EpochGuard(const CTxMemPool& in) : pool(in)\n+{\n+    assert(!pool.m_has_epoch_guard);\n+    ++pool.m_epoch;\n+    pool.m_has_epoch_guard = true;\n+}\n+\n+CTxMemPool::EpochGuard::~EpochGuard()\n+{\n+    // prevents stale results being used\n+    ++pool.m_epoch;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r371986990",
      "id" : 371986990,
      "in_reply_to_id" : 371523359,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk4Njk5MA==",
      "original_commit_id" : "2ccb7cca4ac67198ac89bd58f5b4ae41a5163ceb",
      "original_position" : 37,
      "path" : "src/txmempool.cpp",
      "position" : 78,
      "pull_request_review_id" : 349612915,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925",
      "updated_at" : "2020-01-28T18:43:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/371986990",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r371990443"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/371990443"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "fair point -- I felt that prefixing it with the class name was a bit gauche compared to just naming it the same thing. It's also an internal detail that isn't going to be referenced or inspected by any callers, so it isn't going to yield much name colliding code.\r\n\r\nI suggest that when @ajtowns refactors a lock analyzer friendly interface he can pick whatever variable names he thinks appropriate (except maybe m_aj_is_number_one).",
      "commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "created_at" : "2020-01-28T18:50:22Z",
      "diff_hunk" : "@@ -129,6 +129,7 @@ class CTxMemPoolEntry\n     int64_t GetSigOpCostWithAncestors() const { return nSigOpCostWithAncestors; }\n \n     mutable size_t vTxHashesIdx; //!< Index in mempool's vTxHashes\n+    mutable uint64_t m_epoch; //!< epoch when last touched, useful for graph algorithms",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r371990443",
      "id" : 371990443,
      "in_reply_to_id" : 371514906,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk5MDQ0Mw==",
      "original_commit_id" : "2ccb7cca4ac67198ac89bd58f5b4ae41a5163ceb",
      "original_position" : 4,
      "path" : "src/txmempool.h",
      "position" : 4,
      "pull_request_review_id" : 349617239,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925",
      "updated_at" : "2020-01-28T18:50:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/371990443",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.",
      "created_at" : "2020-01-28T19:29:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#issuecomment-579414760",
      "id" : 579414760,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17925",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3OTQxNDc2MA==",
      "updated_at" : "2020-01-28T19:29:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/579414760",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r372039818"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372039818"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: might default member initializer be used instead?",
      "commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "created_at" : "2020-01-28T20:31:24Z",
      "diff_hunk" : "@@ -23,7 +23,7 @@ CTxMemPoolEntry::CTxMemPoolEntry(const CTransactionRef& _tx, const CAmount& _nFe\n                                  int64_t _nTime, unsigned int _entryHeight,\n                                  bool _spendsCoinbase, int64_t _sigOpsCost, LockPoints lp)\n     : tx(_tx), nFee(_nFee), nTxWeight(GetTransactionWeight(*tx)), nUsageSize(RecursiveDynamicUsage(tx)), nTime(_nTime), entryHeight(_entryHeight),\n-    spendsCoinbase(_spendsCoinbase), sigOpCost(_sigOpsCost), lockPoints(lp)\n+    spendsCoinbase(_spendsCoinbase), sigOpCost(_sigOpsCost), lockPoints(lp), m_epoch(0)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r372039818",
      "id" : 372039818,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjAzOTgxOA==",
      "original_commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "original_position" : 5,
      "path" : "src/txmempool.cpp",
      "position" : 5,
      "pull_request_review_id" : 349680981,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925",
      "updated_at" : "2020-01-28T20:59:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372039818",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r372040196"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372040196"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: might default member initializers be used instead?",
      "commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "created_at" : "2020-01-28T20:32:21Z",
      "diff_hunk" : "@@ -325,7 +327,7 @@ void CTxMemPoolEntry::UpdateAncestorState(int64_t modifySize, CAmount modifyFee,\n }\n \n CTxMemPool::CTxMemPool(CBlockPolicyEstimator* estimator)\n-    : nTransactionsUpdated(0), minerPolicyEstimator(estimator)\n+    : nTransactionsUpdated(0), minerPolicyEstimator(estimator), m_epoch(0), m_has_epoch_guard(false)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r372040196",
      "id" : 372040196,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA0MDE5Ng==",
      "original_commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "original_position" : 55,
      "path" : "src/txmempool.cpp",
      "position" : 55,
      "pull_request_review_id" : 349680981,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925",
      "updated_at" : "2020-01-28T20:59:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372040196",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r372040887"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372040887"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is this comment still relevant?",
      "commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "created_at" : "2020-01-28T20:34:01Z",
      "diff_hunk" : "@@ -132,17 +130,21 @@ void CTxMemPool::UpdateTransactionsFromBlock(const std::vector<uint256> &vHashes\n         auto iter = mapNextTx.lower_bound(COutPoint(hash, 0));\n         // First calculate the children, and update setMemPoolChildren to\n         // include them, and update their setMemPoolParents to include this tx.\n-        for (; iter != mapNextTx.end() && iter->first->hash == hash; ++iter) {\n-            const uint256 &childHash = iter->second->GetHash();\n-            txiter childIter = mapTx.find(childHash);\n-            assert(childIter != mapTx.end());\n-            // We can skip updating entries we've encountered before or that\n-            // are in the block (which are already accounted for).\n-            if (setChildren.insert(childIter).second && !setAlreadyIncluded.count(childHash)) {\n-                UpdateChild(it, childIter, true);\n-                UpdateParent(childIter, it, true);\n+        // we cache the in-mempool children to avoid duplicate updates",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r372040887",
      "id" : 372040887,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA0MDg4Nw==",
      "original_commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "original_position" : 31,
      "path" : "src/txmempool.cpp",
      "position" : 31,
      "pull_request_review_id" : 349680981,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925",
      "updated_at" : "2020-01-28T20:59:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372040887",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r372045194"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372045194"
         }
      },
      "author_association" : "MEMBER",
      "body" : "typo: incomaptible --> incompatible",
      "commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "created_at" : "2020-01-28T20:43:56Z",
      "diff_hunk" : "@@ -736,6 +739,55 @@ class CTxMemPool\n      *  removal.\n      */\n     void removeUnchecked(txiter entry, MemPoolRemovalReason reason) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+public:\n+    /** EpochGuard: RAII-style guard for using epoch-based graph traversal algorithms.\n+     *     When walking ancestors or descendants, we generally want to avoid\n+     * visiting the same transactions twice. Some traversal algorithms use\n+     * std::set (or setEntries) to deduplicate the transaction we visit.\n+     * However, use of std::set is algorithmically undesirable because it both\n+     * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+     * more dynamic memory allocations.\n+     *     In many algorithms we can replace std::set with an internal mempool\n+     * counter to track the time (or, \"epoch\") that we began a traversal, and\n+     * check + update a per-transaction epoch for each transaction we look at to\n+     * determine if that transaction has not yet been visited during the current\n+     * traversal's epoch.\n+     *     Algorithms using std::set can be replaced on a one by one basis.\n+     * Both techniques are not fundamentally incomaptible across the codebase.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r372045194",
      "id" : 372045194,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA0NTE5NA==",
      "original_commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "original_position" : 35,
      "path" : "src/txmempool.h",
      "position" : 35,
      "pull_request_review_id" : 349680981,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925",
      "updated_at" : "2020-01-28T20:59:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372045194",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r372046051"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372046051"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: since epoch is monotonously increasing, might `GetNextEpoch()` be a more appropriate name?",
      "commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "created_at" : "2020-01-28T20:45:54Z",
      "diff_hunk" : "@@ -736,6 +739,55 @@ class CTxMemPool\n      *  removal.\n      */\n     void removeUnchecked(txiter entry, MemPoolRemovalReason reason) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+public:\n+    /** EpochGuard: RAII-style guard for using epoch-based graph traversal algorithms.\n+     *     When walking ancestors or descendants, we generally want to avoid\n+     * visiting the same transactions twice. Some traversal algorithms use\n+     * std::set (or setEntries) to deduplicate the transaction we visit.\n+     * However, use of std::set is algorithmically undesirable because it both\n+     * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+     * more dynamic memory allocations.\n+     *     In many algorithms we can replace std::set with an internal mempool\n+     * counter to track the time (or, \"epoch\") that we began a traversal, and\n+     * check + update a per-transaction epoch for each transaction we look at to\n+     * determine if that transaction has not yet been visited during the current\n+     * traversal's epoch.\n+     *     Algorithms using std::set can be replaced on a one by one basis.\n+     * Both techniques are not fundamentally incomaptible across the codebase.\n+     * Generally speaking, however, the remaining use of std::set for mempool\n+     * traversal should be viewed as a TODO for replacement with an epoch based\n+     * traversal, rather than a preference for std::set over epochs in that\n+     * algorithm.\n+     */\n+    class EpochGuard {\n+        const CTxMemPool& pool;\n+        public:\n+        EpochGuard(const CTxMemPool& in);\n+        ~EpochGuard();\n+    };\n+    // N.B. GetFreshEpoch modifies mutable state via the EpochGuard construction\n+    // (and later destruction)\n+    EpochGuard GetFreshEpoch() const EXCLUSIVE_LOCKS_REQUIRED(cs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r372046051",
      "id" : 372046051,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA0NjA1MQ==",
      "original_commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "original_position" : 49,
      "path" : "src/txmempool.h",
      "position" : 49,
      "pull_request_review_id" : 349680981,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925",
      "updated_at" : "2020-01-28T20:59:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372046051",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r372047993"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372047993"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Agree with @ajtowns that replacing `std::max()` with conditional statement makes things clearer.\r\n",
      "commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "created_at" : "2020-01-28T20:50:07Z",
      "diff_hunk" : "@@ -736,6 +739,55 @@ class CTxMemPool\n      *  removal.\n      */\n     void removeUnchecked(txiter entry, MemPoolRemovalReason reason) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+public:\n+    /** EpochGuard: RAII-style guard for using epoch-based graph traversal algorithms.\n+     *     When walking ancestors or descendants, we generally want to avoid\n+     * visiting the same transactions twice. Some traversal algorithms use\n+     * std::set (or setEntries) to deduplicate the transaction we visit.\n+     * However, use of std::set is algorithmically undesirable because it both\n+     * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+     * more dynamic memory allocations.\n+     *     In many algorithms we can replace std::set with an internal mempool\n+     * counter to track the time (or, \"epoch\") that we began a traversal, and\n+     * check + update a per-transaction epoch for each transaction we look at to\n+     * determine if that transaction has not yet been visited during the current\n+     * traversal's epoch.\n+     *     Algorithms using std::set can be replaced on a one by one basis.\n+     * Both techniques are not fundamentally incomaptible across the codebase.\n+     * Generally speaking, however, the remaining use of std::set for mempool\n+     * traversal should be viewed as a TODO for replacement with an epoch based\n+     * traversal, rather than a preference for std::set over epochs in that\n+     * algorithm.\n+     */\n+    class EpochGuard {\n+        const CTxMemPool& pool;\n+        public:\n+        EpochGuard(const CTxMemPool& in);\n+        ~EpochGuard();\n+    };\n+    // N.B. GetFreshEpoch modifies mutable state via the EpochGuard construction\n+    // (and later destruction)\n+    EpochGuard GetFreshEpoch() const EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    /** visited marks a CTxMemPoolEntry as having been traversed\n+     * during the lifetime of the most recently created EpochGuard\n+     * and returns false if we are the first visitor, true otherwise.\n+     *\n+     * An EpochGuard must be held when visited is called or an assert will be\n+     * triggered.\n+     *\n+     */\n+    bool visited(txiter it) const EXCLUSIVE_LOCKS_REQUIRED(cs) {\n+        assert(m_has_epoch_guard);\n+        bool ret = it->m_epoch >= m_epoch;\n+        it->m_epoch = std::max(it->m_epoch, m_epoch);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r372047993",
      "id" : 372047993,
      "in_reply_to_id" : 369915441,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA0Nzk5Mw==",
      "original_commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "original_position" : 62,
      "path" : "src/txmempool.h",
      "position" : 62,
      "pull_request_review_id" : 349680981,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925",
      "updated_at" : "2020-01-28T20:59:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372047993",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r372049211"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372049211"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: mind adding a comment about \"recursive locking\" you mention in https://github.com/bitcoin/bitcoin/pull/17925/files#r370419851?",
      "commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "created_at" : "2020-01-28T20:52:34Z",
      "diff_hunk" : "@@ -736,6 +739,55 @@ class CTxMemPool\n      *  removal.\n      */\n     void removeUnchecked(txiter entry, MemPoolRemovalReason reason) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+public:\n+    /** EpochGuard: RAII-style guard for using epoch-based graph traversal algorithms.\n+     *     When walking ancestors or descendants, we generally want to avoid\n+     * visiting the same transactions twice. Some traversal algorithms use\n+     * std::set (or setEntries) to deduplicate the transaction we visit.\n+     * However, use of std::set is algorithmically undesirable because it both\n+     * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+     * more dynamic memory allocations.\n+     *     In many algorithms we can replace std::set with an internal mempool\n+     * counter to track the time (or, \"epoch\") that we began a traversal, and\n+     * check + update a per-transaction epoch for each transaction we look at to\n+     * determine if that transaction has not yet been visited during the current\n+     * traversal's epoch.\n+     *     Algorithms using std::set can be replaced on a one by one basis.\n+     * Both techniques are not fundamentally incomaptible across the codebase.\n+     * Generally speaking, however, the remaining use of std::set for mempool\n+     * traversal should be viewed as a TODO for replacement with an epoch based\n+     * traversal, rather than a preference for std::set over epochs in that\n+     * algorithm.\n+     */\n+    class EpochGuard {\n+        const CTxMemPool& pool;\n+        public:\n+        EpochGuard(const CTxMemPool& in);\n+        ~EpochGuard();\n+    };\n+    // N.B. GetFreshEpoch modifies mutable state via the EpochGuard construction\n+    // (and later destruction)\n+    EpochGuard GetFreshEpoch() const EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    /** visited marks a CTxMemPoolEntry as having been traversed\n+     * during the lifetime of the most recently created EpochGuard\n+     * and returns false if we are the first visitor, true otherwise.\n+     *\n+     * An EpochGuard must be held when visited is called or an assert will be\n+     * triggered.\n+     *\n+     */\n+    bool visited(txiter it) const EXCLUSIVE_LOCKS_REQUIRED(cs) {\n+        assert(m_has_epoch_guard);\n+        bool ret = it->m_epoch >= m_epoch;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r372049211",
      "id" : 372049211,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA0OTIxMQ==",
      "original_commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "original_position" : 61,
      "path" : "src/txmempool.h",
      "position" : 61,
      "pull_request_review_id" : 349680981,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925",
      "updated_at" : "2020-01-28T20:59:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372049211",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r372051752"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372051752"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If `Optional<txiter> it` has no value, returned value `visited() == true` seems semantically a bit weird. Could function naming be improved?",
      "commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "created_at" : "2020-01-28T20:58:15Z",
      "diff_hunk" : "@@ -736,6 +739,55 @@ class CTxMemPool\n      *  removal.\n      */\n     void removeUnchecked(txiter entry, MemPoolRemovalReason reason) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+public:\n+    /** EpochGuard: RAII-style guard for using epoch-based graph traversal algorithms.\n+     *     When walking ancestors or descendants, we generally want to avoid\n+     * visiting the same transactions twice. Some traversal algorithms use\n+     * std::set (or setEntries) to deduplicate the transaction we visit.\n+     * However, use of std::set is algorithmically undesirable because it both\n+     * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+     * more dynamic memory allocations.\n+     *     In many algorithms we can replace std::set with an internal mempool\n+     * counter to track the time (or, \"epoch\") that we began a traversal, and\n+     * check + update a per-transaction epoch for each transaction we look at to\n+     * determine if that transaction has not yet been visited during the current\n+     * traversal's epoch.\n+     *     Algorithms using std::set can be replaced on a one by one basis.\n+     * Both techniques are not fundamentally incomaptible across the codebase.\n+     * Generally speaking, however, the remaining use of std::set for mempool\n+     * traversal should be viewed as a TODO for replacement with an epoch based\n+     * traversal, rather than a preference for std::set over epochs in that\n+     * algorithm.\n+     */\n+    class EpochGuard {\n+        const CTxMemPool& pool;\n+        public:\n+        EpochGuard(const CTxMemPool& in);\n+        ~EpochGuard();\n+    };\n+    // N.B. GetFreshEpoch modifies mutable state via the EpochGuard construction\n+    // (and later destruction)\n+    EpochGuard GetFreshEpoch() const EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    /** visited marks a CTxMemPoolEntry as having been traversed\n+     * during the lifetime of the most recently created EpochGuard\n+     * and returns false if we are the first visitor, true otherwise.\n+     *\n+     * An EpochGuard must be held when visited is called or an assert will be\n+     * triggered.\n+     *\n+     */\n+    bool visited(txiter it) const EXCLUSIVE_LOCKS_REQUIRED(cs) {\n+        assert(m_has_epoch_guard);\n+        bool ret = it->m_epoch >= m_epoch;\n+        it->m_epoch = std::max(it->m_epoch, m_epoch);\n+        return ret;\n+    }\n+\n+    bool visited(Optional<txiter> it) const EXCLUSIVE_LOCKS_REQUIRED(cs) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r372051752",
      "id" : 372051752,
      "in_reply_to_id" : 369914759,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA1MTc1Mg==",
      "original_commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "original_position" : 66,
      "path" : "src/txmempool.h",
      "position" : 66,
      "pull_request_review_id" : 349680981,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925",
      "updated_at" : "2020-01-28T20:59:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372051752",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r372055970"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372055970"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think it's best to be style consistent with the other fields which are also set by the initializer list.",
      "commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "created_at" : "2020-01-28T21:07:13Z",
      "diff_hunk" : "@@ -23,7 +23,7 @@ CTxMemPoolEntry::CTxMemPoolEntry(const CTransactionRef& _tx, const CAmount& _nFe\n                                  int64_t _nTime, unsigned int _entryHeight,\n                                  bool _spendsCoinbase, int64_t _sigOpsCost, LockPoints lp)\n     : tx(_tx), nFee(_nFee), nTxWeight(GetTransactionWeight(*tx)), nUsageSize(RecursiveDynamicUsage(tx)), nTime(_nTime), entryHeight(_entryHeight),\n-    spendsCoinbase(_spendsCoinbase), sigOpCost(_sigOpsCost), lockPoints(lp)\n+    spendsCoinbase(_spendsCoinbase), sigOpCost(_sigOpsCost), lockPoints(lp), m_epoch(0)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r372055970",
      "id" : 372055970,
      "in_reply_to_id" : 372039818,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA1NTk3MA==",
      "original_commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "original_position" : 5,
      "path" : "src/txmempool.cpp",
      "position" : 5,
      "pull_request_review_id" : 349702280,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925",
      "updated_at" : "2020-01-28T21:07:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372055970",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r372056084"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372056084"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think it's best to be style consistent with the other fields which are also set by the initializer list.",
      "commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "created_at" : "2020-01-28T21:07:27Z",
      "diff_hunk" : "@@ -325,7 +327,7 @@ void CTxMemPoolEntry::UpdateAncestorState(int64_t modifySize, CAmount modifyFee,\n }\n \n CTxMemPool::CTxMemPool(CBlockPolicyEstimator* estimator)\n-    : nTransactionsUpdated(0), minerPolicyEstimator(estimator)\n+    : nTransactionsUpdated(0), minerPolicyEstimator(estimator), m_epoch(0), m_has_epoch_guard(false)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r372056084",
      "id" : 372056084,
      "in_reply_to_id" : 372040196,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA1NjA4NA==",
      "original_commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "original_position" : 55,
      "path" : "src/txmempool.cpp",
      "position" : 55,
      "pull_request_review_id" : 349702422,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925",
      "updated_at" : "2020-01-28T21:07:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372056084",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r372062930"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372062930"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hmm. The comment is still relevant insofar as it explains what the EpochGuard is doing, but specifically the word \"cache\" is perhaps a bit vague.",
      "commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "created_at" : "2020-01-28T21:18:20Z",
      "diff_hunk" : "@@ -132,17 +130,21 @@ void CTxMemPool::UpdateTransactionsFromBlock(const std::vector<uint256> &vHashes\n         auto iter = mapNextTx.lower_bound(COutPoint(hash, 0));\n         // First calculate the children, and update setMemPoolChildren to\n         // include them, and update their setMemPoolParents to include this tx.\n-        for (; iter != mapNextTx.end() && iter->first->hash == hash; ++iter) {\n-            const uint256 &childHash = iter->second->GetHash();\n-            txiter childIter = mapTx.find(childHash);\n-            assert(childIter != mapTx.end());\n-            // We can skip updating entries we've encountered before or that\n-            // are in the block (which are already accounted for).\n-            if (setChildren.insert(childIter).second && !setAlreadyIncluded.count(childHash)) {\n-                UpdateChild(it, childIter, true);\n-                UpdateParent(childIter, it, true);\n+        // we cache the in-mempool children to avoid duplicate updates",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r372062930",
      "id" : 372062930,
      "in_reply_to_id" : 372040887,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA2MjkzMA==",
      "original_commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "original_position" : 31,
      "path" : "src/txmempool.cpp",
      "position" : 31,
      "pull_request_review_id" : 349710097,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925",
      "updated_at" : "2020-01-28T21:18:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372062930",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r372063109"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372063109"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "good catch",
      "commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "created_at" : "2020-01-28T21:18:44Z",
      "diff_hunk" : "@@ -736,6 +739,55 @@ class CTxMemPool\n      *  removal.\n      */\n     void removeUnchecked(txiter entry, MemPoolRemovalReason reason) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+public:\n+    /** EpochGuard: RAII-style guard for using epoch-based graph traversal algorithms.\n+     *     When walking ancestors or descendants, we generally want to avoid\n+     * visiting the same transactions twice. Some traversal algorithms use\n+     * std::set (or setEntries) to deduplicate the transaction we visit.\n+     * However, use of std::set is algorithmically undesirable because it both\n+     * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+     * more dynamic memory allocations.\n+     *     In many algorithms we can replace std::set with an internal mempool\n+     * counter to track the time (or, \"epoch\") that we began a traversal, and\n+     * check + update a per-transaction epoch for each transaction we look at to\n+     * determine if that transaction has not yet been visited during the current\n+     * traversal's epoch.\n+     *     Algorithms using std::set can be replaced on a one by one basis.\n+     * Both techniques are not fundamentally incomaptible across the codebase.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r372063109",
      "id" : 372063109,
      "in_reply_to_id" : 372045194,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA2MzEwOQ==",
      "original_commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "original_position" : 35,
      "path" : "src/txmempool.h",
      "position" : 35,
      "pull_request_review_id" : 349710321,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925",
      "updated_at" : "2020-01-28T21:18:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372063109",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r372065702"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372065702"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think Fresh better encapsulates that it's an epoch that is unused by any element. Fresh, New, Unused are better to me than Next. All else equal, Fresh is already written.\r\n\r\nI don't care about the names that much though, other than it causes negligible more rebase work for me -- @ajtowns will refactor some of this in a follow up with a new interface, I think if we want to bikeshed names more we can update it then.",
      "commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "created_at" : "2020-01-28T21:24:20Z",
      "diff_hunk" : "@@ -736,6 +739,55 @@ class CTxMemPool\n      *  removal.\n      */\n     void removeUnchecked(txiter entry, MemPoolRemovalReason reason) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+public:\n+    /** EpochGuard: RAII-style guard for using epoch-based graph traversal algorithms.\n+     *     When walking ancestors or descendants, we generally want to avoid\n+     * visiting the same transactions twice. Some traversal algorithms use\n+     * std::set (or setEntries) to deduplicate the transaction we visit.\n+     * However, use of std::set is algorithmically undesirable because it both\n+     * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+     * more dynamic memory allocations.\n+     *     In many algorithms we can replace std::set with an internal mempool\n+     * counter to track the time (or, \"epoch\") that we began a traversal, and\n+     * check + update a per-transaction epoch for each transaction we look at to\n+     * determine if that transaction has not yet been visited during the current\n+     * traversal's epoch.\n+     *     Algorithms using std::set can be replaced on a one by one basis.\n+     * Both techniques are not fundamentally incomaptible across the codebase.\n+     * Generally speaking, however, the remaining use of std::set for mempool\n+     * traversal should be viewed as a TODO for replacement with an epoch based\n+     * traversal, rather than a preference for std::set over epochs in that\n+     * algorithm.\n+     */\n+    class EpochGuard {\n+        const CTxMemPool& pool;\n+        public:\n+        EpochGuard(const CTxMemPool& in);\n+        ~EpochGuard();\n+    };\n+    // N.B. GetFreshEpoch modifies mutable state via the EpochGuard construction\n+    // (and later destruction)\n+    EpochGuard GetFreshEpoch() const EXCLUSIVE_LOCKS_REQUIRED(cs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r372065702",
      "id" : 372065702,
      "in_reply_to_id" : 372046051,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA2NTcwMg==",
      "original_commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "original_position" : 49,
      "path" : "src/txmempool.h",
      "position" : 49,
      "pull_request_review_id" : 349713729,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925",
      "updated_at" : "2020-01-28T21:24:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372065702",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r372068689"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372068689"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It's not that weird of a decision once you look at the code that depends on it.\r\n\r\nEssentially, if I code something like:\r\n```c++\r\nfor (auto& it : mapTx) {\r\n    auto it2 = FindIterByPrevout(it->GetTransaction()->vin[0].prevout);\r\n    if (visited(it2)) continue;\r\n}\r\n```\r\n\r\nthis is kind of semantic, because if the FindByPrevout returns nullopt then we want to skip it because we've (in theory) already traversed everything we could want to traverse.\r\n\r\n\r\n@sdaftuar and I spent like at least an hour trying to come up with a better semantic name than the predecessor to visited, and decided that visited was sufficiently semantic. But if you have a better suggestion, would be happy to consider it, we just couldn't come up with something that wasn't either awkward sounding or less semantic in other cases.",
      "commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "created_at" : "2020-01-28T21:30:37Z",
      "diff_hunk" : "@@ -736,6 +739,55 @@ class CTxMemPool\n      *  removal.\n      */\n     void removeUnchecked(txiter entry, MemPoolRemovalReason reason) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+public:\n+    /** EpochGuard: RAII-style guard for using epoch-based graph traversal algorithms.\n+     *     When walking ancestors or descendants, we generally want to avoid\n+     * visiting the same transactions twice. Some traversal algorithms use\n+     * std::set (or setEntries) to deduplicate the transaction we visit.\n+     * However, use of std::set is algorithmically undesirable because it both\n+     * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+     * more dynamic memory allocations.\n+     *     In many algorithms we can replace std::set with an internal mempool\n+     * counter to track the time (or, \"epoch\") that we began a traversal, and\n+     * check + update a per-transaction epoch for each transaction we look at to\n+     * determine if that transaction has not yet been visited during the current\n+     * traversal's epoch.\n+     *     Algorithms using std::set can be replaced on a one by one basis.\n+     * Both techniques are not fundamentally incomaptible across the codebase.\n+     * Generally speaking, however, the remaining use of std::set for mempool\n+     * traversal should be viewed as a TODO for replacement with an epoch based\n+     * traversal, rather than a preference for std::set over epochs in that\n+     * algorithm.\n+     */\n+    class EpochGuard {\n+        const CTxMemPool& pool;\n+        public:\n+        EpochGuard(const CTxMemPool& in);\n+        ~EpochGuard();\n+    };\n+    // N.B. GetFreshEpoch modifies mutable state via the EpochGuard construction\n+    // (and later destruction)\n+    EpochGuard GetFreshEpoch() const EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    /** visited marks a CTxMemPoolEntry as having been traversed\n+     * during the lifetime of the most recently created EpochGuard\n+     * and returns false if we are the first visitor, true otherwise.\n+     *\n+     * An EpochGuard must be held when visited is called or an assert will be\n+     * triggered.\n+     *\n+     */\n+    bool visited(txiter it) const EXCLUSIVE_LOCKS_REQUIRED(cs) {\n+        assert(m_has_epoch_guard);\n+        bool ret = it->m_epoch >= m_epoch;\n+        it->m_epoch = std::max(it->m_epoch, m_epoch);\n+        return ret;\n+    }\n+\n+    bool visited(Optional<txiter> it) const EXCLUSIVE_LOCKS_REQUIRED(cs) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r372068689",
      "id" : 372068689,
      "in_reply_to_id" : 369914759,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA2ODY4OQ==",
      "original_commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "original_position" : 66,
      "path" : "src/txmempool.h",
      "position" : 66,
      "pull_request_review_id" : 349717559,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925",
      "updated_at" : "2020-01-28T21:30:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372068689",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r372070708"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372070708"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "if i were to update it, I would prefer:\r\n\r\n```c++\r\nif (!ret) it->m_epoch = m_epoch\r\n```\r\nto preserve the aforementioned invariant of monotonicity. This is equivalent to std::max, so I don't have any preference on the style, with a slight preference to what's already there and reviewed. ",
      "commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "created_at" : "2020-01-28T21:34:55Z",
      "diff_hunk" : "@@ -736,6 +739,55 @@ class CTxMemPool\n      *  removal.\n      */\n     void removeUnchecked(txiter entry, MemPoolRemovalReason reason) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+public:\n+    /** EpochGuard: RAII-style guard for using epoch-based graph traversal algorithms.\n+     *     When walking ancestors or descendants, we generally want to avoid\n+     * visiting the same transactions twice. Some traversal algorithms use\n+     * std::set (or setEntries) to deduplicate the transaction we visit.\n+     * However, use of std::set is algorithmically undesirable because it both\n+     * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+     * more dynamic memory allocations.\n+     *     In many algorithms we can replace std::set with an internal mempool\n+     * counter to track the time (or, \"epoch\") that we began a traversal, and\n+     * check + update a per-transaction epoch for each transaction we look at to\n+     * determine if that transaction has not yet been visited during the current\n+     * traversal's epoch.\n+     *     Algorithms using std::set can be replaced on a one by one basis.\n+     * Both techniques are not fundamentally incomaptible across the codebase.\n+     * Generally speaking, however, the remaining use of std::set for mempool\n+     * traversal should be viewed as a TODO for replacement with an epoch based\n+     * traversal, rather than a preference for std::set over epochs in that\n+     * algorithm.\n+     */\n+    class EpochGuard {\n+        const CTxMemPool& pool;\n+        public:\n+        EpochGuard(const CTxMemPool& in);\n+        ~EpochGuard();\n+    };\n+    // N.B. GetFreshEpoch modifies mutable state via the EpochGuard construction\n+    // (and later destruction)\n+    EpochGuard GetFreshEpoch() const EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    /** visited marks a CTxMemPoolEntry as having been traversed\n+     * during the lifetime of the most recently created EpochGuard\n+     * and returns false if we are the first visitor, true otherwise.\n+     *\n+     * An EpochGuard must be held when visited is called or an assert will be\n+     * triggered.\n+     *\n+     */\n+    bool visited(txiter it) const EXCLUSIVE_LOCKS_REQUIRED(cs) {\n+        assert(m_has_epoch_guard);\n+        bool ret = it->m_epoch >= m_epoch;\n+        it->m_epoch = std::max(it->m_epoch, m_epoch);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r372070708",
      "id" : 372070708,
      "in_reply_to_id" : 369915441,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA3MDcwOA==",
      "original_commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "original_position" : 62,
      "path" : "src/txmempool.h",
      "position" : 62,
      "pull_request_review_id" : 349720096,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925",
      "updated_at" : "2020-01-28T21:34:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372070708",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r372071837"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372071837"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Wouldn't mind, but don't want to confuse anyone with a currently unsupported use case.\r\n\r\n",
      "commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "created_at" : "2020-01-28T21:37:17Z",
      "diff_hunk" : "@@ -736,6 +739,55 @@ class CTxMemPool\n      *  removal.\n      */\n     void removeUnchecked(txiter entry, MemPoolRemovalReason reason) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+public:\n+    /** EpochGuard: RAII-style guard for using epoch-based graph traversal algorithms.\n+     *     When walking ancestors or descendants, we generally want to avoid\n+     * visiting the same transactions twice. Some traversal algorithms use\n+     * std::set (or setEntries) to deduplicate the transaction we visit.\n+     * However, use of std::set is algorithmically undesirable because it both\n+     * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+     * more dynamic memory allocations.\n+     *     In many algorithms we can replace std::set with an internal mempool\n+     * counter to track the time (or, \"epoch\") that we began a traversal, and\n+     * check + update a per-transaction epoch for each transaction we look at to\n+     * determine if that transaction has not yet been visited during the current\n+     * traversal's epoch.\n+     *     Algorithms using std::set can be replaced on a one by one basis.\n+     * Both techniques are not fundamentally incomaptible across the codebase.\n+     * Generally speaking, however, the remaining use of std::set for mempool\n+     * traversal should be viewed as a TODO for replacement with an epoch based\n+     * traversal, rather than a preference for std::set over epochs in that\n+     * algorithm.\n+     */\n+    class EpochGuard {\n+        const CTxMemPool& pool;\n+        public:\n+        EpochGuard(const CTxMemPool& in);\n+        ~EpochGuard();\n+    };\n+    // N.B. GetFreshEpoch modifies mutable state via the EpochGuard construction\n+    // (and later destruction)\n+    EpochGuard GetFreshEpoch() const EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    /** visited marks a CTxMemPoolEntry as having been traversed\n+     * during the lifetime of the most recently created EpochGuard\n+     * and returns false if we are the first visitor, true otherwise.\n+     *\n+     * An EpochGuard must be held when visited is called or an assert will be\n+     * triggered.\n+     *\n+     */\n+    bool visited(txiter it) const EXCLUSIVE_LOCKS_REQUIRED(cs) {\n+        assert(m_has_epoch_guard);\n+        bool ret = it->m_epoch >= m_epoch;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r372071837",
      "id" : 372071837,
      "in_reply_to_id" : 372049211,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA3MTgzNw==",
      "original_commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "original_position" : 61,
      "path" : "src/txmempool.h",
      "position" : 61,
      "pull_request_review_id" : 349721508,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925",
      "updated_at" : "2020-01-28T21:37:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372071837",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r372170803"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372170803"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`needs_processing(it2)` or similar could work, but `visited` seems pretty fine to me. (I would prefer it if it more clearly indicated that it's not idempotent/const; ie `bool a = visited(it); bool b = visited(it);` could result in `!a && b`, so maybe `first_visit()` or similar would be better? But still, it's already fine)",
      "commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "created_at" : "2020-01-29T03:14:25Z",
      "diff_hunk" : "@@ -736,6 +739,55 @@ class CTxMemPool\n      *  removal.\n      */\n     void removeUnchecked(txiter entry, MemPoolRemovalReason reason) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+public:\n+    /** EpochGuard: RAII-style guard for using epoch-based graph traversal algorithms.\n+     *     When walking ancestors or descendants, we generally want to avoid\n+     * visiting the same transactions twice. Some traversal algorithms use\n+     * std::set (or setEntries) to deduplicate the transaction we visit.\n+     * However, use of std::set is algorithmically undesirable because it both\n+     * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+     * more dynamic memory allocations.\n+     *     In many algorithms we can replace std::set with an internal mempool\n+     * counter to track the time (or, \"epoch\") that we began a traversal, and\n+     * check + update a per-transaction epoch for each transaction we look at to\n+     * determine if that transaction has not yet been visited during the current\n+     * traversal's epoch.\n+     *     Algorithms using std::set can be replaced on a one by one basis.\n+     * Both techniques are not fundamentally incomaptible across the codebase.\n+     * Generally speaking, however, the remaining use of std::set for mempool\n+     * traversal should be viewed as a TODO for replacement with an epoch based\n+     * traversal, rather than a preference for std::set over epochs in that\n+     * algorithm.\n+     */\n+    class EpochGuard {\n+        const CTxMemPool& pool;\n+        public:\n+        EpochGuard(const CTxMemPool& in);\n+        ~EpochGuard();\n+    };\n+    // N.B. GetFreshEpoch modifies mutable state via the EpochGuard construction\n+    // (and later destruction)\n+    EpochGuard GetFreshEpoch() const EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    /** visited marks a CTxMemPoolEntry as having been traversed\n+     * during the lifetime of the most recently created EpochGuard\n+     * and returns false if we are the first visitor, true otherwise.\n+     *\n+     * An EpochGuard must be held when visited is called or an assert will be\n+     * triggered.\n+     *\n+     */\n+    bool visited(txiter it) const EXCLUSIVE_LOCKS_REQUIRED(cs) {\n+        assert(m_has_epoch_guard);\n+        bool ret = it->m_epoch >= m_epoch;\n+        it->m_epoch = std::max(it->m_epoch, m_epoch);\n+        return ret;\n+    }\n+\n+    bool visited(Optional<txiter> it) const EXCLUSIVE_LOCKS_REQUIRED(cs) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r372170803",
      "id" : 372170803,
      "in_reply_to_id" : 369914759,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE3MDgwMw==",
      "original_commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "original_position" : 66,
      "path" : "src/txmempool.h",
      "position" : 66,
      "pull_request_review_id" : 349840697,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925",
      "updated_at" : "2020-01-29T03:14:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372170803",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r372178583"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372178583"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Things like needs_processing aren't great because there can be some sort of implication that it2 needs processing after it's been marked, and doesn't convey the action. What it is a bit better for is conveying the optionality aspect (something that's an nullopt doesn't need processing).\r\n\r\nThe reason we liked visited as a name is that there is a hint that it's not idempotent, that visited suggests both a query (was it2 visited already?) and a statement (it2 has been visited now).\r\n\r\nUltimately a names just a name, and I don't think visited is horribly unclear. If visited isn't sufficient of a name, I'd opt for removing the optional version of this function (as previously noted it's unused) and just inlining the optional handling where it's used (although it wouldn't quite be the same because of the guard assertion checks).\r\n\r\n(One of the other reasons for introducing this PR now rather than later by the way is that there are two or more separate places in the code presently that use Optional txiters, introducing this in a common PR means that those changes can proceed independently of one another.)",
      "commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "created_at" : "2020-01-29T03:59:09Z",
      "diff_hunk" : "@@ -736,6 +739,55 @@ class CTxMemPool\n      *  removal.\n      */\n     void removeUnchecked(txiter entry, MemPoolRemovalReason reason) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+public:\n+    /** EpochGuard: RAII-style guard for using epoch-based graph traversal algorithms.\n+     *     When walking ancestors or descendants, we generally want to avoid\n+     * visiting the same transactions twice. Some traversal algorithms use\n+     * std::set (or setEntries) to deduplicate the transaction we visit.\n+     * However, use of std::set is algorithmically undesirable because it both\n+     * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+     * more dynamic memory allocations.\n+     *     In many algorithms we can replace std::set with an internal mempool\n+     * counter to track the time (or, \"epoch\") that we began a traversal, and\n+     * check + update a per-transaction epoch for each transaction we look at to\n+     * determine if that transaction has not yet been visited during the current\n+     * traversal's epoch.\n+     *     Algorithms using std::set can be replaced on a one by one basis.\n+     * Both techniques are not fundamentally incomaptible across the codebase.\n+     * Generally speaking, however, the remaining use of std::set for mempool\n+     * traversal should be viewed as a TODO for replacement with an epoch based\n+     * traversal, rather than a preference for std::set over epochs in that\n+     * algorithm.\n+     */\n+    class EpochGuard {\n+        const CTxMemPool& pool;\n+        public:\n+        EpochGuard(const CTxMemPool& in);\n+        ~EpochGuard();\n+    };\n+    // N.B. GetFreshEpoch modifies mutable state via the EpochGuard construction\n+    // (and later destruction)\n+    EpochGuard GetFreshEpoch() const EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    /** visited marks a CTxMemPoolEntry as having been traversed\n+     * during the lifetime of the most recently created EpochGuard\n+     * and returns false if we are the first visitor, true otherwise.\n+     *\n+     * An EpochGuard must be held when visited is called or an assert will be\n+     * triggered.\n+     *\n+     */\n+    bool visited(txiter it) const EXCLUSIVE_LOCKS_REQUIRED(cs) {\n+        assert(m_has_epoch_guard);\n+        bool ret = it->m_epoch >= m_epoch;\n+        it->m_epoch = std::max(it->m_epoch, m_epoch);\n+        return ret;\n+    }\n+\n+    bool visited(Optional<txiter> it) const EXCLUSIVE_LOCKS_REQUIRED(cs) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r372178583",
      "id" : 372178583,
      "in_reply_to_id" : 369914759,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE3ODU4Mw==",
      "original_commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "original_position" : 66,
      "path" : "src/txmempool.h",
      "position" : 66,
      "pull_request_review_id" : 349849398,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925",
      "updated_at" : "2020-01-29T03:59:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372178583",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r372186131"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372186131"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Depends how you traversed mapTx -- if you picked `elt=B` first, then \"C\" would not be a parent or child of \"B\" so you'd only do {A,B,D} in the first subepoch. You'd need to be ordered by feerate or something weird for this to happen, though. But yeah, I can't think of something where sub-epochs is actually useful either. But whatever, `>=` vs `==` doesn't make much difference.",
      "commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "created_at" : "2020-01-29T04:41:56Z",
      "diff_hunk" : "@@ -736,6 +739,55 @@ class CTxMemPool\n      *  removal.\n      */\n     void removeUnchecked(txiter entry, MemPoolRemovalReason reason) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+public:\n+    /** EpochGuard: RAII-style guard for using epoch-based graph traversal algorithms.\n+     *     When walking ancestors or descendants, we generally want to avoid\n+     * visiting the same transactions twice. Some traversal algorithms use\n+     * std::set (or setEntries) to deduplicate the transaction we visit.\n+     * However, use of std::set is algorithmically undesirable because it both\n+     * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+     * more dynamic memory allocations.\n+     *     In many algorithms we can replace std::set with an internal mempool\n+     * counter to track the time (or, \"epoch\") that we began a traversal, and\n+     * check + update a per-transaction epoch for each transaction we look at to\n+     * determine if that transaction has not yet been visited during the current\n+     * traversal's epoch.\n+     *     Algorithms using std::set can be replaced on a one by one basis.\n+     * Both techniques are not fundamentally incomaptible across the codebase.\n+     * Generally speaking, however, the remaining use of std::set for mempool\n+     * traversal should be viewed as a TODO for replacement with an epoch based\n+     * traversal, rather than a preference for std::set over epochs in that\n+     * algorithm.\n+     */\n+    class EpochGuard {\n+        const CTxMemPool& pool;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r372186131",
      "id" : 372186131,
      "in_reply_to_id" : 369914044,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE4NjEzMQ==",
      "original_commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "original_position" : 42,
      "path" : "src/txmempool.h",
      "position" : 42,
      "pull_request_review_id" : 349858200,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925",
      "updated_at" : "2020-01-29T04:41:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372186131",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r372186915"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372186915"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "follow-on PR is #18017 ",
      "commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "created_at" : "2020-01-29T04:46:47Z",
      "diff_hunk" : "@@ -736,6 +739,55 @@ class CTxMemPool\n      *  removal.\n      */\n     void removeUnchecked(txiter entry, MemPoolRemovalReason reason) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+public:\n+    /** EpochGuard: RAII-style guard for using epoch-based graph traversal algorithms.\n+     *     When walking ancestors or descendants, we generally want to avoid\n+     * visiting the same transactions twice. Some traversal algorithms use\n+     * std::set (or setEntries) to deduplicate the transaction we visit.\n+     * However, use of std::set is algorithmically undesirable because it both\n+     * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+     * more dynamic memory allocations.\n+     *     In many algorithms we can replace std::set with an internal mempool\n+     * counter to track the time (or, \"epoch\") that we began a traversal, and\n+     * check + update a per-transaction epoch for each transaction we look at to\n+     * determine if that transaction has not yet been visited during the current\n+     * traversal's epoch.\n+     *     Algorithms using std::set can be replaced on a one by one basis.\n+     * Both techniques are not fundamentally incomaptible across the codebase.\n+     * Generally speaking, however, the remaining use of std::set for mempool\n+     * traversal should be viewed as a TODO for replacement with an epoch based\n+     * traversal, rather than a preference for std::set over epochs in that\n+     * algorithm.\n+     */\n+    class EpochGuard {\n+        const CTxMemPool& pool;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r372186915",
      "id" : 372186915,
      "in_reply_to_id" : 369914044,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE4NjkxNQ==",
      "original_commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "original_position" : 42,
      "path" : "src/txmempool.h",
      "position" : 42,
      "pull_request_review_id" : 349859192,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925",
      "updated_at" : "2020-01-29T04:46:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372186915",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r372188833"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372188833"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ah I think here's the miscommunication of what the algorithm \"GetComponents\" does. It's something like:\r\n\r\n```c++\r\nvector<vector<txiter>> components;\r\nfor (auto elt: mapTx) {\r\n   vector<txiter> to_process;\r\n   vector<txiter> processed;\r\n   if (visited(elt)) continue;\r\n   to_process.push_back(elt);\r\n   while (to_process.size()) {\r\n    auto todo = to_process.back();\r\n    to_process.pop_back();\r\n    processed.push_back(todo);\r\n   for(auto y : GetMemPoolChildren(todo)) {\r\n        if (visited(y)) continue;\r\n        to_process.push_back(y);\r\n   }\r\n   for(auto x : GetMemPoolParents(todo)) {\r\n       if (visited(x)) continue;\r\n        to_process.push_back(x);\r\n    }\r\n\r\n}\r\n    component.push_back(processed);\r\n}\r\n```\r\n\r\nThis lets you find all connected components I think, and passes the test of B-first. A is a parent of B, so then A goes into the to_process stack, then C is a child of A, so C goes onto the to_process stack.\r\n\r\nWithout epochs this would be much messier, but with epochs we can see that things only go onto the stack one time ever because of the visited guards.",
      "commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "created_at" : "2020-01-29T04:57:44Z",
      "diff_hunk" : "@@ -736,6 +739,55 @@ class CTxMemPool\n      *  removal.\n      */\n     void removeUnchecked(txiter entry, MemPoolRemovalReason reason) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+public:\n+    /** EpochGuard: RAII-style guard for using epoch-based graph traversal algorithms.\n+     *     When walking ancestors or descendants, we generally want to avoid\n+     * visiting the same transactions twice. Some traversal algorithms use\n+     * std::set (or setEntries) to deduplicate the transaction we visit.\n+     * However, use of std::set is algorithmically undesirable because it both\n+     * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+     * more dynamic memory allocations.\n+     *     In many algorithms we can replace std::set with an internal mempool\n+     * counter to track the time (or, \"epoch\") that we began a traversal, and\n+     * check + update a per-transaction epoch for each transaction we look at to\n+     * determine if that transaction has not yet been visited during the current\n+     * traversal's epoch.\n+     *     Algorithms using std::set can be replaced on a one by one basis.\n+     * Both techniques are not fundamentally incomaptible across the codebase.\n+     * Generally speaking, however, the remaining use of std::set for mempool\n+     * traversal should be viewed as a TODO for replacement with an epoch based\n+     * traversal, rather than a preference for std::set over epochs in that\n+     * algorithm.\n+     */\n+    class EpochGuard {\n+        const CTxMemPool& pool;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r372188833",
      "id" : 372188833,
      "in_reply_to_id" : 369914044,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE4ODgzMw==",
      "original_commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "original_position" : 42,
      "path" : "src/txmempool.h",
      "position" : 42,
      "pull_request_review_id" : 349861488,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925",
      "updated_at" : "2020-01-29T04:57:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372188833",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@JeremyRubin \r\n> @sdaftuar and I spent like at least an hour trying to come up with a better semantic name than the predecessor to visited, and decided that visited was sufficiently semantic.\r\n\r\nGood to know it. Let @ajtowns and me join your discussion ;)\r\n\r\n> I don't care about the names that much though, other than it causes negligible more rebase work for me -- @ajtowns will refactor some of this in a follow up with a new interface, I think if we want to bikeshed names more we can update it then.\r\n\r\nGood names cause less cognitive work for other contributors, no?\r\n\r\n@ajtowns \r\n> `needs_processing(it2)` or similar could work, but `visited` seems pretty fine to me. (I would prefer it if it more clearly indicated that it's not idempotent/const; ie `bool a = visited(it); bool b = visited(it);` could result in `!a && b`, so maybe `first_visit()` or similar would be better? But still, it's already fine)\r\n\r\nMay I suggest `first_seen()` (or `FirstSeen()` to be in line with [our naming convention)](url) with `first_seen() == !visited()` ?\r\n",
      "created_at" : "2020-01-29T08:14:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#issuecomment-579643248",
      "id" : 579643248,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17925",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3OTY0MzI0OA==",
      "updated_at" : "2020-01-29T08:14:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/579643248",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Apologies, that was an offline discussion!\r\n\r\nfirst_seen or FirstSeen is no good for this use case. If you negate visited then you impose that callers of visited has to check the negation of the call or to nest the code a level deeper inside an if, which adds more cognitive overhead IMO. Most of the code that I've written uses an `if (visited(it)) continue;` guard to check the next element, this code becomes less readable with `if (!first_seen(x)) continue;` or if (first_seen(it)) { x }`\r\n\r\n\r\nI recommend reading this issue on style nits and whatnot: https://github.com/bitcoin/bitcoin/issues/15465; I don't think it's unreasonable to try to figure out better tweaks to names or whatnot, but I think as long as the code is clear & we can convince ourselves it's correct in review, that's more or less sufficient for moving on.\r\n",
      "created_at" : "2020-01-29T09:06:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#issuecomment-579660932",
      "id" : 579660932,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17925",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3OTY2MDkzMg==",
      "updated_at" : "2020-01-29T09:06:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/579660932",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Just to summarize for those looking to review - as of bd5a026 there are 3 ACKs (@sdaftuar, @ariard, and @hebasto) and one \"looks good\" from @ajtowns with no NACKs or any show-stopping concerns raised.\r\n\r\n- In review, there have been some style nits and naming convention disagreements along with a suggested follow on [PR](https://github.com/bitcoin/bitcoin/pull/18017) from @ajtowns which uses clang's thread safety annotations and encapsulates the data more strongly to reduce chances of bugs from API misuse. \r\n\r\n- @sdaftuar has [verified a speed-up](https://github.com/bitcoin/bitcoin/pull/17925#issuecomment-575206318) for the case this PR was designed for.",
      "created_at" : "2020-01-29T20:33:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#issuecomment-579946380",
      "id" : 579946380,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17925",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3OTk0NjM4MA==",
      "updated_at" : "2020-01-29T20:33:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/579946380",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/755825?v=4",
         "events_url" : "https://api.github.com/users/adamjonas/events{/privacy}",
         "followers_url" : "https://api.github.com/users/adamjonas/followers",
         "following_url" : "https://api.github.com/users/adamjonas/following{/other_user}",
         "gists_url" : "https://api.github.com/users/adamjonas/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/adamjonas",
         "id" : 755825,
         "login" : "adamjonas",
         "node_id" : "MDQ6VXNlcjc1NTgyNQ==",
         "organizations_url" : "https://api.github.com/users/adamjonas/orgs",
         "received_events_url" : "https://api.github.com/users/adamjonas/received_events",
         "repos_url" : "https://api.github.com/users/adamjonas/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/adamjonas/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/adamjonas/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/adamjonas"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "ACK bd5a02692853f7240a4fdc593d7d0123d7916e45 (code review)",
      "created_at" : "2020-01-30T02:12:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#issuecomment-580052200",
      "id" : 580052200,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17925",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MDA1MjIwMA==",
      "updated_at" : "2020-01-30T02:12:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/580052200",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r374052497"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/374052497"
         }
      },
      "author_association" : "MEMBER",
      "body" : "typo for follow-ups: s/traverals/traversals/",
      "commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "created_at" : "2020-02-03T11:30:29Z",
      "diff_hunk" : "@@ -736,6 +739,55 @@ class CTxMemPool\n      *  removal.\n      */\n     void removeUnchecked(txiter entry, MemPoolRemovalReason reason) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+public:\n+    /** EpochGuard: RAII-style guard for using epoch-based graph traversal algorithms.\n+     *     When walking ancestors or descendants, we generally want to avoid\n+     * visiting the same transactions twice. Some traversal algorithms use\n+     * std::set (or setEntries) to deduplicate the transaction we visit.\n+     * However, use of std::set is algorithmically undesirable because it both\n+     * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17925#discussion_r374052497",
      "id" : 374052497,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDA1MjQ5Nw==",
      "original_commit_id" : "bd5a02692853f7240a4fdc593d7d0123d7916e45",
      "original_position" : 27,
      "path" : "src/txmempool.h",
      "position" : 27,
      "pull_request_review_id" : 352188424,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17925",
      "updated_at" : "2020-02-03T11:32:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/374052497",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   }
]
