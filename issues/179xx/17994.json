{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "MEMBER",
   "body" : "Fixes #17890. Replaces #17892.\r\n\r\nData files (`{blk|rev}<number>.dat`) pre-allocate space as they are written, and then trims down to the final size once they move on to the next sequence (\"finalized flush\"). The code currently assumes (incorrectly) that blk and rev files finish at the same time, but because blk files are written as blocks come in, and rev files are written in block height order, rev files end up being written to for awhile after moving on to the next block file, resulting in pre-allocation and waste of up to 1 MB of space per rev file.\r\n\r\nThe exact point at which rev file writing finishes is the highest height block found inside the corresponding block file, which is already available in the CBlockFileInfo vector. This PR moves finalized flushing of undo files to to directly after the undo data for the previous block file has been written.\r\n\r\nThere is a branch with annotation that demonstrates how this is handling flushing here: https://github.com/kallewoof/bitcoin/tree/200124-rev-files-annotated",
   "closed_at" : "2020-06-04T14:40:18Z",
   "closed_by" : {
      "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
      "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
      "followers_url" : "https://api.github.com/users/laanwj/followers",
      "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/laanwj",
      "id" : 126646,
      "login" : "laanwj",
      "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
      "organizations_url" : "https://api.github.com/users/laanwj/orgs",
      "received_events_url" : "https://api.github.com/users/laanwj/received_events",
      "repos_url" : "https://api.github.com/users/laanwj/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/laanwj"
   },
   "comments" : 13,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17994/comments",
   "created_at" : "2020-01-24T06:04:51Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17994/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/17994",
   "id" : 554560935,
   "labels" : [
      {
         "color" : "FBBAAB",
         "default" : false,
         "description" : null,
         "id" : 64585,
         "name" : "Bug",
         "node_id" : "MDU6TGFiZWw2NDU4NQ==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Bug"
      },
      {
         "color" : "6060aa",
         "default" : false,
         "description" : null,
         "id" : 118379652,
         "name" : "Validation",
         "node_id" : "MDU6TGFiZWwxMTgzNzk2NTI=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Validation"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17994/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDExOlB1bGxSZXF1ZXN0MzY2NjkyNjgz",
   "number" : 17994,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/17994.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17994",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/17994.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17994"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "validation: flush undo files after last block write",
   "updated_at" : "2020-06-04T14:40:18Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17994",
   "user" : {
      "avatar_url" : "https://avatars3.githubusercontent.com/u/250224?v=4",
      "events_url" : "https://api.github.com/users/kallewoof/events{/privacy}",
      "followers_url" : "https://api.github.com/users/kallewoof/followers",
      "following_url" : "https://api.github.com/users/kallewoof/following{/other_user}",
      "gists_url" : "https://api.github.com/users/kallewoof/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/kallewoof",
      "id" : 250224,
      "login" : "kallewoof",
      "node_id" : "MDQ6VXNlcjI1MDIyNA==",
      "organizations_url" : "https://api.github.com/users/kallewoof/orgs",
      "received_events_url" : "https://api.github.com/users/kallewoof/received_events",
      "repos_url" : "https://api.github.com/users/kallewoof/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/kallewoof/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/kallewoof"
   }
}
