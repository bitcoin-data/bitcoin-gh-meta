[
   {
      "body" : "This changes the semantics of a function that is used in consensus.\r\n\r\nHowever the only uses of `IsFinalTx` with default arguments (before this change) are in the wallet and tests so I think it is ok.\r\n\r\nThough now that we're changing this function anyway, I'd prefer splitting up `IsFinalTx` into:\r\n\r\n- A function `IsFinalTx` that takes explicit `nBlockHeight` `nBlockTime` arguments. This is a consensus function independent of program state.\r\n- A function `IsFinalTxNow` that calls `IsFinalTx` with the default arguments (`chainActive.Height() + 1` and `GetAdjustedTime()`), to be used by the wallet and such.\r\n",
      "created_at" : "2015-05-26T06:13:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6183#issuecomment-105410432",
      "id" : 105410432,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6183",
      "updated_at" : "2015-05-26T06:13:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/105410432",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "@laanwj +1\r\n\r\nChanging the behaviour of a function without renaming it or otherwise breaking old code using it, is asking for trouble.",
      "created_at" : "2015-05-26T06:35:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6183#issuecomment-105415633",
      "id" : 105415633,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6183",
      "updated_at" : "2015-05-26T06:35:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/105415633",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "body" : "See @jtimon's #6063, it sort of does what I'm describing above, apart from renaming the function.",
      "created_at" : "2015-05-27T08:58:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6183#issuecomment-105829767",
      "id" : 105829767,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6183",
      "updated_at" : "2015-05-27T08:58:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/105829767",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "@laanwj Split into two functions.\r\n\r\nIn doing so I also had to add part #6177 \r\n\r\nAny thoughts on what should happen at https://github.com/bitcoin/bitcoin/blob/28bf06236d3b385e95fe26a7a742395b30efd6ee/src/test/miner_tests.cpp#L251?",
      "created_at" : "2015-05-27T10:02:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6183#issuecomment-105849719",
      "id" : 105849719,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6183",
      "updated_at" : "2015-05-27T10:02:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/105849719",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "body" : "Any reason not to just rebase on top of #6063 ?\r\nThat way the function that keeps the old name does what it used to do while the new one has the different name (which will also be more consistent with other consensus functions and will avoid creating unnecessary conflicts with other open PRs [see #6051 ] and other old branches based on them). \r\n\r\n> Any thoughts on what should happen at https://github.com/bitcoin/bitcoin/blob/28bf06236d3b385e95fe26a7a742395b30efd6ee/src/test/miner_tests.cpp#L251 ?\r\n\r\nI believe testing the new method would be good. This is just another example of how globals make testing more difficult.\r\n",
      "created_at" : "2015-05-27T12:13:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6183#issuecomment-105886824",
      "id" : 105886824,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6183",
      "updated_at" : "2015-05-27T12:13:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/105886824",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6183#discussion_r31130828"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6183"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/31130828"
         }
      },
      "body" : "Could just use `IsFinalTx` here with manual arguments instead of `CheckFinalTx` for these tests?",
      "commit_id" : "28bf06236d3b385e95fe26a7a742395b30efd6ee",
      "created_at" : "2015-05-27T13:08:53Z",
      "diff_hunk" : "@@ -248,8 +248,10 @@ BOOST_AUTO_TEST_CASE(CreateNewBlock_validity)\n     chainActive.Tip()->nHeight++;\n     SetMockTime(chainActive.Tip()->GetMedianTimePast()+2);\n \n-    BOOST_CHECK(IsFinalTx(tx, chainActive.Tip()->nHeight + 1));\n-    BOOST_CHECK(IsFinalTx(tx2));\n+    // FIXME: we should *actually* create a new block so the following test\n+    //        works; CheckFinalTx() isn't fooled by monkey-patching nHeight.\n+    //BOOST_CHECK(CheckFinalTx(tx));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6183#discussion_r31130828",
      "id" : 31130828,
      "original_commit_id" : "28bf06236d3b385e95fe26a7a742395b30efd6ee",
      "original_position" : 26,
      "path" : "src/test/miner_tests.cpp",
      "position" : 26,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6183",
      "updated_at" : "2015-05-27T13:08:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/31130828",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6183#discussion_r31131139"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6183"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/31131139"
         }
      },
      "body" : "Curious that this wasn't set yet, anyhow it makes sense to do it",
      "commit_id" : "28bf06236d3b385e95fe26a7a742395b30efd6ee",
      "created_at" : "2015-05-27T13:12:38Z",
      "diff_hunk" : "@@ -137,6 +137,7 @@ CBlockTemplate* CreateNewBlock(const CScript& scriptPubKeyIn)\n         LOCK2(cs_main, mempool.cs);\n         CBlockIndex* pindexPrev = chainActive.Tip();\n         const int nHeight = pindexPrev->nHeight + 1;\n+        pblock->nTime = GetAdjustedTime();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6183#discussion_r31131139",
      "id" : 31131139,
      "original_commit_id" : "28bf06236d3b385e95fe26a7a742395b30efd6ee",
      "original_position" : 4,
      "path" : "src/miner.cpp",
      "position" : 4,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6183",
      "updated_at" : "2015-05-27T13:12:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/31131139",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Looks good to me now.\r\n\r\n@jtimon The reason for renaming the function is outlined in my last post, as well as @luke-jr's reply - as this pull changes the functionality of the function, so to be sure that all caller sites are 'aware' of this it makes sense to rename it.\r\nApart from that I have no opinion on how the functions should be called.",
      "created_at" : "2015-05-27T13:21:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6183#issuecomment-105905555",
      "id" : 105905555,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6183",
      "updated_at" : "2015-05-27T13:21:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/105905555",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6183#discussion_r31136559"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6183"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/31136559"
         }
      },
      "body" : "Are you sure none of the current callers of IsFinalTx pass nBlockHeight or nBlockTime = 0 ?\r\nSeriously, it seems much safer to keep this function as it is and call the \"new\"/consensus-friendly one from that one.\r\nIf you're breaking the old one, why keep to of them at all?\r\nThe only reason I maintain the old one in #6063 is to make sure it keeps being functionally identical. If you can't warranty that, I would just use the consensus-friendly version everywhere. ",
      "commit_id" : "28bf06236d3b385e95fe26a7a742395b30efd6ee",
      "created_at" : "2015-05-27T14:09:15Z",
      "diff_hunk" : "@@ -658,14 +658,8 @@ bool IsStandardTx(const CTransaction& tx, string& reason)\n \n bool IsFinalTx(const CTransaction &tx, int nBlockHeight, int64_t nBlockTime)\n {\n-    AssertLockHeld(cs_main);\n-    // Time based nLockTime implemented in 0.1.6\n     if (tx.nLockTime == 0)\n         return true;\n-    if (nBlockHeight == 0)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6183#discussion_r31136559",
      "id" : 31136559,
      "original_commit_id" : "28bf06236d3b385e95fe26a7a742395b30efd6ee",
      "original_position" : 8,
      "path" : "src/main.cpp",
      "position" : 8,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6183",
      "updated_at" : "2015-05-27T14:09:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/31136559",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "body" : "@laanwj Well, a caller like IsFinalTx(tx, 0, 0) won't work as expected.\r\nThe new function could be the consensus-friendly one, as in #6063.\r\nThat would also make my life easier, although I guess saving developers' time is not that strong of an argument...\r\nKeeping IsFinalTx functionally identical (before maybe deprecating it) is a stronger argument.\r\nYou can also create a third one dependent on the globals and without parameters (like CheckFinalTransaction here) and probably call it IsFinalTx just like the other global-dependent one.\r\n",
      "created_at" : "2015-05-27T14:21:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6183#issuecomment-105928917",
      "id" : 105928917,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6183",
      "updated_at" : "2015-05-27T14:21:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/105928917",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6183#discussion_r31178663"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6183"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/31178663"
         }
      },
      "body" : "You could, but it'd create more code to update if the logic of CheckFinalTx() changes for some reason. Remember that this is really a \"test-the-test\" line of code, not what the test is actually trying to test.",
      "commit_id" : "28bf06236d3b385e95fe26a7a742395b30efd6ee",
      "created_at" : "2015-05-27T20:48:54Z",
      "diff_hunk" : "@@ -248,8 +248,10 @@ BOOST_AUTO_TEST_CASE(CreateNewBlock_validity)\n     chainActive.Tip()->nHeight++;\n     SetMockTime(chainActive.Tip()->GetMedianTimePast()+2);\n \n-    BOOST_CHECK(IsFinalTx(tx, chainActive.Tip()->nHeight + 1));\n-    BOOST_CHECK(IsFinalTx(tx2));\n+    // FIXME: we should *actually* create a new block so the following test\n+    //        works; CheckFinalTx() isn't fooled by monkey-patching nHeight.\n+    //BOOST_CHECK(CheckFinalTx(tx));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6183#discussion_r31178663",
      "id" : 31178663,
      "original_commit_id" : "28bf06236d3b385e95fe26a7a742395b30efd6ee",
      "original_position" : 26,
      "path" : "src/test/miner_tests.cpp",
      "position" : 26,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6183",
      "updated_at" : "2015-05-27T20:48:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/31178663",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6183#discussion_r31178955"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6183"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/31178955"
         }
      },
      "body" : "I am quite sure of that, particularly since the callers that would do that are all consensus-critical code, and this could lead to a consensus split. Edit: maybe that comes off the wrong way... I mean, because it could lead to a consensus split, I spent a good hour or so examining every call of IsFinalTx() to be sure it'd never be called that way.\r\n\r\nFortunately the only block for which nBlockHeight=0 or nBlockTime=0 is legal is the genesis block so we don't actually have that bug in practice. Additionally if nBlockHeight/nBlockTime are set to zero the function still behaves as you'd expect it to in that circumstance.",
      "commit_id" : "28bf06236d3b385e95fe26a7a742395b30efd6ee",
      "created_at" : "2015-05-27T20:51:34Z",
      "diff_hunk" : "@@ -658,14 +658,8 @@ bool IsStandardTx(const CTransaction& tx, string& reason)\n \n bool IsFinalTx(const CTransaction &tx, int nBlockHeight, int64_t nBlockTime)\n {\n-    AssertLockHeld(cs_main);\n-    // Time based nLockTime implemented in 0.1.6\n     if (tx.nLockTime == 0)\n         return true;\n-    if (nBlockHeight == 0)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6183#discussion_r31178955",
      "id" : 31178955,
      "original_commit_id" : "28bf06236d3b385e95fe26a7a742395b30efd6ee",
      "original_position" : 8,
      "path" : "src/main.cpp",
      "position" : 8,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6183",
      "updated_at" : "2015-05-27T21:24:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/31178955",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "body" : "Personally I prefer the terminology \"IsFinalTx()\" for the \"no-context\" consensus-critical check, and \"CheckFinalTx()\" for the context-dependent non-consensus-critical check.",
      "created_at" : "2015-05-27T20:55:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6183#issuecomment-106071996",
      "id" : 106071996,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6183",
      "updated_at" : "2015-05-27T20:55:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/106071996",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6183#discussion_r31205880"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6183"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/31205880"
         }
      },
      "body" : "> I am quite sure of that, particularly since the callers that would do that are all consensus-critical code, and this could lead to a consensus split. Edit: maybe that comes off the wrong way... I mean, because it could lead to a consensus split, I spent a good hour or so examining every call of IsFinalTx() to be sure it'd never be called that way.\r\n\r\nThen why maintain a global-state-dependent function at all?\r\nIf we're going to review all the calls and change all those lines, let's just have the stateless version of it.\r\nAnd at that point, you're only changing one function, shouldn't the criterion \"if you change functionality, change the name of the function\" precisely apply here?\r\n\r\n> Fortunately the only block for which nBlockHeight=0 or nBlockTime=0 is legal is the genesis block so we don't actually have that bug in practice. \r\n\r\nWell, the genesis block shouldn't be tested since it's correct by definition (is really the first consensus rule), so that's fine.\r\n\r\n> Additionally if nBlockHeight/nBlockTime are set to zero the function still behaves as you'd expect it to in that circumstance.\r\n\r\nNo, before the null values were replaced with values from the global state, now they don't.\r\nThey clearly function differently (even if you're taking care of it not mattering by adapting things on the caller, the function itself is NOT functionally equivalent to the previous stateful one).",
      "commit_id" : "28bf06236d3b385e95fe26a7a742395b30efd6ee",
      "created_at" : "2015-05-28T06:19:44Z",
      "diff_hunk" : "@@ -658,14 +658,8 @@ bool IsStandardTx(const CTransaction& tx, string& reason)\n \n bool IsFinalTx(const CTransaction &tx, int nBlockHeight, int64_t nBlockTime)\n {\n-    AssertLockHeld(cs_main);\n-    // Time based nLockTime implemented in 0.1.6\n     if (tx.nLockTime == 0)\n         return true;\n-    if (nBlockHeight == 0)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6183#discussion_r31205880",
      "id" : 31205880,
      "original_commit_id" : "28bf06236d3b385e95fe26a7a742395b30efd6ee",
      "original_position" : 8,
      "path" : "src/main.cpp",
      "position" : 8,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6183",
      "updated_at" : "2015-05-28T06:21:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/31205880",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "body" : "> Personally I prefer the terminology \"IsFinalTx()\" for the \"no-context\" consensus-critical check, and \"CheckFinalTx()\" for the context-dependent non-consensus-critical check.\r\n\r\nAs said, Check is being used by other consensus functions (stateless) and IsFinalTx was global-state dependent. For consistency, it would be better to have the consensus version start with Check. But since this may be considered bikesheding, let me explain what the options I see. Let's imagine this in smaller commits that have been squashed and consider stopping at each point.\r\n\r\n1) Fix the bug without touching IsFinalTx, simply by appropriately  adapting the arguments in the pertinent calls (like the one in miner). We could simply stop here (or at any point).\r\n\r\n2) Separate a stateless (consensus-friendly) version of the function, like in #6063 .\r\n\r\n3) Every call to the old function that passes both arguments and passes them as non-null values, can be safely replaced with a call to the new function, great. You can go further and only leave the old calls that were using the default null values (triggering the replacement with the global state).\r\n\r\n4) Now we can safely remove the optional parameters from the old function, since nobody is using them (the calls that use the parameters now call to the new statelss function).\r\n\r\n5) Maybe we wanted to make the fix at this point instead of doing it first, since now you can fix it inside the stateless function and presumably less calls will be affected.\r\n\r\n6) Assuming we had chosen IsFinalTx for the old global-state-dependent function and CheckFinalTx for the new stateless version (as in #6063 ), we can now switch the names to gratuitously increase the total diff, make the stateless version name less consistent with other consensus functions names and complicate the rebase of branches that were already separating those functions (like #6051 and branches based on it) or that were touching changing IsFinalTx (like https://github.com/maaku/bitcoin/commits/seqno-cltv-csv).\r\n\r\nLet's please stop before 6. Let's forget about naming and making me and possibly other people work more. I propose to use a cleaner git history as the main criterion. My approach is better because it will produce a smaller total diff (since some calls that were using the default values can remain untouched). \r\n",
      "created_at" : "2015-05-28T06:50:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6183#issuecomment-106198465",
      "id" : 106198465,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6183",
      "updated_at" : "2015-05-28T06:50:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/106198465",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6183#discussion_r31223440"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6183"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/31223440"
         }
      },
      "body" : "> Then why maintain a global-state-dependent function at all?\r\n\r\nHuh? The global state-dependent function is for the convenience of callers, who just need to know if the tx will be final by the time the next block comes.\r\n\r\n> If we're going to review all the calls and change all those lines, let's just have the stateless version of it.\r\n\r\nHaving only the stateless IsFinalTx() as an option results in most of those calls having useless - and probably soon to be obsolete - Tip()->nHeight, GetAdjustedTime() boilerplate.\r\n\r\n> And at that point, you're only changing one function, shouldn't the criterion \"if you change functionality, change the name of the function\" precisely apply here?\r\n\r\nThe functionality of mixing up a consensus-critical and non-consensus-critical function in one is simply broken.\r\n\r\n> No, before the null values were replaced with values from the global state, now they don't.\r\nThey clearly function differently (even if you're taking care of it not mattering by adapting things on the caller, the function itself is NOT functionally equivalent to the previous stateful one).\r\n\r\nAgain, the previous design of IsFinalTx() is simply broken and shouldn't have happened; from the point of view of the important stuff - the consensus-critical code - the functionality hasn't changed changed. Fortunately we never had a situation where that *broken design* bit us in the ass so in spite of it we didn't end up with a forking bug; if the functionality had changed from the point of view of consensus-critical code it'd be a guaranteed forking bug because it's comparing nLockTime to state that is *not the same on every node*.",
      "commit_id" : "28bf06236d3b385e95fe26a7a742395b30efd6ee",
      "created_at" : "2015-05-28T11:17:24Z",
      "diff_hunk" : "@@ -658,14 +658,8 @@ bool IsStandardTx(const CTransaction& tx, string& reason)\n \n bool IsFinalTx(const CTransaction &tx, int nBlockHeight, int64_t nBlockTime)\n {\n-    AssertLockHeld(cs_main);\n-    // Time based nLockTime implemented in 0.1.6\n     if (tx.nLockTime == 0)\n         return true;\n-    if (nBlockHeight == 0)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6183#discussion_r31223440",
      "id" : 31223440,
      "original_commit_id" : "28bf06236d3b385e95fe26a7a742395b30efd6ee",
      "original_position" : 8,
      "path" : "src/main.cpp",
      "position" : 8,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6183",
      "updated_at" : "2015-05-28T11:17:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/31223440",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "body" : "Something you're probably not aware of re: CheckFinalTx() is that I'll be submitting another pull-req once this is merged to change CheckFinalTx() to use GetMedianTime() rather than GetAdjustedTime(). This is important for a number of security related reasons. (most discussed before on #bitcoin-wizards) After that I'll be proposing a soft-fork enforcing this within blocks themselves.\r\n\r\nMy thinking re: *not* renaming IsFinalTx() is taking that into account, because IsFinalTx() in that case would be relegated to purely consensus-critical function deep in the bowels of validation, with CheckFinalTx() being what you'd expect people to normally be using to answer the question \"Is the transaction (effectively) final right now?\" (possibly IsFinalTx() might even get renamed to OldIsFinalTx() to further hammer home that point)\r\n\r\nNow, at some point in the implementation of that BIP I wouldn't be surprised if it makes sense to make it possible to provide a \"chain tip\" parameter to CheckFinalTx() to tell it what chain you're checking with respect too, and thus what's the median time, but for now the consensus-critical stuff can stay the way it is. Importantly, by changing everything else we get it all onto a new function with guaranteed semantics of \"just figure out if this transaction is final according to whatever rules exist\" - exactly what you'd expect from a Check*() function! Equally, when that chainTip parameter does get added, we'll be sure to catch everything that needs to be updated in one fell swoop. (if it's not done as a default parameter)\r\n\r\nAnyway, smaller total diffs aren't necessarily always a good thing. In this case, by changing the function name we help clue people in to think \"Why did IsFinalTx() change names?\" \"What's different about the design now?\", hopefully setting the stage to discover things like a future median time rule change.",
      "created_at" : "2015-05-28T11:43:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6183#issuecomment-106286667",
      "id" : 106286667,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6183",
      "updated_at" : "2015-05-28T11:43:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/106286667",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "body" : "> \"just figure out if this transaction is final according to whatever rules exist\" - exactly what you'd expect from a Check*() function! \r\n\r\nI would also expect that function to be stateless!\r\n\r\n> Anyway, smaller total diffs aren't necessarily always a good thing. In this case, by changing the function name we help clue people in to think \"Why did IsFinalTx() change names?\" \"What's different about the design now?\", hopefully setting the stage to discover things like a future median time rule change.\r\n\r\nThen why keep the name IsFinalTx at all when the function is changing from global-state-dependent to stateless?\r\nWhat about using CheckFinalTx for the stateless one and finding anther name for the convenience new one? Like, I don't know, TestFinalTx or something.\r\nThat alone would make me happy.\r\n\r\n> Something you're probably not aware of re: CheckFinalTx() is that I'll be submitting another pull-req once this is merged to change CheckFinalTx() to use GetMedianTime() rather than GetAdjustedTime(). > This is important for a number of security related reasons. (most discussed before on #bitcoin-wizards) After that I'll be proposing a soft-fork enforcing this within blocks themselves.\r\n\r\nOk, I didn't know this. I have to say that passing a CBlockIndex* from the beginning instead of using the global tip would make the function more stateless and my concerns with it being named CheckFinalTx would be lower, specially if it's going to be fully statelss later by not calling GetAdjustedTime().\r\nWhat about passing a CBlockIndex from the beginning? This will not increase the total diff either.\r\nMaybe also moving to from GetAdjustedTime to GetMedianTime in this PR. Tat would make CheckFinalTx stateless from the beginning: that would make me happy as well.\r\n\r\nSo, to reiterate and in summary: a function named CheckFinalTx should be as stateless as possible from the beginning: using the global activeTip inside it, even temporarily, seems horrendous to me.\r\nI now realize that there's more options than I was considering to make that happen.\r\n",
      "created_at" : "2015-05-28T15:10:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6183#issuecomment-106390582",
      "id" : 106390582,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6183",
      "updated_at" : "2015-05-28T15:11:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/106390582",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "body" : "Note that for the last option, CheckFinalTx could optionally take the time (which callers that use it would set as GetAdjustedTime) which is set to pindexTip->GetMedianTime() inside if it's not provided (or 0 is passed).\r\nThen your softfork would merely consist on removing the optional parameter to always use pindexTip->GetMedianTime.\r\nI believe that would be the clearest history possible for those plans.\r\nAnd I could also cleanly move both functions to consensus (do we still need 2 functions at this point?) in #6051 .",
      "created_at" : "2015-05-28T15:18:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6183#issuecomment-106399229",
      "id" : 106399229,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6183",
      "updated_at" : "2015-05-28T15:18:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/106399229",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "body" : "> Then why keep the name IsFinalTx at all when the function is changing from global-state-dependent to stateless?\r\n\r\nAgain, from the point of view of the code that mattered, IsFinalTx() was a stateless function... That it potentially wasn't was an unfortunate bug, not a feature.\r\n\r\nEqually, we can't get rid of it after a soft-fork and replace it with some CheckFinalTx() or whatnot that takes block indexes, as the old behavior is still needed to verify old blocks.\r\n\r\nRe: adding CBlockIndex's and the like right now, that needs some discussion and thought, so it's not going to happen in this pull-req.",
      "created_at" : "2015-05-28T16:14:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6183#issuecomment-106453842",
      "id" : 106453842,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6183",
      "updated_at" : "2015-05-28T16:14:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/106453842",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "body" : "> Re: adding CBlockIndex's and the like right now, that needs some discussion and thought, so it's not going to happen in this pull-req.\r\n\r\nAt least moving up the use of the global chainActive shouldn't generate much discussion.\r\nForcing the callers to call GetAdjustedTime themselves shouldn't be controversial either, specially since you're already touching those lines.\r\nAt that point, I would be happy with the new one being named CheckFinalTx or (even Consensus::CheckFinalTx) because it would already be stateless (even without using GetMedianTime). Even not forcing them to call GetAdjustedTime would be acceptable, but there's really no good reason to use chainActive inside a new function no matter how it is named. \r\n\r\n> Equally, we can't get rid of it after a soft-fork and replace it with some CheckFinalTx() or whatnot that takes block indexes, as the old behavior is still needed to verify old blocks.\r\n\r\nAs said I would be happy with both:\r\n\r\n1) Maintaining it as CheckFinalTx (new name because nw it's stateless) and maybe unify it with the new TestFinalTx in the future.\r\n\r\n2) If the new function is going to be stateless and named CheckFinalTx, we can maintain it as IsFinalTx or IsFinalTxOld or something.\r\n\r\nSo even assuming we want to have 2 separate functions for now, there's at least 2 options for getting a stateless (consensus-friendly) one named CheckFinalTx in this PR (so I would be happy to close #6063 and rebase #6051 on top of this).\r\n",
      "created_at" : "2015-05-28T16:35:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6183#issuecomment-106471202",
      "id" : 106471202,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6183",
      "updated_at" : "2015-05-28T16:35:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/106471202",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "body" : "> Forcing the callers to call GetAdjustedTime themselves shouldn't be controversial either, specially since you're already touching those lines.\r\n\r\nIf I did that, we'd have to re-touch a whole bunch of code all over again later... Notably, that's the kind of design mistake that lead to the bug this pull-req is fixing (re)appearing in the first place.\r\n\r\nAnyway, continuing this discussion is a waste of time. @laanwj do whatever you want, just make sure this bug actually gets fixed.",
      "created_at" : "2015-05-28T19:12:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6183#issuecomment-106569366",
      "id" : 106569366,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6183",
      "updated_at" : "2015-05-28T19:12:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/106569366",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "body" : "> If I did that, we'd have to re-touch a whole bunch of code all over again later... Notably, that's the kind of design mistake that lead to the bug this pull-req is fixing (re)appearing in the first place.\r\n\r\nFair enough, don't do that then. \r\nCan we at least avoid the gratuitous use of the global chainActive in the new function?",
      "created_at" : "2015-05-28T21:41:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6183#issuecomment-106608088",
      "id" : 106608088,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6183",
      "updated_at" : "2015-05-28T21:41:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/106608088",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "body" : "ACK. Merging this as-is. Can discuss naming later but I think the naming is fine.\r\n(I was about to suggest that the new `CheckFinalTx` can be moved to the wallet, but unfortunately there's one use left in main.cpp itself in `AcceptToMemoryPool`)",
      "created_at" : "2015-06-01T09:36:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6183#issuecomment-107381107",
      "id" : 107381107,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6183",
      "updated_at" : "2015-06-01T09:36:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/107381107",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   }
]
