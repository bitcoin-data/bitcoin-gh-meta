[
   {
      "author_association" : "MEMBER",
      "body" : "This was tried very recently already: #21445",
      "created_at" : "2021-03-19T01:18:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21473#issuecomment-802437836",
      "id" : 802437836,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21473",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwMjQzNzgzNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-19T01:18:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/802437836",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "We tested this in #21445, but didn't seem to see any advantage, potentially the builds were even [being under resourced](https://github.com/bitcoin/bitcoin/pull/21445#issuecomment-800039758):\r\n> It seems this will result in a slow-down. E.g. https://cirrus-ci.com/task/6631575736549376?command=ci#L5821 vs https://cirrus-ci.com/task/5477946514210816?command=ci#L5513\r\n\r\n> Looks like it is only using 0.3 CPU even though 2 have been requested?\r\n\r\nIs this no longer the case?",
      "created_at" : "2021-03-19T01:18:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21473#issuecomment-802437851",
      "id" : 802437851,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21473",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwMjQzNzg1MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-19T01:18:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/802437851",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Didn't know you already tried it. Seem weird since the new cluster is using much faster CPUs (they have better single core performance 3.1 GHz vs 2.6 GHz). Let's see how this run will perform.\r\n\r\nBTW how does your build system detect how many cores available? Could it be that it detect wrongly and tries to use 32 cores of the host VM which causes the actual 2 cores being overwhelmed. ð¤ ",
      "created_at" : "2021-03-19T01:30:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21473#issuecomment-802444607",
      "id" : 802444607,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21473",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwMjQ0NDYwNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-19T01:30:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/802444607",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/989066?v=4",
         "events_url" : "https://api.github.com/users/fkorotkov/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fkorotkov/followers",
         "following_url" : "https://api.github.com/users/fkorotkov/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fkorotkov/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fkorotkov",
         "id" : 989066,
         "login" : "fkorotkov",
         "node_id" : "MDQ6VXNlcjk4OTA2Ng==",
         "organizations_url" : "https://api.github.com/users/fkorotkov/orgs",
         "received_events_url" : "https://api.github.com/users/fkorotkov/received_events",
         "repos_url" : "https://api.github.com/users/fkorotkov/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fkorotkov/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fkorotkov/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fkorotkov"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Our ci scripts use `MAKEJOBS` to pass down to `make` and the python tests. It is set to `\"-j4\"`, so that the 2 CPU we requested are filled most of the time.\r\n\r\nI believe the difference between the regular containers and the kvm cluster is that the kvm will spin up a \"private\" vm with the requested CPUs, whereas the regular cluster will use a large shared vm. So if 20 Cirrus users compete for the SSD on the shared vm, it might be faster to use a HDD on the private vm. The CPU will wait idle while the SSD is working.",
      "created_at" : "2021-03-19T06:37:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21473#issuecomment-802594219",
      "id" : 802594219,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21473",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwMjU5NDIxOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-19T06:37:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/802594219",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Still takes more time than the master branch.",
      "created_at" : "2021-03-19T10:46:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21473#issuecomment-802733237",
      "id" : 802733237,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21473",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwMjczMzIzNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-19T10:46:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/802733237",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> Still takes more time than the master branch.\r\n\r\nIndeed. This is very surprising for me since the local SSD on the VMs are 24 times faster than an HHD and the CPUs are faster. On paper everything is faster and indeed a few tasks were faster:\r\n\r\n<img width=\"1555\" alt=\"Screen Shot 2021-03-19 at 7 06 44 AM\" src=\"https://user-images.githubusercontent.com/989066/111772318-1a674180-8883-11eb-8f91-78212acae87c.png\">\r\n\r\nLet me try to rebase and see how a new build performance. I'm very curious in situation and I'd like to investigate a bit more. Maybe there is some  room for improvement for Cirrus. ð¤ ",
      "created_at" : "2021-03-19T11:18:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21473#issuecomment-802759504",
      "id" : 802759504,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21473",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwMjc1OTUwNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-19T11:18:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/802759504",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/989066?v=4",
         "events_url" : "https://api.github.com/users/fkorotkov/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fkorotkov/followers",
         "following_url" : "https://api.github.com/users/fkorotkov/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fkorotkov/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fkorotkov",
         "id" : 989066,
         "login" : "fkorotkov",
         "node_id" : "MDQ6VXNlcjk4OTA2Ng==",
         "organizations_url" : "https://api.github.com/users/fkorotkov/orgs",
         "received_events_url" : "https://api.github.com/users/fkorotkov/received_events",
         "repos_url" : "https://api.github.com/users/fkorotkov/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fkorotkov/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fkorotkov/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fkorotkov"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "I think my initial feeling was right. If I understood the code of tests correctly, they are like integration tests where you have bunch of the nodes running and you verify the results in the end. I think the C++ code [here](https://github.com/bitcoin/bitcoin/blob/05757aa860215a8fd5002d99b6ec653175c6b734/src/util/system.cpp#L1336-L1339) gets the CPU count wrong in case of running in a container. In case of the KVM containers the VM running it is the same size so it works. I think in this case, each node in the integration tests is trying to use 32 cores even though it's throttled by the cgroups. Do you know if there is an easy way to verify my theory and see how many CPUs TestNodes are trying to use during tests?",
      "created_at" : "2021-03-19T12:45:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21473#issuecomment-802808158",
      "id" : 802808158,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21473",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwMjgwODE1OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-19T12:45:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/802808158",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/989066?v=4",
         "events_url" : "https://api.github.com/users/fkorotkov/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fkorotkov/followers",
         "following_url" : "https://api.github.com/users/fkorotkov/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fkorotkov/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fkorotkov",
         "id" : 989066,
         "login" : "fkorotkov",
         "node_id" : "MDQ6VXNlcjk4OTA2Ng==",
         "organizations_url" : "https://api.github.com/users/fkorotkov/orgs",
         "received_events_url" : "https://api.github.com/users/fkorotkov/received_events",
         "repos_url" : "https://api.github.com/users/fkorotkov/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fkorotkov/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fkorotkov/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fkorotkov"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "I've tried to hardcode the CPU amount but still got slower performance for `multiprocess`. I'm a bit confused how it can be slower given that on paper everything should be faster. ð¤·ââï¸\r\n\r\nI don't have any other ideas to try so will close the PR. Sorry for the noise.",
      "created_at" : "2021-03-19T18:07:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21473#issuecomment-803016623",
      "id" : 803016623,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21473",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwMzAxNjYyMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-19T18:07:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/803016623",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/989066?v=4",
         "events_url" : "https://api.github.com/users/fkorotkov/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fkorotkov/followers",
         "following_url" : "https://api.github.com/users/fkorotkov/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fkorotkov/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fkorotkov",
         "id" : 989066,
         "login" : "fkorotkov",
         "node_id" : "MDQ6VXNlcjk4OTA2Ng==",
         "organizations_url" : "https://api.github.com/users/fkorotkov/orgs",
         "received_events_url" : "https://api.github.com/users/fkorotkov/received_events",
         "repos_url" : "https://api.github.com/users/fkorotkov/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fkorotkov/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fkorotkov/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fkorotkov"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "(This has been merged in https://github.com/bitcoin/bitcoin/pull/21445#issuecomment-815853987)",
      "created_at" : "2021-04-09T11:25:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21473#issuecomment-816615236",
      "id" : 816615236,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21473",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxNjYxNTIzNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-09T11:25:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/816615236",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
