{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "NONE",
   "body" : "<!-- Describe the issue -->\r\n\r\nWhen running `importdescriptors` with `range` parameter like `[0, 900000]` if there is a transaction to any of the addresses in high range, e.g. address derived from `84'/1'/0'/0/777777`, bitcoind will hang and no longer respond to some of the RPC requests and syncing stops too.\r\n\r\nFurthermore in top I can observe for hours `bitcoind` process consuming 100% of CPU and doing nothing, also wallet isn't being touched.\r\n\r\n**Expected behavior**\r\n\r\nBitcoin descriptor wallet should be working correctly and import such descriptor without any issues even if the range specified is huge.\r\n\r\n**To reproduce**\r\n\r\n1. Install latest `bitcoin v23.0` (built using depends system), sync to testnet, by adding `testnet=1` in your `bitcoin.conf`\r\n2. Create test descriptor wallet: \r\n```\r\n./bitcoin-cli createwallet test_1\r\n{\r\n  \"name\": \"test_1\",\r\n  \"warning\": \"\"\r\n}\r\n```\r\n3. Get descriptors for the wallet:\r\n```\r\n$ ./bitcoin-cli -rpcwallet=test_1 listdescriptors true\r\n{\r\n  \"wallet_name\": \"test_1\",\r\n  \"descriptors\": [\r\n    {\r\n      \"desc\": \"tr(tprvXXX/86'/1'/0'/0/*)#fuh4d6pe\",\r\n      \"timestamp\": 1661100252,\r\n      \"active\": true,\r\n      \"internal\": false,\r\n      \"range\": [\r\n        0,\r\n        999\r\n      ],\r\n      \"next\": 0\r\n    },\r\n    {\r\n      \"desc\": \"tr(tprvXXX/86'/1'/0'/1/*)#cgj5s03p\",\r\n      \"timestamp\": 1661100254,\r\n      \"active\": true,\r\n      \"internal\": true,\r\n      \"range\": [\r\n        0,\r\n        999\r\n      ],\r\n      \"next\": 0\r\n    },\r\n    {\r\n      \"desc\": \"sh(wpkh(tprvXXX/49'/1'/0'/0/*))#5uegq3cr\",\r\n      \"timestamp\": 1661100252,\r\n      \"active\": true,\r\n      \"internal\": false,\r\n      \"range\": [\r\n        0,\r\n        999\r\n      ],\r\n      \"next\": 0\r\n    },\r\n    {\r\n      \"desc\": \"sh(wpkh(tprvXXX/49'/1'/0'/1/*))#jl3dmunh\",\r\n      \"timestamp\": 1661100253,\r\n      \"active\": true,\r\n      \"internal\": true,\r\n      \"range\": [\r\n        0,\r\n        999\r\n      ],\r\n      \"next\": 0\r\n    },\r\n    {\r\n      \"desc\": \"pkh(tprvXXX/44'/1'/0'/1/*)#t2man3ks\",\r\n      \"timestamp\": 1661100253,\r\n      \"active\": true,\r\n      \"internal\": true,\r\n      \"range\": [\r\n        0,\r\n        999\r\n      ],\r\n      \"next\": 0\r\n    },\r\n    {\r\n      \"desc\": \"wpkh(tprvXXX/84'/1'/0'/1/*)#dxzkmnkj\",\r\n      \"timestamp\": 1661100253,\r\n      \"active\": true,\r\n      \"internal\": true,\r\n      \"range\": [\r\n        0,\r\n        999\r\n      ],\r\n      \"next\": 0\r\n    },\r\n    {\r\n      \"desc\": \"pkh(tprvXXX/44'/1'/0'/0/*)#677uwyxg\",\r\n      \"timestamp\": 1661100251,\r\n      \"active\": true,\r\n      \"internal\": false,\r\n      \"range\": [\r\n        0,\r\n        999\r\n      ],\r\n      \"next\": 0\r\n    },\r\n    {\r\n      \"desc\": \"wpkh(tprvXXX/84'/1'/0'/0/*)#uj8hxxx2\",\r\n      \"timestamp\": 1661100252,\r\n      \"active\": true,\r\n      \"internal\": false,\r\n      \"range\": [\r\n        0,\r\n        999\r\n      ],\r\n      \"next\": 0\r\n    }\r\n  ]\r\n}\r\n```\r\n4. Derive address with huge derivation path `84'/1'/0'/0/777777` for test:\r\n```\r\n./bitcoin-cli deriveaddresses \"wpkh(tprvXXX/84'/1'/0'/0/777777)#60yed6sv\"\r\n[\r\n  \"tb1q5ge5pu77784lzyukur27wz2y2mtc8zzpyfw8nl\"\r\n]\r\n```\r\n5. Send some funds to that address:\r\n```\r\n./bitcoin-cli -rpcwallet=\"\" sendtoaddress tb1q5ge5pu77784lzyukur27wz2y2mtc8zzpyfw8nl 0.00001\r\nc7ca6d0a3c94085d393f973af4cf0bfc4e09e2885a5d0ef42af356ffcbeee41d\r\n```\r\n\r\n6. Update descriptor on the wallet to reflect the range (up to 900000):\r\n```\r\n./bitcoin-cli -rpcwallet=test_1 importdescriptors '[{ \"desc\": \"wpkh(tprvXXX/84h/1h/0h/0/*)#slgn8chc\", \"timestamp\":\"now\", \"range\": [0,900000]}]'\r\n[\r\n  {\r\n    \"success\": true\r\n  }\r\n]\r\n```\r\n7. Now wait for the transaction you've sent earlier to confirm, check logs:\r\n```\r\n2022-08-21T16:55:15Z [default wallet] AddToWallet c7ca6d0a3c94085d393f973af4cf0bfc4e09e2885a5d0ef42af356ffcbeee41d  update\r\n2022-08-21T16:55:15Z [test_1] MarkUnusedAddresses: Detected a used keypool item at index 777777, mark all keypool items up to this item as used\r\n```\r\n\r\n8. After this bitcoind and wallet `test_1` will hang and no longer sync for hours doing something..\r\n9. E.g. doing any request to wallet like:\r\n```\r\n./bitcoin-cli -rpcwallet=test_1 getwalletinfo\r\n```\r\n\r\nwill be hanging forever until the timeout occurs.\r\n\r\n**System information**\r\nUbuntu 18.04.6 LTS\r\n<!-- What version of Bitcoin Core are you using, where did you get it (website, self-compiled, etc)? -->\r\nself-compiled v23.0 using internal depends\r\n\r\n<!-- What type of machine are you observing the error on (OS/CPU and disk type)? -->\r\nWallet is on the NVME, while bitcoind blockchain data is on HDDs, plenty of memory about 16GB and 24 CPUs (AMD Ryzen 9 3900 12-Core Processor)\r\n\r\n<!-- GUI-related issue? What is your operating system and its version? If Linux, what is your desktop environment and graphical shell? -->\r\n\r\n<!-- Any extra information that might be useful in the debugging process. -->\r\n<!--- This is normally the contents of a `debug.log` or `config.log` file. Raw text or a link to a pastebin type site are preferred. -->\r\n\r\n**bitcoin.conf**:\r\n\r\n```\r\nrpcuser=bitcoin_testnet_rpc\r\nrpcpassword=password\r\nrpcbind=127.0.0.1\r\nrpcallowip=127.0.0.1\r\n\r\nwalletrbf=1\r\ntxindex=1\r\n\r\nsettxfee=0.0006\r\npaytxfee=0.0006\r\n\r\ndbcache=512\r\nwalletnotify=/home/bitcoin/.bitcoin/cryptonotify.sh %s %w\r\ntestnet=1\r\n\r\n[test]\r\nrpcworkqueue=128\r\ntxindex=1\r\nrpcbind=127.0.0.1\r\nrpcallowip=127.0.0.1\r\n\r\n# default wallet\r\nwallet=\r\n```\r\n\r\n\r\n**debug.log:**\r\n\r\n```\r\n2022-08-21T16:45:01Z Using SQLite Version 3.32.1\r\n2022-08-21T16:45:01Z Using wallet /home/bitcoin/.bitcoin/testnet3/test_1\r\n2022-08-21T16:45:01Z init message: Loading walletâ¦\r\n2022-08-21T16:45:01Z [test_1] Setting spkMan to active: id = xxx, type = 0, internal = 0\r\n2022-08-21T16:45:01Z [test_1] Setting spkMan to active: id = xxx, type = 1, internal = 0\r\n2022-08-21T16:45:01Z [test_1] Setting spkMan to active: id = xxx, type = 2, internal = 0\r\n2022-08-21T16:45:01Z [test_1] Setting spkMan to active: id = xxx, type = 3, internal = 0\r\n2022-08-21T16:45:01Z [test_1] Setting spkMan to active: id = xxx, type = 0, internal = 1\r\n2022-08-21T16:45:01Z [test_1] Setting spkMan to active: id = xxx, type = 1, internal = 1\r\n2022-08-21T16:45:01Z [test_1] Setting spkMan to active: id = xxx, type = 2, internal = 1\r\n2022-08-21T16:45:01Z [test_1] Setting spkMan to active: id = xxx, type = 3, internal = 1\r\n2022-08-21T16:45:01Z [test_1] Wallet File Version = 169900\r\n2022-08-21T16:45:01Z [test_1] Keys: 8 plaintext, 0 encrypted, 0 w/ metadata, 8 total. Unknown wallet records: 0\r\n2022-08-21T16:45:01Z [test_1] Wallet completed loading in             397ms\r\n2022-08-21T16:45:01Z [test_1] setKeyPool.size() = 8000\r\n2022-08-21T16:45:01Z [test_1] mapWallet.size() = 0\r\n2022-08-21T16:45:01Z [test_1] m_address_book.size() = 0\r\n2022-08-21T16:49:52Z [test_1] Update existing descriptor: wpkh(tpubXXX/84'/1'/0'/0/*)#qfxctt9d\r\n2022-08-21T16:50:29Z [test_1] Deactivate spkMan: id = xxx, type = 2, internal = 0\r\n2022-08-21T16:50:29Z [test_1] RescanFromTime: Rescanning last 23 blocks\r\n2022-08-21T16:50:29Z [test_1] Rescan started from block 000000000000000cda1c49b7202b4714498675d4017d4b49e00f6d13926f3e7a...\r\n2022-08-21T16:50:29Z [test_1] Rescan completed in               2ms\r\n2022-08-21T16:55:15Z UpdateTip: new best=00000000a24fd66fed58a7f821f74af68541b303bae8e26642499b4f5ff9cc35 height=2343214 version=0x20000000 log2_work=74.879888 tx=63453651 date='2022-08-21T16:55:11Z' progress=1.000000 cache=0.1MiB(612txo)\r\n2022-08-21T16:55:15Z [default wallet] AddToWallet c7ca6d0a3c94085d393f973af4cf0bfc4e09e2885a5d0ef42af356ffcbeee41d  update\r\n2022-08-21T16:55:15Z [test_1] MarkUnusedAddresses: Detected a used keypool item at index 777777, mark all keypool items up to this item as used\r\n```",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 1,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25895/comments",
   "created_at" : "2022-08-21T17:05:59Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25895/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/25895",
   "id" : 1345542346,
   "labels" : [
      {
         "color" : "FBBAAB",
         "default" : false,
         "description" : null,
         "id" : 64585,
         "name" : "Bug",
         "node_id" : "MDU6TGFiZWw2NDU4NQ==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Bug"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25895/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "I_kwDOABII585QM1jK",
   "number" : 25895,
   "performed_via_github_app" : null,
   "reactions" : {
      "+1" : 0,
      "-1" : 0,
      "confused" : 0,
      "eyes" : 0,
      "heart" : 0,
      "hooray" : 0,
      "laugh" : 0,
      "rocket" : 0,
      "total_count" : 0,
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25895/reactions"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "state_reason" : null,
   "timeline_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25895/timeline",
   "title" : "importdescriptors hanging on importing/updating descriptor with large range",
   "updated_at" : "2022-08-21T17:13:21Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25895",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/104405?v=4",
      "events_url" : "https://api.github.com/users/gituser/events{/privacy}",
      "followers_url" : "https://api.github.com/users/gituser/followers",
      "following_url" : "https://api.github.com/users/gituser/following{/other_user}",
      "gists_url" : "https://api.github.com/users/gituser/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/gituser",
      "id" : 104405,
      "login" : "gituser",
      "node_id" : "MDQ6VXNlcjEwNDQwNQ==",
      "organizations_url" : "https://api.github.com/users/gituser/orgs",
      "received_events_url" : "https://api.github.com/users/gituser/received_events",
      "repos_url" : "https://api.github.com/users/gituser/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/gituser/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/gituser/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/gituser"
   }
}
