{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "CONTRIBUTOR",
   "body" : "This PR attempts to close (or at least help) #26455 (and closed duplicates #26400 #26530).\r\n\r\n### Context\r\n\r\nmacOS's `fsync` only flushes writes to the drive, but doesn't ask the drive to *immediately* commit the data to permanent storage (ie - physically write it) ([manpage](https://developer.apple.com/library/archive/documentation/System/Conceptual/ManPages_iPhoneOS/man2/fsync.2.html)). The data will eventually be physically written, but there are no guarantees when it will happen -- it could be several seconds or more. For a stronger 'immediate-write' guarantee, they offer an `F_FULLFSYNC` option to `fcntl` ([manpage](https://developer.apple.com/library/archive/documentation/System/Conceptual/ManPages_iPhoneOS/man2/fcntl.2.html#//apple_ref/doc/man/2/fcntl:~:text=current%20file%20offset.-,F_FULLFSYNC,-Does%20the%20same)) to accomplish that. This `fsync`-on-macOS behavior has caused [historical problems](https://github.com/bitcoin/bitcoin/issues/2770#issuecomment-22686426) in this project for macOS builds, so, since then, the `F_FULLSYNC` approach has been used for writing (see #3000).\r\n\r\nHowever, certain external drives or filesystems do not support `fcntl` with `F_FULLFSYNC` option. (And some that *do* supposedly support the option do not actually do it.) These drives/filesystems will typically report `errno` `ENOTSUP` or `ENOTTY`, which is what was reported in the referenced issues. [However, there is no reliable way to determine lack of support](https://github.com/google/leveldb/commit/296de8d5b8e4e57bd1e46c981114dfbe58a8c4fa), so **relying on specific error codes is insufficient**.\r\n\r\nThis bug seems to only be affecting macOS 13 (Ventura) systems, but in theory, any macOS version could be affected.\r\n\r\n### What other projects have done\r\n\r\nOther projects, including [LevelDB](https://github.com/google/leveldb/commit/296de8d5b8e4e57bd1e46c981114dfbe58a8c4fa), [SQLite](https://sqlite.org/src/file?name=src/os_unix.c&ci=5c669f5f399fe899#:~:text=If%20the%20FULLFSYNC%20failed%2C%20fall%20back%20to%20attempting%20an%20fsync()), and [MariaDB](https://github.com/MariaDB/server/commit/746fd9fdacc52ccc297db7703ea9288b67138167) have experienced similar issues, and have taken the strategy of falling back on the (less reliable) `fsync` when `F_FULLFSYNC` isn't supported. (See helpful [Twitter thread](https://twitter.com/TigerBeetleDB/status/1422855270716293123).) Some (SQLite, MariaDB, LevelDB) fall back to `fsync` on *any* error, and others only fall back on specific errors (BerkeleyDB 4.8 [falls back only on `ENOTSUP`](https://github.com/observerdev/db-4.8.30/blob/3c75267f11336acb1be06bed419e8056cc689d09/os/os_fsync.c#L81-L88), which is why this PR may not fully fix #26455, as the wallet is getting the error `ENOTTY`.)\r\n\r\n### This PR\r\n\r\nI propose to follow that general strategy and fall back on `fsync` if `F_FULLFSYNC` fails for any reason, while preserving both error codes for debugging. \r\n\r\n(I think we should also print the error strings using `SysErrorString` rather than print the raw platform-dependent error codes, but I wanted to keep this PR as atomic as possible and save those changes (4 or 5 lines in addition to these) for another PR (which I'd be happy to submit -- or modify this PR to include).)",
   "closed_at" : "2022-11-29T23:56:59Z",
   "closed_by" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/116917595?v=4",
      "events_url" : "https://api.github.com/users/john-moffett/events{/privacy}",
      "followers_url" : "https://api.github.com/users/john-moffett/followers",
      "following_url" : "https://api.github.com/users/john-moffett/following{/other_user}",
      "gists_url" : "https://api.github.com/users/john-moffett/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/john-moffett",
      "id" : 116917595,
      "login" : "john-moffett",
      "node_id" : "U_kgDOBvgFWw",
      "organizations_url" : "https://api.github.com/users/john-moffett/orgs",
      "received_events_url" : "https://api.github.com/users/john-moffett/received_events",
      "repos_url" : "https://api.github.com/users/john-moffett/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/john-moffett/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/john-moffett/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/john-moffett"
   },
   "comments" : 12,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26534/comments",
   "created_at" : "2022-11-19T17:10:54Z",
   "draft" : false,
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26534/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/26534",
   "id" : 1456582981,
   "labels" : [],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26534/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "PR_kwDOABII585DSWG9",
   "number" : 26534,
   "performed_via_github_app" : null,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/26534.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26534",
      "merged_at" : null,
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/26534.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26534"
   },
   "reactions" : {
      "+1" : 0,
      "-1" : 0,
      "confused" : 0,
      "eyes" : 0,
      "heart" : 0,
      "hooray" : 0,
      "laugh" : 0,
      "rocket" : 0,
      "total_count" : 0,
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26534/reactions"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "state_reason" : null,
   "timeline_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26534/timeline",
   "title" : "Fix macOS failing to flush blockfiles to disk for certain external drives",
   "updated_at" : "2022-11-29T23:56:59Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26534",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/116917595?v=4",
      "events_url" : "https://api.github.com/users/john-moffett/events{/privacy}",
      "followers_url" : "https://api.github.com/users/john-moffett/followers",
      "following_url" : "https://api.github.com/users/john-moffett/following{/other_user}",
      "gists_url" : "https://api.github.com/users/john-moffett/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/john-moffett",
      "id" : 116917595,
      "login" : "john-moffett",
      "node_id" : "U_kgDOBvgFWw",
      "organizations_url" : "https://api.github.com/users/john-moffett/orgs",
      "received_events_url" : "https://api.github.com/users/john-moffett/received_events",
      "repos_url" : "https://api.github.com/users/john-moffett/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/john-moffett/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/john-moffett/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/john-moffett"
   }
}
