[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [MarcoFalke](https://github.com/bitcoin/bitcoin/pull/26569#pullrequestreview-1201490437), [jnewbery](https://github.com/bitcoin/bitcoin/pull/26569#pullrequestreview-1202557215) |\n| Concept ACK | [naumenkogs](https://github.com/bitcoin/bitcoin/pull/26569#issuecomment-1330257975), [1440000bytes](https://github.com/bitcoin/bitcoin/pull/26569#issuecomment-1332786402) |\n| Stale ACK | [mzumsande](https://github.com/bitcoin/bitcoin/pull/26569#pullrequestreview-1197873110), [luke-jr](https://github.com/bitcoin/bitcoin/pull/26569#pullrequestreview-1198494418), [glozow](https://github.com/bitcoin/bitcoin/pull/26569#pullrequestreview-1199411984) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#24125](https://github.com/bitcoin/bitcoin/pull/24125) (p2p: Replace RecursiveMutex `m_tx_inventory_mutex` with Mutex and rename it by w0xlt)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2022-11-24T19:42:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26569#issuecomment-1326798103",
      "id" : 1326798103,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26569",
      "node_id" : "IC_kwDOABII585PFVUX",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1326798103/reactions"
      },
      "updated_at" : "2022-12-02T14:15:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1326798103",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1031808079"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1031808079"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n        if (!peer) return;\r\n```\r\n\r\nnit: The function return type is `void`",
      "commit_id" : "4dc67b2a82cc71fc8b11247bd0f3028a6cae5494",
      "created_at" : "2022-11-24T20:29:47Z",
      "diff_hunk" : "@@ -2005,18 +2005,29 @@ void PeerManagerImpl::SendPings()\n \n void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid)\n {\n-    LOCK(m_peer_mutex);\n-    for(auto& it : m_peer_map) {\n-        Peer& peer = *it.second;\n-        auto tx_relay = peer.GetTxRelay();\n-        if (!tx_relay) continue;\n+    m_connman.ForEachNode([this, &wtxid, &txid](CNode* node) {\n+        PeerRef peer{this->GetPeerRef(node->GetId())};\n+        if (!peer) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1031808079",
      "id" : 1031808079,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5849gCRP",
      "original_commit_id" : "8ea1f7dac3a0f40e1c6e5956e99b1fcad469c884",
      "original_line" : 2010,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1193587318,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1031808079/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-24T20:40:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1031808079",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1031813976"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1031813976"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Most of this code in the test can be removed:\r\n\r\n\r\n```diff\r\ndiff --git a/test/functional/p2p_tx_privacy.py b/test/functional/p2p_tx_privacy.py\r\nindex 7944095abc..d7139f5ab7 100755\r\n--- a/test/functional/p2p_tx_privacy.py\r\n+++ b/test/functional/p2p_tx_privacy.py\r\n@@ -17,54 +17,29 @@ from test_framework.p2p import (\r\n     p2p_lock,\r\n )\r\n from test_framework.test_framework import BitcoinTestFramework\r\n+from test_framework.wallet import MiniWallet\r\n \r\n class P2PTxSpy(P2PInterface):\r\n-    def __init__(self, wtxidrelay=True):\r\n-        super().__init__(wtxidrelay=wtxidrelay)\r\n-\r\n     def on_version(self, message):\r\n         # Avoid sending verack in response to version.\r\n         # When calling add_p2p_connection, wait_for_verack=False must be set (see\r\n         # comment in add_p2p_connection).\r\n-        if message.nVersion >= 70016 and self.wtxidrelay:\r\n-            self.send_message(msg_wtxidrelay())\r\n+        self.send_message(msg_wtxidrelay())\r\n \r\n class TxPrivacyTest(BitcoinTestFramework):\r\n     def set_test_params(self):\r\n-        self.setup_clean_chain = True\r\n         self.num_nodes = 1\r\n \r\n     def run_test(self):\r\n-        self.generate(self.nodes[0], 200)\r\n+        self.wallet = MiniWallet(self.nodes[0])\r\n+        self.wallet.rescan_utxos()\r\n \r\n         tx_originator = self.nodes[0].add_p2p_connection(P2PInterface())\r\n-        spy = self.nodes[0].add_p2p_connection(P2PTxSpy(), send_version=False, wait_for_verack=False)\r\n-\r\n-        # Spy sends version message to enable tx relay but doesn't send a verack\r\n-        txrelay_version_msg = msg_version()\r\n-        txrelay_version_msg.nVersion = P2P_VERSION\r\n-        txrelay_version_msg.strSubVer = \"ððð\"\r\n-        txrelay_version_msg.nServices = P2P_SERVICES\r\n-        txrelay_version_msg.relay = 1\r\n-        spy.send_message(txrelay_version_msg)\r\n+        spy = self.nodes[0].add_p2p_connection(P2PTxSpy(), wait_for_verack=False)\r\n         spy.wait_for_verack()\r\n \r\n         # Create a tx to send\r\n-        prevtx = self.nodes[0].getblock(self.nodes[0].getblockhash(5), 2)['tx'][0]\r\n-        rawtx = self.nodes[0].createrawtransaction(\r\n-            inputs=[{'txid': prevtx['txid'], 'vout': 0}],\r\n-            outputs=[{self.nodes[0].get_deterministic_priv_key().address: 50 - 0.00125}],\r\n-        )\r\n-        sigtx = self.nodes[0].signrawtransactionwithkey(\r\n-            hexstring=rawtx,\r\n-            privkeys=[self.nodes[0].get_deterministic_priv_key().key],\r\n-            prevtxs=[{\r\n-                'txid': prevtx['txid'],\r\n-                'vout': 0,\r\n-                'scriptPubKey': prevtx['vout'][0]['scriptPubKey']['hex'],\r\n-            }],\r\n-        )['hex']\r\n-        tx = tx_from_hex(sigtx)\r\n+        tx = self.wallet.create_self_transfer()[\"tx\"]\r\n \r\n         # tx_originator sends a tx\r\n         tx_originator.send_and_ping(msg_tx(tx))\r\n",
      "commit_id" : "4dc67b2a82cc71fc8b11247bd0f3028a6cae5494",
      "created_at" : "2022-11-24T20:40:47Z",
      "diff_hunk" : "@@ -0,0 +1,81 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+from test_framework.messages import (\n+    msg_version,\n+    msg_wtxidrelay,\n+    msg_verack,\n+    msg_tx,\n+    tx_from_hex,\n+)\n+from test_framework.p2p import (\n+    P2PInterface,\n+    P2P_VERSION,\n+    P2P_SERVICES,\n+    p2p_lock,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+\n+class P2PTxSpy(P2PInterface):\n+    def __init__(self, wtxidrelay=True):\n+        super().__init__(wtxidrelay=wtxidrelay)\n+\n+    def on_version(self, message):\n+        # Avoid sending verack in response to version.\n+        # When calling add_p2p_connection, wait_for_verack=False must be set (see\n+        # comment in add_p2p_connection).\n+        if message.nVersion >= 70016 and self.wtxidrelay:\n+            self.send_message(msg_wtxidrelay())\n+\n+class TxPrivacyTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+\n+    def run_test(self):\n+        self.generate(self.nodes[0], 200)\n+\n+        tx_originator = self.nodes[0].add_p2p_connection(P2PInterface())\n+        spy = self.nodes[0].add_p2p_connection(P2PTxSpy(), send_version=False, wait_for_verack=False)\n+\n+        # Spy sends version message to enable tx relay but doesn't send a verack\n+        txrelay_version_msg = msg_version()\n+        txrelay_version_msg.nVersion = P2P_VERSION\n+        txrelay_version_msg.strSubVer = \"ððð\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1031813976",
      "id" : 1031813976,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5849gDtY",
      "original_commit_id" : "c51d8b9dfcc77f0e18f60641d6ca49e59c959052",
      "original_line" : 46,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "test/functional/p2p_tx_privacy.py",
      "position" : null,
      "pull_request_review_id" : 1193587318,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1031813976/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-24T20:40:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1031813976",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1031818013"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1031818013"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Amazing! Done.",
      "commit_id" : "4dc67b2a82cc71fc8b11247bd0f3028a6cae5494",
      "created_at" : "2022-11-24T20:52:58Z",
      "diff_hunk" : "@@ -0,0 +1,81 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+from test_framework.messages import (\n+    msg_version,\n+    msg_wtxidrelay,\n+    msg_verack,\n+    msg_tx,\n+    tx_from_hex,\n+)\n+from test_framework.p2p import (\n+    P2PInterface,\n+    P2P_VERSION,\n+    P2P_SERVICES,\n+    p2p_lock,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+\n+class P2PTxSpy(P2PInterface):\n+    def __init__(self, wtxidrelay=True):\n+        super().__init__(wtxidrelay=wtxidrelay)\n+\n+    def on_version(self, message):\n+        # Avoid sending verack in response to version.\n+        # When calling add_p2p_connection, wait_for_verack=False must be set (see\n+        # comment in add_p2p_connection).\n+        if message.nVersion >= 70016 and self.wtxidrelay:\n+            self.send_message(msg_wtxidrelay())\n+\n+class TxPrivacyTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+\n+    def run_test(self):\n+        self.generate(self.nodes[0], 200)\n+\n+        tx_originator = self.nodes[0].add_p2p_connection(P2PInterface())\n+        spy = self.nodes[0].add_p2p_connection(P2PTxSpy(), send_version=False, wait_for_verack=False)\n+\n+        # Spy sends version message to enable tx relay but doesn't send a verack\n+        txrelay_version_msg = msg_version()\n+        txrelay_version_msg.nVersion = P2P_VERSION\n+        txrelay_version_msg.strSubVer = \"ððð\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1031818013",
      "id" : 1031818013,
      "in_reply_to_id" : 1031813976,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5849gEsd",
      "original_commit_id" : "c51d8b9dfcc77f0e18f60641d6ca49e59c959052",
      "original_line" : 46,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "test/functional/p2p_tx_privacy.py",
      "position" : null,
      "pull_request_review_id" : 1193599345,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1031818013/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-24T20:52:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1031818013",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.\r\n\r\nDid you consider setting `m_next_inv_send_time` to a time point in the future inside `SetTxRelay()`? That seems like a simpler change, and avoids adding a new instance of `ForEachNode()` which we'd like to get rid off eventually.",
      "created_at" : "2022-11-24T20:58:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26569#issuecomment-1326830686",
      "id" : 1326830686,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26569",
      "node_id" : "IC_kwDOABII585PFdRe",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1326830686/reactions"
      },
      "updated_at" : "2022-11-24T20:58:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1326830686",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@jnewbery Really good question! I should have put my reasoning for this in the PR description. \r\n\r\n> Did you consider setting m_next_inv_send_time to a time point in the future inside SetTxRelay()? That seems like a simpler change, and avoids adding a new instance of ForEachNode() which we'd like to get rid off eventually.\r\n\r\nThis actually was my initial approach, however I ended up going with `ForEachNode` for a couple reasons:\r\n\r\n* If we initialize `m_next_inv_send_time` to a time point in the future then we will still announce transactions that were received during the handshake which seems fine from a privacy perspective given the random delay. However,\r\n  *  I could see how that leads to a followup bug in which the spy is able to tell which of the announced transactions were received during the handshake (e.g. see point below). We can eliminate the possibility entirely by going with the `ForEachNode` approach.\r\n  * A node can't know if a peer enables wtxid relay until the handshake completes and it might add txids to `m_tx_inventory_to_send` but announce them as `MSG_WTX` after the handshake. (Didn't test but i think) This again leaks which transactions were received between the spy sending `version` and `wtxidrelay`.\r\n* Storing the txids pre-handshake completion feels a bit weird from a resource consumption perspective. We rely on the 60 second p2p timeout (`-peertimeout`) to clear `m_tx_inventory_to_send` for peers that do not complete the handshake. Again not really an issue now but this doesn't feel robust w.r.t. to future changes to me.",
      "created_at" : "2022-11-25T12:55:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26569#issuecomment-1327440366",
      "id" : 1327440366,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26569",
      "node_id" : "IC_kwDOABII585PHyHu",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1327440366/reactions"
      },
      "updated_at" : "2022-11-25T12:55:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1327440366",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1033467933"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033467933"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Wouldn't it be better to make this a one-line patch?\r\n\r\n`m_next_inv_send_time` will remain `0` for at least as long as the `fSuccessfullyConnected` is false. So an alternative fix would be to check `m_next_inv_send_time==0` in this line.\r\n\r\nThis should behave the same, because `SendMessages` is run after `fSuccessfullyConnected = true` without processing transactions from different peers in-between.",
      "commit_id" : "4dc67b2a82cc71fc8b11247bd0f3028a6cae5494",
      "created_at" : "2022-11-28T12:13:00Z",
      "diff_hunk" : "@@ -2005,18 +2005,27 @@ void PeerManagerImpl::SendPings()\n \n void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid)\n {\n-    LOCK(m_peer_mutex);\n-    for(auto& it : m_peer_map) {\n-        Peer& peer = *it.second;\n-        auto tx_relay = peer.GetTxRelay();\n-        if (!tx_relay) continue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1033467933",
      "id" : 1033467933,
      "line" : 2012,
      "node_id" : "PRRC_kwDOABII5849mXgd",
      "original_commit_id" : "4dc67b2a82cc71fc8b11247bd0f3028a6cae5494",
      "original_line" : 2012,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 8,
      "pull_request_review_id" : 1195700572,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033467933/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-28T12:13:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033467933",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1033579139"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033579139"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Hm I kinda prefer the current patch. `m_next_inv_send_time` is not meant to be used as a \"successfully connected check\" so i prefer not to use it in that way here.",
      "commit_id" : "4dc67b2a82cc71fc8b11247bd0f3028a6cae5494",
      "created_at" : "2022-11-28T14:02:02Z",
      "diff_hunk" : "@@ -2005,18 +2005,27 @@ void PeerManagerImpl::SendPings()\n \n void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid)\n {\n-    LOCK(m_peer_mutex);\n-    for(auto& it : m_peer_map) {\n-        Peer& peer = *it.second;\n-        auto tx_relay = peer.GetTxRelay();\n-        if (!tx_relay) continue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1033579139",
      "id" : 1033579139,
      "in_reply_to_id" : 1033467933,
      "line" : 2012,
      "node_id" : "PRRC_kwDOABII5849myqD",
      "original_commit_id" : "4dc67b2a82cc71fc8b11247bd0f3028a6cae5494",
      "original_line" : 2012,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 8,
      "pull_request_review_id" : 1195866488,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033579139/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-28T14:02:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033579139",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1033722873"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033722873"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I agree with Marco that it'd be better to use state in the `Peer` object rather than reaching into the net layer. It feels like that'd make it easier to unit test net procesing (using #25515).\r\n\r\nUsing the special value `m_next_inv_send_time == 0` to mean \"we're not queueing up an inv message for this peer so don't save hashes to send\" seems ok to me as long as it's commented. Alternatively, it'd be easy enough to add a bool to `TxRelay` to gate the logic for saving hashes.",
      "commit_id" : "959cc24fcd19270d7d851dfde572c4d5848f2579",
      "created_at" : "2022-11-28T15:56:09Z",
      "diff_hunk" : "@@ -2005,18 +2005,27 @@ void PeerManagerImpl::SendPings()\n \n void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid)\n {\n-    LOCK(m_peer_mutex);\n-    for(auto& it : m_peer_map) {\n-        Peer& peer = *it.second;\n-        auto tx_relay = peer.GetTxRelay();\n-        if (!tx_relay) continue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1033722873",
      "id" : 1033722873,
      "in_reply_to_id" : 1033467933,
      "line" : 2012,
      "node_id" : "PRRC_kwDOABII5849nVv5",
      "original_commit_id" : "4dc67b2a82cc71fc8b11247bd0f3028a6cae5494",
      "original_line" : 2012,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 11,
      "pull_request_review_id" : 1196071005,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033722873/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-28T15:56:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033722873",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1033788367"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033788367"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Alright, amended the patch (`m_next_inv_send_time` is now guarded by `m_tx_inventory_mutex`).\r\n\r\n> Alternatively, it'd be easy enough to add a bool to TxRelay to gate the logic for saving hashes.\r\n\r\nYes but it is a little annoying because some of our tests manually set `CNode::fSuccessfullyConnected` and then the new flag on peer would be out of sync. We should be able to move `fSuccessfullyConnected` to Peer entirely though which would be nice since its an application level thing anyway (will do in a separate PR).",
      "commit_id" : "959cc24fcd19270d7d851dfde572c4d5848f2579",
      "created_at" : "2022-11-28T16:47:28Z",
      "diff_hunk" : "@@ -2005,18 +2005,27 @@ void PeerManagerImpl::SendPings()\n \n void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid)\n {\n-    LOCK(m_peer_mutex);\n-    for(auto& it : m_peer_map) {\n-        Peer& peer = *it.second;\n-        auto tx_relay = peer.GetTxRelay();\n-        if (!tx_relay) continue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1033788367",
      "id" : 1033788367,
      "in_reply_to_id" : 1033467933,
      "line" : 2012,
      "node_id" : "PRRC_kwDOABII5849nlvP",
      "original_commit_id" : "4dc67b2a82cc71fc8b11247bd0f3028a6cae5494",
      "original_line" : 2012,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 11,
      "pull_request_review_id" : 1196167169,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033788367/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-28T16:47:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1033788367",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1034320112"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034320112"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "What is the reason for including this `pop`? If bitcoind ever sent an inv to a peer before receiving a verack, shouldn't this test rather fail than silently remove it?",
      "commit_id" : "959cc24fcd19270d7d851dfde572c4d5848f2579",
      "created_at" : "2022-11-29T05:40:17Z",
      "diff_hunk" : "@@ -0,0 +1,47 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+from test_framework.messages import (\n+    msg_wtxidrelay,\n+    msg_verack,\n+    msg_tx,\n+)\n+from test_framework.p2p import (\n+    P2PInterface,\n+    p2p_lock,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.wallet import MiniWallet\n+\n+class P2PTxSpy(P2PInterface):\n+    def on_version(self, message):\n+        self.send_message(msg_wtxidrelay())\n+\n+class TxPrivacyTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+\n+    def run_test(self):\n+        self.wallet = MiniWallet(self.nodes[0])\n+        self.wallet.rescan_utxos()\n+\n+        tx_originator = self.nodes[0].add_p2p_connection(P2PInterface())\n+        spy = self.nodes[0].add_p2p_connection(P2PTxSpy(), wait_for_verack=False)\n+        spy.wait_for_verack()\n+\n+        # tx_originator sends a tx\n+        tx = self.wallet.create_self_transfer()[\"tx\"]\n+        tx_originator.send_and_ping(msg_tx(tx))\n+\n+        with p2p_lock:\n+            spy.last_message.pop(\"inv\", None)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1034320112",
      "id" : 1034320112,
      "line" : 39,
      "node_id" : "PRRC_kwDOABII5849pnjw",
      "original_commit_id" : "959cc24fcd19270d7d851dfde572c4d5848f2579",
      "original_line" : 39,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "test/functional/p2p_tx_privacy.py",
      "position" : 39,
      "pull_request_review_id" : 1196916776,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034320112/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-29T05:49:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034320112",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1034411436"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034411436"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n        if (auto tx_relay = peer->GetTxRelay()) {\r\n```\r\n\r\nnit?",
      "commit_id" : "959cc24fcd19270d7d851dfde572c4d5848f2579",
      "created_at" : "2022-11-29T08:02:24Z",
      "diff_hunk" : "@@ -3428,6 +3433,18 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             }\n         }\n \n+        if (auto tx_relay = peer->GetTxRelay(); tx_relay) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1034411436",
      "id" : 1034411436,
      "line" : 3436,
      "node_id" : "PRRC_kwDOABII5849p92s",
      "original_commit_id" : "959cc24fcd19270d7d851dfde572c4d5848f2579",
      "original_line" : 3436,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 28,
      "pull_request_review_id" : 1197046948,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034411436/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-29T08:02:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034411436",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1034422873"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034422873"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I can't fully grasp the exact risk here... How does it help the spy to learn something new, as opposed to listening/analyzing *after* the handshake?",
      "commit_id" : "959cc24fcd19270d7d851dfde572c4d5848f2579",
      "created_at" : "2022-11-29T08:15:17Z",
      "diff_hunk" : "@@ -2011,8 +2011,13 @@ void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid\n         auto tx_relay = peer.GetTxRelay();\n         if (!tx_relay) continue;\n \n-        const uint256& hash{peer.m_wtxid_relay ? wtxid : txid};\n         LOCK(tx_relay->m_tx_inventory_mutex);\n+        // Only queue transactions for announcement once the version handshake\n+        // is completed. The time of arrival for these transactions is\n+        // otherwise at risk of leaking to a spy.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1034422873",
      "id" : 1034422873,
      "line" : 2017,
      "node_id" : "PRRC_kwDOABII5849qApZ",
      "original_commit_id" : "07c67c47714c8374843f79ab87391056b934e5a8",
      "original_line" : 2017,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 17,
      "pull_request_review_id" : 1197063218,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034422873/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-29T08:15:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034422873",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1034425832"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034425832"
         }
      },
      "author_association" : "MEMBER",
      "body" : "There is no delay, so they can poll all announcements in real time by just creating a new incoming connection in a loop",
      "commit_id" : "959cc24fcd19270d7d851dfde572c4d5848f2579",
      "created_at" : "2022-11-29T08:18:34Z",
      "diff_hunk" : "@@ -2011,8 +2011,13 @@ void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid\n         auto tx_relay = peer.GetTxRelay();\n         if (!tx_relay) continue;\n \n-        const uint256& hash{peer.m_wtxid_relay ? wtxid : txid};\n         LOCK(tx_relay->m_tx_inventory_mutex);\n+        // Only queue transactions for announcement once the version handshake\n+        // is completed. The time of arrival for these transactions is\n+        // otherwise at risk of leaking to a spy.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1034425832",
      "id" : 1034425832,
      "in_reply_to_id" : 1034422873,
      "line" : 2017,
      "node_id" : "PRRC_kwDOABII5849qBXo",
      "original_commit_id" : "07c67c47714c8374843f79ab87391056b934e5a8",
      "original_line" : 2017,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 17,
      "pull_request_review_id" : 1197067568,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034425832/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-29T08:18:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034425832",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1034427654"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034427654"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yeah, the comment from the following commit also helped :) Feel free to resolve this. This is a great finding.\r\n\r\nI can only suggest explaining it here, and not in the following comment, because IMO the justification belongs where the transactions are added.",
      "commit_id" : "959cc24fcd19270d7d851dfde572c4d5848f2579",
      "created_at" : "2022-11-29T08:20:35Z",
      "diff_hunk" : "@@ -2011,8 +2011,13 @@ void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid\n         auto tx_relay = peer.GetTxRelay();\n         if (!tx_relay) continue;\n \n-        const uint256& hash{peer.m_wtxid_relay ? wtxid : txid};\n         LOCK(tx_relay->m_tx_inventory_mutex);\n+        // Only queue transactions for announcement once the version handshake\n+        // is completed. The time of arrival for these transactions is\n+        // otherwise at risk of leaking to a spy.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1034427654",
      "id" : 1034427654,
      "in_reply_to_id" : 1034422873,
      "line" : 2017,
      "node_id" : "PRRC_kwDOABII5849qB0G",
      "original_commit_id" : "07c67c47714c8374843f79ab87391056b934e5a8",
      "original_line" : 2017,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 17,
      "pull_request_review_id" : 1197070298,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034427654/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-29T08:20:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034427654",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.\r\n\r\nLooking forward to resolving the comments :)",
      "created_at" : "2022-11-29T08:25:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26569#issuecomment-1330257975",
      "id" : 1330257975,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26569",
      "node_id" : "IC_kwDOABII585PSiA3",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1330257975/reactions"
      },
      "updated_at" : "2022-11-29T08:25:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1330257975",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1034799697"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034799697"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Improved the comment in this location a little bit.",
      "commit_id" : "1220dfaf7c64f2eebe7c8061634d1f3fd2100a61",
      "created_at" : "2022-11-29T14:08:12Z",
      "diff_hunk" : "@@ -2011,8 +2011,13 @@ void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid\n         auto tx_relay = peer.GetTxRelay();\n         if (!tx_relay) continue;\n \n-        const uint256& hash{peer.m_wtxid_relay ? wtxid : txid};\n         LOCK(tx_relay->m_tx_inventory_mutex);\n+        // Only queue transactions for announcement once the version handshake\n+        // is completed. The time of arrival for these transactions is\n+        // otherwise at risk of leaking to a spy.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1034799697",
      "id" : 1034799697,
      "in_reply_to_id" : 1034422873,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5849rcpR",
      "original_commit_id" : "07c67c47714c8374843f79ab87391056b934e5a8",
      "original_line" : 2017,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1197625407,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034799697/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-29T14:08:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034799697",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1034799785"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034799785"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "1220dfaf7c64f2eebe7c8061634d1f3fd2100a61",
      "created_at" : "2022-11-29T14:08:18Z",
      "diff_hunk" : "@@ -3428,6 +3433,18 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             }\n         }\n \n+        if (auto tx_relay = peer->GetTxRelay(); tx_relay) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1034799785",
      "id" : 1034799785,
      "in_reply_to_id" : 1034411436,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5849rcqp",
      "original_commit_id" : "959cc24fcd19270d7d851dfde572c4d5848f2579",
      "original_line" : 3438,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1197625562,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034799785/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-29T14:08:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034799785",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1034800632"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034800632"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No reason, removed it. Thanks!",
      "commit_id" : "1220dfaf7c64f2eebe7c8061634d1f3fd2100a61",
      "created_at" : "2022-11-29T14:09:02Z",
      "diff_hunk" : "@@ -0,0 +1,47 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+from test_framework.messages import (\n+    msg_wtxidrelay,\n+    msg_verack,\n+    msg_tx,\n+)\n+from test_framework.p2p import (\n+    P2PInterface,\n+    p2p_lock,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.wallet import MiniWallet\n+\n+class P2PTxSpy(P2PInterface):\n+    def on_version(self, message):\n+        self.send_message(msg_wtxidrelay())\n+\n+class TxPrivacyTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+\n+    def run_test(self):\n+        self.wallet = MiniWallet(self.nodes[0])\n+        self.wallet.rescan_utxos()\n+\n+        tx_originator = self.nodes[0].add_p2p_connection(P2PInterface())\n+        spy = self.nodes[0].add_p2p_connection(P2PTxSpy(), wait_for_verack=False)\n+        spy.wait_for_verack()\n+\n+        # tx_originator sends a tx\n+        tx = self.wallet.create_self_transfer()[\"tx\"]\n+        tx_originator.send_and_ping(msg_tx(tx))\n+\n+        with p2p_lock:\n+            spy.last_message.pop(\"inv\", None)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1034800632",
      "id" : 1034800632,
      "in_reply_to_id" : 1034320112,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5849rc34",
      "original_commit_id" : "959cc24fcd19270d7d851dfde572c4d5848f2579",
      "original_line" : 39,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "test/functional/p2p_tx_privacy.py",
      "position" : null,
      "pull_request_review_id" : 1197626913,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034800632/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-29T14:09:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1034800632",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1035112523"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1035112523"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Perhaps add a module-level docstring to describe what the test is testing, and how it is testing it. (https://github.com/bitcoin/bitcoin/blob/master/test/functional/README.md#style-guidelines)",
      "commit_id" : "fbcd991f8c9fe6ecdac181b09f04756cab99f47d",
      "created_at" : "2022-11-29T18:20:34Z",
      "diff_hunk" : "@@ -0,0 +1,44 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1035112523",
      "id" : 1035112523,
      "line" : 4,
      "node_id" : "PRRC_kwDOABII5849spBL",
      "original_commit_id" : "152a42a3344b473c838b94f2ec07b25d6739bd2d",
      "original_line" : 4,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/p2p_tx_privacy.py",
      "position" : 4,
      "pull_request_review_id" : 1198118917,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1035112523/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-29T18:22:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1035112523",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1035114953"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1035114953"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Perhaps send a second tx from `tx_originator` to the node _after_ the version handshake with spy is complete, and then asset that the node announces the second tx, but not the first.",
      "commit_id" : "fbcd991f8c9fe6ecdac181b09f04756cab99f47d",
      "created_at" : "2022-11-29T18:22:21Z",
      "diff_hunk" : "@@ -0,0 +1,44 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+from test_framework.messages import (\n+    msg_wtxidrelay,\n+    msg_verack,\n+    msg_tx,\n+)\n+from test_framework.p2p import (\n+    P2PInterface,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.wallet import MiniWallet\n+\n+class P2PTxSpy(P2PInterface):\n+    def on_version(self, message):\n+        self.send_message(msg_wtxidrelay())\n+\n+class TxPrivacyTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+\n+    def run_test(self):\n+        self.wallet = MiniWallet(self.nodes[0])\n+        self.wallet.rescan_utxos()\n+\n+        tx_originator = self.nodes[0].add_p2p_connection(P2PInterface())\n+        spy = self.nodes[0].add_p2p_connection(P2PTxSpy(), wait_for_verack=False)\n+        spy.wait_for_verack()\n+\n+        # tx_originator sends a tx\n+        tx = self.wallet.create_self_transfer()[\"tx\"]\n+        tx_originator.send_and_ping(msg_tx(tx))\n+\n+        # Spy sends the verack\n+        spy.send_and_ping(msg_verack())\n+\n+        # Spy should not get an inv for the tx\n+        assert 'inv' not in spy.last_message",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1035114953",
      "id" : 1035114953,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5849spnJ",
      "original_commit_id" : "152a42a3344b473c838b94f2ec07b25d6739bd2d",
      "original_line" : 41,
      "original_position" : 41,
      "original_start_line" : 40,
      "path" : "test/functional/p2p_tx_privacy.py",
      "position" : null,
      "pull_request_review_id" : 1198118917,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1035114953/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-11-29T18:22:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1035114953",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1036028179"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036028179"
         }
      },
      "author_association" : "MEMBER",
      "body" : "in 845e3a34c49abcc634b5a10ccdd6b10fb4fcf449, noting to myself that this change is because `m_next_inv_send_time` can now be accessed from the scheduler thread in `ReattemptInitialBroadcast`.",
      "commit_id" : "fbcd991f8c9fe6ecdac181b09f04756cab99f47d",
      "created_at" : "2022-11-30T14:19:23Z",
      "diff_hunk" : "@@ -295,7 +295,7 @@ struct Peer {\n         std::atomic<std::chrono::seconds> m_last_mempool_req{0s};\n         /** The next time after which we will send an `inv` message containing\n          *  transaction announcements to this peer. */\n-        std::chrono::microseconds m_next_inv_send_time GUARDED_BY(NetEventsInterface::g_msgproc_mutex){0};\n+        std::chrono::microseconds m_next_inv_send_time GUARDED_BY(m_tx_inventory_mutex){0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1036028179",
      "id" : 1036028179,
      "line" : 298,
      "node_id" : "PRRC_kwDOABII5849wIkT",
      "original_commit_id" : "845e3a34c49abcc634b5a10ccdd6b10fb4fcf449",
      "original_line" : 298,
      "original_position" : 5,
      "original_start_line" : 298,
      "path" : "src/net_processing.cpp",
      "position" : 5,
      "pull_request_review_id" : 1199411984,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036028179/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 298,
      "start_side" : "LEFT",
      "updated_at" : "2022-11-30T14:20:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036028179",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1036073276"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036073276"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The test doesn't test anything. It passes on master as-is. I think you can just revert to the earlier commit where it was working?",
      "commit_id" : "fbcd991f8c9fe6ecdac181b09f04756cab99f47d",
      "created_at" : "2022-11-30T14:54:33Z",
      "diff_hunk" : "@@ -0,0 +1,69 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"\n+Test that transaction announcements are only queued for peers that have\n+successfully completed the version handshake.\n+\n+Topology:\n+\n+  tx_originator ----> node[0] <---- spy\n+\n+We test that a transaction send by tx_originator is only relayed to spy\n+if it was received after spy's version handshake completed.\n+\n+1. Fully connect tx_originator\n+2. Connect spy (no version handshake)\n+3. tx_originator sends tx1\n+4. spy completes the version handshake\n+5. tx_originator sends tx2\n+6. We wait for an inv message on the spy interface and assert that only tx2 is\n+   announced.\n+\"\"\"\n+from test_framework.messages import (\n+    msg_wtxidrelay,\n+    msg_verack,\n+    msg_tx,\n+    CInv,\n+    MSG_WTX,\n+)\n+from test_framework.p2p import (\n+    P2PInterface,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.wallet import MiniWallet\n+\n+class P2PTxSpy(P2PInterface):\n+    def on_version(self, message):\n+        self.send_message(msg_wtxidrelay())\n+\n+class TxPrivacyTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+\n+    def run_test(self):\n+        self.wallet = MiniWallet(self.nodes[0])\n+        self.wallet.rescan_utxos()\n+\n+        tx_originator = self.nodes[0].add_p2p_connection(P2PInterface())\n+        spy = self.nodes[0].add_p2p_connection(P2PTxSpy(), wait_for_verack=False)\n+        spy.wait_for_verack()\n+\n+        # tx_originator sends tx1\n+        tx1 = self.wallet.create_self_transfer()[\"tx\"]\n+        tx_originator.send_and_ping(msg_tx(tx1))\n+\n+        # Spy sends the verack\n+        spy.send_and_ping(msg_verack())\n+\n+        # tx_originator sends tx2\n+        tx2 = self.wallet.create_self_transfer()[\"tx\"]\n+        tx_originator.send_message(msg_tx(tx2))\n+\n+        # Spy should only get an inv for the second transaction as the first\n+        # one was received pre-verack with the spy\n+        spy.wait_for_inv([CInv(MSG_WTX, tx2.calc_sha256(True))])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1036073276",
      "id" : 1036073276,
      "line" : 66,
      "node_id" : "PRRC_kwDOABII5849wTk8",
      "original_commit_id" : "fbcd991f8c9fe6ecdac181b09f04756cab99f47d",
      "original_line" : 66,
      "original_position" : 66,
      "original_start_line" : null,
      "path" : "test/functional/p2p_tx_privacy.py",
      "position" : 66,
      "pull_request_review_id" : 1199478235,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036073276/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-30T14:54:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036073276",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1036198008"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036198008"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think you could add an `on_inv` method to the spy connection that saves the announced hash, and then assert at the end that you haven't received an annoucement for tx1. ",
      "commit_id" : "8f2dac54096c20afd8fd12c21a2ee5465fea085e",
      "created_at" : "2022-11-30T16:34:57Z",
      "diff_hunk" : "@@ -0,0 +1,69 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"\n+Test that transaction announcements are only queued for peers that have\n+successfully completed the version handshake.\n+\n+Topology:\n+\n+  tx_originator ----> node[0] <---- spy\n+\n+We test that a transaction send by tx_originator is only relayed to spy\n+if it was received after spy's version handshake completed.\n+\n+1. Fully connect tx_originator\n+2. Connect spy (no version handshake)\n+3. tx_originator sends tx1\n+4. spy completes the version handshake\n+5. tx_originator sends tx2\n+6. We wait for an inv message on the spy interface and assert that only tx2 is\n+   announced.\n+\"\"\"\n+from test_framework.messages import (\n+    msg_wtxidrelay,\n+    msg_verack,\n+    msg_tx,\n+    CInv,\n+    MSG_WTX,\n+)\n+from test_framework.p2p import (\n+    P2PInterface,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.wallet import MiniWallet\n+\n+class P2PTxSpy(P2PInterface):\n+    def on_version(self, message):\n+        self.send_message(msg_wtxidrelay())\n+\n+class TxPrivacyTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+\n+    def run_test(self):\n+        self.wallet = MiniWallet(self.nodes[0])\n+        self.wallet.rescan_utxos()\n+\n+        tx_originator = self.nodes[0].add_p2p_connection(P2PInterface())\n+        spy = self.nodes[0].add_p2p_connection(P2PTxSpy(), wait_for_verack=False)\n+        spy.wait_for_verack()\n+\n+        # tx_originator sends tx1\n+        tx1 = self.wallet.create_self_transfer()[\"tx\"]\n+        tx_originator.send_and_ping(msg_tx(tx1))\n+\n+        # Spy sends the verack\n+        spy.send_and_ping(msg_verack())\n+\n+        # tx_originator sends tx2\n+        tx2 = self.wallet.create_self_transfer()[\"tx\"]\n+        tx_originator.send_message(msg_tx(tx2))\n+\n+        # Spy should only get an inv for the second transaction as the first\n+        # one was received pre-verack with the spy\n+        spy.wait_for_inv([CInv(MSG_WTX, tx2.calc_sha256(True))])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1036198008",
      "id" : 1036198008,
      "in_reply_to_id" : 1036073276,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5849wyB4",
      "original_commit_id" : "fbcd991f8c9fe6ecdac181b09f04756cab99f47d",
      "original_line" : 66,
      "original_position" : 66,
      "original_start_line" : null,
      "path" : "test/functional/p2p_tx_privacy.py",
      "position" : null,
      "pull_request_review_id" : 1199662441,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036198008/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-30T16:34:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036198008",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1036208076"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036208076"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Did pretty much what John suggested. It's now using on_inv to collect all announced invs and in the end it checks that there is only one announcement for tx2.",
      "commit_id" : "8f2dac54096c20afd8fd12c21a2ee5465fea085e",
      "created_at" : "2022-11-30T16:43:34Z",
      "diff_hunk" : "@@ -0,0 +1,69 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"\n+Test that transaction announcements are only queued for peers that have\n+successfully completed the version handshake.\n+\n+Topology:\n+\n+  tx_originator ----> node[0] <---- spy\n+\n+We test that a transaction send by tx_originator is only relayed to spy\n+if it was received after spy's version handshake completed.\n+\n+1. Fully connect tx_originator\n+2. Connect spy (no version handshake)\n+3. tx_originator sends tx1\n+4. spy completes the version handshake\n+5. tx_originator sends tx2\n+6. We wait for an inv message on the spy interface and assert that only tx2 is\n+   announced.\n+\"\"\"\n+from test_framework.messages import (\n+    msg_wtxidrelay,\n+    msg_verack,\n+    msg_tx,\n+    CInv,\n+    MSG_WTX,\n+)\n+from test_framework.p2p import (\n+    P2PInterface,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.wallet import MiniWallet\n+\n+class P2PTxSpy(P2PInterface):\n+    def on_version(self, message):\n+        self.send_message(msg_wtxidrelay())\n+\n+class TxPrivacyTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+\n+    def run_test(self):\n+        self.wallet = MiniWallet(self.nodes[0])\n+        self.wallet.rescan_utxos()\n+\n+        tx_originator = self.nodes[0].add_p2p_connection(P2PInterface())\n+        spy = self.nodes[0].add_p2p_connection(P2PTxSpy(), wait_for_verack=False)\n+        spy.wait_for_verack()\n+\n+        # tx_originator sends tx1\n+        tx1 = self.wallet.create_self_transfer()[\"tx\"]\n+        tx_originator.send_and_ping(msg_tx(tx1))\n+\n+        # Spy sends the verack\n+        spy.send_and_ping(msg_verack())\n+\n+        # tx_originator sends tx2\n+        tx2 = self.wallet.create_self_transfer()[\"tx\"]\n+        tx_originator.send_message(msg_tx(tx2))\n+\n+        # Spy should only get an inv for the second transaction as the first\n+        # one was received pre-verack with the spy\n+        spy.wait_for_inv([CInv(MSG_WTX, tx2.calc_sha256(True))])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1036208076",
      "id" : 1036208076,
      "in_reply_to_id" : 1036073276,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5849w0fM",
      "original_commit_id" : "fbcd991f8c9fe6ecdac181b09f04756cab99f47d",
      "original_line" : 66,
      "original_position" : 66,
      "original_start_line" : null,
      "path" : "test/functional/p2p_tx_privacy.py",
      "position" : null,
      "pull_request_review_id" : 1199676521,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 1,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036208076/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-30T16:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1036208076",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK ",
      "created_at" : "2022-11-30T22:00:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26569#issuecomment-1332786402",
      "id" : 1332786402,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26569",
      "node_id" : "IC_kwDOABII585PcLTi",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1332786402/reactions"
      },
      "updated_at" : "2022-11-30T22:00:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1332786402",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/94559964?v=4",
         "events_url" : "https://api.github.com/users/1440000bytes/events{/privacy}",
         "followers_url" : "https://api.github.com/users/1440000bytes/followers",
         "following_url" : "https://api.github.com/users/1440000bytes/following{/other_user}",
         "gists_url" : "https://api.github.com/users/1440000bytes/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/1440000bytes",
         "id" : 94559964,
         "login" : "1440000bytes",
         "node_id" : "U_kgDOBaLe3A",
         "organizations_url" : "https://api.github.com/users/1440000bytes/orgs",
         "received_events_url" : "https://api.github.com/users/1440000bytes/received_events",
         "repos_url" : "https://api.github.com/users/1440000bytes/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/1440000bytes/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/1440000bytes/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/1440000bytes"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1038181466"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038181466"
         }
      },
      "author_association" : "MEMBER",
      "body" : "(not in this PR) it might be nice to set explicitly set `m_next_inv_send_time` to a future time here. It's slightly odd that we go through the transaction sending logic on the first pass through `SendMessages()` even though `m_tx_inventory_to_send` will be empty.",
      "commit_id" : "8f2dac54096c20afd8fd12c21a2ee5465fea085e",
      "created_at" : "2022-12-02T14:11:09Z",
      "diff_hunk" : "@@ -3428,6 +3435,20 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             }\n         }\n \n+        if (auto tx_relay = peer->GetTxRelay()) {\n+            // `TxRelay::m_tx_inventory_to_send` must be empty before the\n+            // version handshake is completed as\n+            // `TxRelay::m_next_inv_send_time` is first initialised in\n+            // `SendMessages` after the verack is received. Any transactions\n+            // received during the version handshake would otherwise\n+            // immediately be advertised without random delay, potentially\n+            // leaking the time of arrival to a spy.\n+            Assume(WITH_LOCK(\n+                tx_relay->m_tx_inventory_mutex,\n+                return tx_relay->m_tx_inventory_to_send.empty() &&\n+                       tx_relay->m_next_inv_send_time == 0s));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26569#discussion_r1038181466",
      "id" : 1038181466,
      "line" : 3449,
      "node_id" : "PRRC_kwDOABII58494WRa",
      "original_commit_id" : "8f2dac54096c20afd8fd12c21a2ee5465fea085e",
      "original_line" : 3449,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 41,
      "pull_request_review_id" : 1202557215,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26569",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038181466/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-02T14:15:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1038181466",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Added this for backport in #26616.",
      "created_at" : "2022-12-02T16:08:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26569#issuecomment-1335477808",
      "id" : 1335477808,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26569",
      "node_id" : "IC_kwDOABII585PmcYw",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1335477808/reactions"
      },
      "updated_at" : "2022-12-02T16:08:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1335477808",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Love that it was merged in less than 10 days, improves bitcoin and reviewed by more than 6 devs :)",
      "created_at" : "2022-12-03T00:10:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26569#issuecomment-1335977977",
      "id" : 1335977977,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26569",
      "node_id" : "IC_kwDOABII585PoWf5",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1335977977/reactions"
      },
      "updated_at" : "2022-12-03T00:10:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1335977977",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/94559964?v=4",
         "events_url" : "https://api.github.com/users/1440000bytes/events{/privacy}",
         "followers_url" : "https://api.github.com/users/1440000bytes/followers",
         "following_url" : "https://api.github.com/users/1440000bytes/following{/other_user}",
         "gists_url" : "https://api.github.com/users/1440000bytes/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/1440000bytes",
         "id" : 94559964,
         "login" : "1440000bytes",
         "node_id" : "U_kgDOBaLe3A",
         "organizations_url" : "https://api.github.com/users/1440000bytes/orgs",
         "received_events_url" : "https://api.github.com/users/1440000bytes/received_events",
         "repos_url" : "https://api.github.com/users/1440000bytes/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/1440000bytes/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/1440000bytes/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/1440000bytes"
      }
   }
]
