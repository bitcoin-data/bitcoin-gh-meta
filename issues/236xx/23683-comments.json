[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "cc @MarcoFalke, thanks for catching my bug :bug:",
      "created_at" : "2021-12-06T11:27:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#issuecomment-986688016",
      "id" : 986688016,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23683",
      "node_id" : "IC_kwDOABII5846z6oQ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/986688016/reactions"
      },
      "updated_at" : "2021-12-06T11:27:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/986688016",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r762930383"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762930383"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: Why is this needed? The `self.sync_all()` in the next line should take care of that already. I think it should be fine to remove either this line or the next.",
      "commit_id" : "bd716bf774d21956ec7ae616d06a2a896568ed18",
      "created_at" : "2021-12-06T11:39:47Z",
      "diff_hunk" : "@@ -106,8 +106,45 @@ def run_test(self):\n \n         self.log.info(\"Check that the mempool is empty\")\n         assert_equal(set(self.nodes[0].getrawmempool()), set())\n+        assert_equal(set(self.nodes[1].getrawmempool()), set())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r762930383",
      "id" : 762930383,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584teWTP",
      "original_commit_id" : "48d1b46f3ee27a909ed06cd020c5e6c33a63feeb",
      "original_line" : 109,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/mempool_reorg.py",
      "position" : null,
      "pull_request_review_id" : 823847626,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762930383/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-06T11:43:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762930383",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r762930557"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762930557"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: Why is this needed? Are they not connected already?",
      "commit_id" : "bd716bf774d21956ec7ae616d06a2a896568ed18",
      "created_at" : "2021-12-06T11:40:05Z",
      "diff_hunk" : "@@ -106,8 +106,45 @@ def run_test(self):\n \n         self.log.info(\"Check that the mempool is empty\")\n         assert_equal(set(self.nodes[0].getrawmempool()), set())\n+        assert_equal(set(self.nodes[1].getrawmempool()), set())\n         self.sync_all()\n \n \n+        self.log.info(\"Simulate natural reorg\")\n+        self.connect_nodes(0, 1)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r762930557",
      "id" : 762930557,
      "line" : 112,
      "node_id" : "PRRC_kwDOABII584teWV9",
      "original_commit_id" : "48d1b46f3ee27a909ed06cd020c5e6c33a63feeb",
      "original_line" : 112,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "test/functional/mempool_reorg.py",
      "position" : 5,
      "pull_request_review_id" : 823847626,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762930557/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-06T11:43:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762930557",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r762931172"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762931172"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: Why are the asserts needed? The implicit `self.sync_all` in the next line should assert this already.",
      "commit_id" : "bd716bf774d21956ec7ae616d06a2a896568ed18",
      "created_at" : "2021-12-06T11:41:02Z",
      "diff_hunk" : "@@ -106,8 +106,45 @@ def run_test(self):\n \n         self.log.info(\"Check that the mempool is empty\")\n         assert_equal(set(self.nodes[0].getrawmempool()), set())\n+        assert_equal(set(self.nodes[1].getrawmempool()), set())\n         self.sync_all()\n \n \n+        self.log.info(\"Simulate natural reorg\")\n+        self.connect_nodes(0, 1)\n+        assert_equal(self.nodes[0].getblockcount(), self.nodes[1].getblockcount())\n+        assert_equal(set(self.nodes[0].getrawmempool()), set(self.nodes[0].getrawmempool()))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r762931172",
      "id" : 762931172,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584teWfk",
      "original_commit_id" : "48d1b46f3ee27a909ed06cd020c5e6c33a63feeb",
      "original_line" : 116,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "test/functional/mempool_reorg.py",
      "position" : null,
      "pull_request_review_id" : 823847626,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762931172/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-06T11:43:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762931172",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r762931588"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762931588"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: Why is this needed? The wallet will pick a utxo by itself.",
      "commit_id" : "bd716bf774d21956ec7ae616d06a2a896568ed18",
      "created_at" : "2021-12-06T11:41:37Z",
      "diff_hunk" : "@@ -106,8 +106,45 @@ def run_test(self):\n \n         self.log.info(\"Check that the mempool is empty\")\n         assert_equal(set(self.nodes[0].getrawmempool()), set())\n+        assert_equal(set(self.nodes[1].getrawmempool()), set())\n         self.sync_all()\n \n \n+        self.log.info(\"Simulate natural reorg\")\n+        self.connect_nodes(0, 1)\n+        assert_equal(self.nodes[0].getblockcount(), self.nodes[1].getblockcount())\n+        assert_equal(set(self.nodes[0].getrawmempool()), set(self.nodes[0].getrawmempool()))\n+        self.generate(self.nodes[0], 3)\n+        # Create another transaction which is time-locked to two blocks in the future\n+        utxo = wallet.get_utxo()\n+        timelock_tx_2 = wallet.create_self_transfer(\n+            from_node=self.nodes[0],\n+            utxo_to_spend=utxo,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r762931588",
      "id" : 762931588,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584teWmE",
      "original_commit_id" : "48d1b46f3ee27a909ed06cd020c5e6c33a63feeb",
      "original_line" : 122,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "test/functional/mempool_reorg.py",
      "position" : null,
      "pull_request_review_id" : 823847626,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762931588/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-06T11:43:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762931588",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r762931929"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762931929"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: Why is this needed? You can use `self.no_op`",
      "commit_id" : "bd716bf774d21956ec7ae616d06a2a896568ed18",
      "created_at" : "2021-12-06T11:42:08Z",
      "diff_hunk" : "@@ -106,8 +106,45 @@ def run_test(self):\n \n         self.log.info(\"Check that the mempool is empty\")\n         assert_equal(set(self.nodes[0].getrawmempool()), set())\n+        assert_equal(set(self.nodes[1].getrawmempool()), set())\n         self.sync_all()\n \n \n+        self.log.info(\"Simulate natural reorg\")\n+        self.connect_nodes(0, 1)\n+        assert_equal(self.nodes[0].getblockcount(), self.nodes[1].getblockcount())\n+        assert_equal(set(self.nodes[0].getrawmempool()), set(self.nodes[0].getrawmempool()))\n+        self.generate(self.nodes[0], 3)\n+        # Create another transaction which is time-locked to two blocks in the future\n+        utxo = wallet.get_utxo()\n+        timelock_tx_2 = wallet.create_self_transfer(\n+            from_node=self.nodes[0],\n+            utxo_to_spend=utxo,\n+            mempool_valid=False,\n+            locktime=self.nodes[0].getblockcount() + 2\n+        )['hex']\n+        # Check that the time-locked transaction is too immature to spend\n+        assert_raises_rpc_error(-26, \"non-final\", self.nodes[0].sendrawtransaction, timelock_tx_2)\n+        assert_raises_rpc_error(-26, \"non-final\", self.nodes[1].sendrawtransaction, timelock_tx_2)\n+\n+        self.log.info(\"Disconnect nodes and mine separate forks\")\n+        self.disconnect_nodes(0, 1)\n+        # Don't try to sync nodes because they are disconnected\n+        no_sync_func = lambda: True",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r762931929",
      "id" : 762931929,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584teWrZ",
      "original_commit_id" : "48d1b46f3ee27a909ed06cd020c5e6c33a63feeb",
      "original_line" : 133,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "test/functional/mempool_reorg.py",
      "position" : null,
      "pull_request_review_id" : 823847626,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762931929/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-06T11:43:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762931929",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r762965682"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762965682"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "They don't stay in sync if I don't call `connect_nodes` here... it also doesn't work if I call `connect_nodes(1, 0)` instead. So my guess is that this creation of a manual connection from node0 to node1 adds a permission that we need.",
      "commit_id" : "bd716bf774d21956ec7ae616d06a2a896568ed18",
      "created_at" : "2021-12-06T12:32:45Z",
      "diff_hunk" : "@@ -106,8 +106,45 @@ def run_test(self):\n \n         self.log.info(\"Check that the mempool is empty\")\n         assert_equal(set(self.nodes[0].getrawmempool()), set())\n+        assert_equal(set(self.nodes[1].getrawmempool()), set())\n         self.sync_all()\n \n \n+        self.log.info(\"Simulate natural reorg\")\n+        self.connect_nodes(0, 1)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r762965682",
      "id" : 762965682,
      "in_reply_to_id" : 762930557,
      "line" : 112,
      "node_id" : "PRRC_kwDOABII584tee6y",
      "original_commit_id" : "48d1b46f3ee27a909ed06cd020c5e6c33a63feeb",
      "original_line" : 112,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "test/functional/mempool_reorg.py",
      "position" : 5,
      "pull_request_review_id" : 823895457,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762965682/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-06T12:32:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762965682",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r762965737"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762965737"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "removed",
      "commit_id" : "bd716bf774d21956ec7ae616d06a2a896568ed18",
      "created_at" : "2021-12-06T12:32:50Z",
      "diff_hunk" : "@@ -106,8 +106,45 @@ def run_test(self):\n \n         self.log.info(\"Check that the mempool is empty\")\n         assert_equal(set(self.nodes[0].getrawmempool()), set())\n+        assert_equal(set(self.nodes[1].getrawmempool()), set())\n         self.sync_all()\n \n \n+        self.log.info(\"Simulate natural reorg\")\n+        self.connect_nodes(0, 1)\n+        assert_equal(self.nodes[0].getblockcount(), self.nodes[1].getblockcount())\n+        assert_equal(set(self.nodes[0].getrawmempool()), set(self.nodes[0].getrawmempool()))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r762965737",
      "id" : 762965737,
      "in_reply_to_id" : 762931172,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584tee7p",
      "original_commit_id" : "48d1b46f3ee27a909ed06cd020c5e6c33a63feeb",
      "original_line" : 116,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "test/functional/mempool_reorg.py",
      "position" : null,
      "pull_request_review_id" : 823895535,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762965737/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-06T12:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762965737",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r762965821"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762965821"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "removed",
      "commit_id" : "bd716bf774d21956ec7ae616d06a2a896568ed18",
      "created_at" : "2021-12-06T12:32:57Z",
      "diff_hunk" : "@@ -106,8 +106,45 @@ def run_test(self):\n \n         self.log.info(\"Check that the mempool is empty\")\n         assert_equal(set(self.nodes[0].getrawmempool()), set())\n+        assert_equal(set(self.nodes[1].getrawmempool()), set())\n         self.sync_all()\n \n \n+        self.log.info(\"Simulate natural reorg\")\n+        self.connect_nodes(0, 1)\n+        assert_equal(self.nodes[0].getblockcount(), self.nodes[1].getblockcount())\n+        assert_equal(set(self.nodes[0].getrawmempool()), set(self.nodes[0].getrawmempool()))\n+        self.generate(self.nodes[0], 3)\n+        # Create another transaction which is time-locked to two blocks in the future\n+        utxo = wallet.get_utxo()\n+        timelock_tx_2 = wallet.create_self_transfer(\n+            from_node=self.nodes[0],\n+            utxo_to_spend=utxo,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r762965821",
      "id" : 762965821,
      "in_reply_to_id" : 762931588,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584tee89",
      "original_commit_id" : "48d1b46f3ee27a909ed06cd020c5e6c33a63feeb",
      "original_line" : 122,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "test/functional/mempool_reorg.py",
      "position" : null,
      "pull_request_review_id" : 823895638,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762965821/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-06T12:32:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762965821",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r762965966"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762965966"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "ahh, didn't know about that - fixed",
      "commit_id" : "bd716bf774d21956ec7ae616d06a2a896568ed18",
      "created_at" : "2021-12-06T12:33:11Z",
      "diff_hunk" : "@@ -106,8 +106,45 @@ def run_test(self):\n \n         self.log.info(\"Check that the mempool is empty\")\n         assert_equal(set(self.nodes[0].getrawmempool()), set())\n+        assert_equal(set(self.nodes[1].getrawmempool()), set())\n         self.sync_all()\n \n \n+        self.log.info(\"Simulate natural reorg\")\n+        self.connect_nodes(0, 1)\n+        assert_equal(self.nodes[0].getblockcount(), self.nodes[1].getblockcount())\n+        assert_equal(set(self.nodes[0].getrawmempool()), set(self.nodes[0].getrawmempool()))\n+        self.generate(self.nodes[0], 3)\n+        # Create another transaction which is time-locked to two blocks in the future\n+        utxo = wallet.get_utxo()\n+        timelock_tx_2 = wallet.create_self_transfer(\n+            from_node=self.nodes[0],\n+            utxo_to_spend=utxo,\n+            mempool_valid=False,\n+            locktime=self.nodes[0].getblockcount() + 2\n+        )['hex']\n+        # Check that the time-locked transaction is too immature to spend\n+        assert_raises_rpc_error(-26, \"non-final\", self.nodes[0].sendrawtransaction, timelock_tx_2)\n+        assert_raises_rpc_error(-26, \"non-final\", self.nodes[1].sendrawtransaction, timelock_tx_2)\n+\n+        self.log.info(\"Disconnect nodes and mine separate forks\")\n+        self.disconnect_nodes(0, 1)\n+        # Don't try to sync nodes because they are disconnected\n+        no_sync_func = lambda: True",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r762965966",
      "id" : 762965966,
      "in_reply_to_id" : 762931929,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584tee_O",
      "original_commit_id" : "48d1b46f3ee27a909ed06cd020c5e6c33a63feeb",
      "original_line" : 133,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "test/functional/mempool_reorg.py",
      "position" : null,
      "pull_request_review_id" : 823895859,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762965966/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-06T12:33:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762965966",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r762966229"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762966229"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "removed",
      "commit_id" : "bd716bf774d21956ec7ae616d06a2a896568ed18",
      "created_at" : "2021-12-06T12:33:28Z",
      "diff_hunk" : "@@ -106,8 +106,45 @@ def run_test(self):\n \n         self.log.info(\"Check that the mempool is empty\")\n         assert_equal(set(self.nodes[0].getrawmempool()), set())\n+        assert_equal(set(self.nodes[1].getrawmempool()), set())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r762966229",
      "id" : 762966229,
      "in_reply_to_id" : 762930383,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584tefDV",
      "original_commit_id" : "48d1b46f3ee27a909ed06cd020c5e6c33a63feeb",
      "original_line" : 109,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/mempool_reorg.py",
      "position" : null,
      "pull_request_review_id" : 823896117,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762966229/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-06T12:33:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762966229",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r763013572"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/763013572"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this comment can be removed. Mutable iterators in the mempool don't exist and the function name is self-explanatory.",
      "commit_id" : "bd716bf774d21956ec7ae616d06a2a896568ed18",
      "created_at" : "2021-12-06T13:38:44Z",
      "diff_hunk" : "@@ -312,6 +312,19 @@ class CompareTxMemPoolEntryByAncestorFee\n     }\n };\n \n+/**\n+ * Update LockPoints in a mempool entry for which the caller only has a const iterator to.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r763013572",
      "id" : 763013572,
      "line" : 316,
      "node_id" : "PRRC_kwDOABII584teqnE",
      "original_commit_id" : "034f13a14a180ee5c060879b686972230d748a22",
      "original_line" : 316,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : 5,
      "pull_request_review_id" : 823962604,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/763013572/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-06T14:56:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/763013572",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r763015410"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/763015410"
         }
      },
      "author_association" : "MEMBER",
      "body" : "in the second commit: Maybe mention that the bug was introduces in commit  bedf246 ?",
      "commit_id" : "bd716bf774d21956ec7ae616d06a2a896568ed18",
      "created_at" : "2021-12-06T13:41:05Z",
      "diff_hunk" : "@@ -378,6 +378,8 @@ void CChainState::MaybeUpdateMempoolForReorg(\n                 }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r763015410",
      "id" : 763015410,
      "line" : 378,
      "node_id" : "PRRC_kwDOABII584terDy",
      "original_commit_id" : "f1f3f19f84da6bc5a157d9bf2e5c0500f53ae614",
      "original_line" : 378,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 1,
      "pull_request_review_id" : 823962604,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/763015410/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-06T14:56:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/763015410",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r763037472"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/763037472"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: missing trailing `,`.",
      "commit_id" : "bd716bf774d21956ec7ae616d06a2a896568ed18",
      "created_at" : "2021-12-06T14:07:54Z",
      "diff_hunk" : "@@ -108,6 +108,37 @@ def run_test(self):\n         assert_equal(set(self.nodes[0].getrawmempool()), set())\n         self.sync_all()\n \n+        self.log.info(\"Simulate a natural reorg where mempool transaction stays valid but on a different block\")\n+        self.connect_nodes(0, 1)\n+        # Mine a block to create mature coinbase\n+        self.generate(self.nodes[0], 2)\n+        # Create another transaction which is time-locked to two blocks in the future\n+        timelock_tx_2 = wallet.create_self_transfer(\n+            from_node=self.nodes[0],\n+            mempool_valid=False,\n+            locktime=self.nodes[0].getblockcount() + 2",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r763037472",
      "id" : 763037472,
      "line" : 119,
      "node_id" : "PRRC_kwDOABII584tewcg",
      "original_commit_id" : "bd716bf774d21956ec7ae616d06a2a896568ed18",
      "original_line" : 119,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "test/functional/mempool_reorg.py",
      "position" : 12,
      "pull_request_review_id" : 823962604,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/763037472/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-06T14:56:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/763037472",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r763051867"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/763051867"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah ok, it is not possible to use compact blocks during IBD",
      "commit_id" : "bd716bf774d21956ec7ae616d06a2a896568ed18",
      "created_at" : "2021-12-06T14:24:09Z",
      "diff_hunk" : "@@ -106,8 +106,45 @@ def run_test(self):\n \n         self.log.info(\"Check that the mempool is empty\")\n         assert_equal(set(self.nodes[0].getrawmempool()), set())\n+        assert_equal(set(self.nodes[1].getrawmempool()), set())\n         self.sync_all()\n \n \n+        self.log.info(\"Simulate natural reorg\")\n+        self.connect_nodes(0, 1)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r763051867",
      "id" : 763051867,
      "in_reply_to_id" : 762930557,
      "line" : 112,
      "node_id" : "PRRC_kwDOABII584tez9b",
      "original_commit_id" : "48d1b46f3ee27a909ed06cd020c5e6c33a63feeb",
      "original_line" : 112,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "test/functional/mempool_reorg.py",
      "position" : 5,
      "pull_request_review_id" : 823962604,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/763051867/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-06T14:56:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/763051867",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r763115678"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/763115678"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "added",
      "commit_id" : "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "created_at" : "2021-12-06T15:32:13Z",
      "diff_hunk" : "@@ -378,6 +378,8 @@ void CChainState::MaybeUpdateMempoolForReorg(\n                 }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r763115678",
      "id" : 763115678,
      "in_reply_to_id" : 763015410,
      "line" : 378,
      "node_id" : "PRRC_kwDOABII584tfDie",
      "original_commit_id" : "f1f3f19f84da6bc5a157d9bf2e5c0500f53ae614",
      "original_line" : 378,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 1,
      "pull_request_review_id" : 824105584,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/763115678/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-06T15:32:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/763115678",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r763115781"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/763115781"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "added",
      "commit_id" : "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "created_at" : "2021-12-06T15:32:20Z",
      "diff_hunk" : "@@ -108,6 +108,37 @@ def run_test(self):\n         assert_equal(set(self.nodes[0].getrawmempool()), set())\n         self.sync_all()\n \n+        self.log.info(\"Simulate a natural reorg where mempool transaction stays valid but on a different block\")\n+        self.connect_nodes(0, 1)\n+        # Mine a block to create mature coinbase\n+        self.generate(self.nodes[0], 2)\n+        # Create another transaction which is time-locked to two blocks in the future\n+        timelock_tx_2 = wallet.create_self_transfer(\n+            from_node=self.nodes[0],\n+            mempool_valid=False,\n+            locktime=self.nodes[0].getblockcount() + 2",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r763115781",
      "id" : 763115781,
      "in_reply_to_id" : 763037472,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584tfDkF",
      "original_commit_id" : "bd716bf774d21956ec7ae616d06a2a896568ed18",
      "original_line" : 119,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "test/functional/mempool_reorg.py",
      "position" : null,
      "pull_request_review_id" : 824105729,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/763115781/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-06T15:32:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/763115781",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r763115892"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/763115892"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "removed",
      "commit_id" : "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "created_at" : "2021-12-06T15:32:25Z",
      "diff_hunk" : "@@ -312,6 +312,19 @@ class CompareTxMemPoolEntryByAncestorFee\n     }\n };\n \n+/**\n+ * Update LockPoints in a mempool entry for which the caller only has a const iterator to.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r763115892",
      "id" : 763115892,
      "in_reply_to_id" : 763013572,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584tfDl0",
      "original_commit_id" : "034f13a14a180ee5c060879b686972230d748a22",
      "original_line" : 316,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : null,
      "pull_request_review_id" : 824105858,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/763115892/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-06T15:32:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/763115892",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r763794040"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/763794040"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I was thinking \"what if we skip those transactions with `should_remove=true` here?\". I guess, we'll have the same original problem: they won't be cleared because we would mistakenly think they have valid `lp` in `removeForReorg`?\r\n\r\nPerhaps this deserves a comment extension, saying that txs to be removed must be updated here.",
      "commit_id" : "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "created_at" : "2021-12-07T09:21:39Z",
      "diff_hunk" : "@@ -378,6 +378,8 @@ void CChainState::MaybeUpdateMempoolForReorg(\n                 }\n             }\n         }\n+        // CheckSequenceLocks updates lp. Update the mempool entry LockPoints.\n+        if (!validLP) m_mempool->mapTx.modify(it, update_lock_points(lp));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r763794040",
      "id" : 763794040,
      "line" : 382,
      "node_id" : "PRRC_kwDOABII584thpJ4",
      "original_commit_id" : "b4adc5ad6769e4a5a6179dfff271cd4c9dc47a5b",
      "original_line" : 382,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 5,
      "pull_request_review_id" : 824999003,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/763794040/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-07T09:22:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/763794040",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r763810771"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/763810771"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "No, they'll still be cleared - `removeForReorg` just applies `check_final_and_mature` on all entries and removes them if it returns true, it doesn't check whether the `lp` is valid. I'm not 100% sure if we could skip the `should_remove=true` ones, but I think it would be fine. The `CheckSequenceLocks` function doesn't guarantee `lp` to be reliable if it returns false, and the function doesn't even get executed if `CheckFinalTx` returns false.",
      "commit_id" : "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "created_at" : "2021-12-07T09:41:07Z",
      "diff_hunk" : "@@ -378,6 +378,8 @@ void CChainState::MaybeUpdateMempoolForReorg(\n                 }\n             }\n         }\n+        // CheckSequenceLocks updates lp. Update the mempool entry LockPoints.\n+        if (!validLP) m_mempool->mapTx.modify(it, update_lock_points(lp));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r763810771",
      "id" : 763810771,
      "in_reply_to_id" : 763794040,
      "line" : 382,
      "node_id" : "PRRC_kwDOABII584thtPT",
      "original_commit_id" : "b4adc5ad6769e4a5a6179dfff271cd4c9dc47a5b",
      "original_line" : 382,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 5,
      "pull_request_review_id" : 825021997,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/763810771/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-07T09:41:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/763810771",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "utACK 28b60ce3122b29ffad2c60790d3bfe9a2ede2471\r\n\r\nThe bug is pretty scary, good thing we found it this soon, and the fix is straightforward.\r\nThe test looks correct.",
      "created_at" : "2021-12-07T09:53:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#issuecomment-987752880",
      "id" : 987752880,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23683",
      "node_id" : "IC_kwDOABII58463-mw",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/987752880/reactions"
      },
      "updated_at" : "2021-12-07T09:53:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/987752880",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r763836593"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/763836593"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I agree that it is safe to skip if the tx will be removed anyway. When this was introduced in commit 14d6324a248df50cb79fbeb5b60a978687a3b64e it updates unconditionally.",
      "commit_id" : "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "created_at" : "2021-12-07T10:09:13Z",
      "diff_hunk" : "@@ -378,6 +378,8 @@ void CChainState::MaybeUpdateMempoolForReorg(\n                 }\n             }\n         }\n+        // CheckSequenceLocks updates lp. Update the mempool entry LockPoints.\n+        if (!validLP) m_mempool->mapTx.modify(it, update_lock_points(lp));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r763836593",
      "id" : 763836593,
      "in_reply_to_id" : 763794040,
      "line" : 382,
      "node_id" : "PRRC_kwDOABII584thzix",
      "original_commit_id" : "b4adc5ad6769e4a5a6179dfff271cd4c9dc47a5b",
      "original_line" : 382,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 5,
      "pull_request_review_id" : 825058969,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/763836593/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-07T10:09:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/763836593",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Too bad this can't properly be tested on regtest. I guess the only way is via a pre-mined main-chain?\r\n\r\nAh no. I don't think this is possible to test at all. The lockpoints are just a cache and if it is outdated, evaluating it will always return false, in which case the lockpoints are re-evaluated. So this is not fixing a behaviour bug, but potentially improving performance a bit?",
      "created_at" : "2021-12-07T10:13:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#issuecomment-987771707",
      "id" : 987771707,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23683",
      "node_id" : "IC_kwDOABII58464DM7",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/987771707/reactions"
      },
      "updated_at" : "2021-12-07T10:13:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/987771707",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> > Too bad this can't properly be tested on regtest. I guess the only way is via a pre-mined main-chain?\r\n\r\n> Ah no. I don't think this is possible to test at all. The lockpoints are just a cache and if it is outdated, evaluating it will always return false, in which case the lockpoints are re-evaluated. So this is not fixing a behaviour bug, but potentially improving performance a bit?\r\n\r\nThe \"natural reorg to a new chain that is shorter (but has more work)\" is probably not possible without significant changes to regtest chainparams, I think. Since this PR adds assertions for the lockpoints, making sure they're updated is testable. And true, I suppose outdated lockpoints are not _that_ bad, though now I'm wondering if it's worth adding the assertions if it's relatively harmless.",
      "created_at" : "2021-12-07T11:18:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#issuecomment-987829408",
      "id" : 987829408,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23683",
      "node_id" : "IC_kwDOABII58464RSg",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/987829408/reactions"
      },
      "updated_at" : "2021-12-07T11:18:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/987829408",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Since this PR adds assertions for the lockpoints\r\n\r\nI was hoping there was a way to test this on current master without modifying the code or looking at the process internal memory, but yeah...",
      "created_at" : "2021-12-07T14:52:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#issuecomment-987998795",
      "id" : 987998795,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23683",
      "node_id" : "IC_kwDOABII584646pL",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/987998795/reactions"
      },
      "updated_at" : "2021-12-07T16:28:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/987998795",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r764162261"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764162261"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I was just about to post the same optimization suggestion: change this to `if (!validLP && !should_remove)`.\r\n\r\n> I guess, we'll have the same original problem: they won't be cleared because we would mistakenly think they have valid lp in removeForReorg\r\n\r\nI don't see it that way - the tx will be removed if this lambda `check_final_and_mature()` returns `true`, so why bother updating that tx data? (I see no reason).",
      "commit_id" : "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "created_at" : "2021-12-07T16:24:51Z",
      "diff_hunk" : "@@ -378,6 +378,8 @@ void CChainState::MaybeUpdateMempoolForReorg(\n                 }\n             }\n         }\n+        // CheckSequenceLocks updates lp. Update the mempool entry LockPoints.\n+        if (!validLP) m_mempool->mapTx.modify(it, update_lock_points(lp));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r764162261",
      "id" : 764162261,
      "in_reply_to_id" : 763794040,
      "line" : 382,
      "node_id" : "PRRC_kwDOABII584tjDDV",
      "original_commit_id" : "b4adc5ad6769e4a5a6179dfff271cd4c9dc47a5b",
      "original_line" : 382,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 5,
      "pull_request_review_id" : 825510685,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764162261/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-07T16:24:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764162261",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r764168506"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764168506"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Is it not better to add this assert as soon as the data is updated? That is, something like this:\r\n\r\n<details>\r\n<summary>patch</summary>\r\n\r\n```diff\r\ndiff --git i/src/txmempool.cpp w/src/txmempool.cpp\r\nindex 26cb2ff4b4..8149c6dcd7 100644\r\n--- i/src/txmempool.cpp\r\n+++ w/src/txmempool.cpp\r\n@@ -635,15 +635,12 @@ void CTxMemPool::removeForReorg(CChain& chain, std::function<bool(txiter)> check\r\n     }\r\n     setEntries setAllRemoves;\r\n     for (txiter it : txToRemove) {\r\n         CalculateDescendants(it, setAllRemoves);\r\n     }\r\n     RemoveStaged(setAllRemoves, false, MemPoolRemovalReason::REORG);\r\n-    for (indexed_transaction_set::const_iterator it = mapTx.begin(); it != mapTx.end(); it++) {\r\n-        assert(TestLockPointValidity(chain, it->GetLockPoints()));\r\n-    }\r\n }\r\n \r\n void CTxMemPool::removeConflicts(const CTransaction &tx)\r\n {\r\n     // Remove transactions which depend on inputs of tx, recursively\r\n     AssertLockHeld(cs);\r\ndiff --git i/src/validation.cpp w/src/validation.cpp\r\nindex 68729e4863..541b7be499 100644\r\n--- i/src/validation.cpp\r\n+++ w/src/validation.cpp\r\n@@ -377,12 +377,15 @@ void CChainState::MaybeUpdateMempoolForReorg(\r\n                     break;\r\n                 }\r\n             }\r\n         }\r\n         // CheckSequenceLocks updates lp. Update the mempool entry LockPoints.\r\n         if (!validLP) m_mempool->mapTx.modify(it, update_lock_points(lp));\r\n+        if (!should_remove) {\r\n+            assert(TestLockPointValidity(m_chain, it->GetLockPoints()));\r\n+        }\r\n         return should_remove;\r\n     };\r\n \r\n     // We also need to remove any now-immature transactions\r\n     m_mempool->removeForReorg(m_chain, check_final_and_mature);\r\n     // Re-limit mempool size, in case we added any transactions\r\n```\r\n</details>",
      "commit_id" : "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "created_at" : "2021-12-07T16:31:46Z",
      "diff_hunk" : "@@ -649,10 +639,7 @@ void CTxMemPool::removeForReorg(CChain& chain, std::function<bool(txiter)> check\n     }\n     RemoveStaged(setAllRemoves, false, MemPoolRemovalReason::REORG);\n     for (indexed_transaction_set::const_iterator it = mapTx.begin(); it != mapTx.end(); it++) {\n-        const LockPoints lp{it->GetLockPoints()};\n-        if (!TestLockPointValidity(chain, lp)) {\n-            mapTx.modify(it, update_lock_points(lp));\n-        }\n+        assert(TestLockPointValidity(chain, it->GetLockPoints()));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r764168506",
      "id" : 764168506,
      "line" : 642,
      "node_id" : "PRRC_kwDOABII584tjEk6",
      "original_commit_id" : "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "original_line" : 642,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 25,
      "pull_request_review_id" : 825519204,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764168506/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-07T16:39:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764168506",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r764171819"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764171819"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This test passes also if the fix is missing. Is this expected? If yes, then what is the point of the test? I think tests should fail if the bug resurfaces.\r\n\r\nOn top of this PR:\r\n* `git show b4adc5ad67 |git apply -R`\r\n* recompile\r\n* run `test/functional/mempool_reorg.py` - it passes",
      "commit_id" : "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "created_at" : "2021-12-07T16:35:30Z",
      "diff_hunk" : "@@ -108,6 +108,37 @@ def run_test(self):\n         assert_equal(set(self.nodes[0].getrawmempool()), set())\n         self.sync_all()\n \n+        self.log.info(\"Simulate a natural reorg where mempool transaction stays valid but on a different block\")\n+        self.connect_nodes(0, 1)\n+        # Mine a block to create mature coinbase",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r764171819",
      "id" : 764171819,
      "line" : 113,
      "node_id" : "PRRC_kwDOABII584tjFYr",
      "original_commit_id" : "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "original_line" : 113,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "test/functional/mempool_reorg.py",
      "position" : 6,
      "pull_request_review_id" : 825519204,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764171819/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-07T16:39:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764171819",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r764196876"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764196876"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think it is possible to test this without modifying the source code (e.g. addding an assert) or inspecting the process internal memory.",
      "commit_id" : "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "created_at" : "2021-12-07T17:04:43Z",
      "diff_hunk" : "@@ -108,6 +108,37 @@ def run_test(self):\n         assert_equal(set(self.nodes[0].getrawmempool()), set())\n         self.sync_all()\n \n+        self.log.info(\"Simulate a natural reorg where mempool transaction stays valid but on a different block\")\n+        self.connect_nodes(0, 1)\n+        # Mine a block to create mature coinbase",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r764196876",
      "id" : 764196876,
      "in_reply_to_id" : 764171819,
      "line" : 113,
      "node_id" : "PRRC_kwDOABII584tjLgM",
      "original_commit_id" : "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "original_line" : 113,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "test/functional/mempool_reorg.py",
      "position" : 6,
      "pull_request_review_id" : 825557043,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764196876/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-07T17:04:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764196876",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r764197601"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764197601"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Seems better to run it on all remaining txs unconditionally before returning as a sanity check.",
      "commit_id" : "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "created_at" : "2021-12-07T17:05:33Z",
      "diff_hunk" : "@@ -649,10 +639,7 @@ void CTxMemPool::removeForReorg(CChain& chain, std::function<bool(txiter)> check\n     }\n     RemoveStaged(setAllRemoves, false, MemPoolRemovalReason::REORG);\n     for (indexed_transaction_set::const_iterator it = mapTx.begin(); it != mapTx.end(); it++) {\n-        const LockPoints lp{it->GetLockPoints()};\n-        if (!TestLockPointValidity(chain, lp)) {\n-            mapTx.modify(it, update_lock_points(lp));\n-        }\n+        assert(TestLockPointValidity(chain, it->GetLockPoints()));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r764197601",
      "id" : 764197601,
      "in_reply_to_id" : 764168506,
      "line" : 642,
      "node_id" : "PRRC_kwDOABII584tjLrh",
      "original_commit_id" : "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "original_line" : 642,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 25,
      "pull_request_review_id" : 825557986,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764197601/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-07T17:05:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764197601",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK a64078e\r\n\r\n> Ah no. I don't think this is possible to test at all. The lockpoints are just a cache and if it is outdated, evaluating it will always return false, in which case the lockpoints are re-evaluated. So this is not fixing a behaviour bug, but potentially improving performance a bit?\r\n\r\nYes, I don't think this is a bug introducing invalid transactions in the mempool. Just a perf regression.\r\n\r\nIf you have a reorg from chain H to chain H'' and the lockpoints are not valid anymore on H'', the cache is not going be updated accordingly.\r\n\r\nLet's say you have one more reorg from chain H'' to chain H'''. If H''' includes the max `CBlockIndex` (tested in `TestLockPointValidity`), the lockpoints are _anew_ valid. If H''' does not include the max `CBlockIndex`, the lockpoints are going to be recomputed by `CheckSequenceLocks` to determine if the transaction is final.\r\n\r\nSo if this reasoning is correct, I also agree that caching lockpoints is a perf improvement, in the sense they save few coins fetches and block index walkes ?",
      "created_at" : "2021-12-08T02:09:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#issuecomment-988431074",
      "id" : 988431074,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23683",
      "node_id" : "IC_kwDOABII58466kLi",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/988431074/reactions"
      },
      "updated_at" : "2021-12-08T02:09:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/988431074",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r764641715"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764641715"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Sleeping over this, now I think that it is better to leave it as is - just `if (!validLP)` because skipping update for the to-be-removed transactions will spare some CPU cycles but will increase the coupling between `check_final_and_mature()` and `removeForReorg()` - the former will assume the later will remove the transactions and the later must be aware that some transactions have invalid lock points in case it decides to do something else before removal. Plus more complex code. Not worth it.",
      "commit_id" : "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "created_at" : "2021-12-08T08:26:39Z",
      "diff_hunk" : "@@ -378,6 +378,8 @@ void CChainState::MaybeUpdateMempoolForReorg(\n                 }\n             }\n         }\n+        // CheckSequenceLocks updates lp. Update the mempool entry LockPoints.\n+        if (!validLP) m_mempool->mapTx.modify(it, update_lock_points(lp));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r764641715",
      "id" : 764641715,
      "in_reply_to_id" : 763794040,
      "line" : 382,
      "node_id" : "PRRC_kwDOABII584tk4Gz",
      "original_commit_id" : "b4adc5ad6769e4a5a6179dfff271cd4c9dc47a5b",
      "original_line" : 382,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 5,
      "pull_request_review_id" : 826133026,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764641715/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-08T08:26:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764641715",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r764648616"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764648616"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "So, what is the purpose of this test? It should be removed?",
      "commit_id" : "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "created_at" : "2021-12-08T08:36:25Z",
      "diff_hunk" : "@@ -108,6 +108,37 @@ def run_test(self):\n         assert_equal(set(self.nodes[0].getrawmempool()), set())\n         self.sync_all()\n \n+        self.log.info(\"Simulate a natural reorg where mempool transaction stays valid but on a different block\")\n+        self.connect_nodes(0, 1)\n+        # Mine a block to create mature coinbase",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r764648616",
      "id" : 764648616,
      "in_reply_to_id" : 764171819,
      "line" : 113,
      "node_id" : "PRRC_kwDOABII584tk5yo",
      "original_commit_id" : "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "original_line" : 113,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "test/functional/mempool_reorg.py",
      "position" : 6,
      "pull_request_review_id" : 826142587,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764648616/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-08T08:36:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764648616",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r764649275"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764649275"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think the goal is to do a reorg in this test without using `invalidateblock`",
      "commit_id" : "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "created_at" : "2021-12-08T08:37:25Z",
      "diff_hunk" : "@@ -108,6 +108,37 @@ def run_test(self):\n         assert_equal(set(self.nodes[0].getrawmempool()), set())\n         self.sync_all()\n \n+        self.log.info(\"Simulate a natural reorg where mempool transaction stays valid but on a different block\")\n+        self.connect_nodes(0, 1)\n+        # Mine a block to create mature coinbase",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r764649275",
      "id" : 764649275,
      "in_reply_to_id" : 764171819,
      "line" : 113,
      "node_id" : "PRRC_kwDOABII584tk587",
      "original_commit_id" : "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "original_line" : 113,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "test/functional/mempool_reorg.py",
      "position" : 6,
      "pull_request_review_id" : 826143510,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764649275/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-08T08:37:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764649275",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> cc @MarcoFalke, thanks for catching my bug\r\n\r\nHow did you catch this? It looks pretty obscure to me.",
      "created_at" : "2021-12-08T08:37:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#issuecomment-988606067",
      "id" : 988606067,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23683",
      "node_id" : "IC_kwDOABII58467O5z",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/988606067/reactions"
      },
      "updated_at" : "2021-12-08T08:37:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/988606067",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> > cc @MarcoFalke, thanks for catching my bug\r\n> \r\n> How did you catch this? It looks pretty obscure to me.\r\n\r\nThrough code review, basically. Though, it was a bit tricky because there was never an externally observable logic bug, at most the performance difference. For a few hours I even thought the code could be removed (#23660) :sweat_smile: ",
      "created_at" : "2021-12-08T08:46:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#issuecomment-988611606",
      "id" : 988611606,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23683",
      "node_id" : "IC_kwDOABII58467QQW",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 1,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/988611606/reactions"
      },
      "updated_at" : "2021-12-08T08:46:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/988611606",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r764671759"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764671759"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The test is supposed to fail without the bugfix if the asserts are there",
      "commit_id" : "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "created_at" : "2021-12-08T09:07:29Z",
      "diff_hunk" : "@@ -108,6 +108,37 @@ def run_test(self):\n         assert_equal(set(self.nodes[0].getrawmempool()), set())\n         self.sync_all()\n \n+        self.log.info(\"Simulate a natural reorg where mempool transaction stays valid but on a different block\")\n+        self.connect_nodes(0, 1)\n+        # Mine a block to create mature coinbase",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r764671759",
      "id" : 764671759,
      "in_reply_to_id" : 764171819,
      "line" : 113,
      "node_id" : "PRRC_kwDOABII584tk_cP",
      "original_commit_id" : "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "original_line" : 113,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "test/functional/mempool_reorg.py",
      "position" : 6,
      "pull_request_review_id" : 826173853,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764671759/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-08T09:07:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764671759",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r764679260"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764679260"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I recall adding the assert and saw this and one other test failing already",
      "commit_id" : "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "created_at" : "2021-12-08T09:17:17Z",
      "diff_hunk" : "@@ -108,6 +108,37 @@ def run_test(self):\n         assert_equal(set(self.nodes[0].getrawmempool()), set())\n         self.sync_all()\n \n+        self.log.info(\"Simulate a natural reorg where mempool transaction stays valid but on a different block\")\n+        self.connect_nodes(0, 1)\n+        # Mine a block to create mature coinbase",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r764679260",
      "id" : 764679260,
      "in_reply_to_id" : 764171819,
      "line" : 113,
      "node_id" : "PRRC_kwDOABII584tlBRc",
      "original_commit_id" : "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "original_line" : 113,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "test/functional/mempool_reorg.py",
      "position" : 6,
      "pull_request_review_id" : 826184027,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764679260/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-08T09:17:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764679260",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r764719351"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764719351"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "What assert? Something extra, that is not in the PR?",
      "commit_id" : "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "created_at" : "2021-12-08T10:05:55Z",
      "diff_hunk" : "@@ -108,6 +108,37 @@ def run_test(self):\n         assert_equal(set(self.nodes[0].getrawmempool()), set())\n         self.sync_all()\n \n+        self.log.info(\"Simulate a natural reorg where mempool transaction stays valid but on a different block\")\n+        self.connect_nodes(0, 1)\n+        # Mine a block to create mature coinbase",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r764719351",
      "id" : 764719351,
      "in_reply_to_id" : 764171819,
      "line" : 113,
      "node_id" : "PRRC_kwDOABII584tlLD3",
      "original_commit_id" : "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "original_line" : 113,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "test/functional/mempool_reorg.py",
      "position" : 6,
      "pull_request_review_id" : 826237817,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764719351/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-08T10:05:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764719351",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r764741205"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764741205"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, assert.\r\n\r\nAs mentioned previously it is not possible to test this without modifying the source code or looking at internal memory.\r\n\r\nAdding an assert is one way to modify the source code. Another way would be to return the struct over rpc, or log it to the debug log, or ...",
      "commit_id" : "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "created_at" : "2021-12-08T10:33:43Z",
      "diff_hunk" : "@@ -108,6 +108,37 @@ def run_test(self):\n         assert_equal(set(self.nodes[0].getrawmempool()), set())\n         self.sync_all()\n \n+        self.log.info(\"Simulate a natural reorg where mempool transaction stays valid but on a different block\")\n+        self.connect_nodes(0, 1)\n+        # Mine a block to create mature coinbase",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r764741205",
      "id" : 764741205,
      "in_reply_to_id" : 764171819,
      "line" : 113,
      "node_id" : "PRRC_kwDOABII584tlQZV",
      "original_commit_id" : "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "original_line" : 113,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "test/functional/mempool_reorg.py",
      "position" : 6,
      "pull_request_review_id" : 826267061,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764741205/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-08T10:33:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/764741205",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Change looks good to me. I agree it fixes the lockpoint invalidity bug introduced in #22677.\r\n\r\nA few suggestions for the `check_final_and_mature` lambda:\r\n\r\n- A contributing factor to the the bug being introduced was misleading naming (of `update_lock_points()`) and a lack of documentation. Therefore, we should be extra explicit about what's going on in these functions by adding plenty of code documentation.\r\n- the return value is the inverse of what I'd expect. I'd expect a `check_blah()` function to return `true` if the check passes and `false` if it fails.\r\n- the local `should_remove` variable seems unnecessary. The function can just return immediately if one of the checks fails.\r\n\r\nI've included a suggested patch below. Feel free to take whatever you think is an improvement.\r\n\r\n<details>\r\n<summary>Suggested patch</summary>\r\n\r\n```diff\r\ndiff --git a/src/txmempool.cpp b/src/txmempool.cpp\r\nindex 26cb2ff4b4..c742548875 100644\r\n--- a/src/txmempool.cpp\r\n+++ b/src/txmempool.cpp\r\n@@ -631,7 +631,7 @@ void CTxMemPool::removeForReorg(CChain& chain, std::function<bool(txiter)> check\r\n \r\n     setEntries txToRemove;\r\n     for (indexed_transaction_set::const_iterator it = mapTx.begin(); it != mapTx.end(); it++) {\r\n-        if (check_final_and_mature(it)) txToRemove.insert(it);\r\n+        if (!check_final_and_mature(it)) txToRemove.insert(it);\r\n     }\r\n     setEntries setAllRemoves;\r\n     for (txiter it : txToRemove) {\r\ndiff --git a/src/validation.cpp b/src/validation.cpp\r\nindex f53641e786..8da2e80510 100644\r\n--- a/src/validation.cpp\r\n+++ b/src/validation.cpp\r\n@@ -350,21 +350,38 @@ void CChainState::MaybeUpdateMempoolForReorg(\r\n     // the disconnectpool that were added back and cleans up the mempool state.\r\n     m_mempool->UpdateTransactionsFromBlock(vHashUpdate);\r\n \r\n-    const auto check_final_and_mature = [this, flags=STANDARD_LOCKTIME_VERIFY_FLAGS](CTxMemPool::txiter it)\r\n+    // Check whether the transaction is still final/mature, and update\r\n+    // the transaction's cached lockpoints if necessary.\r\n+    // If this returns false, the mempool *must* remove the transaction, since\r\n+    // it is no longer valid for inclusion in the next block (and its cached\r\n+    // lockpoints may be invalid).\r\n+    const auto check_final_and_mature = [this, flags=STANDARD_LOCKTIME_VERIFY_FLAGS](CTxMemPool::txiter it) -> bool\r\n         EXCLUSIVE_LOCKS_REQUIRED(m_mempool->cs, ::cs_main) {\r\n-        bool should_remove = false;\r\n         AssertLockHeld(m_mempool->cs);\r\n         AssertLockHeld(::cs_main);\r\n         const CTransaction& tx = it->GetTx();\r\n+\r\n+        // Check transaction finality\r\n+        if (!CheckFinalTx(m_chain.Tip(), tx, flags)) {\r\n+            return false;\r\n+        }\r\n+\r\n+        // Check sequence locks\r\n         LockPoints lp = it->GetLockPoints();\r\n         const bool validLP{TestLockPointValidity(m_chain, lp)};\r\n         CCoinsViewMemPool view_mempool(&CoinsTip(), *m_mempool);\r\n-        if (!CheckFinalTx(m_chain.Tip(), tx, flags)\r\n-            || !CheckSequenceLocks(m_chain.Tip(), view_mempool, tx, flags, &lp, validLP)) {\r\n-            // Note if CheckSequenceLocks fails the LockPoints may still be invalid\r\n-            // So it's critical that we remove the tx and not depend on the LockPoints.\r\n-            should_remove = true;\r\n-        } else if (it->GetSpendsCoinbase()) {\r\n+\r\n+        if (!CheckSequenceLocks(m_chain.Tip(), view_mempool, tx, flags, &lp, validLP)) {\r\n+            // Sequence locks fail. The mempool *must* remove this transaction since\r\n+            // we're not going to update its cached lockpoints.\r\n+            return false;\r\n+        } else if (!validLP) {\r\n+            // CheckSequenceLocks has modified lp. Update the cached lockpoints.\r\n+             m_mempool->mapTx.modify(it, update_lock_points(lp));\r\n+        }\r\n+\r\n+        // Check coinbase spend maturity\r\n+        if (it->GetSpendsCoinbase()) {\r\n             for (const CTxIn& txin : tx.vin) {\r\n                 auto it2 = m_mempool->mapTx.find(txin.prevout.hash);\r\n                 if (it2 != m_mempool->mapTx.end())\r\n@@ -373,18 +390,19 @@ void CChainState::MaybeUpdateMempoolForReorg(\r\n                 assert(!coin.IsSpent());\r\n                 const auto mempool_spend_height{m_chain.Tip()->nHeight + 1};\r\n                 if (coin.IsSpent() || (coin.IsCoinBase() && mempool_spend_height - coin.nHeight < COINBASE_MATURITY)) {\r\n-                    should_remove = true;\r\n-                    break;\r\n+                    // Coinbase spend is now immature. Remove tx from mempool.\r\n+                    return false;\r\n                 }\r\n             }\r\n         }\r\n-        // CheckSequenceLocks updates lp. Update the mempool entry LockPoints.\r\n-        if (!validLP) m_mempool->mapTx.modify(it, update_lock_points(lp));\r\n-        return should_remove;\r\n+\r\n+        // Transaction is still final and mature. Cached lockpoints have been updated.\r\n+        return true;\r\n     };\r\n \r\n-    // We also need to remove any now-immature transactions\r\n+    // Remove any transactions that are no longer final/mature, and update cached lockpoints.\r\n     m_mempool->removeForReorg(m_chain, check_final_and_mature);\r\n+\r\n     // Re-limit mempool size, in case we added any transactions\r\n     LimitMempoolSize(\r\n         *m_mempool,\r\n```\r\n\r\n</details>",
      "created_at" : "2021-12-09T10:56:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#issuecomment-989741186",
      "id" : 989741186,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23683",
      "node_id" : "IC_kwDOABII5846_kCC",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/989741186/reactions"
      },
      "updated_at" : "2021-12-09T10:56:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/989741186",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r765731520"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/765731520"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> What assert?\r\n\r\nThis one: https://github.com/bitcoin/bitcoin/pull/23683/files#diff-c065d4cd2398ad0dbcef393c5dfc53f465bf44723348892395fffd2fb3bac522R642",
      "commit_id" : "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "created_at" : "2021-12-09T12:13:42Z",
      "diff_hunk" : "@@ -108,6 +108,37 @@ def run_test(self):\n         assert_equal(set(self.nodes[0].getrawmempool()), set())\n         self.sync_all()\n \n+        self.log.info(\"Simulate a natural reorg where mempool transaction stays valid but on a different block\")\n+        self.connect_nodes(0, 1)\n+        # Mine a block to create mature coinbase",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r765731520",
      "id" : 765731520,
      "in_reply_to_id" : 764171819,
      "line" : 113,
      "node_id" : "PRRC_kwDOABII584tpCLA",
      "original_commit_id" : "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "original_line" : 113,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "test/functional/mempool_reorg.py",
      "position" : 6,
      "pull_request_review_id" : 827600133,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/765731520/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-09T12:14:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/765731520",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r765732191"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/765732191"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> skipping update for the to-be-removed transactions will spare some CPU cycles but will increase the coupling between check_final_and_mature() and removeForReorg()\r\n\r\nAgreed ð ",
      "commit_id" : "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "created_at" : "2021-12-09T12:14:35Z",
      "diff_hunk" : "@@ -378,6 +378,8 @@ void CChainState::MaybeUpdateMempoolForReorg(\n                 }\n             }\n         }\n+        // CheckSequenceLocks updates lp. Update the mempool entry LockPoints.\n+        if (!validLP) m_mempool->mapTx.modify(it, update_lock_points(lp));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r765732191",
      "id" : 765732191,
      "in_reply_to_id" : 763794040,
      "line" : 382,
      "node_id" : "PRRC_kwDOABII584tpCVf",
      "original_commit_id" : "b4adc5ad6769e4a5a6179dfff271cd4c9dc47a5b",
      "original_line" : 382,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 5,
      "pull_request_review_id" : 827600133,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/765732191/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-09T12:14:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/765732191",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r765733944"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/765733944"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In a previous version of this PR I think I had added the assert in a separate commit from the bugfix.",
      "commit_id" : "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "created_at" : "2021-12-09T12:17:11Z",
      "diff_hunk" : "@@ -108,6 +108,37 @@ def run_test(self):\n         assert_equal(set(self.nodes[0].getrawmempool()), set())\n         self.sync_all()\n \n+        self.log.info(\"Simulate a natural reorg where mempool transaction stays valid but on a different block\")\n+        self.connect_nodes(0, 1)\n+        # Mine a block to create mature coinbase",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r765733944",
      "id" : 765733944,
      "in_reply_to_id" : 764171819,
      "line" : 113,
      "node_id" : "PRRC_kwDOABII584tpCw4",
      "original_commit_id" : "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "original_line" : 113,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "test/functional/mempool_reorg.py",
      "position" : 6,
      "pull_request_review_id" : 827603493,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/765733944/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-09T12:17:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/765733944",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r765734924"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/765734924"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I agree it seems like a better sanity check to run at the end of `removeForReorg`, once all of the entries have been processed",
      "commit_id" : "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "created_at" : "2021-12-09T12:18:32Z",
      "diff_hunk" : "@@ -649,10 +639,7 @@ void CTxMemPool::removeForReorg(CChain& chain, std::function<bool(txiter)> check\n     }\n     RemoveStaged(setAllRemoves, false, MemPoolRemovalReason::REORG);\n     for (indexed_transaction_set::const_iterator it = mapTx.begin(); it != mapTx.end(); it++) {\n-        const LockPoints lp{it->GetLockPoints()};\n-        if (!TestLockPointValidity(chain, lp)) {\n-            mapTx.modify(it, update_lock_points(lp));\n-        }\n+        assert(TestLockPointValidity(chain, it->GetLockPoints()));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r765734924",
      "id" : 765734924,
      "in_reply_to_id" : 764168506,
      "line" : 642,
      "node_id" : "PRRC_kwDOABII584tpDAM",
      "original_commit_id" : "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "original_line" : 642,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 25,
      "pull_request_review_id" : 827604812,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/765734924/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-09T12:18:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/765734924",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r765806365"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/765806365"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I see (which assert). So I took latest `master` (7629efcc2c3a8a8a7c17b1300cd466ec6c8c1f3f) and applied this patch:\r\n\r\n```diff\r\n--- i/src/txmempool.cpp\r\n+++ w/src/txmempool.cpp\r\n@@ -653,6 +653,7 @@ void CTxMemPool::removeForReorg(CChain& chain, std::function<bool(txiter)> check\r\n         if (!TestLockPointValidity(chain, lp)) {\r\n             mapTx.modify(it, update_lock_points(lp));\r\n         }\r\n+        assert(TestLockPointValidity(chain, lp));\r\n     }\r\n }\r\n```\r\n\r\n`test/functional/mempool_reorg.py` then fails because the added assert is hit. This is unmodified `mempool_reorg.py`, without the extension from this PR. If the bug can be reproduced by adding an assert + unmodified `mempool_reorg.py`, then why bother to change (extend) the test?\r\n\r\n> I think the goal is to do a reorg in this test without using `invalidateblock`\r\n\r\nWhy bother if the test fails even without that?",
      "commit_id" : "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "created_at" : "2021-12-09T13:50:39Z",
      "diff_hunk" : "@@ -108,6 +108,37 @@ def run_test(self):\n         assert_equal(set(self.nodes[0].getrawmempool()), set())\n         self.sync_all()\n \n+        self.log.info(\"Simulate a natural reorg where mempool transaction stays valid but on a different block\")\n+        self.connect_nodes(0, 1)\n+        # Mine a block to create mature coinbase",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r765806365",
      "id" : 765806365,
      "in_reply_to_id" : 764171819,
      "line" : 113,
      "node_id" : "PRRC_kwDOABII584tpUcd",
      "original_commit_id" : "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "original_line" : 113,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "test/functional/mempool_reorg.py",
      "position" : 6,
      "pull_request_review_id" : 827706213,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/765806365/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-09T13:50:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/765806365",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r765820262"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/765820262"
         }
      },
      "author_association" : "MEMBER",
      "body" : "reorgs in the real network happen without `invalidateblock`, so I think we should attempt to not use the call",
      "commit_id" : "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "created_at" : "2021-12-09T14:05:57Z",
      "diff_hunk" : "@@ -108,6 +108,37 @@ def run_test(self):\n         assert_equal(set(self.nodes[0].getrawmempool()), set())\n         self.sync_all()\n \n+        self.log.info(\"Simulate a natural reorg where mempool transaction stays valid but on a different block\")\n+        self.connect_nodes(0, 1)\n+        # Mine a block to create mature coinbase",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r765820262",
      "id" : 765820262,
      "in_reply_to_id" : 764171819,
      "line" : 113,
      "node_id" : "PRRC_kwDOABII584tpX1m",
      "original_commit_id" : "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "original_line" : 113,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "test/functional/mempool_reorg.py",
      "position" : 6,
      "pull_request_review_id" : 827725792,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/765820262/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-09T14:05:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/765820262",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r765908448"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/765908448"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The new test is not strictly necessary in order to hit this, but it's not pointless. We didn't have any natural reorgs. We used `invalidateblock` as a shortcut to do it manually. I can remove it if you insist, but I don't really see why it's problematic?",
      "commit_id" : "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "created_at" : "2021-12-09T15:38:26Z",
      "diff_hunk" : "@@ -108,6 +108,37 @@ def run_test(self):\n         assert_equal(set(self.nodes[0].getrawmempool()), set())\n         self.sync_all()\n \n+        self.log.info(\"Simulate a natural reorg where mempool transaction stays valid but on a different block\")\n+        self.connect_nodes(0, 1)\n+        # Mine a block to create mature coinbase",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r765908448",
      "id" : 765908448,
      "in_reply_to_id" : 764171819,
      "line" : 113,
      "node_id" : "PRRC_kwDOABII584tptXg",
      "original_commit_id" : "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "original_line" : 113,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "test/functional/mempool_reorg.py",
      "position" : 6,
      "pull_request_review_id" : 827851302,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/765908448/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-09T15:38:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/765908448",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r766553409"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/766553409"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Alright, I agree that for the test the natural reorg is better than `invalidateblock`. But the change in this PR just adds a natural reorg, without removing the `invalidateblock` one. Shouldn't it replace `invalidateblock` with a natural reorg?\r\n\r\nI checked the code coverage with and without the extension of the test from this PR (28b60ce3122b29ffad2c60790d3bfe9a2ede2471) and it is the same. In other words, the newly added snippet does not extend the coverage. It exercises code that has already been exercised by preceding parts of `mempool_reorg.py`.\r\n\r\n<details>\r\n<summary>commands to compare coverage with/without test extension</summary>\r\n\r\n```sh\r\n# compile\r\nF=\"-fprofile-instr-generate -fcoverage-mapping\" CXXFLAGS=${F} LDFLAGS=${F} ./configure and make as usual\r\n\r\n# run test and gather coverage data\r\nLLVM_PROFILE_FILE=\"/tmp/coverage1/%m-%p.profraw\" test/functional/mempool_reorg.py\r\nllvm-profdata13 merge /tmp/coverage1/*.profraw -o /tmp/coverage1/all.profdata\r\n\r\n# remove topmost commit (test extension)\r\ngit show |git apply -R\r\n\r\n# run test and gather coverage data\r\nLLVM_PROFILE_FILE=\"/tmp/coverage2/%m-%p.profraw\" test/functional/mempool_reorg.py\r\nllvm-profdata13 merge /tmp/coverage2/*.profraw -o /tmp/coverage2/all.profdata\r\n\r\n# compare the coverage (both are identical)\r\nmd5 -r /tmp/coverage*/all.profdata\r\n14196d89227bc6028834aeff32b79ff5 /tmp/coverage1/all.profdata\r\n14196d89227bc6028834aeff32b79ff5 /tmp/coverage2/all.profdata\r\n```\r\n</details>\r\n\r\nI don't insist on removing the test snippet. I am just trying to understand the point of it. So far, with my understanding, I am ~0 on it because I fail to see what value it adds. If the `invalidate` block reorg is removed and replaced by a natural reorg without reducing code coverage, then that would be a definite +1.",
      "commit_id" : "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "created_at" : "2021-12-10T10:19:59Z",
      "diff_hunk" : "@@ -108,6 +108,37 @@ def run_test(self):\n         assert_equal(set(self.nodes[0].getrawmempool()), set())\n         self.sync_all()\n \n+        self.log.info(\"Simulate a natural reorg where mempool transaction stays valid but on a different block\")\n+        self.connect_nodes(0, 1)\n+        # Mine a block to create mature coinbase",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r766553409",
      "id" : 766553409,
      "in_reply_to_id" : 764171819,
      "line" : 113,
      "node_id" : "PRRC_kwDOABII584tsK1B",
      "original_commit_id" : "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "original_line" : 113,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "test/functional/mempool_reorg.py",
      "position" : 6,
      "pull_request_review_id" : 828725082,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/766553409/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-10T10:19:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/766553409",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Notice - the ACKed commit is the HEAD~ of this PR, without the topmost commit which adds a test which I do not think is harmful and I do not object. But I don't see what value it adds \r\n\r\nI've removed the test. Perhaps a followup dedicated to test improvements can convert the `invalidateblock`s to natural reorgs.\r\n\r\n> A few suggestions for the check_final_and_mature lambda:\r\n\r\nThanks, I've applied (most of) your diff. I see what you mean by the return results being unexpected for something called \"check.\" My wish is to follow the convention of a unary predicate that returns `true` if something needs to be removed. I've renamed check to filter.",
      "created_at" : "2021-12-14T12:51:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#issuecomment-993508250",
      "id" : 993508250,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23683",
      "node_id" : "IC_kwDOABII5847N7ua",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/993508250/reactions"
      },
      "updated_at" : "2021-12-14T12:51:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/993508250",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r768858811"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/768858811"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This `for` is removed in commit `[bugfix] update lockpoints during reorg` only to be re-added later in commit `[mempool] check that all LockPoints are valid reorg removals`. I think the latter should be squashed into the former. It was like this in a previous incarnation of this PR and it made sense to me because the added `assert` is logically related to the rest of the changes:\r\n\r\n```diff\r\n     for (indexed_transaction_set::const_iterator it = mapTx.begin(); it != mapTx.end(); it++) {\r\n-        const LockPoints lp{it->GetLockPoints()};\r\n-        if (!TestLockPointValidity(chain, lp)) {\r\n-            mapTx.modify(it, update_lock_points(lp));\r\n-        }\r\n+        assert(TestLockPointValidity(chain, it->GetLockPoints()));\r\n     }\r\n```",
      "commit_id" : "2586226ec20a97f9ab9f3b7eae8a5c7fb6a7806b",
      "created_at" : "2021-12-14T16:50:29Z",
      "diff_hunk" : "@@ -649,10 +639,7 @@ void CTxMemPool::removeForReorg(CChain& chain, std::function<bool(txiter)> check\n     }\n     RemoveStaged(setAllRemoves, false, MemPoolRemovalReason::REORG);\n     for (indexed_transaction_set::const_iterator it = mapTx.begin(); it != mapTx.end(); it++) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r768858811",
      "id" : 768858811,
      "line" : 641,
      "node_id" : "PRRC_kwDOABII584t09q7",
      "original_commit_id" : "2586226ec20a97f9ab9f3b7eae8a5c7fb6a7806b",
      "original_line" : 641,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 20,
      "pull_request_review_id" : 831775988,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/768858811/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-14T17:22:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/768858811",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r768873591"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/768873591"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: `else` is not necessary after `return`. May as well remove it also for consistency with the above `if (!CheckFinalTx...` (which does not include `else` after `return`).\r\n\r\n```suggestion\r\n        }\r\n        if (!validLP) {\r\n```",
      "commit_id" : "2586226ec20a97f9ab9f3b7eae8a5c7fb6a7806b",
      "created_at" : "2021-12-14T17:07:33Z",
      "diff_hunk" : "@@ -350,21 +350,29 @@ void CChainState::MaybeUpdateMempoolForReorg(\n     // the disconnectpool that were added back and cleans up the mempool state.\n     m_mempool->UpdateTransactionsFromBlock(vHashUpdate);\n \n-    const auto check_final_and_mature = [this, flags=STANDARD_LOCKTIME_VERIFY_FLAGS](CTxMemPool::txiter it)\n+    // Check whether the transaction is still final and, if it spends a coinbase output, mature.\n+    // Update the entry's cached LockPoints if needed. If this returns true, the tx would be invalid\n+    // in the next block, so the mempool must remove this entry and all of its descendants.\n+    const auto filter_final_and_mature = [this, flags=STANDARD_LOCKTIME_VERIFY_FLAGS](CTxMemPool::txiter it)\n         EXCLUSIVE_LOCKS_REQUIRED(m_mempool->cs, ::cs_main) {\n-        bool should_remove = false;\n         AssertLockHeld(m_mempool->cs);\n         AssertLockHeld(::cs_main);\n         const CTransaction& tx = it->GetTx();\n         LockPoints lp = it->GetLockPoints();\n         const bool validLP{TestLockPointValidity(m_chain, lp)};\n         CCoinsViewMemPool view_mempool(&CoinsTip(), *m_mempool);\n-        if (!CheckFinalTx(m_chain.Tip(), tx, flags)\n-            || !CheckSequenceLocks(m_chain.Tip(), view_mempool, tx, flags, &lp, validLP)) {\n-            // Note if CheckSequenceLocks fails the LockPoints may still be invalid\n-            // So it's critical that we remove the tx and not depend on the LockPoints.\n-            should_remove = true;\n-        } else if (it->GetSpendsCoinbase()) {\n+        // The transaction must be final.\n+        if (!CheckFinalTx(m_chain.Tip(), tx, flags)) return true;\n+        // Note if CheckSequenceLocks fails the LockPoints may still be invalid\n+        // So it's critical that we remove the tx and not depend on the LockPoints.\n+        if (!CheckSequenceLocks(m_chain.Tip(), view_mempool, tx, flags, &lp, validLP)) {\n+            return true;\n+        } else if (!validLP) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r768873591",
      "id" : 768873591,
      "line" : 370,
      "node_id" : "PRRC_kwDOABII584t1BR3",
      "original_commit_id" : "2586226ec20a97f9ab9f3b7eae8a5c7fb6a7806b",
      "original_line" : 370,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 29,
      "pull_request_review_id" : 831775988,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/768873591/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-14T17:22:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/768873591",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r768876739"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/768876739"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In a previous incarnation of this PR, this `modify()` would have been executed regardless of the outcome of `CheckFinalTx()` and `CheckSequenceLocks()`. Not so anymore. From https://github.com/bitcoin/bitcoin/pull/23683#discussion_r765732191 I got the impression that it is better to update for all transactions, even the to-be-removed ones.",
      "commit_id" : "2586226ec20a97f9ab9f3b7eae8a5c7fb6a7806b",
      "created_at" : "2021-12-14T17:11:12Z",
      "diff_hunk" : "@@ -350,21 +350,29 @@ void CChainState::MaybeUpdateMempoolForReorg(\n     // the disconnectpool that were added back and cleans up the mempool state.\n     m_mempool->UpdateTransactionsFromBlock(vHashUpdate);\n \n-    const auto check_final_and_mature = [this, flags=STANDARD_LOCKTIME_VERIFY_FLAGS](CTxMemPool::txiter it)\n+    // Check whether the transaction is still final and, if it spends a coinbase output, mature.\n+    // Update the entry's cached LockPoints if needed. If this returns true, the tx would be invalid\n+    // in the next block, so the mempool must remove this entry and all of its descendants.\n+    const auto filter_final_and_mature = [this, flags=STANDARD_LOCKTIME_VERIFY_FLAGS](CTxMemPool::txiter it)\n         EXCLUSIVE_LOCKS_REQUIRED(m_mempool->cs, ::cs_main) {\n-        bool should_remove = false;\n         AssertLockHeld(m_mempool->cs);\n         AssertLockHeld(::cs_main);\n         const CTransaction& tx = it->GetTx();\n         LockPoints lp = it->GetLockPoints();\n         const bool validLP{TestLockPointValidity(m_chain, lp)};\n         CCoinsViewMemPool view_mempool(&CoinsTip(), *m_mempool);\n-        if (!CheckFinalTx(m_chain.Tip(), tx, flags)\n-            || !CheckSequenceLocks(m_chain.Tip(), view_mempool, tx, flags, &lp, validLP)) {\n-            // Note if CheckSequenceLocks fails the LockPoints may still be invalid\n-            // So it's critical that we remove the tx and not depend on the LockPoints.\n-            should_remove = true;\n-        } else if (it->GetSpendsCoinbase()) {\n+        // The transaction must be final.\n+        if (!CheckFinalTx(m_chain.Tip(), tx, flags)) return true;\n+        // Note if CheckSequenceLocks fails the LockPoints may still be invalid\n+        // So it's critical that we remove the tx and not depend on the LockPoints.\n+        if (!CheckSequenceLocks(m_chain.Tip(), view_mempool, tx, flags, &lp, validLP)) {\n+            return true;\n+        } else if (!validLP) {\n+            // CheckSequenceLocks updates lp. Update the mempool entry LockPoints.\n+            m_mempool->mapTx.modify(it, update_lock_points(lp));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r768876739",
      "id" : 768876739,
      "line" : 372,
      "node_id" : "PRRC_kwDOABII584t1CDD",
      "original_commit_id" : "2586226ec20a97f9ab9f3b7eae8a5c7fb6a7806b",
      "original_line" : 372,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 31,
      "pull_request_review_id" : 831775988,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/768876739/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-14T17:22:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/768876739",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r768879750"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/768879750"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Previously, this check and the body of the `if` would have been executed before updating the lock points. Now the order is reversed. Could the updated lock points change the outcome of any of this code, e.g. the `mapTx.find()` call?",
      "commit_id" : "2586226ec20a97f9ab9f3b7eae8a5c7fb6a7806b",
      "created_at" : "2021-12-14T17:14:47Z",
      "diff_hunk" : "@@ -350,21 +350,29 @@ void CChainState::MaybeUpdateMempoolForReorg(\n     // the disconnectpool that were added back and cleans up the mempool state.\n     m_mempool->UpdateTransactionsFromBlock(vHashUpdate);\n \n-    const auto check_final_and_mature = [this, flags=STANDARD_LOCKTIME_VERIFY_FLAGS](CTxMemPool::txiter it)\n+    // Check whether the transaction is still final and, if it spends a coinbase output, mature.\n+    // Update the entry's cached LockPoints if needed. If this returns true, the tx would be invalid\n+    // in the next block, so the mempool must remove this entry and all of its descendants.\n+    const auto filter_final_and_mature = [this, flags=STANDARD_LOCKTIME_VERIFY_FLAGS](CTxMemPool::txiter it)\n         EXCLUSIVE_LOCKS_REQUIRED(m_mempool->cs, ::cs_main) {\n-        bool should_remove = false;\n         AssertLockHeld(m_mempool->cs);\n         AssertLockHeld(::cs_main);\n         const CTransaction& tx = it->GetTx();\n         LockPoints lp = it->GetLockPoints();\n         const bool validLP{TestLockPointValidity(m_chain, lp)};\n         CCoinsViewMemPool view_mempool(&CoinsTip(), *m_mempool);\n-        if (!CheckFinalTx(m_chain.Tip(), tx, flags)\n-            || !CheckSequenceLocks(m_chain.Tip(), view_mempool, tx, flags, &lp, validLP)) {\n-            // Note if CheckSequenceLocks fails the LockPoints may still be invalid\n-            // So it's critical that we remove the tx and not depend on the LockPoints.\n-            should_remove = true;\n-        } else if (it->GetSpendsCoinbase()) {\n+        // The transaction must be final.\n+        if (!CheckFinalTx(m_chain.Tip(), tx, flags)) return true;\n+        // Note if CheckSequenceLocks fails the LockPoints may still be invalid\n+        // So it's critical that we remove the tx and not depend on the LockPoints.\n+        if (!CheckSequenceLocks(m_chain.Tip(), view_mempool, tx, flags, &lp, validLP)) {\n+            return true;\n+        } else if (!validLP) {\n+            // CheckSequenceLocks updates lp. Update the mempool entry LockPoints.\n+            m_mempool->mapTx.modify(it, update_lock_points(lp));\n+        }\n+        // If the transaction spends any coinbase outputs, check maturity.\n+        if (it->GetSpendsCoinbase()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r768879750",
      "id" : 768879750,
      "line" : 375,
      "node_id" : "PRRC_kwDOABII584t1CyG",
      "original_commit_id" : "2586226ec20a97f9ab9f3b7eae8a5c7fb6a7806b",
      "original_line" : 375,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 34,
      "pull_request_review_id" : 831775988,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/768879750/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-14T17:22:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/768879750",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r768882217"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/768882217"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> Update the entry's cached LockPoints if needed\r\n\r\nThis is a bit vague with the current code. The lock points may or may not be updated if this function returns `true` and will be updated for sure if it returns `false`. I think it is better to update them in all cases or change this comment to say \"Update the entry's cached LockPoints if false is returned (and also in some cases if true is returned :disappointed:)\".",
      "commit_id" : "2586226ec20a97f9ab9f3b7eae8a5c7fb6a7806b",
      "created_at" : "2021-12-14T17:17:52Z",
      "diff_hunk" : "@@ -350,21 +350,29 @@ void CChainState::MaybeUpdateMempoolForReorg(\n     // the disconnectpool that were added back and cleans up the mempool state.\n     m_mempool->UpdateTransactionsFromBlock(vHashUpdate);\n \n-    const auto check_final_and_mature = [this, flags=STANDARD_LOCKTIME_VERIFY_FLAGS](CTxMemPool::txiter it)\n+    // Check whether the transaction is still final and, if it spends a coinbase output, mature.\n+    // Update the entry's cached LockPoints if needed. If this returns true, the tx would be invalid",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r768882217",
      "id" : 768882217,
      "line" : 354,
      "node_id" : "PRRC_kwDOABII584t1DYp",
      "original_commit_id" : "2586226ec20a97f9ab9f3b7eae8a5c7fb6a7806b",
      "original_line" : 354,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 6,
      "pull_request_review_id" : 831775988,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/768882217/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-14T17:22:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/768882217",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Sorry for the churn. I had wanted to incorporate the suggestions in https://github.com/bitcoin/bitcoin/pull/23683#issuecomment-989741186 for the lambda, but I now think it's best saved for a different PR.",
      "created_at" : "2021-12-16T17:44:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#issuecomment-996039695",
      "id" : 996039695,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23683",
      "node_id" : "IC_kwDOABII5847XlwP",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/996039695/reactions"
      },
      "updated_at" : "2021-12-16T17:44:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/996039695",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r770776035"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/770776035"
         }
      },
      "author_association" : "MEMBER",
      "body" : "reverted back to original, squashed commit",
      "commit_id" : "b4adc5ad6769e4a5a6179dfff271cd4c9dc47a5b",
      "created_at" : "2021-12-16T17:45:25Z",
      "diff_hunk" : "@@ -649,10 +639,7 @@ void CTxMemPool::removeForReorg(CChain& chain, std::function<bool(txiter)> check\n     }\n     RemoveStaged(setAllRemoves, false, MemPoolRemovalReason::REORG);\n     for (indexed_transaction_set::const_iterator it = mapTx.begin(); it != mapTx.end(); it++) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r770776035",
      "id" : 770776035,
      "in_reply_to_id" : 768858811,
      "line" : 641,
      "node_id" : "PRRC_kwDOABII584t8Rvj",
      "original_commit_id" : "2586226ec20a97f9ab9f3b7eae8a5c7fb6a7806b",
      "original_line" : 641,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 20,
      "pull_request_review_id" : 834417459,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/770776035/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-16T17:45:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/770776035",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r772879178"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/772879178"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The `!validLP` check here is logically associated with the `!CheckSequenceLocks()` check, so it makes sense to have it in an `else` branch. Logically the two things are the same since the if branch contains an early return, but structuring it as if/else signals to the developer that the two things are connected.",
      "commit_id" : "b4adc5ad6769e4a5a6179dfff271cd4c9dc47a5b",
      "created_at" : "2021-12-21T07:11:29Z",
      "diff_hunk" : "@@ -350,21 +350,29 @@ void CChainState::MaybeUpdateMempoolForReorg(\n     // the disconnectpool that were added back and cleans up the mempool state.\n     m_mempool->UpdateTransactionsFromBlock(vHashUpdate);\n \n-    const auto check_final_and_mature = [this, flags=STANDARD_LOCKTIME_VERIFY_FLAGS](CTxMemPool::txiter it)\n+    // Check whether the transaction is still final and, if it spends a coinbase output, mature.\n+    // Update the entry's cached LockPoints if needed. If this returns true, the tx would be invalid\n+    // in the next block, so the mempool must remove this entry and all of its descendants.\n+    const auto filter_final_and_mature = [this, flags=STANDARD_LOCKTIME_VERIFY_FLAGS](CTxMemPool::txiter it)\n         EXCLUSIVE_LOCKS_REQUIRED(m_mempool->cs, ::cs_main) {\n-        bool should_remove = false;\n         AssertLockHeld(m_mempool->cs);\n         AssertLockHeld(::cs_main);\n         const CTransaction& tx = it->GetTx();\n         LockPoints lp = it->GetLockPoints();\n         const bool validLP{TestLockPointValidity(m_chain, lp)};\n         CCoinsViewMemPool view_mempool(&CoinsTip(), *m_mempool);\n-        if (!CheckFinalTx(m_chain.Tip(), tx, flags)\n-            || !CheckSequenceLocks(m_chain.Tip(), view_mempool, tx, flags, &lp, validLP)) {\n-            // Note if CheckSequenceLocks fails the LockPoints may still be invalid\n-            // So it's critical that we remove the tx and not depend on the LockPoints.\n-            should_remove = true;\n-        } else if (it->GetSpendsCoinbase()) {\n+        // The transaction must be final.\n+        if (!CheckFinalTx(m_chain.Tip(), tx, flags)) return true;\n+        // Note if CheckSequenceLocks fails the LockPoints may still be invalid\n+        // So it's critical that we remove the tx and not depend on the LockPoints.\n+        if (!CheckSequenceLocks(m_chain.Tip(), view_mempool, tx, flags, &lp, validLP)) {\n+            return true;\n+        } else if (!validLP) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r772879178",
      "id" : 772879178,
      "in_reply_to_id" : 768873591,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584uETNK",
      "original_commit_id" : "2586226ec20a97f9ab9f3b7eae8a5c7fb6a7806b",
      "original_line" : 370,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 837084631,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/772879178/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-21T07:11:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/772879178",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Sorry for the churn. I had wanted to incorporate the suggestions in #23683 (comment) for the lambda, but I now think it's best saved for a different PR.\r\n\r\nI think it's very important that the comments are updated to clarify what this function is doing. A bug was introduced in this code because the code was unclear, so we should take the opportunity to clarify it to prevent a similar regression being added again.\r\n\r\nThis branch does fix the recent regression, but I think it's significantly worse than the previous version since good tests and clarifying code comments have been removed.",
      "created_at" : "2021-12-21T07:14:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#issuecomment-998529602",
      "id" : 998529602,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23683",
      "node_id" : "IC_kwDOABII5847hFpC",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/998529602/reactions"
      },
      "updated_at" : "2021-12-21T07:14:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/998529602",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.",
      "created_at" : "2021-12-28T11:23:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#issuecomment-1002034913",
      "id" : 1002034913,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23683",
      "node_id" : "IC_kwDOABII5847udbh",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1002034913/reactions"
      },
      "updated_at" : "2021-12-28T11:23:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1002034913",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r776328259"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/776328259"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The removed code is no-op actually. After the `if` statement, `it->GetLockPoints()` returns the same value as `lp`.",
      "commit_id" : "b4adc5ad6769e4a5a6179dfff271cd4c9dc47a5b",
      "created_at" : "2021-12-29T13:33:34Z",
      "diff_hunk" : "@@ -649,10 +639,7 @@ void CTxMemPool::removeForReorg(CChain& chain, std::function<bool(txiter)> check\n     }\n     RemoveStaged(setAllRemoves, false, MemPoolRemovalReason::REORG);\n     for (indexed_transaction_set::const_iterator it = mapTx.begin(); it != mapTx.end(); it++) {\n-        const LockPoints lp{it->GetLockPoints()};\n-        if (!TestLockPointValidity(chain, lp)) {\n-            mapTx.modify(it, update_lock_points(lp));\n-        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r776328259",
      "id" : 776328259,
      "line" : 655,
      "node_id" : "PRRC_kwDOABII584uRdRD",
      "original_commit_id" : "b4adc5ad6769e4a5a6179dfff271cd4c9dc47a5b",
      "original_line" : 655,
      "original_position" : 24,
      "original_start_line" : 652,
      "path" : "src/txmempool.cpp",
      "position" : 24,
      "pull_request_review_id" : 841408330,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/776328259/reactions"
      },
      "side" : "LEFT",
      "start_line" : 652,
      "start_side" : "LEFT",
      "updated_at" : "2021-12-29T13:36:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/776328259",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r776329493"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/776329493"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe drop `update_lock_points` altogether:\r\n```diff\r\ndiff --git a/src/txmempool.h b/src/txmempool.h\r\nindex ba1d381a5..f87ecc9cd 100644\r\n--- a/src/txmempool.h\r\n+++ b/src/txmempool.h\r\n@@ -312,16 +312,6 @@ public:\r\n     }\r\n };\r\n \r\n-struct update_lock_points\r\n-{\r\n-    explicit update_lock_points(const LockPoints& _lp) : lp(_lp) { }\r\n-\r\n-    void operator() (CTxMemPoolEntry &e) { e.UpdateLockPoints(lp); }\r\n-\r\n-private:\r\n-    const LockPoints& lp;\r\n-};\r\n-\r\n // Multi_index tag names\r\n struct descendant_score {};\r\n struct entry_time {};\r\ndiff --git a/src/validation.cpp b/src/validation.cpp\r\nindex 68729e486..a42e1f52a 100644\r\n--- a/src/validation.cpp\r\n+++ b/src/validation.cpp\r\n@@ -379,7 +379,7 @@ void CChainState::MaybeUpdateMempoolForReorg(\r\n             }\r\n         }\r\n         // CheckSequenceLocks updates lp. Update the mempool entry LockPoints.\r\n-        if (!validLP) m_mempool->mapTx.modify(it, update_lock_points(lp));\r\n+        if (!validLP) m_mempool->mapTx.modify(it, [lp](CTxMemPoolEntry& e) { e.UpdateLockPoints(lp); });\r\n         return should_remove;\r\n     };\r\n \r\n```\r\n?",
      "commit_id" : "b4adc5ad6769e4a5a6179dfff271cd4c9dc47a5b",
      "created_at" : "2021-12-29T13:36:35Z",
      "diff_hunk" : "@@ -312,6 +312,16 @@ class CompareTxMemPoolEntryByAncestorFee\n     }\n };\n \n+struct update_lock_points\n+{\n+    explicit update_lock_points(const LockPoints& _lp) : lp(_lp) { }\n+\n+    void operator() (CTxMemPoolEntry &e) { e.UpdateLockPoints(lp); }\n+\n+private:\n+    const LockPoints& lp;\n+};\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#discussion_r776329493",
      "id" : 776329493,
      "line" : 324,
      "node_id" : "PRRC_kwDOABII584uRdkV",
      "original_commit_id" : "b4adc5ad6769e4a5a6179dfff271cd4c9dc47a5b",
      "original_line" : 324,
      "original_position" : 13,
      "original_start_line" : 315,
      "path" : "src/txmempool.h",
      "position" : 13,
      "pull_request_review_id" : 841408330,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23683",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/776329493/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 315,
      "start_side" : "RIGHT",
      "updated_at" : "2021-12-29T13:36:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/776329493",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK b4adc5ad6769e4a5a6179dfff271cd4c9dc47a5b\r\n\r\nBut please do update the comments and add a test in a follow-up.",
      "created_at" : "2021-12-29T15:58:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23683#issuecomment-1002662617",
      "id" : 1002662617,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23683",
      "node_id" : "IC_kwDOABII5847w2rZ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1002662617/reactions"
      },
      "updated_at" : "2021-12-29T15:59:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1002662617",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   }
]
