{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "MEMBER",
   "body" : "This adds an `LTO` option to depends, i.e `make -C depends -j9 LTO=1`, which passes `-flto` when building packages, and automatically configures with `--enable-lto` when doing a build using a depends `CONFIG_SITE`.\r\n\r\nLinux and (native) macOS builds seem to be working as expected. There are currently some Qt related issues when cross-compiling. After a Windows cross-compile, when configuring:\r\n```bash\r\n/usr/bin/x86_64-w64-mingw32-ld: simplewidgets.o (symbol from plugin):(.gnu.linkonce.t._ZN19QAccessibleLineEditD1Ev[_ZThn40_N19QAccessibleLineEditD1Ev]+0x0): multiple definition of `QAccessibleLineEdit::~QAccessibleLineEdit()'; rangecontrols.o (symbol from plugin):(.gnu.linkonce.t._ZN19QAccessibleLineEditD1Ev[_ZThn16_N19QAccessibleLineEditD1Ev]+0x0): first defined here\r\n/usr/bin/x86_64-w64-mingw32-ld: simplewidgets.o (symbol from plugin):(.gnu.linkonce.t._ZN19QAccessibleLineEditD1Ev[_ZThn40_N19QAccessibleLineEditD1Ev]+0x0): multiple definition of `non-virtual thunk to QAccessibleLineEdit::~QAccessibleLineEdit()'; rangecontrols.o (symbol from plugin):(.gnu.linkonce.t._ZN19QAccessibleLineEditD1Ev[_ZThn16_N19QAccessibleLineEditD1Ev]+0x0): first defined here\r\n...\r\nconfigure:24359: result: no\r\nconfigure:24363: WARNING: QWindowsVistaStylePlugin not found.; bitcoin-qt frontend will not be built\r\nconfigure:25626: checking whether to build Bitcoin Core GUI\r\nconfigure:25664: result: no\r\n```\r\n\r\nWhen building Qt during a mac cross-compile:\r\n```bash\r\nfile /home/ubuntu/bitcoin/depends/work/build/x86_64-apple-darwin19/qt/5.12.11-796dbd9560b/qtbase/src/3rdparty/pcre2/pcre2.pro ) && make -f Makefile \r\nmake[4]: Entering directory '/home/ubuntu/bitcoin/depends/work/build/x86_64-apple-darwin19/qt/5.12.11-796dbd9560b/qtbase/src/3rdparty/pcre2'\r\nrm -f ../../../lib/libqtpcre2.a\r\nlibtool -static -o ../../../lib/libqtpcre2.a .obj/pcre2_auto_possess.o .obj/pcre2_chartables.o .obj/pcre2_compile.o .obj/pcre2_config.o .obj/pcre2_context.o .obj/pcre2_dfa_match.o .obj/pcre2_error.o .obj/pcre2_extuni.o .obj/pcre2_find_bracket.o .obj/pcre2_jit_compile.o .obj/pcre2_maketables.o .obj/pcre2_match.o .obj/pcre2_match_data.o .obj/pcre2_newline.o .obj/pcre2_ord2utf.o .obj/pcre2_pattern_info.o .obj/pcre2_script_run.o .obj/pcre2_serialize.o .obj/pcre2_string_utils.o .obj/pcre2_study.o .obj/pcre2_substitute.o .obj/pcre2_substring.o .obj/pcre2_tables.o .obj/pcre2_ucd.o .obj/pcre2_valid_utf.o .obj/pcre2_xclass.o\r\nmake[4]: libtool: Command not found\r\nmake[4]: *** [Makefile:207: ../../../lib/libqtpcre2.a] Error 127\r\nmake[4]: Leaving directory '/home/ubuntu/bitcoin/depends/work/build/x86_64-apple-darwin19/qt/5.12.11-796dbd9560b/qtbase/src/3rdparty/pcre2'\r\nmake[3]: *** [Makefile:197: sub-3rdparty-pcre2-make_first] Error 2\r\n```\r\n\r\nI haven't investigated yet, and it's possible either may be fixed after #23489.\r\n\r\nComparing the size (bytes) of the stripped x86-64 Linux binaries produced with master and this PR. I'm seeing a 10% saving for `bitcoind` and 15% saving for `bitcoin-qt`. \r\n\r\n| Binary | master | master (strip) | LTO | LTO (strip) | saving (strip) |\r\n| ------ | -----: | ----------------: | --: | -------------: | ----------------------------: |\r\n| bitcoin-cli | 1492912 | 1252272 | 568032 | 482104 | 61% |\r\n| bitcoin-tx | 1911464 | 1616400 | 855168 | 723368 | 55% |\r\n| bitcoin-util | 1236240 | 1030640 | 314072 | 256408 | 75% | \r\n| bitcoin-wallet | 7939776 | 6861368 | 4887392 | 4288664 | 37% |\r\n| bitcoind | 14212008 | 12081088 | 12680688 | 10819120 | 10% |\r\n| bitcoin-qt | 41300128 | 35762768 | 34255464 | 30196272 | 15% |\r\n\r\nFor the Linux binaries, `make check` and the functional tests pass. `test/util/test_runner.py` does not.",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 0,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23611/comments",
   "created_at" : "2021-11-27T05:58:05Z",
   "draft" : true,
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23611/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/23611",
   "id" : 1064912882,
   "labels" : [
      {
         "color" : "5319e7",
         "default" : false,
         "description" : null,
         "id" : 61889416,
         "name" : "Build system",
         "node_id" : "MDU6TGFiZWw2MTg4OTQxNg==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Build%20system"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23611/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "PR_kwDOABII584vFJwQ",
   "number" : 23611,
   "performed_via_github_app" : null,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/23611.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23611",
      "merged_at" : null,
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/23611.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23611"
   },
   "reactions" : {
      "+1" : 0,
      "-1" : 0,
      "confused" : 0,
      "eyes" : 0,
      "heart" : 0,
      "hooray" : 0,
      "laugh" : 0,
      "rocket" : 0,
      "total_count" : 0,
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23611/reactions"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "timeline_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23611/timeline",
   "title" : "build: add `LTO` option to depends",
   "updated_at" : "2021-11-27T05:58:05Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23611",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
      "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
      "followers_url" : "https://api.github.com/users/fanquake/followers",
      "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
      "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/fanquake",
      "id" : 863730,
      "login" : "fanquake",
      "node_id" : "MDQ6VXNlcjg2MzczMA==",
      "organizations_url" : "https://api.github.com/users/fanquake/orgs",
      "received_events_url" : "https://api.github.com/users/fanquake/received_events",
      "repos_url" : "https://api.github.com/users/fanquake/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/fanquake"
   }
}
