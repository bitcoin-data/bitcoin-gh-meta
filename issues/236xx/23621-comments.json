[
   {
      "author_association" : "MEMBER",
      "body" : "cc @glozow ",
      "created_at" : "2021-11-29T02:36:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/23621#issuecomment-981238867",
      "id" : 981238867,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23621",
      "node_id" : "IC_kwDOABII5846fIRT",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/981238867/reactions"
      },
      "updated_at" : "2021-11-29T02:36:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/981238867",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "This is a good observation: the `if (stageit->GetCountWithDescendants() + entry_count > limitDescendantCount)` condition will overestimate the descendant count when entry is an in-mempool descendant of the entry in `stageit`. In the 3 cases you've nicely enumerated, this logic is only hit when `CalculateMemPoolAncestors()` is called for an in-mempool entry:\r\n\r\n> CTxMemPool::CalculateMemPoolAncestors invokes it, in the cases where entry is already in the mempool, we have an off-by-one error here https://github.com/bitcoin/bitcoin/blob/master/src/txmempool.cpp#L230 (because stageit->GetCountWithDescendants() will include entry in its count\r\n\r\nIn practice, these calls are always made with ancestor/descendant limits set to `noLimit` (see calls in [miner.cpp](https://github.com/bitcoin/bitcoin/blob/e521c5589e253b1a6631d085b3ac578751883082/src/node/miner.cpp#L403-L405), [mempool removal](https://github.com/bitcoin/bitcoin/blob/master/src/txmempool.cpp#L414), and verify by grepping for `CalculateMemPoolAncestors(... false)`). While this means the \"bug\" never results in a failure due to the overestimation, it is brittle to rely on this caller behavior.\r\n\r\nRe: correctness in `CheckPackageLimits`, `package` will never contain in-mempool entries. It would currently result in a rejected package; in the future, we will de-duplicate and remove already-in-mempool transactiosn from the argument passed in to `CheckPackageLimits()`. If you're curious, see [this assertion](https://github.com/bitcoin/bitcoin/pull/22290/commits/cda84edb0953beb2220621fa517abd6d8f5dc3d9#diff-97c3a52bc5fad452d82670a7fd291800bae20c7bc35bb82686c2c0a4ea7b5b98R958-R960) in the draft implementation.\r\n\r\nThanks for bringing this up @mjdietzx. This is not an issue in practice, but is brittle code that can be patched pretty simply, e.g. by creating separate interfaces/code paths for an in-mempool and outside-mempool entry. We can group it in with a refactor, e.g. making the limits members of txmempool.",
      "created_at" : "2021-11-29T05:12:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/23621#issuecomment-981297925",
      "id" : 981297925,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23621",
      "node_id" : "IC_kwDOABII5846fWsF",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/981297925/reactions"
      },
      "updated_at" : "2021-11-29T05:12:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/981297925",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks, nice write-up @glozow. Agreed on all points. And after reading your comment and double checking codebase I realize that the incorrect case \"case 2\" is not currently hit.\r\n\r\nAnyways I do think the code is brittle and there's room for improvement (I may give it another try making it a little more robust myself) in `CalculateAncestorsAndCheckLimits`. And in a followup to #22698 I may try optimizing `IsRBFOptIn` a bit by putting a hard bound here, where \"case 2\" would be hit:\r\n\r\n```c++\r\npool.CalculateMemPoolAncestors(entry, ancestors, noLimit, noLimit, /* limitDescendantCount= */ MAX_BIP125_REPLACEMENT_CANDIDATES, noLimit, dummy, false);\r\n```\r\n\r\nThere's a little more to it (the optimization), but that just highlights the case where the caller (myself a week ago) encounters some unexpected behavior with `CalculateMemPoolAncestors`",
      "created_at" : "2021-11-29T14:21:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/23621#issuecomment-981679507",
      "id" : 981679507,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23621",
      "node_id" : "IC_kwDOABII5846gz2T",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/981679507/reactions"
      },
      "updated_at" : "2021-11-29T14:21:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/981679507",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Closing this as resolved based on the last couple messages",
      "created_at" : "2022-08-04T09:13:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/23621#issuecomment-1204984722",
      "id" : 1204984722,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23621",
      "node_id" : "IC_kwDOABII585H0puS",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1204984722/reactions"
      },
      "updated_at" : "2022-08-04T09:13:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1204984722",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   }
]
