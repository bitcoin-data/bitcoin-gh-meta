[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #21178 (test: run mempool_reorg.py even with wallet disabled by DariusParvin)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-01-07T19:55:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#issuecomment-756346617",
      "id" : 756346617,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20874",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1NjM0NjYxNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-28T07:55:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/756346617",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554068735"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554068735"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Just curious, is there a reason to generate blocks through the MiniWallet and the TestNode separately?",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-01-08T16:55:36Z",
      "diff_hunk" : "@@ -20,55 +21,44 @@ def set_test_params(self):\n         ]]\n         self.supports_cli = False\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def run_test(self):\n         txouts = gen_return_txouts()\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        node = self.nodes[0]\n+        miniwallet = MiniWallet(node)\n+        relayfee = node.getnetworkinfo()['relayfee']\n \n         self.log.info('Check that mempoolminfee is minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_equal(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n-        txids = []\n-        utxos = create_confirmed_utxos(relayfee, self.nodes[0], 91)\n+        txids=[]\n+        miniwallet.generate(91)\n+        node.generate(100)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554068735",
      "id" : 554068735,
      "line" : 37,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDA2ODczNQ==",
      "original_commit_id" : "543919b4b19b98867b3eebc33b38c87f4fd164a3",
      "original_line" : 37,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "test/functional/mempool_limit.py",
      "position" : 35,
      "pull_request_review_id" : 564423905,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554068735",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/264977?v=4",
         "events_url" : "https://api.github.com/users/joelklabo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/joelklabo/followers",
         "following_url" : "https://api.github.com/users/joelklabo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/joelklabo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/joelklabo",
         "id" : 264977,
         "login" : "joelklabo",
         "node_id" : "MDQ6VXNlcjI2NDk3Nw==",
         "organizations_url" : "https://api.github.com/users/joelklabo/orgs",
         "received_events_url" : "https://api.github.com/users/joelklabo/received_events",
         "repos_url" : "https://api.github.com/users/joelklabo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/joelklabo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/joelklabo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/joelklabo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554073731"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554073731"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "We generate blocks in `MiniWallet` so we have utxos to spend (coinbases). It is helpful to generate 100 blocks on the node separately, so all the utxos in MiniWallet are mature.\r\n\r\nIf we just did, miniwallet.generate(191), only 91 of the utxos in mini wallets utxo set will be mature. And it gets tricky because some miniwallet transactions will now fail (And we don't necessarily know which utxo we are gonna get as mini wallet sorts them by size)",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-01-08T17:03:10Z",
      "diff_hunk" : "@@ -20,55 +21,44 @@ def set_test_params(self):\n         ]]\n         self.supports_cli = False\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def run_test(self):\n         txouts = gen_return_txouts()\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        node = self.nodes[0]\n+        miniwallet = MiniWallet(node)\n+        relayfee = node.getnetworkinfo()['relayfee']\n \n         self.log.info('Check that mempoolminfee is minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_equal(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n-        txids = []\n-        utxos = create_confirmed_utxos(relayfee, self.nodes[0], 91)\n+        txids=[]\n+        miniwallet.generate(91)\n+        node.generate(100)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554073731",
      "id" : 554073731,
      "in_reply_to_id" : 554068735,
      "line" : 37,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDA3MzczMQ==",
      "original_commit_id" : "543919b4b19b98867b3eebc33b38c87f4fd164a3",
      "original_line" : 37,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "test/functional/mempool_limit.py",
      "position" : 35,
      "pull_request_review_id" : 564429452,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554073731",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554079938"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554079938"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Not sure if `relayfee = node.getnetworkinfo()['relayfee']` is needed here anymore. seems like it shouldn't have changed, right?",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-01-08T17:14:44Z",
      "diff_hunk" : "@@ -20,55 +21,44 @@ def set_test_params(self):\n         ]]\n         self.supports_cli = False\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def run_test(self):\n         txouts = gen_return_txouts()\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        node = self.nodes[0]\n+        miniwallet = MiniWallet(node)\n+        relayfee = node.getnetworkinfo()['relayfee']\n \n         self.log.info('Check that mempoolminfee is minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_equal(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n-        txids = []\n-        utxos = create_confirmed_utxos(relayfee, self.nodes[0], 91)\n+        txids=[]\n+        miniwallet.generate(91)\n+        node.generate(100)\n \n         self.log.info('Create a mempool tx that will be evicted')\n-        us0 = utxos.pop()\n-        inputs = [{ \"txid\" : us0[\"txid\"], \"vout\" : us0[\"vout\"]}]\n-        outputs = {self.nodes[0].getnewaddress() : 0.0001}\n-        tx = self.nodes[0].createrawtransaction(inputs, outputs)\n-        self.nodes[0].settxfee(relayfee) # specifically fund this tx with low fee\n-        txF = self.nodes[0].fundrawtransaction(tx)\n-        self.nodes[0].settxfee(0) # return to automatic fee selection\n-        txFS = self.nodes[0].signrawtransactionwithwallet(txF['hex'])\n-        txid = self.nodes[0].sendrawtransaction(txFS['hex'])\n-\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        txid = miniwallet.send_self_transfer(fee_rate = relayfee, from_node = node)['txid']\n+        relayfee = node.getnetworkinfo()['relayfee']",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554079938",
      "id" : 554079938,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDA3OTkzOA==",
      "original_commit_id" : "543919b4b19b98867b3eebc33b38c87f4fd164a3",
      "original_line" : 40,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "test/functional/mempool_limit.py",
      "position" : null,
      "pull_request_review_id" : 564437518,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554079938",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554087398"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554087398"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: might as well fix this type-o `minrelytxfee` => `minrelaytxfee`?",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-01-08T17:28:20Z",
      "diff_hunk" : "@@ -20,55 +21,44 @@ def set_test_params(self):\n         ]]\n         self.supports_cli = False\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def run_test(self):\n         txouts = gen_return_txouts()\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        node = self.nodes[0]\n+        miniwallet = MiniWallet(node)\n+        relayfee = node.getnetworkinfo()['relayfee']\n \n         self.log.info('Check that mempoolminfee is minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_equal(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n-        txids = []\n-        utxos = create_confirmed_utxos(relayfee, self.nodes[0], 91)\n+        txids=[]\n+        miniwallet.generate(91)\n+        node.generate(100)\n \n         self.log.info('Create a mempool tx that will be evicted')\n-        us0 = utxos.pop()\n-        inputs = [{ \"txid\" : us0[\"txid\"], \"vout\" : us0[\"vout\"]}]\n-        outputs = {self.nodes[0].getnewaddress() : 0.0001}\n-        tx = self.nodes[0].createrawtransaction(inputs, outputs)\n-        self.nodes[0].settxfee(relayfee) # specifically fund this tx with low fee\n-        txF = self.nodes[0].fundrawtransaction(tx)\n-        self.nodes[0].settxfee(0) # return to automatic fee selection\n-        txFS = self.nodes[0].signrawtransactionwithwallet(txF['hex'])\n-        txid = self.nodes[0].sendrawtransaction(txFS['hex'])\n-\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        txid = miniwallet.send_self_transfer(fee_rate = relayfee, from_node = node)['txid']\n+        relayfee = node.getnetworkinfo()['relayfee']\n         base_fee = relayfee*100\n         for i in range (3):\n             txids.append([])\n-            txids[i] = create_lots_of_big_transactions(self.nodes[0], txouts, utxos[30*i:30*i+30], 30, (i+1)*base_fee)\n+            txids[i] = self.create_large_transactions(node, txouts, miniwallet, 30, (i+1)*base_fee)\n \n         self.log.info('The tx should be evicted by now')\n-        assert txid not in self.nodes[0].getrawmempool()\n-        txdata = self.nodes[0].gettransaction(txid)\n-        assert txdata['confirmations'] ==  0  #confirmation should still be 0\n+        assert txid not in node.getrawmempool()\n \n         self.log.info('Check that mempoolminfee is larger than minrelytxfee')",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554087398",
      "id" : 554087398,
      "line" : 51,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDA4NzM5OA==",
      "original_commit_id" : "543919b4b19b98867b3eebc33b38c87f4fd164a3",
      "original_line" : 51,
      "original_position" : 62,
      "original_start_line" : null,
      "path" : "test/functional/mempool_limit.py",
      "position" : 65,
      "pull_request_review_id" : 564437518,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554087398",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554090506"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554090506"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: need a space between `if` and `(`. I think our linter won't even want the parenthesis (superfluous parenthesis). Really, why not just do: `if big_txouts:` ... `else:`",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-01-08T17:34:17Z",
      "diff_hunk" : "@@ -77,3 +77,30 @@ def send_self_transfer(self, *, fee_rate=Decimal(\"0.003\"), from_node, utxo_to_sp\n         assert_equal(tx_info['vsize'], vsize)\n         assert_equal(tx_info['fee'], fee)\n         return {'txid': txid, 'wtxid': tx_info['wtxid'], 'hex': tx_hex}\n+\n+    def send_multi_self_transfer(self, *, fee_rate=Decimal(\"0.03\"), from_node, utxo_to_spend=None, big_txouts=None):\n+        \"\"\"Create multiple tx with the specified fee_rate. Fee may be exact or at most one satoshi higher than needed.\"\"\"\n+        self._utxos = sorted(self._utxos, key=lambda k: k['value'])\n+        utxo_to_spend = utxo_to_spend or self._utxos.pop() # Pick the largest utxo (if none provided) and hope it covers the fee\n+        send_value = satoshi_round(utxo_to_spend['value'] - fee_rate)\n+        fee = utxo_to_spend['value'] - send_value\n+        assert send_value > 0\n+\n+        tx = CTransaction()\n+        tx.vin = [CTxIn(COutPoint(int(utxo_to_spend['txid'], 16), utxo_to_spend['vout']))]\n+        tx.vout = [CTxOut(int(send_value * COIN), self._scriptPubKey)]\n+        tx.wit.vtxinwit = [CTxInWitness()]\n+        tx.wit.vtxinwit[0].scriptWitness.stack = [CScript([OP_TRUE])]\n+        tx_hex = tx.serialize().hex()\n+\n+        if(big_txouts is not None):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554090506",
      "id" : 554090506,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDA5MDUwNg==",
      "original_commit_id" : "543919b4b19b98867b3eebc33b38c87f4fd164a3",
      "original_line" : 96,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/wallet.py",
      "position" : null,
      "pull_request_review_id" : 564437518,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554090506",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554092198"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554092198"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: `tx.vout.extend(big_txouts)` would have the same behavior and get rid of a loop",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-01-08T17:37:37Z",
      "diff_hunk" : "@@ -77,3 +77,30 @@ def send_self_transfer(self, *, fee_rate=Decimal(\"0.003\"), from_node, utxo_to_sp\n         assert_equal(tx_info['vsize'], vsize)\n         assert_equal(tx_info['fee'], fee)\n         return {'txid': txid, 'wtxid': tx_info['wtxid'], 'hex': tx_hex}\n+\n+    def send_multi_self_transfer(self, *, fee_rate=Decimal(\"0.03\"), from_node, utxo_to_spend=None, big_txouts=None):\n+        \"\"\"Create multiple tx with the specified fee_rate. Fee may be exact or at most one satoshi higher than needed.\"\"\"\n+        self._utxos = sorted(self._utxos, key=lambda k: k['value'])\n+        utxo_to_spend = utxo_to_spend or self._utxos.pop() # Pick the largest utxo (if none provided) and hope it covers the fee\n+        send_value = satoshi_round(utxo_to_spend['value'] - fee_rate)\n+        fee = utxo_to_spend['value'] - send_value\n+        assert send_value > 0\n+\n+        tx = CTransaction()\n+        tx.vin = [CTxIn(COutPoint(int(utxo_to_spend['txid'], 16), utxo_to_spend['vout']))]\n+        tx.vout = [CTxOut(int(send_value * COIN), self._scriptPubKey)]\n+        tx.wit.vtxinwit = [CTxInWitness()]\n+        tx.wit.vtxinwit[0].scriptWitness.stack = [CScript([OP_TRUE])]\n+        tx_hex = tx.serialize().hex()\n+\n+        if(big_txouts is not None):\n+            for txout in big_txouts:\n+                tx.vout.append(txout)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554092198",
      "id" : 554092198,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDA5MjE5OA==",
      "original_commit_id" : "543919b4b19b98867b3eebc33b38c87f4fd164a3",
      "original_line" : 98,
      "original_position" : 22,
      "original_start_line" : 97,
      "path" : "test/functional/test_framework/wallet.py",
      "position" : null,
      "pull_request_review_id" : 564437518,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554092198",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554093130"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554093130"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Do we even want this `else` condition? I would think `big_txouts` should be a required param. Otherwise this branch seems to just duplicate `send_self_transfer`",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-01-08T17:39:28Z",
      "diff_hunk" : "@@ -77,3 +77,30 @@ def send_self_transfer(self, *, fee_rate=Decimal(\"0.003\"), from_node, utxo_to_sp\n         assert_equal(tx_info['vsize'], vsize)\n         assert_equal(tx_info['fee'], fee)\n         return {'txid': txid, 'wtxid': tx_info['wtxid'], 'hex': tx_hex}\n+\n+    def send_multi_self_transfer(self, *, fee_rate=Decimal(\"0.03\"), from_node, utxo_to_spend=None, big_txouts=None):\n+        \"\"\"Create multiple tx with the specified fee_rate. Fee may be exact or at most one satoshi higher than needed.\"\"\"\n+        self._utxos = sorted(self._utxos, key=lambda k: k['value'])\n+        utxo_to_spend = utxo_to_spend or self._utxos.pop() # Pick the largest utxo (if none provided) and hope it covers the fee\n+        send_value = satoshi_round(utxo_to_spend['value'] - fee_rate)\n+        fee = utxo_to_spend['value'] - send_value\n+        assert send_value > 0\n+\n+        tx = CTransaction()\n+        tx.vin = [CTxIn(COutPoint(int(utxo_to_spend['txid'], 16), utxo_to_spend['vout']))]\n+        tx.vout = [CTxOut(int(send_value * COIN), self._scriptPubKey)]\n+        tx.wit.vtxinwit = [CTxInWitness()]\n+        tx.wit.vtxinwit[0].scriptWitness.stack = [CScript([OP_TRUE])]\n+        tx_hex = tx.serialize().hex()\n+\n+        if(big_txouts is not None):\n+            for txout in big_txouts:\n+                tx.vout.append(txout)\n+            tx_hex = tx.serialize().hex()\n+            txid = from_node.sendrawtransaction(tx_hex, 0)\n+        else:\n+            txid = from_node.sendrawtransaction(tx_hex)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554093130",
      "id" : 554093130,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDA5MzEzMA==",
      "original_commit_id" : "543919b4b19b98867b3eebc33b38c87f4fd164a3",
      "original_line" : 102,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/wallet.py",
      "position" : null,
      "pull_request_review_id" : 564437518,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554093130",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554102596"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554102596"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`fee_rate` seems to be a confusing param name. As this is now just the absolute `fee`, right? ",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-01-08T17:57:42Z",
      "diff_hunk" : "@@ -77,3 +77,30 @@ def send_self_transfer(self, *, fee_rate=Decimal(\"0.003\"), from_node, utxo_to_sp\n         assert_equal(tx_info['vsize'], vsize)\n         assert_equal(tx_info['fee'], fee)\n         return {'txid': txid, 'wtxid': tx_info['wtxid'], 'hex': tx_hex}\n+\n+    def send_multi_self_transfer(self, *, fee_rate=Decimal(\"0.03\"), from_node, utxo_to_spend=None, big_txouts=None):\n+        \"\"\"Create multiple tx with the specified fee_rate. Fee may be exact or at most one satoshi higher than needed.\"\"\"\n+        self._utxos = sorted(self._utxos, key=lambda k: k['value'])\n+        utxo_to_spend = utxo_to_spend or self._utxos.pop() # Pick the largest utxo (if none provided) and hope it covers the fee\n+        send_value = satoshi_round(utxo_to_spend['value'] - fee_rate)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554102596",
      "id" : 554102596,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDEwMjU5Ng==",
      "original_commit_id" : "543919b4b19b98867b3eebc33b38c87f4fd164a3",
      "original_line" : 85,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/wallet.py",
      "position" : null,
      "pull_request_review_id" : 564437518,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554102596",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554108817"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554108817"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm not sure this method name is ideal? I was expecting multiple txns, but I guess this sends one big transaction? I'm not sure `send_big_self_transfer` would be better, but just want to double check on naming here",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-01-08T18:10:28Z",
      "diff_hunk" : "@@ -77,3 +77,30 @@ def send_self_transfer(self, *, fee_rate=Decimal(\"0.003\"), from_node, utxo_to_sp\n         assert_equal(tx_info['vsize'], vsize)\n         assert_equal(tx_info['fee'], fee)\n         return {'txid': txid, 'wtxid': tx_info['wtxid'], 'hex': tx_hex}\n+\n+    def send_multi_self_transfer(self, *, fee_rate=Decimal(\"0.03\"), from_node, utxo_to_spend=None, big_txouts=None):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554108817",
      "id" : 554108817,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDEwODgxNw==",
      "original_commit_id" : "543919b4b19b98867b3eebc33b38c87f4fd164a3",
      "original_line" : 81,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/wallet.py",
      "position" : null,
      "pull_request_review_id" : 564437518,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554108817",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554110427"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554110427"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I know this is existing behavior. But I'ma little confused because `txids` aren't used. Should we be checking these are in the mempool?",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-01-08T18:13:42Z",
      "diff_hunk" : "@@ -20,55 +21,44 @@ def set_test_params(self):\n         ]]\n         self.supports_cli = False\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def run_test(self):\n         txouts = gen_return_txouts()\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        node = self.nodes[0]\n+        miniwallet = MiniWallet(node)\n+        relayfee = node.getnetworkinfo()['relayfee']\n \n         self.log.info('Check that mempoolminfee is minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_equal(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n-        txids = []\n-        utxos = create_confirmed_utxos(relayfee, self.nodes[0], 91)\n+        txids=[]\n+        miniwallet.generate(91)\n+        node.generate(100)\n \n         self.log.info('Create a mempool tx that will be evicted')\n-        us0 = utxos.pop()\n-        inputs = [{ \"txid\" : us0[\"txid\"], \"vout\" : us0[\"vout\"]}]\n-        outputs = {self.nodes[0].getnewaddress() : 0.0001}\n-        tx = self.nodes[0].createrawtransaction(inputs, outputs)\n-        self.nodes[0].settxfee(relayfee) # specifically fund this tx with low fee\n-        txF = self.nodes[0].fundrawtransaction(tx)\n-        self.nodes[0].settxfee(0) # return to automatic fee selection\n-        txFS = self.nodes[0].signrawtransactionwithwallet(txF['hex'])\n-        txid = self.nodes[0].sendrawtransaction(txFS['hex'])\n-\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        txid = miniwallet.send_self_transfer(fee_rate = relayfee, from_node = node)['txid']\n+        relayfee = node.getnetworkinfo()['relayfee']\n         base_fee = relayfee*100\n         for i in range (3):\n             txids.append([])\n-            txids[i] = create_lots_of_big_transactions(self.nodes[0], txouts, utxos[30*i:30*i+30], 30, (i+1)*base_fee)\n+            txids[i] = self.create_large_transactions(node, txouts, miniwallet, 30, (i+1)*base_fee)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554110427",
      "id" : 554110427,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDExMDQyNw==",
      "original_commit_id" : "543919b4b19b98867b3eebc33b38c87f4fd164a3",
      "original_line" : 45,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "test/functional/mempool_limit.py",
      "position" : null,
      "pull_request_review_id" : 564437518,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554110427",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554112536"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554112536"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Is there a need to grab a specific utxo here? I would think you can just let miniwallet pick it, and do:\r\n\r\n`assert_raises_rpc_error(-26, \"mempool min fee not met\", miniwallet.send_self_transfer, from_node=node, fee_rate=relayfee)`",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-01-08T18:17:50Z",
      "diff_hunk" : "@@ -20,55 +21,44 @@ def set_test_params(self):\n         ]]\n         self.supports_cli = False\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def run_test(self):\n         txouts = gen_return_txouts()\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        node = self.nodes[0]\n+        miniwallet = MiniWallet(node)\n+        relayfee = node.getnetworkinfo()['relayfee']\n \n         self.log.info('Check that mempoolminfee is minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_equal(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n-        txids = []\n-        utxos = create_confirmed_utxos(relayfee, self.nodes[0], 91)\n+        txids=[]\n+        miniwallet.generate(91)\n+        node.generate(100)\n \n         self.log.info('Create a mempool tx that will be evicted')\n-        us0 = utxos.pop()\n-        inputs = [{ \"txid\" : us0[\"txid\"], \"vout\" : us0[\"vout\"]}]\n-        outputs = {self.nodes[0].getnewaddress() : 0.0001}\n-        tx = self.nodes[0].createrawtransaction(inputs, outputs)\n-        self.nodes[0].settxfee(relayfee) # specifically fund this tx with low fee\n-        txF = self.nodes[0].fundrawtransaction(tx)\n-        self.nodes[0].settxfee(0) # return to automatic fee selection\n-        txFS = self.nodes[0].signrawtransactionwithwallet(txF['hex'])\n-        txid = self.nodes[0].sendrawtransaction(txFS['hex'])\n-\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        txid = miniwallet.send_self_transfer(fee_rate = relayfee, from_node = node)['txid']\n+        relayfee = node.getnetworkinfo()['relayfee']\n         base_fee = relayfee*100\n         for i in range (3):\n             txids.append([])\n-            txids[i] = create_lots_of_big_transactions(self.nodes[0], txouts, utxos[30*i:30*i+30], 30, (i+1)*base_fee)\n+            txids[i] = self.create_large_transactions(node, txouts, miniwallet, 30, (i+1)*base_fee)\n \n         self.log.info('The tx should be evicted by now')\n-        assert txid not in self.nodes[0].getrawmempool()\n-        txdata = self.nodes[0].gettransaction(txid)\n-        assert txdata['confirmations'] ==  0  #confirmation should still be 0\n+        assert txid not in node.getrawmempool()\n \n         self.log.info('Check that mempoolminfee is larger than minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_greater_than(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_greater_than(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n         self.log.info('Create a mempool tx that will not pass mempoolminfee')\n-        us0 = utxos.pop()\n-        inputs = [{ \"txid\" : us0[\"txid\"], \"vout\" : us0[\"vout\"]}]\n-        outputs = {self.nodes[0].getnewaddress() : 0.0001}\n-        tx = self.nodes[0].createrawtransaction(inputs, outputs)\n-        # specifically fund this tx with a fee < mempoolminfee, >= than minrelaytxfee\n-        txF = self.nodes[0].fundrawtransaction(tx, {'feeRate': relayfee})\n-        txFS = self.nodes[0].signrawtransactionwithwallet(txF['hex'])\n-        assert_raises_rpc_error(-26, \"mempool min fee not met\", self.nodes[0].sendrawtransaction, txFS['hex'])\n+        insufficient_fee_utxo = miniwallet.get_utxo()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554112536",
      "id" : 554112536,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDExMjUzNg==",
      "original_commit_id" : "543919b4b19b98867b3eebc33b38c87f4fd164a3",
      "original_line" : 54,
      "original_position" : 77,
      "original_start_line" : null,
      "path" : "test/functional/mempool_limit.py",
      "position" : null,
      "pull_request_review_id" : 564437518,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554112536",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554115491"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554115491"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think there is some confusing behavior here. bc you generate 91 utxos, then spend 1, spend 3*30, and are now spending again (so this won't spend a Coinbase, rather it'll spend one of our previous transactions).\r\n\r\nAnd bc you explicitly `get_utxo` you are going to get the utxo from last transaction from `create_large_transactions` . Whereas if you let MiniWallet pick, it'd sort the utxo set by value, and you'd probably get the transaction that was evicted from the mempool since it had the lowest fee. idk what would happen in that case, very confusing to me.\r\n\r\nAnyways, maybe you just want to generate 92 utxos at the get-go?",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-01-08T18:23:45Z",
      "diff_hunk" : "@@ -20,55 +21,44 @@ def set_test_params(self):\n         ]]\n         self.supports_cli = False\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def run_test(self):\n         txouts = gen_return_txouts()\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        node = self.nodes[0]\n+        miniwallet = MiniWallet(node)\n+        relayfee = node.getnetworkinfo()['relayfee']\n \n         self.log.info('Check that mempoolminfee is minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_equal(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n-        txids = []\n-        utxos = create_confirmed_utxos(relayfee, self.nodes[0], 91)\n+        txids=[]\n+        miniwallet.generate(91)\n+        node.generate(100)\n \n         self.log.info('Create a mempool tx that will be evicted')\n-        us0 = utxos.pop()\n-        inputs = [{ \"txid\" : us0[\"txid\"], \"vout\" : us0[\"vout\"]}]\n-        outputs = {self.nodes[0].getnewaddress() : 0.0001}\n-        tx = self.nodes[0].createrawtransaction(inputs, outputs)\n-        self.nodes[0].settxfee(relayfee) # specifically fund this tx with low fee\n-        txF = self.nodes[0].fundrawtransaction(tx)\n-        self.nodes[0].settxfee(0) # return to automatic fee selection\n-        txFS = self.nodes[0].signrawtransactionwithwallet(txF['hex'])\n-        txid = self.nodes[0].sendrawtransaction(txFS['hex'])\n-\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        txid = miniwallet.send_self_transfer(fee_rate = relayfee, from_node = node)['txid']\n+        relayfee = node.getnetworkinfo()['relayfee']\n         base_fee = relayfee*100\n         for i in range (3):\n             txids.append([])\n-            txids[i] = create_lots_of_big_transactions(self.nodes[0], txouts, utxos[30*i:30*i+30], 30, (i+1)*base_fee)\n+            txids[i] = self.create_large_transactions(node, txouts, miniwallet, 30, (i+1)*base_fee)\n \n         self.log.info('The tx should be evicted by now')\n-        assert txid not in self.nodes[0].getrawmempool()\n-        txdata = self.nodes[0].gettransaction(txid)\n-        assert txdata['confirmations'] ==  0  #confirmation should still be 0\n+        assert txid not in node.getrawmempool()\n \n         self.log.info('Check that mempoolminfee is larger than minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_greater_than(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_greater_than(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n         self.log.info('Create a mempool tx that will not pass mempoolminfee')\n-        us0 = utxos.pop()\n-        inputs = [{ \"txid\" : us0[\"txid\"], \"vout\" : us0[\"vout\"]}]\n-        outputs = {self.nodes[0].getnewaddress() : 0.0001}\n-        tx = self.nodes[0].createrawtransaction(inputs, outputs)\n-        # specifically fund this tx with a fee < mempoolminfee, >= than minrelaytxfee\n-        txF = self.nodes[0].fundrawtransaction(tx, {'feeRate': relayfee})\n-        txFS = self.nodes[0].signrawtransactionwithwallet(txF['hex'])\n-        assert_raises_rpc_error(-26, \"mempool min fee not met\", self.nodes[0].sendrawtransaction, txFS['hex'])\n+        insufficient_fee_utxo = miniwallet.get_utxo()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554115491",
      "id" : 554115491,
      "in_reply_to_id" : 554112536,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDExNTQ5MQ==",
      "original_commit_id" : "543919b4b19b98867b3eebc33b38c87f4fd164a3",
      "original_line" : 54,
      "original_position" : 77,
      "original_start_line" : null,
      "path" : "test/functional/mempool_limit.py",
      "position" : null,
      "pull_request_review_id" : 564437518,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554115491",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554117463"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554117463"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Just want to confirm that we no longer need a `vsize` assertion. I guess we don't know the `vsize` or don't care since we are passing an absolute fee and not calculating the fee based on vsize*fee_rate?",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-01-08T18:27:25Z",
      "diff_hunk" : "@@ -77,3 +77,30 @@ def send_self_transfer(self, *, fee_rate=Decimal(\"0.003\"), from_node, utxo_to_sp\n         assert_equal(tx_info['vsize'], vsize)\n         assert_equal(tx_info['fee'], fee)\n         return {'txid': txid, 'wtxid': tx_info['wtxid'], 'hex': tx_hex}\n+\n+    def send_multi_self_transfer(self, *, fee_rate=Decimal(\"0.03\"), from_node, utxo_to_spend=None, big_txouts=None):\n+        \"\"\"Create multiple tx with the specified fee_rate. Fee may be exact or at most one satoshi higher than needed.\"\"\"\n+        self._utxos = sorted(self._utxos, key=lambda k: k['value'])\n+        utxo_to_spend = utxo_to_spend or self._utxos.pop() # Pick the largest utxo (if none provided) and hope it covers the fee\n+        send_value = satoshi_round(utxo_to_spend['value'] - fee_rate)\n+        fee = utxo_to_spend['value'] - send_value\n+        assert send_value > 0\n+\n+        tx = CTransaction()\n+        tx.vin = [CTxIn(COutPoint(int(utxo_to_spend['txid'], 16), utxo_to_spend['vout']))]\n+        tx.vout = [CTxOut(int(send_value * COIN), self._scriptPubKey)]\n+        tx.wit.vtxinwit = [CTxInWitness()]\n+        tx.wit.vtxinwit[0].scriptWitness.stack = [CScript([OP_TRUE])]\n+        tx_hex = tx.serialize().hex()\n+\n+        if(big_txouts is not None):\n+            for txout in big_txouts:\n+                tx.vout.append(txout)\n+            tx_hex = tx.serialize().hex()\n+            txid = from_node.sendrawtransaction(tx_hex, 0)\n+        else:\n+            txid = from_node.sendrawtransaction(tx_hex)\n+        self._utxos.append({'txid': txid, 'vout': 0, 'value': send_value})\n+        tx_info = from_node.getmempoolentry(txid)\n+        assert_equal(tx_info['fee'], fee)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554117463",
      "id" : 554117463,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDExNzQ2Mw==",
      "original_commit_id" : "543919b4b19b98867b3eebc33b38c87f4fd164a3",
      "original_line" : 99,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/wallet.py",
      "position" : null,
      "pull_request_review_id" : 564437518,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554117463",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554276038"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554276038"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm not very sure about that too. I just followed the existing behavior and kept it there. If it really serves no purpose, i can either get rid of it or add a test case to check those txs in the mempool",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-01-09T02:11:37Z",
      "diff_hunk" : "@@ -20,55 +21,44 @@ def set_test_params(self):\n         ]]\n         self.supports_cli = False\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def run_test(self):\n         txouts = gen_return_txouts()\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        node = self.nodes[0]\n+        miniwallet = MiniWallet(node)\n+        relayfee = node.getnetworkinfo()['relayfee']\n \n         self.log.info('Check that mempoolminfee is minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_equal(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n-        txids = []\n-        utxos = create_confirmed_utxos(relayfee, self.nodes[0], 91)\n+        txids=[]\n+        miniwallet.generate(91)\n+        node.generate(100)\n \n         self.log.info('Create a mempool tx that will be evicted')\n-        us0 = utxos.pop()\n-        inputs = [{ \"txid\" : us0[\"txid\"], \"vout\" : us0[\"vout\"]}]\n-        outputs = {self.nodes[0].getnewaddress() : 0.0001}\n-        tx = self.nodes[0].createrawtransaction(inputs, outputs)\n-        self.nodes[0].settxfee(relayfee) # specifically fund this tx with low fee\n-        txF = self.nodes[0].fundrawtransaction(tx)\n-        self.nodes[0].settxfee(0) # return to automatic fee selection\n-        txFS = self.nodes[0].signrawtransactionwithwallet(txF['hex'])\n-        txid = self.nodes[0].sendrawtransaction(txFS['hex'])\n-\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        txid = miniwallet.send_self_transfer(fee_rate = relayfee, from_node = node)['txid']\n+        relayfee = node.getnetworkinfo()['relayfee']\n         base_fee = relayfee*100\n         for i in range (3):\n             txids.append([])\n-            txids[i] = create_lots_of_big_transactions(self.nodes[0], txouts, utxos[30*i:30*i+30], 30, (i+1)*base_fee)\n+            txids[i] = self.create_large_transactions(node, txouts, miniwallet, 30, (i+1)*base_fee)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554276038",
      "id" : 554276038,
      "in_reply_to_id" : 554110427,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDI3NjAzOA==",
      "original_commit_id" : "543919b4b19b98867b3eebc33b38c87f4fd164a3",
      "original_line" : 45,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "test/functional/mempool_limit.py",
      "position" : null,
      "pull_request_review_id" : 564675030,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554276038",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/26356227?v=4",
         "events_url" : "https://api.github.com/users/stackman27/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stackman27/followers",
         "following_url" : "https://api.github.com/users/stackman27/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stackman27/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stackman27",
         "id" : 26356227,
         "login" : "stackman27",
         "node_id" : "MDQ6VXNlcjI2MzU2MjI3",
         "organizations_url" : "https://api.github.com/users/stackman27/orgs",
         "received_events_url" : "https://api.github.com/users/stackman27/received_events",
         "repos_url" : "https://api.github.com/users/stackman27/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stackman27/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stackman27/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stackman27"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554279481"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554279481"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes thats what i realized. Also the `vsize` changed (from 96 to 67552) while making big txs  and therefore checking it with a constant value of 96 didn't really make sense. I can however, add an assertion to check big tx `vsize` since they're all the same. Do you recommend? ",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-01-09T02:44:51Z",
      "diff_hunk" : "@@ -77,3 +77,30 @@ def send_self_transfer(self, *, fee_rate=Decimal(\"0.003\"), from_node, utxo_to_sp\n         assert_equal(tx_info['vsize'], vsize)\n         assert_equal(tx_info['fee'], fee)\n         return {'txid': txid, 'wtxid': tx_info['wtxid'], 'hex': tx_hex}\n+\n+    def send_multi_self_transfer(self, *, fee_rate=Decimal(\"0.03\"), from_node, utxo_to_spend=None, big_txouts=None):\n+        \"\"\"Create multiple tx with the specified fee_rate. Fee may be exact or at most one satoshi higher than needed.\"\"\"\n+        self._utxos = sorted(self._utxos, key=lambda k: k['value'])\n+        utxo_to_spend = utxo_to_spend or self._utxos.pop() # Pick the largest utxo (if none provided) and hope it covers the fee\n+        send_value = satoshi_round(utxo_to_spend['value'] - fee_rate)\n+        fee = utxo_to_spend['value'] - send_value\n+        assert send_value > 0\n+\n+        tx = CTransaction()\n+        tx.vin = [CTxIn(COutPoint(int(utxo_to_spend['txid'], 16), utxo_to_spend['vout']))]\n+        tx.vout = [CTxOut(int(send_value * COIN), self._scriptPubKey)]\n+        tx.wit.vtxinwit = [CTxInWitness()]\n+        tx.wit.vtxinwit[0].scriptWitness.stack = [CScript([OP_TRUE])]\n+        tx_hex = tx.serialize().hex()\n+\n+        if(big_txouts is not None):\n+            for txout in big_txouts:\n+                tx.vout.append(txout)\n+            tx_hex = tx.serialize().hex()\n+            txid = from_node.sendrawtransaction(tx_hex, 0)\n+        else:\n+            txid = from_node.sendrawtransaction(tx_hex)\n+        self._utxos.append({'txid': txid, 'vout': 0, 'value': send_value})\n+        tx_info = from_node.getmempoolentry(txid)\n+        assert_equal(tx_info['fee'], fee)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554279481",
      "id" : 554279481,
      "in_reply_to_id" : 554117463,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDI3OTQ4MQ==",
      "original_commit_id" : "543919b4b19b98867b3eebc33b38c87f4fd164a3",
      "original_line" : 99,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/wallet.py",
      "position" : null,
      "pull_request_review_id" : 564677460,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554279481",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/26356227?v=4",
         "events_url" : "https://api.github.com/users/stackman27/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stackman27/followers",
         "following_url" : "https://api.github.com/users/stackman27/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stackman27/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stackman27",
         "id" : 26356227,
         "login" : "stackman27",
         "node_id" : "MDQ6VXNlcjI2MzU2MjI3",
         "organizations_url" : "https://api.github.com/users/stackman27/orgs",
         "received_events_url" : "https://api.github.com/users/stackman27/received_events",
         "repos_url" : "https://api.github.com/users/stackman27/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stackman27/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stackman27/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stackman27"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554280046"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554280046"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "@joelklabo I used the previous `miniWallet` tests as reference to generate utxos like the one done here  https://github.com/bitcoin/bitcoin/pull/20688/files  ",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-01-09T02:50:06Z",
      "diff_hunk" : "@@ -20,55 +21,44 @@ def set_test_params(self):\n         ]]\n         self.supports_cli = False\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def run_test(self):\n         txouts = gen_return_txouts()\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        node = self.nodes[0]\n+        miniwallet = MiniWallet(node)\n+        relayfee = node.getnetworkinfo()['relayfee']\n \n         self.log.info('Check that mempoolminfee is minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_equal(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n-        txids = []\n-        utxos = create_confirmed_utxos(relayfee, self.nodes[0], 91)\n+        txids=[]\n+        miniwallet.generate(91)\n+        node.generate(100)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554280046",
      "id" : 554280046,
      "in_reply_to_id" : 554068735,
      "line" : 37,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDI4MDA0Ng==",
      "original_commit_id" : "543919b4b19b98867b3eebc33b38c87f4fd164a3",
      "original_line" : 37,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "test/functional/mempool_limit.py",
      "position" : 35,
      "pull_request_review_id" : 564677817,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554280046",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/26356227?v=4",
         "events_url" : "https://api.github.com/users/stackman27/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stackman27/followers",
         "following_url" : "https://api.github.com/users/stackman27/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stackman27/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stackman27",
         "id" : 26356227,
         "login" : "stackman27",
         "node_id" : "MDQ6VXNlcjI2MzU2MjI3",
         "organizations_url" : "https://api.github.com/users/stackman27/orgs",
         "received_events_url" : "https://api.github.com/users/stackman27/received_events",
         "repos_url" : "https://api.github.com/users/stackman27/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stackman27/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stackman27/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stackman27"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@mjdietzx Thank you very much for the review. I just pushed an update shortening the methods in `miniwallet` class by adding `prepare_tx` and also resolved most of your comments ",
      "created_at" : "2021-01-09T02:52:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#issuecomment-757083465",
      "id" : 757083465,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20874",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1NzA4MzQ2NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-09T02:57:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/757083465",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/26356227?v=4",
         "events_url" : "https://api.github.com/users/stackman27/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stackman27/followers",
         "following_url" : "https://api.github.com/users/stackman27/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stackman27/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stackman27",
         "id" : 26356227,
         "login" : "stackman27",
         "node_id" : "MDQ6VXNlcjI2MzU2MjI3",
         "organizations_url" : "https://api.github.com/users/stackman27/orgs",
         "received_events_url" : "https://api.github.com/users/stackman27/received_events",
         "repos_url" : "https://api.github.com/users/stackman27/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stackman27/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stackman27/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stackman27"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554296055"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554296055"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Great, thanks been confused about that for a bit. I'll check it out!",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-01-09T05:48:28Z",
      "diff_hunk" : "@@ -20,55 +21,44 @@ def set_test_params(self):\n         ]]\n         self.supports_cli = False\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def run_test(self):\n         txouts = gen_return_txouts()\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        node = self.nodes[0]\n+        miniwallet = MiniWallet(node)\n+        relayfee = node.getnetworkinfo()['relayfee']\n \n         self.log.info('Check that mempoolminfee is minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_equal(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n-        txids = []\n-        utxos = create_confirmed_utxos(relayfee, self.nodes[0], 91)\n+        txids=[]\n+        miniwallet.generate(91)\n+        node.generate(100)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554296055",
      "id" : 554296055,
      "in_reply_to_id" : 554068735,
      "line" : 37,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDI5NjA1NQ==",
      "original_commit_id" : "543919b4b19b98867b3eebc33b38c87f4fd164a3",
      "original_line" : 37,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "test/functional/mempool_limit.py",
      "position" : 35,
      "pull_request_review_id" : 564686877,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554296055",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/264977?v=4",
         "events_url" : "https://api.github.com/users/joelklabo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/joelklabo/followers",
         "following_url" : "https://api.github.com/users/joelklabo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/joelklabo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/joelklabo",
         "id" : 264977,
         "login" : "joelklabo",
         "node_id" : "MDQ6VXNlcjI2NDk3Nw==",
         "organizations_url" : "https://api.github.com/users/joelklabo/orgs",
         "received_events_url" : "https://api.github.com/users/joelklabo/received_events",
         "repos_url" : "https://api.github.com/users/joelklabo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/joelklabo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/joelklabo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/joelklabo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554611793"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554611793"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "if you wanted to be \"cool\" you could do:\r\n```python\r\nreturn map(lambda: miniwallet.send_big_self_transfer(from_node=node, big_txouts=txouts, fee=fee)['txid'], range(num))\r\n```",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-01-10T19:29:32Z",
      "diff_hunk" : "@@ -20,55 +21,43 @@ def set_test_params(self):\n         ]]\n         self.supports_cli = False\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def run_test(self):\n         txouts = gen_return_txouts()\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        node = self.nodes[0]\n+        miniwallet = MiniWallet(node)\n+        relayfee = node.getnetworkinfo()['relayfee']\n \n         self.log.info('Check that mempoolminfee is minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_equal(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n-        txids = []\n-        utxos = create_confirmed_utxos(relayfee, self.nodes[0], 91)\n+        txids=[]\n+        miniwallet.generate(92)\n+        node.generate(100)\n \n         self.log.info('Create a mempool tx that will be evicted')\n-        us0 = utxos.pop()\n-        inputs = [{ \"txid\" : us0[\"txid\"], \"vout\" : us0[\"vout\"]}]\n-        outputs = {self.nodes[0].getnewaddress() : 0.0001}\n-        tx = self.nodes[0].createrawtransaction(inputs, outputs)\n-        self.nodes[0].settxfee(relayfee) # specifically fund this tx with low fee\n-        txF = self.nodes[0].fundrawtransaction(tx)\n-        self.nodes[0].settxfee(0) # return to automatic fee selection\n-        txFS = self.nodes[0].signrawtransactionwithwallet(txF['hex'])\n-        txid = self.nodes[0].sendrawtransaction(txFS['hex'])\n+        txid = miniwallet.send_self_transfer(fee_rate = relayfee, from_node = node)['txid']\n \n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n         base_fee = relayfee*100\n         for i in range (3):\n             txids.append([])\n-            txids[i] = create_lots_of_big_transactions(self.nodes[0], txouts, utxos[30*i:30*i+30], 30, (i+1)*base_fee)\n+            txids[i] = self.create_large_transactions(node, txouts, miniwallet, 30, (i+1)*base_fee)\n \n         self.log.info('The tx should be evicted by now')\n-        assert txid not in self.nodes[0].getrawmempool()\n-        txdata = self.nodes[0].gettransaction(txid)\n-        assert txdata['confirmations'] ==  0  #confirmation should still be 0\n+        assert txid not in node.getrawmempool()\n \n         self.log.info('Check that mempoolminfee is larger than minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_greater_than(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_greater_than(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n         self.log.info('Create a mempool tx that will not pass mempoolminfee')\n-        us0 = utxos.pop()\n-        inputs = [{ \"txid\" : us0[\"txid\"], \"vout\" : us0[\"vout\"]}]\n-        outputs = {self.nodes[0].getnewaddress() : 0.0001}\n-        tx = self.nodes[0].createrawtransaction(inputs, outputs)\n-        # specifically fund this tx with a fee < mempoolminfee, >= than minrelaytxfee\n-        txF = self.nodes[0].fundrawtransaction(tx, {'feeRate': relayfee})\n-        txFS = self.nodes[0].signrawtransactionwithwallet(txF['hex'])\n-        assert_raises_rpc_error(-26, \"mempool min fee not met\", self.nodes[0].sendrawtransaction, txFS['hex'])\n+        assert_raises_rpc_error(-26, \"mempool min fee not met\", miniwallet.send_self_transfer, from_node=node, fee_rate=relayfee)\n+\n+    def create_large_transactions(self, node, txouts, miniwallet, num, fee):\n+        large_txids = []\n+        for _ in range(num):\n+            large_txids.append(miniwallet.send_big_self_transfer(from_node=node, big_txouts=txouts, fee=fee)['txid'])\n+        return large_txids",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554611793",
      "id" : 554611793,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDYxMTc5Mw==",
      "original_commit_id" : "5546a4f7b69b500abb3bdf890f27b4fcb04a46a7",
      "original_line" : 67,
      "original_position" : 82,
      "original_start_line" : 57,
      "path" : "test/functional/mempool_limit.py",
      "position" : null,
      "pull_request_review_id" : 564893296,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554611793",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554612178"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554612178"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "so just for my understanding, I guess `mempoolminfee` increases as the mempool fills up? Would you mind explaining this to me or linking to some info/code so I can learn? thanks",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-01-10T19:33:26Z",
      "diff_hunk" : "@@ -20,55 +21,43 @@ def set_test_params(self):\n         ]]\n         self.supports_cli = False\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def run_test(self):\n         txouts = gen_return_txouts()\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        node = self.nodes[0]\n+        miniwallet = MiniWallet(node)\n+        relayfee = node.getnetworkinfo()['relayfee']\n \n         self.log.info('Check that mempoolminfee is minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_equal(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n-        txids = []\n-        utxos = create_confirmed_utxos(relayfee, self.nodes[0], 91)\n+        txids=[]\n+        miniwallet.generate(92)\n+        node.generate(100)\n \n         self.log.info('Create a mempool tx that will be evicted')\n-        us0 = utxos.pop()\n-        inputs = [{ \"txid\" : us0[\"txid\"], \"vout\" : us0[\"vout\"]}]\n-        outputs = {self.nodes[0].getnewaddress() : 0.0001}\n-        tx = self.nodes[0].createrawtransaction(inputs, outputs)\n-        self.nodes[0].settxfee(relayfee) # specifically fund this tx with low fee\n-        txF = self.nodes[0].fundrawtransaction(tx)\n-        self.nodes[0].settxfee(0) # return to automatic fee selection\n-        txFS = self.nodes[0].signrawtransactionwithwallet(txF['hex'])\n-        txid = self.nodes[0].sendrawtransaction(txFS['hex'])\n+        txid = miniwallet.send_self_transfer(fee_rate = relayfee, from_node = node)['txid']\n \n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n         base_fee = relayfee*100\n         for i in range (3):\n             txids.append([])\n-            txids[i] = create_lots_of_big_transactions(self.nodes[0], txouts, utxos[30*i:30*i+30], 30, (i+1)*base_fee)\n+            txids[i] = self.create_large_transactions(node, txouts, miniwallet, 30, (i+1)*base_fee)\n \n         self.log.info('The tx should be evicted by now')\n-        assert txid not in self.nodes[0].getrawmempool()\n-        txdata = self.nodes[0].gettransaction(txid)\n-        assert txdata['confirmations'] ==  0  #confirmation should still be 0\n+        assert txid not in node.getrawmempool()\n \n         self.log.info('Check that mempoolminfee is larger than minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_greater_than(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_greater_than(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554612178",
      "id" : 554612178,
      "line" : 53,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDYxMjE3OA==",
      "original_commit_id" : "5546a4f7b69b500abb3bdf890f27b4fcb04a46a7",
      "original_line" : 53,
      "original_position" : 65,
      "original_start_line" : null,
      "path" : "test/functional/mempool_limit.py",
      "position" : 69,
      "pull_request_review_id" : 564893296,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554612178",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554612333"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554612333"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think `big_txouts` should come before the optional `utxo_to_spend=None` to spend now that it's required, right?",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-01-10T19:35:02Z",
      "diff_hunk" : "@@ -64,16 +73,28 @@ def send_self_transfer(self, *, fee_rate=Decimal(\"0.003\"), from_node, utxo_to_sp\n         fee = utxo_to_spend['value'] - send_value\n         assert send_value > 0\n \n-        tx = CTransaction()\n-        tx.vin = [CTxIn(COutPoint(int(utxo_to_spend['txid'], 16), utxo_to_spend['vout']))]\n-        tx.vout = [CTxOut(int(send_value * COIN), self._scriptPubKey)]\n-        tx.wit.vtxinwit = [CTxInWitness()]\n-        tx.wit.vtxinwit[0].scriptWitness.stack = [CScript([OP_TRUE])]\n+        tx = self.prepare_tx(utxo_to_spend, send_value)\n         tx_hex = tx.serialize().hex()\n-\n         txid = from_node.sendrawtransaction(tx_hex)\n         self._utxos.append({'txid': txid, 'vout': 0, 'value': send_value})\n         tx_info = from_node.getmempoolentry(txid)\n         assert_equal(tx_info['vsize'], vsize)\n         assert_equal(tx_info['fee'], fee)\n         return {'txid': txid, 'wtxid': tx_info['wtxid'], 'hex': tx_hex}\n+\n+    def send_big_self_transfer(self, *, fee, from_node, utxo_to_spend=None, big_txouts):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554612333",
      "id" : 554612333,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDYxMjMzMw==",
      "original_commit_id" : "5546a4f7b69b500abb3bdf890f27b4fcb04a46a7",
      "original_line" : 85,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/wallet.py",
      "position" : null,
      "pull_request_review_id" : 564893296,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554612333",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554613176"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554613176"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "See this: https://github.com/bitcoin/bitcoin/pull/20808#discussion_r554610229\r\n\r\nBasically I'm wondering if you're going to even need to touch `MiniWallet` in this PR if we can align here. If we extend `MiniWallet` to have an option to \"just-create-don't-send\" then you could\r\n1) create the base tx with `MiniWallet` but don't send\r\n2) add all the `big_txouts` to that `tx`\r\n3) send it yourself, outside of `MiniWallet`\r\n\r\nTo me it seems like that may be the cleanest solution",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-01-10T19:41:50Z",
      "diff_hunk" : "@@ -55,6 +55,15 @@ def get_utxo(self, *, txid=''):\n             index = self._utxos.index(utxo)\n         return self._utxos.pop(index)\n \n+    def prepare_tx(self, utxo_to_spend, send_value):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554613176",
      "id" : 554613176,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDYxMzE3Ng==",
      "original_commit_id" : "5546a4f7b69b500abb3bdf890f27b4fcb04a46a7",
      "original_line" : 58,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/wallet.py",
      "position" : null,
      "pull_request_review_id" : 564893296,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554613176",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554613266"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554613266"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm not really sure tbh. But we may be able to get rid of all of this, re one of my other comments in this review",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-01-10T19:42:47Z",
      "diff_hunk" : "@@ -77,3 +77,30 @@ def send_self_transfer(self, *, fee_rate=Decimal(\"0.003\"), from_node, utxo_to_sp\n         assert_equal(tx_info['vsize'], vsize)\n         assert_equal(tx_info['fee'], fee)\n         return {'txid': txid, 'wtxid': tx_info['wtxid'], 'hex': tx_hex}\n+\n+    def send_multi_self_transfer(self, *, fee_rate=Decimal(\"0.03\"), from_node, utxo_to_spend=None, big_txouts=None):\n+        \"\"\"Create multiple tx with the specified fee_rate. Fee may be exact or at most one satoshi higher than needed.\"\"\"\n+        self._utxos = sorted(self._utxos, key=lambda k: k['value'])\n+        utxo_to_spend = utxo_to_spend or self._utxos.pop() # Pick the largest utxo (if none provided) and hope it covers the fee\n+        send_value = satoshi_round(utxo_to_spend['value'] - fee_rate)\n+        fee = utxo_to_spend['value'] - send_value\n+        assert send_value > 0\n+\n+        tx = CTransaction()\n+        tx.vin = [CTxIn(COutPoint(int(utxo_to_spend['txid'], 16), utxo_to_spend['vout']))]\n+        tx.vout = [CTxOut(int(send_value * COIN), self._scriptPubKey)]\n+        tx.wit.vtxinwit = [CTxInWitness()]\n+        tx.wit.vtxinwit[0].scriptWitness.stack = [CScript([OP_TRUE])]\n+        tx_hex = tx.serialize().hex()\n+\n+        if(big_txouts is not None):\n+            for txout in big_txouts:\n+                tx.vout.append(txout)\n+            tx_hex = tx.serialize().hex()\n+            txid = from_node.sendrawtransaction(tx_hex, 0)\n+        else:\n+            txid = from_node.sendrawtransaction(tx_hex)\n+        self._utxos.append({'txid': txid, 'vout': 0, 'value': send_value})\n+        tx_info = from_node.getmempoolentry(txid)\n+        assert_equal(tx_info['fee'], fee)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554613266",
      "id" : 554613266,
      "in_reply_to_id" : 554117463,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDYxMzI2Ng==",
      "original_commit_id" : "543919b4b19b98867b3eebc33b38c87f4fd164a3",
      "original_line" : 99,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/wallet.py",
      "position" : null,
      "pull_request_review_id" : 564893296,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554613266",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554613440"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554613440"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Since it's not related to this PR I'd leave it. But I think adding an assertion to check all these txs are in the mempool would be good, and at least its a sanity check to make sure everything is as we expect",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-01-10T19:43:49Z",
      "diff_hunk" : "@@ -20,55 +21,44 @@ def set_test_params(self):\n         ]]\n         self.supports_cli = False\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def run_test(self):\n         txouts = gen_return_txouts()\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        node = self.nodes[0]\n+        miniwallet = MiniWallet(node)\n+        relayfee = node.getnetworkinfo()['relayfee']\n \n         self.log.info('Check that mempoolminfee is minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_equal(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n-        txids = []\n-        utxos = create_confirmed_utxos(relayfee, self.nodes[0], 91)\n+        txids=[]\n+        miniwallet.generate(91)\n+        node.generate(100)\n \n         self.log.info('Create a mempool tx that will be evicted')\n-        us0 = utxos.pop()\n-        inputs = [{ \"txid\" : us0[\"txid\"], \"vout\" : us0[\"vout\"]}]\n-        outputs = {self.nodes[0].getnewaddress() : 0.0001}\n-        tx = self.nodes[0].createrawtransaction(inputs, outputs)\n-        self.nodes[0].settxfee(relayfee) # specifically fund this tx with low fee\n-        txF = self.nodes[0].fundrawtransaction(tx)\n-        self.nodes[0].settxfee(0) # return to automatic fee selection\n-        txFS = self.nodes[0].signrawtransactionwithwallet(txF['hex'])\n-        txid = self.nodes[0].sendrawtransaction(txFS['hex'])\n-\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        txid = miniwallet.send_self_transfer(fee_rate = relayfee, from_node = node)['txid']\n+        relayfee = node.getnetworkinfo()['relayfee']\n         base_fee = relayfee*100\n         for i in range (3):\n             txids.append([])\n-            txids[i] = create_lots_of_big_transactions(self.nodes[0], txouts, utxos[30*i:30*i+30], 30, (i+1)*base_fee)\n+            txids[i] = self.create_large_transactions(node, txouts, miniwallet, 30, (i+1)*base_fee)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554613440",
      "id" : 554613440,
      "in_reply_to_id" : 554110427,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDYxMzQ0MA==",
      "original_commit_id" : "543919b4b19b98867b3eebc33b38c87f4fd164a3",
      "original_line" : 45,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "test/functional/mempool_limit.py",
      "position" : null,
      "pull_request_review_id" : 564893296,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554613440",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554637482"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554637482"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The `mempoolminfee` is adjusted whenever the mempool reaches `maxmempool` size, and therefore it kicks out all the transaction below that fee, to make space for tx with accepted fees. I can't find a specific method in the codebase as of now but i'll lyk if I find it ",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-01-10T23:10:12Z",
      "diff_hunk" : "@@ -20,55 +21,43 @@ def set_test_params(self):\n         ]]\n         self.supports_cli = False\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def run_test(self):\n         txouts = gen_return_txouts()\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        node = self.nodes[0]\n+        miniwallet = MiniWallet(node)\n+        relayfee = node.getnetworkinfo()['relayfee']\n \n         self.log.info('Check that mempoolminfee is minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_equal(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n-        txids = []\n-        utxos = create_confirmed_utxos(relayfee, self.nodes[0], 91)\n+        txids=[]\n+        miniwallet.generate(92)\n+        node.generate(100)\n \n         self.log.info('Create a mempool tx that will be evicted')\n-        us0 = utxos.pop()\n-        inputs = [{ \"txid\" : us0[\"txid\"], \"vout\" : us0[\"vout\"]}]\n-        outputs = {self.nodes[0].getnewaddress() : 0.0001}\n-        tx = self.nodes[0].createrawtransaction(inputs, outputs)\n-        self.nodes[0].settxfee(relayfee) # specifically fund this tx with low fee\n-        txF = self.nodes[0].fundrawtransaction(tx)\n-        self.nodes[0].settxfee(0) # return to automatic fee selection\n-        txFS = self.nodes[0].signrawtransactionwithwallet(txF['hex'])\n-        txid = self.nodes[0].sendrawtransaction(txFS['hex'])\n+        txid = miniwallet.send_self_transfer(fee_rate = relayfee, from_node = node)['txid']\n \n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n         base_fee = relayfee*100\n         for i in range (3):\n             txids.append([])\n-            txids[i] = create_lots_of_big_transactions(self.nodes[0], txouts, utxos[30*i:30*i+30], 30, (i+1)*base_fee)\n+            txids[i] = self.create_large_transactions(node, txouts, miniwallet, 30, (i+1)*base_fee)\n \n         self.log.info('The tx should be evicted by now')\n-        assert txid not in self.nodes[0].getrawmempool()\n-        txdata = self.nodes[0].gettransaction(txid)\n-        assert txdata['confirmations'] ==  0  #confirmation should still be 0\n+        assert txid not in node.getrawmempool()\n \n         self.log.info('Check that mempoolminfee is larger than minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_greater_than(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_greater_than(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554637482",
      "id" : 554637482,
      "in_reply_to_id" : 554612178,
      "line" : 53,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDYzNzQ4Mg==",
      "original_commit_id" : "5546a4f7b69b500abb3bdf890f27b4fcb04a46a7",
      "original_line" : 53,
      "original_position" : 65,
      "original_start_line" : null,
      "path" : "test/functional/mempool_limit.py",
      "position" : 69,
      "pull_request_review_id" : 564910980,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554637482",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/26356227?v=4",
         "events_url" : "https://api.github.com/users/stackman27/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stackman27/followers",
         "following_url" : "https://api.github.com/users/stackman27/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stackman27/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stackman27",
         "id" : 26356227,
         "login" : "stackman27",
         "node_id" : "MDQ6VXNlcjI2MzU2MjI3",
         "organizations_url" : "https://api.github.com/users/stackman27/orgs",
         "received_events_url" : "https://api.github.com/users/stackman27/received_events",
         "repos_url" : "https://api.github.com/users/stackman27/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stackman27/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stackman27/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stackman27"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554637532"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554637532"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "oh ya! I'll try that ð",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-01-10T23:10:50Z",
      "diff_hunk" : "@@ -20,55 +21,43 @@ def set_test_params(self):\n         ]]\n         self.supports_cli = False\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def run_test(self):\n         txouts = gen_return_txouts()\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        node = self.nodes[0]\n+        miniwallet = MiniWallet(node)\n+        relayfee = node.getnetworkinfo()['relayfee']\n \n         self.log.info('Check that mempoolminfee is minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_equal(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n-        txids = []\n-        utxos = create_confirmed_utxos(relayfee, self.nodes[0], 91)\n+        txids=[]\n+        miniwallet.generate(92)\n+        node.generate(100)\n \n         self.log.info('Create a mempool tx that will be evicted')\n-        us0 = utxos.pop()\n-        inputs = [{ \"txid\" : us0[\"txid\"], \"vout\" : us0[\"vout\"]}]\n-        outputs = {self.nodes[0].getnewaddress() : 0.0001}\n-        tx = self.nodes[0].createrawtransaction(inputs, outputs)\n-        self.nodes[0].settxfee(relayfee) # specifically fund this tx with low fee\n-        txF = self.nodes[0].fundrawtransaction(tx)\n-        self.nodes[0].settxfee(0) # return to automatic fee selection\n-        txFS = self.nodes[0].signrawtransactionwithwallet(txF['hex'])\n-        txid = self.nodes[0].sendrawtransaction(txFS['hex'])\n+        txid = miniwallet.send_self_transfer(fee_rate = relayfee, from_node = node)['txid']\n \n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n         base_fee = relayfee*100\n         for i in range (3):\n             txids.append([])\n-            txids[i] = create_lots_of_big_transactions(self.nodes[0], txouts, utxos[30*i:30*i+30], 30, (i+1)*base_fee)\n+            txids[i] = self.create_large_transactions(node, txouts, miniwallet, 30, (i+1)*base_fee)\n \n         self.log.info('The tx should be evicted by now')\n-        assert txid not in self.nodes[0].getrawmempool()\n-        txdata = self.nodes[0].gettransaction(txid)\n-        assert txdata['confirmations'] ==  0  #confirmation should still be 0\n+        assert txid not in node.getrawmempool()\n \n         self.log.info('Check that mempoolminfee is larger than minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_greater_than(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_greater_than(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n         self.log.info('Create a mempool tx that will not pass mempoolminfee')\n-        us0 = utxos.pop()\n-        inputs = [{ \"txid\" : us0[\"txid\"], \"vout\" : us0[\"vout\"]}]\n-        outputs = {self.nodes[0].getnewaddress() : 0.0001}\n-        tx = self.nodes[0].createrawtransaction(inputs, outputs)\n-        # specifically fund this tx with a fee < mempoolminfee, >= than minrelaytxfee\n-        txF = self.nodes[0].fundrawtransaction(tx, {'feeRate': relayfee})\n-        txFS = self.nodes[0].signrawtransactionwithwallet(txF['hex'])\n-        assert_raises_rpc_error(-26, \"mempool min fee not met\", self.nodes[0].sendrawtransaction, txFS['hex'])\n+        assert_raises_rpc_error(-26, \"mempool min fee not met\", miniwallet.send_self_transfer, from_node=node, fee_rate=relayfee)\n+\n+    def create_large_transactions(self, node, txouts, miniwallet, num, fee):\n+        large_txids = []\n+        for _ in range(num):\n+            large_txids.append(miniwallet.send_big_self_transfer(from_node=node, big_txouts=txouts, fee=fee)['txid'])\n+        return large_txids",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554637532",
      "id" : 554637532,
      "in_reply_to_id" : 554611793,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDYzNzUzMg==",
      "original_commit_id" : "5546a4f7b69b500abb3bdf890f27b4fcb04a46a7",
      "original_line" : 67,
      "original_position" : 82,
      "original_start_line" : 57,
      "path" : "test/functional/mempool_limit.py",
      "position" : null,
      "pull_request_review_id" : 564911033,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554637532",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/26356227?v=4",
         "events_url" : "https://api.github.com/users/stackman27/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stackman27/followers",
         "following_url" : "https://api.github.com/users/stackman27/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stackman27/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stackman27",
         "id" : 26356227,
         "login" : "stackman27",
         "node_id" : "MDQ6VXNlcjI2MzU2MjI3",
         "organizations_url" : "https://api.github.com/users/stackman27/orgs",
         "received_events_url" : "https://api.github.com/users/stackman27/received_events",
         "repos_url" : "https://api.github.com/users/stackman27/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stackman27/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stackman27/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stackman27"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554638069"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554638069"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "ð¤ hmm i'll look into it and try to find a clean solution",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-01-10T23:14:56Z",
      "diff_hunk" : "@@ -55,6 +55,15 @@ def get_utxo(self, *, txid=''):\n             index = self._utxos.index(utxo)\n         return self._utxos.pop(index)\n \n+    def prepare_tx(self, utxo_to_spend, send_value):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554638069",
      "id" : 554638069,
      "in_reply_to_id" : 554613176,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDYzODA2OQ==",
      "original_commit_id" : "5546a4f7b69b500abb3bdf890f27b4fcb04a46a7",
      "original_line" : 58,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/wallet.py",
      "position" : null,
      "pull_request_review_id" : 564911420,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554638069",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/26356227?v=4",
         "events_url" : "https://api.github.com/users/stackman27/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stackman27/followers",
         "following_url" : "https://api.github.com/users/stackman27/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stackman27/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stackman27",
         "id" : 26356227,
         "login" : "stackman27",
         "node_id" : "MDQ6VXNlcjI2MzU2MjI3",
         "organizations_url" : "https://api.github.com/users/stackman27/orgs",
         "received_events_url" : "https://api.github.com/users/stackman27/received_events",
         "repos_url" : "https://api.github.com/users/stackman27/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stackman27/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stackman27/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stackman27"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554642629"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554642629"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If I take this approach the code would be a lot cleaner but i'd have to get rid of some of the assertion checks for the tx because, i dont think i'll have access to variables such as `send_value` or `fee` unless I really dig into the `tx` list: \r\n\r\n<details open>\r\n<summary>This code...</summary>\r\n \r\n  <pre>minwallet._utxos.append({'txid': txid, 'vout': 0, 'value': send_value})  \r\ntx_info = node.getmempoolentry(txid)\r\nassert_equal(tx_info['fee'], fee)\r\nlarge_txids.append({'txid': txid, 'wtxid': tx_info['wtxid'], 'hex': tx_hex})  </pre>\r\n \r\n</details>  \r\n\r\nThe assertions & appends aren't used in the current code. So i'm tempted to not include them in the new code unless they modify `MiniWallet` variable behaviors. ",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-01-10T23:53:20Z",
      "diff_hunk" : "@@ -55,6 +55,15 @@ def get_utxo(self, *, txid=''):\n             index = self._utxos.index(utxo)\n         return self._utxos.pop(index)\n \n+    def prepare_tx(self, utxo_to_spend, send_value):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554642629",
      "id" : 554642629,
      "in_reply_to_id" : 554613176,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDY0MjYyOQ==",
      "original_commit_id" : "5546a4f7b69b500abb3bdf890f27b4fcb04a46a7",
      "original_line" : 58,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/wallet.py",
      "position" : null,
      "pull_request_review_id" : 564914842,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554642629",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/26356227?v=4",
         "events_url" : "https://api.github.com/users/stackman27/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stackman27/followers",
         "following_url" : "https://api.github.com/users/stackman27/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stackman27/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stackman27",
         "id" : 26356227,
         "login" : "stackman27",
         "node_id" : "MDQ6VXNlcjI2MzU2MjI3",
         "organizations_url" : "https://api.github.com/users/stackman27/orgs",
         "received_events_url" : "https://api.github.com/users/stackman27/received_events",
         "repos_url" : "https://api.github.com/users/stackman27/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stackman27/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stackman27/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stackman27"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554647971"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554647971"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "ah ok interesting, thanks for the explanation",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-01-11T00:36:47Z",
      "diff_hunk" : "@@ -20,55 +21,43 @@ def set_test_params(self):\n         ]]\n         self.supports_cli = False\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def run_test(self):\n         txouts = gen_return_txouts()\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        node = self.nodes[0]\n+        miniwallet = MiniWallet(node)\n+        relayfee = node.getnetworkinfo()['relayfee']\n \n         self.log.info('Check that mempoolminfee is minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_equal(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n-        txids = []\n-        utxos = create_confirmed_utxos(relayfee, self.nodes[0], 91)\n+        txids=[]\n+        miniwallet.generate(92)\n+        node.generate(100)\n \n         self.log.info('Create a mempool tx that will be evicted')\n-        us0 = utxos.pop()\n-        inputs = [{ \"txid\" : us0[\"txid\"], \"vout\" : us0[\"vout\"]}]\n-        outputs = {self.nodes[0].getnewaddress() : 0.0001}\n-        tx = self.nodes[0].createrawtransaction(inputs, outputs)\n-        self.nodes[0].settxfee(relayfee) # specifically fund this tx with low fee\n-        txF = self.nodes[0].fundrawtransaction(tx)\n-        self.nodes[0].settxfee(0) # return to automatic fee selection\n-        txFS = self.nodes[0].signrawtransactionwithwallet(txF['hex'])\n-        txid = self.nodes[0].sendrawtransaction(txFS['hex'])\n+        txid = miniwallet.send_self_transfer(fee_rate = relayfee, from_node = node)['txid']\n \n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n         base_fee = relayfee*100\n         for i in range (3):\n             txids.append([])\n-            txids[i] = create_lots_of_big_transactions(self.nodes[0], txouts, utxos[30*i:30*i+30], 30, (i+1)*base_fee)\n+            txids[i] = self.create_large_transactions(node, txouts, miniwallet, 30, (i+1)*base_fee)\n \n         self.log.info('The tx should be evicted by now')\n-        assert txid not in self.nodes[0].getrawmempool()\n-        txdata = self.nodes[0].gettransaction(txid)\n-        assert txdata['confirmations'] ==  0  #confirmation should still be 0\n+        assert txid not in node.getrawmempool()\n \n         self.log.info('Check that mempoolminfee is larger than minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_greater_than(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_greater_than(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554647971",
      "id" : 554647971,
      "in_reply_to_id" : 554612178,
      "line" : 53,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDY0Nzk3MQ==",
      "original_commit_id" : "5546a4f7b69b500abb3bdf890f27b4fcb04a46a7",
      "original_line" : 53,
      "original_position" : 65,
      "original_start_line" : null,
      "path" : "test/functional/mempool_limit.py",
      "position" : 69,
      "pull_request_review_id" : 564918943,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554647971",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554648846"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554648846"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think it's normal to do some assertions outside of MiniWallet if you think they're needed. ie we have things in the current miniwallet tests like: `assert_equal(entry_time, node.getmempoolentry(parent_txid)['time'])` after sending a transaction.\r\n\r\nAnyways do what you think is best here. If my proposed solution ends up having problems or doesn't make sense I don't want to mislead you",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-01-11T00:44:09Z",
      "diff_hunk" : "@@ -55,6 +55,15 @@ def get_utxo(self, *, txid=''):\n             index = self._utxos.index(utxo)\n         return self._utxos.pop(index)\n \n+    def prepare_tx(self, utxo_to_spend, send_value):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554648846",
      "id" : 554648846,
      "in_reply_to_id" : 554613176,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDY0ODg0Ng==",
      "original_commit_id" : "5546a4f7b69b500abb3bdf890f27b4fcb04a46a7",
      "original_line" : 58,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/wallet.py",
      "position" : null,
      "pull_request_review_id" : 564919647,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554648846",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@mjdietzx Thank you very much for the review. Pushed a new update highlighting all the comments and also updated `MiniWallet` by adding  just-create-don't-send method as proposed by @glozow in #20876. Also, I believe the new `create_and_sign_rawtx` method should resolve @nginocchio's issues as proposed in #20808",
      "created_at" : "2021-01-11T00:57:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#issuecomment-757576998",
      "id" : 757576998,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20874",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1NzU3Njk5OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-11T00:57:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/757576998",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/26356227?v=4",
         "events_url" : "https://api.github.com/users/stackman27/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stackman27/followers",
         "following_url" : "https://api.github.com/users/stackman27/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stackman27/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stackman27",
         "id" : 26356227,
         "login" : "stackman27",
         "node_id" : "MDQ6VXNlcjI2MzU2MjI3",
         "organizations_url" : "https://api.github.com/users/stackman27/orgs",
         "received_events_url" : "https://api.github.com/users/stackman27/received_events",
         "repos_url" : "https://api.github.com/users/stackman27/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stackman27/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stackman27/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stackman27"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554650544"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554650544"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "For sure! pushed a new commit with required changes :) ",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-01-11T00:58:38Z",
      "diff_hunk" : "@@ -55,6 +55,15 @@ def get_utxo(self, *, txid=''):\n             index = self._utxos.index(utxo)\n         return self._utxos.pop(index)\n \n+    def prepare_tx(self, utxo_to_spend, send_value):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r554650544",
      "id" : 554650544,
      "in_reply_to_id" : 554613176,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDY1MDU0NA==",
      "original_commit_id" : "5546a4f7b69b500abb3bdf890f27b4fcb04a46a7",
      "original_line" : 58,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/wallet.py",
      "position" : null,
      "pull_request_review_id" : 564921027,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554650544",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/26356227?v=4",
         "events_url" : "https://api.github.com/users/stackman27/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stackman27/followers",
         "following_url" : "https://api.github.com/users/stackman27/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stackman27/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stackman27",
         "id" : 26356227,
         "login" : "stackman27",
         "node_id" : "MDQ6VXNlcjI2MzU2MjI3",
         "organizations_url" : "https://api.github.com/users/stackman27/orgs",
         "received_events_url" : "https://api.github.com/users/stackman27/received_events",
         "repos_url" : "https://api.github.com/users/stackman27/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stackman27/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stackman27/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stackman27"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-01-11T08:55:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#issuecomment-757748386",
      "id" : 757748386,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20874",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1Nzc0ODM4Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-11T08:55:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/757748386",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r556008790"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/556008790"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I was expecting something more along the lines of:\r\n`assert txid in node.getrawmempool() for txid in txids`\r\n\r\nidk if that actually works, maybe\r\n```assert_equal(len(list(lambda txid: txid in node.getrawmempool(), txids)), len(txids))```",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-01-12T19:08:03Z",
      "diff_hunk" : "@@ -20,55 +21,47 @@ def set_test_params(self):\n         ]]\n         self.supports_cli = False\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def run_test(self):\n         txouts = gen_return_txouts()\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        node = self.nodes[0]\n+        miniwallet = MiniWallet(node)\n+        relayfee = node.getnetworkinfo()['relayfee']\n \n         self.log.info('Check that mempoolminfee is minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_equal(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n-        txids = []\n-        utxos = create_confirmed_utxos(relayfee, self.nodes[0], 91)\n+        txids=[]\n+        miniwallet.generate(92)\n+        node.generate(100)\n \n         self.log.info('Create a mempool tx that will be evicted')\n-        us0 = utxos.pop()\n-        inputs = [{ \"txid\" : us0[\"txid\"], \"vout\" : us0[\"vout\"]}]\n-        outputs = {self.nodes[0].getnewaddress() : 0.0001}\n-        tx = self.nodes[0].createrawtransaction(inputs, outputs)\n-        self.nodes[0].settxfee(relayfee) # specifically fund this tx with low fee\n-        txF = self.nodes[0].fundrawtransaction(tx)\n-        self.nodes[0].settxfee(0) # return to automatic fee selection\n-        txFS = self.nodes[0].signrawtransactionwithwallet(txF['hex'])\n-        txid = self.nodes[0].sendrawtransaction(txFS['hex'])\n+        txid = miniwallet.send_self_transfer(fee_rate = relayfee, from_node = node)['txid']\n \n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n         base_fee = relayfee*100\n         for i in range (3):\n             txids.append([])\n-            txids[i] = create_lots_of_big_transactions(self.nodes[0], txouts, utxos[30*i:30*i+30], 30, (i+1)*base_fee)\n+            txids[i] = self.create_large_transactions(node, txouts, miniwallet, 30, (i+1)*base_fee)\n \n         self.log.info('The tx should be evicted by now')\n-        assert txid not in self.nodes[0].getrawmempool()\n-        txdata = self.nodes[0].gettransaction(txid)\n-        assert txdata['confirmations'] ==  0  #confirmation should still be 0\n+        assert txid not in txids # check txid inside the txids list",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r556008790",
      "id" : 556008790,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjAwODc5MA==",
      "original_commit_id" : "f5eb2bcca4233f3a444c30daf551e79932eb4171",
      "original_line" : 47,
      "original_position" : 59,
      "original_start_line" : null,
      "path" : "test/functional/mempool_limit.py",
      "position" : null,
      "pull_request_review_id" : 566590616,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/556008790",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r556011882"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/556011882"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If you pull in this change https://github.com/bitcoin/bitcoin/pull/20808/files#diff-7932a60a9127fd22d10d367526fd7b987f9647ce017595f8b1af5c32d5db0083R58-R59\r\n\r\nI think you could do\r\n```python\r\ntx = miniwallet.create_and_sign_rawtx(from_node=node, fee_rate=fee_rate, submit_tx=False)  # calculate `fee_rate` so it yields the flat fee that you want\r\ntx.vout.extend(txouts)\r\n...\r\n```\r\n",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-01-12T19:13:23Z",
      "diff_hunk" : "@@ -20,55 +21,47 @@ def set_test_params(self):\n         ]]\n         self.supports_cli = False\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def run_test(self):\n         txouts = gen_return_txouts()\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        node = self.nodes[0]\n+        miniwallet = MiniWallet(node)\n+        relayfee = node.getnetworkinfo()['relayfee']\n \n         self.log.info('Check that mempoolminfee is minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_equal(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n-        txids = []\n-        utxos = create_confirmed_utxos(relayfee, self.nodes[0], 91)\n+        txids=[]\n+        miniwallet.generate(92)\n+        node.generate(100)\n \n         self.log.info('Create a mempool tx that will be evicted')\n-        us0 = utxos.pop()\n-        inputs = [{ \"txid\" : us0[\"txid\"], \"vout\" : us0[\"vout\"]}]\n-        outputs = {self.nodes[0].getnewaddress() : 0.0001}\n-        tx = self.nodes[0].createrawtransaction(inputs, outputs)\n-        self.nodes[0].settxfee(relayfee) # specifically fund this tx with low fee\n-        txF = self.nodes[0].fundrawtransaction(tx)\n-        self.nodes[0].settxfee(0) # return to automatic fee selection\n-        txFS = self.nodes[0].signrawtransactionwithwallet(txF['hex'])\n-        txid = self.nodes[0].sendrawtransaction(txFS['hex'])\n+        txid = miniwallet.send_self_transfer(fee_rate = relayfee, from_node = node)['txid']\n \n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n         base_fee = relayfee*100\n         for i in range (3):\n             txids.append([])\n-            txids[i] = create_lots_of_big_transactions(self.nodes[0], txouts, utxos[30*i:30*i+30], 30, (i+1)*base_fee)\n+            txids[i] = self.create_large_transactions(node, txouts, miniwallet, 30, (i+1)*base_fee)\n \n         self.log.info('The tx should be evicted by now')\n-        assert txid not in self.nodes[0].getrawmempool()\n-        txdata = self.nodes[0].gettransaction(txid)\n-        assert txdata['confirmations'] ==  0  #confirmation should still be 0\n+        assert txid not in txids # check txid inside the txids list\n+        assert txid not in node.getrawmempool() # check txid in the rawmempool\n \n         self.log.info('Check that mempoolminfee is larger than minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_greater_than(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_greater_than(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n         self.log.info('Create a mempool tx that will not pass mempoolminfee')\n-        us0 = utxos.pop()\n-        inputs = [{ \"txid\" : us0[\"txid\"], \"vout\" : us0[\"vout\"]}]\n-        outputs = {self.nodes[0].getnewaddress() : 0.0001}\n-        tx = self.nodes[0].createrawtransaction(inputs, outputs)\n-        # specifically fund this tx with a fee < mempoolminfee, >= than minrelaytxfee\n-        txF = self.nodes[0].fundrawtransaction(tx, {'feeRate': relayfee})\n-        txFS = self.nodes[0].signrawtransactionwithwallet(txF['hex'])\n-        assert_raises_rpc_error(-26, \"mempool min fee not met\", self.nodes[0].sendrawtransaction, txFS['hex'])\n+        assert_raises_rpc_error(-26, \"mempool min fee not met\", miniwallet.send_self_transfer, from_node=node, fee_rate=relayfee)\n+\n+    def create_large_transactions(self, node, txouts, miniwallet, num, fee):\n+        large_txids = []\n+        for _ in range(num):\n+            tx = miniwallet.create_and_sign_rawtx(from_node=node, flat_fee=fee)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r556011882",
      "id" : 556011882,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjAxMTg4Mg==",
      "original_commit_id" : "f5eb2bcca4233f3a444c30daf551e79932eb4171",
      "original_line" : 60,
      "original_position" : 82,
      "original_start_line" : null,
      "path" : "test/functional/mempool_limit.py",
      "position" : null,
      "pull_request_review_id" : 566590616,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/556011882",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r556045577"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/556045577"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm not really sure what this line does. You are asserting that none of the txns have the same txid?",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-01-12T19:57:45Z",
      "diff_hunk" : "@@ -20,55 +21,47 @@ def set_test_params(self):\n         ]]\n         self.supports_cli = False\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def run_test(self):\n         txouts = gen_return_txouts()\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        node = self.nodes[0]\n+        miniwallet = MiniWallet(node)\n+        relayfee = node.getnetworkinfo()['relayfee']\n \n         self.log.info('Check that mempoolminfee is minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_equal(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n-        txids = []\n-        utxos = create_confirmed_utxos(relayfee, self.nodes[0], 91)\n+        txids=[]\n+        miniwallet.generate(92)\n+        node.generate(100)\n \n         self.log.info('Create a mempool tx that will be evicted')\n-        us0 = utxos.pop()\n-        inputs = [{ \"txid\" : us0[\"txid\"], \"vout\" : us0[\"vout\"]}]\n-        outputs = {self.nodes[0].getnewaddress() : 0.0001}\n-        tx = self.nodes[0].createrawtransaction(inputs, outputs)\n-        self.nodes[0].settxfee(relayfee) # specifically fund this tx with low fee\n-        txF = self.nodes[0].fundrawtransaction(tx)\n-        self.nodes[0].settxfee(0) # return to automatic fee selection\n-        txFS = self.nodes[0].signrawtransactionwithwallet(txF['hex'])\n-        txid = self.nodes[0].sendrawtransaction(txFS['hex'])\n+        txid = miniwallet.send_self_transfer(fee_rate = relayfee, from_node = node)['txid']\n \n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n         base_fee = relayfee*100\n         for i in range (3):\n             txids.append([])\n-            txids[i] = create_lots_of_big_transactions(self.nodes[0], txouts, utxos[30*i:30*i+30], 30, (i+1)*base_fee)\n+            txids[i] = self.create_large_transactions(node, txouts, miniwallet, 30, (i+1)*base_fee)\n \n         self.log.info('The tx should be evicted by now')\n-        assert txid not in self.nodes[0].getrawmempool()\n-        txdata = self.nodes[0].gettransaction(txid)\n-        assert txdata['confirmations'] ==  0  #confirmation should still be 0\n+        assert txid not in txids # check txid inside the txids list",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r556045577",
      "id" : 556045577,
      "in_reply_to_id" : 556008790,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjA0NTU3Nw==",
      "original_commit_id" : "f5eb2bcca4233f3a444c30daf551e79932eb4171",
      "original_line" : 47,
      "original_position" : 59,
      "original_start_line" : null,
      "path" : "test/functional/mempool_limit.py",
      "position" : null,
      "pull_request_review_id" : 566642005,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/556045577",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r556046096"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/556046096"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "You can do a stronger assertion\r\n```suggestion\r\n        assert_equal(sorted(txids), sorted(node.getrawmempool()))\r\n```",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-01-12T19:58:44Z",
      "diff_hunk" : "@@ -20,55 +21,47 @@ def set_test_params(self):\n         ]]\n         self.supports_cli = False\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def run_test(self):\n         txouts = gen_return_txouts()\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        node = self.nodes[0]\n+        miniwallet = MiniWallet(node)\n+        relayfee = node.getnetworkinfo()['relayfee']\n \n         self.log.info('Check that mempoolminfee is minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_equal(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n-        txids = []\n-        utxos = create_confirmed_utxos(relayfee, self.nodes[0], 91)\n+        txids=[]\n+        miniwallet.generate(92)\n+        node.generate(100)\n \n         self.log.info('Create a mempool tx that will be evicted')\n-        us0 = utxos.pop()\n-        inputs = [{ \"txid\" : us0[\"txid\"], \"vout\" : us0[\"vout\"]}]\n-        outputs = {self.nodes[0].getnewaddress() : 0.0001}\n-        tx = self.nodes[0].createrawtransaction(inputs, outputs)\n-        self.nodes[0].settxfee(relayfee) # specifically fund this tx with low fee\n-        txF = self.nodes[0].fundrawtransaction(tx)\n-        self.nodes[0].settxfee(0) # return to automatic fee selection\n-        txFS = self.nodes[0].signrawtransactionwithwallet(txF['hex'])\n-        txid = self.nodes[0].sendrawtransaction(txFS['hex'])\n+        txid = miniwallet.send_self_transfer(fee_rate = relayfee, from_node = node)['txid']\n \n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n         base_fee = relayfee*100\n         for i in range (3):\n             txids.append([])\n-            txids[i] = create_lots_of_big_transactions(self.nodes[0], txouts, utxos[30*i:30*i+30], 30, (i+1)*base_fee)\n+            txids[i] = self.create_large_transactions(node, txouts, miniwallet, 30, (i+1)*base_fee)\n \n         self.log.info('The tx should be evicted by now')\n-        assert txid not in self.nodes[0].getrawmempool()\n-        txdata = self.nodes[0].gettransaction(txid)\n-        assert txdata['confirmations'] ==  0  #confirmation should still be 0\n+        assert txid not in txids # check txid inside the txids list\n+        assert txid not in node.getrawmempool() # check txid in the rawmempool",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r556046096",
      "id" : 556046096,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjA0NjA5Ng==",
      "original_commit_id" : "f5eb2bcca4233f3a444c30daf551e79932eb4171",
      "original_line" : 48,
      "original_position" : 60,
      "original_start_line" : null,
      "path" : "test/functional/mempool_limit.py",
      "position" : null,
      "pull_request_review_id" : 566642005,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/556046096",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r556065978"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/556065978"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Could we get a more informative function name and/or description? Also I think you should rename to `utxos` and make it a list. \"utxo_to_spend\" is kinda like \"uneaten food to be eaten.\"",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-01-12T20:26:56Z",
      "diff_hunk" : "@@ -55,6 +55,15 @@ def get_utxo(self, *, txid=''):\n             index = self._utxos.index(utxo)\n         return self._utxos.pop(index)\n \n+    def prepare_tx(self, utxo_to_spend, send_value):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r556065978",
      "id" : 556065978,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjA2NTk3OA==",
      "original_commit_id" : "f5eb2bcca4233f3a444c30daf551e79932eb4171",
      "original_line" : 58,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/wallet.py",
      "position" : null,
      "pull_request_review_id" : 566642005,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/556065978",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r556090529"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/556090529"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I did try that solution but the issue was on `flat_fee` vs calculated fee, and i believe `create_large_tx` uses flat_fee. I didn't wanted to use multiple if/else to make the code look unattractive. I did however find a hack by changing the base fee from `base_fee = relayfee*100` => `base_fee = relayfee*1000` . This didn't change the overall behavior of the test code, but changed the `mempoolminfee` which is pretty expected. \r\n\r\nI'm just wondering if we would need `flat_fee` based `create-dont-send-tx` for future reference? And if we do, would that require a different method?\r\n",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-01-12T20:58:51Z",
      "diff_hunk" : "@@ -20,55 +21,47 @@ def set_test_params(self):\n         ]]\n         self.supports_cli = False\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def run_test(self):\n         txouts = gen_return_txouts()\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        node = self.nodes[0]\n+        miniwallet = MiniWallet(node)\n+        relayfee = node.getnetworkinfo()['relayfee']\n \n         self.log.info('Check that mempoolminfee is minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_equal(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n-        txids = []\n-        utxos = create_confirmed_utxos(relayfee, self.nodes[0], 91)\n+        txids=[]\n+        miniwallet.generate(92)\n+        node.generate(100)\n \n         self.log.info('Create a mempool tx that will be evicted')\n-        us0 = utxos.pop()\n-        inputs = [{ \"txid\" : us0[\"txid\"], \"vout\" : us0[\"vout\"]}]\n-        outputs = {self.nodes[0].getnewaddress() : 0.0001}\n-        tx = self.nodes[0].createrawtransaction(inputs, outputs)\n-        self.nodes[0].settxfee(relayfee) # specifically fund this tx with low fee\n-        txF = self.nodes[0].fundrawtransaction(tx)\n-        self.nodes[0].settxfee(0) # return to automatic fee selection\n-        txFS = self.nodes[0].signrawtransactionwithwallet(txF['hex'])\n-        txid = self.nodes[0].sendrawtransaction(txFS['hex'])\n+        txid = miniwallet.send_self_transfer(fee_rate = relayfee, from_node = node)['txid']\n \n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n         base_fee = relayfee*100\n         for i in range (3):\n             txids.append([])\n-            txids[i] = create_lots_of_big_transactions(self.nodes[0], txouts, utxos[30*i:30*i+30], 30, (i+1)*base_fee)\n+            txids[i] = self.create_large_transactions(node, txouts, miniwallet, 30, (i+1)*base_fee)\n \n         self.log.info('The tx should be evicted by now')\n-        assert txid not in self.nodes[0].getrawmempool()\n-        txdata = self.nodes[0].gettransaction(txid)\n-        assert txdata['confirmations'] ==  0  #confirmation should still be 0\n+        assert txid not in txids # check txid inside the txids list\n+        assert txid not in node.getrawmempool() # check txid in the rawmempool\n \n         self.log.info('Check that mempoolminfee is larger than minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_greater_than(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_greater_than(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n         self.log.info('Create a mempool tx that will not pass mempoolminfee')\n-        us0 = utxos.pop()\n-        inputs = [{ \"txid\" : us0[\"txid\"], \"vout\" : us0[\"vout\"]}]\n-        outputs = {self.nodes[0].getnewaddress() : 0.0001}\n-        tx = self.nodes[0].createrawtransaction(inputs, outputs)\n-        # specifically fund this tx with a fee < mempoolminfee, >= than minrelaytxfee\n-        txF = self.nodes[0].fundrawtransaction(tx, {'feeRate': relayfee})\n-        txFS = self.nodes[0].signrawtransactionwithwallet(txF['hex'])\n-        assert_raises_rpc_error(-26, \"mempool min fee not met\", self.nodes[0].sendrawtransaction, txFS['hex'])\n+        assert_raises_rpc_error(-26, \"mempool min fee not met\", miniwallet.send_self_transfer, from_node=node, fee_rate=relayfee)\n+\n+    def create_large_transactions(self, node, txouts, miniwallet, num, fee):\n+        large_txids = []\n+        for _ in range(num):\n+            tx = miniwallet.create_and_sign_rawtx(from_node=node, flat_fee=fee)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r556090529",
      "id" : 556090529,
      "in_reply_to_id" : 556011882,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjA5MDUyOQ==",
      "original_commit_id" : "f5eb2bcca4233f3a444c30daf551e79932eb4171",
      "original_line" : 60,
      "original_position" : 82,
      "original_start_line" : null,
      "path" : "test/functional/mempool_limit.py",
      "position" : null,
      "pull_request_review_id" : 566695432,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/556090529",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/26356227?v=4",
         "events_url" : "https://api.github.com/users/stackman27/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stackman27/followers",
         "following_url" : "https://api.github.com/users/stackman27/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stackman27/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stackman27",
         "id" : 26356227,
         "login" : "stackman27",
         "node_id" : "MDQ6VXNlcjI2MzU2MjI3",
         "organizations_url" : "https://api.github.com/users/stackman27/orgs",
         "received_events_url" : "https://api.github.com/users/stackman27/received_events",
         "repos_url" : "https://api.github.com/users/stackman27/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stackman27/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stackman27/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stackman27"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r556093381"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/556093381"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I was just trying to check whether txid is present in the txids list or not. We checked txid's presence in the mempool but txids was just left hanging, so i was just working around an assertion for txids ",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-01-12T21:03:56Z",
      "diff_hunk" : "@@ -20,55 +21,47 @@ def set_test_params(self):\n         ]]\n         self.supports_cli = False\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def run_test(self):\n         txouts = gen_return_txouts()\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        node = self.nodes[0]\n+        miniwallet = MiniWallet(node)\n+        relayfee = node.getnetworkinfo()['relayfee']\n \n         self.log.info('Check that mempoolminfee is minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_equal(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n-        txids = []\n-        utxos = create_confirmed_utxos(relayfee, self.nodes[0], 91)\n+        txids=[]\n+        miniwallet.generate(92)\n+        node.generate(100)\n \n         self.log.info('Create a mempool tx that will be evicted')\n-        us0 = utxos.pop()\n-        inputs = [{ \"txid\" : us0[\"txid\"], \"vout\" : us0[\"vout\"]}]\n-        outputs = {self.nodes[0].getnewaddress() : 0.0001}\n-        tx = self.nodes[0].createrawtransaction(inputs, outputs)\n-        self.nodes[0].settxfee(relayfee) # specifically fund this tx with low fee\n-        txF = self.nodes[0].fundrawtransaction(tx)\n-        self.nodes[0].settxfee(0) # return to automatic fee selection\n-        txFS = self.nodes[0].signrawtransactionwithwallet(txF['hex'])\n-        txid = self.nodes[0].sendrawtransaction(txFS['hex'])\n+        txid = miniwallet.send_self_transfer(fee_rate = relayfee, from_node = node)['txid']\n \n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n         base_fee = relayfee*100\n         for i in range (3):\n             txids.append([])\n-            txids[i] = create_lots_of_big_transactions(self.nodes[0], txouts, utxos[30*i:30*i+30], 30, (i+1)*base_fee)\n+            txids[i] = self.create_large_transactions(node, txouts, miniwallet, 30, (i+1)*base_fee)\n \n         self.log.info('The tx should be evicted by now')\n-        assert txid not in self.nodes[0].getrawmempool()\n-        txdata = self.nodes[0].gettransaction(txid)\n-        assert txdata['confirmations'] ==  0  #confirmation should still be 0\n+        assert txid not in txids # check txid inside the txids list",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r556093381",
      "id" : 556093381,
      "in_reply_to_id" : 556008790,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjA5MzM4MQ==",
      "original_commit_id" : "f5eb2bcca4233f3a444c30daf551e79932eb4171",
      "original_line" : 47,
      "original_position" : 59,
      "original_start_line" : null,
      "path" : "test/functional/mempool_limit.py",
      "position" : null,
      "pull_request_review_id" : 566699078,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/556093381",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/26356227?v=4",
         "events_url" : "https://api.github.com/users/stackman27/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stackman27/followers",
         "following_url" : "https://api.github.com/users/stackman27/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stackman27/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stackman27",
         "id" : 26356227,
         "login" : "stackman27",
         "node_id" : "MDQ6VXNlcjI2MzU2MjI3",
         "organizations_url" : "https://api.github.com/users/stackman27/orgs",
         "received_events_url" : "https://api.github.com/users/stackman27/received_events",
         "repos_url" : "https://api.github.com/users/stackman27/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stackman27/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stackman27/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stackman27"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r556099951"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/556099951"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Sure, but why do you need to do that?",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-01-12T21:16:15Z",
      "diff_hunk" : "@@ -20,55 +21,47 @@ def set_test_params(self):\n         ]]\n         self.supports_cli = False\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def run_test(self):\n         txouts = gen_return_txouts()\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        node = self.nodes[0]\n+        miniwallet = MiniWallet(node)\n+        relayfee = node.getnetworkinfo()['relayfee']\n \n         self.log.info('Check that mempoolminfee is minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_equal(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n-        txids = []\n-        utxos = create_confirmed_utxos(relayfee, self.nodes[0], 91)\n+        txids=[]\n+        miniwallet.generate(92)\n+        node.generate(100)\n \n         self.log.info('Create a mempool tx that will be evicted')\n-        us0 = utxos.pop()\n-        inputs = [{ \"txid\" : us0[\"txid\"], \"vout\" : us0[\"vout\"]}]\n-        outputs = {self.nodes[0].getnewaddress() : 0.0001}\n-        tx = self.nodes[0].createrawtransaction(inputs, outputs)\n-        self.nodes[0].settxfee(relayfee) # specifically fund this tx with low fee\n-        txF = self.nodes[0].fundrawtransaction(tx)\n-        self.nodes[0].settxfee(0) # return to automatic fee selection\n-        txFS = self.nodes[0].signrawtransactionwithwallet(txF['hex'])\n-        txid = self.nodes[0].sendrawtransaction(txFS['hex'])\n+        txid = miniwallet.send_self_transfer(fee_rate = relayfee, from_node = node)['txid']\n \n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n         base_fee = relayfee*100\n         for i in range (3):\n             txids.append([])\n-            txids[i] = create_lots_of_big_transactions(self.nodes[0], txouts, utxos[30*i:30*i+30], 30, (i+1)*base_fee)\n+            txids[i] = self.create_large_transactions(node, txouts, miniwallet, 30, (i+1)*base_fee)\n \n         self.log.info('The tx should be evicted by now')\n-        assert txid not in self.nodes[0].getrawmempool()\n-        txdata = self.nodes[0].gettransaction(txid)\n-        assert txdata['confirmations'] ==  0  #confirmation should still be 0\n+        assert txid not in txids # check txid inside the txids list",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r556099951",
      "id" : 556099951,
      "in_reply_to_id" : 556008790,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjA5OTk1MQ==",
      "original_commit_id" : "f5eb2bcca4233f3a444c30daf551e79932eb4171",
      "original_line" : 47,
      "original_position" : 59,
      "original_start_line" : null,
      "path" : "test/functional/mempool_limit.py",
      "position" : null,
      "pull_request_review_id" : 566707403,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/556099951",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r556106325"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/556106325"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I believe there are 90 txs in `txids`,  and 65 in `getrawmempool`. I tested this with the current code because I thought there was some issue with my code, but same result",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-01-12T21:27:38Z",
      "diff_hunk" : "@@ -20,55 +21,47 @@ def set_test_params(self):\n         ]]\n         self.supports_cli = False\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def run_test(self):\n         txouts = gen_return_txouts()\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        node = self.nodes[0]\n+        miniwallet = MiniWallet(node)\n+        relayfee = node.getnetworkinfo()['relayfee']\n \n         self.log.info('Check that mempoolminfee is minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_equal(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n-        txids = []\n-        utxos = create_confirmed_utxos(relayfee, self.nodes[0], 91)\n+        txids=[]\n+        miniwallet.generate(92)\n+        node.generate(100)\n \n         self.log.info('Create a mempool tx that will be evicted')\n-        us0 = utxos.pop()\n-        inputs = [{ \"txid\" : us0[\"txid\"], \"vout\" : us0[\"vout\"]}]\n-        outputs = {self.nodes[0].getnewaddress() : 0.0001}\n-        tx = self.nodes[0].createrawtransaction(inputs, outputs)\n-        self.nodes[0].settxfee(relayfee) # specifically fund this tx with low fee\n-        txF = self.nodes[0].fundrawtransaction(tx)\n-        self.nodes[0].settxfee(0) # return to automatic fee selection\n-        txFS = self.nodes[0].signrawtransactionwithwallet(txF['hex'])\n-        txid = self.nodes[0].sendrawtransaction(txFS['hex'])\n+        txid = miniwallet.send_self_transfer(fee_rate = relayfee, from_node = node)['txid']\n \n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n         base_fee = relayfee*100\n         for i in range (3):\n             txids.append([])\n-            txids[i] = create_lots_of_big_transactions(self.nodes[0], txouts, utxos[30*i:30*i+30], 30, (i+1)*base_fee)\n+            txids[i] = self.create_large_transactions(node, txouts, miniwallet, 30, (i+1)*base_fee)\n \n         self.log.info('The tx should be evicted by now')\n-        assert txid not in self.nodes[0].getrawmempool()\n-        txdata = self.nodes[0].gettransaction(txid)\n-        assert txdata['confirmations'] ==  0  #confirmation should still be 0\n+        assert txid not in txids # check txid inside the txids list\n+        assert txid not in node.getrawmempool() # check txid in the rawmempool",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r556106325",
      "id" : 556106325,
      "in_reply_to_id" : 556046096,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjEwNjMyNQ==",
      "original_commit_id" : "f5eb2bcca4233f3a444c30daf551e79932eb4171",
      "original_line" : 48,
      "original_position" : 60,
      "original_start_line" : null,
      "path" : "test/functional/mempool_limit.py",
      "position" : null,
      "pull_request_review_id" : 566715173,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/556106325",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/26356227?v=4",
         "events_url" : "https://api.github.com/users/stackman27/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stackman27/followers",
         "following_url" : "https://api.github.com/users/stackman27/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stackman27/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stackman27",
         "id" : 26356227,
         "login" : "stackman27",
         "node_id" : "MDQ6VXNlcjI2MzU2MjI3",
         "organizations_url" : "https://api.github.com/users/stackman27/orgs",
         "received_events_url" : "https://api.github.com/users/stackman27/received_events",
         "repos_url" : "https://api.github.com/users/stackman27/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stackman27/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stackman27/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stackman27"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r556107823"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/556107823"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "ð my bad. Have never too good at naming functions. But will definitely keep in mind",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-01-12T21:30:28Z",
      "diff_hunk" : "@@ -55,6 +55,15 @@ def get_utxo(self, *, txid=''):\n             index = self._utxos.index(utxo)\n         return self._utxos.pop(index)\n \n+    def prepare_tx(self, utxo_to_spend, send_value):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r556107823",
      "id" : 556107823,
      "in_reply_to_id" : 556065978,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjEwNzgyMw==",
      "original_commit_id" : "f5eb2bcca4233f3a444c30daf551e79932eb4171",
      "original_line" : 58,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/wallet.py",
      "position" : null,
      "pull_request_review_id" : 566717043,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/556107823",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/26356227?v=4",
         "events_url" : "https://api.github.com/users/stackman27/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stackman27/followers",
         "following_url" : "https://api.github.com/users/stackman27/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stackman27/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stackman27",
         "id" : 26356227,
         "login" : "stackman27",
         "node_id" : "MDQ6VXNlcjI2MzU2MjI3",
         "organizations_url" : "https://api.github.com/users/stackman27/orgs",
         "received_events_url" : "https://api.github.com/users/stackman27/received_events",
         "repos_url" : "https://api.github.com/users/stackman27/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stackman27/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stackman27/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stackman27"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r556123615"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/556123615"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "@mjdietzx the assertion didn't work and I believe its because `len(txids)` is 3 with this format `[[*txs*],[*txs*],[*txs*]]` and each of the `*txs*` has 30 transactions. And `node.getrawmempool()` is just a giant list with 65 txs â¹ï¸",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-01-12T22:00:21Z",
      "diff_hunk" : "@@ -20,55 +21,47 @@ def set_test_params(self):\n         ]]\n         self.supports_cli = False\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def run_test(self):\n         txouts = gen_return_txouts()\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        node = self.nodes[0]\n+        miniwallet = MiniWallet(node)\n+        relayfee = node.getnetworkinfo()['relayfee']\n \n         self.log.info('Check that mempoolminfee is minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_equal(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n-        txids = []\n-        utxos = create_confirmed_utxos(relayfee, self.nodes[0], 91)\n+        txids=[]\n+        miniwallet.generate(92)\n+        node.generate(100)\n \n         self.log.info('Create a mempool tx that will be evicted')\n-        us0 = utxos.pop()\n-        inputs = [{ \"txid\" : us0[\"txid\"], \"vout\" : us0[\"vout\"]}]\n-        outputs = {self.nodes[0].getnewaddress() : 0.0001}\n-        tx = self.nodes[0].createrawtransaction(inputs, outputs)\n-        self.nodes[0].settxfee(relayfee) # specifically fund this tx with low fee\n-        txF = self.nodes[0].fundrawtransaction(tx)\n-        self.nodes[0].settxfee(0) # return to automatic fee selection\n-        txFS = self.nodes[0].signrawtransactionwithwallet(txF['hex'])\n-        txid = self.nodes[0].sendrawtransaction(txFS['hex'])\n+        txid = miniwallet.send_self_transfer(fee_rate = relayfee, from_node = node)['txid']\n \n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n         base_fee = relayfee*100\n         for i in range (3):\n             txids.append([])\n-            txids[i] = create_lots_of_big_transactions(self.nodes[0], txouts, utxos[30*i:30*i+30], 30, (i+1)*base_fee)\n+            txids[i] = self.create_large_transactions(node, txouts, miniwallet, 30, (i+1)*base_fee)\n \n         self.log.info('The tx should be evicted by now')\n-        assert txid not in self.nodes[0].getrawmempool()\n-        txdata = self.nodes[0].gettransaction(txid)\n-        assert txdata['confirmations'] ==  0  #confirmation should still be 0\n+        assert txid not in txids # check txid inside the txids list",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r556123615",
      "id" : 556123615,
      "in_reply_to_id" : 556008790,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjEyMzYxNQ==",
      "original_commit_id" : "f5eb2bcca4233f3a444c30daf551e79932eb4171",
      "original_line" : 47,
      "original_position" : 59,
      "original_start_line" : null,
      "path" : "test/functional/mempool_limit.py",
      "position" : null,
      "pull_request_review_id" : 566736641,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/556123615",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/26356227?v=4",
         "events_url" : "https://api.github.com/users/stackman27/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stackman27/followers",
         "following_url" : "https://api.github.com/users/stackman27/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stackman27/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stackman27",
         "id" : 26356227,
         "login" : "stackman27",
         "node_id" : "MDQ6VXNlcjI2MzU2MjI3",
         "organizations_url" : "https://api.github.com/users/stackman27/orgs",
         "received_events_url" : "https://api.github.com/users/stackman27/received_events",
         "repos_url" : "https://api.github.com/users/stackman27/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stackman27/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stackman27/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stackman27"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-01-15T19:53:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#issuecomment-761165255",
      "id" : 761165255,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20874",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2MTE2NTI1NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-15T19:53:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/761165255",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thank you @glozow @mjdietzx  for the review. Added stronger assertion as suggested :) ",
      "created_at" : "2021-02-01T17:00:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#issuecomment-771004319",
      "id" : 771004319,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20874",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3MTAwNDMxOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-01T17:02:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/771004319",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/26356227?v=4",
         "events_url" : "https://api.github.com/users/stackman27/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stackman27/followers",
         "following_url" : "https://api.github.com/users/stackman27/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stackman27/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stackman27",
         "id" : 26356227,
         "login" : "stackman27",
         "node_id" : "MDQ6VXNlcjI2MzU2MjI3",
         "organizations_url" : "https://api.github.com/users/stackman27/orgs",
         "received_events_url" : "https://api.github.com/users/stackman27/received_events",
         "repos_url" : "https://api.github.com/users/stackman27/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stackman27/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stackman27/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stackman27"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thank you @glozow @mjdietzx  for the review. Added stronger assertion as suggested :) ",
      "created_at" : "2021-02-01T19:59:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#issuecomment-771118938",
      "id" : 771118938,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20874",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3MTExODkzOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-01T19:59:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/771118938",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/26356227?v=4",
         "events_url" : "https://api.github.com/users/stackman27/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stackman27/followers",
         "following_url" : "https://api.github.com/users/stackman27/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stackman27/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stackman27",
         "id" : 26356227,
         "login" : "stackman27",
         "node_id" : "MDQ6VXNlcjI2MzU2MjI3",
         "organizations_url" : "https://api.github.com/users/stackman27/orgs",
         "received_events_url" : "https://api.github.com/users/stackman27/received_events",
         "repos_url" : "https://api.github.com/users/stackman27/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stackman27/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stackman27/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stackman27"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r576981713"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576981713"
         }
      },
      "author_association" : "MEMBER",
      "body" : " Generating blocks takes a few seconds in valgrind, so I am thinking if this test may benefit from using `miniwallet.scan_blocks` (to be introduced in #21200). I haven't looked at the details as why you picked 92 blocks to be mined, but if you can do with just 25 mature coinbases, this could make sense.",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-02-16T16:57:23Z",
      "diff_hunk" : "@@ -20,55 +22,50 @@ def set_test_params(self):\n         ]]\n         self.supports_cli = False\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def run_test(self):\n         txouts = gen_return_txouts()\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        node = self.nodes[0]\n+        miniwallet = MiniWallet(node)\n+        relayfee = node.getnetworkinfo()['relayfee']\n \n         self.log.info('Check that mempoolminfee is minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_equal(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n-        txids = []\n-        utxos = create_confirmed_utxos(relayfee, self.nodes[0], 91)\n+        txids=[]\n+        miniwallet.generate(92)\n+        node.generate(100)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r576981713",
      "id" : 576981713,
      "line" : 37,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3Njk4MTcxMw==",
      "original_commit_id" : "18951db04dc01ce2c331dd4e6d19984b909bf117",
      "original_line" : 37,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "test/functional/mempool_limit.py",
      "position" : 35,
      "pull_request_review_id" : 591431002,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576981713",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r579258951"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/579258951"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`Miniwallet.scan_blocks` looks amazing! Can't wait to use it. The reason behind 92 is that we are creating 90 transaction as a part of `create_large_transactions` method. Also, the same number is present in the current code, so I just thought about mimicking it. ",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-02-19T15:15:21Z",
      "diff_hunk" : "@@ -20,55 +22,50 @@ def set_test_params(self):\n         ]]\n         self.supports_cli = False\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def run_test(self):\n         txouts = gen_return_txouts()\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        node = self.nodes[0]\n+        miniwallet = MiniWallet(node)\n+        relayfee = node.getnetworkinfo()['relayfee']\n \n         self.log.info('Check that mempoolminfee is minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_equal(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n-        txids = []\n-        utxos = create_confirmed_utxos(relayfee, self.nodes[0], 91)\n+        txids=[]\n+        miniwallet.generate(92)\n+        node.generate(100)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r579258951",
      "id" : 579258951,
      "in_reply_to_id" : 576981713,
      "line" : 37,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3OTI1ODk1MQ==",
      "original_commit_id" : "18951db04dc01ce2c331dd4e6d19984b909bf117",
      "original_line" : 37,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "test/functional/mempool_limit.py",
      "position" : 35,
      "pull_request_review_id" : 594284796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/579258951",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/26356227?v=4",
         "events_url" : "https://api.github.com/users/stackman27/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stackman27/followers",
         "following_url" : "https://api.github.com/users/stackman27/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stackman27/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stackman27",
         "id" : 26356227,
         "login" : "stackman27",
         "node_id" : "MDQ6VXNlcjI2MzU2MjI3",
         "organizations_url" : "https://api.github.com/users/stackman27/orgs",
         "received_events_url" : "https://api.github.com/users/stackman27/received_events",
         "repos_url" : "https://api.github.com/users/stackman27/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stackman27/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stackman27/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stackman27"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Concept ACK. I actually think a cleaner approach would be to make `create_lots_of_big_transactions` and the other util.py transaction not need wallet. Could reduce the amount of refactoring needed in each of the functional tests?\r\n\r\n@glozow Thank you very much for the review!\r\nAre you suggesting an alternative way to create_lots_of_big_transactions or just simply getting rid of it?",
      "created_at" : "2021-03-04T15:46:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#issuecomment-790713787",
      "id" : 790713787,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20874",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MDcxMzc4Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-04T15:46:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/790713787",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/26356227?v=4",
         "events_url" : "https://api.github.com/users/stackman27/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stackman27/followers",
         "following_url" : "https://api.github.com/users/stackman27/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stackman27/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stackman27",
         "id" : 26356227,
         "login" : "stackman27",
         "node_id" : "MDQ6VXNlcjI2MzU2MjI3",
         "organizations_url" : "https://api.github.com/users/stackman27/orgs",
         "received_events_url" : "https://api.github.com/users/stackman27/received_events",
         "repos_url" : "https://api.github.com/users/stackman27/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stackman27/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stackman27/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stackman27"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r598360954"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/598360954"
         }
      },
      "author_association" : "NONE",
      "body" : "What is the purpose of creating these transactions within this loop with the fee increasing each time? It seems unnecessarily complicated but I am probably missing something.",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-03-22T00:04:41Z",
      "diff_hunk" : "@@ -20,55 +22,50 @@ def set_test_params(self):\n         ]]\n         self.supports_cli = False\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def run_test(self):\n         txouts = gen_return_txouts()\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        node = self.nodes[0]\n+        miniwallet = MiniWallet(node)\n+        relayfee = node.getnetworkinfo()['relayfee']\n \n         self.log.info('Check that mempoolminfee is minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_equal(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n-        txids = []\n-        utxos = create_confirmed_utxos(relayfee, self.nodes[0], 91)\n+        txids=[]\n+        miniwallet.generate(92)\n+        node.generate(100)\n \n         self.log.info('Create a mempool tx that will be evicted')\n-        us0 = utxos.pop()\n-        inputs = [{ \"txid\" : us0[\"txid\"], \"vout\" : us0[\"vout\"]}]\n-        outputs = {self.nodes[0].getnewaddress() : 0.0001}\n-        tx = self.nodes[0].createrawtransaction(inputs, outputs)\n-        self.nodes[0].settxfee(relayfee) # specifically fund this tx with low fee\n-        txF = self.nodes[0].fundrawtransaction(tx)\n-        self.nodes[0].settxfee(0) # return to automatic fee selection\n-        txFS = self.nodes[0].signrawtransactionwithwallet(txF['hex'])\n-        txid = self.nodes[0].sendrawtransaction(txFS['hex'])\n-\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n-        base_fee = relayfee*100\n+        txid = miniwallet.send_self_transfer(fee_rate = relayfee, from_node = node)['txid']\n+        mempool_min_fee = node.getmempoolinfo()['mempoolminfee']\n+        base_fee = relayfee*1000\n         for i in range (3):\n             txids.append([])\n-            txids[i] = create_lots_of_big_transactions(self.nodes[0], txouts, utxos[30*i:30*i+30], 30, (i+1)*base_fee)\n+            txids[i] = self.create_large_transactions(node, txouts, miniwallet, 30, (i+1)*base_fee, mempool_min_fee)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r598360954",
      "id" : 598360954,
      "line" : 45,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5ODM2MDk1NA==",
      "original_commit_id" : "a478bf775f9d153aeb20dcf0010a039a1842635b",
      "original_line" : 45,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "test/functional/mempool_limit.py",
      "position" : 56,
      "pull_request_review_id" : 617080163,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/598360954",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/41220998?v=4",
         "events_url" : "https://api.github.com/users/DariusParvin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DariusParvin/followers",
         "following_url" : "https://api.github.com/users/DariusParvin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DariusParvin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DariusParvin",
         "id" : 41220998,
         "login" : "DariusParvin",
         "node_id" : "MDQ6VXNlcjQxMjIwOTk4",
         "organizations_url" : "https://api.github.com/users/DariusParvin/orgs",
         "received_events_url" : "https://api.github.com/users/DariusParvin/received_events",
         "repos_url" : "https://api.github.com/users/DariusParvin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DariusParvin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DariusParvin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DariusParvin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r598370784"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/598370784"
         }
      },
      "author_association" : "NONE",
      "body" : "nit: since it's just one txid, perhaps rename `txids` to `txid`?",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-03-22T01:04:48Z",
      "diff_hunk" : "@@ -20,55 +22,50 @@ def set_test_params(self):\n         ]]\n         self.supports_cli = False\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def run_test(self):\n         txouts = gen_return_txouts()\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        node = self.nodes[0]\n+        miniwallet = MiniWallet(node)\n+        relayfee = node.getnetworkinfo()['relayfee']\n \n         self.log.info('Check that mempoolminfee is minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_equal(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n-        txids = []\n-        utxos = create_confirmed_utxos(relayfee, self.nodes[0], 91)\n+        txids=[]\n+        miniwallet.generate(92)\n+        node.generate(100)\n \n         self.log.info('Create a mempool tx that will be evicted')\n-        us0 = utxos.pop()\n-        inputs = [{ \"txid\" : us0[\"txid\"], \"vout\" : us0[\"vout\"]}]\n-        outputs = {self.nodes[0].getnewaddress() : 0.0001}\n-        tx = self.nodes[0].createrawtransaction(inputs, outputs)\n-        self.nodes[0].settxfee(relayfee) # specifically fund this tx with low fee\n-        txF = self.nodes[0].fundrawtransaction(tx)\n-        self.nodes[0].settxfee(0) # return to automatic fee selection\n-        txFS = self.nodes[0].signrawtransactionwithwallet(txF['hex'])\n-        txid = self.nodes[0].sendrawtransaction(txFS['hex'])\n-\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n-        base_fee = relayfee*100\n+        txid = miniwallet.send_self_transfer(fee_rate = relayfee, from_node = node)['txid']\n+        mempool_min_fee = node.getmempoolinfo()['mempoolminfee']\n+        base_fee = relayfee*1000\n         for i in range (3):\n             txids.append([])\n-            txids[i] = create_lots_of_big_transactions(self.nodes[0], txouts, utxos[30*i:30*i+30], 30, (i+1)*base_fee)\n+            txids[i] = self.create_large_transactions(node, txouts, miniwallet, 30, (i+1)*base_fee, mempool_min_fee)\n \n         self.log.info('The tx should be evicted by now')\n-        assert txid not in self.nodes[0].getrawmempool()\n-        txdata = self.nodes[0].gettransaction(txid)\n-        assert txdata['confirmations'] ==  0  #confirmation should still be 0\n+        assert_equal(len([tx for txid in txids for tx in txid]), len(node.getrawmempool()))\n+        assert txid not in node.getrawmempool() # check txid in the raw mempool\n \n         self.log.info('Check that mempoolminfee is larger than minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_greater_than(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_greater_than(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n         self.log.info('Create a mempool tx that will not pass mempoolminfee')\n-        us0 = utxos.pop()\n-        inputs = [{ \"txid\" : us0[\"txid\"], \"vout\" : us0[\"vout\"]}]\n-        outputs = {self.nodes[0].getnewaddress() : 0.0001}\n-        tx = self.nodes[0].createrawtransaction(inputs, outputs)\n-        # specifically fund this tx with a fee < mempoolminfee, >= than minrelaytxfee\n-        txF = self.nodes[0].fundrawtransaction(tx, {'feeRate': relayfee})\n-        txFS = self.nodes[0].signrawtransactionwithwallet(txF['hex'])\n-        assert_raises_rpc_error(-26, \"mempool min fee not met\", self.nodes[0].sendrawtransaction, txFS['hex'])\n+        assert_raises_rpc_error(-26, \"mempool min fee not met\", miniwallet.send_self_transfer, from_node=node, fee_rate=relayfee)\n+\n+    def create_large_transactions(self, node, txouts, miniwallet, num, fee, mempool_min_fee):\n+        large_txids = []\n+        for j in range(num):\n+            hex = miniwallet.send_self_transfer(from_node=node, fee_rate=fee, submit_tx=False)['hex']\n+            tx = FromHex(CTransaction(), hex)\n+            tx.vout.extend(txouts)\n+            tx_hex = tx.serialize().hex()\n+            txids = node.sendrawtransaction(tx_hex, 0)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r598370784",
      "id" : 598370784,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5ODM3MDc4NA==",
      "original_commit_id" : "a478bf775f9d153aeb20dcf0010a039a1842635b",
      "original_line" : 65,
      "original_position" : 89,
      "original_start_line" : null,
      "path" : "test/functional/mempool_limit.py",
      "position" : null,
      "pull_request_review_id" : 617080163,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/598370784",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/41220998?v=4",
         "events_url" : "https://api.github.com/users/DariusParvin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DariusParvin/followers",
         "following_url" : "https://api.github.com/users/DariusParvin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DariusParvin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DariusParvin",
         "id" : 41220998,
         "login" : "DariusParvin",
         "node_id" : "MDQ6VXNlcjQxMjIwOTk4",
         "organizations_url" : "https://api.github.com/users/DariusParvin/orgs",
         "received_events_url" : "https://api.github.com/users/DariusParvin/received_events",
         "repos_url" : "https://api.github.com/users/DariusParvin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DariusParvin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DariusParvin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DariusParvin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r598380697"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/598380697"
         }
      },
      "author_association" : "NONE",
      "body" : "I'm wondering if `send_large_transactions` would be a better name since it is also broadcasting them? It would be more consistent with `send_self_transfer`.",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-03-22T01:52:51Z",
      "diff_hunk" : "@@ -20,55 +22,50 @@ def set_test_params(self):\n         ]]\n         self.supports_cli = False\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def run_test(self):\n         txouts = gen_return_txouts()\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        node = self.nodes[0]\n+        miniwallet = MiniWallet(node)\n+        relayfee = node.getnetworkinfo()['relayfee']\n \n         self.log.info('Check that mempoolminfee is minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_equal(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n-        txids = []\n-        utxos = create_confirmed_utxos(relayfee, self.nodes[0], 91)\n+        txids=[]\n+        miniwallet.generate(92)\n+        node.generate(100)\n \n         self.log.info('Create a mempool tx that will be evicted')\n-        us0 = utxos.pop()\n-        inputs = [{ \"txid\" : us0[\"txid\"], \"vout\" : us0[\"vout\"]}]\n-        outputs = {self.nodes[0].getnewaddress() : 0.0001}\n-        tx = self.nodes[0].createrawtransaction(inputs, outputs)\n-        self.nodes[0].settxfee(relayfee) # specifically fund this tx with low fee\n-        txF = self.nodes[0].fundrawtransaction(tx)\n-        self.nodes[0].settxfee(0) # return to automatic fee selection\n-        txFS = self.nodes[0].signrawtransactionwithwallet(txF['hex'])\n-        txid = self.nodes[0].sendrawtransaction(txFS['hex'])\n-\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n-        base_fee = relayfee*100\n+        txid = miniwallet.send_self_transfer(fee_rate = relayfee, from_node = node)['txid']\n+        mempool_min_fee = node.getmempoolinfo()['mempoolminfee']\n+        base_fee = relayfee*1000\n         for i in range (3):\n             txids.append([])\n-            txids[i] = create_lots_of_big_transactions(self.nodes[0], txouts, utxos[30*i:30*i+30], 30, (i+1)*base_fee)\n+            txids[i] = self.create_large_transactions(node, txouts, miniwallet, 30, (i+1)*base_fee, mempool_min_fee)\n \n         self.log.info('The tx should be evicted by now')\n-        assert txid not in self.nodes[0].getrawmempool()\n-        txdata = self.nodes[0].gettransaction(txid)\n-        assert txdata['confirmations'] ==  0  #confirmation should still be 0\n+        assert_equal(len([tx for txid in txids for tx in txid]), len(node.getrawmempool()))\n+        assert txid not in node.getrawmempool() # check txid in the raw mempool\n \n         self.log.info('Check that mempoolminfee is larger than minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_greater_than(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_greater_than(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n         self.log.info('Create a mempool tx that will not pass mempoolminfee')\n-        us0 = utxos.pop()\n-        inputs = [{ \"txid\" : us0[\"txid\"], \"vout\" : us0[\"vout\"]}]\n-        outputs = {self.nodes[0].getnewaddress() : 0.0001}\n-        tx = self.nodes[0].createrawtransaction(inputs, outputs)\n-        # specifically fund this tx with a fee < mempoolminfee, >= than minrelaytxfee\n-        txF = self.nodes[0].fundrawtransaction(tx, {'feeRate': relayfee})\n-        txFS = self.nodes[0].signrawtransactionwithwallet(txF['hex'])\n-        assert_raises_rpc_error(-26, \"mempool min fee not met\", self.nodes[0].sendrawtransaction, txFS['hex'])\n+        assert_raises_rpc_error(-26, \"mempool min fee not met\", miniwallet.send_self_transfer, from_node=node, fee_rate=relayfee)\n+\n+    def create_large_transactions(self, node, txouts, miniwallet, num, fee, mempool_min_fee):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r598380697",
      "id" : 598380697,
      "line" : 58,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5ODM4MDY5Nw==",
      "original_commit_id" : "a478bf775f9d153aeb20dcf0010a039a1842635b",
      "original_line" : 58,
      "original_position" : 82,
      "original_start_line" : null,
      "path" : "test/functional/mempool_limit.py",
      "position" : 82,
      "pull_request_review_id" : 617080163,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/598380697",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/41220998?v=4",
         "events_url" : "https://api.github.com/users/DariusParvin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DariusParvin/followers",
         "following_url" : "https://api.github.com/users/DariusParvin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DariusParvin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DariusParvin",
         "id" : 41220998,
         "login" : "DariusParvin",
         "node_id" : "MDQ6VXNlcjQxMjIwOTk4",
         "organizations_url" : "https://api.github.com/users/DariusParvin/orgs",
         "received_events_url" : "https://api.github.com/users/DariusParvin/received_events",
         "repos_url" : "https://api.github.com/users/DariusParvin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DariusParvin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DariusParvin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DariusParvin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r598382381"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/598382381"
         }
      },
      "author_association" : "NONE",
      "body" : "What is the purpose of having this condition in here? As a result, it means that there are transactions which get broadcast and enter the mempool, but are not added to `large_txids`. I'll add a comment to where it's used to suggest what I think would be a better alternative. ",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-03-22T02:00:23Z",
      "diff_hunk" : "@@ -20,55 +22,50 @@ def set_test_params(self):\n         ]]\n         self.supports_cli = False\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def run_test(self):\n         txouts = gen_return_txouts()\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        node = self.nodes[0]\n+        miniwallet = MiniWallet(node)\n+        relayfee = node.getnetworkinfo()['relayfee']\n \n         self.log.info('Check that mempoolminfee is minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_equal(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n-        txids = []\n-        utxos = create_confirmed_utxos(relayfee, self.nodes[0], 91)\n+        txids=[]\n+        miniwallet.generate(92)\n+        node.generate(100)\n \n         self.log.info('Create a mempool tx that will be evicted')\n-        us0 = utxos.pop()\n-        inputs = [{ \"txid\" : us0[\"txid\"], \"vout\" : us0[\"vout\"]}]\n-        outputs = {self.nodes[0].getnewaddress() : 0.0001}\n-        tx = self.nodes[0].createrawtransaction(inputs, outputs)\n-        self.nodes[0].settxfee(relayfee) # specifically fund this tx with low fee\n-        txF = self.nodes[0].fundrawtransaction(tx)\n-        self.nodes[0].settxfee(0) # return to automatic fee selection\n-        txFS = self.nodes[0].signrawtransactionwithwallet(txF['hex'])\n-        txid = self.nodes[0].sendrawtransaction(txFS['hex'])\n-\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n-        base_fee = relayfee*100\n+        txid = miniwallet.send_self_transfer(fee_rate = relayfee, from_node = node)['txid']\n+        mempool_min_fee = node.getmempoolinfo()['mempoolminfee']\n+        base_fee = relayfee*1000\n         for i in range (3):\n             txids.append([])\n-            txids[i] = create_lots_of_big_transactions(self.nodes[0], txouts, utxos[30*i:30*i+30], 30, (i+1)*base_fee)\n+            txids[i] = self.create_large_transactions(node, txouts, miniwallet, 30, (i+1)*base_fee, mempool_min_fee)\n \n         self.log.info('The tx should be evicted by now')\n-        assert txid not in self.nodes[0].getrawmempool()\n-        txdata = self.nodes[0].gettransaction(txid)\n-        assert txdata['confirmations'] ==  0  #confirmation should still be 0\n+        assert_equal(len([tx for txid in txids for tx in txid]), len(node.getrawmempool()))\n+        assert txid not in node.getrawmempool() # check txid in the raw mempool\n \n         self.log.info('Check that mempoolminfee is larger than minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_greater_than(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_greater_than(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n         self.log.info('Create a mempool tx that will not pass mempoolminfee')\n-        us0 = utxos.pop()\n-        inputs = [{ \"txid\" : us0[\"txid\"], \"vout\" : us0[\"vout\"]}]\n-        outputs = {self.nodes[0].getnewaddress() : 0.0001}\n-        tx = self.nodes[0].createrawtransaction(inputs, outputs)\n-        # specifically fund this tx with a fee < mempoolminfee, >= than minrelaytxfee\n-        txF = self.nodes[0].fundrawtransaction(tx, {'feeRate': relayfee})\n-        txFS = self.nodes[0].signrawtransactionwithwallet(txF['hex'])\n-        assert_raises_rpc_error(-26, \"mempool min fee not met\", self.nodes[0].sendrawtransaction, txFS['hex'])\n+        assert_raises_rpc_error(-26, \"mempool min fee not met\", miniwallet.send_self_transfer, from_node=node, fee_rate=relayfee)\n+\n+    def create_large_transactions(self, node, txouts, miniwallet, num, fee, mempool_min_fee):\n+        large_txids = []\n+        for j in range(num):\n+            hex = miniwallet.send_self_transfer(from_node=node, fee_rate=fee, submit_tx=False)['hex']\n+            tx = FromHex(CTransaction(), hex)\n+            tx.vout.extend(txouts)\n+            tx_hex = tx.serialize().hex()\n+            txids = node.sendrawtransaction(tx_hex, 0)\n+            if node.getmempoolinfo()['mempoolminfee'] == mempool_min_fee:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r598382381",
      "id" : 598382381,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5ODM4MjM4MQ==",
      "original_commit_id" : "a478bf775f9d153aeb20dcf0010a039a1842635b",
      "original_line" : 66,
      "original_position" : 90,
      "original_start_line" : null,
      "path" : "test/functional/mempool_limit.py",
      "position" : null,
      "pull_request_review_id" : 617080163,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/598382381",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/41220998?v=4",
         "events_url" : "https://api.github.com/users/DariusParvin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DariusParvin/followers",
         "following_url" : "https://api.github.com/users/DariusParvin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DariusParvin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DariusParvin",
         "id" : 41220998,
         "login" : "DariusParvin",
         "node_id" : "MDQ6VXNlcjQxMjIwOTk4",
         "organizations_url" : "https://api.github.com/users/DariusParvin/orgs",
         "received_events_url" : "https://api.github.com/users/DariusParvin/received_events",
         "repos_url" : "https://api.github.com/users/DariusParvin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DariusParvin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DariusParvin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DariusParvin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r598383269"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/598383269"
         }
      },
      "author_association" : "NONE",
      "body" : "Here i'm continuing from the comment below about line 66.\r\nI take it this is to double check that the mempool is full? I think a better way might be to remove the condition you have in `create_large_transactions`, so that you return all the broadcasted txids, and instead over here you use `assert_greater_than`, as in:\r\n\r\n`assert_greater_than(len([tx for txid in txids for tx in txid]), len(node.getrawmempool()))`",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-03-22T02:04:29Z",
      "diff_hunk" : "@@ -20,55 +22,50 @@ def set_test_params(self):\n         ]]\n         self.supports_cli = False\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def run_test(self):\n         txouts = gen_return_txouts()\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        node = self.nodes[0]\n+        miniwallet = MiniWallet(node)\n+        relayfee = node.getnetworkinfo()['relayfee']\n \n         self.log.info('Check that mempoolminfee is minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_equal(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n-        txids = []\n-        utxos = create_confirmed_utxos(relayfee, self.nodes[0], 91)\n+        txids=[]\n+        miniwallet.generate(92)\n+        node.generate(100)\n \n         self.log.info('Create a mempool tx that will be evicted')\n-        us0 = utxos.pop()\n-        inputs = [{ \"txid\" : us0[\"txid\"], \"vout\" : us0[\"vout\"]}]\n-        outputs = {self.nodes[0].getnewaddress() : 0.0001}\n-        tx = self.nodes[0].createrawtransaction(inputs, outputs)\n-        self.nodes[0].settxfee(relayfee) # specifically fund this tx with low fee\n-        txF = self.nodes[0].fundrawtransaction(tx)\n-        self.nodes[0].settxfee(0) # return to automatic fee selection\n-        txFS = self.nodes[0].signrawtransactionwithwallet(txF['hex'])\n-        txid = self.nodes[0].sendrawtransaction(txFS['hex'])\n-\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n-        base_fee = relayfee*100\n+        txid = miniwallet.send_self_transfer(fee_rate = relayfee, from_node = node)['txid']\n+        mempool_min_fee = node.getmempoolinfo()['mempoolminfee']\n+        base_fee = relayfee*1000\n         for i in range (3):\n             txids.append([])\n-            txids[i] = create_lots_of_big_transactions(self.nodes[0], txouts, utxos[30*i:30*i+30], 30, (i+1)*base_fee)\n+            txids[i] = self.create_large_transactions(node, txouts, miniwallet, 30, (i+1)*base_fee, mempool_min_fee)\n \n         self.log.info('The tx should be evicted by now')\n-        assert txid not in self.nodes[0].getrawmempool()\n-        txdata = self.nodes[0].gettransaction(txid)\n-        assert txdata['confirmations'] ==  0  #confirmation should still be 0\n+        assert_equal(len([tx for txid in txids for tx in txid]), len(node.getrawmempool()))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r598383269",
      "id" : 598383269,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5ODM4MzI2OQ==",
      "original_commit_id" : "a478bf775f9d153aeb20dcf0010a039a1842635b",
      "original_line" : 48,
      "original_position" : 62,
      "original_start_line" : null,
      "path" : "test/functional/mempool_limit.py",
      "position" : null,
      "pull_request_review_id" : 617080163,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/598383269",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/41220998?v=4",
         "events_url" : "https://api.github.com/users/DariusParvin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DariusParvin/followers",
         "following_url" : "https://api.github.com/users/DariusParvin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DariusParvin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DariusParvin",
         "id" : 41220998,
         "login" : "DariusParvin",
         "node_id" : "MDQ6VXNlcjQxMjIwOTk4",
         "organizations_url" : "https://api.github.com/users/DariusParvin/orgs",
         "received_events_url" : "https://api.github.com/users/DariusParvin/received_events",
         "repos_url" : "https://api.github.com/users/DariusParvin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DariusParvin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DariusParvin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DariusParvin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r598385338"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/598385338"
         }
      },
      "author_association" : "NONE",
      "body" : "nit: it's a bit confusing here since `tx` is actually a txid, and `txid` is another list of txids. I don't think this is much better but maybe `[txid for batch in txids for txid in batch]`?",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-03-22T02:12:59Z",
      "diff_hunk" : "@@ -20,55 +22,50 @@ def set_test_params(self):\n         ]]\n         self.supports_cli = False\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def run_test(self):\n         txouts = gen_return_txouts()\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        node = self.nodes[0]\n+        miniwallet = MiniWallet(node)\n+        relayfee = node.getnetworkinfo()['relayfee']\n \n         self.log.info('Check that mempoolminfee is minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_equal(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n-        txids = []\n-        utxos = create_confirmed_utxos(relayfee, self.nodes[0], 91)\n+        txids=[]\n+        miniwallet.generate(92)\n+        node.generate(100)\n \n         self.log.info('Create a mempool tx that will be evicted')\n-        us0 = utxos.pop()\n-        inputs = [{ \"txid\" : us0[\"txid\"], \"vout\" : us0[\"vout\"]}]\n-        outputs = {self.nodes[0].getnewaddress() : 0.0001}\n-        tx = self.nodes[0].createrawtransaction(inputs, outputs)\n-        self.nodes[0].settxfee(relayfee) # specifically fund this tx with low fee\n-        txF = self.nodes[0].fundrawtransaction(tx)\n-        self.nodes[0].settxfee(0) # return to automatic fee selection\n-        txFS = self.nodes[0].signrawtransactionwithwallet(txF['hex'])\n-        txid = self.nodes[0].sendrawtransaction(txFS['hex'])\n-\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n-        base_fee = relayfee*100\n+        txid = miniwallet.send_self_transfer(fee_rate = relayfee, from_node = node)['txid']\n+        mempool_min_fee = node.getmempoolinfo()['mempoolminfee']\n+        base_fee = relayfee*1000\n         for i in range (3):\n             txids.append([])\n-            txids[i] = create_lots_of_big_transactions(self.nodes[0], txouts, utxos[30*i:30*i+30], 30, (i+1)*base_fee)\n+            txids[i] = self.create_large_transactions(node, txouts, miniwallet, 30, (i+1)*base_fee, mempool_min_fee)\n \n         self.log.info('The tx should be evicted by now')\n-        assert txid not in self.nodes[0].getrawmempool()\n-        txdata = self.nodes[0].gettransaction(txid)\n-        assert txdata['confirmations'] ==  0  #confirmation should still be 0\n+        assert_equal(len([tx for txid in txids for tx in txid]), len(node.getrawmempool()))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r598385338",
      "id" : 598385338,
      "in_reply_to_id" : 598383269,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5ODM4NTMzOA==",
      "original_commit_id" : "a478bf775f9d153aeb20dcf0010a039a1842635b",
      "original_line" : 48,
      "original_position" : 62,
      "original_start_line" : null,
      "path" : "test/functional/mempool_limit.py",
      "position" : null,
      "pull_request_review_id" : 617080163,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/598385338",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/41220998?v=4",
         "events_url" : "https://api.github.com/users/DariusParvin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DariusParvin/followers",
         "following_url" : "https://api.github.com/users/DariusParvin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DariusParvin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DariusParvin",
         "id" : 41220998,
         "login" : "DariusParvin",
         "node_id" : "MDQ6VXNlcjQxMjIwOTk4",
         "organizations_url" : "https://api.github.com/users/DariusParvin/orgs",
         "received_events_url" : "https://api.github.com/users/DariusParvin/received_events",
         "repos_url" : "https://api.github.com/users/DariusParvin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DariusParvin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DariusParvin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DariusParvin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r606049114"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/606049114"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This is part of the feature as we're flooding mempool with transaction with higher fees in every loop. This is also a part of the current codebase so I'm pretty much mimicking it ",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-04-02T03:05:46Z",
      "diff_hunk" : "@@ -20,55 +22,50 @@ def set_test_params(self):\n         ]]\n         self.supports_cli = False\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def run_test(self):\n         txouts = gen_return_txouts()\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        node = self.nodes[0]\n+        miniwallet = MiniWallet(node)\n+        relayfee = node.getnetworkinfo()['relayfee']\n \n         self.log.info('Check that mempoolminfee is minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_equal(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n-        txids = []\n-        utxos = create_confirmed_utxos(relayfee, self.nodes[0], 91)\n+        txids=[]\n+        miniwallet.generate(92)\n+        node.generate(100)\n \n         self.log.info('Create a mempool tx that will be evicted')\n-        us0 = utxos.pop()\n-        inputs = [{ \"txid\" : us0[\"txid\"], \"vout\" : us0[\"vout\"]}]\n-        outputs = {self.nodes[0].getnewaddress() : 0.0001}\n-        tx = self.nodes[0].createrawtransaction(inputs, outputs)\n-        self.nodes[0].settxfee(relayfee) # specifically fund this tx with low fee\n-        txF = self.nodes[0].fundrawtransaction(tx)\n-        self.nodes[0].settxfee(0) # return to automatic fee selection\n-        txFS = self.nodes[0].signrawtransactionwithwallet(txF['hex'])\n-        txid = self.nodes[0].sendrawtransaction(txFS['hex'])\n-\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n-        base_fee = relayfee*100\n+        txid = miniwallet.send_self_transfer(fee_rate = relayfee, from_node = node)['txid']\n+        mempool_min_fee = node.getmempoolinfo()['mempoolminfee']\n+        base_fee = relayfee*1000\n         for i in range (3):\n             txids.append([])\n-            txids[i] = create_lots_of_big_transactions(self.nodes[0], txouts, utxos[30*i:30*i+30], 30, (i+1)*base_fee)\n+            txids[i] = self.create_large_transactions(node, txouts, miniwallet, 30, (i+1)*base_fee, mempool_min_fee)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r606049114",
      "id" : 606049114,
      "in_reply_to_id" : 598360954,
      "line" : 45,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNjA0OTExNA==",
      "original_commit_id" : "a478bf775f9d153aeb20dcf0010a039a1842635b",
      "original_line" : 45,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "test/functional/mempool_limit.py",
      "position" : 56,
      "pull_request_review_id" : 626764262,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/606049114",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/26356227?v=4",
         "events_url" : "https://api.github.com/users/stackman27/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stackman27/followers",
         "following_url" : "https://api.github.com/users/stackman27/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stackman27/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stackman27",
         "id" : 26356227,
         "login" : "stackman27",
         "node_id" : "MDQ6VXNlcjI2MzU2MjI3",
         "organizations_url" : "https://api.github.com/users/stackman27/orgs",
         "received_events_url" : "https://api.github.com/users/stackman27/received_events",
         "repos_url" : "https://api.github.com/users/stackman27/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stackman27/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stackman27/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stackman27"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r606050387"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/606050387"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "hmm just following the naming convention used [here](https://github.com/bitcoin/bitcoin/blob/66daf4cb3b47e8218623936d23ad504fd189e70b/test/functional/test_framework/util.py#L503) as it's just a copy of that code. But happy to change :) ",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-04-02T03:11:49Z",
      "diff_hunk" : "@@ -20,55 +22,50 @@ def set_test_params(self):\n         ]]\n         self.supports_cli = False\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def run_test(self):\n         txouts = gen_return_txouts()\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        node = self.nodes[0]\n+        miniwallet = MiniWallet(node)\n+        relayfee = node.getnetworkinfo()['relayfee']\n \n         self.log.info('Check that mempoolminfee is minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_equal(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n-        txids = []\n-        utxos = create_confirmed_utxos(relayfee, self.nodes[0], 91)\n+        txids=[]\n+        miniwallet.generate(92)\n+        node.generate(100)\n \n         self.log.info('Create a mempool tx that will be evicted')\n-        us0 = utxos.pop()\n-        inputs = [{ \"txid\" : us0[\"txid\"], \"vout\" : us0[\"vout\"]}]\n-        outputs = {self.nodes[0].getnewaddress() : 0.0001}\n-        tx = self.nodes[0].createrawtransaction(inputs, outputs)\n-        self.nodes[0].settxfee(relayfee) # specifically fund this tx with low fee\n-        txF = self.nodes[0].fundrawtransaction(tx)\n-        self.nodes[0].settxfee(0) # return to automatic fee selection\n-        txFS = self.nodes[0].signrawtransactionwithwallet(txF['hex'])\n-        txid = self.nodes[0].sendrawtransaction(txFS['hex'])\n-\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n-        base_fee = relayfee*100\n+        txid = miniwallet.send_self_transfer(fee_rate = relayfee, from_node = node)['txid']\n+        mempool_min_fee = node.getmempoolinfo()['mempoolminfee']\n+        base_fee = relayfee*1000\n         for i in range (3):\n             txids.append([])\n-            txids[i] = create_lots_of_big_transactions(self.nodes[0], txouts, utxos[30*i:30*i+30], 30, (i+1)*base_fee)\n+            txids[i] = self.create_large_transactions(node, txouts, miniwallet, 30, (i+1)*base_fee, mempool_min_fee)\n \n         self.log.info('The tx should be evicted by now')\n-        assert txid not in self.nodes[0].getrawmempool()\n-        txdata = self.nodes[0].gettransaction(txid)\n-        assert txdata['confirmations'] ==  0  #confirmation should still be 0\n+        assert_equal(len([tx for txid in txids for tx in txid]), len(node.getrawmempool()))\n+        assert txid not in node.getrawmempool() # check txid in the raw mempool\n \n         self.log.info('Check that mempoolminfee is larger than minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_greater_than(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_greater_than(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n         self.log.info('Create a mempool tx that will not pass mempoolminfee')\n-        us0 = utxos.pop()\n-        inputs = [{ \"txid\" : us0[\"txid\"], \"vout\" : us0[\"vout\"]}]\n-        outputs = {self.nodes[0].getnewaddress() : 0.0001}\n-        tx = self.nodes[0].createrawtransaction(inputs, outputs)\n-        # specifically fund this tx with a fee < mempoolminfee, >= than minrelaytxfee\n-        txF = self.nodes[0].fundrawtransaction(tx, {'feeRate': relayfee})\n-        txFS = self.nodes[0].signrawtransactionwithwallet(txF['hex'])\n-        assert_raises_rpc_error(-26, \"mempool min fee not met\", self.nodes[0].sendrawtransaction, txFS['hex'])\n+        assert_raises_rpc_error(-26, \"mempool min fee not met\", miniwallet.send_self_transfer, from_node=node, fee_rate=relayfee)\n+\n+    def create_large_transactions(self, node, txouts, miniwallet, num, fee, mempool_min_fee):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r606050387",
      "id" : 606050387,
      "in_reply_to_id" : 598380697,
      "line" : 58,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNjA1MDM4Nw==",
      "original_commit_id" : "a478bf775f9d153aeb20dcf0010a039a1842635b",
      "original_line" : 58,
      "original_position" : 82,
      "original_start_line" : null,
      "path" : "test/functional/mempool_limit.py",
      "position" : 82,
      "pull_request_review_id" : 626765611,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/606050387",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/26356227?v=4",
         "events_url" : "https://api.github.com/users/stackman27/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stackman27/followers",
         "following_url" : "https://api.github.com/users/stackman27/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stackman27/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stackman27",
         "id" : 26356227,
         "login" : "stackman27",
         "node_id" : "MDQ6VXNlcjI2MzU2MjI3",
         "organizations_url" : "https://api.github.com/users/stackman27/orgs",
         "received_events_url" : "https://api.github.com/users/stackman27/received_events",
         "repos_url" : "https://api.github.com/users/stackman27/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stackman27/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stackman27/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stackman27"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r606051159"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/606051159"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "okay! will add a comment but the basic logic is that i'm making sure that the fees have changed and only include those txs whose fees have gone up. This also supports the assert logic at like 48",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-04-02T03:14:48Z",
      "diff_hunk" : "@@ -20,55 +22,50 @@ def set_test_params(self):\n         ]]\n         self.supports_cli = False\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def run_test(self):\n         txouts = gen_return_txouts()\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        node = self.nodes[0]\n+        miniwallet = MiniWallet(node)\n+        relayfee = node.getnetworkinfo()['relayfee']\n \n         self.log.info('Check that mempoolminfee is minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_equal(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n-        txids = []\n-        utxos = create_confirmed_utxos(relayfee, self.nodes[0], 91)\n+        txids=[]\n+        miniwallet.generate(92)\n+        node.generate(100)\n \n         self.log.info('Create a mempool tx that will be evicted')\n-        us0 = utxos.pop()\n-        inputs = [{ \"txid\" : us0[\"txid\"], \"vout\" : us0[\"vout\"]}]\n-        outputs = {self.nodes[0].getnewaddress() : 0.0001}\n-        tx = self.nodes[0].createrawtransaction(inputs, outputs)\n-        self.nodes[0].settxfee(relayfee) # specifically fund this tx with low fee\n-        txF = self.nodes[0].fundrawtransaction(tx)\n-        self.nodes[0].settxfee(0) # return to automatic fee selection\n-        txFS = self.nodes[0].signrawtransactionwithwallet(txF['hex'])\n-        txid = self.nodes[0].sendrawtransaction(txFS['hex'])\n-\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n-        base_fee = relayfee*100\n+        txid = miniwallet.send_self_transfer(fee_rate = relayfee, from_node = node)['txid']\n+        mempool_min_fee = node.getmempoolinfo()['mempoolminfee']\n+        base_fee = relayfee*1000\n         for i in range (3):\n             txids.append([])\n-            txids[i] = create_lots_of_big_transactions(self.nodes[0], txouts, utxos[30*i:30*i+30], 30, (i+1)*base_fee)\n+            txids[i] = self.create_large_transactions(node, txouts, miniwallet, 30, (i+1)*base_fee, mempool_min_fee)\n \n         self.log.info('The tx should be evicted by now')\n-        assert txid not in self.nodes[0].getrawmempool()\n-        txdata = self.nodes[0].gettransaction(txid)\n-        assert txdata['confirmations'] ==  0  #confirmation should still be 0\n+        assert_equal(len([tx for txid in txids for tx in txid]), len(node.getrawmempool()))\n+        assert txid not in node.getrawmempool() # check txid in the raw mempool\n \n         self.log.info('Check that mempoolminfee is larger than minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_greater_than(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_greater_than(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n         self.log.info('Create a mempool tx that will not pass mempoolminfee')\n-        us0 = utxos.pop()\n-        inputs = [{ \"txid\" : us0[\"txid\"], \"vout\" : us0[\"vout\"]}]\n-        outputs = {self.nodes[0].getnewaddress() : 0.0001}\n-        tx = self.nodes[0].createrawtransaction(inputs, outputs)\n-        # specifically fund this tx with a fee < mempoolminfee, >= than minrelaytxfee\n-        txF = self.nodes[0].fundrawtransaction(tx, {'feeRate': relayfee})\n-        txFS = self.nodes[0].signrawtransactionwithwallet(txF['hex'])\n-        assert_raises_rpc_error(-26, \"mempool min fee not met\", self.nodes[0].sendrawtransaction, txFS['hex'])\n+        assert_raises_rpc_error(-26, \"mempool min fee not met\", miniwallet.send_self_transfer, from_node=node, fee_rate=relayfee)\n+\n+    def create_large_transactions(self, node, txouts, miniwallet, num, fee, mempool_min_fee):\n+        large_txids = []\n+        for j in range(num):\n+            hex = miniwallet.send_self_transfer(from_node=node, fee_rate=fee, submit_tx=False)['hex']\n+            tx = FromHex(CTransaction(), hex)\n+            tx.vout.extend(txouts)\n+            tx_hex = tx.serialize().hex()\n+            txids = node.sendrawtransaction(tx_hex, 0)\n+            if node.getmempoolinfo()['mempoolminfee'] == mempool_min_fee:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r606051159",
      "id" : 606051159,
      "in_reply_to_id" : 598382381,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNjA1MTE1OQ==",
      "original_commit_id" : "a478bf775f9d153aeb20dcf0010a039a1842635b",
      "original_line" : 66,
      "original_position" : 90,
      "original_start_line" : null,
      "path" : "test/functional/mempool_limit.py",
      "position" : null,
      "pull_request_review_id" : 626766333,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T21:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/606051159",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/26356227?v=4",
         "events_url" : "https://api.github.com/users/stackman27/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stackman27/followers",
         "following_url" : "https://api.github.com/users/stackman27/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stackman27/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stackman27",
         "id" : 26356227,
         "login" : "stackman27",
         "node_id" : "MDQ6VXNlcjI2MzU2MjI3",
         "organizations_url" : "https://api.github.com/users/stackman27/orgs",
         "received_events_url" : "https://api.github.com/users/stackman27/received_events",
         "repos_url" : "https://api.github.com/users/stackman27/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stackman27/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stackman27/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stackman27"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thank you @DariusParvin  for the review. Added changes as suggested",
      "created_at" : "2021-04-16T21:31:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#issuecomment-821574478",
      "id" : 821574478,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20874",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyMTU3NDQ3OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-16T21:31:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/821574478",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/26356227?v=4",
         "events_url" : "https://api.github.com/users/stackman27/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stackman27/followers",
         "following_url" : "https://api.github.com/users/stackman27/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stackman27/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stackman27",
         "id" : 26356227,
         "login" : "stackman27",
         "node_id" : "MDQ6VXNlcjI2MzU2MjI3",
         "organizations_url" : "https://api.github.com/users/stackman27/orgs",
         "received_events_url" : "https://api.github.com/users/stackman27/received_events",
         "repos_url" : "https://api.github.com/users/stackman27/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stackman27/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stackman27/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stackman27"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r615560829"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615560829"
         }
      },
      "author_association" : "NONE",
      "body" : "here `num` is set to 30 but the test also works with 22 (with only the original tx getting kicked from the mempool). My feeling is that it's more beneficial to have the test run faster than to have some extra leeway with excess txs. \r\n```suggestion\r\n            txids[i] = self.create_large_transactions(node, txouts, miniwallet, 22, (i+1)*base_fee, mempool_min_fee)\r\n```",
      "commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "created_at" : "2021-04-19T06:01:05Z",
      "diff_hunk" : "@@ -20,55 +22,49 @@ def set_test_params(self):\n         ]]\n         self.supports_cli = False\n \n-    def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n-\n     def run_test(self):\n         txouts = gen_return_txouts()\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n+        node = self.nodes[0]\n+        miniwallet = MiniWallet(node)\n+        relayfee = node.getnetworkinfo()['relayfee']\n \n         self.log.info('Check that mempoolminfee is minrelytxfee')\n-        assert_equal(self.nodes[0].getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_equal(self.nodes[0].getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n-        txids = []\n-        utxos = create_confirmed_utxos(relayfee, self.nodes[0], 91)\n+        txids=[]\n+        miniwallet.generate(92)\n+        node.generate(100)\n \n         self.log.info('Create a mempool tx that will be evicted')\n-        us0 = utxos.pop()\n-        inputs = [{ \"txid\" : us0[\"txid\"], \"vout\" : us0[\"vout\"]}]\n-        outputs = {self.nodes[0].getnewaddress() : 0.0001}\n-        tx = self.nodes[0].createrawtransaction(inputs, outputs)\n-        self.nodes[0].settxfee(relayfee) # specifically fund this tx with low fee\n-        txF = self.nodes[0].fundrawtransaction(tx)\n-        self.nodes[0].settxfee(0) # return to automatic fee selection\n-        txFS = self.nodes[0].signrawtransactionwithwallet(txF['hex'])\n-        txid = self.nodes[0].sendrawtransaction(txFS['hex'])\n-\n-        relayfee = self.nodes[0].getnetworkinfo()['relayfee']\n-        base_fee = relayfee*100\n+        txid = miniwallet.send_self_transfer(fee_rate = relayfee, from_node = node)['txid']\n+        mempool_min_fee = node.getmempoolinfo()['mempoolminfee']\n+        base_fee = relayfee*1000\n         for i in range (3):\n             txids.append([])\n-            txids[i] = create_lots_of_big_transactions(self.nodes[0], txouts, utxos[30*i:30*i+30], 30, (i+1)*base_fee)\n+            txids[i] = self.create_large_transactions(node, txouts, miniwallet, 30, (i+1)*base_fee, mempool_min_fee)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#discussion_r615560829",
      "id" : 615560829,
      "line" : 45,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTU2MDgyOQ==",
      "original_commit_id" : "ed1e869e14c0d2d8b8f2f9f82ca8b27be2ffb6b9",
      "original_line" : 45,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "test/functional/mempool_limit.py",
      "position" : 56,
      "pull_request_review_id" : 638484300,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20874",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T06:01:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615560829",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/41220998?v=4",
         "events_url" : "https://api.github.com/users/DariusParvin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DariusParvin/followers",
         "following_url" : "https://api.github.com/users/DariusParvin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DariusParvin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DariusParvin",
         "id" : 41220998,
         "login" : "DariusParvin",
         "node_id" : "MDQ6VXNlcjQxMjIwOTk4",
         "organizations_url" : "https://api.github.com/users/DariusParvin/orgs",
         "received_events_url" : "https://api.github.com/users/DariusParvin/received_events",
         "repos_url" : "https://api.github.com/users/DariusParvin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DariusParvin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DariusParvin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DariusParvin"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-04-29T07:10:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#issuecomment-828993902",
      "id" : 828993902,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20874",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyODk5MzkwMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-29T07:10:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/828993902",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-06-01T14:19:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#issuecomment-852164687",
      "id" : 852164687,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20874",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1MjE2NDY4Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-01T14:19:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/852164687",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Are you still working on this?",
      "created_at" : "2021-07-20T07:32:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#issuecomment-883165494",
      "id" : 883165494,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20874",
      "node_id" : "IC_kwDOABII5840pAk2",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-20T07:32:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/883165494",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Are you still working on this?\r\n\r\nNot at the moment, have been busy with work and classes",
      "created_at" : "2021-07-20T19:02:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20874#issuecomment-883623943",
      "id" : 883623943,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20874",
      "node_id" : "IC_kwDOABII5840qwgH",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-20T19:02:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/883623943",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/26356227?v=4",
         "events_url" : "https://api.github.com/users/stackman27/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stackman27/followers",
         "following_url" : "https://api.github.com/users/stackman27/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stackman27/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stackman27",
         "id" : 26356227,
         "login" : "stackman27",
         "node_id" : "MDQ6VXNlcjI2MzU2MjI3",
         "organizations_url" : "https://api.github.com/users/stackman27/orgs",
         "received_events_url" : "https://api.github.com/users/stackman27/received_events",
         "repos_url" : "https://api.github.com/users/stackman27/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stackman27/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stackman27/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stackman27"
      }
   }
]
