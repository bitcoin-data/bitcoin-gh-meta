[
   {
      "author_association" : "MEMBER",
      "body" : "This is an alternative to my preferred fix #18840",
      "created_at" : "2020-05-01T15:35:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18842#issuecomment-622437145",
      "id" : 622437145,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18842",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMjQzNzE0NQ==",
      "updated_at" : "2020-05-01T15:35:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/622437145",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/18842#issuecomment-622437145\r\n\r\n> This is an alternative to my preferred fix #18840\r\n\r\nfa3fdbfa89719797bba3b044b96caa984c5ff4be does seem a little fragile. I guess I was thinking of something more like:\r\n\r\n```diff\r\ndiff --git a/src/interfaces/chain.cpp b/src/interfaces/chain.cpp\r\nindex 0e7641ae320..8b288e62ff7 100644\r\n--- a/src/interfaces/chain.cpp\r\n+++ b/src/interfaces/chain.cpp\r\n@@ -309,6 +309,11 @@ public:\r\n         LOCK(::mempool.cs);\r\n         return IsRBFOptIn(tx, ::mempool);\r\n     }\r\n+    bool isInMempool(const uint256& txid) override\r\n+    {\r\n+        LOCK(::mempool.cs);\r\n+        return ::mempool.exists(txid);\r\n+    }\r\n     bool hasDescendantsInMempool(const uint256& txid) override\r\n     {\r\n         LOCK(::mempool.cs);\r\ndiff --git a/src/interfaces/chain.h b/src/interfaces/chain.h\r\nindex fb77c81cdcb..c76a361f261 100644\r\n--- a/src/interfaces/chain.h\r\n+++ b/src/interfaces/chain.h\r\n@@ -185,6 +185,9 @@ public:\r\n     //! Check if transaction is RBF opt in.\r\n     virtual RBFTransactionState isRBFOptIn(const CTransaction& tx) = 0;\r\n \r\n+    //! Check if transaction is in mempool.\r\n+    virtual bool isInMempool(const uint256& txid) = 0;\r\n+\r\n     //! Check if transaction has descendants in mempool.\r\n     virtual bool hasDescendantsInMempool(const uint256& txid) = 0;\r\n \r\ndiff --git a/src/wallet/wallet.cpp b/src/wallet/wallet.cpp\r\nindex 7a6deab1a8c..833414d4880 100644\r\n--- a/src/wallet/wallet.cpp\r\n+++ b/src/wallet/wallet.cpp\r\n@@ -707,6 +707,12 @@ bool CWallet::MarkReplaced(const uint256& originalHash, const uint256& newHash)\r\n \r\n     wtx.mapValue[\"replaced_by_txid\"] = newHash.ToString();\r\n \r\n+    // Refresh mempool status without waiting for transactionRemovedFromMempool\r\n+    // notification so the wallet is in an internally consistent state and\r\n+    // immediately knows the old transaction should not be considered trusted\r\n+    // and is eligible to be abandoned\r\n+    wtx.fInMempool = chain().isInMempool(originalHash);\r\n+\r\n     WalletBatch batch(*database, \"r+\");\r\n \r\n     bool success = true;\r\n```\r\n",
      "created_at" : "2020-05-01T17:45:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18842#issuecomment-622489245",
      "id" : 622489245,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18842",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMjQ4OTI0NQ==",
      "updated_at" : "2020-05-01T17:45:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/622489245",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.\r\n\r\nThis looks a bug to me, a test would be nice.\r\n\r\n@ryanofsky how could `chain().isInMempool(originalHash)` be true?\r\n\r\nI find odd that `mapValue[\"replaces_txid\"]` is updated in feebumper and `mapValue[\"replaced_by_txid\"]` is updated in wallet. Maybe we could move `CWallet::MarkReplaced` to feebumper.",
      "created_at" : "2020-08-15T00:13:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18842#issuecomment-674318296",
      "id" : 674318296,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18842",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3NDMxODI5Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-15T00:13:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/674318296",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nNo conflicts as of last run.",
      "created_at" : "2020-09-20T04:22:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18842#issuecomment-695690717",
      "id" : 695690717,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18842",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5NTY5MDcxNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-06T03:32:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/695690717",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-10-14T14:15:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18842#issuecomment-708432437",
      "id" : 708432437,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18842",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwODQzMjQzNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-14T14:15:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/708432437",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Apparently the backwards compatibility test is still intermittently failing. Needs rebase.",
      "created_at" : "2021-03-03T13:51:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18842#issuecomment-789728180",
      "id" : 789728180,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18842",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4OTcyODE4MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-03T13:51:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/789728180",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased. Not addressed any feedback, because the question by @promag hasn't been answered: \"@ryanofsky how could chain().isInMempool(originalHash) be true?\"",
      "created_at" : "2021-03-05T16:14:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18842#issuecomment-791520582",
      "id" : 791520582,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18842",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MTUyMDU4Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-05T16:14:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/791520582",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Rebased. Not addressed any feedback, because the question by @promag hasn't been answered: \"@ryanofsky how could chain().isInMempool(originalHash) be true?\"\r\n\r\nI think it should be true because MarkReplaced should be called after the new transaction is committed and the old transaction is no longer in the mempool. As I understand it, the race happens because `transactionRemovedFromMempool` notification hasn't been processed yet, not because the old transaction is actually in the mempool.",
      "created_at" : "2021-03-05T16:38:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18842#issuecomment-791536626",
      "id" : 791536626,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18842",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MTUzNjYyNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-05T16:38:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/791536626",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Oh sorry, I answered why the question how could it be false, not how could it be true. It could be true if MarkReplaced was called at unexpected time on a transaction that wasn't successfully replaced, or maybe restored after a replacement was abandoned. So the change was suggested to make MarkReplaced safer. An alternative to:\r\n\r\n```c++\r\nwtx.fInMempool = chain().isInMempool(originalHash);\r\n```\r\n\r\ncould be:\r\n\r\n```c++\r\nassert(!chain().isInMempool(originalHash));\r\nwtx.fInMempool = false;\r\n```\r\n\r\nand I think either of these would be more safe. Adding the comment from https://github.com/bitcoin/bitcoin/pull/18842#issuecomment-622489245 could also be helpful.",
      "created_at" : "2021-03-05T17:00:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18842#issuecomment-791550092",
      "id" : 791550092,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18842",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MTU1MDA5Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-05T17:03:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/791550092",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Code review ACK faeedff5c87091fd83d2fb2b29eb49c948363f29 or for any of the suggested alternatives.",
      "created_at" : "2021-03-05T17:01:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18842#issuecomment-791551132",
      "id" : 791551132,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18842",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MTU1MTEzMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-05T17:02:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/791551132",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> assert(!chain().isInMempool(originalHash));\r\n\r\nThis seems fragile, as it (in theory) may crash the node. Imagine calling `bumpfee`, then deprioritizing the tx with `prioritizetransaction`, then adding back the original tx (before the interface call can complete).\r\n\r\n",
      "created_at" : "2021-03-05T17:49:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18842#issuecomment-791579548",
      "id" : 791579548,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18842",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MTU3OTU0OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-05T17:49:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/791579548",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> > assert(!chain().isInMempool(originalHash));\r\n> \r\n> This seems fragile, as it (in theory) may crash the node. Imagine calling `bumpfee`, then deprioritizing the tx with `prioritizetransaction`, then adding back the original tx (before the interface call can complete).\r\n\r\nRight, that's why I suggested `wtx.fInMempool = chain().isInMempool(originalHash);` to do the correct thing in this case. But crashing seems better than doing the wrong thing if we don't want to handle this case.",
      "created_at" : "2021-03-05T17:55:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18842#issuecomment-791583397",
      "id" : 791583397,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18842",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MTU4MzM5Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-05T17:55:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/791583397",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Or you could replace crashing assert with throwing CHECK.  Basically https://github.com/bitcoin/bitcoin/pull/18842#issuecomment-622489245 is still my preferred alternative, but all alternatives discussed and current PR seem fine.",
      "created_at" : "2021-03-05T17:58:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18842#issuecomment-791584702",
      "id" : 791584702,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18842",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MTU4NDcwMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-05T17:59:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/791584702",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> to do the correct thing in this case\r\n\r\nI don't think it is possible to do a thing that is correct in all scenarios. The wallet is an async subscriber of the mempool, so if there are any mempool RPCs called concurrently (and conflicting) with wallet RPCs there is no way to \"do the correct thing\". The design here is that the wallet will eventually catch up with the correct data if you give it enough time to eat all previous in-flight notifications.",
      "created_at" : "2021-03-05T18:16:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18842#issuecomment-791594633",
      "id" : 791594633,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18842",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MTU5NDYzMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-05T18:16:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/791594633",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Is there something not correct about `wtx.fInMempool = chain().isInMempool(originalHash);` with cs_wallet held?",
      "created_at" : "2021-03-05T18:28:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18842#issuecomment-791601417",
      "id" : 791601417,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18842",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MTYwMTQxNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-05T18:28:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/791601417",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "It won't crash the node, but adding it doesn't guarantee that the in-mempool status is correct at all times.\r\n\r\nImagine calling `bumpfee`, concurrently you deprioritize the new tx with `prioritizetransaction`, then adding back the original tx with `sendrawtransaction`. Then `wtx.fInMempool = chain().isInMempool(originalHash);` assigns `true`. But immediately afterward you remove the deprioritization and call `sendrawtransaction` with the bumped-fee tx. `sendrawtransaction` is not a wallet RPC, so the status will incorrectly be `fInMempool=true` for the original tx, when it should be `false`.",
      "created_at" : "2021-03-05T18:37:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18842#issuecomment-791605971",
      "id" : 791605971,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18842",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MTYwNTk3MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-05T18:39:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/791605971",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Imagine calling `bumpfee`, concurrently you deprioritize the new tx with `prioritizetransaction`, then adding back the original tx with `sendrawtransaction`. Then `wtx.fInMempool = chain().isInMempool(originalHash);` assigns `true`\r\n\r\nI think can you avoid problems here just holding cs_wallet throughout the bumpfee call. I haven't dug into the details of what we're doing, but clearly what we're doing now is incorrect.\r\n\r\nI'm not sure if you prefer blindly assigning `wtx.fInMempool = false` over assigning `wtx.fInMempool = isInMempool(wtx)`. If you do, I guess I have a different preference and think that latter would be more correct in long run even if it doesn't fix every problem right now. But either choice seems fine and would be better than current behavior.",
      "created_at" : "2021-03-05T19:01:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18842#issuecomment-791618228",
      "id" : 791618228,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18842",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MTYxODIyOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-05T19:01:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/791618228",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks, force pushed your patch (needed rebased)",
      "created_at" : "2021-03-07T11:19:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18842#issuecomment-792260413",
      "id" : 792260413,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18842",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MjI2MDQxMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-07T11:19:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/792260413",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This variant has two ACKs, so I think it is good to go in",
      "created_at" : "2021-03-09T06:53:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18842#issuecomment-793464220",
      "id" : 793464220,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18842",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MzQ2NDIyMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-09T06:53:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/793464220",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
