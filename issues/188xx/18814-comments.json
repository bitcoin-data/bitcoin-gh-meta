[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #18452 (qt: Fix shutdown when waitfor* cmds are called from RPC console by hebasto)\n* #18354 (Protect wallet by using shared pointers by bvbfan)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-04-29T10:56:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18814#issuecomment-621127303",
      "id" : 621127303,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18814",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMTEyNzMwMw==",
      "updated_at" : "2020-05-10T22:59:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/621127303",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18814#discussion_r417262916"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18814"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417262916"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think this could introduce a bug where wallet never relocks.\r\n\r\nIn case where walletpassphrase is called from two threads, first thread sets `pwallet->nRelockTime` and is interrupted after constructing lambda but before invoking rpcRunLater. Second thread sets `pwallet->nRelockTime` to a different value and calls `rpcRunLater`, and then first thread wakes up and calls `rpcRunLater`.\r\n\r\nLambda from second thread never runs because lambda from first thread replaced it. But lambda from first thread has the wrong `relock_time` value so never relocks the wallet.\r\n\r\nSimplest fix might be adding relock time to timer names \"lockwallet(%s,%i)\" above to make them unique",
      "commit_id" : "b0f1e19f82d725dbefb4b0ac69e4d74f2deb1d44",
      "created_at" : "2020-04-29T12:04:35Z",
      "diff_hunk" : "@@ -1957,9 +1959,11 @@ static UniValue walletpassphrase(const JSONRPCRequest& request)\n     // wallet before the following callback is called. If a valid shared pointer\n     // is acquired in the callback then the wallet is still loaded.\n     std::weak_ptr<CWallet> weak_wallet = wallet;\n-    pwallet->chain().rpcRunLater(strprintf(\"lockwallet(%s)\", pwallet->GetName()), [weak_wallet] {\n+    pwallet->chain().rpcRunLater(strprintf(\"lockwallet(%s)\", pwallet->GetName()), [weak_wallet, relock_time] {\n         if (auto shared_wallet = weak_wallet.lock()) {\n             LOCK(shared_wallet->cs_wallet);\n+            // Skip if this is not the most recent rpcRunLater callback.\n+            if (shared_wallet->nRelockTime != relock_time) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18814#discussion_r417262916",
      "id" : 417262916,
      "line" : 1968,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI2MjkxNg==",
      "original_commit_id" : "5a0486cd15c26e5e587f56f331dec3a7756407b2",
      "original_line" : 1968,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : 27,
      "pull_request_review_id" : 402600925,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18814",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-29T20:34:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417262916",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Would be nice to write a test for this",
      "created_at" : "2020-04-29T12:22:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18814#issuecomment-621167692",
      "id" : 621167692,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18814",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMTE2NzY5Mg==",
      "updated_at" : "2020-04-29T12:22:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/621167692",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18814#discussion_r417276244"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18814"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417276244"
         }
      },
      "author_association" : "MEMBER",
      "body" : "That would make timers list grow - they are never removed, just replaced.\r\n\r\n",
      "commit_id" : "b0f1e19f82d725dbefb4b0ac69e4d74f2deb1d44",
      "created_at" : "2020-04-29T12:29:09Z",
      "diff_hunk" : "@@ -1957,9 +1959,11 @@ static UniValue walletpassphrase(const JSONRPCRequest& request)\n     // wallet before the following callback is called. If a valid shared pointer\n     // is acquired in the callback then the wallet is still loaded.\n     std::weak_ptr<CWallet> weak_wallet = wallet;\n-    pwallet->chain().rpcRunLater(strprintf(\"lockwallet(%s)\", pwallet->GetName()), [weak_wallet] {\n+    pwallet->chain().rpcRunLater(strprintf(\"lockwallet(%s)\", pwallet->GetName()), [weak_wallet, relock_time] {\n         if (auto shared_wallet = weak_wallet.lock()) {\n             LOCK(shared_wallet->cs_wallet);\n+            // Skip if this is not the most recent rpcRunLater callback.\n+            if (shared_wallet->nRelockTime != relock_time) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18814#discussion_r417276244",
      "id" : 417276244,
      "in_reply_to_id" : 417262916,
      "line" : 1968,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI3NjI0NA==",
      "original_commit_id" : "5a0486cd15c26e5e587f56f331dec3a7756407b2",
      "original_line" : 1968,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : 27,
      "pull_request_review_id" : 402617630,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18814",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-29T20:34:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417276244",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for reviewing @ryanofsky. I'll address that case.\r\n\r\n@MarcoFalke probably a unit test no?",
      "created_at" : "2020-04-29T12:38:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18814#issuecomment-621176155",
      "id" : 621176155,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18814",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMTE3NjE1NQ==",
      "updated_at" : "2020-04-29T12:38:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/621176155",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Yes, I haven't looked at the code changes, but I assume some kind of unit test makes sense.",
      "created_at" : "2020-04-29T12:56:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18814#issuecomment-621185922",
      "id" : 621185922,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18814",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMTE4NTkyMg==",
      "updated_at" : "2020-04-29T12:56:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/621185922",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Also, this needs backport, right?",
      "created_at" : "2020-04-29T13:17:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18814#issuecomment-621198353",
      "id" : 621198353,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18814",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMTE5ODM1Mw==",
      "updated_at" : "2020-04-29T13:17:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/621198353",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18814#discussion_r417613093"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18814"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417613093"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added a mutex to prevent concurrent calls with the same wallet. The lock is held during wallet `Unlock` and `RPCRunLater` so the case you describe can't happen.",
      "commit_id" : "b0f1e19f82d725dbefb4b0ac69e4d74f2deb1d44",
      "created_at" : "2020-04-29T21:09:01Z",
      "diff_hunk" : "@@ -1957,9 +1959,11 @@ static UniValue walletpassphrase(const JSONRPCRequest& request)\n     // wallet before the following callback is called. If a valid shared pointer\n     // is acquired in the callback then the wallet is still loaded.\n     std::weak_ptr<CWallet> weak_wallet = wallet;\n-    pwallet->chain().rpcRunLater(strprintf(\"lockwallet(%s)\", pwallet->GetName()), [weak_wallet] {\n+    pwallet->chain().rpcRunLater(strprintf(\"lockwallet(%s)\", pwallet->GetName()), [weak_wallet, relock_time] {\n         if (auto shared_wallet = weak_wallet.lock()) {\n             LOCK(shared_wallet->cs_wallet);\n+            // Skip if this is not the most recent rpcRunLater callback.\n+            if (shared_wallet->nRelockTime != relock_time) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18814#discussion_r417613093",
      "id" : 417613093,
      "in_reply_to_id" : 417262916,
      "line" : 1968,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYxMzA5Mw==",
      "original_commit_id" : "5a0486cd15c26e5e587f56f331dec3a7756407b2",
      "original_line" : 1968,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : 27,
      "pull_request_review_id" : 403041091,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18814",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-29T21:09:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417613093",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> A unit test could be a good idea, but might be difficult to write\r\n\r\nFWIW I'm still trying this.",
      "created_at" : "2020-04-29T21:58:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18814#issuecomment-621487300",
      "id" : 621487300,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18814",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMTQ4NzMwMA==",
      "updated_at" : "2020-04-29T21:58:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/621487300",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> instead of blocking waiting for the old callback to finish.\r\n\r\nBTW If we bump minimum libevent then we could use this https://github.com/libevent/libevent/blob/29cc8386a2f7911eaa9336692a2c5544d8b4734f/whatsnew-2.1.txt#L248-L265\r\n",
      "created_at" : "2020-04-29T22:11:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18814#issuecomment-621492478",
      "id" : 621492478,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18814",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMTQ5MjQ3OA==",
      "updated_at" : "2020-04-29T22:11:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/621492478",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Bumping libevent should be discussed separately. See also #18676 ",
      "created_at" : "2020-04-29T22:30:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18814#issuecomment-621501209",
      "id" : 621501209,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18814",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMTUwMTIwOQ==",
      "updated_at" : "2020-04-29T22:30:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/621501209",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Also, I haven't looked but I doubt there's a need for a special libevent feature to improve rpcRunLater. We should just need an extra bit of code at the end of the existing libevent callback to register a new callback if there's one pending",
      "created_at" : "2020-04-29T22:37:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18814#issuecomment-621503715",
      "id" : 621503715,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18814",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMTUwMzcxNQ==",
      "updated_at" : "2020-04-29T22:37:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/621503715",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18814#discussion_r419169288"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18814"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/419169288"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Nice catch BTW.",
      "commit_id" : "b0f1e19f82d725dbefb4b0ac69e4d74f2deb1d44",
      "created_at" : "2020-05-03T22:30:53Z",
      "diff_hunk" : "@@ -1957,9 +1959,11 @@ static UniValue walletpassphrase(const JSONRPCRequest& request)\n     // wallet before the following callback is called. If a valid shared pointer\n     // is acquired in the callback then the wallet is still loaded.\n     std::weak_ptr<CWallet> weak_wallet = wallet;\n-    pwallet->chain().rpcRunLater(strprintf(\"lockwallet(%s)\", pwallet->GetName()), [weak_wallet] {\n+    pwallet->chain().rpcRunLater(strprintf(\"lockwallet(%s)\", pwallet->GetName()), [weak_wallet, relock_time] {\n         if (auto shared_wallet = weak_wallet.lock()) {\n             LOCK(shared_wallet->cs_wallet);\n+            // Skip if this is not the most recent rpcRunLater callback.\n+            if (shared_wallet->nRelockTime != relock_time) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18814#discussion_r419169288",
      "id" : 419169288,
      "in_reply_to_id" : 417262916,
      "line" : 1968,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE2OTI4OA==",
      "original_commit_id" : "5a0486cd15c26e5e587f56f331dec3a7756407b2",
      "original_line" : 1968,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : 27,
      "pull_request_review_id" : 404663652,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18814",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-03T22:30:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/419169288",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> FWIW I'm still trying this.\r\n\r\nAnd I quit. Tried with unit test but it required to start HTTP/RPC server because of libevent and timer stuff. Then tried funcional test but can't figure how to hit the problem.\r\n\r\n@ryanofsky I'll borrow your comment above to improve PR description.",
      "created_at" : "2020-05-03T22:34:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18814#issuecomment-623193625",
      "id" : 623193625,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18814",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMzE5MzYyNQ==",
      "updated_at" : "2020-05-03T22:34:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/623193625",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "This still looks good but it might be simpler to squash second and third commits to avoid having a bug in the second commit which is fixed by the third commit.\r\n\r\nThis would simplify the PR description so you could drop the paragraph \"Failure to relock race condition in 59a50e7\" about the temporary bug.",
      "created_at" : "2020-05-07T00:38:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18814#issuecomment-624963210",
      "id" : 624963210,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18814",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyNDk2MzIxMA==",
      "updated_at" : "2020-05-07T00:38:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/624963210",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Done.",
      "created_at" : "2020-05-07T00:45:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18814#issuecomment-624964941",
      "id" : 624964941,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18814",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyNDk2NDk0MQ==",
      "updated_at" : "2020-05-07T00:45:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/624964941",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Code review ACK 9f59dde9740d065118bdddde75ef9f4e4603a7b1. No changes since last review except squashing commits.\r\n\r\nTwo other thoughts:\r\n\r\n- It might be nice to add a comment for [`RPCRunLater`](https://github.com/bitcoin/bitcoin/blob/7bcc42b4035b878719d13201286e322989b415c5/src/rpc/server.h#L78-L82) that mentions the risk of deadlocks:\r\n\r\n  ```c++\r\n  /** \r\n   * Run func nSeconds from now. \r\n   * Overrides previous timer <name> (if any).\r\n   *\r\n   * If previous timer has started executing, this will block waiting for the call\r\n   * to return. Therefore, to avoid deadlocks, RPCRunLater can't be called while\r\n   * holding locks that a previous timer might be waiting for.\r\n   *\r\n   * @todo Make implementation nonblocking to avoid risk of deadlocks and simplify\r\n   * usage.\r\n   */ \r\n  void RPCRunLater(const std::string& name, std::function<void()> func, int64_t nSeconds);\r\n  ```\r\n\r\n* This is an idea for a new PR, but maybe there should be an RPC function to return a timer's scheduled time so we could drop `CWallet::nRelockTime`",
      "created_at" : "2020-05-07T01:04:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18814#issuecomment-624969955",
      "id" : 624969955,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18814",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyNDk2OTk1NQ==",
      "updated_at" : "2020-05-07T01:06:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/624969955",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK 9f59dde9740d065118bdddde75ef9f4e4603a7b1",
      "created_at" : "2020-05-11T14:45:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18814#issuecomment-626748762",
      "id" : 626748762,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18814",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyNjc0ODc2Mg==",
      "updated_at" : "2020-05-11T14:45:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/626748762",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@ryanofsky honestly I'd suggest to avoid using it. Instead of timeout what I think would be best is to exclusively \"bind\" the unlock to the current RPC connection. In the GUI we could have a timer. I don't see other uses of the timer in the server.",
      "created_at" : "2020-05-13T10:01:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18814#issuecomment-627882950",
      "id" : 627882950,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18814",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyNzg4Mjk1MA==",
      "updated_at" : "2020-05-13T10:01:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/627882950",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   }
]
