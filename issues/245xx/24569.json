{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "MEMBER",
   "body" : "With this change, I'm now seeing cross-architecture reproducibility from our Guix build (release) process. Given the same code, doing a Guix build on `x86_64` and `aarch64` (arm64 Apple M1) hardware now gives the exact same binaries.\r\n\r\nThe code change to our build script is a bit yuck (hence draft), and generating the correct store paths is a multi-phase process, as modifying glibc to insert the debug-prefix option for the native compiler, changes the store path hashes of the then-rebuilt GCC 10 toolchain, however once we have them, they should be stable for a given commit in our Guix time-machine.\r\n\r\nGiven that glibc startup code ends up in our binaries, we also need to patch out any `/gnu/store/*` paths that may end up in the debug info for it's objects/libs i.e:\r\n```bash\r\n The Directory Table (offset 0xff5619):\r\n  1\t/gnu/store/2d2r6jcsdjf6i3nzbrmf13psxmpwz55w-gcc-cross-sans-libc-x86_64-linux-gnu-7.5.0-lib/lib/gcc/x86_64-linux-gnu/7.5.0/include\r\n\r\n The File Name Table (offset 0xff569c):\r\n  Entry\tDir\tTime\tSize\tName\r\n  1\t0\t0\t0\telf-init.c\r\n  2\t1\t0\t0\tstddef.h\r\n```\r\n\r\nTwo points on that:\r\n* We currently use a GCC 7 native compiler, which is why `-fdebug-prefix-map` is used instead of `-ffile-prefix-map=`. The later is only supported by GCC 8 and older.\r\n* Newer glibcs have actually introduced [an option](https://www.gnu.org/software/libc/manual/html_node/Configuring-and-compiling.html) (`--with-nonshared-cflags=`) to make it easier to:\r\n> Use additional compiler flags cflags to build the parts of the library which are always statically linked into applications and libraries even with shared linking.\r\n\r\nwhich means in future we could potentially use this, as an additional glibc configure option, rather than patching a glibc Makefile.\r\n\r\nRelated to #21194.\r\n\r\nGuix build on x86_64:\r\n```bash\r\nuname -a\r\nLinux 1ab0f609970a 5.13.0-1017-aws #19~20.04.1-Ubuntu SMP Mon Mar 7 12:53:12 UTC 2022 x86_64 Linux\r\n```\r\n\r\n```bash\r\ne3bb0544efc5e3d377cee5714e0e8bbe048ebedcb8981ae738055fd61e2422e1  guix-build-9cf6d7d89390/output/dist-archive/bitcoin-9cf6d7d89390.tar.gz\r\naa994b2edfbca77269e71e5a8d3464d3429ceb252cb3939bc301e1194636e566  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/SHA256SUMS.part\r\n3f53813e74c11c528a677f454873e17a873fc2c2dedcc11c3ee3e7db64355da5  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390-x86_64-linux-gnu-debug.tar.gz\r\n9ada6333aa20f0a7124ca08471a02759951d017e6af12a5554693e8efb4f15bd  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390-x86_64-linux-gnu.tar.gz\r\n3990edfa2fa4d29acc332f61ad95996c7760ec77563130fe3daafd222eb393d3  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/README.md\r\n1b797c31235c1034d2df2729e0c68d7de600131727e3c9a42521d48a1a24f3c7  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/bin/bitcoin-cli\r\n11d01327ef0c87296c01f46f2ef3843b4895091341f41c5e6635fba7b105941d  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/bin/bitcoin-cli.dbg\r\n73569b03799c50ffc92c80489b935d9643165786e0e7724844ee8638d49e7f95  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/bin/bitcoin-qt\r\n41ec7c787a7ddac8214970b7b32e87b00b069b8a274871b724f6d3ed0a4e7a90  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/bin/bitcoin-qt.dbg\r\nf905cdb727cce29166502ea70d1917a284143d2bb1297895f074aec0fcf13e5f  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/bin/bitcoin-tx\r\n86ebbc36d64bf8d94a1761e5fac3f6edd63e59f0022c2cbd9ed8995b0b14f294  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/bin/bitcoin-tx.dbg\r\neb49cd79f143bf574eabfba8f7112323eb85a0f2fddea1d28357f02af7739ed0  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/bin/bitcoin-util\r\n40d4a822e6a7dfd75a2a86c0a4685fec7cf56480f962917bc7f7ecd193cc5af4  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/bin/bitcoin-util.dbg\r\na87b7b4220379e6ef6c9b8744c0de1d5cadaf48f41dce6a3cd4057b12f6127f7  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/bin/bitcoin-wallet\r\n24d79d1c0920335f944bcb180d126150151d80d6375c8a5a1020bf5d238ac291  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/bin/bitcoin-wallet.dbg\r\n175a1ec3e721e457bcec95791beb8cfc5573621a5ddd78e9c9f65d43c8332899  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/bin/bitcoind\r\n35d6a79bfcc6f7591eed887bd4e6a3f89d6f874704d27ef63083dc70ae123eaa  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/bin/bitcoind.dbg\r\n3d97a53717c9ca9460a6f1ea6802f64a3bf9bcdfc3977b6beca5d462df9dc89f  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/bin/test_bitcoin\r\n86073797f1c5a9df4e72a20f008c6deae159fb5c70c5c76e825e1d38bd06a411  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/bin/test_bitcoin.dbg\r\n36127300d74413c6e0e16bc3a1331598128ff93b103cd033ad4ade3cdeeadbec  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/include/bitcoinconsensus.h\r\ncb0ade6c79774358efb502fadaef7d02894e43d96110cd914a61a659f81c7f95  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/lib/libbitcoinconsensus.so.0.0.0\r\n1101b54af2d1ed9110227d782614cf687329404ff04e95d6b5556df8d328010a  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/lib/libbitcoinconsensus.so.0.0.0.dbg\r\n6722c631147686338875b2384ef9cdaf976b5df9f0d79eb03a8d2ec8218005f6  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/share/man/man1/bitcoin-cli.1\r\n4c8e6a876222d5451574abefaeb716fd1735e2001cb0dbd40c98a296eec763b1  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/share/man/man1/bitcoin-qt.1\r\nf59c03e2dc314adbded43bfb94fb5d3f94b64064ec409683ef1a4bae3ebd9be1  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/share/man/man1/bitcoin-tx.1\r\n5356bea504330cd7c07e9598d45e689d8531d72eb82460536604b878a5d44954  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/share/man/man1/bitcoin-util.1\r\nc6a810006423b2923b9d13d5c6e5ae24f5c93ce2527041d2dda88fd779fadb9e  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/share/man/man1/bitcoin-wallet.1\r\n00537e3fb6e839c0f29a7d3b989d8908d6a390cf9a87831f815401346e4f7878  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/share/man/man1/bitcoind.1\r\n```\r\n\r\nGuix build on arm64 (Debian in Docker on Apple M1)\r\n```bash\r\nuname -a \r\nLinux 3b26b9608b88 5.10.104-linuxkit #1 SMP PREEMPT Wed Mar 9 19:01:25 UTC 2022 aarch64 GNU/Linux\r\n```\r\n\r\n```bash\r\ne3bb0544efc5e3d377cee5714e0e8bbe048ebedcb8981ae738055fd61e2422e1  guix-build-9cf6d7d89390/output/dist-archive/bitcoin-9cf6d7d89390.tar.gz\r\naa994b2edfbca77269e71e5a8d3464d3429ceb252cb3939bc301e1194636e566  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/SHA256SUMS.part\r\n3f53813e74c11c528a677f454873e17a873fc2c2dedcc11c3ee3e7db64355da5  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390-x86_64-linux-gnu-debug.tar.gz\r\n9ada6333aa20f0a7124ca08471a02759951d017e6af12a5554693e8efb4f15bd  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390-x86_64-linux-gnu.tar.gz\r\n3990edfa2fa4d29acc332f61ad95996c7760ec77563130fe3daafd222eb393d3  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/README.md\r\n1b797c31235c1034d2df2729e0c68d7de600131727e3c9a42521d48a1a24f3c7  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/bin/bitcoin-cli\r\n11d01327ef0c87296c01f46f2ef3843b4895091341f41c5e6635fba7b105941d  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/bin/bitcoin-cli.dbg\r\n73569b03799c50ffc92c80489b935d9643165786e0e7724844ee8638d49e7f95  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/bin/bitcoin-qt\r\n41ec7c787a7ddac8214970b7b32e87b00b069b8a274871b724f6d3ed0a4e7a90  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/bin/bitcoin-qt.dbg\r\nf905cdb727cce29166502ea70d1917a284143d2bb1297895f074aec0fcf13e5f  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/bin/bitcoin-tx\r\n86ebbc36d64bf8d94a1761e5fac3f6edd63e59f0022c2cbd9ed8995b0b14f294  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/bin/bitcoin-tx.dbg\r\neb49cd79f143bf574eabfba8f7112323eb85a0f2fddea1d28357f02af7739ed0  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/bin/bitcoin-util\r\n40d4a822e6a7dfd75a2a86c0a4685fec7cf56480f962917bc7f7ecd193cc5af4  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/bin/bitcoin-util.dbg\r\na87b7b4220379e6ef6c9b8744c0de1d5cadaf48f41dce6a3cd4057b12f6127f7  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/bin/bitcoin-wallet\r\n24d79d1c0920335f944bcb180d126150151d80d6375c8a5a1020bf5d238ac291  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/bin/bitcoin-wallet.dbg\r\n175a1ec3e721e457bcec95791beb8cfc5573621a5ddd78e9c9f65d43c8332899  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/bin/bitcoind\r\n35d6a79bfcc6f7591eed887bd4e6a3f89d6f874704d27ef63083dc70ae123eaa  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/bin/bitcoind.dbg\r\n3d97a53717c9ca9460a6f1ea6802f64a3bf9bcdfc3977b6beca5d462df9dc89f  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/bin/test_bitcoin\r\n86073797f1c5a9df4e72a20f008c6deae159fb5c70c5c76e825e1d38bd06a411  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/bin/test_bitcoin.dbg\r\n36127300d74413c6e0e16bc3a1331598128ff93b103cd033ad4ade3cdeeadbec  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/include/bitcoinconsensus.h\r\ncb0ade6c79774358efb502fadaef7d02894e43d96110cd914a61a659f81c7f95  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/lib/libbitcoinconsensus.so.0.0.0\r\n1101b54af2d1ed9110227d782614cf687329404ff04e95d6b5556df8d328010a  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/lib/libbitcoinconsensus.so.0.0.0.dbg\r\n6722c631147686338875b2384ef9cdaf976b5df9f0d79eb03a8d2ec8218005f6  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/share/man/man1/bitcoin-cli.1\r\n4c8e6a876222d5451574abefaeb716fd1735e2001cb0dbd40c98a296eec763b1  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/share/man/man1/bitcoin-qt.1\r\nf59c03e2dc314adbded43bfb94fb5d3f94b64064ec409683ef1a4bae3ebd9be1  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/share/man/man1/bitcoin-tx.1\r\n5356bea504330cd7c07e9598d45e689d8531d72eb82460536604b878a5d44954  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/share/man/man1/bitcoin-util.1\r\nc6a810006423b2923b9d13d5c6e5ae24f5c93ce2527041d2dda88fd779fadb9e  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/share/man/man1/bitcoin-wallet.1\r\n00537e3fb6e839c0f29a7d3b989d8908d6a390cf9a87831f815401346e4f7878  guix-build-9cf6d7d89390/output/x86_64-linux-gnu/bitcoin-9cf6d7d89390/share/man/man1/bitcoind.1\r\n```",
   "closed_at" : "2022-03-19T19:28:07Z",
   "closed_by" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
      "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
      "followers_url" : "https://api.github.com/users/fanquake/followers",
      "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
      "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/fanquake",
      "id" : 863730,
      "login" : "fanquake",
      "node_id" : "MDQ6VXNlcjg2MzczMA==",
      "organizations_url" : "https://api.github.com/users/fanquake/orgs",
      "received_events_url" : "https://api.github.com/users/fanquake/received_events",
      "repos_url" : "https://api.github.com/users/fanquake/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/fanquake"
   },
   "comments" : 9,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24569/comments",
   "created_at" : "2022-03-15T15:15:21Z",
   "draft" : true,
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24569/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/24569",
   "id" : 1169812763,
   "labels" : [
      {
         "color" : "5319e7",
         "default" : false,
         "description" : null,
         "id" : 61889416,
         "name" : "Build system",
         "node_id" : "MDU6TGFiZWw2MTg4OTQxNg==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Build%20system"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24569/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "PR_kwDOABII5840eFil",
   "number" : 24569,
   "performed_via_github_app" : null,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/24569.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24569",
      "merged_at" : null,
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/24569.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24569"
   },
   "reactions" : {
      "+1" : 0,
      "-1" : 0,
      "confused" : 0,
      "eyes" : 1,
      "heart" : 0,
      "hooray" : 1,
      "laugh" : 0,
      "rocket" : 0,
      "total_count" : 2,
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24569/reactions"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "timeline_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24569/timeline",
   "title" : "[POC] guix: cross-architecture reproducibility (x86_64 & aarch64)",
   "updated_at" : "2022-03-19T19:28:07Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24569",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
      "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
      "followers_url" : "https://api.github.com/users/fanquake/followers",
      "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
      "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/fanquake",
      "id" : 863730,
      "login" : "fanquake",
      "node_id" : "MDQ6VXNlcjg2MzczMA==",
      "organizations_url" : "https://api.github.com/users/fanquake/orgs",
      "received_events_url" : "https://api.github.com/users/fanquake/received_events",
      "repos_url" : "https://api.github.com/users/fanquake/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/fanquake"
   }
}
