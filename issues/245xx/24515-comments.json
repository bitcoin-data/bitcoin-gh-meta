[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24515#discussion_r823404090"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/823404090"
         }
      },
      "author_association" : "MEMBER",
      "body" : "is this `std::sort`? If yes, maybe switch to that while touching",
      "commit_id" : "f865cf8ded2b2fbc82a6fbc41226d991909a6880",
      "created_at" : "2022-03-10T07:06:15Z",
      "diff_hunk" : "@@ -220,18 +220,21 @@ bool BlockManager::LoadBlockIndex(\n     }\n \n     // Calculate nChainWork\n-    std::vector<std::pair<int, CBlockIndex*>> vSortedByHeight;\n+    std::vector<CBlockIndex*> vSortedByHeight;\n     vSortedByHeight.reserve(m_block_index.size());\n     for (auto& [_, block_index] : m_block_index) {\n-        vSortedByHeight.push_back(std::make_pair(block_index.nHeight, &block_index));\n+        vSortedByHeight.push_back(&block_index);\n     }\n-    sort(vSortedByHeight.begin(), vSortedByHeight.end());\n+    sort(vSortedByHeight.begin(), vSortedByHeight.end(),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24515#discussion_r823404090",
      "id" : 823404090,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584xFCY6",
      "original_commit_id" : "6741a6957a240e9a0cdbd73df95f247b449e7b72",
      "original_line" : 228,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 905394587,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24515",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/823404090/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-10T10:22:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/823404090",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24515#discussion_r823405905"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/823405905"
         }
      },
      "author_association" : "MEMBER",
      "body" : "maybe add the `const` right here in this commit to avoid a separate commit for a single keyword? Also, could keep the symbol name `block` to reduce the diff by one line :sweat_smile: ",
      "commit_id" : "f865cf8ded2b2fbc82a6fbc41226d991909a6880",
      "created_at" : "2022-03-10T07:09:55Z",
      "diff_hunk" : "@@ -220,18 +220,21 @@ bool BlockManager::LoadBlockIndex(\n     }\n \n     // Calculate nChainWork\n-    std::vector<std::pair<int, CBlockIndex*>> vSortedByHeight;\n+    std::vector<CBlockIndex*> vSortedByHeight;\n     vSortedByHeight.reserve(m_block_index.size());\n     for (auto& [_, block_index] : m_block_index) {\n-        vSortedByHeight.push_back(std::make_pair(block_index.nHeight, &block_index));\n+        vSortedByHeight.push_back(&block_index);\n     }\n-    sort(vSortedByHeight.begin(), vSortedByHeight.end());\n+    sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n+         [](const CBlockIndex* pa, const CBlockIndex* pb) {\n+             return pa->nHeight < pb->nHeight;\n+         });\n \n     // Find start of assumed-valid region.\n     int first_assumed_valid_height = std::numeric_limits<int>::max();\n \n-    for (const auto& [height, block] : vSortedByHeight) {\n-        if (block->IsAssumedValid()) {\n+    for (CBlockIndex* pindex : vSortedByHeight) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24515#discussion_r823405905",
      "id" : 823405905,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584xFC1R",
      "original_commit_id" : "6741a6957a240e9a0cdbd73df95f247b449e7b72",
      "original_line" : 236,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 905394587,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24515",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/823405905/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-10T10:22:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/823405905",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24515#discussion_r823406289"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/823406289"
         }
      },
      "author_association" : "MEMBER",
      "body" : "same",
      "commit_id" : "f865cf8ded2b2fbc82a6fbc41226d991909a6880",
      "created_at" : "2022-03-10T07:10:40Z",
      "diff_hunk" : "@@ -4083,8 +4083,80 @@ bool ChainstateManager::LoadBlockIndex()\n     // Load block index from databases\n     bool needs_init = fReindex;\n     if (!fReindex) {\n-        bool ret = m_blockman.LoadBlockIndexDB(*this);\n+        bool ret = m_blockman.LoadBlockIndexDB();\n         if (!ret) return false;\n+\n+        std::vector<CBlockIndex*> vSortedByHeight;\n+        vSortedByHeight.reserve(m_blockman.m_block_index.size());\n+        for (auto& [_, block_index] : m_blockman.m_block_index) {\n+            vSortedByHeight.push_back(&block_index);\n+        }\n+        sort(vSortedByHeight.begin(), vSortedByHeight.end(),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24515#discussion_r823406289",
      "id" : 823406289,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584xFC7R",
      "original_commit_id" : "f5a20039a4a140679981943fa2e645ded687d14e",
      "original_line" : 4094,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 905394587,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24515",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/823406289/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-10T10:22:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/823406289",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "(Ditto what @MarcoFalke said)",
      "created_at" : "2022-03-10T15:26:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24515#issuecomment-1064182115",
      "id" : 1064182115,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24515",
      "node_id" : "IC_kwDOABII584_biFj",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1064182115/reactions"
      },
      "updated_at" : "2022-03-10T15:26:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1064182115",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#24513](https://github.com/bitcoin/bitcoin/pull/24513) (CChainState -> Chainstate by jamesob)\n* [#24456](https://github.com/bitcoin/bitcoin/pull/24456) (blockman: Properly guard blockfile members by dongcarl)\n* [#24230](https://github.com/bitcoin/bitcoin/pull/24230) (indexes: Stop using node internal types and locking cs_main, improve sync logic by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-03-11T06:36:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24515#issuecomment-1064818752",
      "id" : 1064818752,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24515",
      "node_id" : "IC_kwDOABII584_d9hA",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1064818752/reactions"
      },
      "updated_at" : "2022-03-11T06:36:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1064818752",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "The main thing this PR seems to be doing is moving `chainstate->setBlockIndexCandidates` filling code out of block-manager to chainstate-manager. This seems like it makes sense because you would expect block manager just to deal with low level blocks and not know anything about chain states or validation. Would be good to have @jamesob concept ACK since he added most of the code that's moving",
      "created_at" : "2022-03-14T17:05:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24515#issuecomment-1067070862",
      "id" : 1067070862,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24515",
      "node_id" : "IC_kwDOABII584_mjWO",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1067070862/reactions"
      },
      "updated_at" : "2022-03-14T17:05:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1067070862",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24515#discussion_r826264654"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/826264654"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Only load BlockMan in BlockMan member functions\" (f5a20039a4a140679981943fa2e645ded687d14e)\r\n\r\nIMO, it would be better to add a `std::vector<CBlockIndex*> GetSortedByHeight(BlockManager&)` or similar helper function instead of duplicating this code.",
      "commit_id" : "f865cf8ded2b2fbc82a6fbc41226d991909a6880",
      "created_at" : "2022-03-14T18:34:11Z",
      "diff_hunk" : "@@ -4083,8 +4083,80 @@ bool ChainstateManager::LoadBlockIndex()\n     // Load block index from databases\n     bool needs_init = fReindex;\n     if (!fReindex) {\n-        bool ret = m_blockman.LoadBlockIndexDB(*this);\n+        bool ret = m_blockman.LoadBlockIndexDB();\n         if (!ret) return false;\n+\n+        std::vector<CBlockIndex*> vSortedByHeight;\n+        vSortedByHeight.reserve(m_blockman.m_block_index.size());\n+        for (auto& [_, block_index] : m_blockman.m_block_index) {\n+            vSortedByHeight.push_back(&block_index);\n+        }\n+        sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n+             [](const CBlockIndex* pa, const CBlockIndex* pb) {\n+                 return pa->nHeight < pb->nHeight;\n+             });",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24515#discussion_r826264654",
      "id" : 826264654,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584xP8xO",
      "original_commit_id" : "f5a20039a4a140679981943fa2e645ded687d14e",
      "original_line" : 4097,
      "original_position" : 16,
      "original_start_line" : 4089,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 909237464,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24515",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/826264654/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-03-14T19:10:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/826264654",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24515#discussion_r826290392"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/826290392"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"style-only: No need for std::pair for vSortedByHeight\" (6741a6957a240e9a0cdbd73df95f247b449e7b72)\r\n\r\nThis is fine but I don't really get it. Previous commit is renaming a `pindex` to `block_index`, this one is renaming a `block` variable to `pindex`. If these cleanups were consolidated into one commit, it'd be easier to see if the changes were consistent. (Also of the names I like simple `block` the best).",
      "commit_id" : "f865cf8ded2b2fbc82a6fbc41226d991909a6880",
      "created_at" : "2022-03-14T19:07:22Z",
      "diff_hunk" : "@@ -220,18 +220,21 @@ bool BlockManager::LoadBlockIndex(\n     }\n \n     // Calculate nChainWork\n-    std::vector<std::pair<int, CBlockIndex*>> vSortedByHeight;\n+    std::vector<CBlockIndex*> vSortedByHeight;\n     vSortedByHeight.reserve(m_block_index.size());\n     for (auto& [_, block_index] : m_block_index) {\n-        vSortedByHeight.push_back(std::make_pair(block_index.nHeight, &block_index));\n+        vSortedByHeight.push_back(&block_index);\n     }\n-    sort(vSortedByHeight.begin(), vSortedByHeight.end());\n+    sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n+         [](const CBlockIndex* pa, const CBlockIndex* pb) {\n+             return pa->nHeight < pb->nHeight;\n+         });\n \n     // Find start of assumed-valid region.\n     int first_assumed_valid_height = std::numeric_limits<int>::max();\n \n-    for (const auto& [height, block] : vSortedByHeight) {\n-        if (block->IsAssumedValid()) {\n+    for (CBlockIndex* pindex : vSortedByHeight) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24515#discussion_r826290392",
      "id" : 826290392,
      "in_reply_to_id" : 823405905,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584xQDDY",
      "original_commit_id" : "6741a6957a240e9a0cdbd73df95f247b449e7b72",
      "original_line" : 236,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 909237464,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24515",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/826290392/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-14T19:10:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/826290392",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24515#discussion_r827500760"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/827500760"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed in 28ba0313eac37e4a900b7e97af7169ce999c4024",
      "commit_id" : "f865cf8ded2b2fbc82a6fbc41226d991909a6880",
      "created_at" : "2022-03-15T23:38:50Z",
      "diff_hunk" : "@@ -220,18 +220,21 @@ bool BlockManager::LoadBlockIndex(\n     }\n \n     // Calculate nChainWork\n-    std::vector<std::pair<int, CBlockIndex*>> vSortedByHeight;\n+    std::vector<CBlockIndex*> vSortedByHeight;\n     vSortedByHeight.reserve(m_block_index.size());\n     for (auto& [_, block_index] : m_block_index) {\n-        vSortedByHeight.push_back(std::make_pair(block_index.nHeight, &block_index));\n+        vSortedByHeight.push_back(&block_index);\n     }\n-    sort(vSortedByHeight.begin(), vSortedByHeight.end());\n+    sort(vSortedByHeight.begin(), vSortedByHeight.end(),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24515#discussion_r827500760",
      "id" : 827500760,
      "in_reply_to_id" : 823404090,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584xUqjY",
      "original_commit_id" : "6741a6957a240e9a0cdbd73df95f247b449e7b72",
      "original_line" : 228,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 910941443,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24515",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/827500760/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-15T23:47:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/827500760",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24515#discussion_r827504636"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/827504636"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed in 28ba0313eac37e4a900b7e97af7169ce999c4024",
      "commit_id" : "f865cf8ded2b2fbc82a6fbc41226d991909a6880",
      "created_at" : "2022-03-15T23:47:56Z",
      "diff_hunk" : "@@ -4083,8 +4083,80 @@ bool ChainstateManager::LoadBlockIndex()\n     // Load block index from databases\n     bool needs_init = fReindex;\n     if (!fReindex) {\n-        bool ret = m_blockman.LoadBlockIndexDB(*this);\n+        bool ret = m_blockman.LoadBlockIndexDB();\n         if (!ret) return false;\n+\n+        std::vector<CBlockIndex*> vSortedByHeight;\n+        vSortedByHeight.reserve(m_blockman.m_block_index.size());\n+        for (auto& [_, block_index] : m_blockman.m_block_index) {\n+            vSortedByHeight.push_back(&block_index);\n+        }\n+        sort(vSortedByHeight.begin(), vSortedByHeight.end(),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24515#discussion_r827504636",
      "id" : 827504636,
      "in_reply_to_id" : 823406289,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584xUrf8",
      "original_commit_id" : "f5a20039a4a140679981943fa2e645ded687d14e",
      "original_line" : 4094,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 910946032,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24515",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/827504636/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-15T23:47:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/827504636",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24515#discussion_r827504784"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/827504784"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Absorbed into 42e56d9b188f97c077ed2269e24acc0be35ece17",
      "commit_id" : "f865cf8ded2b2fbc82a6fbc41226d991909a6880",
      "created_at" : "2022-03-15T23:48:19Z",
      "diff_hunk" : "@@ -220,18 +220,21 @@ bool BlockManager::LoadBlockIndex(\n     }\n \n     // Calculate nChainWork\n-    std::vector<std::pair<int, CBlockIndex*>> vSortedByHeight;\n+    std::vector<CBlockIndex*> vSortedByHeight;\n     vSortedByHeight.reserve(m_block_index.size());\n     for (auto& [_, block_index] : m_block_index) {\n-        vSortedByHeight.push_back(std::make_pair(block_index.nHeight, &block_index));\n+        vSortedByHeight.push_back(&block_index);\n     }\n-    sort(vSortedByHeight.begin(), vSortedByHeight.end());\n+    sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n+         [](const CBlockIndex* pa, const CBlockIndex* pb) {\n+             return pa->nHeight < pb->nHeight;\n+         });\n \n     // Find start of assumed-valid region.\n     int first_assumed_valid_height = std::numeric_limits<int>::max();\n \n-    for (const auto& [height, block] : vSortedByHeight) {\n-        if (block->IsAssumedValid()) {\n+    for (CBlockIndex* pindex : vSortedByHeight) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24515#discussion_r827504784",
      "id" : 827504784,
      "in_reply_to_id" : 823405905,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584xUriQ",
      "original_commit_id" : "6741a6957a240e9a0cdbd73df95f247b449e7b72",
      "original_line" : 236,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 910946203,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24515",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/827504784/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-15T23:48:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/827504784",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24515#discussion_r827504931"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/827504931"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "See 28ba0313eac37e4a900b7e97af7169ce999c4024 and f865cf8ded2b2fbc82a6fbc41226d991909a6880",
      "commit_id" : "f865cf8ded2b2fbc82a6fbc41226d991909a6880",
      "created_at" : "2022-03-15T23:48:43Z",
      "diff_hunk" : "@@ -4083,8 +4083,80 @@ bool ChainstateManager::LoadBlockIndex()\n     // Load block index from databases\n     bool needs_init = fReindex;\n     if (!fReindex) {\n-        bool ret = m_blockman.LoadBlockIndexDB(*this);\n+        bool ret = m_blockman.LoadBlockIndexDB();\n         if (!ret) return false;\n+\n+        std::vector<CBlockIndex*> vSortedByHeight;\n+        vSortedByHeight.reserve(m_blockman.m_block_index.size());\n+        for (auto& [_, block_index] : m_blockman.m_block_index) {\n+            vSortedByHeight.push_back(&block_index);\n+        }\n+        sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n+             [](const CBlockIndex* pa, const CBlockIndex* pb) {\n+                 return pa->nHeight < pb->nHeight;\n+             });",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24515#discussion_r827504931",
      "id" : 827504931,
      "in_reply_to_id" : 826264654,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584xUrkj",
      "original_commit_id" : "f5a20039a4a140679981943fa2e645ded687d14e",
      "original_line" : 4097,
      "original_position" : 16,
      "original_start_line" : 4089,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 910946386,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24515",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/827504931/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-03-15T23:48:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/827504931",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Pushed af44e85b920055be4c3f724000a17f9d8d31d5ae to f865cf8ded2b2fbc82a6fbc41226d991909a6880\r\n- Addressed all outstanding minor comments",
      "created_at" : "2022-03-15T23:49:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24515#issuecomment-1068575758",
      "id" : 1068575758,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24515",
      "node_id" : "IC_kwDOABII584_sSwO",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1068575758/reactions"
      },
      "updated_at" : "2022-03-15T23:49:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1068575758",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "ACK f865cf8ded2b2fbc82a6fbc41226d991909a6880 ; code review only",
      "created_at" : "2022-03-16T20:54:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24515#issuecomment-1069623072",
      "id" : 1069623072,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24515",
      "node_id" : "IC_kwDOABII584_wScg",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1069623072/reactions"
      },
      "updated_at" : "2022-03-16T20:54:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1069623072",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   }
]
