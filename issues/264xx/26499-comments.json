[
   {
      "author_association" : "MEMBER",
      "body" : "Approach NACK I think. Shouldn't these already be conflicted?",
      "created_at" : "2022-11-14T23:40:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26499#issuecomment-1314553422",
      "id" : 1314553422,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26499",
      "node_id" : "IC_kwDOABII585OWn5O",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1314553422/reactions"
      },
      "updated_at" : "2022-11-14T23:40:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1314553422",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Shouldn't these already be conflicted?\r\n\r\nNope, see the linked issue. Anything that is invalidated by a reorg just gets marked as \"inactive\" which means \"unconfirmed and not in mempool\".\r\n\r\nI looked at marking such txs as conflicted, but ran into some issues with setting the conflicting blockhash and height as `invalidateblock` just marks something as invalid (and reorgs out everything) without having a conflicting block.",
      "created_at" : "2022-11-15T00:15:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26499#issuecomment-1314579374",
      "id" : 1314579374,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26499",
      "node_id" : "IC_kwDOABII585OWuOu",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1314579374/reactions"
      },
      "updated_at" : "2022-11-15T00:15:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1314579374",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I guess in the context of `invalidateblock`, the transaction should be entirely invalid and thus not in the wallet at all. But that would be ugly, especially after it's already there.\r\n\r\nI'm not sure unusual cases like that should get in the way of doing the right thing for the normal conflict case, though. And even that unusual case should resolve cleanly if we handle the normal case, after a competing block is accepting.",
      "created_at" : "2022-11-15T01:47:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26499#issuecomment-1314644660",
      "id" : 1314644660,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26499",
      "node_id" : "IC_kwDOABII585OW-K0",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1314644660/reactions"
      },
      "updated_at" : "2022-11-15T01:47:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1314644660",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> In the second commit, you mentioned the unconfirmed ancestors should be marked as abandoned even when the orphan coinbase has been reorged into the main chain.\r\n\r\nIt's \"should\" as in that is the expected behavior given the current code, not \"should\" as in the correct thing to do.\r\n\r\n> What's the reasoning behind this?\r\n> \r\n> If, say, I mine a block and create descendant transactions from it, and say it got orphaned, so I further mine over it and say I was successful in making it part of the main chain, why should my transactions, created using this block's coinbase transaction should get abandoned?\r\n\r\nI've implemented it this way because it's not clear to me what we should actually be doing. The descendants could be added back to the mempool, but that also has a privacy impact - rebroadcasting all of these transactions at the same time can link them all as being related to a single particular wallet. This privacy impact is made worse by the fact that there was a reorg as it is unlikely that other nodes on the network have them in their mempool already. Additionally, there's a technical challenge of identifying which to broadcast. It could be that some descendants also spend other coinbase outputs that were also reorged. One block being reorged back into the chain does not mean that the descendant blocks are as well.\r\n\r\nGiven that this is only relevant in the cases of 100+ block reorgs, I think that it's reasonable to expect users affected by this issue to be actively involved and paying attention. Leaving the transactions abandoned just means that the user will have to rebroadcast the transactions themselves. Considering the rarity of this situation in practice, I don't think it's worth the effort to implement anything more complex either.",
      "created_at" : "2022-11-15T16:34:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26499#issuecomment-1315570912",
      "id" : 1315570912,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26499",
      "node_id" : "IC_kwDOABII585OagTg",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1315570912/reactions"
      },
      "updated_at" : "2022-11-15T16:34:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1315570912",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26499#discussion_r1023589065"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26499"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1023589065"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit:\r\n```suggestion\r\n        # We expect the descendants of orphaned rewards to no longer be considered\r\n```",
      "commit_id" : "b5e49a4b31debdc1801a22cc1de1542ab5f205c6",
      "created_at" : "2022-11-16T07:23:56Z",
      "diff_hunk" : "@@ -32,28 +32,31 @@ def run_test(self):\n         self.generate(self.nodes[0], 150)\n         assert_equal(self.nodes[1].getbalance(), 10 + 25)\n         txid = self.nodes[1].sendtoaddress(self.nodes[0].getnewaddress(), 30)\n+        orig_chain_tip = self.nodes[0].getbestblockhash()\n \n         # Orphan the block reward and make sure that the original coins\n         # from the wallet can still be spent.\n         self.nodes[0].invalidateblock(blk)\n-        self.generate(self.nodes[0], 152)\n-        # Without the following abandontransaction call, the coins are\n-        # not considered available yet.\n-        assert_equal(self.nodes[1].getbalances()[\"mine\"], {\n-          \"trusted\": 0,\n-          \"untrusted_pending\": 0,\n-          \"immature\": 0,\n-        })\n-        # The following abandontransaction is necessary to make the later\n-        # lines succeed, and probably should not be needed; see\n-        # https://github.com/bitcoin/bitcoin/issues/14148.\n-        self.nodes[1].abandontransaction(txid)\n+        blocks = self.generate(self.nodes[0], 152)\n+        conflict_block = blocks[0]\n+        # We expect the desendants of orphaned rewards to no longer be considered",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26499#discussion_r1023589065",
      "id" : 1023589065,
      "line" : 42,
      "node_id" : "PRRC_kwDOABII5849ArrJ",
      "original_commit_id" : "b5e49a4b31debdc1801a22cc1de1542ab5f205c6",
      "original_line" : 42,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "test/functional/wallet_orphanedreward.py",
      "position" : 23,
      "pull_request_review_id" : 1181997922,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26499",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1023589065/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-16T07:46:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1023589065",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/36541669?v=4",
         "events_url" : "https://api.github.com/users/rajarshimaitra/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rajarshimaitra/followers",
         "following_url" : "https://api.github.com/users/rajarshimaitra/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rajarshimaitra/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rajarshimaitra",
         "id" : 36541669,
         "login" : "rajarshimaitra",
         "node_id" : "MDQ6VXNlcjM2NTQxNjY5",
         "organizations_url" : "https://api.github.com/users/rajarshimaitra/orgs",
         "received_events_url" : "https://api.github.com/users/rajarshimaitra/received_events",
         "repos_url" : "https://api.github.com/users/rajarshimaitra/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rajarshimaitra/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rajarshimaitra/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rajarshimaitra"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26499#discussion_r1023595815"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26499"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1023595815"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Should it be more clear to say \"any unconfirmed descendant transactions remains abandoned\"?  ",
      "commit_id" : "b5e49a4b31debdc1801a22cc1de1542ab5f205c6",
      "created_at" : "2022-11-16T07:32:57Z",
      "diff_hunk" : "@@ -32,28 +32,31 @@ def run_test(self):\n         self.generate(self.nodes[0], 150)\n         assert_equal(self.nodes[1].getbalance(), 10 + 25)\n         txid = self.nodes[1].sendtoaddress(self.nodes[0].getnewaddress(), 30)\n+        orig_chain_tip = self.nodes[0].getbestblockhash()\n \n         # Orphan the block reward and make sure that the original coins\n         # from the wallet can still be spent.\n         self.nodes[0].invalidateblock(blk)\n-        self.generate(self.nodes[0], 152)\n-        # Without the following abandontransaction call, the coins are\n-        # not considered available yet.\n-        assert_equal(self.nodes[1].getbalances()[\"mine\"], {\n-          \"trusted\": 0,\n-          \"untrusted_pending\": 0,\n-          \"immature\": 0,\n-        })\n-        # The following abandontransaction is necessary to make the later\n-        # lines succeed, and probably should not be needed; see\n-        # https://github.com/bitcoin/bitcoin/issues/14148.\n-        self.nodes[1].abandontransaction(txid)\n+        blocks = self.generate(self.nodes[0], 152)\n+        conflict_block = blocks[0]\n+        # We expect the desendants of orphaned rewards to no longer be considered\n         assert_equal(self.nodes[1].getbalances()[\"mine\"], {\n           \"trusted\": 10,\n           \"untrusted_pending\": 0,\n           \"immature\": 0,\n         })\n-        self.nodes[1].sendtoaddress(self.nodes[0].getnewaddress(), 9)\n+        # And the unconfirmed tx to be abandoned\n+        assert_equal(self.nodes[1].gettransaction(txid)[\"details\"][0][\"abandoned\"], True)\n+\n+        # If the orphaned reward is reorged back into the main chain, any unconfirmed txs\n+        # at the time of the original reorg remain abandoned.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26499#discussion_r1023595815",
      "id" : 1023595815,
      "line" : 52,
      "node_id" : "PRRC_kwDOABII5849AtUn",
      "original_commit_id" : "b5e49a4b31debdc1801a22cc1de1542ab5f205c6",
      "original_line" : 52,
      "original_position" : 34,
      "original_start_line" : 51,
      "path" : "test/functional/wallet_orphanedreward.py",
      "position" : 34,
      "pull_request_review_id" : 1181997922,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26499",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1023595815/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 51,
      "start_side" : "RIGHT",
      "updated_at" : "2022-11-16T07:46:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1023595815",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/36541669?v=4",
         "events_url" : "https://api.github.com/users/rajarshimaitra/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rajarshimaitra/followers",
         "following_url" : "https://api.github.com/users/rajarshimaitra/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rajarshimaitra/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rajarshimaitra",
         "id" : 36541669,
         "login" : "rajarshimaitra",
         "node_id" : "MDQ6VXNlcjM2NTQxNjY5",
         "organizations_url" : "https://api.github.com/users/rajarshimaitra/orgs",
         "received_events_url" : "https://api.github.com/users/rajarshimaitra/received_events",
         "repos_url" : "https://api.github.com/users/rajarshimaitra/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rajarshimaitra/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rajarshimaitra/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rajarshimaitra"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26499#discussion_r1023602577"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26499"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1023602577"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Maybe I am dumb and missing something very obvious, why is the block reward 25 here?",
      "commit_id" : "b5e49a4b31debdc1801a22cc1de1542ab5f205c6",
      "created_at" : "2022-11-16T07:41:53Z",
      "diff_hunk" : "@@ -32,28 +32,31 @@ def run_test(self):\n         self.generate(self.nodes[0], 150)\n         assert_equal(self.nodes[1].getbalance(), 10 + 25)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26499#discussion_r1023602577",
      "id" : 1023602577,
      "line" : 33,
      "node_id" : "PRRC_kwDOABII5849Au-R",
      "original_commit_id" : "b5e49a4b31debdc1801a22cc1de1542ab5f205c6",
      "original_line" : 33,
      "original_position" : 2,
      "original_start_line" : null,
      "path" : "test/functional/wallet_orphanedreward.py",
      "position" : 2,
      "pull_request_review_id" : 1181997922,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26499",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1023602577/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-16T07:46:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1023602577",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/36541669?v=4",
         "events_url" : "https://api.github.com/users/rajarshimaitra/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rajarshimaitra/followers",
         "following_url" : "https://api.github.com/users/rajarshimaitra/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rajarshimaitra/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rajarshimaitra",
         "id" : 36541669,
         "login" : "rajarshimaitra",
         "node_id" : "MDQ6VXNlcjM2NTQxNjY5",
         "organizations_url" : "https://api.github.com/users/rajarshimaitra/orgs",
         "received_events_url" : "https://api.github.com/users/rajarshimaitra/received_events",
         "repos_url" : "https://api.github.com/users/rajarshimaitra/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rajarshimaitra/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rajarshimaitra/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rajarshimaitra"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26499#discussion_r1023603887"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26499"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1023603887"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Should we let the block reward mature again?? Then show that the reward is included in the balance but the descendant is still abandoned?  I manually verified that's the case.. ",
      "commit_id" : "b5e49a4b31debdc1801a22cc1de1542ab5f205c6",
      "created_at" : "2022-11-16T07:43:35Z",
      "diff_hunk" : "@@ -32,28 +32,31 @@ def run_test(self):\n         self.generate(self.nodes[0], 150)\n         assert_equal(self.nodes[1].getbalance(), 10 + 25)\n         txid = self.nodes[1].sendtoaddress(self.nodes[0].getnewaddress(), 30)\n+        orig_chain_tip = self.nodes[0].getbestblockhash()\n \n         # Orphan the block reward and make sure that the original coins\n         # from the wallet can still be spent.\n         self.nodes[0].invalidateblock(blk)\n-        self.generate(self.nodes[0], 152)\n-        # Without the following abandontransaction call, the coins are\n-        # not considered available yet.\n-        assert_equal(self.nodes[1].getbalances()[\"mine\"], {\n-          \"trusted\": 0,\n-          \"untrusted_pending\": 0,\n-          \"immature\": 0,\n-        })\n-        # The following abandontransaction is necessary to make the later\n-        # lines succeed, and probably should not be needed; see\n-        # https://github.com/bitcoin/bitcoin/issues/14148.\n-        self.nodes[1].abandontransaction(txid)\n+        blocks = self.generate(self.nodes[0], 152)\n+        conflict_block = blocks[0]\n+        # We expect the desendants of orphaned rewards to no longer be considered\n         assert_equal(self.nodes[1].getbalances()[\"mine\"], {\n           \"trusted\": 10,\n           \"untrusted_pending\": 0,\n           \"immature\": 0,\n         })\n-        self.nodes[1].sendtoaddress(self.nodes[0].getnewaddress(), 9)\n+        # And the unconfirmed tx to be abandoned\n+        assert_equal(self.nodes[1].gettransaction(txid)[\"details\"][0][\"abandoned\"], True)\n+\n+        # If the orphaned reward is reorged back into the main chain, any unconfirmed txs\n+        # at the time of the original reorg remain abandoned.\n+        self.nodes[0].invalidateblock(conflict_block)\n+        self.nodes[0].reconsiderblock(blk)\n+        assert_equal(self.nodes[0].getbestblockhash(), orig_chain_tip)\n+        self.generate(self.nodes[0], 3)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26499#discussion_r1023603887",
      "id" : 1023603887,
      "line" : 56,
      "node_id" : "PRRC_kwDOABII5849AvSv",
      "original_commit_id" : "b5e49a4b31debdc1801a22cc1de1542ab5f205c6",
      "original_line" : 56,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "test/functional/wallet_orphanedreward.py",
      "position" : 38,
      "pull_request_review_id" : 1181997922,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26499",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1023603887/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-16T07:46:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1023603887",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/36541669?v=4",
         "events_url" : "https://api.github.com/users/rajarshimaitra/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rajarshimaitra/followers",
         "following_url" : "https://api.github.com/users/rajarshimaitra/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rajarshimaitra/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rajarshimaitra",
         "id" : 36541669,
         "login" : "rajarshimaitra",
         "node_id" : "MDQ6VXNlcjM2NTQxNjY5",
         "organizations_url" : "https://api.github.com/users/rajarshimaitra/orgs",
         "received_events_url" : "https://api.github.com/users/rajarshimaitra/received_events",
         "repos_url" : "https://api.github.com/users/rajarshimaitra/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rajarshimaitra/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rajarshimaitra/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rajarshimaitra"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26499#discussion_r1024200081"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26499"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1024200081"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Regtest's halving interval is 150 blocks.",
      "commit_id" : "aaedf7bf1fa7b727b30020e11258bf5aaacb4d35",
      "created_at" : "2022-11-16T16:01:18Z",
      "diff_hunk" : "@@ -32,28 +32,31 @@ def run_test(self):\n         self.generate(self.nodes[0], 150)\n         assert_equal(self.nodes[1].getbalance(), 10 + 25)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26499#discussion_r1024200081",
      "id" : 1024200081,
      "in_reply_to_id" : 1023602577,
      "line" : 33,
      "node_id" : "PRRC_kwDOABII5849DA2R",
      "original_commit_id" : "b5e49a4b31debdc1801a22cc1de1542ab5f205c6",
      "original_line" : 33,
      "original_position" : 2,
      "original_start_line" : null,
      "path" : "test/functional/wallet_orphanedreward.py",
      "position" : 3,
      "pull_request_review_id" : 1182877567,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26499",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1024200081/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-16T16:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1024200081",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [furszy](https://github.com/bitcoin/bitcoin/pull/26499#pullrequestreview-1244449884), [aureleoules](https://github.com/bitcoin/bitcoin/pull/26499#pullrequestreview-1250324837) |\n| Approach NACK | [luke-jr](https://github.com/bitcoin/bitcoin/pull/26499#issuecomment-1314553422) |\n| Stale ACK | [rajarshimaitra](https://github.com/bitcoin/bitcoin/pull/26499#pullrequestreview-1187019834) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n",
      "created_at" : "2022-11-16T16:01:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26499#issuecomment-1317251208",
      "id" : 1317251208,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26499",
      "node_id" : "IC_kwDOABII585Og6iI",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1317251208/reactions"
      },
      "updated_at" : "2023-01-23T19:37:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1317251208",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26499#discussion_r1024213568"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26499"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1024213568"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "aaedf7bf1fa7b727b30020e11258bf5aaacb4d35",
      "created_at" : "2022-11-16T16:12:19Z",
      "diff_hunk" : "@@ -32,28 +32,31 @@ def run_test(self):\n         self.generate(self.nodes[0], 150)\n         assert_equal(self.nodes[1].getbalance(), 10 + 25)\n         txid = self.nodes[1].sendtoaddress(self.nodes[0].getnewaddress(), 30)\n+        orig_chain_tip = self.nodes[0].getbestblockhash()\n \n         # Orphan the block reward and make sure that the original coins\n         # from the wallet can still be spent.\n         self.nodes[0].invalidateblock(blk)\n-        self.generate(self.nodes[0], 152)\n-        # Without the following abandontransaction call, the coins are\n-        # not considered available yet.\n-        assert_equal(self.nodes[1].getbalances()[\"mine\"], {\n-          \"trusted\": 0,\n-          \"untrusted_pending\": 0,\n-          \"immature\": 0,\n-        })\n-        # The following abandontransaction is necessary to make the later\n-        # lines succeed, and probably should not be needed; see\n-        # https://github.com/bitcoin/bitcoin/issues/14148.\n-        self.nodes[1].abandontransaction(txid)\n+        blocks = self.generate(self.nodes[0], 152)\n+        conflict_block = blocks[0]\n+        # We expect the desendants of orphaned rewards to no longer be considered",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26499#discussion_r1024213568",
      "id" : 1024213568,
      "in_reply_to_id" : 1023589065,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5849DEJA",
      "original_commit_id" : "b5e49a4b31debdc1801a22cc1de1542ab5f205c6",
      "original_line" : 42,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "test/functional/wallet_orphanedreward.py",
      "position" : null,
      "pull_request_review_id" : 1182897388,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26499",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1024213568/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-16T16:12:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1024213568",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26499#discussion_r1024213757"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26499"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1024213757"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "aaedf7bf1fa7b727b30020e11258bf5aaacb4d35",
      "created_at" : "2022-11-16T16:12:28Z",
      "diff_hunk" : "@@ -32,28 +32,31 @@ def run_test(self):\n         self.generate(self.nodes[0], 150)\n         assert_equal(self.nodes[1].getbalance(), 10 + 25)\n         txid = self.nodes[1].sendtoaddress(self.nodes[0].getnewaddress(), 30)\n+        orig_chain_tip = self.nodes[0].getbestblockhash()\n \n         # Orphan the block reward and make sure that the original coins\n         # from the wallet can still be spent.\n         self.nodes[0].invalidateblock(blk)\n-        self.generate(self.nodes[0], 152)\n-        # Without the following abandontransaction call, the coins are\n-        # not considered available yet.\n-        assert_equal(self.nodes[1].getbalances()[\"mine\"], {\n-          \"trusted\": 0,\n-          \"untrusted_pending\": 0,\n-          \"immature\": 0,\n-        })\n-        # The following abandontransaction is necessary to make the later\n-        # lines succeed, and probably should not be needed; see\n-        # https://github.com/bitcoin/bitcoin/issues/14148.\n-        self.nodes[1].abandontransaction(txid)\n+        blocks = self.generate(self.nodes[0], 152)\n+        conflict_block = blocks[0]\n+        # We expect the desendants of orphaned rewards to no longer be considered\n         assert_equal(self.nodes[1].getbalances()[\"mine\"], {\n           \"trusted\": 10,\n           \"untrusted_pending\": 0,\n           \"immature\": 0,\n         })\n-        self.nodes[1].sendtoaddress(self.nodes[0].getnewaddress(), 9)\n+        # And the unconfirmed tx to be abandoned\n+        assert_equal(self.nodes[1].gettransaction(txid)[\"details\"][0][\"abandoned\"], True)\n+\n+        # If the orphaned reward is reorged back into the main chain, any unconfirmed txs\n+        # at the time of the original reorg remain abandoned.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26499#discussion_r1024213757",
      "id" : 1024213757,
      "in_reply_to_id" : 1023595815,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5849DEL9",
      "original_commit_id" : "b5e49a4b31debdc1801a22cc1de1542ab5f205c6",
      "original_line" : 52,
      "original_position" : 34,
      "original_start_line" : 51,
      "path" : "test/functional/wallet_orphanedreward.py",
      "position" : null,
      "pull_request_review_id" : 1182897674,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26499",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1024213757/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-11-16T16:12:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1024213757",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26499#discussion_r1024214654"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26499"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1024214654"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The reward does actually mature since `reconsiderblock` will reactivate the entire reorged chain, not just that particular block. I've added a check that the balances are as we expect for the matured reward.",
      "commit_id" : "aaedf7bf1fa7b727b30020e11258bf5aaacb4d35",
      "created_at" : "2022-11-16T16:13:15Z",
      "diff_hunk" : "@@ -32,28 +32,31 @@ def run_test(self):\n         self.generate(self.nodes[0], 150)\n         assert_equal(self.nodes[1].getbalance(), 10 + 25)\n         txid = self.nodes[1].sendtoaddress(self.nodes[0].getnewaddress(), 30)\n+        orig_chain_tip = self.nodes[0].getbestblockhash()\n \n         # Orphan the block reward and make sure that the original coins\n         # from the wallet can still be spent.\n         self.nodes[0].invalidateblock(blk)\n-        self.generate(self.nodes[0], 152)\n-        # Without the following abandontransaction call, the coins are\n-        # not considered available yet.\n-        assert_equal(self.nodes[1].getbalances()[\"mine\"], {\n-          \"trusted\": 0,\n-          \"untrusted_pending\": 0,\n-          \"immature\": 0,\n-        })\n-        # The following abandontransaction is necessary to make the later\n-        # lines succeed, and probably should not be needed; see\n-        # https://github.com/bitcoin/bitcoin/issues/14148.\n-        self.nodes[1].abandontransaction(txid)\n+        blocks = self.generate(self.nodes[0], 152)\n+        conflict_block = blocks[0]\n+        # We expect the desendants of orphaned rewards to no longer be considered\n         assert_equal(self.nodes[1].getbalances()[\"mine\"], {\n           \"trusted\": 10,\n           \"untrusted_pending\": 0,\n           \"immature\": 0,\n         })\n-        self.nodes[1].sendtoaddress(self.nodes[0].getnewaddress(), 9)\n+        # And the unconfirmed tx to be abandoned\n+        assert_equal(self.nodes[1].gettransaction(txid)[\"details\"][0][\"abandoned\"], True)\n+\n+        # If the orphaned reward is reorged back into the main chain, any unconfirmed txs\n+        # at the time of the original reorg remain abandoned.\n+        self.nodes[0].invalidateblock(conflict_block)\n+        self.nodes[0].reconsiderblock(blk)\n+        assert_equal(self.nodes[0].getbestblockhash(), orig_chain_tip)\n+        self.generate(self.nodes[0], 3)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26499#discussion_r1024214654",
      "id" : 1024214654,
      "in_reply_to_id" : 1023603887,
      "line" : 57,
      "node_id" : "PRRC_kwDOABII5849DEZ-",
      "original_commit_id" : "b5e49a4b31debdc1801a22cc1de1542ab5f205c6",
      "original_line" : 57,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "test/functional/wallet_orphanedreward.py",
      "position" : 40,
      "pull_request_review_id" : 1182899054,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26499",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1024214654/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-16T16:13:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1024214654",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Should this be documented somewhere? User maybe actively noticing the situation as you suggested but might not know that the descendant needs another rebroadcast? Also given its a 100 blk reorg, the possibility of this occurring is very low.. But maybe just for sake completeness, makes sense to write a line in the code somewhere explaining the manual broadcasting part?\r\n\r\nI've added a comment about that, as well as a comment that the transaction states can still change after abandoning.",
      "created_at" : "2022-11-16T16:14:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26499#issuecomment-1317273058",
      "id" : 1317273058,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26499",
      "node_id" : "IC_kwDOABII585Og_3i",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1317273058/reactions"
      },
      "updated_at" : "2022-11-16T16:14:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1317273058",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "CI:  \r\n\r\n```\r\n  File \"/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/test/functional/wallet_orphanedreward.py\", line 57, in run_test\r\n    self.generate(self.nodes[0], 3)\r\n  File \"/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/test/functional/test_framework/test_framework.py\", line 650, in generate\r\n    sync_fun() if sync_fun else self.sync_all()\r\n  File \"/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/test/functional/test_framework/test_framework.py\", line 715, in sync_all\r\n    self.sync_mempools(nodes)\r\n  File \"/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/test/functional/test_framework/test_framework.py\", line 708, in sync_mempools\r\n    raise AssertionError(\"Mempool sync timed out after {}s:{}\".format(\r\nAssertionError: Mempool sync timed out after 2400s:\r\n  {'22b1bf7d8f18b9a08c8f5ad676f3372000a5ad247f4fae848b2a76309c0dba3b'}\r\n  set()",
      "created_at" : "2022-11-17T12:29:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26499#issuecomment-1318567391",
      "id" : 1318567391,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26499",
      "node_id" : "IC_kwDOABII585Ol73f",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1318567391/reactions"
      },
      "updated_at" : "2022-11-22T12:59:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1318567391",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26499#discussion_r1025238538"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26499"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1025238538"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ohh.. My bad.. ",
      "commit_id" : "aaedf7bf1fa7b727b30020e11258bf5aaacb4d35",
      "created_at" : "2022-11-17T14:06:32Z",
      "diff_hunk" : "@@ -32,28 +32,31 @@ def run_test(self):\n         self.generate(self.nodes[0], 150)\n         assert_equal(self.nodes[1].getbalance(), 10 + 25)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26499#discussion_r1025238538",
      "id" : 1025238538,
      "in_reply_to_id" : 1023602577,
      "line" : 33,
      "node_id" : "PRRC_kwDOABII5849G-YK",
      "original_commit_id" : "b5e49a4b31debdc1801a22cc1de1542ab5f205c6",
      "original_line" : 33,
      "original_position" : 2,
      "original_start_line" : null,
      "path" : "test/functional/wallet_orphanedreward.py",
      "position" : 3,
      "pull_request_review_id" : 1184380272,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26499",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1025238538/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-17T14:06:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1025238538",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/36541669?v=4",
         "events_url" : "https://api.github.com/users/rajarshimaitra/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rajarshimaitra/followers",
         "following_url" : "https://api.github.com/users/rajarshimaitra/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rajarshimaitra/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rajarshimaitra",
         "id" : 36541669,
         "login" : "rajarshimaitra",
         "node_id" : "MDQ6VXNlcjM2NTQxNjY5",
         "organizations_url" : "https://api.github.com/users/rajarshimaitra/orgs",
         "received_events_url" : "https://api.github.com/users/rajarshimaitra/received_events",
         "repos_url" : "https://api.github.com/users/rajarshimaitra/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rajarshimaitra/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rajarshimaitra/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rajarshimaitra"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> CI:\r\n> \r\n> ```\r\n>   File \"/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/test/functional/wallet_orphanedreward.py\", line 57, in run_test\r\n>     self.generate(self.nodes[0], 3)\r\n>   File \"/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/test/functional/test_framework/test_framework.py\", line 650, in generate\r\n>     sync_fun() if sync_fun else self.sync_all()\r\n>   File \"/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/test/functional/test_framework/test_framework.py\", line 715, in sync_all\r\n>     self.sync_mempools(nodes)\r\n>   File \"/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/test/functional/test_framework/test_framework.py\", line 708, in sync_mempools\r\n>     raise AssertionError(\"Mempool sync timed out after {}s:{}\".format(\r\n> AssertionError: Mempool sync timed out after 2400s:\r\n>   {'22b1bf7d8f18b9a08c8f5ad676f3372000a5ad247f4fae848b2a76309c0dba3b'}\r\n>   set()\r\n> ```\r\n\r\nThis error is actually really confusing. I ran into it a few times while writing the test, but whenever I actually tried to debug it, I couldn't get it to reproduce.\r\n\r\nWhat's happening is that the unconfirmed transaction descended from the previously orphaned parent is somehow making its way back into node0's mempool. What I don't understand is how that is happening. When attempting to debug this, I added some `print(self.nodes[0].getrawmempool())` statements before the generate and those indicated that node0's mempool is empty, as it should be. The transaction is removed from the mempool when its parent is reorged out of the chain, and the wallet is not rebroadcasting it either, so I don't understand how node0 becomes aware of it again.",
      "created_at" : "2022-11-17T16:43:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26499#issuecomment-1318912195",
      "id" : 1318912195,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26499",
      "node_id" : "IC_kwDOABII585OnQDD",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1318912195/reactions"
      },
      "updated_at" : "2022-11-17T16:43:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1318912195",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26499#discussion_r1064198746"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26499"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064198746"
         }
      },
      "author_association" : "MEMBER",
      "body" : "would be better to rename this variable, it's shadowing the method's argument.",
      "commit_id" : "b0fa5989e1b77a343349bd36f8bc407f9366a589",
      "created_at" : "2023-01-08T20:38:11Z",
      "diff_hunk" : "@@ -1067,6 +1067,33 @@ CWalletTx* CWallet::AddToWallet(CTransactionRef tx, const TxState& state, const\n         }\n     }\n \n+    // Mark inactive coinbase transactions and their descendants as abandoned\n+    if (wtx.IsCoinBase() && wtx.isInactive()) {\n+        std::vector<CWalletTx*> txs;\n+        txs.push_back(&wtx);\n+\n+        TxStateInactive inactive_state = TxStateInactive{/*abandoned=*/true};\n+\n+        while (!txs.empty()) {\n+            CWalletTx* tx = txs.back();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26499#discussion_r1064198746",
      "id" : 1064198746,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584_bmJa",
      "original_commit_id" : "1449a44bc1ea4179822ad59850466287c80bd573",
      "original_line" : 1078,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1239831999,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26499",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064198746/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-08T20:59:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064198746",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26499#discussion_r1064199776"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26499"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064199776"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: could inline this\r\n```c++\r\nstd::vector<CWalletTx*> txs{&wtx};\r\n```",
      "commit_id" : "b0fa5989e1b77a343349bd36f8bc407f9366a589",
      "created_at" : "2023-01-08T20:45:29Z",
      "diff_hunk" : "@@ -1067,6 +1067,33 @@ CWalletTx* CWallet::AddToWallet(CTransactionRef tx, const TxState& state, const\n         }\n     }\n \n+    // Mark inactive coinbase transactions and their descendants as abandoned\n+    if (wtx.IsCoinBase() && wtx.isInactive()) {\n+        std::vector<CWalletTx*> txs;\n+        txs.push_back(&wtx);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26499#discussion_r1064199776",
      "id" : 1064199776,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584_bmZg",
      "original_commit_id" : "1449a44bc1ea4179822ad59850466287c80bd573",
      "original_line" : 1073,
      "original_position" : 7,
      "original_start_line" : 1072,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1239831999,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26499",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064199776/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2023-01-08T20:59:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064199776",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26499#discussion_r1066445374"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26499"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1066445374"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "b0fa5989e1b77a343349bd36f8bc407f9366a589",
      "created_at" : "2023-01-10T23:36:15Z",
      "diff_hunk" : "@@ -1067,6 +1067,33 @@ CWalletTx* CWallet::AddToWallet(CTransactionRef tx, const TxState& state, const\n         }\n     }\n \n+    // Mark inactive coinbase transactions and their descendants as abandoned\n+    if (wtx.IsCoinBase() && wtx.isInactive()) {\n+        std::vector<CWalletTx*> txs;\n+        txs.push_back(&wtx);\n+\n+        TxStateInactive inactive_state = TxStateInactive{/*abandoned=*/true};\n+\n+        while (!txs.empty()) {\n+            CWalletTx* tx = txs.back();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26499#discussion_r1066445374",
      "id" : 1066445374,
      "in_reply_to_id" : 1064198746,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584_kKo-",
      "original_commit_id" : "1449a44bc1ea4179822ad59850466287c80bd573",
      "original_line" : 1078,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1243114658,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26499",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1066445374/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-10T23:36:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1066445374",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26499#discussion_r1066445425"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26499"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1066445425"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "b0fa5989e1b77a343349bd36f8bc407f9366a589",
      "created_at" : "2023-01-10T23:36:20Z",
      "diff_hunk" : "@@ -1067,6 +1067,33 @@ CWalletTx* CWallet::AddToWallet(CTransactionRef tx, const TxState& state, const\n         }\n     }\n \n+    // Mark inactive coinbase transactions and their descendants as abandoned\n+    if (wtx.IsCoinBase() && wtx.isInactive()) {\n+        std::vector<CWalletTx*> txs;\n+        txs.push_back(&wtx);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26499#discussion_r1066445425",
      "id" : 1066445425,
      "in_reply_to_id" : 1064199776,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584_kKpx",
      "original_commit_id" : "1449a44bc1ea4179822ad59850466287c80bd573",
      "original_line" : 1073,
      "original_position" : 7,
      "original_start_line" : 1072,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1243114718,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26499",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1066445425/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2023-01-10T23:36:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1066445425",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Seems that the coinbase descendants state modification is not permitted to disk. So after a restart, they will get back to their previous state.\r\n\r\nOops, fixed.",
      "created_at" : "2023-01-10T23:36:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26499#issuecomment-1378036205",
      "id" : 1378036205,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26499",
      "node_id" : "IC_kwDOABII585SIynt",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1378036205/reactions"
      },
      "updated_at" : "2023-01-10T23:36:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1378036205",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26499#discussion_r1067351159"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26499"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1067351159"
         }
      },
      "author_association" : "MEMBER",
      "body" : "non-blocking question:\r\nguess that the 3 blocks generated here are just to make the chain longer, so the other node accepts it and trigger a reorg (in that case, it should also work with 2 blocks).",
      "commit_id" : "b0fa5989e1b77a343349bd36f8bc407f9366a589",
      "created_at" : "2023-01-11T18:53:28Z",
      "diff_hunk" : "@@ -31,19 +31,40 @@ def run_test(self):\n         # the existing balance and the block reward.\n         self.generate(self.nodes[0], 150)\n         assert_equal(self.nodes[1].getbalance(), 10 + 25)\n+        pre_reorg_conf_bals = self.nodes[1].getbalances()\n         txid = self.nodes[1].sendtoaddress(self.nodes[0].getnewaddress(), 30)\n+        orig_chain_tip = self.nodes[0].getbestblockhash()\n+        self.sync_mempools()\n \n         # Orphan the block reward and make sure that the original coins\n         # from the wallet can still be spent.\n         self.nodes[0].invalidateblock(blk)\n-        self.generate(self.nodes[0], 152)\n+        blocks = self.generate(self.nodes[0], 152)\n+        conflict_block = blocks[0]\n         # We expect the descendants of orphaned rewards to no longer be considered\n         assert_equal(self.nodes[1].getbalances()[\"mine\"], {\n           \"trusted\": 10,\n           \"untrusted_pending\": 0,\n           \"immature\": 0,\n         })\n-        self.nodes[1].sendtoaddress(self.nodes[0].getnewaddress(), 9)\n+        # And the unconfirmed tx to be abandoned\n+        assert_equal(self.nodes[1].gettransaction(txid)[\"details\"][0][\"abandoned\"], True)\n+\n+        # The abandoning should persist through reloading\n+        self.nodes[1].unloadwallet(self.default_wallet_name)\n+        self.nodes[1].loadwallet(self.default_wallet_name)\n+        assert_equal(self.nodes[1].gettransaction(txid)[\"details\"][0][\"abandoned\"], True)\n+\n+        # If the orphaned reward is reorged back into the main chain, any unconfirmed\n+        # descendant txs at the time of the original reorg remain abandoned.\n+        self.nodes[0].invalidateblock(conflict_block)\n+        self.nodes[0].reconsiderblock(blk)\n+        assert_equal(self.nodes[0].getbestblockhash(), orig_chain_tip)\n+        self.generate(self.nodes[0], 3)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26499#discussion_r1067351159",
      "id" : 1067351159,
      "line" : 63,
      "node_id" : "PRRC_kwDOABII584_nnx3",
      "original_commit_id" : "b0fa5989e1b77a343349bd36f8bc407f9366a589",
      "original_line" : 63,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "test/functional/wallet_orphanedreward.py",
      "position" : 35,
      "pull_request_review_id" : 1244449884,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26499",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1067351159/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-11T20:18:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1067351159",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26499#discussion_r1084469523"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26499"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1084469523"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, 2 would work, I think I just miscounted when writing this originally.",
      "commit_id" : "b0fa5989e1b77a343349bd36f8bc407f9366a589",
      "created_at" : "2023-01-23T19:37:53Z",
      "diff_hunk" : "@@ -31,19 +31,40 @@ def run_test(self):\n         # the existing balance and the block reward.\n         self.generate(self.nodes[0], 150)\n         assert_equal(self.nodes[1].getbalance(), 10 + 25)\n+        pre_reorg_conf_bals = self.nodes[1].getbalances()\n         txid = self.nodes[1].sendtoaddress(self.nodes[0].getnewaddress(), 30)\n+        orig_chain_tip = self.nodes[0].getbestblockhash()\n+        self.sync_mempools()\n \n         # Orphan the block reward and make sure that the original coins\n         # from the wallet can still be spent.\n         self.nodes[0].invalidateblock(blk)\n-        self.generate(self.nodes[0], 152)\n+        blocks = self.generate(self.nodes[0], 152)\n+        conflict_block = blocks[0]\n         # We expect the descendants of orphaned rewards to no longer be considered\n         assert_equal(self.nodes[1].getbalances()[\"mine\"], {\n           \"trusted\": 10,\n           \"untrusted_pending\": 0,\n           \"immature\": 0,\n         })\n-        self.nodes[1].sendtoaddress(self.nodes[0].getnewaddress(), 9)\n+        # And the unconfirmed tx to be abandoned\n+        assert_equal(self.nodes[1].gettransaction(txid)[\"details\"][0][\"abandoned\"], True)\n+\n+        # The abandoning should persist through reloading\n+        self.nodes[1].unloadwallet(self.default_wallet_name)\n+        self.nodes[1].loadwallet(self.default_wallet_name)\n+        assert_equal(self.nodes[1].gettransaction(txid)[\"details\"][0][\"abandoned\"], True)\n+\n+        # If the orphaned reward is reorged back into the main chain, any unconfirmed\n+        # descendant txs at the time of the original reorg remain abandoned.\n+        self.nodes[0].invalidateblock(conflict_block)\n+        self.nodes[0].reconsiderblock(blk)\n+        assert_equal(self.nodes[0].getbestblockhash(), orig_chain_tip)\n+        self.generate(self.nodes[0], 3)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26499#discussion_r1084469523",
      "id" : 1084469523,
      "in_reply_to_id" : 1067351159,
      "line" : 63,
      "node_id" : "PRRC_kwDOABII585Ao7ET",
      "original_commit_id" : "b0fa5989e1b77a343349bd36f8bc407f9366a589",
      "original_line" : 63,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "test/functional/wallet_orphanedreward.py",
      "position" : 35,
      "pull_request_review_id" : 1266214815,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26499",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1084469523/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-23T19:37:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1084469523",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> The initial round of the loop (when we only have the orphan coinbase in the vector) isn't needed. We update the state and reset the cached amounts below.\r\n\r\nIt does, but I think it's easier to read this way and the performance impact of breaking the caches twice and writing it twice is not that big.",
      "created_at" : "2023-01-23T19:38:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26499#issuecomment-1400877814",
      "id" : 1400877814,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26499",
      "node_id" : "IC_kwDOABII585Tf7L2",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1400877814/reactions"
      },
      "updated_at" : "2023-01-23T19:38:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1400877814",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   }
]
