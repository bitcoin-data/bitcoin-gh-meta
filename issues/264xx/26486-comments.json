[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26486#discussion_r1020066568"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26486"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1020066568"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can you explain why it is safe to change the order of responses? From a first impression, I think it is possible that a peer sends us a `getdata` [1], then a `ping`, then they would receive the `pong` first, and then the `notfound`, no? Previously they should be in order.\r\n\r\nIf this is safe to change, it might be good to explain. Also, then it would be better to move this out of the cs_main scope here, because the lock is not needed.\r\n\r\nIf it is not safe to change, I guess you can just move the send to the process function?\r\n\r\n[1] This should happen intermittently whenever there is `fPauseSend` backpressure, or you can force it deterministically by sending an unknown getdata type.",
      "commit_id" : "ad393c2d130b593b671b66e6a84c244664c3fd4c",
      "created_at" : "2022-11-11T10:01:50Z",
      "diff_hunk" : "@@ -5820,10 +5830,14 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                 m_txrequest.ForgetTxHash(gtxid.GetHash());\n             }\n         }\n-\n-\n         if (!vGetData.empty())\n             m_connman.PushMessage(pto, msgMaker.Make(NetMsgType::GETDATA, vGetData));\n+\n+        // Message: notfound\n+        if (!peer->m_notfounds_to_send.empty()) {\n+            m_connman.PushMessage(pto, msgMaker.Make(NetMsgType::NOTFOUND, peer->m_notfounds_to_send));\n+            peer->m_notfounds_to_send.clear();\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26486#discussion_r1020066568",
      "id" : 1020066568,
      "line" : 5840,
      "node_id" : "PRRC_kwDOABII5848zPsI",
      "original_commit_id" : "ad393c2d130b593b671b66e6a84c244664c3fd4c",
      "original_line" : 5840,
      "original_position" : 123,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 123,
      "pull_request_review_id" : 1177114470,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26486",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1020066568/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-11T10:01:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1020066568",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [vasild](https://github.com/bitcoin/bitcoin/pull/26486#issuecomment-1313298718), [amitiuttarwar](https://github.com/bitcoin/bitcoin/pull/26486#pullrequestreview-1183686743) |\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#26140](https://github.com/bitcoin/bitcoin/pull/26140) (refactor: Move CNodeState members guarded by g_msgproc_mutex to Peer by dergoegge)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2022-11-11T23:59:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26486#issuecomment-1312274035",
      "id" : 1312274035,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26486",
      "node_id" : "IC_kwDOABII585ON7Zz",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1312274035/reactions"
      },
      "updated_at" : "2022-11-21T21:18:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1312274035",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2022-11-14T08:49:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26486#issuecomment-1313298718",
      "id" : 1313298718,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26486",
      "node_id" : "IC_kwDOABII585OR1ke",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1313298718/reactions"
      },
      "updated_at" : "2022-11-14T08:49:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1313298718",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26486#discussion_r1023603478"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26486"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1023603478"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "We already have out of order notfounds: if you request `getdata [a,b,c]` and `b` is known but `a` and `c` aren't; we'll send back `tx b; notfound [a,c]`. Having a `pong` interspersed as well doesn't seem like it makes a big difference?",
      "commit_id" : "ad393c2d130b593b671b66e6a84c244664c3fd4c",
      "created_at" : "2022-11-16T07:43:04Z",
      "diff_hunk" : "@@ -5820,10 +5830,14 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                 m_txrequest.ForgetTxHash(gtxid.GetHash());\n             }\n         }\n-\n-\n         if (!vGetData.empty())\n             m_connman.PushMessage(pto, msgMaker.Make(NetMsgType::GETDATA, vGetData));\n+\n+        // Message: notfound\n+        if (!peer->m_notfounds_to_send.empty()) {\n+            m_connman.PushMessage(pto, msgMaker.Make(NetMsgType::NOTFOUND, peer->m_notfounds_to_send));\n+            peer->m_notfounds_to_send.clear();\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26486#discussion_r1023603478",
      "id" : 1023603478,
      "in_reply_to_id" : 1020066568,
      "line" : 5840,
      "node_id" : "PRRC_kwDOABII5849AvMW",
      "original_commit_id" : "ad393c2d130b593b671b66e6a84c244664c3fd4c",
      "original_line" : 5840,
      "original_position" : 123,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 123,
      "pull_request_review_id" : 1182017989,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26486",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1023603478/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-16T07:46:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1023603478",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26486#discussion_r1024763870"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26486"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1024763870"
         }
      },
      "author_association" : "MEMBER",
      "body" : "- agree that this code can be moved out of `cs_main` \r\n- I spent some time, and can't think of any specific circumstances that would cause this change in ordering to be problematic in normal node operations (which is not to say its necessarily fine)\r\n- however, one question that came to mind is if this could negatively impact timing in the tests because of the expectations from the `sync_with_ping` function. however, with AJ's patch, any test covering `NOTFOUND` behavior would require some time delay. so this shouldnât be an issue.",
      "commit_id" : "ad393c2d130b593b671b66e6a84c244664c3fd4c",
      "created_at" : "2022-11-17T05:20:15Z",
      "diff_hunk" : "@@ -5820,10 +5830,14 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                 m_txrequest.ForgetTxHash(gtxid.GetHash());\n             }\n         }\n-\n-\n         if (!vGetData.empty())\n             m_connman.PushMessage(pto, msgMaker.Make(NetMsgType::GETDATA, vGetData));\n+\n+        // Message: notfound\n+        if (!peer->m_notfounds_to_send.empty()) {\n+            m_connman.PushMessage(pto, msgMaker.Make(NetMsgType::NOTFOUND, peer->m_notfounds_to_send));\n+            peer->m_notfounds_to_send.clear();\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26486#discussion_r1024763870",
      "id" : 1024763870,
      "in_reply_to_id" : 1020066568,
      "line" : 5840,
      "node_id" : "PRRC_kwDOABII5849FKfe",
      "original_commit_id" : "ad393c2d130b593b671b66e6a84c244664c3fd4c",
      "original_line" : 5840,
      "original_position" : 123,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 123,
      "pull_request_review_id" : 1183686743,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26486",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1024763870/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-17T05:28:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1024763870",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I updated the tests in [this branch](https://github.com/amitiuttarwar/bitcoin/commits/pr/26486.me). an overview of the commits: \r\n1. ad393c2d130b593b671b66e6a84c244664c3fd4c with the `SendMessages` functionality pulled out of `cs_main`\r\n2. a completely unnecessary tidy to merge the max size constant for addr / getdata / notfound \r\n3. the timer from @ajtowns' patch (aka `net_processing` changes only) \r\n4. the batching tests, adding assertions & removing the print statements \r\n\r\nsome notes on the last commit: \r\n- cherry-picking that commit (and discarding the `net_processing` change from it) will fail on master & ad393c2d130b593b671b66e6a84c244664c3fd4c. but should pass on my branch. \r\n- AJ introduced a batching timer of 300ms, but I was getting flakiness in my tests, so I increased it to 1s. while that consistently passes on my machine, I don't know how to guarantee it wouldn't introduce flakiness in CI without having a sleep statement for each check from the test.",
      "created_at" : "2022-11-18T05:14:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26486#issuecomment-1319557812",
      "id" : 1319557812,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26486",
      "node_id" : "IC_kwDOABII585Optq0",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1319557812/reactions"
      },
      "updated_at" : "2022-11-18T05:14:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1319557812",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Let me give a bit of background on where this PR comes from.\r\n\r\nI've been running some of my nodes with a patch to gather statistics on how frequently multiple messages are sent out simultaneously by the network thread (this is in the context of BIP324, where we're investigating whether it makes sense to support having multiple application-level messages in one transport-level packet). When I looked at these numbers a few weeks ago, I noticed that there were a small number of peers which surprisingly high \"message batching\" (much more than other peers), and noticed that these same peers also had remarkably high frequency of NOTFOUNDs being sent.\r\n\r\nThis made me wonder - without further evidence - whether perhaps these peers were broken in some way that caused many NOTFOUNDs to be sent out by us which could really be batched together. If that were the case, it'd mean maybe my gathered statistics were unfairly biased by this easily correctable misbehavior, so I wrote a small patch to add to the nodes gathering statistics. As I then had this patch, it made sense to also PR it, as it wouldn't hurt.\r\n\r\nThat said, I haven't seen changes in the statistics since deploying with the patch, but that's easily explainable by the fact that a SendMessages always follows a ProcessMessages. I've now included @ajtowns' patch which adds a further delay to NOTFOUNDs and am re-running statistics with that.\r\n\r\nTo comment on some of the review comments: it's a good question on whether the behavior change is acceptable and/or desirable. Historically, I'd say yes, because NOTFOUND was specifically introduced with the purpose of avoiding the need to constantly send PING after a GETDATA transaction to figure out whether it was missing or not, plus of course the fact that it's already sent out of order w.r.t. TX messages in the GETDATA. I'm very open to discussing other issues that could arise of course.\r\n\r\nI'll address further comments on the code when I get more numbers (probably next week somewhere, hopefully that gives a representative picture).",
      "created_at" : "2022-11-21T21:18:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26486#issuecomment-1322656573",
      "id" : 1322656573,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26486",
      "node_id" : "IC_kwDOABII585O1iM9",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1322656573/reactions"
      },
      "updated_at" : "2022-11-21T21:18:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1322656573",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I noticed that there were a small number of peers which surprisingly high \"message batching\" (much more than other peers), and noticed that these same peers also had remarkably high frequency of NOTFOUNDs being sent.\r\n\r\nWere you able to identify/characterize those nodes in any way? The behaviour you describe seems unusual. In normal operation, most `getdata` requests will be for transactions that we've announced to the peer, and the responses will be individual `tx` messages - one for each transaction. It's pretty rare to hit a `notfound` condition for a tx that we've announced (it'd need to have been removed from our mempool *and* aged out of our mapRelay cache). It therefore seems likely that those peers are requesting lots of transactions that we haven't announced to them. Is it possible that those are spy/scanning peers? Should we therefore be trying to limit/disconnect those peers, rather than making requests from them more bandwidth efficient?\r\n\r\nI do think that a similar change to this PR may be an improvement in the case where a single `getdata` with a large amount of inventory results in us sending multiple `notfound` messages. That isn't a serious attack (after all, a peer could always just request the same tx multiple times if they wanted to waste bandwidth), but it does seem potentially slightly better if a single `getdata` can only ever result in a single `notfound`.\r\n\r\n> Message types INV, GETDATA, and NOTFOUND are similar in that they all have a payload consisting of a vector of CInv data structure. But while sent INV and GETDATA messages are constructed by aggregating them, and then sending them out in batch during SendMessages, NOTFOUND is sent immediately.\r\n\r\nThere's a difference here: `inv` and `getdata` messages are initial messages in a dialog. The sender is free to batch or delay those messages however they want since the receiver isn't waiting for them. `notfound` is an in-dialog response to a previous message so delaying/batching may be unexpected behaviour for the peer. I'm not aware of anywhere else that we batch responses to multiple inbound messages.\r\n\r\n> We already have out of order notfounds: if you request getdata [a,b,c] and b is known but a and c aren't; we'll send back tx b; notfound [a,c]. Having a pong interspersed as well doesn't seem like it makes a big difference?\r\n\r\nThose are different things. Our p2p implementation always treats inbound messages in serial and responds to them in order. Inventory _within_ a single `getdata` message is not treated as serial, and hasn't been ever since `notfound` was introduced in #2192. Lots of our tests use `sync_with_ping` to synchronise p2p exchange with the node (which isn't in itself a good reason not to change this, but is a good indication of how deeply that assumption is baked in).\r\n\r\n> If this is safe to change, it might be good to explain.\r\n\r\nI agree with this. I think changing such a long-standing assumption in our p2p implementation would require better motivation/explanation.",
      "created_at" : "2022-11-24T21:32:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26486#issuecomment-1326848370",
      "id" : 1326848370,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26486",
      "node_id" : "IC_kwDOABII585PFhly",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1326848370/reactions"
      },
      "updated_at" : "2022-11-24T21:32:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1326848370",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> where we're investigating whether it makes sense to support having multiple application-level messages in one transport-level packet).\r\n\r\nRather than delaying sending the notfounds by some arbitrary interval, it might make sense to have `ProcessMessages` keep invoking `ProcessMessage` until either some real work is done (looking up a block, running ATMP, etc), or there are no messages in the queue, and only then be followed by a single run of `SendMessages`. So if the message queue contains `getdata tx; getdata tx; getdata block; getdata tx` that's treated exactly the same as `getdata tx tx block tx`.",
      "created_at" : "2022-11-24T23:20:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26486#issuecomment-1326888787",
      "id" : 1326888787,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26486",
      "node_id" : "IC_kwDOABII585PFrdT",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1326888787/reactions"
      },
      "updated_at" : "2022-11-24T23:20:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1326888787",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   }
]
