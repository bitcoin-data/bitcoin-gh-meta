[
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.",
      "created_at" : "2020-06-07T06:18:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19197#issuecomment-640163951",
      "id" : 640163951,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19197",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0MDE2Mzk1MQ==",
      "updated_at" : "2020-06-07T06:18:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/640163951",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19197#discussion_r436332073"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19197"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/436332073"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: The `AppInitMain()` is a way large function. Could the scope of the `import` variable be limited by a block?",
      "commit_id" : "83fd3a6d73eee452dc5141bdf6826da62d7b2dbd",
      "created_at" : "2020-06-07T06:55:01Z",
      "diff_hunk" : "@@ -1853,7 +1852,8 @@ bool AppInitMain(const util::Ref& context, NodeContext& node)\n         vImportFiles.push_back(strFile);\n     }\n \n-    threadGroup.create_thread([=, &chainman] { ThreadImport(chainman, vImportFiles); });\n+    std::thread import(&TraceThread<std::function<void()>>, \"loadblk\", [=, &chainman]{ ThreadImport(chainman, vImportFiles); });\n+    import.detach();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19197#discussion_r436332073",
      "id" : 436332073,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMzMjA3Mw==",
      "original_commit_id" : "aeb100f79ec6ff816ee26344b4eef70001dd51a6",
      "original_line" : 1856,
      "original_position" : 14,
      "original_start_line" : 1855,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 425792638,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19197",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-06-12T08:05:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/436332073",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Keep testing and the second instance of \"loadblk\" thread appears:\r\n\r\n![Screenshot from 2020-06-07 10-02-35](https://user-images.githubusercontent.com/32963518/83962547-fd8af000-a8a6-11ea-9a45-f8103f13b6bb.png)\r\n\r\nIs it ok?\r\n\r\nUPDATE: the same behavior observed on master, therefore it seems does not related to this PR changes. Going to submit a dedicated issue.",
      "created_at" : "2020-06-07T07:12:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19197#issuecomment-640169081",
      "id" : 640169081,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19197",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0MDE2OTA4MQ==",
      "updated_at" : "2020-06-07T07:55:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/640169081",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "why is is ok to not wait for the thread to exit (join) before shutdown?",
      "created_at" : "2020-06-07T10:26:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19197#issuecomment-640193207",
      "id" : 640193207,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19197",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0MDE5MzIwNw==",
      "updated_at" : "2020-06-07T10:26:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/640193207",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@MarcoFalke AFAIK, there is no problem with that. The application won't quit until all its threads have terminated.",
      "created_at" : "2020-06-07T16:28:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19197#issuecomment-640244112",
      "id" : 640244112,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19197",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0MDI0NDExMg==",
      "updated_at" : "2020-06-07T16:28:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/640244112",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "What I mean is that during shutdown we assume the chain clients don't receive (let's say) block connected signals anymore because they are already flushed. After this change, it is (theoretically, I haven't checked) possible that ThreadImport generates events that will be sent to objects that can't handle them or that ThreadImport reads from objects that have been deleted.\r\n\r\nAm I missing something obvious?",
      "created_at" : "2020-06-07T16:34:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19197#issuecomment-640245008",
      "id" : 640245008,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19197",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0MDI0NTAwOA==",
      "updated_at" : "2020-06-07T16:34:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/640245008",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> @MarcoFalke AFAIK, there is no problem with that. The application won't quit until all its threads have terminated.\r\n\r\nI thought that once main returns, any detached threads will not be waited on and stack unwinding does not occur risking danger of uncalled dtors.\r\n\r\nI tried a sample here and it seems to be the case?\r\n```\r\n#include <thread>\r\n#include <chrono>\r\n#include <iostream>\r\n\r\nusing namespace std::chrono_literals;\r\nstruct Destruct\r\n{\r\n    ~Destruct() { std::cout << \"Dtor called\" << std::endl; }\r\n};\r\n\r\nvoid ThreadProc()\r\n{\r\n  Destruct d;\r\n  std::this_thread::sleep_for(1s);\r\n}\r\n\r\nint main(int argc, char* argv[])\r\n{\r\n  std::cout << \"Hello\" << std::endl;\r\n\r\n  std::thread t(ThreadProc);\r\n  //t.join();\r\n  t.detach();\r\n\r\n  std::cout << \"Bye\" << std::endl;\r\n  return 0;\r\n}\r\n```\r\n\r\nOutput is Hello,Bye instead of Hello,Dtor called,Bye. \r\nEdit: above output wouldn't happen anyway. - but I'm wondering if dtor really gets called or not. I'll do more research.",
      "created_at" : "2020-06-07T16:57:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19197#issuecomment-640248104",
      "id" : 640248104,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19197",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0MDI0ODEwNA==",
      "updated_at" : "2020-06-07T17:02:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/640248104",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6394033?v=4",
         "events_url" : "https://api.github.com/users/donaloconnor/events{/privacy}",
         "followers_url" : "https://api.github.com/users/donaloconnor/followers",
         "following_url" : "https://api.github.com/users/donaloconnor/following{/other_user}",
         "gists_url" : "https://api.github.com/users/donaloconnor/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/donaloconnor",
         "id" : 6394033,
         "login" : "donaloconnor",
         "node_id" : "MDQ6VXNlcjYzOTQwMzM=",
         "organizations_url" : "https://api.github.com/users/donaloconnor/orgs",
         "received_events_url" : "https://api.github.com/users/donaloconnor/received_events",
         "repos_url" : "https://api.github.com/users/donaloconnor/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/donaloconnor/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/donaloconnor/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/donaloconnor"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@donaloconnor I would certainly have expected the code above to sleep 1 s before exiting, so it does seem I'm wrong.\r\n\r\n@MarcoFalke That's a good point. It seems we'll need to keep the std::thread object around somehow, and join it in the right order at shutdown.",
      "created_at" : "2020-06-07T17:05:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19197#issuecomment-640249127",
      "id" : 640249127,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19197",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0MDI0OTEyNw==",
      "updated_at" : "2020-06-07T17:05:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/640249127",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.\r\n\r\n> @MarcoFalke That's a good point. It seems we'll need to keep the std::thread object around somehow, and join it in the right order at shutdown.\r\n\r\nYes. It needs to be join-ed on shutdown to make sure it has terminated before tearing down validation-related data structures. Detach is not safe for a thread like this.\r\n\r\n(there's only one use where using `detach` is acceptable, that is the treads spawning child processes for notification that run free)\r\n",
      "created_at" : "2020-06-09T14:35:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19197#issuecomment-641338935",
      "id" : 641338935,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19197",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0MTMzODkzNQ==",
      "updated_at" : "2020-06-09T14:43:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/641338935",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Pushed a `.detach()`-less change.",
      "created_at" : "2020-06-12T07:47:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19197#issuecomment-643126864",
      "id" : 643126864,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19197",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0MzEyNjg2NA==",
      "updated_at" : "2020-06-12T07:47:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/643126864",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19197#discussion_r439267832"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19197"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/439267832"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think it might be safer to check if the thread is joinable before joining in case this path is reached after some initialization failure when the thread may not have started.",
      "commit_id" : "83fd3a6d73eee452dc5141bdf6826da62d7b2dbd",
      "created_at" : "2020-06-12T07:59:29Z",
      "diff_hunk" : "@@ -214,8 +216,9 @@ void Shutdown(NodeContext& node)\n     StopTorControl();\n \n     // After everything has been shut down, but before things get flushed, stop the\n-    // CScheduler/checkqueue threadGroup\n+    // CScheduler/checkqueue, threadGroup and load block thread.\n     if (node.scheduler) node.scheduler->stop();\n+    g_load_block.join();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19197#discussion_r439267832",
      "id" : 439267832,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI2NzgzMg==",
      "original_commit_id" : "2aca26d5dde506a47959dc1fde65d68c62db0015",
      "original_line" : 221,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 429538502,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19197",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-12T08:05:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/439267832",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6394033?v=4",
         "events_url" : "https://api.github.com/users/donaloconnor/events{/privacy}",
         "followers_url" : "https://api.github.com/users/donaloconnor/followers",
         "following_url" : "https://api.github.com/users/donaloconnor/following{/other_user}",
         "gists_url" : "https://api.github.com/users/donaloconnor/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/donaloconnor",
         "id" : 6394033,
         "login" : "donaloconnor",
         "node_id" : "MDQ6VXNlcjYzOTQwMzM=",
         "organizations_url" : "https://api.github.com/users/donaloconnor/orgs",
         "received_events_url" : "https://api.github.com/users/donaloconnor/received_events",
         "repos_url" : "https://api.github.com/users/donaloconnor/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/donaloconnor/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/donaloconnor/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/donaloconnor"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19197#discussion_r439270803"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19197"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/439270803"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks, I've added that.",
      "commit_id" : "83fd3a6d73eee452dc5141bdf6826da62d7b2dbd",
      "created_at" : "2020-06-12T08:06:14Z",
      "diff_hunk" : "@@ -214,8 +216,9 @@ void Shutdown(NodeContext& node)\n     StopTorControl();\n \n     // After everything has been shut down, but before things get flushed, stop the\n-    // CScheduler/checkqueue threadGroup\n+    // CScheduler/checkqueue, threadGroup and load block thread.\n     if (node.scheduler) node.scheduler->stop();\n+    g_load_block.join();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19197#discussion_r439270803",
      "id" : 439270803,
      "in_reply_to_id" : 439267832,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI3MDgwMw==",
      "original_commit_id" : "2aca26d5dde506a47959dc1fde65d68c62db0015",
      "original_line" : 221,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 429542463,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19197",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-12T08:06:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/439270803",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "ACK 83fd3a6",
      "created_at" : "2020-06-12T08:08:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19197#issuecomment-643136469",
      "id" : 643136469,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19197",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0MzEzNjQ2OQ==",
      "updated_at" : "2020-06-12T08:08:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/643136469",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6394033?v=4",
         "events_url" : "https://api.github.com/users/donaloconnor/events{/privacy}",
         "followers_url" : "https://api.github.com/users/donaloconnor/followers",
         "following_url" : "https://api.github.com/users/donaloconnor/following{/other_user}",
         "gists_url" : "https://api.github.com/users/donaloconnor/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/donaloconnor",
         "id" : 6394033,
         "login" : "donaloconnor",
         "node_id" : "MDQ6VXNlcjYzOTQwMzM=",
         "organizations_url" : "https://api.github.com/users/donaloconnor/orgs",
         "received_events_url" : "https://api.github.com/users/donaloconnor/received_events",
         "repos_url" : "https://api.github.com/users/donaloconnor/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/donaloconnor/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/donaloconnor/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/donaloconnor"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19197#discussion_r439362097"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19197"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/439362097"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't really like adding more and more globals to init. Ideally init should be a slim file with only calls to other modules to start/stop. Longer term `ThreadImport` should be moved to validation because it is purely validation related. Init shouldn't need to know how to load blocks from disk, etc... Note that `LoadMempool` is also in validation.\r\n\r\nMoreover, with assumeutxo, thus multiple chainstates, I could imagine that a reindex/import can be done in the background chainstate for additional efficiency. Having init to deal with even more chainstate related logic would feel wrong.\r\n\r\nWhat do you think about making this thread a member of the chainstate manager?",
      "commit_id" : "83fd3a6d73eee452dc5141bdf6826da62d7b2dbd",
      "created_at" : "2020-06-12T11:22:45Z",
      "diff_hunk" : "@@ -152,6 +152,8 @@ NODISCARD static bool CreatePidFile()\n \n static std::unique_ptr<ECCVerifyHandle> globalVerifyHandle;\n \n+static std::thread g_load_block;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19197#discussion_r439362097",
      "id" : 439362097,
      "line" : 155,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTM2MjA5Nw==",
      "original_commit_id" : "83fd3a6d73eee452dc5141bdf6826da62d7b2dbd",
      "original_line" : 155,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 4,
      "pull_request_review_id" : 429664356,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19197",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-12T11:22:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/439362097",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19197#discussion_r440946316"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19197"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/440946316"
         }
      },
      "author_association" : "MEMBER",
      "body" : "On the other hand this was a *hidden* global before, a part of `threadGroup` (which can hopefully go away soon!). I don't think this PR makes anything worse.\r\n\r\nI think your longer-term solution makes sense, but I'm not sure it needs to be done here.",
      "commit_id" : "83fd3a6d73eee452dc5141bdf6826da62d7b2dbd",
      "created_at" : "2020-06-16T15:33:44Z",
      "diff_hunk" : "@@ -152,6 +152,8 @@ NODISCARD static bool CreatePidFile()\n \n static std::unique_ptr<ECCVerifyHandle> globalVerifyHandle;\n \n+static std::thread g_load_block;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19197#discussion_r440946316",
      "id" : 440946316,
      "in_reply_to_id" : 439362097,
      "line" : 155,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk0NjMxNg==",
      "original_commit_id" : "83fd3a6d73eee452dc5141bdf6826da62d7b2dbd",
      "original_line" : 155,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 4,
      "pull_request_review_id" : 431634888,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19197",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-16T15:36:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/440946316",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Code review ACK 83fd3a6d73eee452dc5141bdf6826da62d7b2dbd",
      "created_at" : "2020-06-16T15:34:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19197#issuecomment-644841483",
      "id" : 644841483,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19197",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0NDg0MTQ4Mw==",
      "updated_at" : "2020-06-16T15:34:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/644841483",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19197#discussion_r440980063"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19197"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/440980063"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Agree that it doesn't make anything worse, but it could be slightly better with a trivial diff.\r\n\r\n```diff\r\ndiff --git a/src/init.cpp b/src/init.cpp\r\nindex 8d9566edc3..984f6b2034 100644\r\n--- a/src/init.cpp\r\n+++ b/src/init.cpp\r\n@@ -152,8 +152,6 @@ NODISCARD static bool CreatePidFile()\r\n \r\n static std::unique_ptr<ECCVerifyHandle> globalVerifyHandle;\r\n \r\n-static std::thread g_load_block;\r\n-\r\n static boost::thread_group threadGroup;\r\n \r\n void Interrupt(NodeContext& node)\r\n@@ -218,7 +216,7 @@ void Shutdown(NodeContext& node)\r\n     // After everything has been shut down, but before things get flushed, stop the\r\n     // CScheduler/checkqueue, threadGroup and load block thread.\r\n     if (node.scheduler) node.scheduler->stop();\r\n-    if (g_load_block.joinable()) g_load_block.join();\r\n+    if (node.chainman && node.chainman->m_load_block.joinable()) node.chainman->m_load_block.join();\r\n     threadGroup.interrupt_all();\r\n     threadGroup.join_all();\r\n \r\n@@ -1844,7 +1842,7 @@ bool AppInitMain(const util::Ref& context, NodeContext& node)\r\n         vImportFiles.push_back(strFile);\r\n     }\r\n \r\n-    g_load_block = std::thread(&TraceThread<std::function<void()>>, \"loadblk\", [=, &chainman]{ ThreadImport(chainman, vImportFiles); });\r\n+    chainman.m_load_block = std::thread(&TraceThread<std::function<void()>>, \"loadblk\", [=, &chainman]{ ThreadImport(chainman, vImportFiles); });\r\n \r\n     // Wait for genesis block to be processed\r\n     {\r\ndiff --git a/src/validation.h b/src/validation.h\r\nindex e403bcb51a..9764a7aaca 100644\r\n--- a/src/validation.h\r\n+++ b/src/validation.h\r\n@@ -783,6 +783,7 @@ private:\r\n     friend CChain& ChainActive();\r\n \r\n public:\r\n+    std::thread m_load_block;\r\n     //! A single BlockManager instance is shared across each constructed\r\n     //! chainstate to avoid duplicating block metadata.\r\n     BlockManager m_blockman GUARDED_BY(::cs_main);\r\n",
      "commit_id" : "83fd3a6d73eee452dc5141bdf6826da62d7b2dbd",
      "created_at" : "2020-06-16T16:22:11Z",
      "diff_hunk" : "@@ -152,6 +152,8 @@ NODISCARD static bool CreatePidFile()\n \n static std::unique_ptr<ECCVerifyHandle> globalVerifyHandle;\n \n+static std::thread g_load_block;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19197#discussion_r440980063",
      "id" : 440980063,
      "in_reply_to_id" : 439362097,
      "line" : 155,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk4MDA2Mw==",
      "original_commit_id" : "83fd3a6d73eee452dc5141bdf6826da62d7b2dbd",
      "original_line" : 155,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 4,
      "pull_request_review_id" : 431679584,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19197",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-16T16:22:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/440980063",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19197#discussion_r442637440"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19197"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442637440"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks. I'll take care of the suggestions, adding to chainman and thread renaming, in some followup changes. I just wanted to get it out of the Boost thread group here.",
      "commit_id" : "83fd3a6d73eee452dc5141bdf6826da62d7b2dbd",
      "created_at" : "2020-06-19T05:26:27Z",
      "diff_hunk" : "@@ -152,6 +152,8 @@ NODISCARD static bool CreatePidFile()\n \n static std::unique_ptr<ECCVerifyHandle> globalVerifyHandle;\n \n+static std::thread g_load_block;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19197#discussion_r442637440",
      "id" : 442637440,
      "in_reply_to_id" : 439362097,
      "line" : 155,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjYzNzQ0MA==",
      "original_commit_id" : "83fd3a6d73eee452dc5141bdf6826da62d7b2dbd",
      "original_line" : 155,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 4,
      "pull_request_review_id" : 433810280,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19197",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-19T05:26:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442637440",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   }
]
