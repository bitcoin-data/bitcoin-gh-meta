[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #20864 (net: Move SocketSendData lock annotation to header by MarcoFalke)\n* #20744 ([POC] Use std::filesystem. Remove Boost Filesystem & System by fanquake)\n* #20487 (draft: Add syscall sandboxing using seccomp-bpf (Linux secure computing mode) by practicalswift)\n* #20201 (build: pkg-config related cleanup by hebasto)\n* #20196 (net: fix GetListenPort() to derive the proper port by vasild)\n* #19683 (depends: Pin clang search paths for darwin host by dongcarl)\n* #19064 (refactor: Cleanup thread ctor calls by hebasto)\n* #17920 (guix: Build support for macOS by dongcarl)\n* #16546 (External signer support - Wallet Box edition by Sjors)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-02-05T23:18:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-582659603",
      "id" : 582659603,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MjY1OTYwMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-06T15:41:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/582659603",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for picking this up again. I hope we manage to do this this time.",
      "created_at" : "2020-02-06T11:22:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-582859339",
      "id" : 582859339,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4Mjg1OTMzOQ==",
      "updated_at" : "2020-02-06T11:22:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/582859339",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r375996088"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/375996088"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This will break building with both NAT-PMP and UPnP support...",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-06T18:06:53Z",
      "diff_hunk" : "@@ -0,0 +1,221 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <arpa/inet.h>\n+#include <netinet/in.h>\n+#endif\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#endif\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif\n+\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_upnp_interrupt;\n+static std::thread g_upnp_thread;\n+\n+#ifdef USE_NATPMP\n+static void ThreadMapPort()\n+{\n+    int r;\n+    natpmp_t natpmp;\n+    natpmpresp_t response;\n+\n+    r = initnatpmp(&natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r < 0) {\n+        LogPrintf(\"NAT-PMP: initnatpmp() failed with %d error.\\n\", r);\n+        closenatpmp(&natpmp);\n+        return;\n+    }\n+\n+    if (fDiscover) {\n+        r = sendpublicaddressrequest(&natpmp);\n+        if (r < 0) {\n+            LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed with %d error.\\n\", r);\n+        } else {\n+            do {\n+                r = readnatpmpresponseorretry(&natpmp, &response);\n+            } while (r == NATPMP_TRYAGAIN);\n+            if (r < 0 || response.type != NATPMP_RESPTYPE_PUBLICADDRESS) {\n+                LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r);\n+            } else {\n+                const char* public_address = inet_ntoa(response.pnu.publicaddress.addr);\n+                if (public_address[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(public_address, resolved, false)) {\n+                        LogPrintf(\"NAT-PMP: public address = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_UPNP);\n+                    }\n+                } else {\n+                    LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed.\\n\");\n+                }\n+            }\n+        }\n+    }\n+\n+    const uint16_t port = GetListenPort();\n+    do {\n+        r = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, port, port, 3600 /*seconds*/);\n+        if (r < 0) {\n+            LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed with %d error.\\n\", r);\n+            break;\n+        }\n+\n+        do {\n+            r = readnatpmpresponseorretry(&natpmp, &response);\n+        } while (r == NATPMP_TRYAGAIN);\n+        if (r < 0 || response.type != NATPMP_RESPTYPE_TCPPORTMAPPING) {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r);\n+        } else {\n+            auto pm = response.pnu.newportmapping;\n+            if (port == pm.privateport && port == pm.mappedpublicport && pm.lifetime > 0) {\n+                LogPrintf(\"NAT-PMP: port mapping successful.\\n\");\n+            } else {\n+                LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed.\\n\");\n+            }\n+        }\n+\n+    } while (g_upnp_interrupt.sleep_for(std::chrono::minutes(20)));\n+\n+    r = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, port, port, /* remove a port mapping */ 0);\n+    if (r < 0) {\n+        LogPrintf(\"NAT-PMP: sendnewportmappingrequest(0) failed with %d error.\\n\", r);\n+    }\n+\n+    closenatpmp(&natpmp);\n+}\n+\n+#else // USE_UPNP",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r375996088",
      "id" : 375996088,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk5NjA4OA==",
      "original_commit_id" : "60e2524c8aa0edf5ce09d842cec09065cb854bcd",
      "original_line" : 119,
      "original_position" : 119,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : null,
      "pull_request_review_id" : 354660903,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/375996088",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r375999662"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/375999662"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> This will break building with both NAT-PMP and UPnP support...\r\n\r\nYes, I'm aware of that. This PR in its current state is intended for NAT-PMP functionality tests and concept (N)ACKs.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-06T18:14:29Z",
      "diff_hunk" : "@@ -0,0 +1,221 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <arpa/inet.h>\n+#include <netinet/in.h>\n+#endif\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#endif\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif\n+\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_upnp_interrupt;\n+static std::thread g_upnp_thread;\n+\n+#ifdef USE_NATPMP\n+static void ThreadMapPort()\n+{\n+    int r;\n+    natpmp_t natpmp;\n+    natpmpresp_t response;\n+\n+    r = initnatpmp(&natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r < 0) {\n+        LogPrintf(\"NAT-PMP: initnatpmp() failed with %d error.\\n\", r);\n+        closenatpmp(&natpmp);\n+        return;\n+    }\n+\n+    if (fDiscover) {\n+        r = sendpublicaddressrequest(&natpmp);\n+        if (r < 0) {\n+            LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed with %d error.\\n\", r);\n+        } else {\n+            do {\n+                r = readnatpmpresponseorretry(&natpmp, &response);\n+            } while (r == NATPMP_TRYAGAIN);\n+            if (r < 0 || response.type != NATPMP_RESPTYPE_PUBLICADDRESS) {\n+                LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r);\n+            } else {\n+                const char* public_address = inet_ntoa(response.pnu.publicaddress.addr);\n+                if (public_address[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(public_address, resolved, false)) {\n+                        LogPrintf(\"NAT-PMP: public address = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_UPNP);\n+                    }\n+                } else {\n+                    LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed.\\n\");\n+                }\n+            }\n+        }\n+    }\n+\n+    const uint16_t port = GetListenPort();\n+    do {\n+        r = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, port, port, 3600 /*seconds*/);\n+        if (r < 0) {\n+            LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed with %d error.\\n\", r);\n+            break;\n+        }\n+\n+        do {\n+            r = readnatpmpresponseorretry(&natpmp, &response);\n+        } while (r == NATPMP_TRYAGAIN);\n+        if (r < 0 || response.type != NATPMP_RESPTYPE_TCPPORTMAPPING) {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r);\n+        } else {\n+            auto pm = response.pnu.newportmapping;\n+            if (port == pm.privateport && port == pm.mappedpublicport && pm.lifetime > 0) {\n+                LogPrintf(\"NAT-PMP: port mapping successful.\\n\");\n+            } else {\n+                LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed.\\n\");\n+            }\n+        }\n+\n+    } while (g_upnp_interrupt.sleep_for(std::chrono::minutes(20)));\n+\n+    r = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, port, port, /* remove a port mapping */ 0);\n+    if (r < 0) {\n+        LogPrintf(\"NAT-PMP: sendnewportmappingrequest(0) failed with %d error.\\n\", r);\n+    }\n+\n+    closenatpmp(&natpmp);\n+}\n+\n+#else // USE_UPNP",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r375999662",
      "id" : 375999662,
      "in_reply_to_id" : 375996088,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk5OTY2Mg==",
      "original_commit_id" : "60e2524c8aa0edf5ce09d842cec09065cb854bcd",
      "original_line" : 119,
      "original_position" : 119,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : null,
      "pull_request_review_id" : 354665487,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/375999662",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2020-02-06T18:16:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-583039181",
      "id" : 583039181,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MzAzOTE4MQ==",
      "updated_at" : "2020-02-06T18:16:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/583039181",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "It is ready for reviewing now.",
      "created_at" : "2020-02-07T20:53:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-583606396",
      "id" : 583606396,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MzYwNjM5Ng==",
      "updated_at" : "2020-02-07T20:53:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/583606396",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Updated 4ff5349a3172d02fceb976bf4989996c88f86680 -> cf94431e8f4bfd6636998a17e2355feb2c5c3d58 ([pr18077.03](https://github.com/hebasto/bitcoin/commits/pr18077.03) -> [pr18077.04](https://github.com/hebasto/bitcoin/commits/pr18077.04), [compare](https://github.com/hebasto/bitcoin/compare/pr18077.03..pr18077.04)):\r\n\r\nadded `libnatpmp` package to macOS 10.14 native Travis build.",
      "created_at" : "2020-02-07T21:49:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-583630233",
      "id" : 583630233,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MzYzMDIzMw==",
      "updated_at" : "2020-02-07T21:49:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/583630233",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Updated cf94431e8f4bfd6636998a17e2355feb2c5c3d58 -> 88248a44241c8e3922a80729ce4a9a178ef2dbea ([pr18077.04](https://github.com/hebasto/bitcoin/commits/pr18077.04) -> [pr18077.05](https://github.com/hebasto/bitcoin/commits/pr18077.05), [compare](https://github.com/hebasto/bitcoin/compare/pr18077.04..pr18077.05)):\r\n\r\nadded:\r\n- changes to docs\r\n- release notes",
      "created_at" : "2020-02-08T08:17:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-583715048",
      "id" : 583715048,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MzcxNTA0OA==",
      "updated_at" : "2020-02-08T08:17:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/583715048",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2020-02-10T12:03:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-584090512",
      "id" : 584090512,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NDA5MDUxMg==",
      "updated_at" : "2020-02-10T12:03:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/584090512",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased after #17398 and #18081 have been merged.",
      "created_at" : "2020-02-10T17:20:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-584234105",
      "id" : 584234105,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NDIzNDEwNQ==",
      "updated_at" : "2020-02-10T17:20:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/584234105",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK, will test on my home router.",
      "created_at" : "2020-02-10T19:26:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-584307307",
      "id" : 584307307,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NDMwNzMwNw==",
      "updated_at" : "2020-02-10T19:26:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/584307307",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK. Lightly tested configure / build on macOS.\r\n\r\nUnfortunately I'm behind a IPv6 DS-Lite router, I can't test the IPv4 port forward. Perhaps `-7` could be replaced by something more readable.\r\n\r\n```\r\n2020-02-11T17:48:27Z natpmp thread start\r\n2020-02-11T17:48:27Z Bound to [::]:8333\r\n2020-02-11T17:48:27Z Bound to 0.0.0.0:8333\r\n2020-02-11T17:48:27Z init message: Loading P2P addresses...\r\n2020-02-11T17:48:27Z NAT-PMP: readnatpmpresponseorretry() for public address failed with -7 error.\r\n2020-02-11T17:48:27Z NAT-PMP: readnatpmpresponseorretry() for port mapping failed with -7 error. \r\n```\r\n\r\nI looked up the error code, and it's what I would expect given my setup:\r\n```\r\n/* NATPMP_ERR_NOGATEWAYSUPPORT : the gateway does not support NAT-PMP */\r\n#define NATPMP_ERR_NOGATEWAYSUPPORT (-7)\r\n```\r\n\r\nTwo suggesitons for followups, or this PR:\r\n* add checkbox in QT Settings (above UPNP)\r\n* add support for IPv6 pinhole if the library supports it, see #17012 (looks like it doesn't)",
      "created_at" : "2020-02-11T17:57:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-584768149",
      "id" : 584768149,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NDc2ODE0OQ==",
      "updated_at" : "2020-02-11T18:03:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/584768149",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@Sjors \r\n\r\nThank you for your review and testing.\r\n\r\n> I looked up the error code, and it's what I would expect given my setup:\r\n> \r\n> ```\r\n> /* NATPMP_ERR_NOGATEWAYSUPPORT : the gateway does not support NAT-PMP */\r\n> #define NATPMP_ERR_NOGATEWAYSUPPORT (-7)\r\n> ```\r\n\r\nAgree.\r\nBut in this initial PR I intentionally do not provide user-friendly error messages in order to keep `ThreadNatpmp()` dense and tight for easier reviewing ;)\r\n\r\nIn followups every library call (`initnatpmp()`, `sendpublicaddressrequest()` and `sendnewportmappingrequest()`) with the following `readnatpmpresponseorretry()` loops could be refactored out to separate functions with user-friendly error messages.\r\n\r\n> Two suggesitons for followups, or this PR:\r\n> \r\n>     * add checkbox in QT Settings (above UPNP)\r\n\r\nAgree. From the OP:\r\n> Some follow-ups are out of this PR's scope:\r\n> \r\n>     * mention NAT-PMP library in the version message\r\n> \r\n>     * integrate NAT-PMP into the GUI\r\n\r\n",
      "created_at" : "2020-02-11T19:11:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-584801614",
      "id" : 584801614,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NDgwMTYxNA==",
      "updated_at" : "2020-02-11T19:13:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/584801614",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r378006285"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/378006285"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Won't this overwrite the `g_mapport_thread` set above if both are enabled?",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-12T02:12:13Z",
      "diff_hunk" : "@@ -0,0 +1,236 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <arpa/inet.h>\n+#include <netinet/in.h>\n+#endif // #ifdef WIN32\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif // #ifdef USE_UPNP\n+\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_mapport_interrupt;\n+static std::thread g_mapport_thread;\n+\n+#ifdef USE_NATPMP\n+static void ThreadNatpmp()\n+{\n+    int r;\n+    natpmp_t natpmp;\n+    natpmpresp_t response;\n+\n+    r = initnatpmp(&natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r < 0) {\n+        LogPrintf(\"NAT-PMP: initnatpmp() failed with %d error.\\n\", r);\n+        closenatpmp(&natpmp);\n+        return;\n+    }\n+\n+    if (fDiscover) {\n+        r = sendpublicaddressrequest(&natpmp);\n+        if (r < 0) {\n+            LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed with %d error.\\n\", r);\n+        } else {\n+            do {\n+                r = readnatpmpresponseorretry(&natpmp, &response);\n+            } while (r == NATPMP_TRYAGAIN);\n+            if (r < 0 || response.type != NATPMP_RESPTYPE_PUBLICADDRESS) {\n+                LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r);\n+            } else {\n+                const char* public_address = inet_ntoa(response.pnu.publicaddress.addr);\n+                if (public_address[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(public_address, resolved, false)) {\n+                        LogPrintf(\"NAT-PMP: public address = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed.\\n\");\n+                }\n+            }\n+        }\n+    }\n+\n+    const uint16_t port = GetListenPort();\n+    do {\n+        r = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, port, port, 3600 /*seconds*/);\n+        if (r < 0) {\n+            LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed with %d error.\\n\", r);\n+            break;\n+        }\n+\n+        do {\n+            r = readnatpmpresponseorretry(&natpmp, &response);\n+        } while (r == NATPMP_TRYAGAIN);\n+        if (r < 0 || response.type != NATPMP_RESPTYPE_TCPPORTMAPPING) {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r);\n+        } else {\n+            auto pm = response.pnu.newportmapping;\n+            if (port == pm.privateport && port == pm.mappedpublicport && pm.lifetime > 0) {\n+                LogPrintf(\"NAT-PMP: port mapping successful.\\n\");\n+            } else {\n+                LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed.\\n\");\n+            }\n+        }\n+\n+    } while (g_mapport_interrupt.sleep_for(std::chrono::minutes(20)));\n+\n+    r = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, port, port, /* remove a port mapping */ 0);\n+    if (r < 0) {\n+        LogPrintf(\"NAT-PMP: sendnewportmappingrequest(0) failed with %d error.\\n\", r);\n+    }\n+\n+    closenatpmp(&natpmp);\n+}\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+static void ThreadUpnp()\n+{\n+    std::string port = strprintf(\"%u\", GetListenPort());\n+    const char * multicastif = nullptr;\n+    const char * minissdpdpath = nullptr;\n+    struct UPNPDev * devlist = nullptr;\n+    char lanaddr[64];\n+\n+    int error = 0;\n+#if MINIUPNPC_API_VERSION < 14\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, &error);\n+#else\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, 2, &error);\n+#endif\n+\n+    struct UPNPUrls urls;\n+    struct IGDdatas data;\n+    int r;\n+\n+    r = UPNP_GetValidIGD(devlist, &urls, &data, lanaddr, sizeof(lanaddr));\n+    if (r == 1)\n+    {\n+        if (fDiscover) {\n+            char externalIPAddress[40];\n+            r = UPNP_GetExternalIPAddress(urls.controlURL, data.first.servicetype, externalIPAddress);\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"UPnP: GetExternalIPAddress() returned %d\\n\", r);\n+            } else {\n+                if (externalIPAddress[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(externalIPAddress, resolved, false)) {\n+                        LogPrintf(\"UPnP: ExternalIPAddress = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"UPnP: GetExternalIPAddress failed.\\n\");\n+                }\n+            }\n+        }\n+\n+        std::string strDesc = PACKAGE_NAME \" \" + FormatFullVersion();\n+\n+        do {\n+            r = UPNP_AddPortMapping(urls.controlURL, data.first.servicetype, port.c_str(), port.c_str(), lanaddr, strDesc.c_str(), \"TCP\", 0, \"0\");\n+\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"AddPortMapping(%s, %s, %s) failed with code %d (%s)\\n\", port, port, lanaddr, r, strupnperror(r));\n+            } else {\n+                LogPrintf(\"UPnP Port Mapping successful.\\n\");\n+            }\n+        } while (g_mapport_interrupt.sleep_for(std::chrono::minutes(20)));\n+\n+        r = UPNP_DeletePortMapping(urls.controlURL, data.first.servicetype, port.c_str(), \"TCP\", 0);\n+        LogPrintf(\"UPNP_DeletePortMapping() returned: %d\\n\", r);\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        FreeUPNPUrls(&urls);\n+    } else {\n+        LogPrintf(\"No valid UPnP IGDs found\\n\");\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        if (r != 0)\n+            FreeUPNPUrls(&urls);\n+    }\n+}\n+#endif // #ifdef USE_UPNP\n+\n+void StartMapPort(MapPort proto)\n+{\n+    if (!g_mapport_thread.joinable()) {\n+        assert(!g_mapport_interrupt);\n+        switch (proto) {\n+        case MapPort::NAT_PMP: {\n+#ifdef USE_NATPMP\n+            g_mapport_thread = std::thread((std::bind(&TraceThread<void (*)()>, \"natpmp\", &ThreadNatpmp)));\n+#endif // #ifdef USE_NATPMP\n+            return;\n+        }\n+        case MapPort::UPNP: {\n+#ifdef USE_UPNP\n+            g_mapport_thread = std::thread((std::bind(&TraceThread<void (*)()>, \"upnp\", &ThreadUpnp)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r378006285",
      "id" : 378006285,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAwNjI4NQ==",
      "original_commit_id" : "c7e90ca40ad9b7c66f3429b792435e9279ceca6b",
      "original_line" : 242,
      "original_position" : 199,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : null,
      "pull_request_review_id" : 357148016,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/378006285",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r378072197"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/378072197"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I believe that the both port mapping protocols shouldn't be enabled simultaneously:\r\nhttps://github.com/bitcoin/bitcoin/blob/c7e90ca40ad9b7c66f3429b792435e9279ceca6b/src/init.cpp#L1781-L1786",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-12T07:10:35Z",
      "diff_hunk" : "@@ -0,0 +1,236 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <arpa/inet.h>\n+#include <netinet/in.h>\n+#endif // #ifdef WIN32\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif // #ifdef USE_UPNP\n+\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_mapport_interrupt;\n+static std::thread g_mapport_thread;\n+\n+#ifdef USE_NATPMP\n+static void ThreadNatpmp()\n+{\n+    int r;\n+    natpmp_t natpmp;\n+    natpmpresp_t response;\n+\n+    r = initnatpmp(&natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r < 0) {\n+        LogPrintf(\"NAT-PMP: initnatpmp() failed with %d error.\\n\", r);\n+        closenatpmp(&natpmp);\n+        return;\n+    }\n+\n+    if (fDiscover) {\n+        r = sendpublicaddressrequest(&natpmp);\n+        if (r < 0) {\n+            LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed with %d error.\\n\", r);\n+        } else {\n+            do {\n+                r = readnatpmpresponseorretry(&natpmp, &response);\n+            } while (r == NATPMP_TRYAGAIN);\n+            if (r < 0 || response.type != NATPMP_RESPTYPE_PUBLICADDRESS) {\n+                LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r);\n+            } else {\n+                const char* public_address = inet_ntoa(response.pnu.publicaddress.addr);\n+                if (public_address[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(public_address, resolved, false)) {\n+                        LogPrintf(\"NAT-PMP: public address = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed.\\n\");\n+                }\n+            }\n+        }\n+    }\n+\n+    const uint16_t port = GetListenPort();\n+    do {\n+        r = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, port, port, 3600 /*seconds*/);\n+        if (r < 0) {\n+            LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed with %d error.\\n\", r);\n+            break;\n+        }\n+\n+        do {\n+            r = readnatpmpresponseorretry(&natpmp, &response);\n+        } while (r == NATPMP_TRYAGAIN);\n+        if (r < 0 || response.type != NATPMP_RESPTYPE_TCPPORTMAPPING) {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r);\n+        } else {\n+            auto pm = response.pnu.newportmapping;\n+            if (port == pm.privateport && port == pm.mappedpublicport && pm.lifetime > 0) {\n+                LogPrintf(\"NAT-PMP: port mapping successful.\\n\");\n+            } else {\n+                LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed.\\n\");\n+            }\n+        }\n+\n+    } while (g_mapport_interrupt.sleep_for(std::chrono::minutes(20)));\n+\n+    r = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, port, port, /* remove a port mapping */ 0);\n+    if (r < 0) {\n+        LogPrintf(\"NAT-PMP: sendnewportmappingrequest(0) failed with %d error.\\n\", r);\n+    }\n+\n+    closenatpmp(&natpmp);\n+}\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+static void ThreadUpnp()\n+{\n+    std::string port = strprintf(\"%u\", GetListenPort());\n+    const char * multicastif = nullptr;\n+    const char * minissdpdpath = nullptr;\n+    struct UPNPDev * devlist = nullptr;\n+    char lanaddr[64];\n+\n+    int error = 0;\n+#if MINIUPNPC_API_VERSION < 14\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, &error);\n+#else\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, 2, &error);\n+#endif\n+\n+    struct UPNPUrls urls;\n+    struct IGDdatas data;\n+    int r;\n+\n+    r = UPNP_GetValidIGD(devlist, &urls, &data, lanaddr, sizeof(lanaddr));\n+    if (r == 1)\n+    {\n+        if (fDiscover) {\n+            char externalIPAddress[40];\n+            r = UPNP_GetExternalIPAddress(urls.controlURL, data.first.servicetype, externalIPAddress);\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"UPnP: GetExternalIPAddress() returned %d\\n\", r);\n+            } else {\n+                if (externalIPAddress[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(externalIPAddress, resolved, false)) {\n+                        LogPrintf(\"UPnP: ExternalIPAddress = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"UPnP: GetExternalIPAddress failed.\\n\");\n+                }\n+            }\n+        }\n+\n+        std::string strDesc = PACKAGE_NAME \" \" + FormatFullVersion();\n+\n+        do {\n+            r = UPNP_AddPortMapping(urls.controlURL, data.first.servicetype, port.c_str(), port.c_str(), lanaddr, strDesc.c_str(), \"TCP\", 0, \"0\");\n+\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"AddPortMapping(%s, %s, %s) failed with code %d (%s)\\n\", port, port, lanaddr, r, strupnperror(r));\n+            } else {\n+                LogPrintf(\"UPnP Port Mapping successful.\\n\");\n+            }\n+        } while (g_mapport_interrupt.sleep_for(std::chrono::minutes(20)));\n+\n+        r = UPNP_DeletePortMapping(urls.controlURL, data.first.servicetype, port.c_str(), \"TCP\", 0);\n+        LogPrintf(\"UPNP_DeletePortMapping() returned: %d\\n\", r);\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        FreeUPNPUrls(&urls);\n+    } else {\n+        LogPrintf(\"No valid UPnP IGDs found\\n\");\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        if (r != 0)\n+            FreeUPNPUrls(&urls);\n+    }\n+}\n+#endif // #ifdef USE_UPNP\n+\n+void StartMapPort(MapPort proto)\n+{\n+    if (!g_mapport_thread.joinable()) {\n+        assert(!g_mapport_interrupt);\n+        switch (proto) {\n+        case MapPort::NAT_PMP: {\n+#ifdef USE_NATPMP\n+            g_mapport_thread = std::thread((std::bind(&TraceThread<void (*)()>, \"natpmp\", &ThreadNatpmp)));\n+#endif // #ifdef USE_NATPMP\n+            return;\n+        }\n+        case MapPort::UPNP: {\n+#ifdef USE_UPNP\n+            g_mapport_thread = std::thread((std::bind(&TraceThread<void (*)()>, \"upnp\", &ThreadUpnp)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r378072197",
      "id" : 378072197,
      "in_reply_to_id" : 378006285,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA3MjE5Nw==",
      "original_commit_id" : "c7e90ca40ad9b7c66f3429b792435e9279ceca6b",
      "original_line" : 242,
      "original_position" : 199,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : null,
      "pull_request_review_id" : 357227561,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/378072197",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r378210260"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/378210260"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It should be possible to enable both.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-12T12:05:22Z",
      "diff_hunk" : "@@ -0,0 +1,236 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <arpa/inet.h>\n+#include <netinet/in.h>\n+#endif // #ifdef WIN32\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif // #ifdef USE_UPNP\n+\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_mapport_interrupt;\n+static std::thread g_mapport_thread;\n+\n+#ifdef USE_NATPMP\n+static void ThreadNatpmp()\n+{\n+    int r;\n+    natpmp_t natpmp;\n+    natpmpresp_t response;\n+\n+    r = initnatpmp(&natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r < 0) {\n+        LogPrintf(\"NAT-PMP: initnatpmp() failed with %d error.\\n\", r);\n+        closenatpmp(&natpmp);\n+        return;\n+    }\n+\n+    if (fDiscover) {\n+        r = sendpublicaddressrequest(&natpmp);\n+        if (r < 0) {\n+            LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed with %d error.\\n\", r);\n+        } else {\n+            do {\n+                r = readnatpmpresponseorretry(&natpmp, &response);\n+            } while (r == NATPMP_TRYAGAIN);\n+            if (r < 0 || response.type != NATPMP_RESPTYPE_PUBLICADDRESS) {\n+                LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r);\n+            } else {\n+                const char* public_address = inet_ntoa(response.pnu.publicaddress.addr);\n+                if (public_address[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(public_address, resolved, false)) {\n+                        LogPrintf(\"NAT-PMP: public address = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed.\\n\");\n+                }\n+            }\n+        }\n+    }\n+\n+    const uint16_t port = GetListenPort();\n+    do {\n+        r = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, port, port, 3600 /*seconds*/);\n+        if (r < 0) {\n+            LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed with %d error.\\n\", r);\n+            break;\n+        }\n+\n+        do {\n+            r = readnatpmpresponseorretry(&natpmp, &response);\n+        } while (r == NATPMP_TRYAGAIN);\n+        if (r < 0 || response.type != NATPMP_RESPTYPE_TCPPORTMAPPING) {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r);\n+        } else {\n+            auto pm = response.pnu.newportmapping;\n+            if (port == pm.privateport && port == pm.mappedpublicport && pm.lifetime > 0) {\n+                LogPrintf(\"NAT-PMP: port mapping successful.\\n\");\n+            } else {\n+                LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed.\\n\");\n+            }\n+        }\n+\n+    } while (g_mapport_interrupt.sleep_for(std::chrono::minutes(20)));\n+\n+    r = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, port, port, /* remove a port mapping */ 0);\n+    if (r < 0) {\n+        LogPrintf(\"NAT-PMP: sendnewportmappingrequest(0) failed with %d error.\\n\", r);\n+    }\n+\n+    closenatpmp(&natpmp);\n+}\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+static void ThreadUpnp()\n+{\n+    std::string port = strprintf(\"%u\", GetListenPort());\n+    const char * multicastif = nullptr;\n+    const char * minissdpdpath = nullptr;\n+    struct UPNPDev * devlist = nullptr;\n+    char lanaddr[64];\n+\n+    int error = 0;\n+#if MINIUPNPC_API_VERSION < 14\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, &error);\n+#else\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, 2, &error);\n+#endif\n+\n+    struct UPNPUrls urls;\n+    struct IGDdatas data;\n+    int r;\n+\n+    r = UPNP_GetValidIGD(devlist, &urls, &data, lanaddr, sizeof(lanaddr));\n+    if (r == 1)\n+    {\n+        if (fDiscover) {\n+            char externalIPAddress[40];\n+            r = UPNP_GetExternalIPAddress(urls.controlURL, data.first.servicetype, externalIPAddress);\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"UPnP: GetExternalIPAddress() returned %d\\n\", r);\n+            } else {\n+                if (externalIPAddress[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(externalIPAddress, resolved, false)) {\n+                        LogPrintf(\"UPnP: ExternalIPAddress = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"UPnP: GetExternalIPAddress failed.\\n\");\n+                }\n+            }\n+        }\n+\n+        std::string strDesc = PACKAGE_NAME \" \" + FormatFullVersion();\n+\n+        do {\n+            r = UPNP_AddPortMapping(urls.controlURL, data.first.servicetype, port.c_str(), port.c_str(), lanaddr, strDesc.c_str(), \"TCP\", 0, \"0\");\n+\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"AddPortMapping(%s, %s, %s) failed with code %d (%s)\\n\", port, port, lanaddr, r, strupnperror(r));\n+            } else {\n+                LogPrintf(\"UPnP Port Mapping successful.\\n\");\n+            }\n+        } while (g_mapport_interrupt.sleep_for(std::chrono::minutes(20)));\n+\n+        r = UPNP_DeletePortMapping(urls.controlURL, data.first.servicetype, port.c_str(), \"TCP\", 0);\n+        LogPrintf(\"UPNP_DeletePortMapping() returned: %d\\n\", r);\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        FreeUPNPUrls(&urls);\n+    } else {\n+        LogPrintf(\"No valid UPnP IGDs found\\n\");\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        if (r != 0)\n+            FreeUPNPUrls(&urls);\n+    }\n+}\n+#endif // #ifdef USE_UPNP\n+\n+void StartMapPort(MapPort proto)\n+{\n+    if (!g_mapport_thread.joinable()) {\n+        assert(!g_mapport_interrupt);\n+        switch (proto) {\n+        case MapPort::NAT_PMP: {\n+#ifdef USE_NATPMP\n+            g_mapport_thread = std::thread((std::bind(&TraceThread<void (*)()>, \"natpmp\", &ThreadNatpmp)));\n+#endif // #ifdef USE_NATPMP\n+            return;\n+        }\n+        case MapPort::UPNP: {\n+#ifdef USE_UPNP\n+            g_mapport_thread = std::thread((std::bind(&TraceThread<void (*)()>, \"upnp\", &ThreadUpnp)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r378210260",
      "id" : 378210260,
      "in_reply_to_id" : 378006285,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIxMDI2MA==",
      "original_commit_id" : "c7e90ca40ad9b7c66f3429b792435e9279ceca6b",
      "original_line" : 242,
      "original_position" : 199,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : null,
      "pull_request_review_id" : 357399634,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/378210260",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r378219481"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/378219481"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If both are enabled, would you try to open de port with NAT_PMP first and if that fails UPNP?",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-12T12:26:31Z",
      "diff_hunk" : "@@ -0,0 +1,236 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <arpa/inet.h>\n+#include <netinet/in.h>\n+#endif // #ifdef WIN32\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif // #ifdef USE_UPNP\n+\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_mapport_interrupt;\n+static std::thread g_mapport_thread;\n+\n+#ifdef USE_NATPMP\n+static void ThreadNatpmp()\n+{\n+    int r;\n+    natpmp_t natpmp;\n+    natpmpresp_t response;\n+\n+    r = initnatpmp(&natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r < 0) {\n+        LogPrintf(\"NAT-PMP: initnatpmp() failed with %d error.\\n\", r);\n+        closenatpmp(&natpmp);\n+        return;\n+    }\n+\n+    if (fDiscover) {\n+        r = sendpublicaddressrequest(&natpmp);\n+        if (r < 0) {\n+            LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed with %d error.\\n\", r);\n+        } else {\n+            do {\n+                r = readnatpmpresponseorretry(&natpmp, &response);\n+            } while (r == NATPMP_TRYAGAIN);\n+            if (r < 0 || response.type != NATPMP_RESPTYPE_PUBLICADDRESS) {\n+                LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r);\n+            } else {\n+                const char* public_address = inet_ntoa(response.pnu.publicaddress.addr);\n+                if (public_address[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(public_address, resolved, false)) {\n+                        LogPrintf(\"NAT-PMP: public address = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed.\\n\");\n+                }\n+            }\n+        }\n+    }\n+\n+    const uint16_t port = GetListenPort();\n+    do {\n+        r = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, port, port, 3600 /*seconds*/);\n+        if (r < 0) {\n+            LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed with %d error.\\n\", r);\n+            break;\n+        }\n+\n+        do {\n+            r = readnatpmpresponseorretry(&natpmp, &response);\n+        } while (r == NATPMP_TRYAGAIN);\n+        if (r < 0 || response.type != NATPMP_RESPTYPE_TCPPORTMAPPING) {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r);\n+        } else {\n+            auto pm = response.pnu.newportmapping;\n+            if (port == pm.privateport && port == pm.mappedpublicport && pm.lifetime > 0) {\n+                LogPrintf(\"NAT-PMP: port mapping successful.\\n\");\n+            } else {\n+                LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed.\\n\");\n+            }\n+        }\n+\n+    } while (g_mapport_interrupt.sleep_for(std::chrono::minutes(20)));\n+\n+    r = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, port, port, /* remove a port mapping */ 0);\n+    if (r < 0) {\n+        LogPrintf(\"NAT-PMP: sendnewportmappingrequest(0) failed with %d error.\\n\", r);\n+    }\n+\n+    closenatpmp(&natpmp);\n+}\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+static void ThreadUpnp()\n+{\n+    std::string port = strprintf(\"%u\", GetListenPort());\n+    const char * multicastif = nullptr;\n+    const char * minissdpdpath = nullptr;\n+    struct UPNPDev * devlist = nullptr;\n+    char lanaddr[64];\n+\n+    int error = 0;\n+#if MINIUPNPC_API_VERSION < 14\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, &error);\n+#else\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, 2, &error);\n+#endif\n+\n+    struct UPNPUrls urls;\n+    struct IGDdatas data;\n+    int r;\n+\n+    r = UPNP_GetValidIGD(devlist, &urls, &data, lanaddr, sizeof(lanaddr));\n+    if (r == 1)\n+    {\n+        if (fDiscover) {\n+            char externalIPAddress[40];\n+            r = UPNP_GetExternalIPAddress(urls.controlURL, data.first.servicetype, externalIPAddress);\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"UPnP: GetExternalIPAddress() returned %d\\n\", r);\n+            } else {\n+                if (externalIPAddress[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(externalIPAddress, resolved, false)) {\n+                        LogPrintf(\"UPnP: ExternalIPAddress = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"UPnP: GetExternalIPAddress failed.\\n\");\n+                }\n+            }\n+        }\n+\n+        std::string strDesc = PACKAGE_NAME \" \" + FormatFullVersion();\n+\n+        do {\n+            r = UPNP_AddPortMapping(urls.controlURL, data.first.servicetype, port.c_str(), port.c_str(), lanaddr, strDesc.c_str(), \"TCP\", 0, \"0\");\n+\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"AddPortMapping(%s, %s, %s) failed with code %d (%s)\\n\", port, port, lanaddr, r, strupnperror(r));\n+            } else {\n+                LogPrintf(\"UPnP Port Mapping successful.\\n\");\n+            }\n+        } while (g_mapport_interrupt.sleep_for(std::chrono::minutes(20)));\n+\n+        r = UPNP_DeletePortMapping(urls.controlURL, data.first.servicetype, port.c_str(), \"TCP\", 0);\n+        LogPrintf(\"UPNP_DeletePortMapping() returned: %d\\n\", r);\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        FreeUPNPUrls(&urls);\n+    } else {\n+        LogPrintf(\"No valid UPnP IGDs found\\n\");\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        if (r != 0)\n+            FreeUPNPUrls(&urls);\n+    }\n+}\n+#endif // #ifdef USE_UPNP\n+\n+void StartMapPort(MapPort proto)\n+{\n+    if (!g_mapport_thread.joinable()) {\n+        assert(!g_mapport_interrupt);\n+        switch (proto) {\n+        case MapPort::NAT_PMP: {\n+#ifdef USE_NATPMP\n+            g_mapport_thread = std::thread((std::bind(&TraceThread<void (*)()>, \"natpmp\", &ThreadNatpmp)));\n+#endif // #ifdef USE_NATPMP\n+            return;\n+        }\n+        case MapPort::UPNP: {\n+#ifdef USE_UPNP\n+            g_mapport_thread = std::thread((std::bind(&TraceThread<void (*)()>, \"upnp\", &ThreadUpnp)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r378219481",
      "id" : 378219481,
      "in_reply_to_id" : 378006285,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIxOTQ4MQ==",
      "original_commit_id" : "c7e90ca40ad9b7c66f3429b792435e9279ceca6b",
      "original_line" : 242,
      "original_position" : 199,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : null,
      "pull_request_review_id" : 357411424,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/378219481",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r378221757"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/378221757"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> It should be possible to enable both.\r\n\r\nDo you mean that a router could do port mapping using both NAT-PMP and UPnP simultaneously? What is the reason for that?",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-12T12:31:52Z",
      "diff_hunk" : "@@ -0,0 +1,236 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <arpa/inet.h>\n+#include <netinet/in.h>\n+#endif // #ifdef WIN32\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif // #ifdef USE_UPNP\n+\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_mapport_interrupt;\n+static std::thread g_mapport_thread;\n+\n+#ifdef USE_NATPMP\n+static void ThreadNatpmp()\n+{\n+    int r;\n+    natpmp_t natpmp;\n+    natpmpresp_t response;\n+\n+    r = initnatpmp(&natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r < 0) {\n+        LogPrintf(\"NAT-PMP: initnatpmp() failed with %d error.\\n\", r);\n+        closenatpmp(&natpmp);\n+        return;\n+    }\n+\n+    if (fDiscover) {\n+        r = sendpublicaddressrequest(&natpmp);\n+        if (r < 0) {\n+            LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed with %d error.\\n\", r);\n+        } else {\n+            do {\n+                r = readnatpmpresponseorretry(&natpmp, &response);\n+            } while (r == NATPMP_TRYAGAIN);\n+            if (r < 0 || response.type != NATPMP_RESPTYPE_PUBLICADDRESS) {\n+                LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r);\n+            } else {\n+                const char* public_address = inet_ntoa(response.pnu.publicaddress.addr);\n+                if (public_address[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(public_address, resolved, false)) {\n+                        LogPrintf(\"NAT-PMP: public address = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed.\\n\");\n+                }\n+            }\n+        }\n+    }\n+\n+    const uint16_t port = GetListenPort();\n+    do {\n+        r = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, port, port, 3600 /*seconds*/);\n+        if (r < 0) {\n+            LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed with %d error.\\n\", r);\n+            break;\n+        }\n+\n+        do {\n+            r = readnatpmpresponseorretry(&natpmp, &response);\n+        } while (r == NATPMP_TRYAGAIN);\n+        if (r < 0 || response.type != NATPMP_RESPTYPE_TCPPORTMAPPING) {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r);\n+        } else {\n+            auto pm = response.pnu.newportmapping;\n+            if (port == pm.privateport && port == pm.mappedpublicport && pm.lifetime > 0) {\n+                LogPrintf(\"NAT-PMP: port mapping successful.\\n\");\n+            } else {\n+                LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed.\\n\");\n+            }\n+        }\n+\n+    } while (g_mapport_interrupt.sleep_for(std::chrono::minutes(20)));\n+\n+    r = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, port, port, /* remove a port mapping */ 0);\n+    if (r < 0) {\n+        LogPrintf(\"NAT-PMP: sendnewportmappingrequest(0) failed with %d error.\\n\", r);\n+    }\n+\n+    closenatpmp(&natpmp);\n+}\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+static void ThreadUpnp()\n+{\n+    std::string port = strprintf(\"%u\", GetListenPort());\n+    const char * multicastif = nullptr;\n+    const char * minissdpdpath = nullptr;\n+    struct UPNPDev * devlist = nullptr;\n+    char lanaddr[64];\n+\n+    int error = 0;\n+#if MINIUPNPC_API_VERSION < 14\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, &error);\n+#else\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, 2, &error);\n+#endif\n+\n+    struct UPNPUrls urls;\n+    struct IGDdatas data;\n+    int r;\n+\n+    r = UPNP_GetValidIGD(devlist, &urls, &data, lanaddr, sizeof(lanaddr));\n+    if (r == 1)\n+    {\n+        if (fDiscover) {\n+            char externalIPAddress[40];\n+            r = UPNP_GetExternalIPAddress(urls.controlURL, data.first.servicetype, externalIPAddress);\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"UPnP: GetExternalIPAddress() returned %d\\n\", r);\n+            } else {\n+                if (externalIPAddress[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(externalIPAddress, resolved, false)) {\n+                        LogPrintf(\"UPnP: ExternalIPAddress = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"UPnP: GetExternalIPAddress failed.\\n\");\n+                }\n+            }\n+        }\n+\n+        std::string strDesc = PACKAGE_NAME \" \" + FormatFullVersion();\n+\n+        do {\n+            r = UPNP_AddPortMapping(urls.controlURL, data.first.servicetype, port.c_str(), port.c_str(), lanaddr, strDesc.c_str(), \"TCP\", 0, \"0\");\n+\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"AddPortMapping(%s, %s, %s) failed with code %d (%s)\\n\", port, port, lanaddr, r, strupnperror(r));\n+            } else {\n+                LogPrintf(\"UPnP Port Mapping successful.\\n\");\n+            }\n+        } while (g_mapport_interrupt.sleep_for(std::chrono::minutes(20)));\n+\n+        r = UPNP_DeletePortMapping(urls.controlURL, data.first.servicetype, port.c_str(), \"TCP\", 0);\n+        LogPrintf(\"UPNP_DeletePortMapping() returned: %d\\n\", r);\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        FreeUPNPUrls(&urls);\n+    } else {\n+        LogPrintf(\"No valid UPnP IGDs found\\n\");\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        if (r != 0)\n+            FreeUPNPUrls(&urls);\n+    }\n+}\n+#endif // #ifdef USE_UPNP\n+\n+void StartMapPort(MapPort proto)\n+{\n+    if (!g_mapport_thread.joinable()) {\n+        assert(!g_mapport_interrupt);\n+        switch (proto) {\n+        case MapPort::NAT_PMP: {\n+#ifdef USE_NATPMP\n+            g_mapport_thread = std::thread((std::bind(&TraceThread<void (*)()>, \"natpmp\", &ThreadNatpmp)));\n+#endif // #ifdef USE_NATPMP\n+            return;\n+        }\n+        case MapPort::UPNP: {\n+#ifdef USE_UPNP\n+            g_mapport_thread = std::thread((std::bind(&TraceThread<void (*)()>, \"upnp\", &ThreadUpnp)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r378221757",
      "id" : 378221757,
      "in_reply_to_id" : 378006285,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIyMTc1Nw==",
      "original_commit_id" : "c7e90ca40ad9b7c66f3429b792435e9279ceca6b",
      "original_line" : 242,
      "original_position" : 199,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : null,
      "pull_request_review_id" : 357414425,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/378221757",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r378227115"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/378227115"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I wouldn't use them simultaneously, but one fails it makes sense to try the other. Though I believe our long plan is to remove UPnP, if NAT-PMP does the job.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-12T12:43:39Z",
      "diff_hunk" : "@@ -0,0 +1,236 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <arpa/inet.h>\n+#include <netinet/in.h>\n+#endif // #ifdef WIN32\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif // #ifdef USE_UPNP\n+\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_mapport_interrupt;\n+static std::thread g_mapport_thread;\n+\n+#ifdef USE_NATPMP\n+static void ThreadNatpmp()\n+{\n+    int r;\n+    natpmp_t natpmp;\n+    natpmpresp_t response;\n+\n+    r = initnatpmp(&natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r < 0) {\n+        LogPrintf(\"NAT-PMP: initnatpmp() failed with %d error.\\n\", r);\n+        closenatpmp(&natpmp);\n+        return;\n+    }\n+\n+    if (fDiscover) {\n+        r = sendpublicaddressrequest(&natpmp);\n+        if (r < 0) {\n+            LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed with %d error.\\n\", r);\n+        } else {\n+            do {\n+                r = readnatpmpresponseorretry(&natpmp, &response);\n+            } while (r == NATPMP_TRYAGAIN);\n+            if (r < 0 || response.type != NATPMP_RESPTYPE_PUBLICADDRESS) {\n+                LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r);\n+            } else {\n+                const char* public_address = inet_ntoa(response.pnu.publicaddress.addr);\n+                if (public_address[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(public_address, resolved, false)) {\n+                        LogPrintf(\"NAT-PMP: public address = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed.\\n\");\n+                }\n+            }\n+        }\n+    }\n+\n+    const uint16_t port = GetListenPort();\n+    do {\n+        r = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, port, port, 3600 /*seconds*/);\n+        if (r < 0) {\n+            LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed with %d error.\\n\", r);\n+            break;\n+        }\n+\n+        do {\n+            r = readnatpmpresponseorretry(&natpmp, &response);\n+        } while (r == NATPMP_TRYAGAIN);\n+        if (r < 0 || response.type != NATPMP_RESPTYPE_TCPPORTMAPPING) {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r);\n+        } else {\n+            auto pm = response.pnu.newportmapping;\n+            if (port == pm.privateport && port == pm.mappedpublicport && pm.lifetime > 0) {\n+                LogPrintf(\"NAT-PMP: port mapping successful.\\n\");\n+            } else {\n+                LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed.\\n\");\n+            }\n+        }\n+\n+    } while (g_mapport_interrupt.sleep_for(std::chrono::minutes(20)));\n+\n+    r = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, port, port, /* remove a port mapping */ 0);\n+    if (r < 0) {\n+        LogPrintf(\"NAT-PMP: sendnewportmappingrequest(0) failed with %d error.\\n\", r);\n+    }\n+\n+    closenatpmp(&natpmp);\n+}\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+static void ThreadUpnp()\n+{\n+    std::string port = strprintf(\"%u\", GetListenPort());\n+    const char * multicastif = nullptr;\n+    const char * minissdpdpath = nullptr;\n+    struct UPNPDev * devlist = nullptr;\n+    char lanaddr[64];\n+\n+    int error = 0;\n+#if MINIUPNPC_API_VERSION < 14\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, &error);\n+#else\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, 2, &error);\n+#endif\n+\n+    struct UPNPUrls urls;\n+    struct IGDdatas data;\n+    int r;\n+\n+    r = UPNP_GetValidIGD(devlist, &urls, &data, lanaddr, sizeof(lanaddr));\n+    if (r == 1)\n+    {\n+        if (fDiscover) {\n+            char externalIPAddress[40];\n+            r = UPNP_GetExternalIPAddress(urls.controlURL, data.first.servicetype, externalIPAddress);\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"UPnP: GetExternalIPAddress() returned %d\\n\", r);\n+            } else {\n+                if (externalIPAddress[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(externalIPAddress, resolved, false)) {\n+                        LogPrintf(\"UPnP: ExternalIPAddress = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"UPnP: GetExternalIPAddress failed.\\n\");\n+                }\n+            }\n+        }\n+\n+        std::string strDesc = PACKAGE_NAME \" \" + FormatFullVersion();\n+\n+        do {\n+            r = UPNP_AddPortMapping(urls.controlURL, data.first.servicetype, port.c_str(), port.c_str(), lanaddr, strDesc.c_str(), \"TCP\", 0, \"0\");\n+\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"AddPortMapping(%s, %s, %s) failed with code %d (%s)\\n\", port, port, lanaddr, r, strupnperror(r));\n+            } else {\n+                LogPrintf(\"UPnP Port Mapping successful.\\n\");\n+            }\n+        } while (g_mapport_interrupt.sleep_for(std::chrono::minutes(20)));\n+\n+        r = UPNP_DeletePortMapping(urls.controlURL, data.first.servicetype, port.c_str(), \"TCP\", 0);\n+        LogPrintf(\"UPNP_DeletePortMapping() returned: %d\\n\", r);\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        FreeUPNPUrls(&urls);\n+    } else {\n+        LogPrintf(\"No valid UPnP IGDs found\\n\");\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        if (r != 0)\n+            FreeUPNPUrls(&urls);\n+    }\n+}\n+#endif // #ifdef USE_UPNP\n+\n+void StartMapPort(MapPort proto)\n+{\n+    if (!g_mapport_thread.joinable()) {\n+        assert(!g_mapport_interrupt);\n+        switch (proto) {\n+        case MapPort::NAT_PMP: {\n+#ifdef USE_NATPMP\n+            g_mapport_thread = std::thread((std::bind(&TraceThread<void (*)()>, \"natpmp\", &ThreadNatpmp)));\n+#endif // #ifdef USE_NATPMP\n+            return;\n+        }\n+        case MapPort::UPNP: {\n+#ifdef USE_UPNP\n+            g_mapport_thread = std::thread((std::bind(&TraceThread<void (*)()>, \"upnp\", &ThreadUpnp)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r378227115",
      "id" : 378227115,
      "in_reply_to_id" : 378006285,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIyNzExNQ==",
      "original_commit_id" : "c7e90ca40ad9b7c66f3429b792435e9279ceca6b",
      "original_line" : 242,
      "original_position" : 199,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : null,
      "pull_request_review_id" : 357421173,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/378227115",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r378235158"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/378235158"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> I wouldn't use them simultaneously, but one fails it makes sense to try the other.\r\n\r\nGood suggestion for a followup.\r\n\r\n> Though I believe our long plan is to remove UPnP, if NAT-PMP does the job.\r\n\r\nNot all routers with stock software have NAT-PMP port mapping feature.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-12T13:01:00Z",
      "diff_hunk" : "@@ -0,0 +1,236 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <arpa/inet.h>\n+#include <netinet/in.h>\n+#endif // #ifdef WIN32\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif // #ifdef USE_UPNP\n+\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_mapport_interrupt;\n+static std::thread g_mapport_thread;\n+\n+#ifdef USE_NATPMP\n+static void ThreadNatpmp()\n+{\n+    int r;\n+    natpmp_t natpmp;\n+    natpmpresp_t response;\n+\n+    r = initnatpmp(&natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r < 0) {\n+        LogPrintf(\"NAT-PMP: initnatpmp() failed with %d error.\\n\", r);\n+        closenatpmp(&natpmp);\n+        return;\n+    }\n+\n+    if (fDiscover) {\n+        r = sendpublicaddressrequest(&natpmp);\n+        if (r < 0) {\n+            LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed with %d error.\\n\", r);\n+        } else {\n+            do {\n+                r = readnatpmpresponseorretry(&natpmp, &response);\n+            } while (r == NATPMP_TRYAGAIN);\n+            if (r < 0 || response.type != NATPMP_RESPTYPE_PUBLICADDRESS) {\n+                LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r);\n+            } else {\n+                const char* public_address = inet_ntoa(response.pnu.publicaddress.addr);\n+                if (public_address[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(public_address, resolved, false)) {\n+                        LogPrintf(\"NAT-PMP: public address = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed.\\n\");\n+                }\n+            }\n+        }\n+    }\n+\n+    const uint16_t port = GetListenPort();\n+    do {\n+        r = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, port, port, 3600 /*seconds*/);\n+        if (r < 0) {\n+            LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed with %d error.\\n\", r);\n+            break;\n+        }\n+\n+        do {\n+            r = readnatpmpresponseorretry(&natpmp, &response);\n+        } while (r == NATPMP_TRYAGAIN);\n+        if (r < 0 || response.type != NATPMP_RESPTYPE_TCPPORTMAPPING) {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r);\n+        } else {\n+            auto pm = response.pnu.newportmapping;\n+            if (port == pm.privateport && port == pm.mappedpublicport && pm.lifetime > 0) {\n+                LogPrintf(\"NAT-PMP: port mapping successful.\\n\");\n+            } else {\n+                LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed.\\n\");\n+            }\n+        }\n+\n+    } while (g_mapport_interrupt.sleep_for(std::chrono::minutes(20)));\n+\n+    r = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, port, port, /* remove a port mapping */ 0);\n+    if (r < 0) {\n+        LogPrintf(\"NAT-PMP: sendnewportmappingrequest(0) failed with %d error.\\n\", r);\n+    }\n+\n+    closenatpmp(&natpmp);\n+}\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+static void ThreadUpnp()\n+{\n+    std::string port = strprintf(\"%u\", GetListenPort());\n+    const char * multicastif = nullptr;\n+    const char * minissdpdpath = nullptr;\n+    struct UPNPDev * devlist = nullptr;\n+    char lanaddr[64];\n+\n+    int error = 0;\n+#if MINIUPNPC_API_VERSION < 14\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, &error);\n+#else\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, 2, &error);\n+#endif\n+\n+    struct UPNPUrls urls;\n+    struct IGDdatas data;\n+    int r;\n+\n+    r = UPNP_GetValidIGD(devlist, &urls, &data, lanaddr, sizeof(lanaddr));\n+    if (r == 1)\n+    {\n+        if (fDiscover) {\n+            char externalIPAddress[40];\n+            r = UPNP_GetExternalIPAddress(urls.controlURL, data.first.servicetype, externalIPAddress);\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"UPnP: GetExternalIPAddress() returned %d\\n\", r);\n+            } else {\n+                if (externalIPAddress[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(externalIPAddress, resolved, false)) {\n+                        LogPrintf(\"UPnP: ExternalIPAddress = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"UPnP: GetExternalIPAddress failed.\\n\");\n+                }\n+            }\n+        }\n+\n+        std::string strDesc = PACKAGE_NAME \" \" + FormatFullVersion();\n+\n+        do {\n+            r = UPNP_AddPortMapping(urls.controlURL, data.first.servicetype, port.c_str(), port.c_str(), lanaddr, strDesc.c_str(), \"TCP\", 0, \"0\");\n+\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"AddPortMapping(%s, %s, %s) failed with code %d (%s)\\n\", port, port, lanaddr, r, strupnperror(r));\n+            } else {\n+                LogPrintf(\"UPnP Port Mapping successful.\\n\");\n+            }\n+        } while (g_mapport_interrupt.sleep_for(std::chrono::minutes(20)));\n+\n+        r = UPNP_DeletePortMapping(urls.controlURL, data.first.servicetype, port.c_str(), \"TCP\", 0);\n+        LogPrintf(\"UPNP_DeletePortMapping() returned: %d\\n\", r);\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        FreeUPNPUrls(&urls);\n+    } else {\n+        LogPrintf(\"No valid UPnP IGDs found\\n\");\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        if (r != 0)\n+            FreeUPNPUrls(&urls);\n+    }\n+}\n+#endif // #ifdef USE_UPNP\n+\n+void StartMapPort(MapPort proto)\n+{\n+    if (!g_mapport_thread.joinable()) {\n+        assert(!g_mapport_interrupt);\n+        switch (proto) {\n+        case MapPort::NAT_PMP: {\n+#ifdef USE_NATPMP\n+            g_mapport_thread = std::thread((std::bind(&TraceThread<void (*)()>, \"natpmp\", &ThreadNatpmp)));\n+#endif // #ifdef USE_NATPMP\n+            return;\n+        }\n+        case MapPort::UPNP: {\n+#ifdef USE_UPNP\n+            g_mapport_thread = std::thread((std::bind(&TraceThread<void (*)()>, \"upnp\", &ThreadUpnp)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r378235158",
      "id" : 378235158,
      "in_reply_to_id" : 378006285,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIzNTE1OA==",
      "original_commit_id" : "c7e90ca40ad9b7c66f3429b792435e9279ceca6b",
      "original_line" : 242,
      "original_position" : 199,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : null,
      "pull_request_review_id" : 357431400,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/378235158",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r378236713"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/378236713"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Users who don't know what their router supports should be able to just flip both on. And laptops might very well migrate between different routers using each protocol.\r\n\r\nAgree with @hebasto that NAT-PMP can't be a complete substitute for UPnP since routers might not support both.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-12T13:04:21Z",
      "diff_hunk" : "@@ -0,0 +1,236 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <arpa/inet.h>\n+#include <netinet/in.h>\n+#endif // #ifdef WIN32\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif // #ifdef USE_UPNP\n+\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_mapport_interrupt;\n+static std::thread g_mapport_thread;\n+\n+#ifdef USE_NATPMP\n+static void ThreadNatpmp()\n+{\n+    int r;\n+    natpmp_t natpmp;\n+    natpmpresp_t response;\n+\n+    r = initnatpmp(&natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r < 0) {\n+        LogPrintf(\"NAT-PMP: initnatpmp() failed with %d error.\\n\", r);\n+        closenatpmp(&natpmp);\n+        return;\n+    }\n+\n+    if (fDiscover) {\n+        r = sendpublicaddressrequest(&natpmp);\n+        if (r < 0) {\n+            LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed with %d error.\\n\", r);\n+        } else {\n+            do {\n+                r = readnatpmpresponseorretry(&natpmp, &response);\n+            } while (r == NATPMP_TRYAGAIN);\n+            if (r < 0 || response.type != NATPMP_RESPTYPE_PUBLICADDRESS) {\n+                LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r);\n+            } else {\n+                const char* public_address = inet_ntoa(response.pnu.publicaddress.addr);\n+                if (public_address[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(public_address, resolved, false)) {\n+                        LogPrintf(\"NAT-PMP: public address = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed.\\n\");\n+                }\n+            }\n+        }\n+    }\n+\n+    const uint16_t port = GetListenPort();\n+    do {\n+        r = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, port, port, 3600 /*seconds*/);\n+        if (r < 0) {\n+            LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed with %d error.\\n\", r);\n+            break;\n+        }\n+\n+        do {\n+            r = readnatpmpresponseorretry(&natpmp, &response);\n+        } while (r == NATPMP_TRYAGAIN);\n+        if (r < 0 || response.type != NATPMP_RESPTYPE_TCPPORTMAPPING) {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r);\n+        } else {\n+            auto pm = response.pnu.newportmapping;\n+            if (port == pm.privateport && port == pm.mappedpublicport && pm.lifetime > 0) {\n+                LogPrintf(\"NAT-PMP: port mapping successful.\\n\");\n+            } else {\n+                LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed.\\n\");\n+            }\n+        }\n+\n+    } while (g_mapport_interrupt.sleep_for(std::chrono::minutes(20)));\n+\n+    r = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, port, port, /* remove a port mapping */ 0);\n+    if (r < 0) {\n+        LogPrintf(\"NAT-PMP: sendnewportmappingrequest(0) failed with %d error.\\n\", r);\n+    }\n+\n+    closenatpmp(&natpmp);\n+}\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+static void ThreadUpnp()\n+{\n+    std::string port = strprintf(\"%u\", GetListenPort());\n+    const char * multicastif = nullptr;\n+    const char * minissdpdpath = nullptr;\n+    struct UPNPDev * devlist = nullptr;\n+    char lanaddr[64];\n+\n+    int error = 0;\n+#if MINIUPNPC_API_VERSION < 14\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, &error);\n+#else\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, 2, &error);\n+#endif\n+\n+    struct UPNPUrls urls;\n+    struct IGDdatas data;\n+    int r;\n+\n+    r = UPNP_GetValidIGD(devlist, &urls, &data, lanaddr, sizeof(lanaddr));\n+    if (r == 1)\n+    {\n+        if (fDiscover) {\n+            char externalIPAddress[40];\n+            r = UPNP_GetExternalIPAddress(urls.controlURL, data.first.servicetype, externalIPAddress);\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"UPnP: GetExternalIPAddress() returned %d\\n\", r);\n+            } else {\n+                if (externalIPAddress[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(externalIPAddress, resolved, false)) {\n+                        LogPrintf(\"UPnP: ExternalIPAddress = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"UPnP: GetExternalIPAddress failed.\\n\");\n+                }\n+            }\n+        }\n+\n+        std::string strDesc = PACKAGE_NAME \" \" + FormatFullVersion();\n+\n+        do {\n+            r = UPNP_AddPortMapping(urls.controlURL, data.first.servicetype, port.c_str(), port.c_str(), lanaddr, strDesc.c_str(), \"TCP\", 0, \"0\");\n+\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"AddPortMapping(%s, %s, %s) failed with code %d (%s)\\n\", port, port, lanaddr, r, strupnperror(r));\n+            } else {\n+                LogPrintf(\"UPnP Port Mapping successful.\\n\");\n+            }\n+        } while (g_mapport_interrupt.sleep_for(std::chrono::minutes(20)));\n+\n+        r = UPNP_DeletePortMapping(urls.controlURL, data.first.servicetype, port.c_str(), \"TCP\", 0);\n+        LogPrintf(\"UPNP_DeletePortMapping() returned: %d\\n\", r);\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        FreeUPNPUrls(&urls);\n+    } else {\n+        LogPrintf(\"No valid UPnP IGDs found\\n\");\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        if (r != 0)\n+            FreeUPNPUrls(&urls);\n+    }\n+}\n+#endif // #ifdef USE_UPNP\n+\n+void StartMapPort(MapPort proto)\n+{\n+    if (!g_mapport_thread.joinable()) {\n+        assert(!g_mapport_interrupt);\n+        switch (proto) {\n+        case MapPort::NAT_PMP: {\n+#ifdef USE_NATPMP\n+            g_mapport_thread = std::thread((std::bind(&TraceThread<void (*)()>, \"natpmp\", &ThreadNatpmp)));\n+#endif // #ifdef USE_NATPMP\n+            return;\n+        }\n+        case MapPort::UPNP: {\n+#ifdef USE_UPNP\n+            g_mapport_thread = std::thread((std::bind(&TraceThread<void (*)()>, \"upnp\", &ThreadUpnp)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r378236713",
      "id" : 378236713,
      "in_reply_to_id" : 378006285,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIzNjcxMw==",
      "original_commit_id" : "c7e90ca40ad9b7c66f3429b792435e9279ceca6b",
      "original_line" : 242,
      "original_position" : 199,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : null,
      "pull_request_review_id" : 357433454,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/378236713",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Updated c7e90ca40ad9b7c66f3429b792435e9279ceca6b -> dc228d6db8d2e9406d6d6e0eb04e37940b1ffb82 ([pr18077.06](https://github.com/hebasto/bitcoin/commits/pr18077.06) -> [pr18077.07](https://github.com/hebasto/bitcoin/commits/pr18077.07), [compare](https://github.com/hebasto/bitcoin/compare/pr18077.06..pr18077.07)):\r\n\r\nChanges:\r\n- added a user-friendly error message for the `NATPMP_ERR_NOGATEWAYSUPPORT` error\r\n- enable both NAT-PMP and UPnP if `-natpmp` and `-upnp` options are supplied\r\n\r\n---\r\n\r\n@Sjors \r\n> Perhaps `-7` could be replaced by something more readable.\r\n\r\nDone.\r\n\r\n> If both are enabled, would you try to open de port with NAT_PMP first and if that fails UPNP?\r\n> I wouldn't use them simultaneously, but one fails it makes sense to try the other.\r\n\r\nDone.",
      "created_at" : "2020-02-16T15:59:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-586722575",
      "id" : 586722575,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NjcyMjU3NQ==",
      "updated_at" : "2020-02-16T16:09:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/586722575",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r379913637"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/379913637"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Addressed in the latest push.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-16T16:00:20Z",
      "diff_hunk" : "@@ -0,0 +1,236 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <arpa/inet.h>\n+#include <netinet/in.h>\n+#endif // #ifdef WIN32\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif // #ifdef USE_UPNP\n+\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_mapport_interrupt;\n+static std::thread g_mapport_thread;\n+\n+#ifdef USE_NATPMP\n+static void ThreadNatpmp()\n+{\n+    int r;\n+    natpmp_t natpmp;\n+    natpmpresp_t response;\n+\n+    r = initnatpmp(&natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r < 0) {\n+        LogPrintf(\"NAT-PMP: initnatpmp() failed with %d error.\\n\", r);\n+        closenatpmp(&natpmp);\n+        return;\n+    }\n+\n+    if (fDiscover) {\n+        r = sendpublicaddressrequest(&natpmp);\n+        if (r < 0) {\n+            LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed with %d error.\\n\", r);\n+        } else {\n+            do {\n+                r = readnatpmpresponseorretry(&natpmp, &response);\n+            } while (r == NATPMP_TRYAGAIN);\n+            if (r < 0 || response.type != NATPMP_RESPTYPE_PUBLICADDRESS) {\n+                LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r);\n+            } else {\n+                const char* public_address = inet_ntoa(response.pnu.publicaddress.addr);\n+                if (public_address[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(public_address, resolved, false)) {\n+                        LogPrintf(\"NAT-PMP: public address = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed.\\n\");\n+                }\n+            }\n+        }\n+    }\n+\n+    const uint16_t port = GetListenPort();\n+    do {\n+        r = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, port, port, 3600 /*seconds*/);\n+        if (r < 0) {\n+            LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed with %d error.\\n\", r);\n+            break;\n+        }\n+\n+        do {\n+            r = readnatpmpresponseorretry(&natpmp, &response);\n+        } while (r == NATPMP_TRYAGAIN);\n+        if (r < 0 || response.type != NATPMP_RESPTYPE_TCPPORTMAPPING) {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r);\n+        } else {\n+            auto pm = response.pnu.newportmapping;\n+            if (port == pm.privateport && port == pm.mappedpublicport && pm.lifetime > 0) {\n+                LogPrintf(\"NAT-PMP: port mapping successful.\\n\");\n+            } else {\n+                LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed.\\n\");\n+            }\n+        }\n+\n+    } while (g_mapport_interrupt.sleep_for(std::chrono::minutes(20)));\n+\n+    r = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, port, port, /* remove a port mapping */ 0);\n+    if (r < 0) {\n+        LogPrintf(\"NAT-PMP: sendnewportmappingrequest(0) failed with %d error.\\n\", r);\n+    }\n+\n+    closenatpmp(&natpmp);\n+}\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+static void ThreadUpnp()\n+{\n+    std::string port = strprintf(\"%u\", GetListenPort());\n+    const char * multicastif = nullptr;\n+    const char * minissdpdpath = nullptr;\n+    struct UPNPDev * devlist = nullptr;\n+    char lanaddr[64];\n+\n+    int error = 0;\n+#if MINIUPNPC_API_VERSION < 14\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, &error);\n+#else\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, 2, &error);\n+#endif\n+\n+    struct UPNPUrls urls;\n+    struct IGDdatas data;\n+    int r;\n+\n+    r = UPNP_GetValidIGD(devlist, &urls, &data, lanaddr, sizeof(lanaddr));\n+    if (r == 1)\n+    {\n+        if (fDiscover) {\n+            char externalIPAddress[40];\n+            r = UPNP_GetExternalIPAddress(urls.controlURL, data.first.servicetype, externalIPAddress);\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"UPnP: GetExternalIPAddress() returned %d\\n\", r);\n+            } else {\n+                if (externalIPAddress[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(externalIPAddress, resolved, false)) {\n+                        LogPrintf(\"UPnP: ExternalIPAddress = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"UPnP: GetExternalIPAddress failed.\\n\");\n+                }\n+            }\n+        }\n+\n+        std::string strDesc = PACKAGE_NAME \" \" + FormatFullVersion();\n+\n+        do {\n+            r = UPNP_AddPortMapping(urls.controlURL, data.first.servicetype, port.c_str(), port.c_str(), lanaddr, strDesc.c_str(), \"TCP\", 0, \"0\");\n+\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"AddPortMapping(%s, %s, %s) failed with code %d (%s)\\n\", port, port, lanaddr, r, strupnperror(r));\n+            } else {\n+                LogPrintf(\"UPnP Port Mapping successful.\\n\");\n+            }\n+        } while (g_mapport_interrupt.sleep_for(std::chrono::minutes(20)));\n+\n+        r = UPNP_DeletePortMapping(urls.controlURL, data.first.servicetype, port.c_str(), \"TCP\", 0);\n+        LogPrintf(\"UPNP_DeletePortMapping() returned: %d\\n\", r);\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        FreeUPNPUrls(&urls);\n+    } else {\n+        LogPrintf(\"No valid UPnP IGDs found\\n\");\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        if (r != 0)\n+            FreeUPNPUrls(&urls);\n+    }\n+}\n+#endif // #ifdef USE_UPNP\n+\n+void StartMapPort(MapPort proto)\n+{\n+    if (!g_mapport_thread.joinable()) {\n+        assert(!g_mapport_interrupt);\n+        switch (proto) {\n+        case MapPort::NAT_PMP: {\n+#ifdef USE_NATPMP\n+            g_mapport_thread = std::thread((std::bind(&TraceThread<void (*)()>, \"natpmp\", &ThreadNatpmp)));\n+#endif // #ifdef USE_NATPMP\n+            return;\n+        }\n+        case MapPort::UPNP: {\n+#ifdef USE_UPNP\n+            g_mapport_thread = std::thread((std::bind(&TraceThread<void (*)()>, \"upnp\", &ThreadUpnp)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r379913637",
      "id" : 379913637,
      "in_reply_to_id" : 378006285,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTkxMzYzNw==",
      "original_commit_id" : "c7e90ca40ad9b7c66f3429b792435e9279ceca6b",
      "original_line" : 242,
      "original_position" : 199,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : null,
      "pull_request_review_id" : 359412797,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/379913637",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r379960033"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/379960033"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Prefer to leave this alone (and use `%s` in the new options)",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-17T02:09:25Z",
      "diff_hunk" : "@@ -438,15 +439,24 @@ void SetupServerArgs()\n     gArgs.AddArg(\"-torcontrol=<ip>:<port>\", strprintf(\"Tor control port to use if onion listening enabled (default: %s)\", DEFAULT_TOR_CONTROL), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n     gArgs.AddArg(\"-torpassword=<pass>\", \"Tor control port password (default: empty)\", ArgsManager::ALLOW_ANY | ArgsManager::SENSITIVE, OptionsCategory::CONNECTION);\n     gArgs.AddArg(\"-asmap=<file>\", \"Specify asn mapping used for bucketing of the peers. Path should be relative to the -datadir path.\", ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n+#ifdef USE_NATPMP\n+#if USE_NATPMP\n+    gArgs.AddArg(\"-natpmp\", \"Use NAT-PMP to map the listening port (default: 1 when listening and no -proxy)\", ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n+#else\n+    gArgs.AddArg(\"-natpmp\", \"Use NAT-PMP to map the listening port (default: 0)\", ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n+#endif\n+#else\n+    hidden_args.emplace_back(\"-natpmp\");\n+#endif // #ifdef USE_NATPMP\n #ifdef USE_UPNP\n #if USE_UPNP\n     gArgs.AddArg(\"-upnp\", \"Use UPnP to map the listening port (default: 1 when listening and no -proxy)\", ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n #else\n-    gArgs.AddArg(\"-upnp\", strprintf(\"Use UPnP to map the listening port (default: %u)\", 0), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n+    gArgs.AddArg(\"-upnp\", \"Use UPnP to map the listening port (default: 0)\", ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r379960033",
      "id" : 379960033,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTk2MDAzMw==",
      "original_commit_id" : "dc228d6db8d2e9406d6d6e0eb04e37940b1ffb82",
      "original_line" : 455,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 359457316,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/379960033",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "The logic here still seems broken. Again, consider that users may migrate between different routers each with NAT-PMP or UPnP support. So there should be a common thread main that *at each refresh* (which ideally should trigger when network availability changes, but that can be another PR) checks for which protocol to use and does the right thing.",
      "created_at" : "2020-02-17T02:13:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-586789305",
      "id" : 586789305,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4Njc4OTMwNQ==",
      "updated_at" : "2020-02-17T02:13:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/586789305",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r380002423"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/380002423"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Agree. It will be fixed.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-17T06:25:09Z",
      "diff_hunk" : "@@ -438,15 +439,24 @@ void SetupServerArgs()\n     gArgs.AddArg(\"-torcontrol=<ip>:<port>\", strprintf(\"Tor control port to use if onion listening enabled (default: %s)\", DEFAULT_TOR_CONTROL), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n     gArgs.AddArg(\"-torpassword=<pass>\", \"Tor control port password (default: empty)\", ArgsManager::ALLOW_ANY | ArgsManager::SENSITIVE, OptionsCategory::CONNECTION);\n     gArgs.AddArg(\"-asmap=<file>\", \"Specify asn mapping used for bucketing of the peers. Path should be relative to the -datadir path.\", ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n+#ifdef USE_NATPMP\n+#if USE_NATPMP\n+    gArgs.AddArg(\"-natpmp\", \"Use NAT-PMP to map the listening port (default: 1 when listening and no -proxy)\", ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n+#else\n+    gArgs.AddArg(\"-natpmp\", \"Use NAT-PMP to map the listening port (default: 0)\", ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n+#endif\n+#else\n+    hidden_args.emplace_back(\"-natpmp\");\n+#endif // #ifdef USE_NATPMP\n #ifdef USE_UPNP\n #if USE_UPNP\n     gArgs.AddArg(\"-upnp\", \"Use UPnP to map the listening port (default: 1 when listening and no -proxy)\", ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n #else\n-    gArgs.AddArg(\"-upnp\", strprintf(\"Use UPnP to map the listening port (default: %u)\", 0), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n+    gArgs.AddArg(\"-upnp\", \"Use UPnP to map the listening port (default: 0)\", ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r380002423",
      "id" : 380002423,
      "in_reply_to_id" : 379960033,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDAwMjQyMw==",
      "original_commit_id" : "dc228d6db8d2e9406d6d6e0eb04e37940b1ffb82",
      "original_line" : 455,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 359509336,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/380002423",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@luke-jr \r\n> The logic here still seems broken. Again, consider that users may migrate between different routers each with NAT-PMP or UPnP support. So there should be a common thread main that _at each refresh_ (which ideally should trigger when network availability changes, but that can be another PR) checks for which protocol to use and does the right thing.\r\n\r\n`ThreadAnyAvailable()` does almost the same:\r\nif a used protocol becomes unavailable, `ThreadAnyAvailable()` switches to another one, no?",
      "created_at" : "2020-02-17T06:28:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-586837309",
      "id" : 586837309,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NjgzNzMwOQ==",
      "updated_at" : "2020-02-17T06:28:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/586837309",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Yes, re-reading it, you're right, it does. I saw the loops in the per-protocol functions and missed the outer one.",
      "created_at" : "2020-02-17T14:23:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-587017420",
      "id" : 587017420,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NzAxNzQyMA==",
      "updated_at" : "2020-02-17T14:23:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/587017420",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Updated dc228d6db8d2e9406d6d6e0eb04e37940b1ffb82 -> 2d5d98ce0aa07401c6771731f4e27634629f197c ([pr18077.07](https://github.com/hebasto/bitcoin/commits/pr18077.07) -> [pr18077.08](https://github.com/hebasto/bitcoin/commits/pr18077.08), [compare](https://github.com/hebasto/bitcoin/compare/pr18077.07..pr18077.08)):\r\n\r\nChanges:\r\n- addressed @luke-jr's [comment](https://github.com/bitcoin/bitcoin/pull/18077#discussion_r379960033)",
      "created_at" : "2020-02-17T16:55:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-587082936",
      "id" : 587082936,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NzA4MjkzNg==",
      "updated_at" : "2020-02-17T16:55:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/587082936",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r380289414"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/380289414"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-17T16:56:03Z",
      "diff_hunk" : "@@ -438,15 +439,24 @@ void SetupServerArgs()\n     gArgs.AddArg(\"-torcontrol=<ip>:<port>\", strprintf(\"Tor control port to use if onion listening enabled (default: %s)\", DEFAULT_TOR_CONTROL), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n     gArgs.AddArg(\"-torpassword=<pass>\", \"Tor control port password (default: empty)\", ArgsManager::ALLOW_ANY | ArgsManager::SENSITIVE, OptionsCategory::CONNECTION);\n     gArgs.AddArg(\"-asmap=<file>\", \"Specify asn mapping used for bucketing of the peers. Path should be relative to the -datadir path.\", ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n+#ifdef USE_NATPMP\n+#if USE_NATPMP\n+    gArgs.AddArg(\"-natpmp\", \"Use NAT-PMP to map the listening port (default: 1 when listening and no -proxy)\", ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n+#else\n+    gArgs.AddArg(\"-natpmp\", \"Use NAT-PMP to map the listening port (default: 0)\", ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n+#endif\n+#else\n+    hidden_args.emplace_back(\"-natpmp\");\n+#endif // #ifdef USE_NATPMP\n #ifdef USE_UPNP\n #if USE_UPNP\n     gArgs.AddArg(\"-upnp\", \"Use UPnP to map the listening port (default: 1 when listening and no -proxy)\", ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n #else\n-    gArgs.AddArg(\"-upnp\", strprintf(\"Use UPnP to map the listening port (default: %u)\", 0), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n+    gArgs.AddArg(\"-upnp\", \"Use UPnP to map the listening port (default: 0)\", ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r380289414",
      "id" : 380289414,
      "in_reply_to_id" : 379960033,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI4OTQxNA==",
      "original_commit_id" : "dc228d6db8d2e9406d6d6e0eb04e37940b1ffb82",
      "original_line" : 455,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 359871878,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/380289414",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r380352723"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/380352723"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Suggest just making this `StartMapPort(bool use_upnp, bool use_natpmp)`",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-17T20:16:34Z",
      "diff_hunk" : "@@ -1764,9 +1778,17 @@ bool AppInitMain(NodeContext& node)\n \n     Discover();\n \n-    // Map ports with UPnP\n-    if (gArgs.GetBoolArg(\"-upnp\", DEFAULT_UPNP)) {\n-        StartMapPort();\n+    // Map ports with NAT-PMP (preferable) or UPnP.\n+    {\n+        const bool natpmp = gArgs.GetBoolArg(\"-natpmp\", DEFAULT_NATPMP);\n+        const bool upnp = gArgs.GetBoolArg(\"-upnp\", DEFAULT_UPNP);\n+        if (natpmp && upnp) {\n+            StartMapPort(MapPort::ANY_AVAILABLE);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r380352723",
      "id" : 380352723,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM1MjcyMw==",
      "original_commit_id" : "2d5d98ce0aa07401c6771731f4e27634629f197c",
      "original_line" : 1786,
      "original_position" : 89,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 359949105,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/380352723",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r380352965"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/380352965"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This logic won't work if the thread is already running...",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-17T20:17:38Z",
      "diff_hunk" : "@@ -350,9 +362,13 @@ bool OptionsModel::setData(const QModelIndex & index, const QVariant & value, in\n             fMinimizeToTray = value.toBool();\n             settings.setValue(\"fMinimizeToTray\", fMinimizeToTray);\n             break;\n+        case MapPortNatpmp: // core option - can be changed on-the-fly\n+            settings.setValue(\"fUseNatpmp\", value.toBool());\n+            m_node.mapPort(value.toBool(), MapPort::NAT_PMP);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r380352965",
      "id" : 380352965,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM1Mjk2NQ==",
      "original_commit_id" : "2d5d98ce0aa07401c6771731f4e27634629f197c",
      "original_line" : 367,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/qt/optionsmodel.cpp",
      "position" : null,
      "pull_request_review_id" : 359949105,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/380352965",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r380362646"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/380362646"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`%s` > `%u`",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-17T20:54:31Z",
      "diff_hunk" : "@@ -438,6 +439,15 @@ void SetupServerArgs()\n     gArgs.AddArg(\"-torcontrol=<ip>:<port>\", strprintf(\"Tor control port to use if onion listening enabled (default: %s)\", DEFAULT_TOR_CONTROL), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n     gArgs.AddArg(\"-torpassword=<pass>\", \"Tor control port password (default: empty)\", ArgsManager::ALLOW_ANY | ArgsManager::SENSITIVE, OptionsCategory::CONNECTION);\n     gArgs.AddArg(\"-asmap=<file>\", \"Specify asn mapping used for bucketing of the peers. Path should be relative to the -datadir path.\", ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n+#ifdef USE_NATPMP\n+#if USE_NATPMP\n+    gArgs.AddArg(\"-natpmp\", \"Use NAT-PMP to map the listening port (default: 1 when listening and no -proxy)\", ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n+#else\n+    gArgs.AddArg(\"-natpmp\", strprintf(\"Use NAT-PMP to map the listening port (default: %u)\", 0), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r380362646",
      "id" : 380362646,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM2MjY0Ng==",
      "original_commit_id" : "2d5d98ce0aa07401c6771731f4e27634629f197c",
      "original_line" : 446,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 359961465,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/380362646",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r380371070"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/380371070"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Or better yet: Just check gArgs inside StartMapPort...",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-17T21:26:59Z",
      "diff_hunk" : "@@ -1764,9 +1778,17 @@ bool AppInitMain(NodeContext& node)\n \n     Discover();\n \n-    // Map ports with UPnP\n-    if (gArgs.GetBoolArg(\"-upnp\", DEFAULT_UPNP)) {\n-        StartMapPort();\n+    // Map ports with NAT-PMP (preferable) or UPnP.\n+    {\n+        const bool natpmp = gArgs.GetBoolArg(\"-natpmp\", DEFAULT_NATPMP);\n+        const bool upnp = gArgs.GetBoolArg(\"-upnp\", DEFAULT_UPNP);\n+        if (natpmp && upnp) {\n+            StartMapPort(MapPort::ANY_AVAILABLE);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r380371070",
      "id" : 380371070,
      "in_reply_to_id" : 380352723,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM3MTA3MA==",
      "original_commit_id" : "2d5d98ce0aa07401c6771731f4e27634629f197c",
      "original_line" : 1786,
      "original_position" : 89,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 359971764,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/380371070",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r380525759"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/380525759"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Going to fix it.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-18T08:42:29Z",
      "diff_hunk" : "@@ -350,9 +362,13 @@ bool OptionsModel::setData(const QModelIndex & index, const QVariant & value, in\n             fMinimizeToTray = value.toBool();\n             settings.setValue(\"fMinimizeToTray\", fMinimizeToTray);\n             break;\n+        case MapPortNatpmp: // core option - can be changed on-the-fly\n+            settings.setValue(\"fUseNatpmp\", value.toBool());\n+            m_node.mapPort(value.toBool(), MapPort::NAT_PMP);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r380525759",
      "id" : 380525759,
      "in_reply_to_id" : 380352965,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDUyNTc1OQ==",
      "original_commit_id" : "2d5d98ce0aa07401c6771731f4e27634629f197c",
      "original_line" : 367,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/qt/optionsmodel.cpp",
      "position" : null,
      "pull_request_review_id" : 360151983,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/380525759",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r380527819"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/380527819"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> `%s` > `%u`\r\n\r\nWhat is the rationale? We already use the `%u` specifier for unsigned integers in `tfm::format()`.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-18T08:46:44Z",
      "diff_hunk" : "@@ -438,6 +439,15 @@ void SetupServerArgs()\n     gArgs.AddArg(\"-torcontrol=<ip>:<port>\", strprintf(\"Tor control port to use if onion listening enabled (default: %s)\", DEFAULT_TOR_CONTROL), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n     gArgs.AddArg(\"-torpassword=<pass>\", \"Tor control port password (default: empty)\", ArgsManager::ALLOW_ANY | ArgsManager::SENSITIVE, OptionsCategory::CONNECTION);\n     gArgs.AddArg(\"-asmap=<file>\", \"Specify asn mapping used for bucketing of the peers. Path should be relative to the -datadir path.\", ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n+#ifdef USE_NATPMP\n+#if USE_NATPMP\n+    gArgs.AddArg(\"-natpmp\", \"Use NAT-PMP to map the listening port (default: 1 when listening and no -proxy)\", ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n+#else\n+    gArgs.AddArg(\"-natpmp\", strprintf(\"Use NAT-PMP to map the listening port (default: %u)\", 0), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r380527819",
      "id" : 380527819,
      "in_reply_to_id" : 380362646,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDUyNzgxOQ==",
      "original_commit_id" : "2d5d98ce0aa07401c6771731f4e27634629f197c",
      "original_line" : 446,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 360154539,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/380527819",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Updated 2d5d98ce0aa07401c6771731f4e27634629f197c -> ccb4a7ea18c38914f084b7c070303d020adad326 ([pr18077.08](https://github.com/hebasto/bitcoin/commits/pr18077.08) -> [pr18077.09](https://github.com/hebasto/bitcoin/commits/pr18077.09), [compare](https://github.com/hebasto/bitcoin/compare/pr18077.08..pr18077.09)):\r\n\r\n- fixed a [bug](https://github.com/bitcoin/bitcoin/pull/18077#discussion_r380352965) pointed by @luke-jr ",
      "created_at" : "2020-02-18T22:01:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-587924741",
      "id" : 587924741,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NzkyNDc0MQ==",
      "updated_at" : "2020-02-18T22:01:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/587924741",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r380961736"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/380961736"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed in the latest push.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-18T22:01:34Z",
      "diff_hunk" : "@@ -350,9 +362,13 @@ bool OptionsModel::setData(const QModelIndex & index, const QVariant & value, in\n             fMinimizeToTray = value.toBool();\n             settings.setValue(\"fMinimizeToTray\", fMinimizeToTray);\n             break;\n+        case MapPortNatpmp: // core option - can be changed on-the-fly\n+            settings.setValue(\"fUseNatpmp\", value.toBool());\n+            m_node.mapPort(value.toBool(), MapPort::NAT_PMP);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r380961736",
      "id" : 380961736,
      "in_reply_to_id" : 380352965,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk2MTczNg==",
      "original_commit_id" : "2d5d98ce0aa07401c6771731f4e27634629f197c",
      "original_line" : 367,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/qt/optionsmodel.cpp",
      "position" : null,
      "pull_request_review_id" : 360705700,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/380961736",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r380961933"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/380961933"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Reworked in the latest push.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-18T22:01:57Z",
      "diff_hunk" : "@@ -1764,9 +1778,17 @@ bool AppInitMain(NodeContext& node)\n \n     Discover();\n \n-    // Map ports with UPnP\n-    if (gArgs.GetBoolArg(\"-upnp\", DEFAULT_UPNP)) {\n-        StartMapPort();\n+    // Map ports with NAT-PMP (preferable) or UPnP.\n+    {\n+        const bool natpmp = gArgs.GetBoolArg(\"-natpmp\", DEFAULT_NATPMP);\n+        const bool upnp = gArgs.GetBoolArg(\"-upnp\", DEFAULT_UPNP);\n+        if (natpmp && upnp) {\n+            StartMapPort(MapPort::ANY_AVAILABLE);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r380961933",
      "id" : 380961933,
      "in_reply_to_id" : 380352723,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk2MTkzMw==",
      "original_commit_id" : "2d5d98ce0aa07401c6771731f4e27634629f197c",
      "original_line" : 1786,
      "original_position" : 89,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 360705933,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/380961933",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Hi all, did some testing on ccb4a7ea18c38914f084b7c070303d020adad326. What I did:\r\n\r\n1. Installed natpmpd on my OpenBSD gateway router\r\n2. Started `natpmpd`, added relevant `pf.conf` line, reloaded `pf`\r\n3. Configure and compile `bitcoind` with `--without-miniupnpc --disable-bench --disable-wallet --without-gui --with-natpmp`\r\n4. Start `bitcoind` with `-natpmp`\r\n5. Saw the following lines:\r\n```\r\n2020-02-18T22:26:26Z NAT-PMP: Public address = 108.21.84.253\r\n2020-02-18T22:26:26Z AddLocal(108.21.84.253:8333,3)\r\n2020-02-18T22:26:26Z NAT-PMP: Port mapping failed.\r\n2020-02-18T22:26:26Z NAT-PMP: Port mapping removed successfully.\r\n```\r\n6. Checked my `natpmpd` anchored `pfctl` rules:\r\n```\r\n$ doas pfctl -a natpmpd -s rules\r\npass in quick on rdomain 0 inet proto tcp from any to <my-egress-ip> port = 62774 flags any rdr-to 192.168.0.5 port 8333\r\n```\r\n\r\nI believe this means that natpmpd successfully allocated a port 62774 to `bitcoind`, but since that port does not equal our private port, this check failed: https://github.com/bitcoin/bitcoin/pull/18077/files#diff-161ad6a962291e0bbafeb83ddc8a977cR109. I believe this is because `natpmpd` ignores our \"Suggested External Port\", which is perfectly valid, and we should probably account for that possibility. ",
      "created_at" : "2020-02-18T23:11:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-587950934",
      "id" : 587950934,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4Nzk1MDkzNA==",
      "updated_at" : "2020-02-19T01:55:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/587950934",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r381008856"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/381008856"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`%s` doesn't care what type the value is.\r\n\r\nYou can use the same format string above, with a value of `\"1 when listening and no -proxy\"`",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-19T00:08:21Z",
      "diff_hunk" : "@@ -438,6 +439,15 @@ void SetupServerArgs()\n     gArgs.AddArg(\"-torcontrol=<ip>:<port>\", strprintf(\"Tor control port to use if onion listening enabled (default: %s)\", DEFAULT_TOR_CONTROL), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n     gArgs.AddArg(\"-torpassword=<pass>\", \"Tor control port password (default: empty)\", ArgsManager::ALLOW_ANY | ArgsManager::SENSITIVE, OptionsCategory::CONNECTION);\n     gArgs.AddArg(\"-asmap=<file>\", \"Specify asn mapping used for bucketing of the peers. Path should be relative to the -datadir path.\", ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n+#ifdef USE_NATPMP\n+#if USE_NATPMP\n+    gArgs.AddArg(\"-natpmp\", \"Use NAT-PMP to map the listening port (default: 1 when listening and no -proxy)\", ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n+#else\n+    gArgs.AddArg(\"-natpmp\", strprintf(\"Use NAT-PMP to map the listening port (default: %u)\", 0), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r381008856",
      "id" : 381008856,
      "in_reply_to_id" : 380362646,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAwODg1Ng==",
      "original_commit_id" : "2d5d98ce0aa07401c6771731f4e27634629f197c",
      "original_line" : 446,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 360762594,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/381008856",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "If NAT-PMP allows ignoring the suggested port, then we probably should handle that by advertising the correct port for the external IP in addrman.",
      "created_at" : "2020-02-19T00:19:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-587970728",
      "id" : 587970728,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4Nzk3MDcyOA==",
      "updated_at" : "2020-02-19T00:19:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/587970728",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@dongcarl \r\nThank you for testing this PR with [`natpmpd`](https://github.com/bodgit/natpmpd) on OpenBSD (I've tested with [`miniupnpd`](https://github.com/miniupnp/miniupnp/tree/master/miniupnpd) on OpenWrt).\r\n\r\n> I believe this is because `natpmpd` ignores our \"Suggested External Port\", which is perfectly valid, and we should probably account for that possibility.\r\n\r\nCorrect. From `natpmpd` [docs](http://bodgitandscarper.co.uk/natpmpd/):\r\n> The external TCP or UDP port assigned to the client is _always_ randomised rather than giving the first client the port it actually requested and then trying to work out what to do for additional clients that want the same external port.\r\n\r\n(highlighted in italics by me).\r\n\r\nOTOH, [RFC 6886](https://tools.ietf.org/html/rfc6886) states:\r\n> If the client would prefer to have a high-numbered \"anonymous\" external port assigned, then it should set the Suggested External Port to zero, which indicates to the gateway that it should allocate a high-numbered port of its choosing.  If the client would prefer instead to have the mapped external port be the same as its local internal port if possible (e.g., a web server listening on port 80 that would ideally like to have external port 80), then it should set the Suggested External Port to the desired value.  However, the gateway is _not_ obliged to assign the port suggested, and may choose not to, either for policy reasons (e.g., port 80 is reserved and clients may not request it) or because that port has already been assigned to some other client.\r\n\r\n(highlighted in italics by me).\r\n\r\n@luke-jr \r\n> If NAT-PMP allows ignoring the suggested port, then we probably should handle that by advertising the correct port for the external IP in addrman.\r\n\r\nSure, we should.",
      "created_at" : "2020-02-19T09:29:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-588121365",
      "id" : 588121365,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4ODEyMTM2NQ==",
      "updated_at" : "2020-02-19T09:29:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/588121365",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Updated ccb4a7ea18c38914f084b7c070303d020adad326 -> 03e2733be1772ef69caf34e84c7b400f64a8ea9f ([pr18077.09](https://github.com/hebasto/bitcoin/commits/pr18077.09) -> [pr18077.10](https://github.com/hebasto/bitcoin/commits/pr18077.10), [compare](https://github.com/hebasto/bitcoin/compare/pr18077.09..pr18077.10)):\r\n\r\n- aligned with RFC 6886\r\n\r\n@dongcarl @luke-jr \r\nThank you for your reviews. All your comments have been addressed.",
      "created_at" : "2020-02-19T20:05:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-588422681",
      "id" : 588422681,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4ODQyMjY4MQ==",
      "updated_at" : "2020-02-19T20:05:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/588422681",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r381514731"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/381514731"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done in the latest push.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-19T20:05:53Z",
      "diff_hunk" : "@@ -438,6 +439,15 @@ void SetupServerArgs()\n     gArgs.AddArg(\"-torcontrol=<ip>:<port>\", strprintf(\"Tor control port to use if onion listening enabled (default: %s)\", DEFAULT_TOR_CONTROL), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n     gArgs.AddArg(\"-torpassword=<pass>\", \"Tor control port password (default: empty)\", ArgsManager::ALLOW_ANY | ArgsManager::SENSITIVE, OptionsCategory::CONNECTION);\n     gArgs.AddArg(\"-asmap=<file>\", \"Specify asn mapping used for bucketing of the peers. Path should be relative to the -datadir path.\", ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n+#ifdef USE_NATPMP\n+#if USE_NATPMP\n+    gArgs.AddArg(\"-natpmp\", \"Use NAT-PMP to map the listening port (default: 1 when listening and no -proxy)\", ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n+#else\n+    gArgs.AddArg(\"-natpmp\", strprintf(\"Use NAT-PMP to map the listening port (default: %u)\", 0), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r381514731",
      "id" : 381514731,
      "in_reply_to_id" : 380362646,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTUxNDczMQ==",
      "original_commit_id" : "2d5d98ce0aa07401c6771731f4e27634629f197c",
      "original_line" : 446,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 361399235,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/381514731",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r381553831"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/381553831"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This logic breaks the \"command line overrides GUI options\" stuff above (see `addOverriddenOption`)...\r\n\r\nNot really sure what the best solution here is.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-19T21:26:25Z",
      "diff_hunk" : "@@ -344,15 +356,19 @@ bool OptionsModel::setData(const QModelIndex & index, const QVariant & value, in\n         case HideTrayIcon:\n             fHideTrayIcon = value.toBool();\n             settings.setValue(\"fHideTrayIcon\", fHideTrayIcon);\n-    \t\tQ_EMIT hideTrayIconChanged(fHideTrayIcon);\n+            Q_EMIT hideTrayIconChanged(fHideTrayIcon);\n             break;\n         case MinimizeToTray:\n             fMinimizeToTray = value.toBool();\n             settings.setValue(\"fMinimizeToTray\", fMinimizeToTray);\n             break;\n+        case MapPortNatpmp: // core option - can be changed on-the-fly\n+            settings.setValue(\"fUseNatpmp\", value.toBool());\n+            m_node.mapPort(value.toBool(), settings.value(\"fUseUPnP\").toBool());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r381553831",
      "id" : 381553831,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU1MzgzMQ==",
      "original_commit_id" : "03e2733be1772ef69caf34e84c7b400f64a8ea9f",
      "original_line" : 367,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/qt/optionsmodel.cpp",
      "position" : null,
      "pull_request_review_id" : 361448941,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/381553831",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r381557545"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/381557545"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This won't work if we used to have both protocols enabled, are currently using UPnP, but want to disable UPnP.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-19T21:33:54Z",
      "diff_hunk" : "@@ -0,0 +1,320 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <netinet/in.h>\n+#endif // #ifdef WIN32\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif // #ifdef USE_UPNP\n+\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_mapport_interrupt;\n+static std::thread g_mapport_thread;\n+static MapPortProto g_mapport_current_proto = MapPortProto::NONE;\n+static unsigned int g_mapport_target_proto = g_mapport_current_proto;\n+static uint16_t g_mapport_external_port = 0;\n+static constexpr auto PORT_MAPPING_REANNOUNCE_PERIOD = std::chrono::minutes(20);\n+static constexpr auto PORT_MAPPING_RETRY_PERIOD = std::chrono::minutes(5);\n+\n+#ifdef USE_NATPMP\n+static bool NatpmpInit(natpmp_t* natpmp)\n+{\n+    const int r_init = initnatpmp(natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r_init == 0) return true;\n+    LogPrintf(\"NAT-PMP: initnatpmp() failed with %d error.\\n\", r_init);\n+    return false;\n+}\n+\n+static bool NatpmpDiscover(natpmp_t* natpmp, struct in_addr& external_ipv4_addr)\n+{\n+    const int r_send = sendpublicaddressrequest(natpmp);\n+    if (r_send == 2 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            external_ipv4_addr = response.pnu.publicaddress.addr;\n+            return true;\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"NAT-PMP: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool NatpmpMapping(natpmp_t* natpmp, const struct in_addr& external_ipv4_addr, uint16_t private_port, bool& external_ip_discovered)\n+{\n+    const uint16_t suggested_external_port = g_mapport_external_port ? g_mapport_external_port : private_port;\n+    const int r_send = sendnewportmappingrequest(natpmp, NATPMP_PROTOCOL_TCP, private_port, suggested_external_port, 3600 /*seconds*/);\n+    if (r_send == 12 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            auto pm = response.pnu.newportmapping;\n+            if (private_port == pm.privateport && pm.lifetime > 0) {\n+                g_mapport_current_proto = MapPortProto::NAT_PMP;\n+                g_mapport_external_port = pm.mappedpublicport;\n+                const CService external{external_ipv4_addr, pm.mappedpublicport};\n+                if (!external_ip_discovered && fDiscover) {\n+                    AddLocal(external, LOCAL_MAPPED);\n+                    external_ip_discovered = true;\n+                }\n+\n+                LogPrintf(\"NAT-PMP: Port mapping successful. External address = %s\\n\", external.ToString());\n+                return true;\n+            } else {\n+                LogPrintf(\"NAT-PMP: Port mapping failed.\\n\");\n+            }\n+\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"NAT-PMP: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool ThreadNatpmp()\n+{\n+    bool ret = false;\n+    natpmp_t natpmp;\n+    struct in_addr external_ipv4_addr;\n+    if (NatpmpInit(&natpmp) && NatpmpDiscover(&natpmp, external_ipv4_addr)) {\n+        bool external_ip_discovered = false;\n+        const uint16_t private_port = GetListenPort();\n+        do {\n+            ret = NatpmpMapping(&natpmp, external_ipv4_addr, private_port, external_ip_discovered);\n+        } while (ret && g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+\n+        const int r_send = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, private_port, g_mapport_external_port, /* remove a port mapping */ 0);\n+        g_mapport_external_port = 0;\n+        if (r_send == 12 /* OK */) {\n+            LogPrintf(\"NAT-PMP: Port mapping removed successfully.\\n\");\n+        } else {\n+            LogPrintf(\"NAT-PMP: sendnewportmappingrequest(0) failed with %d error.\\n\", r_send);\n+        }\n+    }\n+\n+    closenatpmp(&natpmp);\n+    return ret;\n+}\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+static bool ThreadUpnp()\n+{\n+    bool ret = false;\n+    std::string port = strprintf(\"%u\", GetListenPort());\n+    const char * multicastif = nullptr;\n+    const char * minissdpdpath = nullptr;\n+    struct UPNPDev * devlist = nullptr;\n+    char lanaddr[64];\n+\n+    int error = 0;\n+#if MINIUPNPC_API_VERSION < 14\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, &error);\n+#else\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, 2, &error);\n+#endif\n+\n+    struct UPNPUrls urls;\n+    struct IGDdatas data;\n+    int r;\n+\n+    r = UPNP_GetValidIGD(devlist, &urls, &data, lanaddr, sizeof(lanaddr));\n+    if (r == 1)\n+    {\n+        if (fDiscover) {\n+            char externalIPAddress[40];\n+            r = UPNP_GetExternalIPAddress(urls.controlURL, data.first.servicetype, externalIPAddress);\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"UPnP: GetExternalIPAddress() returned %d\\n\", r);\n+            } else {\n+                if (externalIPAddress[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(externalIPAddress, resolved, false)) {\n+                        LogPrintf(\"UPnP: ExternalIPAddress = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"UPnP: GetExternalIPAddress failed.\\n\");\n+                }\n+            }\n+        }\n+\n+        std::string strDesc = PACKAGE_NAME \" \" + FormatFullVersion();\n+\n+        do {\n+            r = UPNP_AddPortMapping(urls.controlURL, data.first.servicetype, port.c_str(), port.c_str(), lanaddr, strDesc.c_str(), \"TCP\", 0, \"0\");\n+\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                ret = false;\n+                LogPrintf(\"AddPortMapping(%s, %s, %s) failed with code %d (%s)\\n\", port, port, lanaddr, r, strupnperror(r));\n+                break;\n+            } else {\n+                ret = true;\n+                g_mapport_current_proto = MapPortProto::UPNP;\n+                LogPrintf(\"UPnP Port Mapping successful.\\n\");\n+            }\n+        } while (g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+\n+        r = UPNP_DeletePortMapping(urls.controlURL, data.first.servicetype, port.c_str(), \"TCP\", 0);\n+        LogPrintf(\"UPNP_DeletePortMapping() returned: %d\\n\", r);\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        FreeUPNPUrls(&urls);\n+    } else {\n+        LogPrintf(\"No valid UPnP IGDs found\\n\");\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        if (r != 0)\n+            FreeUPNPUrls(&urls);\n+    }\n+\n+    return ret;\n+}\n+#endif // #ifdef USE_UPNP\n+\n+static void ThreadMapPort()\n+{\n+    bool ok;\n+    do {\n+        ok = false;\n+\n+#ifdef USE_NATPMP\n+        if (g_mapport_target_proto & MapPortProto::NAT_PMP) {\n+            ok = ThreadNatpmp();\n+            if (ok) continue;\n+        }\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+        if (g_mapport_target_proto & MapPortProto::UPNP) {\n+            ok = ThreadUpnp();\n+            if (ok) continue;\n+        }\n+#endif // #ifdef USE_UPNP\n+\n+        if (g_mapport_target_proto == MapPortProto::NONE) {\n+            g_mapport_current_proto = MapPortProto::NONE;\n+            return;\n+        }\n+\n+    } while (ok || g_mapport_interrupt.sleep_for(PORT_MAPPING_RETRY_PERIOD));\n+}\n+\n+void StartMapPort(bool use_natpmp, bool use_upnp)\n+{\n+    if (use_natpmp) {\n+        g_mapport_target_proto |= MapPortProto::NAT_PMP;\n+    } else {\n+        g_mapport_target_proto &= ~MapPortProto::NAT_PMP;\n+    }\n+\n+    if (use_upnp) {\n+        g_mapport_target_proto |= MapPortProto::UPNP;\n+    } else {\n+        g_mapport_target_proto &= ~MapPortProto::UPNP;\n+    }\n+\n+    if (g_mapport_current_proto == MapPortProto::NONE) {\n+        if (g_mapport_target_proto == MapPortProto::NONE) {\n+            return;\n+        }\n+    } else if (g_mapport_target_proto & g_mapport_current_proto) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r381557545",
      "id" : 381557545,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU1NzU0NQ==",
      "original_commit_id" : "03e2733be1772ef69caf34e84c7b400f64a8ea9f",
      "original_line" : 275,
      "original_position" : 273,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : null,
      "pull_request_review_id" : 361453595,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/381557545",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r381558152"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/381558152"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Won't this cause the thread to shut down?",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-19T21:35:05Z",
      "diff_hunk" : "@@ -0,0 +1,320 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <netinet/in.h>\n+#endif // #ifdef WIN32\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif // #ifdef USE_UPNP\n+\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_mapport_interrupt;\n+static std::thread g_mapport_thread;\n+static MapPortProto g_mapport_current_proto = MapPortProto::NONE;\n+static unsigned int g_mapport_target_proto = g_mapport_current_proto;\n+static uint16_t g_mapport_external_port = 0;\n+static constexpr auto PORT_MAPPING_REANNOUNCE_PERIOD = std::chrono::minutes(20);\n+static constexpr auto PORT_MAPPING_RETRY_PERIOD = std::chrono::minutes(5);\n+\n+#ifdef USE_NATPMP\n+static bool NatpmpInit(natpmp_t* natpmp)\n+{\n+    const int r_init = initnatpmp(natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r_init == 0) return true;\n+    LogPrintf(\"NAT-PMP: initnatpmp() failed with %d error.\\n\", r_init);\n+    return false;\n+}\n+\n+static bool NatpmpDiscover(natpmp_t* natpmp, struct in_addr& external_ipv4_addr)\n+{\n+    const int r_send = sendpublicaddressrequest(natpmp);\n+    if (r_send == 2 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            external_ipv4_addr = response.pnu.publicaddress.addr;\n+            return true;\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"NAT-PMP: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool NatpmpMapping(natpmp_t* natpmp, const struct in_addr& external_ipv4_addr, uint16_t private_port, bool& external_ip_discovered)\n+{\n+    const uint16_t suggested_external_port = g_mapport_external_port ? g_mapport_external_port : private_port;\n+    const int r_send = sendnewportmappingrequest(natpmp, NATPMP_PROTOCOL_TCP, private_port, suggested_external_port, 3600 /*seconds*/);\n+    if (r_send == 12 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            auto pm = response.pnu.newportmapping;\n+            if (private_port == pm.privateport && pm.lifetime > 0) {\n+                g_mapport_current_proto = MapPortProto::NAT_PMP;\n+                g_mapport_external_port = pm.mappedpublicport;\n+                const CService external{external_ipv4_addr, pm.mappedpublicport};\n+                if (!external_ip_discovered && fDiscover) {\n+                    AddLocal(external, LOCAL_MAPPED);\n+                    external_ip_discovered = true;\n+                }\n+\n+                LogPrintf(\"NAT-PMP: Port mapping successful. External address = %s\\n\", external.ToString());\n+                return true;\n+            } else {\n+                LogPrintf(\"NAT-PMP: Port mapping failed.\\n\");\n+            }\n+\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"NAT-PMP: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool ThreadNatpmp()\n+{\n+    bool ret = false;\n+    natpmp_t natpmp;\n+    struct in_addr external_ipv4_addr;\n+    if (NatpmpInit(&natpmp) && NatpmpDiscover(&natpmp, external_ipv4_addr)) {\n+        bool external_ip_discovered = false;\n+        const uint16_t private_port = GetListenPort();\n+        do {\n+            ret = NatpmpMapping(&natpmp, external_ipv4_addr, private_port, external_ip_discovered);\n+        } while (ret && g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+\n+        const int r_send = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, private_port, g_mapport_external_port, /* remove a port mapping */ 0);\n+        g_mapport_external_port = 0;\n+        if (r_send == 12 /* OK */) {\n+            LogPrintf(\"NAT-PMP: Port mapping removed successfully.\\n\");\n+        } else {\n+            LogPrintf(\"NAT-PMP: sendnewportmappingrequest(0) failed with %d error.\\n\", r_send);\n+        }\n+    }\n+\n+    closenatpmp(&natpmp);\n+    return ret;\n+}\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+static bool ThreadUpnp()\n+{\n+    bool ret = false;\n+    std::string port = strprintf(\"%u\", GetListenPort());\n+    const char * multicastif = nullptr;\n+    const char * minissdpdpath = nullptr;\n+    struct UPNPDev * devlist = nullptr;\n+    char lanaddr[64];\n+\n+    int error = 0;\n+#if MINIUPNPC_API_VERSION < 14\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, &error);\n+#else\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, 2, &error);\n+#endif\n+\n+    struct UPNPUrls urls;\n+    struct IGDdatas data;\n+    int r;\n+\n+    r = UPNP_GetValidIGD(devlist, &urls, &data, lanaddr, sizeof(lanaddr));\n+    if (r == 1)\n+    {\n+        if (fDiscover) {\n+            char externalIPAddress[40];\n+            r = UPNP_GetExternalIPAddress(urls.controlURL, data.first.servicetype, externalIPAddress);\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"UPnP: GetExternalIPAddress() returned %d\\n\", r);\n+            } else {\n+                if (externalIPAddress[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(externalIPAddress, resolved, false)) {\n+                        LogPrintf(\"UPnP: ExternalIPAddress = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"UPnP: GetExternalIPAddress failed.\\n\");\n+                }\n+            }\n+        }\n+\n+        std::string strDesc = PACKAGE_NAME \" \" + FormatFullVersion();\n+\n+        do {\n+            r = UPNP_AddPortMapping(urls.controlURL, data.first.servicetype, port.c_str(), port.c_str(), lanaddr, strDesc.c_str(), \"TCP\", 0, \"0\");\n+\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                ret = false;\n+                LogPrintf(\"AddPortMapping(%s, %s, %s) failed with code %d (%s)\\n\", port, port, lanaddr, r, strupnperror(r));\n+                break;\n+            } else {\n+                ret = true;\n+                g_mapport_current_proto = MapPortProto::UPNP;\n+                LogPrintf(\"UPnP Port Mapping successful.\\n\");\n+            }\n+        } while (g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+\n+        r = UPNP_DeletePortMapping(urls.controlURL, data.first.servicetype, port.c_str(), \"TCP\", 0);\n+        LogPrintf(\"UPNP_DeletePortMapping() returned: %d\\n\", r);\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        FreeUPNPUrls(&urls);\n+    } else {\n+        LogPrintf(\"No valid UPnP IGDs found\\n\");\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        if (r != 0)\n+            FreeUPNPUrls(&urls);\n+    }\n+\n+    return ret;\n+}\n+#endif // #ifdef USE_UPNP\n+\n+static void ThreadMapPort()\n+{\n+    bool ok;\n+    do {\n+        ok = false;\n+\n+#ifdef USE_NATPMP\n+        if (g_mapport_target_proto & MapPortProto::NAT_PMP) {\n+            ok = ThreadNatpmp();\n+            if (ok) continue;\n+        }\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+        if (g_mapport_target_proto & MapPortProto::UPNP) {\n+            ok = ThreadUpnp();\n+            if (ok) continue;\n+        }\n+#endif // #ifdef USE_UPNP\n+\n+        if (g_mapport_target_proto == MapPortProto::NONE) {\n+            g_mapport_current_proto = MapPortProto::NONE;\n+            return;\n+        }\n+\n+    } while (ok || g_mapport_interrupt.sleep_for(PORT_MAPPING_RETRY_PERIOD));\n+}\n+\n+void StartMapPort(bool use_natpmp, bool use_upnp)\n+{\n+    if (use_natpmp) {\n+        g_mapport_target_proto |= MapPortProto::NAT_PMP;\n+    } else {\n+        g_mapport_target_proto &= ~MapPortProto::NAT_PMP;\n+    }\n+\n+    if (use_upnp) {\n+        g_mapport_target_proto |= MapPortProto::UPNP;\n+    } else {\n+        g_mapport_target_proto &= ~MapPortProto::UPNP;\n+    }\n+\n+    if (g_mapport_current_proto == MapPortProto::NONE) {\n+        if (g_mapport_target_proto == MapPortProto::NONE) {\n+            return;\n+        }\n+    } else if (g_mapport_target_proto & g_mapport_current_proto) {\n+        return;\n+    }\n+\n+    if (g_mapport_target_proto == MapPortProto::NONE) {\n+        InterruptMapPort();\n+        StopMapPort();\n+        return;\n+    }\n+\n+    if (g_mapport_thread.joinable()) {\n+        g_mapport_interrupt();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r381558152",
      "id" : 381558152,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU1ODE1Mg==",
      "original_commit_id" : "03e2733be1772ef69caf34e84c7b400f64a8ea9f",
      "original_line" : 286,
      "original_position" : 284,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : null,
      "pull_request_review_id" : 361454311,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/381558152",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r381558659"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/381558659"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't see the logic here to handle being assigned a different port number.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-19T21:36:08Z",
      "diff_hunk" : "@@ -0,0 +1,320 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <netinet/in.h>\n+#endif // #ifdef WIN32\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif // #ifdef USE_UPNP\n+\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_mapport_interrupt;\n+static std::thread g_mapport_thread;\n+static MapPortProto g_mapport_current_proto = MapPortProto::NONE;\n+static unsigned int g_mapport_target_proto = g_mapport_current_proto;\n+static uint16_t g_mapport_external_port = 0;\n+static constexpr auto PORT_MAPPING_REANNOUNCE_PERIOD = std::chrono::minutes(20);\n+static constexpr auto PORT_MAPPING_RETRY_PERIOD = std::chrono::minutes(5);\n+\n+#ifdef USE_NATPMP\n+static bool NatpmpInit(natpmp_t* natpmp)\n+{\n+    const int r_init = initnatpmp(natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r_init == 0) return true;\n+    LogPrintf(\"NAT-PMP: initnatpmp() failed with %d error.\\n\", r_init);\n+    return false;\n+}\n+\n+static bool NatpmpDiscover(natpmp_t* natpmp, struct in_addr& external_ipv4_addr)\n+{\n+    const int r_send = sendpublicaddressrequest(natpmp);\n+    if (r_send == 2 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            external_ipv4_addr = response.pnu.publicaddress.addr;\n+            return true;\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"NAT-PMP: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool NatpmpMapping(natpmp_t* natpmp, const struct in_addr& external_ipv4_addr, uint16_t private_port, bool& external_ip_discovered)\n+{\n+    const uint16_t suggested_external_port = g_mapport_external_port ? g_mapport_external_port : private_port;\n+    const int r_send = sendnewportmappingrequest(natpmp, NATPMP_PROTOCOL_TCP, private_port, suggested_external_port, 3600 /*seconds*/);\n+    if (r_send == 12 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            auto pm = response.pnu.newportmapping;\n+            if (private_port == pm.privateport && pm.lifetime > 0) {\n+                g_mapport_current_proto = MapPortProto::NAT_PMP;\n+                g_mapport_external_port = pm.mappedpublicport;\n+                const CService external{external_ipv4_addr, pm.mappedpublicport};\n+                if (!external_ip_discovered && fDiscover) {\n+                    AddLocal(external, LOCAL_MAPPED);\n+                    external_ip_discovered = true;\n+                }\n+\n+                LogPrintf(\"NAT-PMP: Port mapping successful. External address = %s\\n\", external.ToString());\n+                return true;\n+            } else {\n+                LogPrintf(\"NAT-PMP: Port mapping failed.\\n\");\n+            }\n+\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"NAT-PMP: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool ThreadNatpmp()\n+{\n+    bool ret = false;\n+    natpmp_t natpmp;\n+    struct in_addr external_ipv4_addr;\n+    if (NatpmpInit(&natpmp) && NatpmpDiscover(&natpmp, external_ipv4_addr)) {\n+        bool external_ip_discovered = false;\n+        const uint16_t private_port = GetListenPort();\n+        do {\n+            ret = NatpmpMapping(&natpmp, external_ipv4_addr, private_port, external_ip_discovered);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r381558659",
      "id" : 381558659,
      "line" : 131,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU1ODY1OQ==",
      "original_commit_id" : "03e2733be1772ef69caf34e84c7b400f64a8ea9f",
      "original_line" : 131,
      "original_position" : 137,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : 131,
      "pull_request_review_id" : 361454958,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/381558659",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I suggest putting the variable renames in a separate commit for easier review.\r\n\r\nAlso, since NAT-PMP apparently maps random ports often, I think we should prefer UPnP...",
      "created_at" : "2020-02-19T21:37:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-588484002",
      "id" : 588484002,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4ODQ4NDAwMg==",
      "updated_at" : "2020-02-19T21:37:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/588484002",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r381830792"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/381830792"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The logic to handle being assigned a different external port number by the gateway uses the `g_mapport_external_port` variable.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-20T07:49:34Z",
      "diff_hunk" : "@@ -0,0 +1,320 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <netinet/in.h>\n+#endif // #ifdef WIN32\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif // #ifdef USE_UPNP\n+\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_mapport_interrupt;\n+static std::thread g_mapport_thread;\n+static MapPortProto g_mapport_current_proto = MapPortProto::NONE;\n+static unsigned int g_mapport_target_proto = g_mapport_current_proto;\n+static uint16_t g_mapport_external_port = 0;\n+static constexpr auto PORT_MAPPING_REANNOUNCE_PERIOD = std::chrono::minutes(20);\n+static constexpr auto PORT_MAPPING_RETRY_PERIOD = std::chrono::minutes(5);\n+\n+#ifdef USE_NATPMP\n+static bool NatpmpInit(natpmp_t* natpmp)\n+{\n+    const int r_init = initnatpmp(natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r_init == 0) return true;\n+    LogPrintf(\"NAT-PMP: initnatpmp() failed with %d error.\\n\", r_init);\n+    return false;\n+}\n+\n+static bool NatpmpDiscover(natpmp_t* natpmp, struct in_addr& external_ipv4_addr)\n+{\n+    const int r_send = sendpublicaddressrequest(natpmp);\n+    if (r_send == 2 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            external_ipv4_addr = response.pnu.publicaddress.addr;\n+            return true;\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"NAT-PMP: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool NatpmpMapping(natpmp_t* natpmp, const struct in_addr& external_ipv4_addr, uint16_t private_port, bool& external_ip_discovered)\n+{\n+    const uint16_t suggested_external_port = g_mapport_external_port ? g_mapport_external_port : private_port;\n+    const int r_send = sendnewportmappingrequest(natpmp, NATPMP_PROTOCOL_TCP, private_port, suggested_external_port, 3600 /*seconds*/);\n+    if (r_send == 12 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            auto pm = response.pnu.newportmapping;\n+            if (private_port == pm.privateport && pm.lifetime > 0) {\n+                g_mapport_current_proto = MapPortProto::NAT_PMP;\n+                g_mapport_external_port = pm.mappedpublicport;\n+                const CService external{external_ipv4_addr, pm.mappedpublicport};\n+                if (!external_ip_discovered && fDiscover) {\n+                    AddLocal(external, LOCAL_MAPPED);\n+                    external_ip_discovered = true;\n+                }\n+\n+                LogPrintf(\"NAT-PMP: Port mapping successful. External address = %s\\n\", external.ToString());\n+                return true;\n+            } else {\n+                LogPrintf(\"NAT-PMP: Port mapping failed.\\n\");\n+            }\n+\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"NAT-PMP: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool ThreadNatpmp()\n+{\n+    bool ret = false;\n+    natpmp_t natpmp;\n+    struct in_addr external_ipv4_addr;\n+    if (NatpmpInit(&natpmp) && NatpmpDiscover(&natpmp, external_ipv4_addr)) {\n+        bool external_ip_discovered = false;\n+        const uint16_t private_port = GetListenPort();\n+        do {\n+            ret = NatpmpMapping(&natpmp, external_ipv4_addr, private_port, external_ip_discovered);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r381830792",
      "id" : 381830792,
      "in_reply_to_id" : 381558659,
      "line" : 131,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTgzMDc5Mg==",
      "original_commit_id" : "03e2733be1772ef69caf34e84c7b400f64a8ea9f",
      "original_line" : 131,
      "original_position" : 137,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : 131,
      "pull_request_review_id" : 361688719,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/381830792",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@luke-jr \r\n> I suggest putting the variable renames in a separate commit for easier review.\r\n\r\nThere is a dedicated commit \"refactor: Rename UPnP stuff\" (a2de373a96dc1b9f5374eb70d605dcaf49f9b244).\r\nWhat variable rename did I miss to put it to?",
      "created_at" : "2020-02-20T07:56:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-588713300",
      "id" : 588713300,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4ODcxMzMwMA==",
      "updated_at" : "2020-02-20T07:56:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/588713300",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r381908006"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/381908006"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The separate issue #18184 has been submitted.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-20T10:21:34Z",
      "diff_hunk" : "@@ -344,15 +356,19 @@ bool OptionsModel::setData(const QModelIndex & index, const QVariant & value, in\n         case HideTrayIcon:\n             fHideTrayIcon = value.toBool();\n             settings.setValue(\"fHideTrayIcon\", fHideTrayIcon);\n-    \t\tQ_EMIT hideTrayIconChanged(fHideTrayIcon);\n+            Q_EMIT hideTrayIconChanged(fHideTrayIcon);\n             break;\n         case MinimizeToTray:\n             fMinimizeToTray = value.toBool();\n             settings.setValue(\"fMinimizeToTray\", fMinimizeToTray);\n             break;\n+        case MapPortNatpmp: // core option - can be changed on-the-fly\n+            settings.setValue(\"fUseNatpmp\", value.toBool());\n+            m_node.mapPort(value.toBool(), settings.value(\"fUseUPnP\").toBool());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r381908006",
      "id" : 381908006,
      "in_reply_to_id" : 381553831,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTkwODAwNg==",
      "original_commit_id" : "03e2733be1772ef69caf34e84c7b400f64a8ea9f",
      "original_line" : 367,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/qt/optionsmodel.cpp",
      "position" : null,
      "pull_request_review_id" : 361785165,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/381908006",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Updated 03e2733be1772ef69caf34e84c7b400f64a8ea9f -> dd3229e7af8563c69d26955c4207f73ae1d3bc94 ([pr18077.10](https://github.com/hebasto/bitcoin/commits/pr18077.10) -> [pr18077.11](https://github.com/hebasto/bitcoin/commits/pr18077.11), [compare](https://github.com/hebasto/bitcoin/compare/pr18077.10..pr18077.11)):\r\n\r\n- fixed CI issues\r\n- the NAT-PMP checkbox added to the GUI (this simplifies testing a lot)\r\n- fixed a [bug](https://github.com/bitcoin/bitcoin/pull/18077#discussion_r381558152) pointed by @luke-jr",
      "created_at" : "2020-02-20T23:21:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-589405068",
      "id" : 589405068,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4OTQwNTA2OA==",
      "updated_at" : "2020-02-20T23:21:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/589405068",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r382315043"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/382315043"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed in the latest [push](https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-589405068).",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-20T23:24:10Z",
      "diff_hunk" : "@@ -0,0 +1,320 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <netinet/in.h>\n+#endif // #ifdef WIN32\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif // #ifdef USE_UPNP\n+\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_mapport_interrupt;\n+static std::thread g_mapport_thread;\n+static MapPortProto g_mapport_current_proto = MapPortProto::NONE;\n+static unsigned int g_mapport_target_proto = g_mapport_current_proto;\n+static uint16_t g_mapport_external_port = 0;\n+static constexpr auto PORT_MAPPING_REANNOUNCE_PERIOD = std::chrono::minutes(20);\n+static constexpr auto PORT_MAPPING_RETRY_PERIOD = std::chrono::minutes(5);\n+\n+#ifdef USE_NATPMP\n+static bool NatpmpInit(natpmp_t* natpmp)\n+{\n+    const int r_init = initnatpmp(natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r_init == 0) return true;\n+    LogPrintf(\"NAT-PMP: initnatpmp() failed with %d error.\\n\", r_init);\n+    return false;\n+}\n+\n+static bool NatpmpDiscover(natpmp_t* natpmp, struct in_addr& external_ipv4_addr)\n+{\n+    const int r_send = sendpublicaddressrequest(natpmp);\n+    if (r_send == 2 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            external_ipv4_addr = response.pnu.publicaddress.addr;\n+            return true;\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"NAT-PMP: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool NatpmpMapping(natpmp_t* natpmp, const struct in_addr& external_ipv4_addr, uint16_t private_port, bool& external_ip_discovered)\n+{\n+    const uint16_t suggested_external_port = g_mapport_external_port ? g_mapport_external_port : private_port;\n+    const int r_send = sendnewportmappingrequest(natpmp, NATPMP_PROTOCOL_TCP, private_port, suggested_external_port, 3600 /*seconds*/);\n+    if (r_send == 12 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            auto pm = response.pnu.newportmapping;\n+            if (private_port == pm.privateport && pm.lifetime > 0) {\n+                g_mapport_current_proto = MapPortProto::NAT_PMP;\n+                g_mapport_external_port = pm.mappedpublicport;\n+                const CService external{external_ipv4_addr, pm.mappedpublicport};\n+                if (!external_ip_discovered && fDiscover) {\n+                    AddLocal(external, LOCAL_MAPPED);\n+                    external_ip_discovered = true;\n+                }\n+\n+                LogPrintf(\"NAT-PMP: Port mapping successful. External address = %s\\n\", external.ToString());\n+                return true;\n+            } else {\n+                LogPrintf(\"NAT-PMP: Port mapping failed.\\n\");\n+            }\n+\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"NAT-PMP: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool ThreadNatpmp()\n+{\n+    bool ret = false;\n+    natpmp_t natpmp;\n+    struct in_addr external_ipv4_addr;\n+    if (NatpmpInit(&natpmp) && NatpmpDiscover(&natpmp, external_ipv4_addr)) {\n+        bool external_ip_discovered = false;\n+        const uint16_t private_port = GetListenPort();\n+        do {\n+            ret = NatpmpMapping(&natpmp, external_ipv4_addr, private_port, external_ip_discovered);\n+        } while (ret && g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+\n+        const int r_send = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, private_port, g_mapport_external_port, /* remove a port mapping */ 0);\n+        g_mapport_external_port = 0;\n+        if (r_send == 12 /* OK */) {\n+            LogPrintf(\"NAT-PMP: Port mapping removed successfully.\\n\");\n+        } else {\n+            LogPrintf(\"NAT-PMP: sendnewportmappingrequest(0) failed with %d error.\\n\", r_send);\n+        }\n+    }\n+\n+    closenatpmp(&natpmp);\n+    return ret;\n+}\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+static bool ThreadUpnp()\n+{\n+    bool ret = false;\n+    std::string port = strprintf(\"%u\", GetListenPort());\n+    const char * multicastif = nullptr;\n+    const char * minissdpdpath = nullptr;\n+    struct UPNPDev * devlist = nullptr;\n+    char lanaddr[64];\n+\n+    int error = 0;\n+#if MINIUPNPC_API_VERSION < 14\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, &error);\n+#else\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, 2, &error);\n+#endif\n+\n+    struct UPNPUrls urls;\n+    struct IGDdatas data;\n+    int r;\n+\n+    r = UPNP_GetValidIGD(devlist, &urls, &data, lanaddr, sizeof(lanaddr));\n+    if (r == 1)\n+    {\n+        if (fDiscover) {\n+            char externalIPAddress[40];\n+            r = UPNP_GetExternalIPAddress(urls.controlURL, data.first.servicetype, externalIPAddress);\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"UPnP: GetExternalIPAddress() returned %d\\n\", r);\n+            } else {\n+                if (externalIPAddress[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(externalIPAddress, resolved, false)) {\n+                        LogPrintf(\"UPnP: ExternalIPAddress = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"UPnP: GetExternalIPAddress failed.\\n\");\n+                }\n+            }\n+        }\n+\n+        std::string strDesc = PACKAGE_NAME \" \" + FormatFullVersion();\n+\n+        do {\n+            r = UPNP_AddPortMapping(urls.controlURL, data.first.servicetype, port.c_str(), port.c_str(), lanaddr, strDesc.c_str(), \"TCP\", 0, \"0\");\n+\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                ret = false;\n+                LogPrintf(\"AddPortMapping(%s, %s, %s) failed with code %d (%s)\\n\", port, port, lanaddr, r, strupnperror(r));\n+                break;\n+            } else {\n+                ret = true;\n+                g_mapport_current_proto = MapPortProto::UPNP;\n+                LogPrintf(\"UPnP Port Mapping successful.\\n\");\n+            }\n+        } while (g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+\n+        r = UPNP_DeletePortMapping(urls.controlURL, data.first.servicetype, port.c_str(), \"TCP\", 0);\n+        LogPrintf(\"UPNP_DeletePortMapping() returned: %d\\n\", r);\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        FreeUPNPUrls(&urls);\n+    } else {\n+        LogPrintf(\"No valid UPnP IGDs found\\n\");\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        if (r != 0)\n+            FreeUPNPUrls(&urls);\n+    }\n+\n+    return ret;\n+}\n+#endif // #ifdef USE_UPNP\n+\n+static void ThreadMapPort()\n+{\n+    bool ok;\n+    do {\n+        ok = false;\n+\n+#ifdef USE_NATPMP\n+        if (g_mapport_target_proto & MapPortProto::NAT_PMP) {\n+            ok = ThreadNatpmp();\n+            if (ok) continue;\n+        }\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+        if (g_mapport_target_proto & MapPortProto::UPNP) {\n+            ok = ThreadUpnp();\n+            if (ok) continue;\n+        }\n+#endif // #ifdef USE_UPNP\n+\n+        if (g_mapport_target_proto == MapPortProto::NONE) {\n+            g_mapport_current_proto = MapPortProto::NONE;\n+            return;\n+        }\n+\n+    } while (ok || g_mapport_interrupt.sleep_for(PORT_MAPPING_RETRY_PERIOD));\n+}\n+\n+void StartMapPort(bool use_natpmp, bool use_upnp)\n+{\n+    if (use_natpmp) {\n+        g_mapport_target_proto |= MapPortProto::NAT_PMP;\n+    } else {\n+        g_mapport_target_proto &= ~MapPortProto::NAT_PMP;\n+    }\n+\n+    if (use_upnp) {\n+        g_mapport_target_proto |= MapPortProto::UPNP;\n+    } else {\n+        g_mapport_target_proto &= ~MapPortProto::UPNP;\n+    }\n+\n+    if (g_mapport_current_proto == MapPortProto::NONE) {\n+        if (g_mapport_target_proto == MapPortProto::NONE) {\n+            return;\n+        }\n+    } else if (g_mapport_target_proto & g_mapport_current_proto) {\n+        return;\n+    }\n+\n+    if (g_mapport_target_proto == MapPortProto::NONE) {\n+        InterruptMapPort();\n+        StopMapPort();\n+        return;\n+    }\n+\n+    if (g_mapport_thread.joinable()) {\n+        g_mapport_interrupt();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r382315043",
      "id" : 382315043,
      "in_reply_to_id" : 381558152,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMxNTA0Mw==",
      "original_commit_id" : "03e2733be1772ef69caf34e84c7b400f64a8ea9f",
      "original_line" : 286,
      "original_position" : 284,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : null,
      "pull_request_review_id" : 362306083,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/382315043",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r382316994"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/382316994"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Sure it works.\r\nThe log excerpt for the mentioned case:\r\n```\r\n2020-02-20T23:26:30Z [mapport] UPNP_DeletePortMapping() returned: 0\r\n2020-02-20T23:26:30Z [mapport] AddLocal(95.164.65.194:18333,3)\r\n2020-02-20T23:26:30Z [mapport] NAT-PMP: Port mapping successful. External address = 95.164.65.194:18333\r\n\r\n```",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-20T23:29:52Z",
      "diff_hunk" : "@@ -0,0 +1,320 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <netinet/in.h>\n+#endif // #ifdef WIN32\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif // #ifdef USE_UPNP\n+\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_mapport_interrupt;\n+static std::thread g_mapport_thread;\n+static MapPortProto g_mapport_current_proto = MapPortProto::NONE;\n+static unsigned int g_mapport_target_proto = g_mapport_current_proto;\n+static uint16_t g_mapport_external_port = 0;\n+static constexpr auto PORT_MAPPING_REANNOUNCE_PERIOD = std::chrono::minutes(20);\n+static constexpr auto PORT_MAPPING_RETRY_PERIOD = std::chrono::minutes(5);\n+\n+#ifdef USE_NATPMP\n+static bool NatpmpInit(natpmp_t* natpmp)\n+{\n+    const int r_init = initnatpmp(natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r_init == 0) return true;\n+    LogPrintf(\"NAT-PMP: initnatpmp() failed with %d error.\\n\", r_init);\n+    return false;\n+}\n+\n+static bool NatpmpDiscover(natpmp_t* natpmp, struct in_addr& external_ipv4_addr)\n+{\n+    const int r_send = sendpublicaddressrequest(natpmp);\n+    if (r_send == 2 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            external_ipv4_addr = response.pnu.publicaddress.addr;\n+            return true;\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"NAT-PMP: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool NatpmpMapping(natpmp_t* natpmp, const struct in_addr& external_ipv4_addr, uint16_t private_port, bool& external_ip_discovered)\n+{\n+    const uint16_t suggested_external_port = g_mapport_external_port ? g_mapport_external_port : private_port;\n+    const int r_send = sendnewportmappingrequest(natpmp, NATPMP_PROTOCOL_TCP, private_port, suggested_external_port, 3600 /*seconds*/);\n+    if (r_send == 12 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            auto pm = response.pnu.newportmapping;\n+            if (private_port == pm.privateport && pm.lifetime > 0) {\n+                g_mapport_current_proto = MapPortProto::NAT_PMP;\n+                g_mapport_external_port = pm.mappedpublicport;\n+                const CService external{external_ipv4_addr, pm.mappedpublicport};\n+                if (!external_ip_discovered && fDiscover) {\n+                    AddLocal(external, LOCAL_MAPPED);\n+                    external_ip_discovered = true;\n+                }\n+\n+                LogPrintf(\"NAT-PMP: Port mapping successful. External address = %s\\n\", external.ToString());\n+                return true;\n+            } else {\n+                LogPrintf(\"NAT-PMP: Port mapping failed.\\n\");\n+            }\n+\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"NAT-PMP: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool ThreadNatpmp()\n+{\n+    bool ret = false;\n+    natpmp_t natpmp;\n+    struct in_addr external_ipv4_addr;\n+    if (NatpmpInit(&natpmp) && NatpmpDiscover(&natpmp, external_ipv4_addr)) {\n+        bool external_ip_discovered = false;\n+        const uint16_t private_port = GetListenPort();\n+        do {\n+            ret = NatpmpMapping(&natpmp, external_ipv4_addr, private_port, external_ip_discovered);\n+        } while (ret && g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+\n+        const int r_send = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, private_port, g_mapport_external_port, /* remove a port mapping */ 0);\n+        g_mapport_external_port = 0;\n+        if (r_send == 12 /* OK */) {\n+            LogPrintf(\"NAT-PMP: Port mapping removed successfully.\\n\");\n+        } else {\n+            LogPrintf(\"NAT-PMP: sendnewportmappingrequest(0) failed with %d error.\\n\", r_send);\n+        }\n+    }\n+\n+    closenatpmp(&natpmp);\n+    return ret;\n+}\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+static bool ThreadUpnp()\n+{\n+    bool ret = false;\n+    std::string port = strprintf(\"%u\", GetListenPort());\n+    const char * multicastif = nullptr;\n+    const char * minissdpdpath = nullptr;\n+    struct UPNPDev * devlist = nullptr;\n+    char lanaddr[64];\n+\n+    int error = 0;\n+#if MINIUPNPC_API_VERSION < 14\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, &error);\n+#else\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, 2, &error);\n+#endif\n+\n+    struct UPNPUrls urls;\n+    struct IGDdatas data;\n+    int r;\n+\n+    r = UPNP_GetValidIGD(devlist, &urls, &data, lanaddr, sizeof(lanaddr));\n+    if (r == 1)\n+    {\n+        if (fDiscover) {\n+            char externalIPAddress[40];\n+            r = UPNP_GetExternalIPAddress(urls.controlURL, data.first.servicetype, externalIPAddress);\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"UPnP: GetExternalIPAddress() returned %d\\n\", r);\n+            } else {\n+                if (externalIPAddress[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(externalIPAddress, resolved, false)) {\n+                        LogPrintf(\"UPnP: ExternalIPAddress = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"UPnP: GetExternalIPAddress failed.\\n\");\n+                }\n+            }\n+        }\n+\n+        std::string strDesc = PACKAGE_NAME \" \" + FormatFullVersion();\n+\n+        do {\n+            r = UPNP_AddPortMapping(urls.controlURL, data.first.servicetype, port.c_str(), port.c_str(), lanaddr, strDesc.c_str(), \"TCP\", 0, \"0\");\n+\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                ret = false;\n+                LogPrintf(\"AddPortMapping(%s, %s, %s) failed with code %d (%s)\\n\", port, port, lanaddr, r, strupnperror(r));\n+                break;\n+            } else {\n+                ret = true;\n+                g_mapport_current_proto = MapPortProto::UPNP;\n+                LogPrintf(\"UPnP Port Mapping successful.\\n\");\n+            }\n+        } while (g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+\n+        r = UPNP_DeletePortMapping(urls.controlURL, data.first.servicetype, port.c_str(), \"TCP\", 0);\n+        LogPrintf(\"UPNP_DeletePortMapping() returned: %d\\n\", r);\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        FreeUPNPUrls(&urls);\n+    } else {\n+        LogPrintf(\"No valid UPnP IGDs found\\n\");\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        if (r != 0)\n+            FreeUPNPUrls(&urls);\n+    }\n+\n+    return ret;\n+}\n+#endif // #ifdef USE_UPNP\n+\n+static void ThreadMapPort()\n+{\n+    bool ok;\n+    do {\n+        ok = false;\n+\n+#ifdef USE_NATPMP\n+        if (g_mapport_target_proto & MapPortProto::NAT_PMP) {\n+            ok = ThreadNatpmp();\n+            if (ok) continue;\n+        }\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+        if (g_mapport_target_proto & MapPortProto::UPNP) {\n+            ok = ThreadUpnp();\n+            if (ok) continue;\n+        }\n+#endif // #ifdef USE_UPNP\n+\n+        if (g_mapport_target_proto == MapPortProto::NONE) {\n+            g_mapport_current_proto = MapPortProto::NONE;\n+            return;\n+        }\n+\n+    } while (ok || g_mapport_interrupt.sleep_for(PORT_MAPPING_RETRY_PERIOD));\n+}\n+\n+void StartMapPort(bool use_natpmp, bool use_upnp)\n+{\n+    if (use_natpmp) {\n+        g_mapport_target_proto |= MapPortProto::NAT_PMP;\n+    } else {\n+        g_mapport_target_proto &= ~MapPortProto::NAT_PMP;\n+    }\n+\n+    if (use_upnp) {\n+        g_mapport_target_proto |= MapPortProto::UPNP;\n+    } else {\n+        g_mapport_target_proto &= ~MapPortProto::UPNP;\n+    }\n+\n+    if (g_mapport_current_proto == MapPortProto::NONE) {\n+        if (g_mapport_target_proto == MapPortProto::NONE) {\n+            return;\n+        }\n+    } else if (g_mapport_target_proto & g_mapport_current_proto) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r382316994",
      "id" : 382316994,
      "in_reply_to_id" : 381557545,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMxNjk5NA==",
      "original_commit_id" : "03e2733be1772ef69caf34e84c7b400f64a8ea9f",
      "original_line" : 275,
      "original_position" : 273,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : null,
      "pull_request_review_id" : 362308336,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/382316994",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@luke-jr \r\n> Also, since NAT-PMP apparently maps random ports often, I think we should prefer UPnP...\r\n\r\nDoes this behavior of NAT-PMP gateways hurt the entire p2p network?\r\n\r\nOTOH, NAT-PMP seems more secure than UPnP (for example, one could compare numbers of CVEs for each protocol).",
      "created_at" : "2020-02-20T23:42:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-589416424",
      "id" : 589416424,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4OTQxNjQyNA==",
      "updated_at" : "2020-02-20T23:42:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/589416424",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : ">Does this behavior of NAT-PMP gateways hurt the entire p2p network?\r\n\r\nDNS seeds can't provide port numbers, so using anything other than 8333 reduces the list of nodes we can advertise. Currently, mine (which is IIRC more restrictive than others) has 3090 eligible nodes, so it's not a big deal, but it'd be nicer to have a wider selection available than a narrower selection.\r\n\r\n> OTOH, NAT-PMP seems more secure than UPnP (for example, one could compare numbers of CVEs for each protocol).\r\n\r\nThe CVEs AFAIK are for the implementations, not the protocol.\r\n\r\nIn any case, when we are using either, I think we're reduced to the weakest no matter which we prefer (a hostile router could block NAT-PMP to force fallback to UPnP).",
      "created_at" : "2020-02-20T23:52:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-589428754",
      "id" : 589428754,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4OTQyODc1NA==",
      "updated_at" : "2020-02-20T23:52:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/589428754",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r382325993"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/382325993"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why would it? You'd return early here without making the change...",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-20T23:55:02Z",
      "diff_hunk" : "@@ -0,0 +1,320 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <netinet/in.h>\n+#endif // #ifdef WIN32\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif // #ifdef USE_UPNP\n+\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_mapport_interrupt;\n+static std::thread g_mapport_thread;\n+static MapPortProto g_mapport_current_proto = MapPortProto::NONE;\n+static unsigned int g_mapport_target_proto = g_mapport_current_proto;\n+static uint16_t g_mapport_external_port = 0;\n+static constexpr auto PORT_MAPPING_REANNOUNCE_PERIOD = std::chrono::minutes(20);\n+static constexpr auto PORT_MAPPING_RETRY_PERIOD = std::chrono::minutes(5);\n+\n+#ifdef USE_NATPMP\n+static bool NatpmpInit(natpmp_t* natpmp)\n+{\n+    const int r_init = initnatpmp(natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r_init == 0) return true;\n+    LogPrintf(\"NAT-PMP: initnatpmp() failed with %d error.\\n\", r_init);\n+    return false;\n+}\n+\n+static bool NatpmpDiscover(natpmp_t* natpmp, struct in_addr& external_ipv4_addr)\n+{\n+    const int r_send = sendpublicaddressrequest(natpmp);\n+    if (r_send == 2 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            external_ipv4_addr = response.pnu.publicaddress.addr;\n+            return true;\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"NAT-PMP: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool NatpmpMapping(natpmp_t* natpmp, const struct in_addr& external_ipv4_addr, uint16_t private_port, bool& external_ip_discovered)\n+{\n+    const uint16_t suggested_external_port = g_mapport_external_port ? g_mapport_external_port : private_port;\n+    const int r_send = sendnewportmappingrequest(natpmp, NATPMP_PROTOCOL_TCP, private_port, suggested_external_port, 3600 /*seconds*/);\n+    if (r_send == 12 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            auto pm = response.pnu.newportmapping;\n+            if (private_port == pm.privateport && pm.lifetime > 0) {\n+                g_mapport_current_proto = MapPortProto::NAT_PMP;\n+                g_mapport_external_port = pm.mappedpublicport;\n+                const CService external{external_ipv4_addr, pm.mappedpublicport};\n+                if (!external_ip_discovered && fDiscover) {\n+                    AddLocal(external, LOCAL_MAPPED);\n+                    external_ip_discovered = true;\n+                }\n+\n+                LogPrintf(\"NAT-PMP: Port mapping successful. External address = %s\\n\", external.ToString());\n+                return true;\n+            } else {\n+                LogPrintf(\"NAT-PMP: Port mapping failed.\\n\");\n+            }\n+\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"NAT-PMP: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool ThreadNatpmp()\n+{\n+    bool ret = false;\n+    natpmp_t natpmp;\n+    struct in_addr external_ipv4_addr;\n+    if (NatpmpInit(&natpmp) && NatpmpDiscover(&natpmp, external_ipv4_addr)) {\n+        bool external_ip_discovered = false;\n+        const uint16_t private_port = GetListenPort();\n+        do {\n+            ret = NatpmpMapping(&natpmp, external_ipv4_addr, private_port, external_ip_discovered);\n+        } while (ret && g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+\n+        const int r_send = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, private_port, g_mapport_external_port, /* remove a port mapping */ 0);\n+        g_mapport_external_port = 0;\n+        if (r_send == 12 /* OK */) {\n+            LogPrintf(\"NAT-PMP: Port mapping removed successfully.\\n\");\n+        } else {\n+            LogPrintf(\"NAT-PMP: sendnewportmappingrequest(0) failed with %d error.\\n\", r_send);\n+        }\n+    }\n+\n+    closenatpmp(&natpmp);\n+    return ret;\n+}\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+static bool ThreadUpnp()\n+{\n+    bool ret = false;\n+    std::string port = strprintf(\"%u\", GetListenPort());\n+    const char * multicastif = nullptr;\n+    const char * minissdpdpath = nullptr;\n+    struct UPNPDev * devlist = nullptr;\n+    char lanaddr[64];\n+\n+    int error = 0;\n+#if MINIUPNPC_API_VERSION < 14\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, &error);\n+#else\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, 2, &error);\n+#endif\n+\n+    struct UPNPUrls urls;\n+    struct IGDdatas data;\n+    int r;\n+\n+    r = UPNP_GetValidIGD(devlist, &urls, &data, lanaddr, sizeof(lanaddr));\n+    if (r == 1)\n+    {\n+        if (fDiscover) {\n+            char externalIPAddress[40];\n+            r = UPNP_GetExternalIPAddress(urls.controlURL, data.first.servicetype, externalIPAddress);\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"UPnP: GetExternalIPAddress() returned %d\\n\", r);\n+            } else {\n+                if (externalIPAddress[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(externalIPAddress, resolved, false)) {\n+                        LogPrintf(\"UPnP: ExternalIPAddress = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"UPnP: GetExternalIPAddress failed.\\n\");\n+                }\n+            }\n+        }\n+\n+        std::string strDesc = PACKAGE_NAME \" \" + FormatFullVersion();\n+\n+        do {\n+            r = UPNP_AddPortMapping(urls.controlURL, data.first.servicetype, port.c_str(), port.c_str(), lanaddr, strDesc.c_str(), \"TCP\", 0, \"0\");\n+\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                ret = false;\n+                LogPrintf(\"AddPortMapping(%s, %s, %s) failed with code %d (%s)\\n\", port, port, lanaddr, r, strupnperror(r));\n+                break;\n+            } else {\n+                ret = true;\n+                g_mapport_current_proto = MapPortProto::UPNP;\n+                LogPrintf(\"UPnP Port Mapping successful.\\n\");\n+            }\n+        } while (g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+\n+        r = UPNP_DeletePortMapping(urls.controlURL, data.first.servicetype, port.c_str(), \"TCP\", 0);\n+        LogPrintf(\"UPNP_DeletePortMapping() returned: %d\\n\", r);\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        FreeUPNPUrls(&urls);\n+    } else {\n+        LogPrintf(\"No valid UPnP IGDs found\\n\");\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        if (r != 0)\n+            FreeUPNPUrls(&urls);\n+    }\n+\n+    return ret;\n+}\n+#endif // #ifdef USE_UPNP\n+\n+static void ThreadMapPort()\n+{\n+    bool ok;\n+    do {\n+        ok = false;\n+\n+#ifdef USE_NATPMP\n+        if (g_mapport_target_proto & MapPortProto::NAT_PMP) {\n+            ok = ThreadNatpmp();\n+            if (ok) continue;\n+        }\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+        if (g_mapport_target_proto & MapPortProto::UPNP) {\n+            ok = ThreadUpnp();\n+            if (ok) continue;\n+        }\n+#endif // #ifdef USE_UPNP\n+\n+        if (g_mapport_target_proto == MapPortProto::NONE) {\n+            g_mapport_current_proto = MapPortProto::NONE;\n+            return;\n+        }\n+\n+    } while (ok || g_mapport_interrupt.sleep_for(PORT_MAPPING_RETRY_PERIOD));\n+}\n+\n+void StartMapPort(bool use_natpmp, bool use_upnp)\n+{\n+    if (use_natpmp) {\n+        g_mapport_target_proto |= MapPortProto::NAT_PMP;\n+    } else {\n+        g_mapport_target_proto &= ~MapPortProto::NAT_PMP;\n+    }\n+\n+    if (use_upnp) {\n+        g_mapport_target_proto |= MapPortProto::UPNP;\n+    } else {\n+        g_mapport_target_proto &= ~MapPortProto::UPNP;\n+    }\n+\n+    if (g_mapport_current_proto == MapPortProto::NONE) {\n+        if (g_mapport_target_proto == MapPortProto::NONE) {\n+            return;\n+        }\n+    } else if (g_mapport_target_proto & g_mapport_current_proto) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r382325993",
      "id" : 382325993,
      "in_reply_to_id" : 381557545,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMyNTk5Mw==",
      "original_commit_id" : "03e2733be1772ef69caf34e84c7b400f64a8ea9f",
      "original_line" : 275,
      "original_position" : 273,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : null,
      "pull_request_review_id" : 362319026,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/382325993",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r382327259"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/382327259"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If both protocols were enabled, `g_mapport_target_proto != MapPortProto::NONE`",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-20T23:59:05Z",
      "diff_hunk" : "@@ -0,0 +1,320 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <netinet/in.h>\n+#endif // #ifdef WIN32\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif // #ifdef USE_UPNP\n+\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_mapport_interrupt;\n+static std::thread g_mapport_thread;\n+static MapPortProto g_mapport_current_proto = MapPortProto::NONE;\n+static unsigned int g_mapport_target_proto = g_mapport_current_proto;\n+static uint16_t g_mapport_external_port = 0;\n+static constexpr auto PORT_MAPPING_REANNOUNCE_PERIOD = std::chrono::minutes(20);\n+static constexpr auto PORT_MAPPING_RETRY_PERIOD = std::chrono::minutes(5);\n+\n+#ifdef USE_NATPMP\n+static bool NatpmpInit(natpmp_t* natpmp)\n+{\n+    const int r_init = initnatpmp(natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r_init == 0) return true;\n+    LogPrintf(\"NAT-PMP: initnatpmp() failed with %d error.\\n\", r_init);\n+    return false;\n+}\n+\n+static bool NatpmpDiscover(natpmp_t* natpmp, struct in_addr& external_ipv4_addr)\n+{\n+    const int r_send = sendpublicaddressrequest(natpmp);\n+    if (r_send == 2 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            external_ipv4_addr = response.pnu.publicaddress.addr;\n+            return true;\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"NAT-PMP: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool NatpmpMapping(natpmp_t* natpmp, const struct in_addr& external_ipv4_addr, uint16_t private_port, bool& external_ip_discovered)\n+{\n+    const uint16_t suggested_external_port = g_mapport_external_port ? g_mapport_external_port : private_port;\n+    const int r_send = sendnewportmappingrequest(natpmp, NATPMP_PROTOCOL_TCP, private_port, suggested_external_port, 3600 /*seconds*/);\n+    if (r_send == 12 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            auto pm = response.pnu.newportmapping;\n+            if (private_port == pm.privateport && pm.lifetime > 0) {\n+                g_mapport_current_proto = MapPortProto::NAT_PMP;\n+                g_mapport_external_port = pm.mappedpublicport;\n+                const CService external{external_ipv4_addr, pm.mappedpublicport};\n+                if (!external_ip_discovered && fDiscover) {\n+                    AddLocal(external, LOCAL_MAPPED);\n+                    external_ip_discovered = true;\n+                }\n+\n+                LogPrintf(\"NAT-PMP: Port mapping successful. External address = %s\\n\", external.ToString());\n+                return true;\n+            } else {\n+                LogPrintf(\"NAT-PMP: Port mapping failed.\\n\");\n+            }\n+\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"NAT-PMP: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool ThreadNatpmp()\n+{\n+    bool ret = false;\n+    natpmp_t natpmp;\n+    struct in_addr external_ipv4_addr;\n+    if (NatpmpInit(&natpmp) && NatpmpDiscover(&natpmp, external_ipv4_addr)) {\n+        bool external_ip_discovered = false;\n+        const uint16_t private_port = GetListenPort();\n+        do {\n+            ret = NatpmpMapping(&natpmp, external_ipv4_addr, private_port, external_ip_discovered);\n+        } while (ret && g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+\n+        const int r_send = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, private_port, g_mapport_external_port, /* remove a port mapping */ 0);\n+        g_mapport_external_port = 0;\n+        if (r_send == 12 /* OK */) {\n+            LogPrintf(\"NAT-PMP: Port mapping removed successfully.\\n\");\n+        } else {\n+            LogPrintf(\"NAT-PMP: sendnewportmappingrequest(0) failed with %d error.\\n\", r_send);\n+        }\n+    }\n+\n+    closenatpmp(&natpmp);\n+    return ret;\n+}\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+static bool ThreadUpnp()\n+{\n+    bool ret = false;\n+    std::string port = strprintf(\"%u\", GetListenPort());\n+    const char * multicastif = nullptr;\n+    const char * minissdpdpath = nullptr;\n+    struct UPNPDev * devlist = nullptr;\n+    char lanaddr[64];\n+\n+    int error = 0;\n+#if MINIUPNPC_API_VERSION < 14\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, &error);\n+#else\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, 2, &error);\n+#endif\n+\n+    struct UPNPUrls urls;\n+    struct IGDdatas data;\n+    int r;\n+\n+    r = UPNP_GetValidIGD(devlist, &urls, &data, lanaddr, sizeof(lanaddr));\n+    if (r == 1)\n+    {\n+        if (fDiscover) {\n+            char externalIPAddress[40];\n+            r = UPNP_GetExternalIPAddress(urls.controlURL, data.first.servicetype, externalIPAddress);\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"UPnP: GetExternalIPAddress() returned %d\\n\", r);\n+            } else {\n+                if (externalIPAddress[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(externalIPAddress, resolved, false)) {\n+                        LogPrintf(\"UPnP: ExternalIPAddress = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"UPnP: GetExternalIPAddress failed.\\n\");\n+                }\n+            }\n+        }\n+\n+        std::string strDesc = PACKAGE_NAME \" \" + FormatFullVersion();\n+\n+        do {\n+            r = UPNP_AddPortMapping(urls.controlURL, data.first.servicetype, port.c_str(), port.c_str(), lanaddr, strDesc.c_str(), \"TCP\", 0, \"0\");\n+\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                ret = false;\n+                LogPrintf(\"AddPortMapping(%s, %s, %s) failed with code %d (%s)\\n\", port, port, lanaddr, r, strupnperror(r));\n+                break;\n+            } else {\n+                ret = true;\n+                g_mapport_current_proto = MapPortProto::UPNP;\n+                LogPrintf(\"UPnP Port Mapping successful.\\n\");\n+            }\n+        } while (g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+\n+        r = UPNP_DeletePortMapping(urls.controlURL, data.first.servicetype, port.c_str(), \"TCP\", 0);\n+        LogPrintf(\"UPNP_DeletePortMapping() returned: %d\\n\", r);\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        FreeUPNPUrls(&urls);\n+    } else {\n+        LogPrintf(\"No valid UPnP IGDs found\\n\");\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        if (r != 0)\n+            FreeUPNPUrls(&urls);\n+    }\n+\n+    return ret;\n+}\n+#endif // #ifdef USE_UPNP\n+\n+static void ThreadMapPort()\n+{\n+    bool ok;\n+    do {\n+        ok = false;\n+\n+#ifdef USE_NATPMP\n+        if (g_mapport_target_proto & MapPortProto::NAT_PMP) {\n+            ok = ThreadNatpmp();\n+            if (ok) continue;\n+        }\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+        if (g_mapport_target_proto & MapPortProto::UPNP) {\n+            ok = ThreadUpnp();\n+            if (ok) continue;\n+        }\n+#endif // #ifdef USE_UPNP\n+\n+        if (g_mapport_target_proto == MapPortProto::NONE) {\n+            g_mapport_current_proto = MapPortProto::NONE;\n+            return;\n+        }\n+\n+    } while (ok || g_mapport_interrupt.sleep_for(PORT_MAPPING_RETRY_PERIOD));\n+}\n+\n+void StartMapPort(bool use_natpmp, bool use_upnp)\n+{\n+    if (use_natpmp) {\n+        g_mapport_target_proto |= MapPortProto::NAT_PMP;\n+    } else {\n+        g_mapport_target_proto &= ~MapPortProto::NAT_PMP;\n+    }\n+\n+    if (use_upnp) {\n+        g_mapport_target_proto |= MapPortProto::UPNP;\n+    } else {\n+        g_mapport_target_proto &= ~MapPortProto::UPNP;\n+    }\n+\n+    if (g_mapport_current_proto == MapPortProto::NONE) {\n+        if (g_mapport_target_proto == MapPortProto::NONE) {\n+            return;\n+        }\n+    } else if (g_mapport_target_proto & g_mapport_current_proto) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r382327259",
      "id" : 382327259,
      "in_reply_to_id" : 381557545,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMyNzI1OQ==",
      "original_commit_id" : "03e2733be1772ef69caf34e84c7b400f64a8ea9f",
      "original_line" : 275,
      "original_position" : 273,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : null,
      "pull_request_review_id" : 362320522,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/382327259",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r382377105"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/382377105"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The conditional here is `(g_mapport_target_proto & g_mapport_current_proto)`",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-21T03:13:33Z",
      "diff_hunk" : "@@ -0,0 +1,320 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <netinet/in.h>\n+#endif // #ifdef WIN32\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif // #ifdef USE_UPNP\n+\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_mapport_interrupt;\n+static std::thread g_mapport_thread;\n+static MapPortProto g_mapport_current_proto = MapPortProto::NONE;\n+static unsigned int g_mapport_target_proto = g_mapport_current_proto;\n+static uint16_t g_mapport_external_port = 0;\n+static constexpr auto PORT_MAPPING_REANNOUNCE_PERIOD = std::chrono::minutes(20);\n+static constexpr auto PORT_MAPPING_RETRY_PERIOD = std::chrono::minutes(5);\n+\n+#ifdef USE_NATPMP\n+static bool NatpmpInit(natpmp_t* natpmp)\n+{\n+    const int r_init = initnatpmp(natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r_init == 0) return true;\n+    LogPrintf(\"NAT-PMP: initnatpmp() failed with %d error.\\n\", r_init);\n+    return false;\n+}\n+\n+static bool NatpmpDiscover(natpmp_t* natpmp, struct in_addr& external_ipv4_addr)\n+{\n+    const int r_send = sendpublicaddressrequest(natpmp);\n+    if (r_send == 2 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            external_ipv4_addr = response.pnu.publicaddress.addr;\n+            return true;\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"NAT-PMP: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool NatpmpMapping(natpmp_t* natpmp, const struct in_addr& external_ipv4_addr, uint16_t private_port, bool& external_ip_discovered)\n+{\n+    const uint16_t suggested_external_port = g_mapport_external_port ? g_mapport_external_port : private_port;\n+    const int r_send = sendnewportmappingrequest(natpmp, NATPMP_PROTOCOL_TCP, private_port, suggested_external_port, 3600 /*seconds*/);\n+    if (r_send == 12 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            auto pm = response.pnu.newportmapping;\n+            if (private_port == pm.privateport && pm.lifetime > 0) {\n+                g_mapport_current_proto = MapPortProto::NAT_PMP;\n+                g_mapport_external_port = pm.mappedpublicport;\n+                const CService external{external_ipv4_addr, pm.mappedpublicport};\n+                if (!external_ip_discovered && fDiscover) {\n+                    AddLocal(external, LOCAL_MAPPED);\n+                    external_ip_discovered = true;\n+                }\n+\n+                LogPrintf(\"NAT-PMP: Port mapping successful. External address = %s\\n\", external.ToString());\n+                return true;\n+            } else {\n+                LogPrintf(\"NAT-PMP: Port mapping failed.\\n\");\n+            }\n+\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"NAT-PMP: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool ThreadNatpmp()\n+{\n+    bool ret = false;\n+    natpmp_t natpmp;\n+    struct in_addr external_ipv4_addr;\n+    if (NatpmpInit(&natpmp) && NatpmpDiscover(&natpmp, external_ipv4_addr)) {\n+        bool external_ip_discovered = false;\n+        const uint16_t private_port = GetListenPort();\n+        do {\n+            ret = NatpmpMapping(&natpmp, external_ipv4_addr, private_port, external_ip_discovered);\n+        } while (ret && g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+\n+        const int r_send = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, private_port, g_mapport_external_port, /* remove a port mapping */ 0);\n+        g_mapport_external_port = 0;\n+        if (r_send == 12 /* OK */) {\n+            LogPrintf(\"NAT-PMP: Port mapping removed successfully.\\n\");\n+        } else {\n+            LogPrintf(\"NAT-PMP: sendnewportmappingrequest(0) failed with %d error.\\n\", r_send);\n+        }\n+    }\n+\n+    closenatpmp(&natpmp);\n+    return ret;\n+}\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+static bool ThreadUpnp()\n+{\n+    bool ret = false;\n+    std::string port = strprintf(\"%u\", GetListenPort());\n+    const char * multicastif = nullptr;\n+    const char * minissdpdpath = nullptr;\n+    struct UPNPDev * devlist = nullptr;\n+    char lanaddr[64];\n+\n+    int error = 0;\n+#if MINIUPNPC_API_VERSION < 14\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, &error);\n+#else\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, 2, &error);\n+#endif\n+\n+    struct UPNPUrls urls;\n+    struct IGDdatas data;\n+    int r;\n+\n+    r = UPNP_GetValidIGD(devlist, &urls, &data, lanaddr, sizeof(lanaddr));\n+    if (r == 1)\n+    {\n+        if (fDiscover) {\n+            char externalIPAddress[40];\n+            r = UPNP_GetExternalIPAddress(urls.controlURL, data.first.servicetype, externalIPAddress);\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"UPnP: GetExternalIPAddress() returned %d\\n\", r);\n+            } else {\n+                if (externalIPAddress[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(externalIPAddress, resolved, false)) {\n+                        LogPrintf(\"UPnP: ExternalIPAddress = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"UPnP: GetExternalIPAddress failed.\\n\");\n+                }\n+            }\n+        }\n+\n+        std::string strDesc = PACKAGE_NAME \" \" + FormatFullVersion();\n+\n+        do {\n+            r = UPNP_AddPortMapping(urls.controlURL, data.first.servicetype, port.c_str(), port.c_str(), lanaddr, strDesc.c_str(), \"TCP\", 0, \"0\");\n+\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                ret = false;\n+                LogPrintf(\"AddPortMapping(%s, %s, %s) failed with code %d (%s)\\n\", port, port, lanaddr, r, strupnperror(r));\n+                break;\n+            } else {\n+                ret = true;\n+                g_mapport_current_proto = MapPortProto::UPNP;\n+                LogPrintf(\"UPnP Port Mapping successful.\\n\");\n+            }\n+        } while (g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+\n+        r = UPNP_DeletePortMapping(urls.controlURL, data.first.servicetype, port.c_str(), \"TCP\", 0);\n+        LogPrintf(\"UPNP_DeletePortMapping() returned: %d\\n\", r);\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        FreeUPNPUrls(&urls);\n+    } else {\n+        LogPrintf(\"No valid UPnP IGDs found\\n\");\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        if (r != 0)\n+            FreeUPNPUrls(&urls);\n+    }\n+\n+    return ret;\n+}\n+#endif // #ifdef USE_UPNP\n+\n+static void ThreadMapPort()\n+{\n+    bool ok;\n+    do {\n+        ok = false;\n+\n+#ifdef USE_NATPMP\n+        if (g_mapport_target_proto & MapPortProto::NAT_PMP) {\n+            ok = ThreadNatpmp();\n+            if (ok) continue;\n+        }\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+        if (g_mapport_target_proto & MapPortProto::UPNP) {\n+            ok = ThreadUpnp();\n+            if (ok) continue;\n+        }\n+#endif // #ifdef USE_UPNP\n+\n+        if (g_mapport_target_proto == MapPortProto::NONE) {\n+            g_mapport_current_proto = MapPortProto::NONE;\n+            return;\n+        }\n+\n+    } while (ok || g_mapport_interrupt.sleep_for(PORT_MAPPING_RETRY_PERIOD));\n+}\n+\n+void StartMapPort(bool use_natpmp, bool use_upnp)\n+{\n+    if (use_natpmp) {\n+        g_mapport_target_proto |= MapPortProto::NAT_PMP;\n+    } else {\n+        g_mapport_target_proto &= ~MapPortProto::NAT_PMP;\n+    }\n+\n+    if (use_upnp) {\n+        g_mapport_target_proto |= MapPortProto::UPNP;\n+    } else {\n+        g_mapport_target_proto &= ~MapPortProto::UPNP;\n+    }\n+\n+    if (g_mapport_current_proto == MapPortProto::NONE) {\n+        if (g_mapport_target_proto == MapPortProto::NONE) {\n+            return;\n+        }\n+    } else if (g_mapport_target_proto & g_mapport_current_proto) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r382377105",
      "id" : 382377105,
      "in_reply_to_id" : 381557545,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM3NzEwNQ==",
      "original_commit_id" : "03e2733be1772ef69caf34e84c7b400f64a8ea9f",
      "original_line" : 275,
      "original_position" : 273,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : null,
      "pull_request_review_id" : 362376836,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/382377105",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r382547566"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/382547566"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```C++\r\nvoid StartMapPort(bool use_natpmp, bool use_upnp)\r\n{\r\n    // Both protocols are enabled, so\r\n    // g_mapport_target_proto == MapPortProto::NAT_PMP | MapPortProto::UPNP\r\n    //\r\n    // UPnP is currently using, so\r\n    // g_mapport_current_proto == MapPortProto::UPNP\r\n    //\r\n    // A user disables UPnP then passed arguments are:\r\n    // use_natpmp == true, use_upnp = false\r\n\r\n    if (use_natpmp) {\r\n        // Effectively noop here as MapPortProto::NAT_PMP is set already.\r\n        g_mapport_target_proto |= MapPortProto::NAT_PMP;\r\n    } else {\r\n        g_mapport_target_proto &= ~MapPortProto::NAT_PMP;\r\n    }\r\n\r\n    if (use_upnp) {\r\n        g_mapport_target_proto |= MapPortProto::UPNP;\r\n    } else {\r\n        // Unset MapPortProto::UPNP bit.\r\n        g_mapport_target_proto &= ~MapPortProto::UPNP;\r\n    }\r\n\r\n    // At this point variables are set to the following values:\r\n    // g_mapport_target_proto == MapPortProto::NAT_PMP\r\n    // g_mapport_current_proto == MapPortProto::UPNP\r\n    // ...\r\n    if (g_mapport_current_proto == MapPortProto::NONE) {\r\n        if (g_mapport_target_proto == MapPortProto::NONE) {\r\n            return;\r\n        }\r\n    // ... and the next condition evaluates to false.\r\n    } else if (g_mapport_target_proto & g_mapport_current_proto) {\r\n        return;\r\n    }\r\n\r\n    // Making the changes...\r\n    ...\r\n}\r\n```\r\n\r\nAnd logs confirm this logic.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-21T12:06:51Z",
      "diff_hunk" : "@@ -0,0 +1,320 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <netinet/in.h>\n+#endif // #ifdef WIN32\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif // #ifdef USE_UPNP\n+\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_mapport_interrupt;\n+static std::thread g_mapport_thread;\n+static MapPortProto g_mapport_current_proto = MapPortProto::NONE;\n+static unsigned int g_mapport_target_proto = g_mapport_current_proto;\n+static uint16_t g_mapport_external_port = 0;\n+static constexpr auto PORT_MAPPING_REANNOUNCE_PERIOD = std::chrono::minutes(20);\n+static constexpr auto PORT_MAPPING_RETRY_PERIOD = std::chrono::minutes(5);\n+\n+#ifdef USE_NATPMP\n+static bool NatpmpInit(natpmp_t* natpmp)\n+{\n+    const int r_init = initnatpmp(natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r_init == 0) return true;\n+    LogPrintf(\"NAT-PMP: initnatpmp() failed with %d error.\\n\", r_init);\n+    return false;\n+}\n+\n+static bool NatpmpDiscover(natpmp_t* natpmp, struct in_addr& external_ipv4_addr)\n+{\n+    const int r_send = sendpublicaddressrequest(natpmp);\n+    if (r_send == 2 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            external_ipv4_addr = response.pnu.publicaddress.addr;\n+            return true;\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"NAT-PMP: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool NatpmpMapping(natpmp_t* natpmp, const struct in_addr& external_ipv4_addr, uint16_t private_port, bool& external_ip_discovered)\n+{\n+    const uint16_t suggested_external_port = g_mapport_external_port ? g_mapport_external_port : private_port;\n+    const int r_send = sendnewportmappingrequest(natpmp, NATPMP_PROTOCOL_TCP, private_port, suggested_external_port, 3600 /*seconds*/);\n+    if (r_send == 12 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            auto pm = response.pnu.newportmapping;\n+            if (private_port == pm.privateport && pm.lifetime > 0) {\n+                g_mapport_current_proto = MapPortProto::NAT_PMP;\n+                g_mapport_external_port = pm.mappedpublicport;\n+                const CService external{external_ipv4_addr, pm.mappedpublicport};\n+                if (!external_ip_discovered && fDiscover) {\n+                    AddLocal(external, LOCAL_MAPPED);\n+                    external_ip_discovered = true;\n+                }\n+\n+                LogPrintf(\"NAT-PMP: Port mapping successful. External address = %s\\n\", external.ToString());\n+                return true;\n+            } else {\n+                LogPrintf(\"NAT-PMP: Port mapping failed.\\n\");\n+            }\n+\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"NAT-PMP: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool ThreadNatpmp()\n+{\n+    bool ret = false;\n+    natpmp_t natpmp;\n+    struct in_addr external_ipv4_addr;\n+    if (NatpmpInit(&natpmp) && NatpmpDiscover(&natpmp, external_ipv4_addr)) {\n+        bool external_ip_discovered = false;\n+        const uint16_t private_port = GetListenPort();\n+        do {\n+            ret = NatpmpMapping(&natpmp, external_ipv4_addr, private_port, external_ip_discovered);\n+        } while (ret && g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+\n+        const int r_send = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, private_port, g_mapport_external_port, /* remove a port mapping */ 0);\n+        g_mapport_external_port = 0;\n+        if (r_send == 12 /* OK */) {\n+            LogPrintf(\"NAT-PMP: Port mapping removed successfully.\\n\");\n+        } else {\n+            LogPrintf(\"NAT-PMP: sendnewportmappingrequest(0) failed with %d error.\\n\", r_send);\n+        }\n+    }\n+\n+    closenatpmp(&natpmp);\n+    return ret;\n+}\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+static bool ThreadUpnp()\n+{\n+    bool ret = false;\n+    std::string port = strprintf(\"%u\", GetListenPort());\n+    const char * multicastif = nullptr;\n+    const char * minissdpdpath = nullptr;\n+    struct UPNPDev * devlist = nullptr;\n+    char lanaddr[64];\n+\n+    int error = 0;\n+#if MINIUPNPC_API_VERSION < 14\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, &error);\n+#else\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, 2, &error);\n+#endif\n+\n+    struct UPNPUrls urls;\n+    struct IGDdatas data;\n+    int r;\n+\n+    r = UPNP_GetValidIGD(devlist, &urls, &data, lanaddr, sizeof(lanaddr));\n+    if (r == 1)\n+    {\n+        if (fDiscover) {\n+            char externalIPAddress[40];\n+            r = UPNP_GetExternalIPAddress(urls.controlURL, data.first.servicetype, externalIPAddress);\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"UPnP: GetExternalIPAddress() returned %d\\n\", r);\n+            } else {\n+                if (externalIPAddress[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(externalIPAddress, resolved, false)) {\n+                        LogPrintf(\"UPnP: ExternalIPAddress = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"UPnP: GetExternalIPAddress failed.\\n\");\n+                }\n+            }\n+        }\n+\n+        std::string strDesc = PACKAGE_NAME \" \" + FormatFullVersion();\n+\n+        do {\n+            r = UPNP_AddPortMapping(urls.controlURL, data.first.servicetype, port.c_str(), port.c_str(), lanaddr, strDesc.c_str(), \"TCP\", 0, \"0\");\n+\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                ret = false;\n+                LogPrintf(\"AddPortMapping(%s, %s, %s) failed with code %d (%s)\\n\", port, port, lanaddr, r, strupnperror(r));\n+                break;\n+            } else {\n+                ret = true;\n+                g_mapport_current_proto = MapPortProto::UPNP;\n+                LogPrintf(\"UPnP Port Mapping successful.\\n\");\n+            }\n+        } while (g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+\n+        r = UPNP_DeletePortMapping(urls.controlURL, data.first.servicetype, port.c_str(), \"TCP\", 0);\n+        LogPrintf(\"UPNP_DeletePortMapping() returned: %d\\n\", r);\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        FreeUPNPUrls(&urls);\n+    } else {\n+        LogPrintf(\"No valid UPnP IGDs found\\n\");\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        if (r != 0)\n+            FreeUPNPUrls(&urls);\n+    }\n+\n+    return ret;\n+}\n+#endif // #ifdef USE_UPNP\n+\n+static void ThreadMapPort()\n+{\n+    bool ok;\n+    do {\n+        ok = false;\n+\n+#ifdef USE_NATPMP\n+        if (g_mapport_target_proto & MapPortProto::NAT_PMP) {\n+            ok = ThreadNatpmp();\n+            if (ok) continue;\n+        }\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+        if (g_mapport_target_proto & MapPortProto::UPNP) {\n+            ok = ThreadUpnp();\n+            if (ok) continue;\n+        }\n+#endif // #ifdef USE_UPNP\n+\n+        if (g_mapport_target_proto == MapPortProto::NONE) {\n+            g_mapport_current_proto = MapPortProto::NONE;\n+            return;\n+        }\n+\n+    } while (ok || g_mapport_interrupt.sleep_for(PORT_MAPPING_RETRY_PERIOD));\n+}\n+\n+void StartMapPort(bool use_natpmp, bool use_upnp)\n+{\n+    if (use_natpmp) {\n+        g_mapport_target_proto |= MapPortProto::NAT_PMP;\n+    } else {\n+        g_mapport_target_proto &= ~MapPortProto::NAT_PMP;\n+    }\n+\n+    if (use_upnp) {\n+        g_mapport_target_proto |= MapPortProto::UPNP;\n+    } else {\n+        g_mapport_target_proto &= ~MapPortProto::UPNP;\n+    }\n+\n+    if (g_mapport_current_proto == MapPortProto::NONE) {\n+        if (g_mapport_target_proto == MapPortProto::NONE) {\n+            return;\n+        }\n+    } else if (g_mapport_target_proto & g_mapport_current_proto) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r382547566",
      "id" : 382547566,
      "in_reply_to_id" : 381557545,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjU0NzU2Ng==",
      "original_commit_id" : "03e2733be1772ef69caf34e84c7b400f64a8ea9f",
      "original_line" : 275,
      "original_position" : 273,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : null,
      "pull_request_review_id" : 362585478,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/382547566",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r382571364"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/382571364"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Got it. I was confusing it with (target & new_target)",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-21T13:07:25Z",
      "diff_hunk" : "@@ -0,0 +1,320 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <netinet/in.h>\n+#endif // #ifdef WIN32\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif // #ifdef USE_UPNP\n+\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_mapport_interrupt;\n+static std::thread g_mapport_thread;\n+static MapPortProto g_mapport_current_proto = MapPortProto::NONE;\n+static unsigned int g_mapport_target_proto = g_mapport_current_proto;\n+static uint16_t g_mapport_external_port = 0;\n+static constexpr auto PORT_MAPPING_REANNOUNCE_PERIOD = std::chrono::minutes(20);\n+static constexpr auto PORT_MAPPING_RETRY_PERIOD = std::chrono::minutes(5);\n+\n+#ifdef USE_NATPMP\n+static bool NatpmpInit(natpmp_t* natpmp)\n+{\n+    const int r_init = initnatpmp(natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r_init == 0) return true;\n+    LogPrintf(\"NAT-PMP: initnatpmp() failed with %d error.\\n\", r_init);\n+    return false;\n+}\n+\n+static bool NatpmpDiscover(natpmp_t* natpmp, struct in_addr& external_ipv4_addr)\n+{\n+    const int r_send = sendpublicaddressrequest(natpmp);\n+    if (r_send == 2 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            external_ipv4_addr = response.pnu.publicaddress.addr;\n+            return true;\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"NAT-PMP: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool NatpmpMapping(natpmp_t* natpmp, const struct in_addr& external_ipv4_addr, uint16_t private_port, bool& external_ip_discovered)\n+{\n+    const uint16_t suggested_external_port = g_mapport_external_port ? g_mapport_external_port : private_port;\n+    const int r_send = sendnewportmappingrequest(natpmp, NATPMP_PROTOCOL_TCP, private_port, suggested_external_port, 3600 /*seconds*/);\n+    if (r_send == 12 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            auto pm = response.pnu.newportmapping;\n+            if (private_port == pm.privateport && pm.lifetime > 0) {\n+                g_mapport_current_proto = MapPortProto::NAT_PMP;\n+                g_mapport_external_port = pm.mappedpublicport;\n+                const CService external{external_ipv4_addr, pm.mappedpublicport};\n+                if (!external_ip_discovered && fDiscover) {\n+                    AddLocal(external, LOCAL_MAPPED);\n+                    external_ip_discovered = true;\n+                }\n+\n+                LogPrintf(\"NAT-PMP: Port mapping successful. External address = %s\\n\", external.ToString());\n+                return true;\n+            } else {\n+                LogPrintf(\"NAT-PMP: Port mapping failed.\\n\");\n+            }\n+\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"NAT-PMP: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool ThreadNatpmp()\n+{\n+    bool ret = false;\n+    natpmp_t natpmp;\n+    struct in_addr external_ipv4_addr;\n+    if (NatpmpInit(&natpmp) && NatpmpDiscover(&natpmp, external_ipv4_addr)) {\n+        bool external_ip_discovered = false;\n+        const uint16_t private_port = GetListenPort();\n+        do {\n+            ret = NatpmpMapping(&natpmp, external_ipv4_addr, private_port, external_ip_discovered);\n+        } while (ret && g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+\n+        const int r_send = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, private_port, g_mapport_external_port, /* remove a port mapping */ 0);\n+        g_mapport_external_port = 0;\n+        if (r_send == 12 /* OK */) {\n+            LogPrintf(\"NAT-PMP: Port mapping removed successfully.\\n\");\n+        } else {\n+            LogPrintf(\"NAT-PMP: sendnewportmappingrequest(0) failed with %d error.\\n\", r_send);\n+        }\n+    }\n+\n+    closenatpmp(&natpmp);\n+    return ret;\n+}\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+static bool ThreadUpnp()\n+{\n+    bool ret = false;\n+    std::string port = strprintf(\"%u\", GetListenPort());\n+    const char * multicastif = nullptr;\n+    const char * minissdpdpath = nullptr;\n+    struct UPNPDev * devlist = nullptr;\n+    char lanaddr[64];\n+\n+    int error = 0;\n+#if MINIUPNPC_API_VERSION < 14\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, &error);\n+#else\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, 2, &error);\n+#endif\n+\n+    struct UPNPUrls urls;\n+    struct IGDdatas data;\n+    int r;\n+\n+    r = UPNP_GetValidIGD(devlist, &urls, &data, lanaddr, sizeof(lanaddr));\n+    if (r == 1)\n+    {\n+        if (fDiscover) {\n+            char externalIPAddress[40];\n+            r = UPNP_GetExternalIPAddress(urls.controlURL, data.first.servicetype, externalIPAddress);\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"UPnP: GetExternalIPAddress() returned %d\\n\", r);\n+            } else {\n+                if (externalIPAddress[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(externalIPAddress, resolved, false)) {\n+                        LogPrintf(\"UPnP: ExternalIPAddress = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"UPnP: GetExternalIPAddress failed.\\n\");\n+                }\n+            }\n+        }\n+\n+        std::string strDesc = PACKAGE_NAME \" \" + FormatFullVersion();\n+\n+        do {\n+            r = UPNP_AddPortMapping(urls.controlURL, data.first.servicetype, port.c_str(), port.c_str(), lanaddr, strDesc.c_str(), \"TCP\", 0, \"0\");\n+\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                ret = false;\n+                LogPrintf(\"AddPortMapping(%s, %s, %s) failed with code %d (%s)\\n\", port, port, lanaddr, r, strupnperror(r));\n+                break;\n+            } else {\n+                ret = true;\n+                g_mapport_current_proto = MapPortProto::UPNP;\n+                LogPrintf(\"UPnP Port Mapping successful.\\n\");\n+            }\n+        } while (g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+\n+        r = UPNP_DeletePortMapping(urls.controlURL, data.first.servicetype, port.c_str(), \"TCP\", 0);\n+        LogPrintf(\"UPNP_DeletePortMapping() returned: %d\\n\", r);\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        FreeUPNPUrls(&urls);\n+    } else {\n+        LogPrintf(\"No valid UPnP IGDs found\\n\");\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        if (r != 0)\n+            FreeUPNPUrls(&urls);\n+    }\n+\n+    return ret;\n+}\n+#endif // #ifdef USE_UPNP\n+\n+static void ThreadMapPort()\n+{\n+    bool ok;\n+    do {\n+        ok = false;\n+\n+#ifdef USE_NATPMP\n+        if (g_mapport_target_proto & MapPortProto::NAT_PMP) {\n+            ok = ThreadNatpmp();\n+            if (ok) continue;\n+        }\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+        if (g_mapport_target_proto & MapPortProto::UPNP) {\n+            ok = ThreadUpnp();\n+            if (ok) continue;\n+        }\n+#endif // #ifdef USE_UPNP\n+\n+        if (g_mapport_target_proto == MapPortProto::NONE) {\n+            g_mapport_current_proto = MapPortProto::NONE;\n+            return;\n+        }\n+\n+    } while (ok || g_mapport_interrupt.sleep_for(PORT_MAPPING_RETRY_PERIOD));\n+}\n+\n+void StartMapPort(bool use_natpmp, bool use_upnp)\n+{\n+    if (use_natpmp) {\n+        g_mapport_target_proto |= MapPortProto::NAT_PMP;\n+    } else {\n+        g_mapport_target_proto &= ~MapPortProto::NAT_PMP;\n+    }\n+\n+    if (use_upnp) {\n+        g_mapport_target_proto |= MapPortProto::UPNP;\n+    } else {\n+        g_mapport_target_proto &= ~MapPortProto::UPNP;\n+    }\n+\n+    if (g_mapport_current_proto == MapPortProto::NONE) {\n+        if (g_mapport_target_proto == MapPortProto::NONE) {\n+            return;\n+        }\n+    } else if (g_mapport_target_proto & g_mapport_current_proto) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r382571364",
      "id" : 382571364,
      "in_reply_to_id" : 381557545,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjU3MTM2NA==",
      "original_commit_id" : "03e2733be1772ef69caf34e84c7b400f64a8ea9f",
      "original_line" : 275,
      "original_position" : 273,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : null,
      "pull_request_review_id" : 362615449,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/382571364",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r382750749"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/382750749"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This should be reset outside of the protocol-specific functions, or else we could end up with a race.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-21T18:58:20Z",
      "diff_hunk" : "@@ -0,0 +1,322 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <netinet/in.h>\n+#endif // #ifdef WIN32\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif // #ifdef USE_UPNP\n+\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_mapport_interrupt;\n+static std::thread g_mapport_thread;\n+static MapPortProto g_mapport_current_proto = MapPortProto::NONE;\n+static unsigned int g_mapport_target_proto = g_mapport_current_proto;\n+static constexpr auto PORT_MAPPING_REANNOUNCE_PERIOD = std::chrono::minutes(20);\n+static constexpr auto PORT_MAPPING_RETRY_PERIOD = std::chrono::minutes(5);\n+\n+#ifdef USE_NATPMP\n+static uint16_t g_mapport_external_port = 0;\n+static bool NatpmpInit(natpmp_t* natpmp)\n+{\n+    const int r_init = initnatpmp(natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r_init == 0) return true;\n+    LogPrintf(\"NAT-PMP: initnatpmp() failed with %d error.\\n\", r_init);\n+    return false;\n+}\n+\n+static bool NatpmpDiscover(natpmp_t* natpmp, struct in_addr& external_ipv4_addr)\n+{\n+    const int r_send = sendpublicaddressrequest(natpmp);\n+    if (r_send == 2 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            external_ipv4_addr = response.pnu.publicaddress.addr;\n+            return true;\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"NAT-PMP: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool NatpmpMapping(natpmp_t* natpmp, const struct in_addr& external_ipv4_addr, uint16_t private_port, bool& external_ip_discovered)\n+{\n+    const uint16_t suggested_external_port = g_mapport_external_port ? g_mapport_external_port : private_port;\n+    const int r_send = sendnewportmappingrequest(natpmp, NATPMP_PROTOCOL_TCP, private_port, suggested_external_port, 3600 /*seconds*/);\n+    if (r_send == 12 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            auto pm = response.pnu.newportmapping;\n+            if (private_port == pm.privateport && pm.lifetime > 0) {\n+                g_mapport_current_proto = MapPortProto::NAT_PMP;\n+                g_mapport_external_port = pm.mappedpublicport;\n+                const CService external{external_ipv4_addr, pm.mappedpublicport};\n+                if (!external_ip_discovered && fDiscover) {\n+                    AddLocal(external, LOCAL_MAPPED);\n+                    external_ip_discovered = true;\n+                }\n+\n+                LogPrintf(\"NAT-PMP: Port mapping successful. External address = %s\\n\", external.ToString());\n+                return true;\n+            } else {\n+                LogPrintf(\"NAT-PMP: Port mapping failed.\\n\");\n+            }\n+\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"NAT-PMP: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool ThreadNatpmp()\n+{\n+    bool ret = false;\n+    natpmp_t natpmp;\n+    struct in_addr external_ipv4_addr;\n+    if (NatpmpInit(&natpmp) && NatpmpDiscover(&natpmp, external_ipv4_addr)) {\n+        bool external_ip_discovered = false;\n+        const uint16_t private_port = GetListenPort();\n+        g_mapport_interrupt.reset();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r382750749",
      "id" : 382750749,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc1MDc0OQ==",
      "original_commit_id" : "dd3229e7af8563c69d26955c4207f73ae1d3bc94",
      "original_line" : 136,
      "original_position" : 136,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : null,
      "pull_request_review_id" : 362846053,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/382750749",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r382751074"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/382751074"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This will exit if it get the interrupt, causing target changes to shut off port mapping entirely.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-21T18:59:02Z",
      "diff_hunk" : "@@ -0,0 +1,322 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <netinet/in.h>\n+#endif // #ifdef WIN32\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif // #ifdef USE_UPNP\n+\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_mapport_interrupt;\n+static std::thread g_mapport_thread;\n+static MapPortProto g_mapport_current_proto = MapPortProto::NONE;\n+static unsigned int g_mapport_target_proto = g_mapport_current_proto;\n+static constexpr auto PORT_MAPPING_REANNOUNCE_PERIOD = std::chrono::minutes(20);\n+static constexpr auto PORT_MAPPING_RETRY_PERIOD = std::chrono::minutes(5);\n+\n+#ifdef USE_NATPMP\n+static uint16_t g_mapport_external_port = 0;\n+static bool NatpmpInit(natpmp_t* natpmp)\n+{\n+    const int r_init = initnatpmp(natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r_init == 0) return true;\n+    LogPrintf(\"NAT-PMP: initnatpmp() failed with %d error.\\n\", r_init);\n+    return false;\n+}\n+\n+static bool NatpmpDiscover(natpmp_t* natpmp, struct in_addr& external_ipv4_addr)\n+{\n+    const int r_send = sendpublicaddressrequest(natpmp);\n+    if (r_send == 2 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            external_ipv4_addr = response.pnu.publicaddress.addr;\n+            return true;\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"NAT-PMP: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool NatpmpMapping(natpmp_t* natpmp, const struct in_addr& external_ipv4_addr, uint16_t private_port, bool& external_ip_discovered)\n+{\n+    const uint16_t suggested_external_port = g_mapport_external_port ? g_mapport_external_port : private_port;\n+    const int r_send = sendnewportmappingrequest(natpmp, NATPMP_PROTOCOL_TCP, private_port, suggested_external_port, 3600 /*seconds*/);\n+    if (r_send == 12 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            auto pm = response.pnu.newportmapping;\n+            if (private_port == pm.privateport && pm.lifetime > 0) {\n+                g_mapport_current_proto = MapPortProto::NAT_PMP;\n+                g_mapport_external_port = pm.mappedpublicport;\n+                const CService external{external_ipv4_addr, pm.mappedpublicport};\n+                if (!external_ip_discovered && fDiscover) {\n+                    AddLocal(external, LOCAL_MAPPED);\n+                    external_ip_discovered = true;\n+                }\n+\n+                LogPrintf(\"NAT-PMP: Port mapping successful. External address = %s\\n\", external.ToString());\n+                return true;\n+            } else {\n+                LogPrintf(\"NAT-PMP: Port mapping failed.\\n\");\n+            }\n+\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"NAT-PMP: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool ThreadNatpmp()\n+{\n+    bool ret = false;\n+    natpmp_t natpmp;\n+    struct in_addr external_ipv4_addr;\n+    if (NatpmpInit(&natpmp) && NatpmpDiscover(&natpmp, external_ipv4_addr)) {\n+        bool external_ip_discovered = false;\n+        const uint16_t private_port = GetListenPort();\n+        g_mapport_interrupt.reset();\n+        do {\n+            ret = NatpmpMapping(&natpmp, external_ipv4_addr, private_port, external_ip_discovered);\n+        } while (ret && g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+\n+        const int r_send = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, private_port, g_mapport_external_port, /* remove a port mapping */ 0);\n+        g_mapport_external_port = 0;\n+        if (r_send == 12 /* OK */) {\n+            LogPrintf(\"NAT-PMP: Port mapping removed successfully.\\n\");\n+        } else {\n+            LogPrintf(\"NAT-PMP: sendnewportmappingrequest(0) failed with %d error.\\n\", r_send);\n+        }\n+    }\n+\n+    closenatpmp(&natpmp);\n+    return ret;\n+}\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+static bool ThreadUpnp()\n+{\n+    bool ret = false;\n+    std::string port = strprintf(\"%u\", GetListenPort());\n+    const char * multicastif = nullptr;\n+    const char * minissdpdpath = nullptr;\n+    struct UPNPDev * devlist = nullptr;\n+    char lanaddr[64];\n+\n+    int error = 0;\n+#if MINIUPNPC_API_VERSION < 14\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, &error);\n+#else\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, 2, &error);\n+#endif\n+\n+    struct UPNPUrls urls;\n+    struct IGDdatas data;\n+    int r;\n+\n+    r = UPNP_GetValidIGD(devlist, &urls, &data, lanaddr, sizeof(lanaddr));\n+    if (r == 1)\n+    {\n+        if (fDiscover) {\n+            char externalIPAddress[40];\n+            r = UPNP_GetExternalIPAddress(urls.controlURL, data.first.servicetype, externalIPAddress);\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"UPnP: GetExternalIPAddress() returned %d\\n\", r);\n+            } else {\n+                if (externalIPAddress[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(externalIPAddress, resolved, false)) {\n+                        LogPrintf(\"UPnP: ExternalIPAddress = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"UPnP: GetExternalIPAddress failed.\\n\");\n+                }\n+            }\n+        }\n+\n+        std::string strDesc = PACKAGE_NAME \" \" + FormatFullVersion();\n+\n+        g_mapport_interrupt.reset();\n+        do {\n+            r = UPNP_AddPortMapping(urls.controlURL, data.first.servicetype, port.c_str(), port.c_str(), lanaddr, strDesc.c_str(), \"TCP\", 0, \"0\");\n+\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                ret = false;\n+                LogPrintf(\"AddPortMapping(%s, %s, %s) failed with code %d (%s)\\n\", port, port, lanaddr, r, strupnperror(r));\n+                break;\n+            } else {\n+                ret = true;\n+                g_mapport_current_proto = MapPortProto::UPNP;\n+                LogPrintf(\"UPnP Port Mapping successful.\\n\");\n+            }\n+        } while (g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+\n+        r = UPNP_DeletePortMapping(urls.controlURL, data.first.servicetype, port.c_str(), \"TCP\", 0);\n+        LogPrintf(\"UPNP_DeletePortMapping() returned: %d\\n\", r);\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        FreeUPNPUrls(&urls);\n+    } else {\n+        LogPrintf(\"No valid UPnP IGDs found\\n\");\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        if (r != 0)\n+            FreeUPNPUrls(&urls);\n+    }\n+\n+    return ret;\n+}\n+#endif // #ifdef USE_UPNP\n+\n+static void ThreadMapPort()\n+{\n+    bool ok;\n+    do {\n+        ok = false;\n+\n+#ifdef USE_NATPMP\n+        if (g_mapport_target_proto & MapPortProto::NAT_PMP) {\n+            ok = ThreadNatpmp();\n+            if (ok) continue;\n+        }\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+        if (g_mapport_target_proto & MapPortProto::UPNP) {\n+            ok = ThreadUpnp();\n+            if (ok) continue;\n+        }\n+#endif // #ifdef USE_UPNP\n+\n+        if (g_mapport_target_proto == MapPortProto::NONE) {\n+            g_mapport_current_proto = MapPortProto::NONE;\n+            return;\n+        }\n+\n+    } while (ok || g_mapport_interrupt.sleep_for(PORT_MAPPING_RETRY_PERIOD));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r382751074",
      "id" : 382751074,
      "line" : 251,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc1MTA3NA==",
      "original_commit_id" : "dd3229e7af8563c69d26955c4207f73ae1d3bc94",
      "original_line" : 251,
      "original_position" : 254,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : 251,
      "pull_request_review_id" : 362846053,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/382751074",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Re NAT-PMP preference: Also, with the port number changing every startup, it will be hard for peers to reconnect or meaningfully pass on addr messages for you...\r\n\r\nI think cd7a0f689c5 should get split up. It's too hard to follow what it's doing.",
      "created_at" : "2020-02-21T19:01:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-589789757",
      "id" : 589789757,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4OTc4OTc1Nw==",
      "updated_at" : "2020-02-21T19:01:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/589789757",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Re NAT-PMP preference: Also, with the port number changing every startup, it will be hard for peers to reconnect or meaningfully pass on addr messages for you...\r\n\r\nOnly [`natpmpd`](https://github.com/bodgit/natpmpd) on OpenBSD will change external port number on every startup.\r\n[`miniupnpd`](https://github.com/miniupnp/miniupnp/tree/master/miniupnpd) assigns suggested one, i.e. 8333.",
      "created_at" : "2020-02-22T08:43:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-589933497",
      "id" : 589933497,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4OTkzMzQ5Nw==",
      "updated_at" : "2020-02-22T08:43:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/589933497",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r382904239"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/382904239"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If the protocol switch is initiated by a user, the `g_mapport_interrupt()` call will end the internal protocol-specific loop in the `ThreadNatpmp()` or in the `ThreadUpnp()`, `ok == true` and `g_mapport_interrupt.sleep_for(PORT_MAPPING_RETRY_PERIOD)` will not call at all.\r\n\r\nIf the protocol switch is initiated by a protocol failure, `ok == false` and `g_mapport_interrupt.sleep_for(PORT_MAPPING_RETRY_PERIOD)` will behave as intended.\r\n\r\nSetting `g_mapport_target_proto` variable to `MapPortProto::NONE` also causes shutting off port mapping entirely.\r\n\r\n",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-22T10:51:02Z",
      "diff_hunk" : "@@ -0,0 +1,322 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <netinet/in.h>\n+#endif // #ifdef WIN32\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif // #ifdef USE_UPNP\n+\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_mapport_interrupt;\n+static std::thread g_mapport_thread;\n+static MapPortProto g_mapport_current_proto = MapPortProto::NONE;\n+static unsigned int g_mapport_target_proto = g_mapport_current_proto;\n+static constexpr auto PORT_MAPPING_REANNOUNCE_PERIOD = std::chrono::minutes(20);\n+static constexpr auto PORT_MAPPING_RETRY_PERIOD = std::chrono::minutes(5);\n+\n+#ifdef USE_NATPMP\n+static uint16_t g_mapport_external_port = 0;\n+static bool NatpmpInit(natpmp_t* natpmp)\n+{\n+    const int r_init = initnatpmp(natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r_init == 0) return true;\n+    LogPrintf(\"NAT-PMP: initnatpmp() failed with %d error.\\n\", r_init);\n+    return false;\n+}\n+\n+static bool NatpmpDiscover(natpmp_t* natpmp, struct in_addr& external_ipv4_addr)\n+{\n+    const int r_send = sendpublicaddressrequest(natpmp);\n+    if (r_send == 2 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            external_ipv4_addr = response.pnu.publicaddress.addr;\n+            return true;\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"NAT-PMP: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool NatpmpMapping(natpmp_t* natpmp, const struct in_addr& external_ipv4_addr, uint16_t private_port, bool& external_ip_discovered)\n+{\n+    const uint16_t suggested_external_port = g_mapport_external_port ? g_mapport_external_port : private_port;\n+    const int r_send = sendnewportmappingrequest(natpmp, NATPMP_PROTOCOL_TCP, private_port, suggested_external_port, 3600 /*seconds*/);\n+    if (r_send == 12 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            auto pm = response.pnu.newportmapping;\n+            if (private_port == pm.privateport && pm.lifetime > 0) {\n+                g_mapport_current_proto = MapPortProto::NAT_PMP;\n+                g_mapport_external_port = pm.mappedpublicport;\n+                const CService external{external_ipv4_addr, pm.mappedpublicport};\n+                if (!external_ip_discovered && fDiscover) {\n+                    AddLocal(external, LOCAL_MAPPED);\n+                    external_ip_discovered = true;\n+                }\n+\n+                LogPrintf(\"NAT-PMP: Port mapping successful. External address = %s\\n\", external.ToString());\n+                return true;\n+            } else {\n+                LogPrintf(\"NAT-PMP: Port mapping failed.\\n\");\n+            }\n+\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"NAT-PMP: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool ThreadNatpmp()\n+{\n+    bool ret = false;\n+    natpmp_t natpmp;\n+    struct in_addr external_ipv4_addr;\n+    if (NatpmpInit(&natpmp) && NatpmpDiscover(&natpmp, external_ipv4_addr)) {\n+        bool external_ip_discovered = false;\n+        const uint16_t private_port = GetListenPort();\n+        g_mapport_interrupt.reset();\n+        do {\n+            ret = NatpmpMapping(&natpmp, external_ipv4_addr, private_port, external_ip_discovered);\n+        } while (ret && g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+\n+        const int r_send = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, private_port, g_mapport_external_port, /* remove a port mapping */ 0);\n+        g_mapport_external_port = 0;\n+        if (r_send == 12 /* OK */) {\n+            LogPrintf(\"NAT-PMP: Port mapping removed successfully.\\n\");\n+        } else {\n+            LogPrintf(\"NAT-PMP: sendnewportmappingrequest(0) failed with %d error.\\n\", r_send);\n+        }\n+    }\n+\n+    closenatpmp(&natpmp);\n+    return ret;\n+}\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+static bool ThreadUpnp()\n+{\n+    bool ret = false;\n+    std::string port = strprintf(\"%u\", GetListenPort());\n+    const char * multicastif = nullptr;\n+    const char * minissdpdpath = nullptr;\n+    struct UPNPDev * devlist = nullptr;\n+    char lanaddr[64];\n+\n+    int error = 0;\n+#if MINIUPNPC_API_VERSION < 14\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, &error);\n+#else\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, 2, &error);\n+#endif\n+\n+    struct UPNPUrls urls;\n+    struct IGDdatas data;\n+    int r;\n+\n+    r = UPNP_GetValidIGD(devlist, &urls, &data, lanaddr, sizeof(lanaddr));\n+    if (r == 1)\n+    {\n+        if (fDiscover) {\n+            char externalIPAddress[40];\n+            r = UPNP_GetExternalIPAddress(urls.controlURL, data.first.servicetype, externalIPAddress);\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"UPnP: GetExternalIPAddress() returned %d\\n\", r);\n+            } else {\n+                if (externalIPAddress[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(externalIPAddress, resolved, false)) {\n+                        LogPrintf(\"UPnP: ExternalIPAddress = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"UPnP: GetExternalIPAddress failed.\\n\");\n+                }\n+            }\n+        }\n+\n+        std::string strDesc = PACKAGE_NAME \" \" + FormatFullVersion();\n+\n+        g_mapport_interrupt.reset();\n+        do {\n+            r = UPNP_AddPortMapping(urls.controlURL, data.first.servicetype, port.c_str(), port.c_str(), lanaddr, strDesc.c_str(), \"TCP\", 0, \"0\");\n+\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                ret = false;\n+                LogPrintf(\"AddPortMapping(%s, %s, %s) failed with code %d (%s)\\n\", port, port, lanaddr, r, strupnperror(r));\n+                break;\n+            } else {\n+                ret = true;\n+                g_mapport_current_proto = MapPortProto::UPNP;\n+                LogPrintf(\"UPnP Port Mapping successful.\\n\");\n+            }\n+        } while (g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+\n+        r = UPNP_DeletePortMapping(urls.controlURL, data.first.servicetype, port.c_str(), \"TCP\", 0);\n+        LogPrintf(\"UPNP_DeletePortMapping() returned: %d\\n\", r);\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        FreeUPNPUrls(&urls);\n+    } else {\n+        LogPrintf(\"No valid UPnP IGDs found\\n\");\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        if (r != 0)\n+            FreeUPNPUrls(&urls);\n+    }\n+\n+    return ret;\n+}\n+#endif // #ifdef USE_UPNP\n+\n+static void ThreadMapPort()\n+{\n+    bool ok;\n+    do {\n+        ok = false;\n+\n+#ifdef USE_NATPMP\n+        if (g_mapport_target_proto & MapPortProto::NAT_PMP) {\n+            ok = ThreadNatpmp();\n+            if (ok) continue;\n+        }\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+        if (g_mapport_target_proto & MapPortProto::UPNP) {\n+            ok = ThreadUpnp();\n+            if (ok) continue;\n+        }\n+#endif // #ifdef USE_UPNP\n+\n+        if (g_mapport_target_proto == MapPortProto::NONE) {\n+            g_mapport_current_proto = MapPortProto::NONE;\n+            return;\n+        }\n+\n+    } while (ok || g_mapport_interrupt.sleep_for(PORT_MAPPING_RETRY_PERIOD));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r382904239",
      "id" : 382904239,
      "in_reply_to_id" : 382751074,
      "line" : 251,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjkwNDIzOQ==",
      "original_commit_id" : "dd3229e7af8563c69d26955c4207f73ae1d3bc94",
      "original_line" : 251,
      "original_position" : 254,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : 251,
      "pull_request_review_id" : 363022932,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/382904239",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Yes, but UPnP is reliably using the same/requested port if it works.",
      "created_at" : "2020-02-22T16:00:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-589969568",
      "id" : 589969568,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4OTk2OTU2OA==",
      "updated_at" : "2020-02-22T16:00:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/589969568",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Updated dd3229e7af8563c69d26955c4207f73ae1d3bc94 -> d9ecda8fa0ebce5b6da972691b19f4425164ae43 ([pr18077.11](https://github.com/hebasto/bitcoin/commits/pr18077.11) -> [pr18077.12](https://github.com/hebasto/bitcoin/commits/pr18077.12), [compare](https://github.com/hebasto/bitcoin/compare/pr18077.11..pr18077.12)):\r\n\r\n- UPnP is prioritized (as @luke-jr suggested)\r\n- a note about possible random external port number is added to the NAT-PMP tooltip\r\n- commits are split and reordered to make review easier, I hope",
      "created_at" : "2020-02-23T01:00:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-590014625",
      "id" : 590014625,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5MDAxNDYyNQ==",
      "updated_at" : "2020-02-23T01:00:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/590014625",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r382954341"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/382954341"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@luke-jr \r\n> This should be reset outside of the protocol-specific functions, or else we could end up with a race.\r\n\r\nLooking into the `CThreadInterrupt` class implementation I couldn't see possibilities for a race.\r\n\r\nWhat did I miss?",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-23T01:08:27Z",
      "diff_hunk" : "@@ -0,0 +1,342 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <netinet/in.h>\n+#endif // #ifdef WIN32\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif // #ifdef USE_UPNP\n+\n+#include <atomic>\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_mapport_interrupt;\n+static std::thread g_mapport_thread;\n+static std::atomic_uint g_mapport_target_proto{MapPortProto::NONE};\n+static std::atomic<MapPortProto> g_mapport_current_proto{MapPortProto::NONE};\n+static constexpr auto PORT_MAPPING_REANNOUNCE_PERIOD = std::chrono::minutes(20);\n+static constexpr auto PORT_MAPPING_RETRY_PERIOD = std::chrono::minutes(5);\n+\n+#ifdef USE_NATPMP\n+static uint16_t g_mapport_external_port = 0;\n+static bool NatpmpInit(natpmp_t* natpmp)\n+{\n+    const int r_init = initnatpmp(natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r_init == 0) return true;\n+    LogPrintf(\"NAT-PMP: initnatpmp() failed with %d error.\\n\", r_init);\n+    return false;\n+}\n+\n+static bool NatpmpDiscover(natpmp_t* natpmp, struct in_addr& external_ipv4_addr)\n+{\n+    const int r_send = sendpublicaddressrequest(natpmp);\n+    if (r_send == 2 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            external_ipv4_addr = response.pnu.publicaddress.addr;\n+            return true;\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"NAT-PMP: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool NatpmpMapping(natpmp_t* natpmp, const struct in_addr& external_ipv4_addr, uint16_t private_port, bool& external_ip_discovered)\n+{\n+    const uint16_t suggested_external_port = g_mapport_external_port ? g_mapport_external_port : private_port;\n+    const int r_send = sendnewportmappingrequest(natpmp, NATPMP_PROTOCOL_TCP, private_port, suggested_external_port, 3600 /*seconds*/);\n+    if (r_send == 12 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            auto pm = response.pnu.newportmapping;\n+            if (private_port == pm.privateport && pm.lifetime > 0) {\n+                g_mapport_external_port = pm.mappedpublicport;\n+                const CService external{external_ipv4_addr, pm.mappedpublicport};\n+                if (!external_ip_discovered && fDiscover) {\n+                    AddLocal(external, LOCAL_MAPPED);\n+                    external_ip_discovered = true;\n+                }\n+\n+                LogPrintf(\"NAT-PMP: Port mapping successful. External address = %s\\n\", external.ToString());\n+                return true;\n+            } else {\n+                LogPrintf(\"NAT-PMP: Port mapping failed.\\n\");\n+            }\n+\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"NAT-PMP: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool ThreadNatpmp()\n+{\n+    bool ret = false;\n+    natpmp_t natpmp;\n+    struct in_addr external_ipv4_addr;\n+    if (NatpmpInit(&natpmp) && NatpmpDiscover(&natpmp, external_ipv4_addr)) {\n+        bool external_ip_discovered = false;\n+        const uint16_t private_port = GetListenPort();\n+        do {\n+            ret = NatpmpMapping(&natpmp, external_ipv4_addr, private_port, external_ip_discovered);\n+        } while (ret && g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+        g_mapport_interrupt.reset();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r382954341",
      "id" : 382954341,
      "line" : 133,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk1NDM0MQ==",
      "original_commit_id" : "d9ecda8fa0ebce5b6da972691b19f4425164ae43",
      "original_line" : 133,
      "original_position" : 139,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : 133,
      "pull_request_review_id" : 363059461,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/382954341",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r382957249"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/382957249"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This name is way too vague...",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-23T02:11:59Z",
      "diff_hunk" : "@@ -115,14 +117,39 @@ static void ThreadMapPort()\n     } while (g_upnp_interrupt.sleep_for(PORT_MAPPING_RETRY_PERIOD));\n }\n \n-void StartMapPort()\n+void StartThread()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r382957249",
      "id" : 382957249,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk1NzI0OQ==",
      "original_commit_id" : "acb567e3eecf3e63e629c4bffca2124462142352",
      "original_line" : 120,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : null,
      "pull_request_review_id" : 363061187,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/382957249",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r382957368"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/382957368"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`enum class`",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-23T02:14:54Z",
      "diff_hunk" : "@@ -12,7 +12,12 @@ static const bool DEFAULT_UPNP = USE_UPNP;\n static const bool DEFAULT_UPNP = false;\n #endif\n \n-void StartMapPort();\n+enum MapPortProto : unsigned int {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r382957368",
      "id" : 382957368,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk1NzM2OA==",
      "original_commit_id" : "acb567e3eecf3e63e629c4bffca2124462142352",
      "original_line" : 15,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/mapport.h",
      "position" : null,
      "pull_request_review_id" : 363061187,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/382957368",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r382959771"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/382959771"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Are we sure the settings are changed *before* the signal? Or could it be in parallel and therefore a race?",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-23T03:09:27Z",
      "diff_hunk" : "@@ -50,6 +51,10 @@ OptionsDialog::OptionsDialog(QWidget *parent, bool enableWallet) :\n #ifndef USE_UPNP\n     ui->mapPortUpnp->setEnabled(false);\n #endif\n+    connect(this, &QDialog::accepted, [this](){\n+        QSettings settings;\n+        model->node().mapPort(settings.value(\"fUseUPnP\").toBool());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r382959771",
      "id" : 382959771,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk1OTc3MQ==",
      "original_commit_id" : "2b0ba0cfe41a1260c75497114e5932d2b9da0d1c",
      "original_line" : 56,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/qt/optionsdialog.cpp",
      "position" : null,
      "pull_request_review_id" : 363061187,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/382959771",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r383034794"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/383034794"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Pretty sure `a?b:c` requires `b` and `c` to have the same type.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-23T20:14:40Z",
      "diff_hunk" : "@@ -447,7 +447,12 @@ void SetupServerArgs()\n #endif\n #else\n     hidden_args.emplace_back(\"-upnp\");\n-#endif\n+#endif // #ifdef USE_UPNP\n+#ifdef USE_NATPMP\n+    gArgs.AddArg(\"-natpmp\", strprintf(\"Use NAT-PMP to map the listening port (default: %s)\", DEFAULT_NATPMP ? \"1 when listening and no -proxy\" : 0), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r383034794",
      "id" : 383034794,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzAzNDc5NA==",
      "original_commit_id" : "de19f109c77790c06a3b92527a4780aa5d11b532",
      "original_line" : 452,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 363061187,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/383034794",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r383035036"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/383035036"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Pretty sure `a?b:c` requires `b` and `c` to have the same type.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-23T20:18:07Z",
      "diff_hunk" : "@@ -447,7 +447,12 @@ void SetupServerArgs()\n #endif\n #else\n     hidden_args.emplace_back(\"-upnp\");\n-#endif\n+#endif // #ifdef USE_UPNP\n+#ifdef USE_NATPMP\n+    gArgs.AddArg(\"-natpmp\", strprintf(\"Use NAT-PMP to map the listening port (default: %s)\", DEFAULT_NATPMP ? \"1 when listening and no -proxy\" : 0), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r383035036",
      "id" : 383035036,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzAzNTAzNg==",
      "original_commit_id" : "de19f109c77790c06a3b92527a4780aa5d11b532",
      "original_line" : 452,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 363061187,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/383035036",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r383494027"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/383494027"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> This name is way too vague...\r\n\r\nYeah... I'm not good at choosing English names, and will appreciate your suggestion.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-24T20:23:07Z",
      "diff_hunk" : "@@ -115,14 +117,39 @@ static void ThreadMapPort()\n     } while (g_upnp_interrupt.sleep_for(PORT_MAPPING_RETRY_PERIOD));\n }\n \n-void StartMapPort()\n+void StartThread()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r383494027",
      "id" : 383494027,
      "in_reply_to_id" : 382957249,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ5NDAyNw==",
      "original_commit_id" : "acb567e3eecf3e63e629c4bffca2124462142352",
      "original_line" : 120,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : null,
      "pull_request_review_id" : 363675606,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/383494027",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r383496750"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/383496750"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It will require to define bitwise operators which are used here:\r\nhttps://github.com/bitcoin/bitcoin/blob/d9ecda8fa0ebce5b6da972691b19f4425164ae43/src/mapport.cpp#L297-L304\r\n\r\nMaybe in follow-up?",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-24T20:29:09Z",
      "diff_hunk" : "@@ -12,7 +12,12 @@ static const bool DEFAULT_UPNP = USE_UPNP;\n static const bool DEFAULT_UPNP = false;\n #endif\n \n-void StartMapPort();\n+enum MapPortProto : unsigned int {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r383496750",
      "id" : 383496750,
      "in_reply_to_id" : 382957368,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ5Njc1MA==",
      "original_commit_id" : "acb567e3eecf3e63e629c4bffca2124462142352",
      "original_line" : 15,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/mapport.h",
      "position" : null,
      "pull_request_review_id" : 363678930,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/383496750",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r383498346"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/383498346"
         }
      },
      "author_association" : "MEMBER",
      "body" : "StartThreadMapPort maybe",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-24T20:32:51Z",
      "diff_hunk" : "@@ -115,14 +117,39 @@ static void ThreadMapPort()\n     } while (g_upnp_interrupt.sleep_for(PORT_MAPPING_RETRY_PERIOD));\n }\n \n-void StartMapPort()\n+void StartThread()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r383498346",
      "id" : 383498346,
      "in_reply_to_id" : 382957249,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ5ODM0Ng==",
      "original_commit_id" : "acb567e3eecf3e63e629c4bffca2124462142352",
      "original_line" : 120,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : null,
      "pull_request_review_id" : 363680997,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/383498346",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r383571052"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/383571052"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I wish there was a C++ standard QFlags...",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-24T23:15:27Z",
      "diff_hunk" : "@@ -12,7 +12,12 @@ static const bool DEFAULT_UPNP = USE_UPNP;\n static const bool DEFAULT_UPNP = false;\n #endif\n \n-void StartMapPort();\n+enum MapPortProto : unsigned int {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r383571052",
      "id" : 383571052,
      "in_reply_to_id" : 382957368,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU3MTA1Mg==",
      "original_commit_id" : "acb567e3eecf3e63e629c4bffca2124462142352",
      "original_line" : 15,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/mapport.h",
      "position" : null,
      "pull_request_review_id" : 363769445,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/383571052",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r383889887"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/383889887"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Are we sure the settings are changed _before_ the signal? Or could it be in parallel and therefore a race?\r\n\r\nYes, we are. Please consider the following slot:\r\nhttps://github.com/bitcoin/bitcoin/blob/d9ecda8fa0ebce5b6da972691b19f4425164ae43/src/qt/optionsdialog.cpp#L284-L289\r\n\r\nAll changes are submitted to the model in the `mapper->submit()` call _before_ the `QDialog::accepted()` signal is emitted when the dialog has been accepted by calling `accept()`.\r\n\r\nThen the following connection:\r\nhttps://github.com/bitcoin/bitcoin/blob/d9ecda8fa0ebce5b6da972691b19f4425164ae43/src/qt/optionsdialog.cpp#L57-L60\r\ndoes its work.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-25T13:51:23Z",
      "diff_hunk" : "@@ -50,6 +51,10 @@ OptionsDialog::OptionsDialog(QWidget *parent, bool enableWallet) :\n #ifndef USE_UPNP\n     ui->mapPortUpnp->setEnabled(false);\n #endif\n+    connect(this, &QDialog::accepted, [this](){\n+        QSettings settings;\n+        model->node().mapPort(settings.value(\"fUseUPnP\").toBool());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r383889887",
      "id" : 383889887,
      "in_reply_to_id" : 382959771,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzg4OTg4Nw==",
      "original_commit_id" : "2b0ba0cfe41a1260c75497114e5932d2b9da0d1c",
      "original_line" : 56,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/qt/optionsdialog.cpp",
      "position" : null,
      "pull_request_review_id" : 364154273,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/383889887",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Updated d9ecda8fa0ebce5b6da972691b19f4425164ae43 -> 405e85c61a6690ff2f7159c51715fdbafcbf2b1e ([pr18077.12](https://github.com/hebasto/bitcoin/commits/pr18077.12) -> [pr18077.13](https://github.com/hebasto/bitcoin/commits/pr18077.13), [compare](https://github.com/hebasto/bitcoin/compare/pr18077.12..pr18077.13)):\r\n\r\n- `StartThread()` renamed to `StartThreadMapPort()` (as @luke-jr [suggested)](https://github.com/bitcoin/bitcoin/pull/18077#discussion_r383498346)\r\n- conditional operator argument types are the same now (https://github.com/bitcoin/bitcoin/pull/18077#discussion_r383034794)\r\n- renamed `MapPortProto` enum to `MapPortProtoFlag` and `g_mapport_target_proto` to `g_mapport_enabled_protos` for better semantics",
      "created_at" : "2020-02-25T17:27:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-590977043",
      "id" : 590977043,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5MDk3NzA0Mw==",
      "updated_at" : "2020-02-25T17:27:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/590977043",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r384020701"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/384020701"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-25T17:30:00Z",
      "diff_hunk" : "@@ -447,7 +447,12 @@ void SetupServerArgs()\n #endif\n #else\n     hidden_args.emplace_back(\"-upnp\");\n-#endif\n+#endif // #ifdef USE_UPNP\n+#ifdef USE_NATPMP\n+    gArgs.AddArg(\"-natpmp\", strprintf(\"Use NAT-PMP to map the listening port (default: %s)\", DEFAULT_NATPMP ? \"1 when listening and no -proxy\" : 0), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r384020701",
      "id" : 384020701,
      "in_reply_to_id" : 383034794,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDAyMDcwMQ==",
      "original_commit_id" : "de19f109c77790c06a3b92527a4780aa5d11b532",
      "original_line" : 452,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 364318059,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/384020701",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r384020937"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/384020937"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-25T17:30:24Z",
      "diff_hunk" : "@@ -447,7 +447,12 @@ void SetupServerArgs()\n #endif\n #else\n     hidden_args.emplace_back(\"-upnp\");\n-#endif\n+#endif // #ifdef USE_UPNP\n+#ifdef USE_NATPMP\n+    gArgs.AddArg(\"-natpmp\", strprintf(\"Use NAT-PMP to map the listening port (default: %s)\", DEFAULT_NATPMP ? \"1 when listening and no -proxy\" : 0), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r384020937",
      "id" : 384020937,
      "in_reply_to_id" : 383035036,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDAyMDkzNw==",
      "original_commit_id" : "de19f109c77790c06a3b92527a4780aa5d11b532",
      "original_line" : 452,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 364318333,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/384020937",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r384021154"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/384021154"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-25T17:30:44Z",
      "diff_hunk" : "@@ -115,14 +117,39 @@ static void ThreadMapPort()\n     } while (g_upnp_interrupt.sleep_for(PORT_MAPPING_RETRY_PERIOD));\n }\n \n-void StartMapPort()\n+void StartThread()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r384021154",
      "id" : 384021154,
      "in_reply_to_id" : 382957249,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDAyMTE1NA==",
      "original_commit_id" : "acb567e3eecf3e63e629c4bffca2124462142352",
      "original_line" : 120,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : null,
      "pull_request_review_id" : 364318559,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/384021154",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r384206803"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/384206803"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit \"refactor: Move port mapping code to own files\"\r\n\r\nNit: when you're copying/moving code, retain the copyright years of the original code.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-26T00:17:15Z",
      "diff_hunk" : "@@ -0,0 +1,137 @@\n+// Copyright (c) 2020 The Bitcoin Core developers",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r384206803",
      "id" : 384206803,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDIwNjgwMw==",
      "original_commit_id" : "f93e76ad1bb37f8c3b770312c48e7955128bab65",
      "original_line" : 1,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : null,
      "pull_request_review_id" : 364543841,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/384206803",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r384207039"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/384207039"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit \"net: Keep trying to use UPnP when -upnp=1\"\r\n\r\nThis is confusingly named when it isn't actually a thread on its own anymore.\r\n",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-26T00:17:59Z",
      "diff_hunk" : "@@ -35,9 +35,11 @@ static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\"\n static CThreadInterrupt g_upnp_interrupt;\n static std::thread g_upnp_thread;\n static constexpr auto PORT_MAPPING_REANNOUNCE_PERIOD = std::chrono::minutes(20);\n+static constexpr auto PORT_MAPPING_RETRY_PERIOD = std::chrono::minutes(5);\n \n-static void ThreadMapPort()\n+static bool ThreadUpnp()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r384207039",
      "id" : 384207039,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDIwNzAzOQ==",
      "original_commit_id" : "9945c2e19311c3b566050cf7adb0864ed1620c79",
      "original_line" : 40,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : null,
      "pull_request_review_id" : 364543841,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/384207039",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r384310915"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/384310915"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The UPnP support code has been added in 2011 (see #133).\r\nIs it correct to retain pre-2011 copyright years?\r\n\r\nCould it be \"2011-2020\" in new files?",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-26T07:22:56Z",
      "diff_hunk" : "@@ -0,0 +1,137 @@\n+// Copyright (c) 2020 The Bitcoin Core developers",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r384310915",
      "id" : 384310915,
      "in_reply_to_id" : 384206803,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMxMDkxNQ==",
      "original_commit_id" : "f93e76ad1bb37f8c3b770312c48e7955128bab65",
      "original_line" : 1,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : null,
      "pull_request_review_id" : 364667484,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/384310915",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Updated 405e85c61a6690ff2f7159c51715fdbafcbf2b1e -> 4e7b9f03b8a3dd02bc9831e77905a8022770c846 ([pr18077.13](https://github.com/hebasto/bitcoin/commits/pr18077.13) -> [pr18077.14](https://github.com/hebasto/bitcoin/commits/pr18077.14), [compare](https://github.com/hebasto/bitcoin/compare/pr18077.13..pr18077.14)):\r\n\r\n- corrected copyright years as @sipa [suggested](https://github.com/bitcoin/bitcoin/pull/18077#discussion_r384206803)\r\n- both `ThreadUpnp()` and `ThreadNatpmp()` renamed to `ProcessUpnp()` and `ProcessNatpmp()` respectively (see @sipa's [comment](https://github.com/bitcoin/bitcoin/pull/18077#discussion_r384207039))\r\n- removed extra parens (thanks to @Empact; see https://github.com/bitcoin/bitcoin/pull/12381#discussion_r167062893)",
      "created_at" : "2020-02-26T07:45:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-591285675",
      "id" : 591285675,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5MTI4NTY3NQ==",
      "updated_at" : "2020-02-26T07:45:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/591285675",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r384318840"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/384318840"
         }
      },
      "author_association" : "MEMBER",
      "body" : "See the latest [push](https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-591285675).",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-26T07:46:46Z",
      "diff_hunk" : "@@ -0,0 +1,137 @@\n+// Copyright (c) 2020 The Bitcoin Core developers",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r384318840",
      "id" : 384318840,
      "in_reply_to_id" : 384206803,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMxODg0MA==",
      "original_commit_id" : "f93e76ad1bb37f8c3b770312c48e7955128bab65",
      "original_line" : 1,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : null,
      "pull_request_review_id" : 364677293,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/384318840",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r384318974"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/384318974"
         }
      },
      "author_association" : "MEMBER",
      "body" : "[Renamed](https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-591285675).",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-02-26T07:47:09Z",
      "diff_hunk" : "@@ -35,9 +35,11 @@ static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\"\n static CThreadInterrupt g_upnp_interrupt;\n static std::thread g_upnp_thread;\n static constexpr auto PORT_MAPPING_REANNOUNCE_PERIOD = std::chrono::minutes(20);\n+static constexpr auto PORT_MAPPING_RETRY_PERIOD = std::chrono::minutes(5);\n \n-static void ThreadMapPort()\n+static bool ThreadUpnp()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r384318974",
      "id" : 384318974,
      "in_reply_to_id" : 384207039,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMxODk3NA==",
      "original_commit_id" : "9945c2e19311c3b566050cf7adb0864ed1620c79",
      "original_line" : 40,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : null,
      "pull_request_review_id" : 364677480,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/384318974",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2020-03-01T22:05:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-593151561",
      "id" : 593151561,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5MzE1MTU2MQ==",
      "updated_at" : "2020-03-01T22:05:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/593151561",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased after #17399 has been merged.",
      "created_at" : "2020-03-03T15:29:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-594010099",
      "id" : 594010099,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5NDAxMDA5OQ==",
      "updated_at" : "2020-03-03T15:29:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/594010099",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/fa733bbd78add587e19f0175ab9c127a8c27e024/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-03-10T13:54:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-597098216",
      "id" : 597098216,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5NzA5ODIxNg==",
      "updated_at" : "2020-03-10T13:54:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/597098216",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased due to the conflict with merged #18264.",
      "created_at" : "2020-03-11T16:12:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-597724976",
      "id" : 597724976,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5NzcyNDk3Ng==",
      "updated_at" : "2020-03-11T16:12:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/597724976",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-03-25T19:47:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-604048846",
      "id" : 604048846,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwNDA0ODg0Ng==",
      "updated_at" : "2020-03-25T19:47:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/604048846",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased 4be5c3c72d98b616367d1aa3de22702e6f9f81ee -> 1bf61f0557637b5bedd670a4fba7bb11bf42ac6a due to the conflicts with #18134 and #18438.",
      "created_at" : "2020-03-28T18:50:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-605503139",
      "id" : 605503139,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwNTUwMzEzOQ==",
      "updated_at" : "2020-03-28T18:50:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/605503139",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-04-06T02:10:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-609530476",
      "id" : 609530476,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwOTUzMDQ3Ng==",
      "updated_at" : "2020-04-06T02:10:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/609530476",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased 1bf61f0557637b5bedd670a4fba7bb11bf42ac6a -> 607144bab1aecb8b970e17aeb145d62175d58c4c ([pr18077.17](https://github.com/hebasto/bitcoin/commits/pr18077.17) -> [pr18077.18](https://github.com/hebasto/bitcoin/commits/pr18077.18)) due to the conflicts with #18514 and #16367.",
      "created_at" : "2020-04-11T13:13:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-612418519",
      "id" : 612418519,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxMjQxODUxOQ==",
      "updated_at" : "2020-04-11T13:13:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/612418519",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased 607144bab1aecb8b970e17aeb145d62175d58c4c -> a388fae1dca9b4983bc95d50d07503aae527f29e ([pr18077.18](https://github.com/hebasto/bitcoin/commits/pr18077.18) -> [pr18077.19](https://github.com/hebasto/bitcoin/commits/pr18077.19)) due to the conflict with #18588.",
      "created_at" : "2020-04-11T14:43:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-612436848",
      "id" : 612436848,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxMjQzNjg0OA==",
      "updated_at" : "2020-04-11T14:43:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/612436848",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-04-15T23:46:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-614334429",
      "id" : 614334429,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxNDMzNDQyOQ==",
      "updated_at" : "2020-04-15T23:46:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/614334429",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased a388fae1dca9b4983bc95d50d07503aae527f29e -> 95e943cb1855dca3ed5fb4fd98b357515d1a3646 ([pr18077.19](https://github.com/hebasto/bitcoin/commits/pr18077.19) -> [pr18077.20](https://github.com/hebasto/bitcoin/commits/pr18077.20)) due to the conflict with #18571.",
      "created_at" : "2020-04-16T16:51:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-614770003",
      "id" : 614770003,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxNDc3MDAwMw==",
      "updated_at" : "2020-04-16T16:51:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/614770003",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-04-20T16:21:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-616660640",
      "id" : 616660640,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxNjY2MDY0MA==",
      "updated_at" : "2020-04-20T16:21:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/616660640",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased 95e943cb1855dca3ed5fb4fd98b357515d1a3646 -> f4a4643712eca819a5b7ed0a143216e06125d1a9 ([pr18077.20](https://github.com/hebasto/bitcoin/commits/pr18077.20) -> [pr18077.21](https://github.com/hebasto/bitcoin/commits/pr18077.21)) due to the conflicts with #18676 and #18705.",
      "created_at" : "2020-04-20T19:10:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-616752414",
      "id" : 616752414,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxNjc1MjQxNA==",
      "updated_at" : "2020-04-20T19:10:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/616752414",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "tACK f4a4643712eca819a5b7ed0a143216e06125d1a9 on Debian 9\r\n\r\n```\r\n2020-05-17T04:14:52Z NAT-PMP: Port mapping successful. External address = [redacted]:8333\r\n2020-05-17T04:22:05Z NAT-PMP: Port mapping removed successfully.\r\n```\r\n\r\nThe port is accessible externally without any other forwarding rules.",
      "created_at" : "2020-05-17T04:28:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-629741483",
      "id" : 629741483,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyOTc0MTQ4Mw==",
      "updated_at" : "2020-05-17T04:30:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/629741483",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/8435003?v=4",
         "events_url" : "https://api.github.com/users/tryphe/events{/privacy}",
         "followers_url" : "https://api.github.com/users/tryphe/followers",
         "following_url" : "https://api.github.com/users/tryphe/following{/other_user}",
         "gists_url" : "https://api.github.com/users/tryphe/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/tryphe",
         "id" : 8435003,
         "login" : "tryphe",
         "node_id" : "MDQ6VXNlcjg0MzUwMDM=",
         "organizations_url" : "https://api.github.com/users/tryphe/orgs",
         "received_events_url" : "https://api.github.com/users/tryphe/received_events",
         "repos_url" : "https://api.github.com/users/tryphe/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/tryphe/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/tryphe/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/tryphe"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-05-19T10:10:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-630723997",
      "id" : 630723997,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMDcyMzk5Nw==",
      "updated_at" : "2020-05-19T10:10:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/630723997",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased f4a4643712eca819a5b7ed0a143216e06125d1a9 -> 2f7a01708482ad9f8fede1d7b7a9d59901370aa1 ([pr18077.21](https://github.com/hebasto/bitcoin/commits/pr18077.21) -> [pr18077.22](https://github.com/hebasto/bitcoin/commits/pr18077.22)) due to the conflict with #19008.",
      "created_at" : "2020-05-19T16:24:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-630930056",
      "id" : 630930056,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMDkzMDA1Ng==",
      "updated_at" : "2020-05-19T16:24:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/630930056",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-05-21T08:02:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-631946436",
      "id" : 631946436,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMTk0NjQzNg==",
      "updated_at" : "2020-05-21T08:02:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/631946436",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased 2f7a01708482ad9f8fede1d7b7a9d59901370aa1 -> f0cf6523c9fb4c3bb0bc64af72cdcadfa7747748 ([pr18077.22](https://github.com/hebasto/bitcoin/commits/pr18077.22) -> [pr18077.23](https://github.com/hebasto/bitcoin/commits/pr18077.23)) due to the conflict with #18677.",
      "created_at" : "2020-05-22T05:33:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-632491960",
      "id" : 632491960,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMjQ5MTk2MA==",
      "updated_at" : "2020-05-22T05:33:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/632491960",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-05-22T11:09:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-632636066",
      "id" : 632636066,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMjYzNjA2Ng==",
      "updated_at" : "2020-05-22T11:09:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/632636066",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased f0cf6523c9fb4c3bb0bc64af72cdcadfa7747748 -> 1b006d618d02eac38bd434937d6d5c42084992bf ([pr18077.23](https://github.com/hebasto/bitcoin/commits/pr18077.23) -> [pr18077.24](https://github.com/hebasto/bitcoin/commits/pr18077.24)) due to the conflict with #19014.",
      "created_at" : "2020-05-22T11:38:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-632647985",
      "id" : 632647985,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMjY0Nzk4NQ==",
      "updated_at" : "2020-05-22T11:38:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/632647985",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-06-03T15:16:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-638264472",
      "id" : 638264472,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzODI2NDQ3Mg==",
      "updated_at" : "2020-06-03T15:16:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/638264472",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased 1b006d618d02eac38bd434937d6d5c42084992bf -> 0692bed243adb8d4f3aa8192e9d1952d1de4a2ad ([pr18077.24](https://github.com/hebasto/bitcoin/commits/pr18077.24) -> [pr18077.25](https://github.com/hebasto/bitcoin/commits/pr18077.25)) due to the conflict with #19041.",
      "created_at" : "2020-06-04T07:09:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-638649592",
      "id" : 638649592,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzODY0OTU5Mg==",
      "updated_at" : "2020-06-04T07:09:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/638649592",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-06-08T12:17:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-640567436",
      "id" : 640567436,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0MDU2NzQzNg==",
      "updated_at" : "2020-06-08T12:17:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/640567436",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased 0692bed243adb8d4f3aa8192e9d1952d1de4a2ad -> 5a29078b373f5ffecb452317a1bd6fb165b08b42 ([pr18077.25](https://github.com/hebasto/bitcoin/commits/pr18077.25) -> [pr18077.26](https://github.com/hebasto/bitcoin/commits/pr18077.26)) due to the conflict with #19180.",
      "created_at" : "2020-06-08T15:06:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-640688912",
      "id" : 640688912,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0MDY4ODkxMg==",
      "updated_at" : "2020-06-08T15:06:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/640688912",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-06-19T17:01:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-646758187",
      "id" : 646758187,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0Njc1ODE4Nw==",
      "updated_at" : "2020-06-19T17:01:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/646758187",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased 5a29078b373f5ffecb452317a1bd6fb165b08b42 -> 570c1060058d7f52286107df217b66d28d0b1f91 ([pr18077.26](https://github.com/hebasto/bitcoin/commits/pr18077.26) -> [pr18077.27](https://github.com/hebasto/bitcoin/commits/pr18077.27)) due to the conflict with #19267.",
      "created_at" : "2020-06-20T08:01:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-646960469",
      "id" : 646960469,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0Njk2MDQ2OQ==",
      "updated_at" : "2020-06-20T08:01:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/646960469",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-07-01T14:26:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-652451330",
      "id" : 652451330,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1MjQ1MTMzMA==",
      "updated_at" : "2020-07-01T14:26:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/652451330",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased 570c1060058d7f52286107df217b66d28d0b1f91 -> a660ecc26e691ed9b931d6fe27c26899ef66be64 ([pr18077.27](https://github.com/hebasto/bitcoin/commits/pr18077.27) -> [pr18077.28](https://github.com/hebasto/bitcoin/commits/pr18077.28)) due to the conflict with #19331.",
      "created_at" : "2020-07-03T07:16:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-653393228",
      "id" : 653393228,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1MzM5MzIyOA==",
      "updated_at" : "2020-07-03T07:16:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/653393228",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased a660ecc26e691ed9b931d6fe27c26899ef66be64 -> d4a143ae233fc5fd0cb3c08ce7c388434d256574 ([pr18077.28](https://github.com/hebasto/bitcoin/commits/pr18077.28) -> [pr18077.29](https://github.com/hebasto/bitcoin/commits/pr18077.29),  [diff](https://github.com/hebasto/bitcoin/compare/pr18077.28..pr18077.29)):\r\n\r\n- fixed dependency `libnatpmp` build with the custom `CC` variable.",
      "created_at" : "2020-07-05T09:06:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-653861394",
      "id" : 653861394,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1Mzg2MTM5NA==",
      "updated_at" : "2020-07-05T09:06:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/653861394",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-07-09T16:33:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-656229350",
      "id" : 656229350,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1NjIyOTM1MA==",
      "updated_at" : "2020-07-09T16:33:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/656229350",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased d4a143ae233fc5fd0cb3c08ce7c388434d256574 -> b61233d7ab4afe6cd7875b178e923fab59f0534a ([pr18077.29](https://github.com/hebasto/bitcoin/commits/pr18077.29) -> [pr18077.30](https://github.com/hebasto/bitcoin/commits/pr18077.30)) due to the conflicts with #19191 and #19314.",
      "created_at" : "2020-07-10T07:55:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-656540518",
      "id" : 656540518,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1NjU0MDUxOA==",
      "updated_at" : "2020-07-10T07:55:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/656540518",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-07-14T07:19:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-658015173",
      "id" : 658015173,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1ODAxNTE3Mw==",
      "updated_at" : "2020-07-14T07:19:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/658015173",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased b61233d7ab4afe6cd7875b178e923fab59f0534a -> 1c4bfdb46d48fed6c3f43bbdd7973069cdd21baf ([pr18077.30](https://github.com/hebasto/bitcoin/commits/pr18077.30) -> [pr18077.31](https://github.com/hebasto/bitcoin/commits/pr18077.31)) due to the conflict with #19495.",
      "created_at" : "2020-07-14T08:17:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-658041248",
      "id" : 658041248,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1ODA0MTI0OA==",
      "updated_at" : "2020-07-14T08:17:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/658041248",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-07-16T16:01:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-659508781",
      "id" : 659508781,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1OTUwODc4MQ==",
      "updated_at" : "2020-07-16T16:01:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/659508781",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased 1c4bfdb46d48fed6c3f43bbdd7973069cdd21baf -> 155d87877c11a32abe1ed91799776691b5977a31 ([pr18077.31](https://github.com/hebasto/bitcoin/commits/pr18077.31) -> [pr18077.32](https://github.com/hebasto/bitcoin/commits/pr18077.32)) due to the conflict with #17919.",
      "created_at" : "2020-07-16T18:42:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-659598396",
      "id" : 659598396,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1OTU5ODM5Ng==",
      "updated_at" : "2020-07-16T18:42:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/659598396",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-07-30T16:26:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-666506580",
      "id" : 666506580,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2NjUwNjU4MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-30T16:26:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/666506580",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased 155d87877c11a32abe1ed91799776691b5977a31 -> 88b1f0357c332bc67fa20450dda9f77fa449576e ([pr18077.32](https://github.com/hebasto/bitcoin/commits/pr18077.32) -> [pr18077.33](https://github.com/hebasto/bitcoin/commits/pr18077.33)) due to the conflict with #19561.",
      "created_at" : "2020-07-31T12:14:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-667089839",
      "id" : 667089839,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2NzA4OTgzOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-31T12:14:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/667089839",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-08-07T10:09:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-670441819",
      "id" : 670441819,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3MDQ0MTgxOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-07T10:09:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/670441819",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased 88b1f0357c332bc67fa20450dda9f77fa449576e -> 225f512438f4391f6af255f851131358e3c466a2 ([pr18077.33](https://github.com/hebasto/bitcoin/commits/pr18077.33) -> [pr18077.34](https://github.com/hebasto/bitcoin/commits/pr18077.34)) due to the conflict with #19098.",
      "created_at" : "2020-08-08T07:19:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-670837706",
      "id" : 670837706,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3MDgzNzcwNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-08T07:19:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/670837706",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "For those looking to review or revisit:\r\n\r\n(All pre-rebase)\r\nThere are concept ACKs from: luke-jr, dongcarl, Sjors, Sipa\r\na tACK from tryphe\r\nwith no NACKs or blocking issues",
      "created_at" : "2020-08-10T14:02:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-671373132",
      "id" : 671373132,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3MTM3MzEzMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-20T19:20:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/671373132",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/755825?v=4",
         "events_url" : "https://api.github.com/users/adamjonas/events{/privacy}",
         "followers_url" : "https://api.github.com/users/adamjonas/followers",
         "following_url" : "https://api.github.com/users/adamjonas/following{/other_user}",
         "gists_url" : "https://api.github.com/users/adamjonas/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/adamjonas",
         "id" : 755825,
         "login" : "adamjonas",
         "node_id" : "MDQ6VXNlcjc1NTgyNQ==",
         "organizations_url" : "https://api.github.com/users/adamjonas/orgs",
         "received_events_url" : "https://api.github.com/users/adamjonas/received_events",
         "repos_url" : "https://api.github.com/users/adamjonas/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/adamjonas/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/adamjonas/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/adamjonas"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Tested 225f512438f4391f6af255f851131358e3c466a2, works:\r\n```\r\n2020-08-20T19:07:08Z NAT-PMP: Port mapping successful. External address = <redacted>\r\n```\r\n\r\n---\r\n\r\nDid not read code yet",
      "created_at" : "2020-08-20T19:11:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-677847589",
      "id" : 677847589,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3Nzg0NzU4OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-20T19:11:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/677847589",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r474281799"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/474281799"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Neither should prevail - one should be attempted before the other, but both should work.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-08-20T21:26:06Z",
      "diff_hunk" : "@@ -0,0 +1,9 @@\n+P2P and network changes\n+-----------------------\n+\n+- Added NAT-PMP port mapping support via [`libnatpmp`](https://miniupnp.tuxfamily.org/libnatpmp.html)\n+\n+Command-line options\n+--------------------\n+\n+-  The `-natpmp` option has been added to use NAT-PMP to map the listening port. If both `-upnp` and `-natpmp` options are provided, the former prevails.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r474281799",
      "id" : 474281799,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI4MTc5OQ==",
      "original_commit_id" : "225f512438f4391f6af255f851131358e3c466a2",
      "original_line" : 9,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "doc/release-notes-18077.md",
      "position" : null,
      "pull_request_review_id" : 471997437,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/474281799",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-08-26T09:03:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-680755364",
      "id" : 680755364,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4MDc1NTM2NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-26T09:03:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/680755364",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased 225f512438f4391f6af255f851131358e3c466a2 -> 22cbf4eefaa7333a3e2bf94fbf4d3e7b4bf379cb ([pr18077.34](https://github.com/hebasto/bitcoin/commits/pr18077.34) -> [pr18077.35](https://github.com/hebasto/bitcoin/commits/pr18077.35)) due to the conflict with #19779.",
      "created_at" : "2020-08-26T09:13:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-680760631",
      "id" : 680760631,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4MDc2MDYzMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-26T09:13:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/680760631",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased 22cbf4eefaa7333a3e2bf94fbf4d3e7b4bf379cb -> 2b6bd32e915d13928577b038c18194ac4024fc10 ([pr18077.35](https://github.com/hebasto/bitcoin/commits/pr18077.35) -> [pr18077.36](https://github.com/hebasto/bitcoin/commits/pr18077.36)) due to the conflict with https://github.com/bitcoin-core/gui/pull/35.",
      "created_at" : "2020-08-26T17:01:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-681005079",
      "id" : 681005079,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4MTAwNTA3OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-26T17:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/681005079",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-09-15T11:40:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-692659821",
      "id" : 692659821,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5MjY1OTgyMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-15T11:40:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/692659821",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased 2b6bd32e915d13928577b038c18194ac4024fc10 -> 62601a5a158b8c3710fde7cac8aadaa71a72f110 ([pr18077.36](https://github.com/hebasto/bitcoin/commits/pr18077.36) -> [pr18077.37](https://github.com/hebasto/bitcoin/commits/pr18077.37)) due to the conflict with #19558.",
      "created_at" : "2020-09-15T14:34:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-692756420",
      "id" : 692756420,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5Mjc1NjQyMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-15T14:34:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/692756420",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2020-09-17T10:09:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-694135151",
      "id" : 694135151,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5NDEzNTE1MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-17T10:09:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/694135151",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-10-12T18:13:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-707272081",
      "id" : 707272081,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwNzI3MjA4MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-12T18:13:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/707272081",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I performed basic functional testing against this branch (but not master with this applied due to rebase hell) against http://www.nongnu.org/natpmp/.\r\n\r\nI don't really like the natpmp default being set by configure. I see the UPNP is currently handled that way, but I think that is an artefact of the fact that UPNP is disabled for implementation specific security reasons. Otherwise, no other bitcoin setting has its default set by configure.  That said, this could easily be something changed after getting the functionality merged or even in a subsequent release.\r\n\r\nI found that it successfully mapped 8333 and released the mapping on shutdown.\r\n\r\nI restricted the port range at the pmp-daemon and found that it successfully mapped a different port and correctly learned the other port number.\r\n\r\nI killed the pmp-daemon while bitcoind was running then shutdown and verified that it didn't hang up waiting for some unmap confirmation or anything like that.\r\n\r\nI did not change my external IP to confirm that it learned about the IP change (as I couldn't do that without disrupting other people). I think this would be a useful thing to test, but even if it didn't work right I don't think it would block merging this.\r\n\r\nLooks to me like it works!\r\n",
      "created_at" : "2020-10-12T19:03:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-707294191",
      "id" : 707294191,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwNzI5NDE5MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-12T19:07:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/707294191",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased 62601a5a158b8c3710fde7cac8aadaa71a72f110 -> 44a697619d3fc3d9311c3d099cae04b21de071f3 ([pr18077.37](https://github.com/hebasto/bitcoin/commits/pr18077.37) -> [pr18077.38](https://github.com/hebasto/bitcoin/commits/pr18077.38)) due to the conflict with #19998.",
      "created_at" : "2020-10-13T05:47:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-707504201",
      "id" : 707504201,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwNzUwNDIwMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-13T05:47:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/707504201",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "ultra minor nit, ignore if you like:  I didn't like that the logs calls it \"NAT-PMP\" but the configuration option is natpmp, so I had to go read the code to figure out what I should be looking for. I'd prefer to see logs say \"natpmp\" for optimum greppability.",
      "created_at" : "2020-10-15T09:41:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-709047605",
      "id" : 709047605,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwOTA0NzYwNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-15T09:41:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/709047605",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased 44a697619d3fc3d9311c3d099cae04b21de071f3 -> 81a791d88d68e64968e52d8ff6ec20879bd5fad1 ([pr18077.38](https://github.com/hebasto/bitcoin/commits/pr18077.38) -> [pr18077.39](https://github.com/hebasto/bitcoin/commits/pr18077.39)) due to the conflict with #19077, and addressed @gmaxwell's [comment](https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-709047605): \r\n> ultra minor nit, ignore if you like: I didn't like that the logs calls it \"NAT-PMP\" but the configuration option is natpmp, so I had to go read the code to figure out what I should be looking for. I'd prefer to see logs say \"natpmp\" for optimum greppability.\r\n",
      "created_at" : "2020-10-15T10:26:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-709111256",
      "id" : 709111256,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwOTExMTI1Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-15T10:26:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/709111256",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Still works. Looks good to me.",
      "created_at" : "2020-10-15T21:54:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-709610568",
      "id" : 709610568,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwOTYxMDU2OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-15T21:54:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/709610568",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK - reviewing this shortly",
      "created_at" : "2020-10-19T16:52:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-712296249",
      "id" : 712296249,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcxMjI5NjI0OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-19T16:52:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/712296249",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r508586206"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/508586206"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Verified this locally.\r\n```\r\n% curl -O https://miniupnp.tuxfamily.org/files/libnatpmp-20150609.tar.gz\r\n% sha256sum libnatpmp-20150609.tar.gz\r\ne1aa9c4c4219bc06943d6b2130f664daee213fb262fcb94dd355815b8f4536b0  libnatpmp-20150609.tar.gz\r\n```",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-10-20T15:01:58Z",
      "diff_hunk" : "@@ -0,0 +1,19 @@\n+package=libnatpmp\n+$(package)_version=20150609\n+$(package)_download_path=https://miniupnp.tuxfamily.org/files/\n+$(package)_file_name=$(package)-$($(package)_version).tar.gz\n+$(package)_sha256_hash=e1aa9c4c4219bc06943d6b2130f664daee213fb262fcb94dd355815b8f4536b0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r508586206",
      "id" : 508586206,
      "line" : 5,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU4NjIwNg==",
      "original_commit_id" : "81a791d88d68e64968e52d8ff6ec20879bd5fad1",
      "original_line" : 5,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "depends/packages/libnatpmp.mk",
      "position" : 5,
      "pull_request_review_id" : 512819049,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/508586206",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r508821208"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/508821208"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/pull/18077/commits/035a41ca371675d0cb0fbfa8177553ec19068663\r\n\r\nVerified this is move-only from here on down.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-10-20T20:33:47Z",
      "diff_hunk" : "@@ -0,0 +1,137 @@\n+// Copyright (c) 2011-2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif\n+\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#ifdef USE_UPNP",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r508821208",
      "id" : 508821208,
      "line" : 149,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgyMTIwOA==",
      "original_commit_id" : "035a41ca371675d0cb0fbfa8177553ec19068663",
      "original_line" : 149,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : 149,
      "pull_request_review_id" : 512819049,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/508821208",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r508822897"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/508822897"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/pull/18077/commits/035a41ca371675d0cb0fbfa8177553ec19068663\r\n\r\nSo this was just unnecessary in the first place?",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-10-20T20:36:45Z",
      "diff_hunk" : "@@ -33,11 +33,6 @@\n #include <memory>\n #include <condition_variable>\n \n-#ifndef WIN32\n-#include <arpa/inet.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r508822897",
      "id" : 508822897,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgyMjg5Nw==",
      "original_commit_id" : "035a41ca371675d0cb0fbfa8177553ec19068663",
      "original_line" : 37,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 512819049,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/508822897",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r508826548"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/508826548"
         }
      },
      "author_association" : "MEMBER",
      "body" : "(Note on https://github.com/bitcoin/bitcoin/pull/18077/commits/5b6af780967c428ec38fa18ae68a193d2d036f57 as a whole)\r\n\r\nI certainly don't have qualms with this change but it seems orthogonal to NAT-PMP per se. Is it necessary for NAT-PMP somehow? Just curious.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-10-20T20:43:19Z",
      "diff_hunk" : "@@ -35,9 +35,11 @@ static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\"\n static CThreadInterrupt g_upnp_interrupt;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r508826548",
      "id" : 508826548,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgyNjU0OA==",
      "original_commit_id" : "5b6af780967c428ec38fa18ae68a193d2d036f57",
      "original_line" : 35,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : null,
      "pull_request_review_id" : 512819049,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/508826548",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r508829278"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/508829278"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/pull/18077/commits/ea445ad4bc5b4d2904cbe234a627700a6d22d32e\r\n\r\nNote: simultaneous use of either NAT-PMP or upnp enabled in a later commit.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-10-20T20:48:14Z",
      "diff_hunk" : "@@ -115,14 +117,39 @@ static void ThreadMapPort()\n     } while (g_upnp_interrupt.sleep_for(PORT_MAPPING_RETRY_PERIOD));\n }\n \n-void StartMapPort()\n+void StartThreadMapPort()\n {\n     if (!g_upnp_thread.joinable()) {\n         assert(!g_upnp_interrupt);\n         g_upnp_thread = std::thread((std::bind(&TraceThread<void (*)()>, \"upnp\", &ThreadMapPort)));\n     }\n }\n \n+static void DispatchMapPort()\n+{\n+    if (g_mapport_target_proto == MapPortProtoFlag::UPNP) {\n+        StartThreadMapPort();\n+    } else {\n+        InterruptMapPort();\n+        StopMapPort();\n+    }\n+}\n+\n+static void MapPortProtoSetEnabled(MapPortProtoFlag proto, bool enabled)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r508829278",
      "id" : 508829278,
      "line" : 291,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgyOTI3OA==",
      "original_commit_id" : "ea445ad4bc5b4d2904cbe234a627700a6d22d32e",
      "original_line" : 291,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : 291,
      "pull_request_review_id" : 512819049,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/508829278",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r508829874"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/508829874"
         }
      },
      "author_association" : "MEMBER",
      "body" : "(Note on https://github.com/bitcoin/bitcoin/pull/18077/commits/1bf23f291d7c053538245f1a7f6f7699daf4a3b9 as a whole:) could be a scripteddiff AFAICT, but not a huge deal.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-10-20T20:49:17Z",
      "diff_hunk" : "@@ -33,8 +33,8 @@ static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\"\n #include <thread>\n \n #ifdef USE_UPNP\n-static CThreadInterrupt g_upnp_interrupt;\n-static std::thread g_upnp_thread;\n+static CThreadInterrupt g_mapport_interrupt;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r508829874",
      "id" : 508829874,
      "line" : 41,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgyOTg3NA==",
      "original_commit_id" : "1bf23f291d7c053538245f1a7f6f7699daf4a3b9",
      "original_line" : 41,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : 41,
      "pull_request_review_id" : 512819049,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/508829874",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r508835955"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/508835955"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/pull/18077/commits/f6bd717f3f44f2a167ce2e548df1132789d0ea98\r\n\r\nHm, I see we're explicitly setting this in `NetpmpMapping` but then it goes unused. No big deal, just curious.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-10-20T21:00:04Z",
      "diff_hunk" : "@@ -32,13 +41,117 @@ static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\"\n #include <string>\n #include <thread>\n \n-#ifdef USE_UPNP\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n static CThreadInterrupt g_mapport_interrupt;\n static std::thread g_mapport_thread;\n static std::atomic_uint g_mapport_target_proto{MapPortProtoFlag::NONE};\n static constexpr auto PORT_MAPPING_REANNOUNCE_PERIOD = std::chrono::minutes(20);\n static constexpr auto PORT_MAPPING_RETRY_PERIOD = std::chrono::minutes(5);\n \n+#ifdef USE_NATPMP\n+static uint16_t g_mapport_external_port = 0;\n+static bool NatpmpInit(natpmp_t* natpmp)\n+{\n+    const int r_init = initnatpmp(natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r_init == 0) return true;\n+    LogPrintf(\"natpmp: initnatpmp() failed with %d error.\\n\", r_init);\n+    return false;\n+}\n+\n+static bool NatpmpDiscover(natpmp_t* natpmp, struct in_addr& external_ipv4_addr)\n+{\n+    const int r_send = sendpublicaddressrequest(natpmp);\n+    if (r_send == 2 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            external_ipv4_addr = response.pnu.publicaddress.addr;\n+            return true;\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"natpmp: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"natpmp: sendpublicaddressrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool NatpmpMapping(natpmp_t* natpmp, const struct in_addr& external_ipv4_addr, uint16_t private_port, bool& external_ip_discovered)\n+{\n+    const uint16_t suggested_external_port = g_mapport_external_port ? g_mapport_external_port : private_port;\n+    const int r_send = sendnewportmappingrequest(natpmp, NATPMP_PROTOCOL_TCP, private_port, suggested_external_port, 3600 /*seconds*/);\n+    if (r_send == 12 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            auto pm = response.pnu.newportmapping;\n+            if (private_port == pm.privateport && pm.lifetime > 0) {\n+                g_mapport_external_port = pm.mappedpublicport;\n+                const CService external{external_ipv4_addr, pm.mappedpublicport};\n+                if (!external_ip_discovered && fDiscover) {\n+                    AddLocal(external, LOCAL_MAPPED);\n+                    external_ip_discovered = true;\n+                }\n+\n+                LogPrintf(\"natpmp: Port mapping successful. External address = %s\\n\", external.ToString());\n+                return true;\n+            } else {\n+                LogPrintf(\"natpmp: Port mapping failed.\\n\");\n+            }\n+\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"natpmp: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"natpmp: sendnewportmappingrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool ProcessNatpmp()\n+{\n+    bool ret = false;\n+    natpmp_t natpmp;\n+    struct in_addr external_ipv4_addr;\n+    if (NatpmpInit(&natpmp) && NatpmpDiscover(&natpmp, external_ipv4_addr)) {\n+        bool external_ip_discovered = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r508835955",
      "id" : 508835955,
      "line" : 128,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgzNTk1NQ==",
      "original_commit_id" : "f6bd717f3f44f2a167ce2e548df1132789d0ea98",
      "original_line" : 128,
      "original_position" : 119,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : 128,
      "pull_request_review_id" : 512819049,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/508835955",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r508839477"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/508839477"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Nit: linebreak would be nice.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-10-20T21:06:31Z",
      "diff_hunk" : "@@ -479,7 +479,12 @@ void SetupServerArgs(NodeContext& node)\n #endif\n #else\n     hidden_args.emplace_back(\"-upnp\");\n-#endif\n+#endif // #ifdef USE_UPNP\n+#ifdef USE_NATPMP\n+    argsman.AddArg(\"-natpmp\", strprintf(\"Use NAT-PMP to map the listening port (default: %s)\", DEFAULT_NATPMP ? \"1 when listening and no -proxy\" : \"0\"), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r508839477",
      "id" : 508839477,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgzOTQ3Nw==",
      "original_commit_id" : "ea022f30db70a8541f07243c41d5f7d0401d0a35",
      "original_line" : 484,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 512819049,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/508839477",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r508841927"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/508841927"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Nit: not s/false/USE_NATPMP ?",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-10-20T21:10:58Z",
      "diff_hunk" : "@@ -50,6 +50,9 @@ OptionsDialog::OptionsDialog(QWidget *parent, bool enableWallet) :\n     /* Network elements init */\n #ifndef USE_UPNP\n     ui->mapPortUpnp->setEnabled(false);\n+#endif\n+#ifndef USE_NATPMP\n+    ui->mapPortNatpmp->setEnabled(false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r508841927",
      "id" : 508841927,
      "line" : 55,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg0MTkyNw==",
      "original_commit_id" : "1f93ddff189a8201699a3d52ef4546b93aa0e948",
      "original_line" : 55,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/qt/optionsdialog.cpp",
      "position" : 13,
      "pull_request_review_id" : 512819049,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/508841927",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r510322172"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/510322172"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes. I've submitted a dedicated #20221.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-10-22T17:05:44Z",
      "diff_hunk" : "@@ -33,11 +33,6 @@\n #include <memory>\n #include <condition_variable>\n \n-#ifndef WIN32\n-#include <arpa/inet.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r510322172",
      "id" : 510322172,
      "in_reply_to_id" : 508822897,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDMyMjE3Mg==",
      "original_commit_id" : "035a41ca371675d0cb0fbfa8177553ec19068663",
      "original_line" : 37,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 514942815,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/510322172",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r510329265"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/510329265"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The _\"net: Keep trying to use UPnP when -upnp=1\"_ commit (5b6af780967c428ec38fa18ae68a193d2d036f57) is a prerequisite for the _\"net: Add NAT-PMP to port mapping loop\"_ commit (c329ae5b6834e8dae6d178bc84321c7dc6e3c6fc).\r\nBoth commits make possible to switch port forwarding method at runtime.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-10-22T17:17:38Z",
      "diff_hunk" : "@@ -35,9 +35,11 @@ static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\"\n static CThreadInterrupt g_upnp_interrupt;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r510329265",
      "id" : 510329265,
      "in_reply_to_id" : 508826548,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDMyOTI2NQ==",
      "original_commit_id" : "5b6af780967c428ec38fa18ae68a193d2d036f57",
      "original_line" : 35,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : null,
      "pull_request_review_id" : 514952560,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/510329265",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r510337604"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/510337604"
         }
      },
      "author_association" : "MEMBER",
      "body" : "As an in-out parameter, `external_ip_discovered` is used here https://github.com/bitcoin/bitcoin/blob/81a791d88d68e64968e52d8ff6ec20879bd5fad1/src/mapport.cpp#L104-L107 to prevent consecutive `AddLocal` calls. ",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-10-22T17:31:11Z",
      "diff_hunk" : "@@ -32,13 +41,117 @@ static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\"\n #include <string>\n #include <thread>\n \n-#ifdef USE_UPNP\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n static CThreadInterrupt g_mapport_interrupt;\n static std::thread g_mapport_thread;\n static std::atomic_uint g_mapport_target_proto{MapPortProtoFlag::NONE};\n static constexpr auto PORT_MAPPING_REANNOUNCE_PERIOD = std::chrono::minutes(20);\n static constexpr auto PORT_MAPPING_RETRY_PERIOD = std::chrono::minutes(5);\n \n+#ifdef USE_NATPMP\n+static uint16_t g_mapport_external_port = 0;\n+static bool NatpmpInit(natpmp_t* natpmp)\n+{\n+    const int r_init = initnatpmp(natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r_init == 0) return true;\n+    LogPrintf(\"natpmp: initnatpmp() failed with %d error.\\n\", r_init);\n+    return false;\n+}\n+\n+static bool NatpmpDiscover(natpmp_t* natpmp, struct in_addr& external_ipv4_addr)\n+{\n+    const int r_send = sendpublicaddressrequest(natpmp);\n+    if (r_send == 2 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            external_ipv4_addr = response.pnu.publicaddress.addr;\n+            return true;\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"natpmp: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"natpmp: sendpublicaddressrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool NatpmpMapping(natpmp_t* natpmp, const struct in_addr& external_ipv4_addr, uint16_t private_port, bool& external_ip_discovered)\n+{\n+    const uint16_t suggested_external_port = g_mapport_external_port ? g_mapport_external_port : private_port;\n+    const int r_send = sendnewportmappingrequest(natpmp, NATPMP_PROTOCOL_TCP, private_port, suggested_external_port, 3600 /*seconds*/);\n+    if (r_send == 12 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            auto pm = response.pnu.newportmapping;\n+            if (private_port == pm.privateport && pm.lifetime > 0) {\n+                g_mapport_external_port = pm.mappedpublicport;\n+                const CService external{external_ipv4_addr, pm.mappedpublicport};\n+                if (!external_ip_discovered && fDiscover) {\n+                    AddLocal(external, LOCAL_MAPPED);\n+                    external_ip_discovered = true;\n+                }\n+\n+                LogPrintf(\"natpmp: Port mapping successful. External address = %s\\n\", external.ToString());\n+                return true;\n+            } else {\n+                LogPrintf(\"natpmp: Port mapping failed.\\n\");\n+            }\n+\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"natpmp: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"natpmp: sendnewportmappingrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool ProcessNatpmp()\n+{\n+    bool ret = false;\n+    natpmp_t natpmp;\n+    struct in_addr external_ipv4_addr;\n+    if (NatpmpInit(&natpmp) && NatpmpDiscover(&natpmp, external_ipv4_addr)) {\n+        bool external_ip_discovered = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r510337604",
      "id" : 510337604,
      "in_reply_to_id" : 508835955,
      "line" : 128,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDMzNzYwNA==",
      "original_commit_id" : "f6bd717f3f44f2a167ce2e548df1132789d0ea98",
      "original_line" : 128,
      "original_position" : 119,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : 128,
      "pull_request_review_id" : 514963255,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/510337604",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r510344800"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/510344800"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It won't compile if `USE_NATPMP` is undefined. Did I understand you correctly?",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-10-22T17:43:04Z",
      "diff_hunk" : "@@ -50,6 +50,9 @@ OptionsDialog::OptionsDialog(QWidget *parent, bool enableWallet) :\n     /* Network elements init */\n #ifndef USE_UPNP\n     ui->mapPortUpnp->setEnabled(false);\n+#endif\n+#ifndef USE_NATPMP\n+    ui->mapPortNatpmp->setEnabled(false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r510344800",
      "id" : 510344800,
      "in_reply_to_id" : 508841927,
      "line" : 55,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDM0NDgwMA==",
      "original_commit_id" : "1f93ddff189a8201699a3d52ef4546b93aa0e948",
      "original_line" : 55,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/qt/optionsdialog.cpp",
      "position" : 13,
      "pull_request_review_id" : 514972531,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/510344800",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r510347832"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/510347832"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oh my mistake; I read that as ifdef.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-10-22T17:47:59Z",
      "diff_hunk" : "@@ -50,6 +50,9 @@ OptionsDialog::OptionsDialog(QWidget *parent, bool enableWallet) :\n     /* Network elements init */\n #ifndef USE_UPNP\n     ui->mapPortUpnp->setEnabled(false);\n+#endif\n+#ifndef USE_NATPMP\n+    ui->mapPortNatpmp->setEnabled(false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r510347832",
      "id" : 510347832,
      "in_reply_to_id" : 508841927,
      "line" : 55,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDM0NzgzMg==",
      "original_commit_id" : "1f93ddff189a8201699a3d52ef4546b93aa0e948",
      "original_line" : 55,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/qt/optionsdialog.cpp",
      "position" : 13,
      "pull_request_review_id" : 514976265,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/510347832",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Updated 81a791d88d68e64968e52d8ff6ec20879bd5fad1 -> cb4060686155c011cbece84fd551dfa000277d51 ([pr18077.39](https://github.com/hebasto/bitcoin/commits/pr18077.39) -> [pr18077.40](https://github.com/hebasto/bitcoin/commits/pr18077.40), [diff](https://github.com/hebasto/bitcoin/compare/pr18077.39..pr18077.40)).\r\n\r\nAddressed @jamesob's comments:\r\n-  https://github.com/bitcoin/bitcoin/pull/18077#discussion_r508829874:\r\n> (Note on [1bf23f2](https://github.com/bitcoin/bitcoin/commit/1bf23f291d7c053538245f1a7f6f7699daf4a3b9) as a whole:) could be a scripteddiff AFAICT, but not a huge deal.\r\n\r\n- https://github.com/bitcoin/bitcoin/pull/18077#discussion_r508839477:\r\n> Nit: linebreak would be nice.",
      "created_at" : "2020-10-22T18:37:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-714683741",
      "id" : 714683741,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcxNDY4Mzc0MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-23T08:19:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/714683741",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r510376824"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/510376824"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks! [Updated](https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-714683741).",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-10-22T18:38:13Z",
      "diff_hunk" : "@@ -33,8 +33,8 @@ static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\"\n #include <thread>\n \n #ifdef USE_UPNP\n-static CThreadInterrupt g_upnp_interrupt;\n-static std::thread g_upnp_thread;\n+static CThreadInterrupt g_mapport_interrupt;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r510376824",
      "id" : 510376824,
      "in_reply_to_id" : 508829874,
      "line" : 41,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDM3NjgyNA==",
      "original_commit_id" : "1bf23f291d7c053538245f1a7f6f7699daf4a3b9",
      "original_line" : 41,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : 41,
      "pull_request_review_id" : 515014330,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/510376824",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r510377046"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/510377046"
         }
      },
      "author_association" : "MEMBER",
      "body" : "[Updated](https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-714683741).",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-10-22T18:38:40Z",
      "diff_hunk" : "@@ -479,7 +479,12 @@ void SetupServerArgs(NodeContext& node)\n #endif\n #else\n     hidden_args.emplace_back(\"-upnp\");\n-#endif\n+#endif // #ifdef USE_UPNP\n+#ifdef USE_NATPMP\n+    argsman.AddArg(\"-natpmp\", strprintf(\"Use NAT-PMP to map the listening port (default: %s)\", DEFAULT_NATPMP ? \"1 when listening and no -proxy\" : \"0\"), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r510377046",
      "id" : 510377046,
      "in_reply_to_id" : 508839477,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDM3NzA0Ng==",
      "original_commit_id" : "ea022f30db70a8541f07243c41d5f7d0401d0a35",
      "original_line" : 484,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 515014633,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/510377046",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r510714033"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/510714033"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Reverted back as a linebreak breaks `test/lint/check-doc.py` linter: https://travis-ci.org/github/bitcoin/bitcoin/jobs/738110074",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-10-23T08:17:07Z",
      "diff_hunk" : "@@ -479,7 +479,12 @@ void SetupServerArgs(NodeContext& node)\n #endif\n #else\n     hidden_args.emplace_back(\"-upnp\");\n-#endif\n+#endif // #ifdef USE_UPNP\n+#ifdef USE_NATPMP\n+    argsman.AddArg(\"-natpmp\", strprintf(\"Use NAT-PMP to map the listening port (default: %s)\", DEFAULT_NATPMP ? \"1 when listening and no -proxy\" : \"0\"), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r510714033",
      "id" : 510714033,
      "in_reply_to_id" : 508839477,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDcxNDAzMw==",
      "original_commit_id" : "ea022f30db70a8541f07243c41d5f7d0401d0a35",
      "original_line" : 484,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 515442196,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/510714033",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Updated cb4060686155c011cbece84fd551dfa000277d51 -> bddfeade1e7740f04002f6d88e6e9840ed985bea ([pr18077.40](https://github.com/hebasto/bitcoin/commits/pr18077.40) -> [pr18077.41](https://github.com/hebasto/bitcoin/commits/pr18077.41), [diff](https://github.com/hebasto/bitcoin/compare/pr18077.40..pr18077.41)): https://github.com/bitcoin/bitcoin/pull/18077#discussion_r510714033",
      "created_at" : "2020-10-23T08:19:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-715155281",
      "id" : 715155281,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcxNTE1NTI4MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-23T08:19:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/715155281",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r512074064"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/512074064"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oh I see, thanks.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-10-26T15:58:13Z",
      "diff_hunk" : "@@ -32,13 +41,117 @@ static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\"\n #include <string>\n #include <thread>\n \n-#ifdef USE_UPNP\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n static CThreadInterrupt g_mapport_interrupt;\n static std::thread g_mapport_thread;\n static std::atomic_uint g_mapport_target_proto{MapPortProtoFlag::NONE};\n static constexpr auto PORT_MAPPING_REANNOUNCE_PERIOD = std::chrono::minutes(20);\n static constexpr auto PORT_MAPPING_RETRY_PERIOD = std::chrono::minutes(5);\n \n+#ifdef USE_NATPMP\n+static uint16_t g_mapport_external_port = 0;\n+static bool NatpmpInit(natpmp_t* natpmp)\n+{\n+    const int r_init = initnatpmp(natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r_init == 0) return true;\n+    LogPrintf(\"natpmp: initnatpmp() failed with %d error.\\n\", r_init);\n+    return false;\n+}\n+\n+static bool NatpmpDiscover(natpmp_t* natpmp, struct in_addr& external_ipv4_addr)\n+{\n+    const int r_send = sendpublicaddressrequest(natpmp);\n+    if (r_send == 2 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            external_ipv4_addr = response.pnu.publicaddress.addr;\n+            return true;\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"natpmp: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"natpmp: sendpublicaddressrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool NatpmpMapping(natpmp_t* natpmp, const struct in_addr& external_ipv4_addr, uint16_t private_port, bool& external_ip_discovered)\n+{\n+    const uint16_t suggested_external_port = g_mapport_external_port ? g_mapport_external_port : private_port;\n+    const int r_send = sendnewportmappingrequest(natpmp, NATPMP_PROTOCOL_TCP, private_port, suggested_external_port, 3600 /*seconds*/);\n+    if (r_send == 12 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            auto pm = response.pnu.newportmapping;\n+            if (private_port == pm.privateport && pm.lifetime > 0) {\n+                g_mapport_external_port = pm.mappedpublicport;\n+                const CService external{external_ipv4_addr, pm.mappedpublicport};\n+                if (!external_ip_discovered && fDiscover) {\n+                    AddLocal(external, LOCAL_MAPPED);\n+                    external_ip_discovered = true;\n+                }\n+\n+                LogPrintf(\"natpmp: Port mapping successful. External address = %s\\n\", external.ToString());\n+                return true;\n+            } else {\n+                LogPrintf(\"natpmp: Port mapping failed.\\n\");\n+            }\n+\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"natpmp: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"natpmp: sendnewportmappingrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool ProcessNatpmp()\n+{\n+    bool ret = false;\n+    natpmp_t natpmp;\n+    struct in_addr external_ipv4_addr;\n+    if (NatpmpInit(&natpmp) && NatpmpDiscover(&natpmp, external_ipv4_addr)) {\n+        bool external_ip_discovered = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r512074064",
      "id" : 512074064,
      "in_reply_to_id" : 508835955,
      "line" : 128,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA3NDA2NA==",
      "original_commit_id" : "f6bd717f3f44f2a167ce2e548df1132789d0ea98",
      "original_line" : 128,
      "original_position" : 119,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : 128,
      "pull_request_review_id" : 516928142,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/512074064",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-10-27T10:05:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-717129662",
      "id" : 717129662,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcxNzEyOTY2Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-27T10:05:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/717129662",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased bddfeade1e7740f04002f6d88e6e9840ed985bea -> 5fd127243f452827dab3b4f4f47b6e96816fdfb8 ([pr18077.41](https://github.com/hebasto/bitcoin/commits/pr18077.41) -> [pr18077.42](https://github.com/hebasto/bitcoin/commits/pr18077.42)) due to the conflict with #19124.",
      "created_at" : "2020-10-27T10:27:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-717142998",
      "id" : 717142998,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcxNzE0Mjk5OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-27T10:27:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/717142998",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-10-29T14:21:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-718785331",
      "id" : 718785331,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcxODc4NTMzMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-29T14:21:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/718785331",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased 5fd127243f452827dab3b4f4f47b6e96816fdfb8 -> 90d9547f135ef0ffc00dd790072c3ae307f053ad ([pr18077.42](https://github.com/hebasto/bitcoin/commits/pr18077.42) -> [pr18077.43](https://github.com/hebasto/bitcoin/commits/pr18077.43)) due to the conflict with #20156.",
      "created_at" : "2020-10-29T14:58:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-718810195",
      "id" : 718810195,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcxODgxMDE5NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-29T14:58:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/718810195",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r515256116"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/515256116"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Perhaps I'm reading the code wrong, but it seems like \"If both UPnP and NAT-PMP are enabled, a successful allocation from UPnP prevails over one from NAT-PMP\" is a more accurate description here?\r\n\r\nI'm thinking about the case where both UPnP and NAT-PMP are enabled, but the gateway box is not responding to UPnP, in that case, a NAT-PMP allocation would still be accepted, right?",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-10-30T17:20:45Z",
      "diff_hunk" : "@@ -0,0 +1,9 @@\n+P2P and network changes\n+-----------------------\n+\n+- Added NAT-PMP port mapping support via [`libnatpmp`](https://miniupnp.tuxfamily.org/libnatpmp.html)\n+\n+Command-line options\n+--------------------\n+\n+-  The `-natpmp` option has been added to use NAT-PMP to map the listening port. If both `-upnp` and `-natpmp` options are provided, the former prevails.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r515256116",
      "id" : 515256116,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI1NjExNg==",
      "original_commit_id" : "90d9547f135ef0ffc00dd790072c3ae307f053ad",
      "original_line" : 9,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "doc/release-notes-18077.md",
      "position" : null,
      "pull_request_review_id" : 520878706,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/515256116",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Updated 90d9547f135ef0ffc00dd790072c3ae307f053ad -> 29fb5708ca04da9ca0c25c1b801887354eb714bc ([pr18077.43](https://github.com/hebasto/bitcoin/commits/pr18077.43) -> [pr18077.44](https://github.com/hebasto/bitcoin/commits/pr18077.44), [diff](https://github.com/hebasto/bitcoin/compare/pr18077.43..pr18077.44)):\r\n\r\n- addressed @dongcarl's [comment](https://github.com/bitcoin/bitcoin/pull/18077#discussion_r515256116):\r\n> Perhaps I'm reading the code wrong, but it seems like \"If both UPnP and NAT-PMP are enabled, a successful allocation from UPnP prevails over one from NAT-PMP\" is a more accurate description her",
      "created_at" : "2020-10-30T17:38:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-719697155",
      "id" : 719697155,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcxOTY5NzE1NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-30T17:38:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/719697155",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r515271554"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/515271554"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Perhaps I'm reading the code wrong, but it seems like \"If both UPnP and NAT-PMP are enabled, a successful allocation from UPnP prevails over one from NAT-PMP\" is a more accurate description here?\r\n\r\nThanks! It remained from the initial version of the PR :)\r\n[Updated](https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-719697155).",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-10-30T17:39:37Z",
      "diff_hunk" : "@@ -0,0 +1,9 @@\n+P2P and network changes\n+-----------------------\n+\n+- Added NAT-PMP port mapping support via [`libnatpmp`](https://miniupnp.tuxfamily.org/libnatpmp.html)\n+\n+Command-line options\n+--------------------\n+\n+-  The `-natpmp` option has been added to use NAT-PMP to map the listening port. If both `-upnp` and `-natpmp` options are provided, the former prevails.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r515271554",
      "id" : 515271554,
      "in_reply_to_id" : 515256116,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI3MTU1NA==",
      "original_commit_id" : "90d9547f135ef0ffc00dd790072c3ae307f053ad",
      "original_line" : 9,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "doc/release-notes-18077.md",
      "position" : null,
      "pull_request_review_id" : 520896161,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/515271554",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r515272813"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/515272813"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> I'm thinking about the case where both UPnP and NAT-PMP are enabled, but the gateway box is not responding to UPnP, in that case, a NAT-PMP allocation would still be accepted, right\r\n\r\nThe `do` loop introduced in the c01073db04e94a8d67f29de3daead0e2574b1c26 commit is responsible for that.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-10-30T17:41:50Z",
      "diff_hunk" : "@@ -0,0 +1,9 @@\n+P2P and network changes\n+-----------------------\n+\n+- Added NAT-PMP port mapping support via [`libnatpmp`](https://miniupnp.tuxfamily.org/libnatpmp.html)\n+\n+Command-line options\n+--------------------\n+\n+-  The `-natpmp` option has been added to use NAT-PMP to map the listening port. If both `-upnp` and `-natpmp` options are provided, the former prevails.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r515272813",
      "id" : 515272813,
      "in_reply_to_id" : 515256116,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI3MjgxMw==",
      "original_commit_id" : "90d9547f135ef0ffc00dd790072c3ae307f053ad",
      "original_line" : 9,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "doc/release-notes-18077.md",
      "position" : null,
      "pull_request_review_id" : 520897721,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/515272813",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r515414822"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/515414822"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Couldn't this be true if the user is impossibly fast?",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-10-30T22:51:58Z",
      "diff_hunk" : "@@ -0,0 +1,342 @@\n+// Copyright (c) 2011-2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <netinet/in.h>\n+#endif // #ifdef WIN32\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif // #ifdef USE_UPNP\n+\n+#include <atomic>\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_mapport_interrupt;\n+static std::thread g_mapport_thread;\n+static std::atomic_uint g_mapport_enabled_protos{MapPortProtoFlag::NONE};\n+static std::atomic<MapPortProtoFlag> g_mapport_current_proto{MapPortProtoFlag::NONE};\n+static constexpr auto PORT_MAPPING_REANNOUNCE_PERIOD = std::chrono::minutes(20);\n+static constexpr auto PORT_MAPPING_RETRY_PERIOD = std::chrono::minutes(5);\n+\n+#ifdef USE_NATPMP\n+static uint16_t g_mapport_external_port = 0;\n+static bool NatpmpInit(natpmp_t* natpmp)\n+{\n+    const int r_init = initnatpmp(natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r_init == 0) return true;\n+    LogPrintf(\"natpmp: initnatpmp() failed with %d error.\\n\", r_init);\n+    return false;\n+}\n+\n+static bool NatpmpDiscover(natpmp_t* natpmp, struct in_addr& external_ipv4_addr)\n+{\n+    const int r_send = sendpublicaddressrequest(natpmp);\n+    if (r_send == 2 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            external_ipv4_addr = response.pnu.publicaddress.addr;\n+            return true;\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"natpmp: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"natpmp: sendpublicaddressrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool NatpmpMapping(natpmp_t* natpmp, const struct in_addr& external_ipv4_addr, uint16_t private_port, bool& external_ip_discovered)\n+{\n+    const uint16_t suggested_external_port = g_mapport_external_port ? g_mapport_external_port : private_port;\n+    const int r_send = sendnewportmappingrequest(natpmp, NATPMP_PROTOCOL_TCP, private_port, suggested_external_port, 3600 /*seconds*/);\n+    if (r_send == 12 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            auto pm = response.pnu.newportmapping;\n+            if (private_port == pm.privateport && pm.lifetime > 0) {\n+                g_mapport_external_port = pm.mappedpublicport;\n+                const CService external{external_ipv4_addr, pm.mappedpublicport};\n+                if (!external_ip_discovered && fDiscover) {\n+                    AddLocal(external, LOCAL_MAPPED);\n+                    external_ip_discovered = true;\n+                }\n+\n+                LogPrintf(\"natpmp: Port mapping successful. External address = %s\\n\", external.ToString());\n+                return true;\n+            } else {\n+                LogPrintf(\"natpmp: Port mapping failed.\\n\");\n+            }\n+\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"natpmp: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"natpmp: sendnewportmappingrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool ProcessNatpmp()\n+{\n+    bool ret = false;\n+    natpmp_t natpmp;\n+    struct in_addr external_ipv4_addr;\n+    if (NatpmpInit(&natpmp) && NatpmpDiscover(&natpmp, external_ipv4_addr)) {\n+        bool external_ip_discovered = false;\n+        const uint16_t private_port = GetListenPort();\n+        do {\n+            ret = NatpmpMapping(&natpmp, external_ipv4_addr, private_port, external_ip_discovered);\n+        } while (ret && g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+        g_mapport_interrupt.reset();\n+\n+        const int r_send = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, private_port, g_mapport_external_port, /* remove a port mapping */ 0);\n+        g_mapport_external_port = 0;\n+        if (r_send == 12 /* OK */) {\n+            LogPrintf(\"natpmp: Port mapping removed successfully.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: sendnewportmappingrequest(0) failed with %d error.\\n\", r_send);\n+        }\n+    }\n+\n+    closenatpmp(&natpmp);\n+    return ret;\n+}\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+static bool ProcessUpnp()\n+{\n+    bool ret = false;\n+    std::string port = strprintf(\"%u\", GetListenPort());\n+    const char * multicastif = nullptr;\n+    const char * minissdpdpath = nullptr;\n+    struct UPNPDev * devlist = nullptr;\n+    char lanaddr[64];\n+\n+    int error = 0;\n+#if MINIUPNPC_API_VERSION < 14\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, &error);\n+#else\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, 2, &error);\n+#endif\n+\n+    struct UPNPUrls urls;\n+    struct IGDdatas data;\n+    int r;\n+\n+    r = UPNP_GetValidIGD(devlist, &urls, &data, lanaddr, sizeof(lanaddr));\n+    if (r == 1)\n+    {\n+        if (fDiscover) {\n+            char externalIPAddress[40];\n+            r = UPNP_GetExternalIPAddress(urls.controlURL, data.first.servicetype, externalIPAddress);\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"UPnP: GetExternalIPAddress() returned %d\\n\", r);\n+            } else {\n+                if (externalIPAddress[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(externalIPAddress, resolved, false)) {\n+                        LogPrintf(\"UPnP: ExternalIPAddress = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"UPnP: GetExternalIPAddress failed.\\n\");\n+                }\n+            }\n+        }\n+\n+        std::string strDesc = PACKAGE_NAME \" \" + FormatFullVersion();\n+\n+        do {\n+            r = UPNP_AddPortMapping(urls.controlURL, data.first.servicetype, port.c_str(), port.c_str(), lanaddr, strDesc.c_str(), \"TCP\", 0, \"0\");\n+\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                ret = false;\n+                LogPrintf(\"AddPortMapping(%s, %s, %s) failed with code %d (%s)\\n\", port, port, lanaddr, r, strupnperror(r));\n+                break;\n+            } else {\n+                ret = true;\n+                LogPrintf(\"UPnP Port Mapping successful.\\n\");\n+            }\n+        } while (g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+        g_mapport_interrupt.reset();\n+\n+        r = UPNP_DeletePortMapping(urls.controlURL, data.first.servicetype, port.c_str(), \"TCP\", 0);\n+        LogPrintf(\"UPNP_DeletePortMapping() returned: %d\\n\", r);\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        FreeUPNPUrls(&urls);\n+    } else {\n+        LogPrintf(\"No valid UPnP IGDs found\\n\");\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        if (r != 0)\n+            FreeUPNPUrls(&urls);\n+    }\n+\n+    return ret;\n+}\n+#endif // #ifdef USE_UPNP\n+\n+static void ThreadMapPort()\n+{\n+    bool ok;\n+    do {\n+        ok = false;\n+\n+#ifdef USE_UPNP\n+        // High priority protocol.\n+        if (g_mapport_enabled_protos & MapPortProtoFlag::UPNP) {\n+            g_mapport_current_proto = MapPortProtoFlag::UPNP;\n+            ok = ProcessUpnp();\n+            if (ok) continue;\n+        }\n+#endif // #ifdef USE_UPNP\n+\n+#ifdef USE_NATPMP\n+        // Low priority protocol.\n+        if (g_mapport_enabled_protos & MapPortProtoFlag::NAT_PMP) {\n+            g_mapport_current_proto = MapPortProtoFlag::NAT_PMP;\n+            ok = ProcessNatpmp();\n+            if (ok) continue;\n+        }\n+#endif // #ifdef USE_NATPMP\n+\n+        g_mapport_current_proto = MapPortProtoFlag::NONE;\n+        if (g_mapport_enabled_protos == MapPortProtoFlag::NONE) {\n+            return;\n+        }\n+\n+    } while (ok || g_mapport_interrupt.sleep_for(PORT_MAPPING_RETRY_PERIOD));\n+}\n+\n+void StartThreadMapPort()\n+{\n+    if (!g_mapport_thread.joinable()) {\n+        assert(!g_mapport_interrupt);\n+        g_mapport_thread = std::thread(std::bind(&TraceThread<void (*)()>, \"mapport\", &ThreadMapPort));\n+    }\n+}\n+\n+static void DispatchMapPort()\n+{\n+    if (g_mapport_current_proto == MapPortProtoFlag::NONE && g_mapport_enabled_protos == MapPortProtoFlag::NONE) {\n+        return;\n+    }\n+\n+    if (g_mapport_current_proto == MapPortProtoFlag::NONE && g_mapport_enabled_protos != MapPortProtoFlag::NONE) {\n+        StartThreadMapPort();\n+        return;\n+    }\n+\n+    if (g_mapport_current_proto != MapPortProtoFlag::NONE && g_mapport_enabled_protos == MapPortProtoFlag::NONE) {\n+        InterruptMapPort();\n+        StopMapPort();\n+        return;\n+    }\n+\n+    if (g_mapport_enabled_protos & g_mapport_current_proto) {\n+        // Enabling another protocol does not cause switching from the currently used one.\n+        return;\n+    }\n+\n+    assert(g_mapport_thread.joinable());\n+    assert(!g_mapport_interrupt);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r515414822",
      "id" : 515414822,
      "line" : 285,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQxNDgyMg==",
      "original_commit_id" : "29fb5708ca04da9ca0c25c1b801887354eb714bc",
      "original_line" : 285,
      "original_position" : 291,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : 285,
      "pull_request_review_id" : 471997437,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/515414822",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r515428173"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/515428173"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Simultaneously? ",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-10-30T23:59:17Z",
      "diff_hunk" : "@@ -0,0 +1,9 @@\n+P2P and network changes\n+-----------------------\n+\n+- Added NAT-PMP port mapping support via [`libnatpmp`](https://miniupnp.tuxfamily.org/libnatpmp.html)\n+\n+Command-line options\n+--------------------\n+\n+-  The `-natpmp` option has been added to use NAT-PMP to map the listening port. If both `-upnp` and `-natpmp` options are provided, the former prevails.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r515428173",
      "id" : 515428173,
      "in_reply_to_id" : 474281799,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQyODE3Mw==",
      "original_commit_id" : "225f512438f4391f6af255f851131358e3c466a2",
      "original_line" : 9,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "doc/release-notes-18077.md",
      "position" : null,
      "pull_request_review_id" : 521090651,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/515428173",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-11-09T14:48:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-724059790",
      "id" : 724059790,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcyNDA1OTc5MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-09T14:48:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/724059790",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased 29fb5708ca04da9ca0c25c1b801887354eb714bc -> 3c26d53f538442363834178a45bc8b459b5b334d ([pr18077.44](https://github.com/hebasto/bitcoin/commits/pr18077.44) -> [pr18077.45](https://github.com/hebasto/bitcoin/commits/pr18077.45)) due to the conflicts with #20202, #20494 and the recent CI changes.",
      "created_at" : "2020-12-07T11:02:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-739845253",
      "id" : 739845253,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczOTg0NTI1Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-07T11:02:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/739845253",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r537609030"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/537609030"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think so due to the `CThreadInterrupt` class implementation.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-12-07T15:44:36Z",
      "diff_hunk" : "@@ -0,0 +1,342 @@\n+// Copyright (c) 2011-2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <netinet/in.h>\n+#endif // #ifdef WIN32\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif // #ifdef USE_UPNP\n+\n+#include <atomic>\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_mapport_interrupt;\n+static std::thread g_mapport_thread;\n+static std::atomic_uint g_mapport_enabled_protos{MapPortProtoFlag::NONE};\n+static std::atomic<MapPortProtoFlag> g_mapport_current_proto{MapPortProtoFlag::NONE};\n+static constexpr auto PORT_MAPPING_REANNOUNCE_PERIOD = std::chrono::minutes(20);\n+static constexpr auto PORT_MAPPING_RETRY_PERIOD = std::chrono::minutes(5);\n+\n+#ifdef USE_NATPMP\n+static uint16_t g_mapport_external_port = 0;\n+static bool NatpmpInit(natpmp_t* natpmp)\n+{\n+    const int r_init = initnatpmp(natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r_init == 0) return true;\n+    LogPrintf(\"natpmp: initnatpmp() failed with %d error.\\n\", r_init);\n+    return false;\n+}\n+\n+static bool NatpmpDiscover(natpmp_t* natpmp, struct in_addr& external_ipv4_addr)\n+{\n+    const int r_send = sendpublicaddressrequest(natpmp);\n+    if (r_send == 2 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            external_ipv4_addr = response.pnu.publicaddress.addr;\n+            return true;\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"natpmp: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"natpmp: sendpublicaddressrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool NatpmpMapping(natpmp_t* natpmp, const struct in_addr& external_ipv4_addr, uint16_t private_port, bool& external_ip_discovered)\n+{\n+    const uint16_t suggested_external_port = g_mapport_external_port ? g_mapport_external_port : private_port;\n+    const int r_send = sendnewportmappingrequest(natpmp, NATPMP_PROTOCOL_TCP, private_port, suggested_external_port, 3600 /*seconds*/);\n+    if (r_send == 12 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            auto pm = response.pnu.newportmapping;\n+            if (private_port == pm.privateport && pm.lifetime > 0) {\n+                g_mapport_external_port = pm.mappedpublicport;\n+                const CService external{external_ipv4_addr, pm.mappedpublicport};\n+                if (!external_ip_discovered && fDiscover) {\n+                    AddLocal(external, LOCAL_MAPPED);\n+                    external_ip_discovered = true;\n+                }\n+\n+                LogPrintf(\"natpmp: Port mapping successful. External address = %s\\n\", external.ToString());\n+                return true;\n+            } else {\n+                LogPrintf(\"natpmp: Port mapping failed.\\n\");\n+            }\n+\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"natpmp: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"natpmp: sendnewportmappingrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool ProcessNatpmp()\n+{\n+    bool ret = false;\n+    natpmp_t natpmp;\n+    struct in_addr external_ipv4_addr;\n+    if (NatpmpInit(&natpmp) && NatpmpDiscover(&natpmp, external_ipv4_addr)) {\n+        bool external_ip_discovered = false;\n+        const uint16_t private_port = GetListenPort();\n+        do {\n+            ret = NatpmpMapping(&natpmp, external_ipv4_addr, private_port, external_ip_discovered);\n+        } while (ret && g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+        g_mapport_interrupt.reset();\n+\n+        const int r_send = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, private_port, g_mapport_external_port, /* remove a port mapping */ 0);\n+        g_mapport_external_port = 0;\n+        if (r_send == 12 /* OK */) {\n+            LogPrintf(\"natpmp: Port mapping removed successfully.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: sendnewportmappingrequest(0) failed with %d error.\\n\", r_send);\n+        }\n+    }\n+\n+    closenatpmp(&natpmp);\n+    return ret;\n+}\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+static bool ProcessUpnp()\n+{\n+    bool ret = false;\n+    std::string port = strprintf(\"%u\", GetListenPort());\n+    const char * multicastif = nullptr;\n+    const char * minissdpdpath = nullptr;\n+    struct UPNPDev * devlist = nullptr;\n+    char lanaddr[64];\n+\n+    int error = 0;\n+#if MINIUPNPC_API_VERSION < 14\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, &error);\n+#else\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, 2, &error);\n+#endif\n+\n+    struct UPNPUrls urls;\n+    struct IGDdatas data;\n+    int r;\n+\n+    r = UPNP_GetValidIGD(devlist, &urls, &data, lanaddr, sizeof(lanaddr));\n+    if (r == 1)\n+    {\n+        if (fDiscover) {\n+            char externalIPAddress[40];\n+            r = UPNP_GetExternalIPAddress(urls.controlURL, data.first.servicetype, externalIPAddress);\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"UPnP: GetExternalIPAddress() returned %d\\n\", r);\n+            } else {\n+                if (externalIPAddress[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(externalIPAddress, resolved, false)) {\n+                        LogPrintf(\"UPnP: ExternalIPAddress = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"UPnP: GetExternalIPAddress failed.\\n\");\n+                }\n+            }\n+        }\n+\n+        std::string strDesc = PACKAGE_NAME \" \" + FormatFullVersion();\n+\n+        do {\n+            r = UPNP_AddPortMapping(urls.controlURL, data.first.servicetype, port.c_str(), port.c_str(), lanaddr, strDesc.c_str(), \"TCP\", 0, \"0\");\n+\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                ret = false;\n+                LogPrintf(\"AddPortMapping(%s, %s, %s) failed with code %d (%s)\\n\", port, port, lanaddr, r, strupnperror(r));\n+                break;\n+            } else {\n+                ret = true;\n+                LogPrintf(\"UPnP Port Mapping successful.\\n\");\n+            }\n+        } while (g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+        g_mapport_interrupt.reset();\n+\n+        r = UPNP_DeletePortMapping(urls.controlURL, data.first.servicetype, port.c_str(), \"TCP\", 0);\n+        LogPrintf(\"UPNP_DeletePortMapping() returned: %d\\n\", r);\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        FreeUPNPUrls(&urls);\n+    } else {\n+        LogPrintf(\"No valid UPnP IGDs found\\n\");\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        if (r != 0)\n+            FreeUPNPUrls(&urls);\n+    }\n+\n+    return ret;\n+}\n+#endif // #ifdef USE_UPNP\n+\n+static void ThreadMapPort()\n+{\n+    bool ok;\n+    do {\n+        ok = false;\n+\n+#ifdef USE_UPNP\n+        // High priority protocol.\n+        if (g_mapport_enabled_protos & MapPortProtoFlag::UPNP) {\n+            g_mapport_current_proto = MapPortProtoFlag::UPNP;\n+            ok = ProcessUpnp();\n+            if (ok) continue;\n+        }\n+#endif // #ifdef USE_UPNP\n+\n+#ifdef USE_NATPMP\n+        // Low priority protocol.\n+        if (g_mapport_enabled_protos & MapPortProtoFlag::NAT_PMP) {\n+            g_mapport_current_proto = MapPortProtoFlag::NAT_PMP;\n+            ok = ProcessNatpmp();\n+            if (ok) continue;\n+        }\n+#endif // #ifdef USE_NATPMP\n+\n+        g_mapport_current_proto = MapPortProtoFlag::NONE;\n+        if (g_mapport_enabled_protos == MapPortProtoFlag::NONE) {\n+            return;\n+        }\n+\n+    } while (ok || g_mapport_interrupt.sleep_for(PORT_MAPPING_RETRY_PERIOD));\n+}\n+\n+void StartThreadMapPort()\n+{\n+    if (!g_mapport_thread.joinable()) {\n+        assert(!g_mapport_interrupt);\n+        g_mapport_thread = std::thread(std::bind(&TraceThread<void (*)()>, \"mapport\", &ThreadMapPort));\n+    }\n+}\n+\n+static void DispatchMapPort()\n+{\n+    if (g_mapport_current_proto == MapPortProtoFlag::NONE && g_mapport_enabled_protos == MapPortProtoFlag::NONE) {\n+        return;\n+    }\n+\n+    if (g_mapport_current_proto == MapPortProtoFlag::NONE && g_mapport_enabled_protos != MapPortProtoFlag::NONE) {\n+        StartThreadMapPort();\n+        return;\n+    }\n+\n+    if (g_mapport_current_proto != MapPortProtoFlag::NONE && g_mapport_enabled_protos == MapPortProtoFlag::NONE) {\n+        InterruptMapPort();\n+        StopMapPort();\n+        return;\n+    }\n+\n+    if (g_mapport_enabled_protos & g_mapport_current_proto) {\n+        // Enabling another protocol does not cause switching from the currently used one.\n+        return;\n+    }\n+\n+    assert(g_mapport_thread.joinable());\n+    assert(!g_mapport_interrupt);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r537609030",
      "id" : 537609030,
      "in_reply_to_id" : 515414822,
      "line" : 285,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYwOTAzMA==",
      "original_commit_id" : "29fb5708ca04da9ca0c25c1b801887354eb714bc",
      "original_line" : 285,
      "original_position" : 291,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : 285,
      "pull_request_review_id" : 546274855,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/537609030",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-12-10T12:38:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-742495716",
      "id" : 742495716,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0MjQ5NTcxNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-10T12:38:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/742495716",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased 3c26d53f538442363834178a45bc8b459b5b334d -> cc68169e72c5b28fe53466a86eeac9fd214cd0d1 ([pr18077.45](https://github.com/hebasto/bitcoin/commits/pr18077.45) -> [pr18077.46](https://github.com/hebasto/bitcoin/commits/pr18077.46)) due to the conflict with #20527.",
      "created_at" : "2020-12-10T18:30:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-742709774",
      "id" : 742709774,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0MjcwOTc3NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-10T18:30:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/742709774",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-12-15T10:10:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-745188313",
      "id" : 745188313,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0NTE4ODMxMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-15T10:10:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/745188313",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased cc68169e72c5b28fe53466a86eeac9fd214cd0d1 -> 93ff21a929ba3036d6cd5d822f300cf036ff939f ([pr18077.46](https://github.com/hebasto/bitcoin/commits/pr18077.46) -> [pr18077.47](https://github.com/hebasto/bitcoin/commits/pr18077.47)) due to the conflict with https://github.com/bitcoin-core/gui/pull/115.",
      "created_at" : "2020-12-15T18:29:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-745479342",
      "id" : 745479342,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0NTQ3OTM0Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-15T18:29:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/745479342",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "In case any of this is helpful... I wanted to try running this, I'm running Ubuntu 18.04 as a Virtualbox guest on a Windows 10 host running at home (Xfinity-Comcast, nothing unusual), I checked out branch `pr18077.47`, ran\r\n```\r\n$ sudo apt install libminiupnpc-dev libnatpmp-dev\r\n(... successful)\r\n$ ./autogen.sh && ./configure --disable-wallet --without-miniupnpc --enable-natpmp-default && make\r\n(...)\r\nchecking whether to build with support for UPnP... no\r\nchecking whether to build with support for NAT-PMP... yes\r\nchecking whether to build with NAT-PMP enabled by default... yes\r\n(...)\r\n$ src/bitcoind\r\n```\r\nStarts up normally, but this prints to `debug.log` every 5 minutes:\r\n```\r\n2020-12-16T19:14:17Z natpmp: The gateway does not support NAT-PMP.\r\n```\r\nand `bitcoin-cli -netstat` shows that I have no incoming peers. I think this is all as expected, but I'm not testing much. I don't know how to change my gateway to support NAT-PMP (I'd appreciate any help). I did change my cable modem router's firewall to allow P2P applications on both IPv4 and IPv6, but that didn't make any difference.",
      "created_at" : "2020-12-16T20:44:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-746986174",
      "id" : 746986174,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0Njk4NjE3NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-16T20:44:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/746986174",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@LarryRuane \r\n\r\nThanks for testing!\r\n\r\n> I don't know how to change my gateway to support NAT-PMP (I'd appreciate any help).\r\n\r\nYour gateway s/w manual (if available) could help. My TP-Link Archer C6  does not have NAT-PMP support with stock s/w, so I've flashed the OpenWrt on it.",
      "created_at" : "2020-12-17T09:32:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-747323211",
      "id" : 747323211,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0NzMyMzIxMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-17T09:32:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/747323211",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Looked over the overall changes, they look reasonable to me.\r\nWill test.",
      "created_at" : "2020-12-17T13:10:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-747429639",
      "id" : 747429639,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0NzQyOTYzOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-17T13:10:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/747429639",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r545078633"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545078633"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why is NATPMP \"low priority\"? I think NATPMP is the preferred protocol? (for one, it's simpler so less prone to exploitation)",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-12-17T13:11:45Z",
      "diff_hunk" : "@@ -0,0 +1,342 @@\n+// Copyright (c) 2011-2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <netinet/in.h>\n+#endif // #ifdef WIN32\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif // #ifdef USE_UPNP\n+\n+#include <atomic>\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_mapport_interrupt;\n+static std::thread g_mapport_thread;\n+static std::atomic_uint g_mapport_enabled_protos{MapPortProtoFlag::NONE};\n+static std::atomic<MapPortProtoFlag> g_mapport_current_proto{MapPortProtoFlag::NONE};\n+static constexpr auto PORT_MAPPING_REANNOUNCE_PERIOD = std::chrono::minutes(20);\n+static constexpr auto PORT_MAPPING_RETRY_PERIOD = std::chrono::minutes(5);\n+\n+#ifdef USE_NATPMP\n+static uint16_t g_mapport_external_port = 0;\n+static bool NatpmpInit(natpmp_t* natpmp)\n+{\n+    const int r_init = initnatpmp(natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r_init == 0) return true;\n+    LogPrintf(\"natpmp: initnatpmp() failed with %d error.\\n\", r_init);\n+    return false;\n+}\n+\n+static bool NatpmpDiscover(natpmp_t* natpmp, struct in_addr& external_ipv4_addr)\n+{\n+    const int r_send = sendpublicaddressrequest(natpmp);\n+    if (r_send == 2 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            external_ipv4_addr = response.pnu.publicaddress.addr;\n+            return true;\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"natpmp: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"natpmp: sendpublicaddressrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool NatpmpMapping(natpmp_t* natpmp, const struct in_addr& external_ipv4_addr, uint16_t private_port, bool& external_ip_discovered)\n+{\n+    const uint16_t suggested_external_port = g_mapport_external_port ? g_mapport_external_port : private_port;\n+    const int r_send = sendnewportmappingrequest(natpmp, NATPMP_PROTOCOL_TCP, private_port, suggested_external_port, 3600 /*seconds*/);\n+    if (r_send == 12 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            auto pm = response.pnu.newportmapping;\n+            if (private_port == pm.privateport && pm.lifetime > 0) {\n+                g_mapport_external_port = pm.mappedpublicport;\n+                const CService external{external_ipv4_addr, pm.mappedpublicport};\n+                if (!external_ip_discovered && fDiscover) {\n+                    AddLocal(external, LOCAL_MAPPED);\n+                    external_ip_discovered = true;\n+                }\n+\n+                LogPrintf(\"natpmp: Port mapping successful. External address = %s\\n\", external.ToString());\n+                return true;\n+            } else {\n+                LogPrintf(\"natpmp: Port mapping failed.\\n\");\n+            }\n+\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"natpmp: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"natpmp: sendnewportmappingrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool ProcessNatpmp()\n+{\n+    bool ret = false;\n+    natpmp_t natpmp;\n+    struct in_addr external_ipv4_addr;\n+    if (NatpmpInit(&natpmp) && NatpmpDiscover(&natpmp, external_ipv4_addr)) {\n+        bool external_ip_discovered = false;\n+        const uint16_t private_port = GetListenPort();\n+        do {\n+            ret = NatpmpMapping(&natpmp, external_ipv4_addr, private_port, external_ip_discovered);\n+        } while (ret && g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+        g_mapport_interrupt.reset();\n+\n+        const int r_send = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, private_port, g_mapport_external_port, /* remove a port mapping */ 0);\n+        g_mapport_external_port = 0;\n+        if (r_send == 12 /* OK */) {\n+            LogPrintf(\"natpmp: Port mapping removed successfully.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: sendnewportmappingrequest(0) failed with %d error.\\n\", r_send);\n+        }\n+    }\n+\n+    closenatpmp(&natpmp);\n+    return ret;\n+}\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+static bool ProcessUpnp()\n+{\n+    bool ret = false;\n+    std::string port = strprintf(\"%u\", GetListenPort());\n+    const char * multicastif = nullptr;\n+    const char * minissdpdpath = nullptr;\n+    struct UPNPDev * devlist = nullptr;\n+    char lanaddr[64];\n+\n+    int error = 0;\n+#if MINIUPNPC_API_VERSION < 14\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, &error);\n+#else\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, 2, &error);\n+#endif\n+\n+    struct UPNPUrls urls;\n+    struct IGDdatas data;\n+    int r;\n+\n+    r = UPNP_GetValidIGD(devlist, &urls, &data, lanaddr, sizeof(lanaddr));\n+    if (r == 1)\n+    {\n+        if (fDiscover) {\n+            char externalIPAddress[40];\n+            r = UPNP_GetExternalIPAddress(urls.controlURL, data.first.servicetype, externalIPAddress);\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"UPnP: GetExternalIPAddress() returned %d\\n\", r);\n+            } else {\n+                if (externalIPAddress[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(externalIPAddress, resolved, false)) {\n+                        LogPrintf(\"UPnP: ExternalIPAddress = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"UPnP: GetExternalIPAddress failed.\\n\");\n+                }\n+            }\n+        }\n+\n+        std::string strDesc = PACKAGE_NAME \" \" + FormatFullVersion();\n+\n+        do {\n+            r = UPNP_AddPortMapping(urls.controlURL, data.first.servicetype, port.c_str(), port.c_str(), lanaddr, strDesc.c_str(), \"TCP\", 0, \"0\");\n+\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                ret = false;\n+                LogPrintf(\"AddPortMapping(%s, %s, %s) failed with code %d (%s)\\n\", port, port, lanaddr, r, strupnperror(r));\n+                break;\n+            } else {\n+                ret = true;\n+                LogPrintf(\"UPnP Port Mapping successful.\\n\");\n+            }\n+        } while (g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+        g_mapport_interrupt.reset();\n+\n+        r = UPNP_DeletePortMapping(urls.controlURL, data.first.servicetype, port.c_str(), \"TCP\", 0);\n+        LogPrintf(\"UPNP_DeletePortMapping() returned: %d\\n\", r);\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        FreeUPNPUrls(&urls);\n+    } else {\n+        LogPrintf(\"No valid UPnP IGDs found\\n\");\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        if (r != 0)\n+            FreeUPNPUrls(&urls);\n+    }\n+\n+    return ret;\n+}\n+#endif // #ifdef USE_UPNP\n+\n+static void ThreadMapPort()\n+{\n+    bool ok;\n+    do {\n+        ok = false;\n+\n+#ifdef USE_UPNP\n+        // High priority protocol.\n+        if (g_mapport_enabled_protos & MapPortProtoFlag::UPNP) {\n+            g_mapport_current_proto = MapPortProtoFlag::UPNP;\n+            ok = ProcessUpnp();\n+            if (ok) continue;\n+        }\n+#endif // #ifdef USE_UPNP\n+\n+#ifdef USE_NATPMP\n+        // Low priority protocol.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r545078633",
      "id" : 545078633,
      "line" : 238,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTA3ODYzMw==",
      "original_commit_id" : "93ff21a929ba3036d6cd5d822f300cf036ff939f",
      "original_line" : 238,
      "original_position" : 244,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : 238,
      "pull_request_review_id" : 554588978,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545078633",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r545080902"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545080902"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-588484002 by @luke-jr ",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-12-17T13:15:17Z",
      "diff_hunk" : "@@ -0,0 +1,342 @@\n+// Copyright (c) 2011-2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <netinet/in.h>\n+#endif // #ifdef WIN32\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif // #ifdef USE_UPNP\n+\n+#include <atomic>\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_mapport_interrupt;\n+static std::thread g_mapport_thread;\n+static std::atomic_uint g_mapport_enabled_protos{MapPortProtoFlag::NONE};\n+static std::atomic<MapPortProtoFlag> g_mapport_current_proto{MapPortProtoFlag::NONE};\n+static constexpr auto PORT_MAPPING_REANNOUNCE_PERIOD = std::chrono::minutes(20);\n+static constexpr auto PORT_MAPPING_RETRY_PERIOD = std::chrono::minutes(5);\n+\n+#ifdef USE_NATPMP\n+static uint16_t g_mapport_external_port = 0;\n+static bool NatpmpInit(natpmp_t* natpmp)\n+{\n+    const int r_init = initnatpmp(natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r_init == 0) return true;\n+    LogPrintf(\"natpmp: initnatpmp() failed with %d error.\\n\", r_init);\n+    return false;\n+}\n+\n+static bool NatpmpDiscover(natpmp_t* natpmp, struct in_addr& external_ipv4_addr)\n+{\n+    const int r_send = sendpublicaddressrequest(natpmp);\n+    if (r_send == 2 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            external_ipv4_addr = response.pnu.publicaddress.addr;\n+            return true;\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"natpmp: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"natpmp: sendpublicaddressrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool NatpmpMapping(natpmp_t* natpmp, const struct in_addr& external_ipv4_addr, uint16_t private_port, bool& external_ip_discovered)\n+{\n+    const uint16_t suggested_external_port = g_mapport_external_port ? g_mapport_external_port : private_port;\n+    const int r_send = sendnewportmappingrequest(natpmp, NATPMP_PROTOCOL_TCP, private_port, suggested_external_port, 3600 /*seconds*/);\n+    if (r_send == 12 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            auto pm = response.pnu.newportmapping;\n+            if (private_port == pm.privateport && pm.lifetime > 0) {\n+                g_mapport_external_port = pm.mappedpublicport;\n+                const CService external{external_ipv4_addr, pm.mappedpublicport};\n+                if (!external_ip_discovered && fDiscover) {\n+                    AddLocal(external, LOCAL_MAPPED);\n+                    external_ip_discovered = true;\n+                }\n+\n+                LogPrintf(\"natpmp: Port mapping successful. External address = %s\\n\", external.ToString());\n+                return true;\n+            } else {\n+                LogPrintf(\"natpmp: Port mapping failed.\\n\");\n+            }\n+\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"natpmp: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"natpmp: sendnewportmappingrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool ProcessNatpmp()\n+{\n+    bool ret = false;\n+    natpmp_t natpmp;\n+    struct in_addr external_ipv4_addr;\n+    if (NatpmpInit(&natpmp) && NatpmpDiscover(&natpmp, external_ipv4_addr)) {\n+        bool external_ip_discovered = false;\n+        const uint16_t private_port = GetListenPort();\n+        do {\n+            ret = NatpmpMapping(&natpmp, external_ipv4_addr, private_port, external_ip_discovered);\n+        } while (ret && g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+        g_mapport_interrupt.reset();\n+\n+        const int r_send = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, private_port, g_mapport_external_port, /* remove a port mapping */ 0);\n+        g_mapport_external_port = 0;\n+        if (r_send == 12 /* OK */) {\n+            LogPrintf(\"natpmp: Port mapping removed successfully.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: sendnewportmappingrequest(0) failed with %d error.\\n\", r_send);\n+        }\n+    }\n+\n+    closenatpmp(&natpmp);\n+    return ret;\n+}\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+static bool ProcessUpnp()\n+{\n+    bool ret = false;\n+    std::string port = strprintf(\"%u\", GetListenPort());\n+    const char * multicastif = nullptr;\n+    const char * minissdpdpath = nullptr;\n+    struct UPNPDev * devlist = nullptr;\n+    char lanaddr[64];\n+\n+    int error = 0;\n+#if MINIUPNPC_API_VERSION < 14\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, &error);\n+#else\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, 2, &error);\n+#endif\n+\n+    struct UPNPUrls urls;\n+    struct IGDdatas data;\n+    int r;\n+\n+    r = UPNP_GetValidIGD(devlist, &urls, &data, lanaddr, sizeof(lanaddr));\n+    if (r == 1)\n+    {\n+        if (fDiscover) {\n+            char externalIPAddress[40];\n+            r = UPNP_GetExternalIPAddress(urls.controlURL, data.first.servicetype, externalIPAddress);\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"UPnP: GetExternalIPAddress() returned %d\\n\", r);\n+            } else {\n+                if (externalIPAddress[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(externalIPAddress, resolved, false)) {\n+                        LogPrintf(\"UPnP: ExternalIPAddress = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"UPnP: GetExternalIPAddress failed.\\n\");\n+                }\n+            }\n+        }\n+\n+        std::string strDesc = PACKAGE_NAME \" \" + FormatFullVersion();\n+\n+        do {\n+            r = UPNP_AddPortMapping(urls.controlURL, data.first.servicetype, port.c_str(), port.c_str(), lanaddr, strDesc.c_str(), \"TCP\", 0, \"0\");\n+\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                ret = false;\n+                LogPrintf(\"AddPortMapping(%s, %s, %s) failed with code %d (%s)\\n\", port, port, lanaddr, r, strupnperror(r));\n+                break;\n+            } else {\n+                ret = true;\n+                LogPrintf(\"UPnP Port Mapping successful.\\n\");\n+            }\n+        } while (g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+        g_mapport_interrupt.reset();\n+\n+        r = UPNP_DeletePortMapping(urls.controlURL, data.first.servicetype, port.c_str(), \"TCP\", 0);\n+        LogPrintf(\"UPNP_DeletePortMapping() returned: %d\\n\", r);\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        FreeUPNPUrls(&urls);\n+    } else {\n+        LogPrintf(\"No valid UPnP IGDs found\\n\");\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        if (r != 0)\n+            FreeUPNPUrls(&urls);\n+    }\n+\n+    return ret;\n+}\n+#endif // #ifdef USE_UPNP\n+\n+static void ThreadMapPort()\n+{\n+    bool ok;\n+    do {\n+        ok = false;\n+\n+#ifdef USE_UPNP\n+        // High priority protocol.\n+        if (g_mapport_enabled_protos & MapPortProtoFlag::UPNP) {\n+            g_mapport_current_proto = MapPortProtoFlag::UPNP;\n+            ok = ProcessUpnp();\n+            if (ok) continue;\n+        }\n+#endif // #ifdef USE_UPNP\n+\n+#ifdef USE_NATPMP\n+        // Low priority protocol.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r545080902",
      "id" : 545080902,
      "in_reply_to_id" : 545078633,
      "line" : 238,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTA4MDkwMg==",
      "original_commit_id" : "93ff21a929ba3036d6cd5d822f300cf036ff939f",
      "original_line" : 238,
      "original_position" : 244,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : 238,
      "pull_request_review_id" : 554591662,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545080902",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r545081619"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545081619"
         }
      },
      "author_association" : "MEMBER",
      "body" : "FWIW, I disagree. I think we should prefer NATPMP and phase out UPnP in the longer run when it has proven to be stable.\r\n(of course, if a lot of issues actually come up it's different, but I wouldn't do this based on one comment)",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-12-17T13:16:27Z",
      "diff_hunk" : "@@ -0,0 +1,342 @@\n+// Copyright (c) 2011-2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <netinet/in.h>\n+#endif // #ifdef WIN32\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif // #ifdef USE_UPNP\n+\n+#include <atomic>\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_mapport_interrupt;\n+static std::thread g_mapport_thread;\n+static std::atomic_uint g_mapport_enabled_protos{MapPortProtoFlag::NONE};\n+static std::atomic<MapPortProtoFlag> g_mapport_current_proto{MapPortProtoFlag::NONE};\n+static constexpr auto PORT_MAPPING_REANNOUNCE_PERIOD = std::chrono::minutes(20);\n+static constexpr auto PORT_MAPPING_RETRY_PERIOD = std::chrono::minutes(5);\n+\n+#ifdef USE_NATPMP\n+static uint16_t g_mapport_external_port = 0;\n+static bool NatpmpInit(natpmp_t* natpmp)\n+{\n+    const int r_init = initnatpmp(natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r_init == 0) return true;\n+    LogPrintf(\"natpmp: initnatpmp() failed with %d error.\\n\", r_init);\n+    return false;\n+}\n+\n+static bool NatpmpDiscover(natpmp_t* natpmp, struct in_addr& external_ipv4_addr)\n+{\n+    const int r_send = sendpublicaddressrequest(natpmp);\n+    if (r_send == 2 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            external_ipv4_addr = response.pnu.publicaddress.addr;\n+            return true;\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"natpmp: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"natpmp: sendpublicaddressrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool NatpmpMapping(natpmp_t* natpmp, const struct in_addr& external_ipv4_addr, uint16_t private_port, bool& external_ip_discovered)\n+{\n+    const uint16_t suggested_external_port = g_mapport_external_port ? g_mapport_external_port : private_port;\n+    const int r_send = sendnewportmappingrequest(natpmp, NATPMP_PROTOCOL_TCP, private_port, suggested_external_port, 3600 /*seconds*/);\n+    if (r_send == 12 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            auto pm = response.pnu.newportmapping;\n+            if (private_port == pm.privateport && pm.lifetime > 0) {\n+                g_mapport_external_port = pm.mappedpublicport;\n+                const CService external{external_ipv4_addr, pm.mappedpublicport};\n+                if (!external_ip_discovered && fDiscover) {\n+                    AddLocal(external, LOCAL_MAPPED);\n+                    external_ip_discovered = true;\n+                }\n+\n+                LogPrintf(\"natpmp: Port mapping successful. External address = %s\\n\", external.ToString());\n+                return true;\n+            } else {\n+                LogPrintf(\"natpmp: Port mapping failed.\\n\");\n+            }\n+\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"natpmp: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"natpmp: sendnewportmappingrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool ProcessNatpmp()\n+{\n+    bool ret = false;\n+    natpmp_t natpmp;\n+    struct in_addr external_ipv4_addr;\n+    if (NatpmpInit(&natpmp) && NatpmpDiscover(&natpmp, external_ipv4_addr)) {\n+        bool external_ip_discovered = false;\n+        const uint16_t private_port = GetListenPort();\n+        do {\n+            ret = NatpmpMapping(&natpmp, external_ipv4_addr, private_port, external_ip_discovered);\n+        } while (ret && g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+        g_mapport_interrupt.reset();\n+\n+        const int r_send = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, private_port, g_mapport_external_port, /* remove a port mapping */ 0);\n+        g_mapport_external_port = 0;\n+        if (r_send == 12 /* OK */) {\n+            LogPrintf(\"natpmp: Port mapping removed successfully.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: sendnewportmappingrequest(0) failed with %d error.\\n\", r_send);\n+        }\n+    }\n+\n+    closenatpmp(&natpmp);\n+    return ret;\n+}\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+static bool ProcessUpnp()\n+{\n+    bool ret = false;\n+    std::string port = strprintf(\"%u\", GetListenPort());\n+    const char * multicastif = nullptr;\n+    const char * minissdpdpath = nullptr;\n+    struct UPNPDev * devlist = nullptr;\n+    char lanaddr[64];\n+\n+    int error = 0;\n+#if MINIUPNPC_API_VERSION < 14\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, &error);\n+#else\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, 2, &error);\n+#endif\n+\n+    struct UPNPUrls urls;\n+    struct IGDdatas data;\n+    int r;\n+\n+    r = UPNP_GetValidIGD(devlist, &urls, &data, lanaddr, sizeof(lanaddr));\n+    if (r == 1)\n+    {\n+        if (fDiscover) {\n+            char externalIPAddress[40];\n+            r = UPNP_GetExternalIPAddress(urls.controlURL, data.first.servicetype, externalIPAddress);\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"UPnP: GetExternalIPAddress() returned %d\\n\", r);\n+            } else {\n+                if (externalIPAddress[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(externalIPAddress, resolved, false)) {\n+                        LogPrintf(\"UPnP: ExternalIPAddress = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"UPnP: GetExternalIPAddress failed.\\n\");\n+                }\n+            }\n+        }\n+\n+        std::string strDesc = PACKAGE_NAME \" \" + FormatFullVersion();\n+\n+        do {\n+            r = UPNP_AddPortMapping(urls.controlURL, data.first.servicetype, port.c_str(), port.c_str(), lanaddr, strDesc.c_str(), \"TCP\", 0, \"0\");\n+\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                ret = false;\n+                LogPrintf(\"AddPortMapping(%s, %s, %s) failed with code %d (%s)\\n\", port, port, lanaddr, r, strupnperror(r));\n+                break;\n+            } else {\n+                ret = true;\n+                LogPrintf(\"UPnP Port Mapping successful.\\n\");\n+            }\n+        } while (g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+        g_mapport_interrupt.reset();\n+\n+        r = UPNP_DeletePortMapping(urls.controlURL, data.first.servicetype, port.c_str(), \"TCP\", 0);\n+        LogPrintf(\"UPNP_DeletePortMapping() returned: %d\\n\", r);\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        FreeUPNPUrls(&urls);\n+    } else {\n+        LogPrintf(\"No valid UPnP IGDs found\\n\");\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        if (r != 0)\n+            FreeUPNPUrls(&urls);\n+    }\n+\n+    return ret;\n+}\n+#endif // #ifdef USE_UPNP\n+\n+static void ThreadMapPort()\n+{\n+    bool ok;\n+    do {\n+        ok = false;\n+\n+#ifdef USE_UPNP\n+        // High priority protocol.\n+        if (g_mapport_enabled_protos & MapPortProtoFlag::UPNP) {\n+            g_mapport_current_proto = MapPortProtoFlag::UPNP;\n+            ok = ProcessUpnp();\n+            if (ok) continue;\n+        }\n+#endif // #ifdef USE_UPNP\n+\n+#ifdef USE_NATPMP\n+        // Low priority protocol.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r545081619",
      "id" : 545081619,
      "in_reply_to_id" : 545078633,
      "line" : 238,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTA4MTYxOQ==",
      "original_commit_id" : "93ff21a929ba3036d6cd5d822f300cf036ff939f",
      "original_line" : 238,
      "original_position" : 244,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : 238,
      "pull_request_review_id" : 554592553,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545081619",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "It works !\r\n\r\n- On Ubuntu 20.04 I installed the `libnatpmp-dev` package, re-ran configure, it was detected correctly and enabled\r\n- I run bitcoind with `-natpmp -regtest`\r\n\r\nI see the following in my log\r\n```\r\n2020-12-17T15:06:10Z natpmp: Port mapping successful. External address = x.x.x.x:18444\r\n```\r\nMy router's admin interface show the redirect:\r\n```\r\nProtocol | External Port | Client Address | Client Port | Â \r\n-- | -- | -- | -- | --\r\nTCP | 18444 | 192.168.x.x | 18444\r\n```\r\nI have verified that I can connect to the host/port from a remote server.",
      "created_at" : "2020-12-17T15:14:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-747500131",
      "id" : 747500131,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0NzUwMDEzMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-17T15:21:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/747500131",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r545181363"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545181363"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think we can avoid this platform dependent include dance by including `<compat.h>`.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-12-17T15:32:13Z",
      "diff_hunk" : "@@ -0,0 +1,342 @@\n+// Copyright (c) 2011-2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#ifdef WIN32\n+#include <winsock2.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r545181363",
      "id" : 545181363,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTE4MTM2Mw==",
      "original_commit_id" : "93ff21a929ba3036d6cd5d822f300cf036ff939f",
      "original_line" : 22,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : null,
      "pull_request_review_id" : 554717639,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545181363",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r545195115"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545195115"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Spurious newline?",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-12-17T15:49:32Z",
      "diff_hunk" : "@@ -0,0 +1,342 @@\n+// Copyright (c) 2011-2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <netinet/in.h>\n+#endif // #ifdef WIN32\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif // #ifdef USE_UPNP\n+\n+#include <atomic>\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_mapport_interrupt;\n+static std::thread g_mapport_thread;\n+static std::atomic_uint g_mapport_enabled_protos{MapPortProtoFlag::NONE};\n+static std::atomic<MapPortProtoFlag> g_mapport_current_proto{MapPortProtoFlag::NONE};\n+static constexpr auto PORT_MAPPING_REANNOUNCE_PERIOD = std::chrono::minutes(20);\n+static constexpr auto PORT_MAPPING_RETRY_PERIOD = std::chrono::minutes(5);\n+\n+#ifdef USE_NATPMP\n+static uint16_t g_mapport_external_port = 0;\n+static bool NatpmpInit(natpmp_t* natpmp)\n+{\n+    const int r_init = initnatpmp(natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r_init == 0) return true;\n+    LogPrintf(\"natpmp: initnatpmp() failed with %d error.\\n\", r_init);\n+    return false;\n+}\n+\n+static bool NatpmpDiscover(natpmp_t* natpmp, struct in_addr& external_ipv4_addr)\n+{\n+    const int r_send = sendpublicaddressrequest(natpmp);\n+    if (r_send == 2 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            external_ipv4_addr = response.pnu.publicaddress.addr;\n+            return true;\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"natpmp: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r_read);\n+        }\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r545195115",
      "id" : 545195115,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTE5NTExNQ==",
      "original_commit_id" : "93ff21a929ba3036d6cd5d822f300cf036ff939f",
      "original_line" : 80,
      "original_position" : 80,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : null,
      "pull_request_review_id" : 554735167,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545195115",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r545198538"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545198538"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n        if (r != 0) FreeUPNPUrls(&urls);\r\n```",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-12-17T15:53:45Z",
      "diff_hunk" : "@@ -0,0 +1,342 @@\n+// Copyright (c) 2011-2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <netinet/in.h>\n+#endif // #ifdef WIN32\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif // #ifdef USE_UPNP\n+\n+#include <atomic>\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_mapport_interrupt;\n+static std::thread g_mapport_thread;\n+static std::atomic_uint g_mapport_enabled_protos{MapPortProtoFlag::NONE};\n+static std::atomic<MapPortProtoFlag> g_mapport_current_proto{MapPortProtoFlag::NONE};\n+static constexpr auto PORT_MAPPING_REANNOUNCE_PERIOD = std::chrono::minutes(20);\n+static constexpr auto PORT_MAPPING_RETRY_PERIOD = std::chrono::minutes(5);\n+\n+#ifdef USE_NATPMP\n+static uint16_t g_mapport_external_port = 0;\n+static bool NatpmpInit(natpmp_t* natpmp)\n+{\n+    const int r_init = initnatpmp(natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r_init == 0) return true;\n+    LogPrintf(\"natpmp: initnatpmp() failed with %d error.\\n\", r_init);\n+    return false;\n+}\n+\n+static bool NatpmpDiscover(natpmp_t* natpmp, struct in_addr& external_ipv4_addr)\n+{\n+    const int r_send = sendpublicaddressrequest(natpmp);\n+    if (r_send == 2 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            external_ipv4_addr = response.pnu.publicaddress.addr;\n+            return true;\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"natpmp: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"natpmp: sendpublicaddressrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool NatpmpMapping(natpmp_t* natpmp, const struct in_addr& external_ipv4_addr, uint16_t private_port, bool& external_ip_discovered)\n+{\n+    const uint16_t suggested_external_port = g_mapport_external_port ? g_mapport_external_port : private_port;\n+    const int r_send = sendnewportmappingrequest(natpmp, NATPMP_PROTOCOL_TCP, private_port, suggested_external_port, 3600 /*seconds*/);\n+    if (r_send == 12 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            auto pm = response.pnu.newportmapping;\n+            if (private_port == pm.privateport && pm.lifetime > 0) {\n+                g_mapport_external_port = pm.mappedpublicport;\n+                const CService external{external_ipv4_addr, pm.mappedpublicport};\n+                if (!external_ip_discovered && fDiscover) {\n+                    AddLocal(external, LOCAL_MAPPED);\n+                    external_ip_discovered = true;\n+                }\n+\n+                LogPrintf(\"natpmp: Port mapping successful. External address = %s\\n\", external.ToString());\n+                return true;\n+            } else {\n+                LogPrintf(\"natpmp: Port mapping failed.\\n\");\n+            }\n+\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"natpmp: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"natpmp: sendnewportmappingrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool ProcessNatpmp()\n+{\n+    bool ret = false;\n+    natpmp_t natpmp;\n+    struct in_addr external_ipv4_addr;\n+    if (NatpmpInit(&natpmp) && NatpmpDiscover(&natpmp, external_ipv4_addr)) {\n+        bool external_ip_discovered = false;\n+        const uint16_t private_port = GetListenPort();\n+        do {\n+            ret = NatpmpMapping(&natpmp, external_ipv4_addr, private_port, external_ip_discovered);\n+        } while (ret && g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+        g_mapport_interrupt.reset();\n+\n+        const int r_send = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, private_port, g_mapport_external_port, /* remove a port mapping */ 0);\n+        g_mapport_external_port = 0;\n+        if (r_send == 12 /* OK */) {\n+            LogPrintf(\"natpmp: Port mapping removed successfully.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: sendnewportmappingrequest(0) failed with %d error.\\n\", r_send);\n+        }\n+    }\n+\n+    closenatpmp(&natpmp);\n+    return ret;\n+}\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+static bool ProcessUpnp()\n+{\n+    bool ret = false;\n+    std::string port = strprintf(\"%u\", GetListenPort());\n+    const char * multicastif = nullptr;\n+    const char * minissdpdpath = nullptr;\n+    struct UPNPDev * devlist = nullptr;\n+    char lanaddr[64];\n+\n+    int error = 0;\n+#if MINIUPNPC_API_VERSION < 14\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, &error);\n+#else\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, 2, &error);\n+#endif\n+\n+    struct UPNPUrls urls;\n+    struct IGDdatas data;\n+    int r;\n+\n+    r = UPNP_GetValidIGD(devlist, &urls, &data, lanaddr, sizeof(lanaddr));\n+    if (r == 1)\n+    {\n+        if (fDiscover) {\n+            char externalIPAddress[40];\n+            r = UPNP_GetExternalIPAddress(urls.controlURL, data.first.servicetype, externalIPAddress);\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"UPnP: GetExternalIPAddress() returned %d\\n\", r);\n+            } else {\n+                if (externalIPAddress[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(externalIPAddress, resolved, false)) {\n+                        LogPrintf(\"UPnP: ExternalIPAddress = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"UPnP: GetExternalIPAddress failed.\\n\");\n+                }\n+            }\n+        }\n+\n+        std::string strDesc = PACKAGE_NAME \" \" + FormatFullVersion();\n+\n+        do {\n+            r = UPNP_AddPortMapping(urls.controlURL, data.first.servicetype, port.c_str(), port.c_str(), lanaddr, strDesc.c_str(), \"TCP\", 0, \"0\");\n+\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                ret = false;\n+                LogPrintf(\"AddPortMapping(%s, %s, %s) failed with code %d (%s)\\n\", port, port, lanaddr, r, strupnperror(r));\n+                break;\n+            } else {\n+                ret = true;\n+                LogPrintf(\"UPnP Port Mapping successful.\\n\");\n+            }\n+        } while (g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+        g_mapport_interrupt.reset();\n+\n+        r = UPNP_DeletePortMapping(urls.controlURL, data.first.servicetype, port.c_str(), \"TCP\", 0);\n+        LogPrintf(\"UPNP_DeletePortMapping() returned: %d\\n\", r);\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        FreeUPNPUrls(&urls);\n+    } else {\n+        LogPrintf(\"No valid UPnP IGDs found\\n\");\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        if (r != 0)\n+            FreeUPNPUrls(&urls);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r545198538",
      "id" : 545198538,
      "line" : 215,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTE5ODUzOA==",
      "original_commit_id" : "93ff21a929ba3036d6cd5d822f300cf036ff939f",
      "original_line" : 215,
      "original_position" : 221,
      "original_start_line" : 220,
      "path" : "src/mapport.cpp",
      "position" : 215,
      "pull_request_review_id" : 554739336,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : 214,
      "start_side" : "RIGHT",
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545198538",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r545199678"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545199678"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oh, this is a move-only part, ok.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-12-17T15:55:06Z",
      "diff_hunk" : "@@ -0,0 +1,342 @@\n+// Copyright (c) 2011-2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <netinet/in.h>\n+#endif // #ifdef WIN32\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif // #ifdef USE_UPNP\n+\n+#include <atomic>\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_mapport_interrupt;\n+static std::thread g_mapport_thread;\n+static std::atomic_uint g_mapport_enabled_protos{MapPortProtoFlag::NONE};\n+static std::atomic<MapPortProtoFlag> g_mapport_current_proto{MapPortProtoFlag::NONE};\n+static constexpr auto PORT_MAPPING_REANNOUNCE_PERIOD = std::chrono::minutes(20);\n+static constexpr auto PORT_MAPPING_RETRY_PERIOD = std::chrono::minutes(5);\n+\n+#ifdef USE_NATPMP\n+static uint16_t g_mapport_external_port = 0;\n+static bool NatpmpInit(natpmp_t* natpmp)\n+{\n+    const int r_init = initnatpmp(natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r_init == 0) return true;\n+    LogPrintf(\"natpmp: initnatpmp() failed with %d error.\\n\", r_init);\n+    return false;\n+}\n+\n+static bool NatpmpDiscover(natpmp_t* natpmp, struct in_addr& external_ipv4_addr)\n+{\n+    const int r_send = sendpublicaddressrequest(natpmp);\n+    if (r_send == 2 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            external_ipv4_addr = response.pnu.publicaddress.addr;\n+            return true;\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"natpmp: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"natpmp: sendpublicaddressrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool NatpmpMapping(natpmp_t* natpmp, const struct in_addr& external_ipv4_addr, uint16_t private_port, bool& external_ip_discovered)\n+{\n+    const uint16_t suggested_external_port = g_mapport_external_port ? g_mapport_external_port : private_port;\n+    const int r_send = sendnewportmappingrequest(natpmp, NATPMP_PROTOCOL_TCP, private_port, suggested_external_port, 3600 /*seconds*/);\n+    if (r_send == 12 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            auto pm = response.pnu.newportmapping;\n+            if (private_port == pm.privateport && pm.lifetime > 0) {\n+                g_mapport_external_port = pm.mappedpublicport;\n+                const CService external{external_ipv4_addr, pm.mappedpublicport};\n+                if (!external_ip_discovered && fDiscover) {\n+                    AddLocal(external, LOCAL_MAPPED);\n+                    external_ip_discovered = true;\n+                }\n+\n+                LogPrintf(\"natpmp: Port mapping successful. External address = %s\\n\", external.ToString());\n+                return true;\n+            } else {\n+                LogPrintf(\"natpmp: Port mapping failed.\\n\");\n+            }\n+\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"natpmp: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"natpmp: sendnewportmappingrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool ProcessNatpmp()\n+{\n+    bool ret = false;\n+    natpmp_t natpmp;\n+    struct in_addr external_ipv4_addr;\n+    if (NatpmpInit(&natpmp) && NatpmpDiscover(&natpmp, external_ipv4_addr)) {\n+        bool external_ip_discovered = false;\n+        const uint16_t private_port = GetListenPort();\n+        do {\n+            ret = NatpmpMapping(&natpmp, external_ipv4_addr, private_port, external_ip_discovered);\n+        } while (ret && g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+        g_mapport_interrupt.reset();\n+\n+        const int r_send = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, private_port, g_mapport_external_port, /* remove a port mapping */ 0);\n+        g_mapport_external_port = 0;\n+        if (r_send == 12 /* OK */) {\n+            LogPrintf(\"natpmp: Port mapping removed successfully.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: sendnewportmappingrequest(0) failed with %d error.\\n\", r_send);\n+        }\n+    }\n+\n+    closenatpmp(&natpmp);\n+    return ret;\n+}\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+static bool ProcessUpnp()\n+{\n+    bool ret = false;\n+    std::string port = strprintf(\"%u\", GetListenPort());\n+    const char * multicastif = nullptr;\n+    const char * minissdpdpath = nullptr;\n+    struct UPNPDev * devlist = nullptr;\n+    char lanaddr[64];\n+\n+    int error = 0;\n+#if MINIUPNPC_API_VERSION < 14\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, &error);\n+#else\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, 2, &error);\n+#endif\n+\n+    struct UPNPUrls urls;\n+    struct IGDdatas data;\n+    int r;\n+\n+    r = UPNP_GetValidIGD(devlist, &urls, &data, lanaddr, sizeof(lanaddr));\n+    if (r == 1)\n+    {\n+        if (fDiscover) {\n+            char externalIPAddress[40];\n+            r = UPNP_GetExternalIPAddress(urls.controlURL, data.first.servicetype, externalIPAddress);\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"UPnP: GetExternalIPAddress() returned %d\\n\", r);\n+            } else {\n+                if (externalIPAddress[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(externalIPAddress, resolved, false)) {\n+                        LogPrintf(\"UPnP: ExternalIPAddress = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"UPnP: GetExternalIPAddress failed.\\n\");\n+                }\n+            }\n+        }\n+\n+        std::string strDesc = PACKAGE_NAME \" \" + FormatFullVersion();\n+\n+        do {\n+            r = UPNP_AddPortMapping(urls.controlURL, data.first.servicetype, port.c_str(), port.c_str(), lanaddr, strDesc.c_str(), \"TCP\", 0, \"0\");\n+\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                ret = false;\n+                LogPrintf(\"AddPortMapping(%s, %s, %s) failed with code %d (%s)\\n\", port, port, lanaddr, r, strupnperror(r));\n+                break;\n+            } else {\n+                ret = true;\n+                LogPrintf(\"UPnP Port Mapping successful.\\n\");\n+            }\n+        } while (g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+        g_mapport_interrupt.reset();\n+\n+        r = UPNP_DeletePortMapping(urls.controlURL, data.first.servicetype, port.c_str(), \"TCP\", 0);\n+        LogPrintf(\"UPNP_DeletePortMapping() returned: %d\\n\", r);\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        FreeUPNPUrls(&urls);\n+    } else {\n+        LogPrintf(\"No valid UPnP IGDs found\\n\");\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        if (r != 0)\n+            FreeUPNPUrls(&urls);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r545199678",
      "id" : 545199678,
      "in_reply_to_id" : 545198538,
      "line" : 215,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTE5OTY3OA==",
      "original_commit_id" : "93ff21a929ba3036d6cd5d822f300cf036ff939f",
      "original_line" : 215,
      "original_position" : 221,
      "original_start_line" : 220,
      "path" : "src/mapport.cpp",
      "position" : 215,
      "pull_request_review_id" : 554740689,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : 214,
      "start_side" : "RIGHT",
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545199678",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r545270674"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545270674"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I guess at some point in the future we could replace this thread (which does nothing but waiting and periodically run stuff) with scheduler runnables instead? (not in this PR)",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-12-17T17:31:28Z",
      "diff_hunk" : "@@ -0,0 +1,342 @@\n+// Copyright (c) 2011-2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <netinet/in.h>\n+#endif // #ifdef WIN32\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif // #ifdef USE_UPNP\n+\n+#include <atomic>\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_mapport_interrupt;\n+static std::thread g_mapport_thread;\n+static std::atomic_uint g_mapport_enabled_protos{MapPortProtoFlag::NONE};\n+static std::atomic<MapPortProtoFlag> g_mapport_current_proto{MapPortProtoFlag::NONE};\n+static constexpr auto PORT_MAPPING_REANNOUNCE_PERIOD = std::chrono::minutes(20);\n+static constexpr auto PORT_MAPPING_RETRY_PERIOD = std::chrono::minutes(5);\n+\n+#ifdef USE_NATPMP\n+static uint16_t g_mapport_external_port = 0;\n+static bool NatpmpInit(natpmp_t* natpmp)\n+{\n+    const int r_init = initnatpmp(natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r_init == 0) return true;\n+    LogPrintf(\"natpmp: initnatpmp() failed with %d error.\\n\", r_init);\n+    return false;\n+}\n+\n+static bool NatpmpDiscover(natpmp_t* natpmp, struct in_addr& external_ipv4_addr)\n+{\n+    const int r_send = sendpublicaddressrequest(natpmp);\n+    if (r_send == 2 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            external_ipv4_addr = response.pnu.publicaddress.addr;\n+            return true;\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"natpmp: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"natpmp: sendpublicaddressrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool NatpmpMapping(natpmp_t* natpmp, const struct in_addr& external_ipv4_addr, uint16_t private_port, bool& external_ip_discovered)\n+{\n+    const uint16_t suggested_external_port = g_mapport_external_port ? g_mapport_external_port : private_port;\n+    const int r_send = sendnewportmappingrequest(natpmp, NATPMP_PROTOCOL_TCP, private_port, suggested_external_port, 3600 /*seconds*/);\n+    if (r_send == 12 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            auto pm = response.pnu.newportmapping;\n+            if (private_port == pm.privateport && pm.lifetime > 0) {\n+                g_mapport_external_port = pm.mappedpublicport;\n+                const CService external{external_ipv4_addr, pm.mappedpublicport};\n+                if (!external_ip_discovered && fDiscover) {\n+                    AddLocal(external, LOCAL_MAPPED);\n+                    external_ip_discovered = true;\n+                }\n+\n+                LogPrintf(\"natpmp: Port mapping successful. External address = %s\\n\", external.ToString());\n+                return true;\n+            } else {\n+                LogPrintf(\"natpmp: Port mapping failed.\\n\");\n+            }\n+\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"natpmp: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"natpmp: sendnewportmappingrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool ProcessNatpmp()\n+{\n+    bool ret = false;\n+    natpmp_t natpmp;\n+    struct in_addr external_ipv4_addr;\n+    if (NatpmpInit(&natpmp) && NatpmpDiscover(&natpmp, external_ipv4_addr)) {\n+        bool external_ip_discovered = false;\n+        const uint16_t private_port = GetListenPort();\n+        do {\n+            ret = NatpmpMapping(&natpmp, external_ipv4_addr, private_port, external_ip_discovered);\n+        } while (ret && g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+        g_mapport_interrupt.reset();\n+\n+        const int r_send = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, private_port, g_mapport_external_port, /* remove a port mapping */ 0);\n+        g_mapport_external_port = 0;\n+        if (r_send == 12 /* OK */) {\n+            LogPrintf(\"natpmp: Port mapping removed successfully.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: sendnewportmappingrequest(0) failed with %d error.\\n\", r_send);\n+        }\n+    }\n+\n+    closenatpmp(&natpmp);\n+    return ret;\n+}\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+static bool ProcessUpnp()\n+{\n+    bool ret = false;\n+    std::string port = strprintf(\"%u\", GetListenPort());\n+    const char * multicastif = nullptr;\n+    const char * minissdpdpath = nullptr;\n+    struct UPNPDev * devlist = nullptr;\n+    char lanaddr[64];\n+\n+    int error = 0;\n+#if MINIUPNPC_API_VERSION < 14\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, &error);\n+#else\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, 2, &error);\n+#endif\n+\n+    struct UPNPUrls urls;\n+    struct IGDdatas data;\n+    int r;\n+\n+    r = UPNP_GetValidIGD(devlist, &urls, &data, lanaddr, sizeof(lanaddr));\n+    if (r == 1)\n+    {\n+        if (fDiscover) {\n+            char externalIPAddress[40];\n+            r = UPNP_GetExternalIPAddress(urls.controlURL, data.first.servicetype, externalIPAddress);\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"UPnP: GetExternalIPAddress() returned %d\\n\", r);\n+            } else {\n+                if (externalIPAddress[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(externalIPAddress, resolved, false)) {\n+                        LogPrintf(\"UPnP: ExternalIPAddress = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"UPnP: GetExternalIPAddress failed.\\n\");\n+                }\n+            }\n+        }\n+\n+        std::string strDesc = PACKAGE_NAME \" \" + FormatFullVersion();\n+\n+        do {\n+            r = UPNP_AddPortMapping(urls.controlURL, data.first.servicetype, port.c_str(), port.c_str(), lanaddr, strDesc.c_str(), \"TCP\", 0, \"0\");\n+\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                ret = false;\n+                LogPrintf(\"AddPortMapping(%s, %s, %s) failed with code %d (%s)\\n\", port, port, lanaddr, r, strupnperror(r));\n+                break;\n+            } else {\n+                ret = true;\n+                LogPrintf(\"UPnP Port Mapping successful.\\n\");\n+            }\n+        } while (g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+        g_mapport_interrupt.reset();\n+\n+        r = UPNP_DeletePortMapping(urls.controlURL, data.first.servicetype, port.c_str(), \"TCP\", 0);\n+        LogPrintf(\"UPNP_DeletePortMapping() returned: %d\\n\", r);\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        FreeUPNPUrls(&urls);\n+    } else {\n+        LogPrintf(\"No valid UPnP IGDs found\\n\");\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        if (r != 0)\n+            FreeUPNPUrls(&urls);\n+    }\n+\n+    return ret;\n+}\n+#endif // #ifdef USE_UPNP\n+\n+static void ThreadMapPort()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r545270674",
      "id" : 545270674,
      "line" : 222,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTI3MDY3NA==",
      "original_commit_id" : "93ff21a929ba3036d6cd5d822f300cf036ff939f",
      "original_line" : 222,
      "original_position" : 228,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : 222,
      "pull_request_review_id" : 554828804,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545270674",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-12-17T19:31:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-747652241",
      "id" : 747652241,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0NzY1MjI0MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-17T19:31:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/747652241",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r545689768"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545689768"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "@luke-jr, what do you mean by \"maps random ports often\"? Some implementation of natpmp has bugs? Can you give an example?\r\n\r\nMaybe just remove this comment \"// Low priority protocol.\" -- it is unclear what is meant by it and is missing in other places where `#ifdef USE_NATPMP` is used.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-12-18T09:11:16Z",
      "diff_hunk" : "@@ -0,0 +1,342 @@\n+// Copyright (c) 2011-2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <netinet/in.h>\n+#endif // #ifdef WIN32\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif // #ifdef USE_UPNP\n+\n+#include <atomic>\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_mapport_interrupt;\n+static std::thread g_mapport_thread;\n+static std::atomic_uint g_mapport_enabled_protos{MapPortProtoFlag::NONE};\n+static std::atomic<MapPortProtoFlag> g_mapport_current_proto{MapPortProtoFlag::NONE};\n+static constexpr auto PORT_MAPPING_REANNOUNCE_PERIOD = std::chrono::minutes(20);\n+static constexpr auto PORT_MAPPING_RETRY_PERIOD = std::chrono::minutes(5);\n+\n+#ifdef USE_NATPMP\n+static uint16_t g_mapport_external_port = 0;\n+static bool NatpmpInit(natpmp_t* natpmp)\n+{\n+    const int r_init = initnatpmp(natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r_init == 0) return true;\n+    LogPrintf(\"natpmp: initnatpmp() failed with %d error.\\n\", r_init);\n+    return false;\n+}\n+\n+static bool NatpmpDiscover(natpmp_t* natpmp, struct in_addr& external_ipv4_addr)\n+{\n+    const int r_send = sendpublicaddressrequest(natpmp);\n+    if (r_send == 2 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            external_ipv4_addr = response.pnu.publicaddress.addr;\n+            return true;\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"natpmp: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"natpmp: sendpublicaddressrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool NatpmpMapping(natpmp_t* natpmp, const struct in_addr& external_ipv4_addr, uint16_t private_port, bool& external_ip_discovered)\n+{\n+    const uint16_t suggested_external_port = g_mapport_external_port ? g_mapport_external_port : private_port;\n+    const int r_send = sendnewportmappingrequest(natpmp, NATPMP_PROTOCOL_TCP, private_port, suggested_external_port, 3600 /*seconds*/);\n+    if (r_send == 12 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            auto pm = response.pnu.newportmapping;\n+            if (private_port == pm.privateport && pm.lifetime > 0) {\n+                g_mapport_external_port = pm.mappedpublicport;\n+                const CService external{external_ipv4_addr, pm.mappedpublicport};\n+                if (!external_ip_discovered && fDiscover) {\n+                    AddLocal(external, LOCAL_MAPPED);\n+                    external_ip_discovered = true;\n+                }\n+\n+                LogPrintf(\"natpmp: Port mapping successful. External address = %s\\n\", external.ToString());\n+                return true;\n+            } else {\n+                LogPrintf(\"natpmp: Port mapping failed.\\n\");\n+            }\n+\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"natpmp: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"natpmp: sendnewportmappingrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool ProcessNatpmp()\n+{\n+    bool ret = false;\n+    natpmp_t natpmp;\n+    struct in_addr external_ipv4_addr;\n+    if (NatpmpInit(&natpmp) && NatpmpDiscover(&natpmp, external_ipv4_addr)) {\n+        bool external_ip_discovered = false;\n+        const uint16_t private_port = GetListenPort();\n+        do {\n+            ret = NatpmpMapping(&natpmp, external_ipv4_addr, private_port, external_ip_discovered);\n+        } while (ret && g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+        g_mapport_interrupt.reset();\n+\n+        const int r_send = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, private_port, g_mapport_external_port, /* remove a port mapping */ 0);\n+        g_mapport_external_port = 0;\n+        if (r_send == 12 /* OK */) {\n+            LogPrintf(\"natpmp: Port mapping removed successfully.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: sendnewportmappingrequest(0) failed with %d error.\\n\", r_send);\n+        }\n+    }\n+\n+    closenatpmp(&natpmp);\n+    return ret;\n+}\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+static bool ProcessUpnp()\n+{\n+    bool ret = false;\n+    std::string port = strprintf(\"%u\", GetListenPort());\n+    const char * multicastif = nullptr;\n+    const char * minissdpdpath = nullptr;\n+    struct UPNPDev * devlist = nullptr;\n+    char lanaddr[64];\n+\n+    int error = 0;\n+#if MINIUPNPC_API_VERSION < 14\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, &error);\n+#else\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, 2, &error);\n+#endif\n+\n+    struct UPNPUrls urls;\n+    struct IGDdatas data;\n+    int r;\n+\n+    r = UPNP_GetValidIGD(devlist, &urls, &data, lanaddr, sizeof(lanaddr));\n+    if (r == 1)\n+    {\n+        if (fDiscover) {\n+            char externalIPAddress[40];\n+            r = UPNP_GetExternalIPAddress(urls.controlURL, data.first.servicetype, externalIPAddress);\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"UPnP: GetExternalIPAddress() returned %d\\n\", r);\n+            } else {\n+                if (externalIPAddress[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(externalIPAddress, resolved, false)) {\n+                        LogPrintf(\"UPnP: ExternalIPAddress = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"UPnP: GetExternalIPAddress failed.\\n\");\n+                }\n+            }\n+        }\n+\n+        std::string strDesc = PACKAGE_NAME \" \" + FormatFullVersion();\n+\n+        do {\n+            r = UPNP_AddPortMapping(urls.controlURL, data.first.servicetype, port.c_str(), port.c_str(), lanaddr, strDesc.c_str(), \"TCP\", 0, \"0\");\n+\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                ret = false;\n+                LogPrintf(\"AddPortMapping(%s, %s, %s) failed with code %d (%s)\\n\", port, port, lanaddr, r, strupnperror(r));\n+                break;\n+            } else {\n+                ret = true;\n+                LogPrintf(\"UPnP Port Mapping successful.\\n\");\n+            }\n+        } while (g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+        g_mapport_interrupt.reset();\n+\n+        r = UPNP_DeletePortMapping(urls.controlURL, data.first.servicetype, port.c_str(), \"TCP\", 0);\n+        LogPrintf(\"UPNP_DeletePortMapping() returned: %d\\n\", r);\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        FreeUPNPUrls(&urls);\n+    } else {\n+        LogPrintf(\"No valid UPnP IGDs found\\n\");\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        if (r != 0)\n+            FreeUPNPUrls(&urls);\n+    }\n+\n+    return ret;\n+}\n+#endif // #ifdef USE_UPNP\n+\n+static void ThreadMapPort()\n+{\n+    bool ok;\n+    do {\n+        ok = false;\n+\n+#ifdef USE_UPNP\n+        // High priority protocol.\n+        if (g_mapport_enabled_protos & MapPortProtoFlag::UPNP) {\n+            g_mapport_current_proto = MapPortProtoFlag::UPNP;\n+            ok = ProcessUpnp();\n+            if (ok) continue;\n+        }\n+#endif // #ifdef USE_UPNP\n+\n+#ifdef USE_NATPMP\n+        // Low priority protocol.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r545689768",
      "id" : 545689768,
      "in_reply_to_id" : 545078633,
      "line" : 238,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTY4OTc2OA==",
      "original_commit_id" : "93ff21a929ba3036d6cd5d822f300cf036ff939f",
      "original_line" : 238,
      "original_position" : 244,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : 238,
      "pull_request_review_id" : 555316641,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/545689768",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r546112557"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546112557"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@vasild \r\n> @luke-jr, what do you mean by \"maps random ports often\"? Some implementation of natpmp has bugs? Can you give an example?\r\n\r\nSome NAT-PMP daemon implementations do randomize an external port. For example, see https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-588121365 and http://bodgitandscarper.co.uk/natpmpd/:\r\n> The external TCP or UDP port assigned to the client is always randomised rather than giving the first client the port it actually requested and then trying to work out what to do for additional clients that want the same external port.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-12-18T22:04:39Z",
      "diff_hunk" : "@@ -0,0 +1,342 @@\n+// Copyright (c) 2011-2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <netinet/in.h>\n+#endif // #ifdef WIN32\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif // #ifdef USE_UPNP\n+\n+#include <atomic>\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_mapport_interrupt;\n+static std::thread g_mapport_thread;\n+static std::atomic_uint g_mapport_enabled_protos{MapPortProtoFlag::NONE};\n+static std::atomic<MapPortProtoFlag> g_mapport_current_proto{MapPortProtoFlag::NONE};\n+static constexpr auto PORT_MAPPING_REANNOUNCE_PERIOD = std::chrono::minutes(20);\n+static constexpr auto PORT_MAPPING_RETRY_PERIOD = std::chrono::minutes(5);\n+\n+#ifdef USE_NATPMP\n+static uint16_t g_mapport_external_port = 0;\n+static bool NatpmpInit(natpmp_t* natpmp)\n+{\n+    const int r_init = initnatpmp(natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r_init == 0) return true;\n+    LogPrintf(\"natpmp: initnatpmp() failed with %d error.\\n\", r_init);\n+    return false;\n+}\n+\n+static bool NatpmpDiscover(natpmp_t* natpmp, struct in_addr& external_ipv4_addr)\n+{\n+    const int r_send = sendpublicaddressrequest(natpmp);\n+    if (r_send == 2 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            external_ipv4_addr = response.pnu.publicaddress.addr;\n+            return true;\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"natpmp: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"natpmp: sendpublicaddressrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool NatpmpMapping(natpmp_t* natpmp, const struct in_addr& external_ipv4_addr, uint16_t private_port, bool& external_ip_discovered)\n+{\n+    const uint16_t suggested_external_port = g_mapport_external_port ? g_mapport_external_port : private_port;\n+    const int r_send = sendnewportmappingrequest(natpmp, NATPMP_PROTOCOL_TCP, private_port, suggested_external_port, 3600 /*seconds*/);\n+    if (r_send == 12 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            auto pm = response.pnu.newportmapping;\n+            if (private_port == pm.privateport && pm.lifetime > 0) {\n+                g_mapport_external_port = pm.mappedpublicport;\n+                const CService external{external_ipv4_addr, pm.mappedpublicport};\n+                if (!external_ip_discovered && fDiscover) {\n+                    AddLocal(external, LOCAL_MAPPED);\n+                    external_ip_discovered = true;\n+                }\n+\n+                LogPrintf(\"natpmp: Port mapping successful. External address = %s\\n\", external.ToString());\n+                return true;\n+            } else {\n+                LogPrintf(\"natpmp: Port mapping failed.\\n\");\n+            }\n+\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"natpmp: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"natpmp: sendnewportmappingrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool ProcessNatpmp()\n+{\n+    bool ret = false;\n+    natpmp_t natpmp;\n+    struct in_addr external_ipv4_addr;\n+    if (NatpmpInit(&natpmp) && NatpmpDiscover(&natpmp, external_ipv4_addr)) {\n+        bool external_ip_discovered = false;\n+        const uint16_t private_port = GetListenPort();\n+        do {\n+            ret = NatpmpMapping(&natpmp, external_ipv4_addr, private_port, external_ip_discovered);\n+        } while (ret && g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+        g_mapport_interrupt.reset();\n+\n+        const int r_send = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, private_port, g_mapport_external_port, /* remove a port mapping */ 0);\n+        g_mapport_external_port = 0;\n+        if (r_send == 12 /* OK */) {\n+            LogPrintf(\"natpmp: Port mapping removed successfully.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: sendnewportmappingrequest(0) failed with %d error.\\n\", r_send);\n+        }\n+    }\n+\n+    closenatpmp(&natpmp);\n+    return ret;\n+}\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+static bool ProcessUpnp()\n+{\n+    bool ret = false;\n+    std::string port = strprintf(\"%u\", GetListenPort());\n+    const char * multicastif = nullptr;\n+    const char * minissdpdpath = nullptr;\n+    struct UPNPDev * devlist = nullptr;\n+    char lanaddr[64];\n+\n+    int error = 0;\n+#if MINIUPNPC_API_VERSION < 14\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, &error);\n+#else\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, 2, &error);\n+#endif\n+\n+    struct UPNPUrls urls;\n+    struct IGDdatas data;\n+    int r;\n+\n+    r = UPNP_GetValidIGD(devlist, &urls, &data, lanaddr, sizeof(lanaddr));\n+    if (r == 1)\n+    {\n+        if (fDiscover) {\n+            char externalIPAddress[40];\n+            r = UPNP_GetExternalIPAddress(urls.controlURL, data.first.servicetype, externalIPAddress);\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"UPnP: GetExternalIPAddress() returned %d\\n\", r);\n+            } else {\n+                if (externalIPAddress[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(externalIPAddress, resolved, false)) {\n+                        LogPrintf(\"UPnP: ExternalIPAddress = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"UPnP: GetExternalIPAddress failed.\\n\");\n+                }\n+            }\n+        }\n+\n+        std::string strDesc = PACKAGE_NAME \" \" + FormatFullVersion();\n+\n+        do {\n+            r = UPNP_AddPortMapping(urls.controlURL, data.first.servicetype, port.c_str(), port.c_str(), lanaddr, strDesc.c_str(), \"TCP\", 0, \"0\");\n+\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                ret = false;\n+                LogPrintf(\"AddPortMapping(%s, %s, %s) failed with code %d (%s)\\n\", port, port, lanaddr, r, strupnperror(r));\n+                break;\n+            } else {\n+                ret = true;\n+                LogPrintf(\"UPnP Port Mapping successful.\\n\");\n+            }\n+        } while (g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+        g_mapport_interrupt.reset();\n+\n+        r = UPNP_DeletePortMapping(urls.controlURL, data.first.servicetype, port.c_str(), \"TCP\", 0);\n+        LogPrintf(\"UPNP_DeletePortMapping() returned: %d\\n\", r);\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        FreeUPNPUrls(&urls);\n+    } else {\n+        LogPrintf(\"No valid UPnP IGDs found\\n\");\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        if (r != 0)\n+            FreeUPNPUrls(&urls);\n+    }\n+\n+    return ret;\n+}\n+#endif // #ifdef USE_UPNP\n+\n+static void ThreadMapPort()\n+{\n+    bool ok;\n+    do {\n+        ok = false;\n+\n+#ifdef USE_UPNP\n+        // High priority protocol.\n+        if (g_mapport_enabled_protos & MapPortProtoFlag::UPNP) {\n+            g_mapport_current_proto = MapPortProtoFlag::UPNP;\n+            ok = ProcessUpnp();\n+            if (ok) continue;\n+        }\n+#endif // #ifdef USE_UPNP\n+\n+#ifdef USE_NATPMP\n+        // Low priority protocol.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r546112557",
      "id" : 546112557,
      "in_reply_to_id" : 545078633,
      "line" : 238,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjExMjU1Nw==",
      "original_commit_id" : "93ff21a929ba3036d6cd5d822f300cf036ff939f",
      "original_line" : 238,
      "original_position" : 244,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : 238,
      "pull_request_review_id" : 555841283,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546112557",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Updated 93ff21a929ba3036d6cd5d822f300cf036ff939f -> 890e59c64d62fd39778ede620a70fe6bc60d9993 ([pr18077.47](https://github.com/hebasto/bitcoin/commits/pr18077.47) -> [pr18077.48](https://github.com/hebasto/bitcoin/commits/pr18077.48)):\r\n\r\n- rebased due to the conflict with #20681\r\n- addressed the recent @laanwj's comments\r\n- used C++14 chrono literal",
      "created_at" : "2020-12-18T23:03:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-748361576",
      "id" : 748361576,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0ODM2MTU3Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-18T23:03:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/748361576",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r546135778"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546135778"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks! [Updated](https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-748361576).",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-12-18T23:04:16Z",
      "diff_hunk" : "@@ -0,0 +1,342 @@\n+// Copyright (c) 2011-2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#ifdef WIN32\n+#include <winsock2.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r546135778",
      "id" : 546135778,
      "in_reply_to_id" : 545181363,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjEzNTc3OA==",
      "original_commit_id" : "93ff21a929ba3036d6cd5d822f300cf036ff939f",
      "original_line" : 22,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : null,
      "pull_request_review_id" : 555870107,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546135778",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r546135940"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546135940"
         }
      },
      "author_association" : "MEMBER",
      "body" : "[Updated](https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-748361576).",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-12-18T23:04:28Z",
      "diff_hunk" : "@@ -0,0 +1,342 @@\n+// Copyright (c) 2011-2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <netinet/in.h>\n+#endif // #ifdef WIN32\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif // #ifdef USE_UPNP\n+\n+#include <atomic>\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_mapport_interrupt;\n+static std::thread g_mapport_thread;\n+static std::atomic_uint g_mapport_enabled_protos{MapPortProtoFlag::NONE};\n+static std::atomic<MapPortProtoFlag> g_mapport_current_proto{MapPortProtoFlag::NONE};\n+static constexpr auto PORT_MAPPING_REANNOUNCE_PERIOD = std::chrono::minutes(20);\n+static constexpr auto PORT_MAPPING_RETRY_PERIOD = std::chrono::minutes(5);\n+\n+#ifdef USE_NATPMP\n+static uint16_t g_mapport_external_port = 0;\n+static bool NatpmpInit(natpmp_t* natpmp)\n+{\n+    const int r_init = initnatpmp(natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r_init == 0) return true;\n+    LogPrintf(\"natpmp: initnatpmp() failed with %d error.\\n\", r_init);\n+    return false;\n+}\n+\n+static bool NatpmpDiscover(natpmp_t* natpmp, struct in_addr& external_ipv4_addr)\n+{\n+    const int r_send = sendpublicaddressrequest(natpmp);\n+    if (r_send == 2 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            external_ipv4_addr = response.pnu.publicaddress.addr;\n+            return true;\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"natpmp: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r_read);\n+        }\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r546135940",
      "id" : 546135940,
      "in_reply_to_id" : 545195115,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjEzNTk0MA==",
      "original_commit_id" : "93ff21a929ba3036d6cd5d822f300cf036ff939f",
      "original_line" : 80,
      "original_position" : 80,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : null,
      "pull_request_review_id" : 555870166,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546135940",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r546581515"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546581515"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "@hebasto, Thanks for the clarification! IMO the nat-pmp implementation overriding the desired external port is fine as long as we advertise the overriden one instead of the desired one (I guess we do). That should also be expected as it is allowed by the RFC.\r\n\r\nI guess something like that happens with UPnP too if the desired port is already used?",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-12-21T08:52:55Z",
      "diff_hunk" : "@@ -0,0 +1,342 @@\n+// Copyright (c) 2011-2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <netinet/in.h>\n+#endif // #ifdef WIN32\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif // #ifdef USE_UPNP\n+\n+#include <atomic>\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_mapport_interrupt;\n+static std::thread g_mapport_thread;\n+static std::atomic_uint g_mapport_enabled_protos{MapPortProtoFlag::NONE};\n+static std::atomic<MapPortProtoFlag> g_mapport_current_proto{MapPortProtoFlag::NONE};\n+static constexpr auto PORT_MAPPING_REANNOUNCE_PERIOD = std::chrono::minutes(20);\n+static constexpr auto PORT_MAPPING_RETRY_PERIOD = std::chrono::minutes(5);\n+\n+#ifdef USE_NATPMP\n+static uint16_t g_mapport_external_port = 0;\n+static bool NatpmpInit(natpmp_t* natpmp)\n+{\n+    const int r_init = initnatpmp(natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r_init == 0) return true;\n+    LogPrintf(\"natpmp: initnatpmp() failed with %d error.\\n\", r_init);\n+    return false;\n+}\n+\n+static bool NatpmpDiscover(natpmp_t* natpmp, struct in_addr& external_ipv4_addr)\n+{\n+    const int r_send = sendpublicaddressrequest(natpmp);\n+    if (r_send == 2 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            external_ipv4_addr = response.pnu.publicaddress.addr;\n+            return true;\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"natpmp: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"natpmp: sendpublicaddressrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool NatpmpMapping(natpmp_t* natpmp, const struct in_addr& external_ipv4_addr, uint16_t private_port, bool& external_ip_discovered)\n+{\n+    const uint16_t suggested_external_port = g_mapport_external_port ? g_mapport_external_port : private_port;\n+    const int r_send = sendnewportmappingrequest(natpmp, NATPMP_PROTOCOL_TCP, private_port, suggested_external_port, 3600 /*seconds*/);\n+    if (r_send == 12 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            auto pm = response.pnu.newportmapping;\n+            if (private_port == pm.privateport && pm.lifetime > 0) {\n+                g_mapport_external_port = pm.mappedpublicport;\n+                const CService external{external_ipv4_addr, pm.mappedpublicport};\n+                if (!external_ip_discovered && fDiscover) {\n+                    AddLocal(external, LOCAL_MAPPED);\n+                    external_ip_discovered = true;\n+                }\n+\n+                LogPrintf(\"natpmp: Port mapping successful. External address = %s\\n\", external.ToString());\n+                return true;\n+            } else {\n+                LogPrintf(\"natpmp: Port mapping failed.\\n\");\n+            }\n+\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"natpmp: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"natpmp: sendnewportmappingrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool ProcessNatpmp()\n+{\n+    bool ret = false;\n+    natpmp_t natpmp;\n+    struct in_addr external_ipv4_addr;\n+    if (NatpmpInit(&natpmp) && NatpmpDiscover(&natpmp, external_ipv4_addr)) {\n+        bool external_ip_discovered = false;\n+        const uint16_t private_port = GetListenPort();\n+        do {\n+            ret = NatpmpMapping(&natpmp, external_ipv4_addr, private_port, external_ip_discovered);\n+        } while (ret && g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+        g_mapport_interrupt.reset();\n+\n+        const int r_send = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, private_port, g_mapport_external_port, /* remove a port mapping */ 0);\n+        g_mapport_external_port = 0;\n+        if (r_send == 12 /* OK */) {\n+            LogPrintf(\"natpmp: Port mapping removed successfully.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: sendnewportmappingrequest(0) failed with %d error.\\n\", r_send);\n+        }\n+    }\n+\n+    closenatpmp(&natpmp);\n+    return ret;\n+}\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+static bool ProcessUpnp()\n+{\n+    bool ret = false;\n+    std::string port = strprintf(\"%u\", GetListenPort());\n+    const char * multicastif = nullptr;\n+    const char * minissdpdpath = nullptr;\n+    struct UPNPDev * devlist = nullptr;\n+    char lanaddr[64];\n+\n+    int error = 0;\n+#if MINIUPNPC_API_VERSION < 14\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, &error);\n+#else\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, 2, &error);\n+#endif\n+\n+    struct UPNPUrls urls;\n+    struct IGDdatas data;\n+    int r;\n+\n+    r = UPNP_GetValidIGD(devlist, &urls, &data, lanaddr, sizeof(lanaddr));\n+    if (r == 1)\n+    {\n+        if (fDiscover) {\n+            char externalIPAddress[40];\n+            r = UPNP_GetExternalIPAddress(urls.controlURL, data.first.servicetype, externalIPAddress);\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"UPnP: GetExternalIPAddress() returned %d\\n\", r);\n+            } else {\n+                if (externalIPAddress[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(externalIPAddress, resolved, false)) {\n+                        LogPrintf(\"UPnP: ExternalIPAddress = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"UPnP: GetExternalIPAddress failed.\\n\");\n+                }\n+            }\n+        }\n+\n+        std::string strDesc = PACKAGE_NAME \" \" + FormatFullVersion();\n+\n+        do {\n+            r = UPNP_AddPortMapping(urls.controlURL, data.first.servicetype, port.c_str(), port.c_str(), lanaddr, strDesc.c_str(), \"TCP\", 0, \"0\");\n+\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                ret = false;\n+                LogPrintf(\"AddPortMapping(%s, %s, %s) failed with code %d (%s)\\n\", port, port, lanaddr, r, strupnperror(r));\n+                break;\n+            } else {\n+                ret = true;\n+                LogPrintf(\"UPnP Port Mapping successful.\\n\");\n+            }\n+        } while (g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+        g_mapport_interrupt.reset();\n+\n+        r = UPNP_DeletePortMapping(urls.controlURL, data.first.servicetype, port.c_str(), \"TCP\", 0);\n+        LogPrintf(\"UPNP_DeletePortMapping() returned: %d\\n\", r);\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        FreeUPNPUrls(&urls);\n+    } else {\n+        LogPrintf(\"No valid UPnP IGDs found\\n\");\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        if (r != 0)\n+            FreeUPNPUrls(&urls);\n+    }\n+\n+    return ret;\n+}\n+#endif // #ifdef USE_UPNP\n+\n+static void ThreadMapPort()\n+{\n+    bool ok;\n+    do {\n+        ok = false;\n+\n+#ifdef USE_UPNP\n+        // High priority protocol.\n+        if (g_mapport_enabled_protos & MapPortProtoFlag::UPNP) {\n+            g_mapport_current_proto = MapPortProtoFlag::UPNP;\n+            ok = ProcessUpnp();\n+            if (ok) continue;\n+        }\n+#endif // #ifdef USE_UPNP\n+\n+#ifdef USE_NATPMP\n+        // Low priority protocol.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r546581515",
      "id" : 546581515,
      "in_reply_to_id" : 545078633,
      "line" : 238,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjU4MTUxNQ==",
      "original_commit_id" : "93ff21a929ba3036d6cd5d822f300cf036ff939f",
      "original_line" : 238,
      "original_position" : 244,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : 238,
      "pull_request_review_id" : 556219089,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546581515",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r548844201"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/548844201"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> IMO the nat-pmp implementation overriding the desired external port is fine as long as we advertise the overriden one instead of the desired one (I guess we do).\r\n\r\nYes, we do:\r\nhttps://github.com/bitcoin/bitcoin/blob/890e59c64d62fd39778ede620a70fe6bc60d9993/src/mapport.cpp#L97-L102\r\n\r\n> I guess something like that happens with UPnP too if the desired port is already used?\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/890e59c64d62fd39778ede620a70fe6bc60d9993/src/mapport.cpp#L173-L186",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2020-12-25T09:37:09Z",
      "diff_hunk" : "@@ -0,0 +1,342 @@\n+// Copyright (c) 2011-2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <netinet/in.h>\n+#endif // #ifdef WIN32\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif // #ifdef USE_UPNP\n+\n+#include <atomic>\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_mapport_interrupt;\n+static std::thread g_mapport_thread;\n+static std::atomic_uint g_mapport_enabled_protos{MapPortProtoFlag::NONE};\n+static std::atomic<MapPortProtoFlag> g_mapport_current_proto{MapPortProtoFlag::NONE};\n+static constexpr auto PORT_MAPPING_REANNOUNCE_PERIOD = std::chrono::minutes(20);\n+static constexpr auto PORT_MAPPING_RETRY_PERIOD = std::chrono::minutes(5);\n+\n+#ifdef USE_NATPMP\n+static uint16_t g_mapport_external_port = 0;\n+static bool NatpmpInit(natpmp_t* natpmp)\n+{\n+    const int r_init = initnatpmp(natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r_init == 0) return true;\n+    LogPrintf(\"natpmp: initnatpmp() failed with %d error.\\n\", r_init);\n+    return false;\n+}\n+\n+static bool NatpmpDiscover(natpmp_t* natpmp, struct in_addr& external_ipv4_addr)\n+{\n+    const int r_send = sendpublicaddressrequest(natpmp);\n+    if (r_send == 2 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            external_ipv4_addr = response.pnu.publicaddress.addr;\n+            return true;\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"natpmp: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"natpmp: sendpublicaddressrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool NatpmpMapping(natpmp_t* natpmp, const struct in_addr& external_ipv4_addr, uint16_t private_port, bool& external_ip_discovered)\n+{\n+    const uint16_t suggested_external_port = g_mapport_external_port ? g_mapport_external_port : private_port;\n+    const int r_send = sendnewportmappingrequest(natpmp, NATPMP_PROTOCOL_TCP, private_port, suggested_external_port, 3600 /*seconds*/);\n+    if (r_send == 12 /* OK */) {\n+        int r_read;\n+        natpmpresp_t response;\n+        do {\n+            r_read = readnatpmpresponseorretry(natpmp, &response);\n+        } while (r_read == NATPMP_TRYAGAIN);\n+\n+        if (r_read == 0) {\n+            auto pm = response.pnu.newportmapping;\n+            if (private_port == pm.privateport && pm.lifetime > 0) {\n+                g_mapport_external_port = pm.mappedpublicport;\n+                const CService external{external_ipv4_addr, pm.mappedpublicport};\n+                if (!external_ip_discovered && fDiscover) {\n+                    AddLocal(external, LOCAL_MAPPED);\n+                    external_ip_discovered = true;\n+                }\n+\n+                LogPrintf(\"natpmp: Port mapping successful. External address = %s\\n\", external.ToString());\n+                return true;\n+            } else {\n+                LogPrintf(\"natpmp: Port mapping failed.\\n\");\n+            }\n+\n+        } else if (r_read == NATPMP_ERR_NOGATEWAYSUPPORT) {\n+            LogPrintf(\"natpmp: The gateway does not support NAT-PMP.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r_read);\n+        }\n+\n+    } else {\n+        LogPrintf(\"natpmp: sendnewportmappingrequest() failed with %d error.\\n\", r_send);\n+    }\n+\n+    return false;\n+}\n+\n+static bool ProcessNatpmp()\n+{\n+    bool ret = false;\n+    natpmp_t natpmp;\n+    struct in_addr external_ipv4_addr;\n+    if (NatpmpInit(&natpmp) && NatpmpDiscover(&natpmp, external_ipv4_addr)) {\n+        bool external_ip_discovered = false;\n+        const uint16_t private_port = GetListenPort();\n+        do {\n+            ret = NatpmpMapping(&natpmp, external_ipv4_addr, private_port, external_ip_discovered);\n+        } while (ret && g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+        g_mapport_interrupt.reset();\n+\n+        const int r_send = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, private_port, g_mapport_external_port, /* remove a port mapping */ 0);\n+        g_mapport_external_port = 0;\n+        if (r_send == 12 /* OK */) {\n+            LogPrintf(\"natpmp: Port mapping removed successfully.\\n\");\n+        } else {\n+            LogPrintf(\"natpmp: sendnewportmappingrequest(0) failed with %d error.\\n\", r_send);\n+        }\n+    }\n+\n+    closenatpmp(&natpmp);\n+    return ret;\n+}\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+static bool ProcessUpnp()\n+{\n+    bool ret = false;\n+    std::string port = strprintf(\"%u\", GetListenPort());\n+    const char * multicastif = nullptr;\n+    const char * minissdpdpath = nullptr;\n+    struct UPNPDev * devlist = nullptr;\n+    char lanaddr[64];\n+\n+    int error = 0;\n+#if MINIUPNPC_API_VERSION < 14\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, &error);\n+#else\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, 2, &error);\n+#endif\n+\n+    struct UPNPUrls urls;\n+    struct IGDdatas data;\n+    int r;\n+\n+    r = UPNP_GetValidIGD(devlist, &urls, &data, lanaddr, sizeof(lanaddr));\n+    if (r == 1)\n+    {\n+        if (fDiscover) {\n+            char externalIPAddress[40];\n+            r = UPNP_GetExternalIPAddress(urls.controlURL, data.first.servicetype, externalIPAddress);\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"UPnP: GetExternalIPAddress() returned %d\\n\", r);\n+            } else {\n+                if (externalIPAddress[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(externalIPAddress, resolved, false)) {\n+                        LogPrintf(\"UPnP: ExternalIPAddress = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"UPnP: GetExternalIPAddress failed.\\n\");\n+                }\n+            }\n+        }\n+\n+        std::string strDesc = PACKAGE_NAME \" \" + FormatFullVersion();\n+\n+        do {\n+            r = UPNP_AddPortMapping(urls.controlURL, data.first.servicetype, port.c_str(), port.c_str(), lanaddr, strDesc.c_str(), \"TCP\", 0, \"0\");\n+\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                ret = false;\n+                LogPrintf(\"AddPortMapping(%s, %s, %s) failed with code %d (%s)\\n\", port, port, lanaddr, r, strupnperror(r));\n+                break;\n+            } else {\n+                ret = true;\n+                LogPrintf(\"UPnP Port Mapping successful.\\n\");\n+            }\n+        } while (g_mapport_interrupt.sleep_for(PORT_MAPPING_REANNOUNCE_PERIOD));\n+        g_mapport_interrupt.reset();\n+\n+        r = UPNP_DeletePortMapping(urls.controlURL, data.first.servicetype, port.c_str(), \"TCP\", 0);\n+        LogPrintf(\"UPNP_DeletePortMapping() returned: %d\\n\", r);\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        FreeUPNPUrls(&urls);\n+    } else {\n+        LogPrintf(\"No valid UPnP IGDs found\\n\");\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        if (r != 0)\n+            FreeUPNPUrls(&urls);\n+    }\n+\n+    return ret;\n+}\n+#endif // #ifdef USE_UPNP\n+\n+static void ThreadMapPort()\n+{\n+    bool ok;\n+    do {\n+        ok = false;\n+\n+#ifdef USE_UPNP\n+        // High priority protocol.\n+        if (g_mapport_enabled_protos & MapPortProtoFlag::UPNP) {\n+            g_mapport_current_proto = MapPortProtoFlag::UPNP;\n+            ok = ProcessUpnp();\n+            if (ok) continue;\n+        }\n+#endif // #ifdef USE_UPNP\n+\n+#ifdef USE_NATPMP\n+        // Low priority protocol.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r548844201",
      "id" : 548844201,
      "in_reply_to_id" : 545078633,
      "line" : 238,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODg0NDIwMQ==",
      "original_commit_id" : "93ff21a929ba3036d6cd5d822f300cf036ff939f",
      "original_line" : 238,
      "original_position" : 244,
      "original_start_line" : null,
      "path" : "src/mapport.cpp",
      "position" : 238,
      "pull_request_review_id" : 558794397,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T16:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/548844201",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-01-07T15:07:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-756173150",
      "id" : 756173150,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1NjE3MzE1MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-07T15:07:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/756173150",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased 890e59c64d62fd39778ede620a70fe6bc60d9993 -> a191e23b8e7f0e19fc0359825eb7ca0d47966fa9 ([pr18077.48](https://github.com/hebasto/bitcoin/commits/pr18077.48) -> [pr18077.49](https://github.com/hebasto/bitcoin/commits/pr18077.49)) due to the conflict with #20864.",
      "created_at" : "2021-01-07T16:25:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-756222455",
      "id" : 756222455,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1NjIyMjQ1NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-07T16:25:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/756222455",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r560381734"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/560381734"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"gui: Apply port mapping changes on dialog exit\" (58e8364dcdc4e57b0caac09f8402e6535301de9b)\r\n\r\n@hebasto It seems like this commit has a bug and will incorrectly overwrite command line and config file `-upnp` and `-natpmp` options. I think this might have happened before, but previously only if these settings were changed, now if the dialog is just opened and closed.\r\n\r\nWould you have an opinion on reverting this change? Aside from the bug, it seems simpler to go back to fully applying settings in OptionsModel, instead of using half-using OptionsModel to apply the setting, and then reading the setting later in a different code path and QSettings instance in dialog code outside of OptionsModel.\r\n\r\n(Encountered this while rebasing #15936)\r\n",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2021-01-19T18:09:43Z",
      "diff_hunk" : "@@ -50,6 +51,10 @@ OptionsDialog::OptionsDialog(QWidget *parent, bool enableWallet) :\n #ifndef USE_UPNP\n     ui->mapPortUpnp->setEnabled(false);\n #endif\n+    connect(this, &QDialog::accepted, [this](){\n+        QSettings settings;\n+        model->node().mapPort(settings.value(\"fUseUPnP\").toBool());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r560381734",
      "id" : 560381734,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDM4MTczNA==",
      "original_commit_id" : "58e8364dcdc4e57b0caac09f8402e6535301de9b",
      "original_line" : 56,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/qt/optionsdialog.cpp",
      "position" : null,
      "pull_request_review_id" : 571516086,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-19T18:09:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/560381734",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r567211003"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567211003"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@ryanofsky\r\n\r\nYou are right.\r\n\r\n> It seems like this commit has a bug and will incorrectly overwrite command line and config file `-upnp` and `-natpmp` options.\r\n\r\nThe concerns about user-friendly and correct behavior were raised in #18184. Now users are able to switch `-upnp` and `-natpmp` on/off on-the-fly via the GUI. Should we drop this feature?\r\n\r\n> I think this might have happened before, but previously only if these settings were changed, now if the dialog is just opened and closed.\r\n\r\nExiting the dialog via the \"Cancel\" push button or pressing the \"Esc\" key should not trigger that code path.\r\n\r\nAnyway, I'll happy to revert (or enhance) that change in a proper way.",
      "commit_id" : "a191e23b8e7f0e19fc0359825eb7ca0d47966fa9",
      "created_at" : "2021-01-30T07:20:00Z",
      "diff_hunk" : "@@ -50,6 +51,10 @@ OptionsDialog::OptionsDialog(QWidget *parent, bool enableWallet) :\n #ifndef USE_UPNP\n     ui->mapPortUpnp->setEnabled(false);\n #endif\n+    connect(this, &QDialog::accepted, [this](){\n+        QSettings settings;\n+        model->node().mapPort(settings.value(\"fUseUPnP\").toBool());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r567211003",
      "id" : 567211003,
      "in_reply_to_id" : 560381734,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzIxMTAwMw==",
      "original_commit_id" : "58e8364dcdc4e57b0caac09f8402e6535301de9b",
      "original_line" : 56,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/qt/optionsdialog.cpp",
      "position" : null,
      "pull_request_review_id" : 579737007,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-30T07:20:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567211003",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   }
]
