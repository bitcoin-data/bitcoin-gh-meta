[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #19556 (Remove mempool global by MarcoFalke)\n* #19498 (Tidy up ProcessOrphanTx by jnewbery)\n* #19488 (Refactor mempool.dat to be extensible, and store missing info by luke-jr)\n* #19478 (Remove CTxMempool::mapLinks data structure member by JeremyRubin)\n* #19306 (refactor: Replace RecursiveMutex with Mutex in CTxMemPool by hebasto)\n* #19184 (Overhaul transaction request logic by sipa)\n* #19134 (test: Replace global wait_until with BitcoinTestFramework.wait_until and mininode.wait_until by dboures)\n* #19031 (Implement ADDRv2 support (part of BIP155) by vasild)\n* #18086 (Accurately account for mempool index memory by sipa)\n* #12677 (RPC: Add ancestor{count,size,fees} to listunspent output by luke-jr)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-01-31T17:55:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-580840274",
      "id" : 580840274,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MDg0MDI3NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-21T08:03:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/580840274",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r373735577"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/373735577"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You're dereferencing `it` here after it has been incremented (see Travis failure). I think you want to use `inv.type` instead.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-02-01T00:02:11Z",
      "diff_hunk" : "@@ -1601,12 +1632,13 @@ void static ProcessGetData(CNode* pfrom, const CChainParams& chainparams, CConnm\n             // Send stream from relay memory\n             bool push = false;\n             auto mi = mapRelay.find(inv.hash);\n+            // WTX and WITNESS_TX imply we serialize with witness\n             int nSendFlags = (inv.type == MSG_TX ? SERIALIZE_TRANSACTION_NO_WITNESS : 0);\n             if (mi != mapRelay.end()) {\n                 connman->PushMessage(pfrom, msgMaker.Make(nSendFlags, NetMsgType::TX, *mi->second));\n                 push = true;\n             } else {\n-                auto txinfo = mempool.info(inv.hash);\n+                auto txinfo = mempool.info(inv.hash, it->type == MSG_WTX);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r373735577",
      "id" : 373735577,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzczNTU3Nw==",
      "original_commit_id" : "310aafa76bc460f05ff061d24eb8ea6954a54fe4",
      "original_line" : 1641,
      "original_position" : 197,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 351841019,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/373735577",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r373775307"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/373775307"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks, fixed.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-02-01T11:37:12Z",
      "diff_hunk" : "@@ -1601,12 +1632,13 @@ void static ProcessGetData(CNode* pfrom, const CChainParams& chainparams, CConnm\n             // Send stream from relay memory\n             bool push = false;\n             auto mi = mapRelay.find(inv.hash);\n+            // WTX and WITNESS_TX imply we serialize with witness\n             int nSendFlags = (inv.type == MSG_TX ? SERIALIZE_TRANSACTION_NO_WITNESS : 0);\n             if (mi != mapRelay.end()) {\n                 connman->PushMessage(pfrom, msgMaker.Make(nSendFlags, NetMsgType::TX, *mi->second));\n                 push = true;\n             } else {\n-                auto txinfo = mempool.info(inv.hash);\n+                auto txinfo = mempool.info(inv.hash, it->type == MSG_WTX);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r373775307",
      "id" : 373775307,
      "in_reply_to_id" : 373735577,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc3NTMwNw==",
      "original_commit_id" : "310aafa76bc460f05ff061d24eb8ea6954a54fe4",
      "original_line" : 1641,
      "original_position" : 197,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 351880462,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/373775307",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r373775416"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/373775416"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I wonder if this should be sent immediately in response to a VERSION message, rather than in response to a VERACK.  It looks like the way I've done it here creates a race condition where a peer could send a txid-based inv to us before it gets this message, which I think would cause relay of that transaction to fail.\r\n\r\nhttps://travis-ci.org/bitcoin/bitcoin/jobs/644609638?utm_medium=notification&utm_source=github_status",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-02-01T11:39:03Z",
      "diff_hunk" : "@@ -2175,6 +2175,10 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n             nCMPCTBLOCKVersion = 1;\n             connman->PushMessage(pfrom, msgMaker.Make(NetMsgType::SENDCMPCT, fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion));\n         }\n+\n+        if (pfrom->nVersion >= WTXID_RELAY_VERSION) {\n+            connman->PushMessage(pfrom, msgMaker.Make(NetMsgType::WTXIDRELAY));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r373775416",
      "id" : 373775416,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc3NTQxNg==",
      "original_commit_id" : "ee29e7debcb14fa335e8482888a5cc0294bb8dc8",
      "original_line" : 2180,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 351880546,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/373775416",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r374576703"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/374576703"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Seeing a build warning here:\r\n```\r\nnet_processing.cpp: In member function âvirtual bool PeerLogicValidation::SendMessages(CNode*)â:\r\nnet_processing.cpp:4135:42: warning: enumeral and non-enumeral type in conditional expression [-Wextra]\r\n             CInv inv(state.m_wtxid_relay ? MSG_WTX : (MSG_TX | GetFetchFlags(pto)), txid);\r\n                      ~~~~~~~~~~~~~~~~~~~~^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n```",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-02-04T10:04:03Z",
      "diff_hunk" : "@@ -4057,7 +4132,7 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n             // Erase this entry from tx_process_time (it may be added back for\n             // processing at a later time, see below)\n             tx_process_time.erase(tx_process_time.begin());\n-            CInv inv(MSG_TX | GetFetchFlags(pto), txid);\n+            CInv inv(state.m_wtxid_relay ? MSG_WTX : (MSG_TX | GetFetchFlags(pto)), txid);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r374576703",
      "id" : 374576703,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU3NjcwMw==",
      "original_commit_id" : "fd2c3f257e416323dc6cc1351af65a4026057716",
      "original_line" : 4139,
      "original_position" : 449,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 352852514,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/374576703",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r374697402"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/374697402"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yeah I saw that too, but I think the code is correct?",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-02-04T14:21:25Z",
      "diff_hunk" : "@@ -4057,7 +4132,7 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n             // Erase this entry from tx_process_time (it may be added back for\n             // processing at a later time, see below)\n             tx_process_time.erase(tx_process_time.begin());\n-            CInv inv(MSG_TX | GetFetchFlags(pto), txid);\n+            CInv inv(state.m_wtxid_relay ? MSG_WTX : (MSG_TX | GetFetchFlags(pto)), txid);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r374697402",
      "id" : 374697402,
      "in_reply_to_id" : 374576703,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY5NzQwMg==",
      "original_commit_id" : "fd2c3f257e416323dc6cc1351af65a4026057716",
      "original_line" : 4139,
      "original_position" : 449,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 353010926,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/374697402",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Wrote up a short BIP draft here: https://github.com/sdaftuar/bips/blob/2020-02-wtxid-relay/bip-wtxid-relay.mediawiki, which this PR implements. \r\n\r\nI'll wait for some concept ACKs here before I send to the mailing list.",
      "created_at" : "2020-02-04T14:23:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-581932930",
      "id" : 581932930,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MTkzMjkzMA==",
      "updated_at" : "2020-02-04T14:23:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/581932930",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r374699185"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/374699185"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Would it be a good idea to fetch `nNow + std::chrono::microseconds{RELAY_TX_CACHE_TIME}.count()` once and use the same value for both relay expirations?",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-02-04T14:24:25Z",
      "diff_hunk" : "@@ -3927,6 +3997,11 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n                             if (ret.second) {\n                                 vRelayExpiration.push_back(std::make_pair(nNow + std::chrono::microseconds{RELAY_TX_CACHE_TIME}.count(), ret.first));\n                             }\n+                            // Add wtxid-based lookup into mapRelay as well, so that peers can request by wtxid\n+                            auto ret2 = mapRelay.insert(std::make_pair(ret.first->second->GetWitnessHash(), ret.first->second));\n+                            if (ret2.second) {\n+                                vRelayExpiration.push_back(std::make_pair(nNow + std::chrono::microseconds{RELAY_TX_CACHE_TIME}.count(), ret2.first));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r374699185",
      "id" : 374699185,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY5OTE4NQ==",
      "original_commit_id" : "fd2c3f257e416323dc6cc1351af65a4026057716",
      "original_line" : 4020,
      "original_position" : 439,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 353013332,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/374699185",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Nice -- will add a link to the BIP draft in the review club notes at https://bitcoincore.reviews/18044. Currently reviewing. Can someone add a `Review club` label? It helps let people know that there is a review club resource they can use.",
      "created_at" : "2020-02-04T14:38:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-581939690",
      "id" : 581939690,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MTkzOTY5MA==",
      "updated_at" : "2020-02-10T08:14:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/581939690",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Cocnept ACK. Ran standard tests. All passing. Overall agreed with the idea of using wtxid for everything. Will try to try out the huristic and report some results.   ",
      "created_at" : "2020-02-04T18:27:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-582049318",
      "id" : 582049318,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MjA0OTMxOA==",
      "updated_at" : "2020-02-04T18:27:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/582049318",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/36541669?v=4",
         "events_url" : "https://api.github.com/users/codeShark149/events{/privacy}",
         "followers_url" : "https://api.github.com/users/codeShark149/followers",
         "following_url" : "https://api.github.com/users/codeShark149/following{/other_user}",
         "gists_url" : "https://api.github.com/users/codeShark149/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/codeShark149",
         "id" : 36541669,
         "login" : "codeShark149",
         "node_id" : "MDQ6VXNlcjM2NTQxNjY5",
         "organizations_url" : "https://api.github.com/users/codeShark149/orgs",
         "received_events_url" : "https://api.github.com/users/codeShark149/received_events",
         "repos_url" : "https://api.github.com/users/codeShark149/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/codeShark149/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/codeShark149/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/codeShark149"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r374846097"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/374846097"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Doesn't this comment needs update in light of the changed condition? We are now accepting txs containg witness in recentRejects.  ",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-02-04T18:29:58Z",
      "diff_hunk" : "@@ -2604,14 +2604,15 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n                 // We will continue to reject this tx since it has rejected\n                 // parents so avoid re-requesting it from other peers.\n                 recentRejects->insert(tx.GetHash());\n+                recentRejects->insert(tx.GetWitnessHash());\n             }\n         } else {\n-            if (!tx.HasWitness() && state.GetResult() != TxValidationResult::TX_WITNESS_MUTATED) {\n+            if (tx.HasWitness() || state.GetResult() != TxValidationResult::TX_WITNESS_MUTATED) {\n                 // Do not use rejection cache for witness transactions or\n                 // witness-stripped transactions, as they can have been malleated.\n                 // See https://github.com/bitcoin/bitcoin/issues/8279 for details.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r374846097",
      "id" : 374846097,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg0NjA5Nw==",
      "original_commit_id" : "fb1b69dba63ff9911a2520cdae8f5aab78f26ec0",
      "original_line" : 2613,
      "original_position" : 26,
      "original_start_line" : 2611,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 353203516,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/374846097",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/36541669?v=4",
         "events_url" : "https://api.github.com/users/rajarshimaitra/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rajarshimaitra/followers",
         "following_url" : "https://api.github.com/users/rajarshimaitra/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rajarshimaitra/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rajarshimaitra",
         "id" : 36541669,
         "login" : "rajarshimaitra",
         "node_id" : "MDQ6VXNlcjM2NTQxNjY5",
         "organizations_url" : "https://api.github.com/users/rajarshimaitra/orgs",
         "received_events_url" : "https://api.github.com/users/rajarshimaitra/received_events",
         "repos_url" : "https://api.github.com/users/rajarshimaitra/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rajarshimaitra/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rajarshimaitra/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rajarshimaitra"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Reference [IRC discussion](http://www.erisian.com.au/bitcoin-core-dev/log-2020-02-05.html#l-336) for further context around the VERSION/VERACK messages.",
      "created_at" : "2020-02-06T19:47:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-583078254",
      "id" : 583078254,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MzA3ODI1NA==",
      "updated_at" : "2020-02-06T19:47:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/583078254",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/755825?v=4",
         "events_url" : "https://api.github.com/users/adamjonas/events{/privacy}",
         "followers_url" : "https://api.github.com/users/adamjonas/followers",
         "following_url" : "https://api.github.com/users/adamjonas/following{/other_user}",
         "gists_url" : "https://api.github.com/users/adamjonas/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/adamjonas",
         "id" : 755825,
         "login" : "adamjonas",
         "node_id" : "MDQ6VXNlcjc1NTgyNQ==",
         "organizations_url" : "https://api.github.com/users/adamjonas/orgs",
         "received_events_url" : "https://api.github.com/users/adamjonas/received_events",
         "repos_url" : "https://api.github.com/users/adamjonas/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/adamjonas/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/adamjonas/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/adamjonas"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r376195717"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/376195717"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think it's treating `MSG_WTX` as `enum GetDataMsg` and `MSG_TX | GetFetchFlags()` as `uint32_t` (match `GetFetchFlags` return type). Changing `GetFetchFlags()` to return `GetDataMsg` (and casting its result correspondingly), and making it `enum GetDataMsg : uint32_t` makes the warning go away. Actually, just saying `enum GetDataMsg : uint32_t` makes the warning go away too by the looks.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-02-07T03:12:30Z",
      "diff_hunk" : "@@ -4057,7 +4132,7 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n             // Erase this entry from tx_process_time (it may be added back for\n             // processing at a later time, see below)\n             tx_process_time.erase(tx_process_time.begin());\n-            CInv inv(MSG_TX | GetFetchFlags(pto), txid);\n+            CInv inv(state.m_wtxid_relay ? MSG_WTX : (MSG_TX | GetFetchFlags(pto)), txid);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r376195717",
      "id" : 376195717,
      "in_reply_to_id" : 374576703,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE5NTcxNw==",
      "original_commit_id" : "fd2c3f257e416323dc6cc1351af65a4026057716",
      "original_line" : 4139,
      "original_position" : 449,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 354909544,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/376195717",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK. First take: doing extra messages in between VERSION and VERACK sounds better to me than extending VERSION or potentially doing txid relay briefly in between VERACK and WTXIDRELAY, the code changes seem really nicely laid out, and the main thing that caught my eye looks like it's probably fixed by the WITNESS_STRIPPED addition.",
      "created_at" : "2020-02-09T19:36:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-583884102",
      "id" : 583884102,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4Mzg4NDEwMg==",
      "updated_at" : "2020-02-09T19:36:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/583884102",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r378570286"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/378570286"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "How is  indexed_transaction_set::const_iterator different than txindex?",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-02-12T23:22:17Z",
      "diff_hunk" : "@@ -690,8 +713,19 @@ class CTxMemPool\n         return (mapTx.count(hash) != 0);\n     }\n \n+    bool wtxid_exists(const uint256& hash) const\n+    {\n+        LOCK(cs);\n+        return (mapTx.get<index_by_wtxid>().count(hash) != 0);\n+    }\n+\n     CTransactionRef get(const uint256& hash) const;\n-    TxMempoolInfo info(const uint256& hash) const;\n+    indexed_transaction_set::const_iterator get_iter_from_wtxid(const uint256& wtxid) const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r378570286",
      "id" : 378570286,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU3MDI4Ng==",
      "original_commit_id" : "cf8c70fac6df96e23c37afe1c27eaa3925996caf",
      "original_line" : 723,
      "original_position" : 65,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : null,
      "pull_request_review_id" : 357860151,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/378570286",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r378572903"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/378572903"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Can we rename the function, then?",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-02-12T23:30:34Z",
      "diff_hunk" : "@@ -954,11 +954,11 @@ class CNode\n     }\n \n \n-    void AddInventoryKnown(const CInv& inv)\n+    void AddInventoryKnown(const uint256& hash)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r378572903",
      "id" : 378572903,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU3MjkwMw==",
      "original_commit_id" : "9377e308a7e236aa807461795cd2ccd08e6a6a8b",
      "original_line" : 957,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 357860151,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/378572903",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r378574214"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/378574214"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "WITNESS_TX and WTX read a little bit too close for comfort. I don't think the extra characters to write a useful name cost us much :p.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-02-12T23:34:54Z",
      "diff_hunk" : "@@ -363,7 +369,8 @@ enum GetDataMsg\n     UNDEFINED = 0,\n     MSG_TX = 1,\n     MSG_BLOCK = 2,\n-    // The following can only occur in getdata. Invs always use TX or BLOCK.\n+    MSG_WTX = 5, // Defined in BIP XXX",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r378574214",
      "id" : 378574214,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU3NDIxNA==",
      "original_commit_id" : "cf8c70fac6df96e23c37afe1c27eaa3925996caf",
      "original_line" : 372,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/protocol.h",
      "position" : null,
      "pull_request_review_id" : 357860151,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/378574214",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r378581343"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/378581343"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Not (this pr's) your bug, but clang complains that you're copying shared_ptrs on every iteration and you should add a &.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-02-12T23:58:43Z",
      "diff_hunk" : "@@ -1184,6 +1204,7 @@ void PeerLogicValidation::BlockConnected(const std::shared_ptr<const CBlock>& pb\n         LOCK(g_cs_recent_confirmed_transactions);\n         for (const auto ptx : pblock->vtx) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r378581343",
      "id" : 378581343,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU4MTM0Mw==",
      "original_commit_id" : "cf8c70fac6df96e23c37afe1c27eaa3925996caf",
      "original_line" : 1205,
      "original_position" : 127,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 357860151,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/378581343",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r378581882"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/378581882"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "You should probably wipe this in ~CNetProcessingCleanup() like we do the other orphan fields, but, also, why the hell is that thing even there...",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-02-13T00:00:31Z",
      "diff_hunk" : "@@ -92,6 +94,7 @@ struct COrphanTx {\n };\n RecursiveMutex g_cs_orphans;\n std::map<uint256, COrphanTx> mapOrphanTransactions GUARDED_BY(g_cs_orphans);\n+std::map<uint256, std::map<uint256, COrphanTx>::iterator> g_orphans_by_wtxid GUARDED_BY(g_cs_orphans);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r378581882",
      "id" : 378581882,
      "line" : 156,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU4MTg4Mg==",
      "original_commit_id" : "cf8c70fac6df96e23c37afe1c27eaa3925996caf",
      "original_line" : 156,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 13,
      "pull_request_review_id" : 357860151,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/378581882",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r378586250"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/378586250"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Would this be any different if it were *just* orphan_state.GetResult() != TxValidationResult::TX_WITNESS_STRIPPED?",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-02-13T00:16:17Z",
      "diff_hunk" : "@@ -1910,12 +1943,18 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n             // Has inputs but not accepted to mempool\n             // Probably non-standard or insufficient fee\n             LogPrint(BCLog::MEMPOOL, \"   removed orphan tx %s\\n\", orphanHash.ToString());\n-            if (!orphanTx.HasWitness() && orphan_state.GetResult() != TxValidationResult::TX_WITNESS_MUTATED) {\n-                // Do not use rejection cache for witness transactions or\n-                // witness-stripped transactions, as they can have been malleated.\n-                // See https://github.com/bitcoin/bitcoin/issues/8279 for details.\n+            if (orphanTx.HasWitness() || orphan_state.GetResult() != TxValidationResult::TX_WITNESS_STRIPPED) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r378586250",
      "id" : 378586250,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU4NjI1MA==",
      "original_commit_id" : "cf8c70fac6df96e23c37afe1c27eaa3925996caf",
      "original_line" : 1946,
      "original_position" : 226,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 357860151,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/378586250",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r378586654"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/378586654"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "s/tripped/stripped/, but, more importantly, can we? Wouldn't that allow an attacker to see an 0.19 client's inv, request the tx without delay (unlike its other peers), then spam the network with the witness-stripped version, preventing relay of that transaction. At least as long as we dont ban for TX_WITNESS_STRIPPED.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-02-13T00:17:42Z",
      "diff_hunk" : "@@ -1910,12 +1943,18 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n             // Has inputs but not accepted to mempool\n             // Probably non-standard or insufficient fee\n             LogPrint(BCLog::MEMPOOL, \"   removed orphan tx %s\\n\", orphanHash.ToString());\n-            if (!orphanTx.HasWitness() && orphan_state.GetResult() != TxValidationResult::TX_WITNESS_MUTATED) {\n-                // Do not use rejection cache for witness transactions or\n-                // witness-stripped transactions, as they can have been malleated.\n-                // See https://github.com/bitcoin/bitcoin/issues/8279 for details.\n+            if (orphanTx.HasWitness() || orphan_state.GetResult() != TxValidationResult::TX_WITNESS_STRIPPED) {\n+                // Do not add txids of witness transactions or witness-stripped\n+                // transactions to the filter, as they can have been malleated;\n+                // adding such txids to the reject filter would potentially\n+                // interfere with relay of valid transactions from peers that\n+                // do not support wtxid-based relay. See\n+                // https://github.com/bitcoin/bitcoin/issues/8279 for details.\n+                // We can remove this restriction (and always add wtxids to\n+                // the filter even for witness tripped transactions) once",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r378586654",
      "id" : 378586654,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU4NjY1NA==",
      "original_commit_id" : "cf8c70fac6df96e23c37afe1c27eaa3925996caf",
      "original_line" : 1954,
      "original_position" : 234,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 357860151,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/378586654",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "FWIW, travis error is \" node0 2020-02-12T14:39:48.835709Z [msghand] Error: Disk space is too low! \"",
      "created_at" : "2020-02-13T00:28:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-585487309",
      "id" : 585487309,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NTQ4NzMwOQ==",
      "updated_at" : "2020-02-13T00:28:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/585487309",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r378851243"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/378851243"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Suggestions?",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-02-13T13:14:34Z",
      "diff_hunk" : "@@ -363,7 +369,8 @@ enum GetDataMsg\n     UNDEFINED = 0,\n     MSG_TX = 1,\n     MSG_BLOCK = 2,\n-    // The following can only occur in getdata. Invs always use TX or BLOCK.\n+    MSG_WTX = 5, // Defined in BIP XXX",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r378851243",
      "id" : 378851243,
      "in_reply_to_id" : 378574214,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODg1MTI0Mw==",
      "original_commit_id" : "cf8c70fac6df96e23c37afe1c27eaa3925996caf",
      "original_line" : 372,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/protocol.h",
      "position" : null,
      "pull_request_review_id" : 358204455,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/378851243",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r378858979"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/378858979"
         }
      },
      "author_association" : "MEMBER",
      "body" : "From a single node's perspective, as long as you have at least 1 honest wtxid-relay peer, such an attack would not work, because the wtxid for the honest version of the transaction would not be added to your filter (only the txid), and so you would eventually request the valid version of the transaction from your honest wtxid-relay peer.\r\n\r\nCurrently we preference outbound peers for transaction download, so once we believe that some sufficient majority of listening nodes support wtxid-relay, such that the chances of having 0 or just a few wtxid-relay-outbound-peers is pretty small, then I think we can just get rid of this.  \r\n\r\nI don't think our threat model has ever really been too concerned with every node getting every transaction, anyway -- we just don't want the network as a whole to not relay a transaction altogether because of something like this.  So exactly how long we should wait before dropping this logic is debatable IMO; anyway we should defer the debate to the future when someone thinks this is ready. ",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-02-13T13:29:39Z",
      "diff_hunk" : "@@ -1910,12 +1943,18 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n             // Has inputs but not accepted to mempool\n             // Probably non-standard or insufficient fee\n             LogPrint(BCLog::MEMPOOL, \"   removed orphan tx %s\\n\", orphanHash.ToString());\n-            if (!orphanTx.HasWitness() && orphan_state.GetResult() != TxValidationResult::TX_WITNESS_MUTATED) {\n-                // Do not use rejection cache for witness transactions or\n-                // witness-stripped transactions, as they can have been malleated.\n-                // See https://github.com/bitcoin/bitcoin/issues/8279 for details.\n+            if (orphanTx.HasWitness() || orphan_state.GetResult() != TxValidationResult::TX_WITNESS_STRIPPED) {\n+                // Do not add txids of witness transactions or witness-stripped\n+                // transactions to the filter, as they can have been malleated;\n+                // adding such txids to the reject filter would potentially\n+                // interfere with relay of valid transactions from peers that\n+                // do not support wtxid-based relay. See\n+                // https://github.com/bitcoin/bitcoin/issues/8279 for details.\n+                // We can remove this restriction (and always add wtxids to\n+                // the filter even for witness tripped transactions) once",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r378858979",
      "id" : 378858979,
      "in_reply_to_id" : 378586654,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODg1ODk3OQ==",
      "original_commit_id" : "cf8c70fac6df96e23c37afe1c27eaa3925996caf",
      "original_line" : 1954,
      "original_position" : 234,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 358214364,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/378858979",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK on the BIP draft and the implementation of it\r\n\r\nI am not so sure about the 2-second delay, however, because it is not necessarily an improvement, it can also make matters worse afaict. Example: At least one of our `txid` peers is better connected than all of our `wtxid` peers. We get a `txid` inv first and wait for 2 seconds. Meanwhile, we receive the `wtxid` inv and request it, but before we get the response we also request the transaction from the  `txid` peer. I am not sure how realistic this is and it will certainly not happen frequently once large parts of the network have upgraded to `wtxid` invs. But I also think the PR is compelling enough without the 2-second delay optimization and it could be left as a follow-up so it can be discussed separately.\r\n\r\nDo you plan to add additional tests? Otherwise, I might be interested to look into that.",
      "created_at" : "2020-02-14T16:58:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-586375495",
      "id" : 586375495,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NjM3NTQ5NQ==",
      "updated_at" : "2020-02-14T16:58:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/586375495",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r380426287"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/380426287"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "(this is already fixed on master, so a rebase would solve it)",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-02-18T02:22:45Z",
      "diff_hunk" : "@@ -1184,6 +1204,7 @@ void PeerLogicValidation::BlockConnected(const std::shared_ptr<const CBlock>& pb\n         LOCK(g_cs_recent_confirmed_transactions);\n         for (const auto ptx : pblock->vtx) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r380426287",
      "id" : 380426287,
      "in_reply_to_id" : 378581343,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDQyNjI4Nw==",
      "original_commit_id" : "cf8c70fac6df96e23c37afe1c27eaa3925996caf",
      "original_line" : 1205,
      "original_position" : 127,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 360037046,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/380426287",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "concept ACK",
      "created_at" : "2020-02-18T20:03:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-587757896",
      "id" : 587757896,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4Nzc1Nzg5Ng==",
      "updated_at" : "2020-02-18T20:03:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/587757896",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2020-02-25T19:46:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-591034818",
      "id" : 591034818,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5MTAzNDgxOA==",
      "updated_at" : "2020-02-25T19:46:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/591034818",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r384694065"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/384694065"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Updated with the `enum GetDataMsg : uint32_t` fix, thanks.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-02-26T18:52:58Z",
      "diff_hunk" : "@@ -4057,7 +4132,7 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n             // Erase this entry from tx_process_time (it may be added back for\n             // processing at a later time, see below)\n             tx_process_time.erase(tx_process_time.begin());\n-            CInv inv(MSG_TX | GetFetchFlags(pto), txid);\n+            CInv inv(state.m_wtxid_relay ? MSG_WTX : (MSG_TX | GetFetchFlags(pto)), txid);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r384694065",
      "id" : 384694065,
      "in_reply_to_id" : 374576703,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDY5NDA2NQ==",
      "original_commit_id" : "fd2c3f257e416323dc6cc1351af65a4026057716",
      "original_line" : 4139,
      "original_position" : 449,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 365154543,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/384694065",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r384694231"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/384694231"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-02-26T18:53:16Z",
      "diff_hunk" : "@@ -690,8 +713,19 @@ class CTxMemPool\n         return (mapTx.count(hash) != 0);\n     }\n \n+    bool wtxid_exists(const uint256& hash) const\n+    {\n+        LOCK(cs);\n+        return (mapTx.get<index_by_wtxid>().count(hash) != 0);\n+    }\n+\n     CTransactionRef get(const uint256& hash) const;\n-    TxMempoolInfo info(const uint256& hash) const;\n+    indexed_transaction_set::const_iterator get_iter_from_wtxid(const uint256& wtxid) const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r384694231",
      "id" : 384694231,
      "in_reply_to_id" : 378570286,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDY5NDIzMQ==",
      "original_commit_id" : "cf8c70fac6df96e23c37afe1c27eaa3925996caf",
      "original_line" : 723,
      "original_position" : 65,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : null,
      "pull_request_review_id" : 365154772,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/384694231",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r384694296"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/384694296"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-02-26T18:53:24Z",
      "diff_hunk" : "@@ -954,11 +954,11 @@ class CNode\n     }\n \n \n-    void AddInventoryKnown(const CInv& inv)\n+    void AddInventoryKnown(const uint256& hash)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r384694296",
      "id" : 384694296,
      "in_reply_to_id" : 378572903,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDY5NDI5Ng==",
      "original_commit_id" : "9377e308a7e236aa807461795cd2ccd08e6a6a8b",
      "original_line" : 957,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 365154867,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/384694296",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r384694706"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/384694706"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed, thanks.\r\n\r\nNot sure exactly what you're asking but it seemed easier to add an additional map, rather than change the existing data structure to support wtxid-lookup.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-02-26T18:54:06Z",
      "diff_hunk" : "@@ -92,6 +94,7 @@ struct COrphanTx {\n };\n RecursiveMutex g_cs_orphans;\n std::map<uint256, COrphanTx> mapOrphanTransactions GUARDED_BY(g_cs_orphans);\n+std::map<uint256, std::map<uint256, COrphanTx>::iterator> g_orphans_by_wtxid GUARDED_BY(g_cs_orphans);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r384694706",
      "id" : 384694706,
      "in_reply_to_id" : 378581882,
      "line" : 156,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDY5NDcwNg==",
      "original_commit_id" : "cf8c70fac6df96e23c37afe1c27eaa3925996caf",
      "original_line" : 156,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 13,
      "pull_request_review_id" : 365155345,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/384694706",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r384694860"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/384694860"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Nope, would not be different.  Fixed.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-02-26T18:54:23Z",
      "diff_hunk" : "@@ -1910,12 +1943,18 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n             // Has inputs but not accepted to mempool\n             // Probably non-standard or insufficient fee\n             LogPrint(BCLog::MEMPOOL, \"   removed orphan tx %s\\n\", orphanHash.ToString());\n-            if (!orphanTx.HasWitness() && orphan_state.GetResult() != TxValidationResult::TX_WITNESS_MUTATED) {\n-                // Do not use rejection cache for witness transactions or\n-                // witness-stripped transactions, as they can have been malleated.\n-                // See https://github.com/bitcoin/bitcoin/issues/8279 for details.\n+            if (orphanTx.HasWitness() || orphan_state.GetResult() != TxValidationResult::TX_WITNESS_STRIPPED) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r384694860",
      "id" : 384694860,
      "in_reply_to_id" : 378586250,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDY5NDg2MA==",
      "original_commit_id" : "cf8c70fac6df96e23c37afe1c27eaa3925996caf",
      "original_line" : 1946,
      "original_position" : 226,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 365155554,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/384694860",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Updated to fix the comments left so far.  I also changed the 2 second delay heuristic to only delay initial request of a transaction from a txid-relay peer, and not subsequent requests -- @naumenkogs pointed out to me that the original behavior I proposed would have opened us up to an \"InvBlock\" attack if we get a bunch of inbound peers that have wtxid-relay turned on, but don't yet have any outbound peers.\r\n\r\n@fjahr Please feel free to write some tests, thank you!  As for your comment about delaying transaction relay, yes I think that is the tradeoff -- reduce bandwidth at the expense of latency. ",
      "created_at" : "2020-02-26T18:57:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-591585772",
      "id" : 591585772,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5MTU4NTc3Mg==",
      "updated_at" : "2020-02-26T18:57:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/591585772",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r384862855"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/384862855"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This comment is slightly confusing to me. If you setting this expectation here, maybe you want to enforce the rule in the code? Track whether VERACK was not received or something.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-02-27T01:17:24Z",
      "diff_hunk" : "@@ -2154,10 +2197,24 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n             nCMPCTBLOCKVersion = 1;\n             connman->PushMessage(pfrom, msgMaker.Make(NetMsgType::SENDCMPCT, fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion));\n         }\n+\n         pfrom->fSuccessfullyConnected = true;\n         return true;\n     }\n \n+    // Feature negotiation of wtxidrelay should happen between VERSION and\n+    // VERACK, to avoid relay problems from switching after a connection is up",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r384862855",
      "id" : 384862855,
      "line" : 2517,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg2Mjg1NQ==",
      "original_commit_id" : "1cdf17837b26b8dfaf1aeec4c4a1a4b73810e4a5",
      "original_line" : 2517,
      "original_position" : 263,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 330,
      "pull_request_review_id" : 365357115,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/384862855",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r385362270"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385362270"
         }
      },
      "author_association" : "MEMBER",
      "body" : "54d58e7\r\n\r\n3 new pointers for `boost::multi_index::tag<index_by_wtxid>, mempoolentry_wtxid, SaltedTxidHasher`, not one for new `boost::multi_index::hashed_unique` ? ",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-02-27T20:47:40Z",
      "diff_hunk" : "@@ -912,8 +912,8 @@ bool CCoinsViewMemPool::GetCoin(const COutPoint &outpoint, Coin &coin) const {\n \n size_t CTxMemPool::DynamicMemoryUsage() const {\n     LOCK(cs);\n-    // Estimate the overhead of mapTx to be 12 pointers + an allocation, as no exact formula for boost::multi_index_contained is implemented.\n-    return memusage::MallocUsage(sizeof(CTxMemPoolEntry) + 12 * sizeof(void*)) * mapTx.size() + memusage::DynamicUsage(mapNextTx) + memusage::DynamicUsage(mapDeltas) + memusage::DynamicUsage(mapLinks) + memusage::DynamicUsage(vTxHashes) + cachedInnerUsage;\n+    // Estimate the overhead of mapTx to be 15 pointers + an allocation, as no exact formula for boost::multi_index_contained is implemented.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r385362270",
      "id" : 385362270,
      "line" : 920,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM2MjI3MA==",
      "original_commit_id" : "1d1fddb9790cb3b9a70df5370a71ac245491b71c",
      "original_line" : 920,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 35,
      "pull_request_review_id" : 365986399,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385362270",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r385428189"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385428189"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What would be the challenges to switch mapOrphanTransactions to wtxid-only? It's just an internal structure, do we use it to interact with our peers ? (and even you can  translate backward there)",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-02-27T23:23:19Z",
      "diff_hunk" : "@@ -92,6 +94,7 @@ struct COrphanTx {\n };\n RecursiveMutex g_cs_orphans;\n std::map<uint256, COrphanTx> mapOrphanTransactions GUARDED_BY(g_cs_orphans);\n+std::map<uint256, std::map<uint256, COrphanTx>::iterator> g_orphans_by_wtxid GUARDED_BY(g_cs_orphans);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r385428189",
      "id" : 385428189,
      "in_reply_to_id" : 378581882,
      "line" : 156,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQyODE4OQ==",
      "original_commit_id" : "cf8c70fac6df96e23c37afe1c27eaa3925996caf",
      "original_line" : 156,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 13,
      "pull_request_review_id" : 365986399,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385428189",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r385437587"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385437587"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Would be okay with MSG_WTXID to mark we only deal with tx identifier not a specific new data structure, we already have a GetDataMsg for the transaction and its witness.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-02-27T23:54:03Z",
      "diff_hunk" : "@@ -363,7 +369,8 @@ enum GetDataMsg\n     UNDEFINED = 0,\n     MSG_TX = 1,\n     MSG_BLOCK = 2,\n-    // The following can only occur in getdata. Invs always use TX or BLOCK.\n+    MSG_WTX = 5, // Defined in BIP XXX",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r385437587",
      "id" : 385437587,
      "in_reply_to_id" : 378574214,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQzNzU4Nw==",
      "original_commit_id" : "cf8c70fac6df96e23c37afe1c27eaa3925996caf",
      "original_line" : 372,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/protocol.h",
      "position" : null,
      "pull_request_review_id" : 365986399,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385437587",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r385439388"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385439388"
         }
      },
      "author_association" : "MEMBER",
      "body" : "d0f03e9\r\n\r\nIs this rule a best-effort right now? At tx reception, we may have to request parent based only on the input. If so is the BIP clear enough on the 5) ? Precise also there is no current sanction of the rule by receiver as of today",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-02-27T23:59:43Z",
      "diff_hunk" : "@@ -230,6 +230,12 @@ extern const char *GETBLOCKTXN;\n  * @since protocol version 70014 as described by BIP 152\n  */\n extern const char *BLOCKTXN;\n+/**\n+ * Indicates that a node prefers to relay transactions via wtxid, rather than\n+ * txid.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r385439388",
      "id" : 385439388,
      "line" : 266,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQzOTM4OA==",
      "original_commit_id" : "021c5d392b6469596ba8eaa18c9ea01dafd9fdf0",
      "original_line" : 266,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/protocol.h",
      "position" : 6,
      "pull_request_review_id" : 365986399,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385439388",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r385441278"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385441278"
         }
      },
      "author_association" : "MEMBER",
      "body" : "cf8c70f\r\n\r\nFor context-tracking, would be fine to even further comment, \"right now if we reject witness transactions based on their txids, relying on wtxid-based relay peers might lead to a stripped-witness tx starvation due to the low number of wtxid-relay peers at protocol deployment\"\r\n\r\nAlso, once we reach a deployment meaningful enough, should we merge together TX_WITNESS_MUTATED and TX_WITNESS_STRIPPED ?",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-02-28T00:06:12Z",
      "diff_hunk" : "@@ -1942,10 +1943,16 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n             // Has inputs but not accepted to mempool\n             // Probably non-standard or insufficient fee\n             LogPrint(BCLog::MEMPOOL, \"   removed orphan tx %s\\n\", orphanHash.ToString());\n-            if (orphanTx.HasWitness() || orphan_state.GetResult() != TxValidationResult::TX_WITNESS_MUTATED) {\n-                // Do not use rejection cache for witness transactions or\n-                // witness-stripped transactions, as they can have been malleated.\n-                // See https://github.com/bitcoin/bitcoin/issues/8279 for details.\n+            if (orphan_state.GetResult() != TxValidationResult::TX_WITNESS_STRIPPED) {\n+                // Do not add txids of witness transactions or witness-stripped\n+                // transactions to the filter, as they can have been malleated;\n+                // adding such txids to the reject filter would potentially\n+                // interfere with relay of valid transactions from peers that\n+                // do not support wtxid-based relay. See\n+                // https://github.com/bitcoin/bitcoin/issues/8279 for details.\n+                // We can remove this restriction (and always add wtxids to\n+                // the filter even for witness stripped transactions) once\n+                // wtxid-based relay is broadly deployed.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r385441278",
      "id" : 385441278,
      "line" : 2054,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ0MTI3OA==",
      "original_commit_id" : "6e7290f8f830fbbe49f8578f5f4f3d52613c7056",
      "original_line" : 2054,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 304,
      "pull_request_review_id" : 365986399,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/385441278",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r387858917"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/387858917"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What to do in that case?  We could disconnect the peer for violating the spec, or ignore the message and not switch to wtxid relay, but I thought trying to do wtxid-relay was the most practical, as it should mostly work (just things that were announced earlier might not be successfully requested).  Maybe it's better to not tolerate any kind of bugs though, so that implementations get all this stuff right?",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-04T18:40:53Z",
      "diff_hunk" : "@@ -2154,10 +2197,24 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n             nCMPCTBLOCKVersion = 1;\n             connman->PushMessage(pfrom, msgMaker.Make(NetMsgType::SENDCMPCT, fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion));\n         }\n+\n         pfrom->fSuccessfullyConnected = true;\n         return true;\n     }\n \n+    // Feature negotiation of wtxidrelay should happen between VERSION and\n+    // VERACK, to avoid relay problems from switching after a connection is up",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r387858917",
      "id" : 387858917,
      "in_reply_to_id" : 384862855,
      "line" : 2517,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg1ODkxNw==",
      "original_commit_id" : "1cdf17837b26b8dfaf1aeec4c4a1a4b73810e4a5",
      "original_line" : 2517,
      "original_position" : 263,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 330,
      "pull_request_review_id" : 369026275,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/387858917",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> What taproot is making worst here than current tx-relay of segwit v0 txn ?\r\n\r\nExplained this offline, but the issue is that in a normal, non-adversarial situation where new nodes are relaying segwit transactions that violate old nodes' policy, those old nodes will be wasting bandwidth repeatedly downloading such transactions, because we have no caching of acceptance failure for segwit transactions.\r\n\r\n> Wrt to IRC discussion on multi-party transactions & tx-relay interference, at least for Lightning I can't see this as an issue, worst-case your counterparty can resign to produce another valid witness and you redownload twice ? Or is the attack finding a wtxid-collision with an invalid tx to make propagation of a valid time-sensitive tx near impossible?\r\n\r\nI think you're referencing an IRC conversation about a proposal to change wtxid-based relay to use some shorter, truncated hash instead (128 bits instead of 256 bits), which one version of the Erlay proposal called for.  I've opted not to pursue that, because the bandwidth savings seem small after Erlay.  If someone is going to advocate for truncated hashes, we can revisit the concerns from that conversation.",
      "created_at" : "2020-03-05T17:18:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-595345973",
      "id" : 595345973,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5NTM0NTk3Mw==",
      "updated_at" : "2020-03-05T17:18:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/595345973",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r388444497"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/388444497"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, you made a good observation -- our fetching of parents of orphan transactions must be by txid, rather than wtxid.  I did try to carefully word the BIP to avoid referencing this situation:\r\n\r\n> After a node has sent and received a \"wtxidrelay\" message to/from a given peer, the node is required to use the MSG_WTX inv-type when announcing transactions to that peer, or requesting announced transactions from that peer.\r\n\r\nSo the BIP says that newly announced transactions must be by wtxid.  And if your peer announces a transaction by wtxid, you must fetch it by wtxid (and not txid).  The BIP is silent on requests for transactions that are not announced -- we could make this explicit but this has never been documented behavior, and I'm not sure we should commit to a certain handling of this kind of thing anyway...  But open to suggestions.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-05T17:23:07Z",
      "diff_hunk" : "@@ -230,6 +230,12 @@ extern const char *GETBLOCKTXN;\n  * @since protocol version 70014 as described by BIP 152\n  */\n extern const char *BLOCKTXN;\n+/**\n+ * Indicates that a node prefers to relay transactions via wtxid, rather than\n+ * txid.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r388444497",
      "id" : 388444497,
      "in_reply_to_id" : 385439388,
      "line" : 266,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ0NDQ5Nw==",
      "original_commit_id" : "021c5d392b6469596ba8eaa18c9ea01dafd9fdf0",
      "original_line" : 266,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/protocol.h",
      "position" : 6,
      "pull_request_review_id" : 369765705,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/388444497",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r388445400"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/388445400"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In the future, I think I'd like to eventually get rid of WITNESS_STRIPPED as a reason that validation returns, because we incur non-trivial CPU usage in order to make the determination of whether a transaction might be WITNESS_STRIPPED.\r\n\r\n",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-05T17:24:42Z",
      "diff_hunk" : "@@ -1942,10 +1943,16 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n             // Has inputs but not accepted to mempool\n             // Probably non-standard or insufficient fee\n             LogPrint(BCLog::MEMPOOL, \"   removed orphan tx %s\\n\", orphanHash.ToString());\n-            if (orphanTx.HasWitness() || orphan_state.GetResult() != TxValidationResult::TX_WITNESS_MUTATED) {\n-                // Do not use rejection cache for witness transactions or\n-                // witness-stripped transactions, as they can have been malleated.\n-                // See https://github.com/bitcoin/bitcoin/issues/8279 for details.\n+            if (orphan_state.GetResult() != TxValidationResult::TX_WITNESS_STRIPPED) {\n+                // Do not add txids of witness transactions or witness-stripped\n+                // transactions to the filter, as they can have been malleated;\n+                // adding such txids to the reject filter would potentially\n+                // interfere with relay of valid transactions from peers that\n+                // do not support wtxid-based relay. See\n+                // https://github.com/bitcoin/bitcoin/issues/8279 for details.\n+                // We can remove this restriction (and always add wtxids to\n+                // the filter even for witness stripped transactions) once\n+                // wtxid-based relay is broadly deployed.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r388445400",
      "id" : 388445400,
      "in_reply_to_id" : 385441278,
      "line" : 2054,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ0NTQwMA==",
      "original_commit_id" : "6e7290f8f830fbbe49f8578f5f4f3d52613c7056",
      "original_line" : 2054,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 304,
      "pull_request_review_id" : 369766876,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/388445400",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r388481642"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/388481642"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Disconnecting is too much, but ignoring the wtxid_relay message may be reasonable.\r\n\r\nAlternatively (and probably better), we can just make the comment more clear. Something like \"currently this is not enforced, because at most we get slight inefficiency if not following this rule\".\r\n\r\nAnd then the responsibility would be on the future developer to introduce the disconnect/ignore behavior if they choose to fundamentally rely on this assumption.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-05T18:31:29Z",
      "diff_hunk" : "@@ -2154,10 +2197,24 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n             nCMPCTBLOCKVersion = 1;\n             connman->PushMessage(pfrom, msgMaker.Make(NetMsgType::SENDCMPCT, fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion));\n         }\n+\n         pfrom->fSuccessfullyConnected = true;\n         return true;\n     }\n \n+    // Feature negotiation of wtxidrelay should happen between VERSION and\n+    // VERACK, to avoid relay problems from switching after a connection is up",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r388481642",
      "id" : 388481642,
      "in_reply_to_id" : 384862855,
      "line" : 2517,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ4MTY0Mg==",
      "original_commit_id" : "1cdf17837b26b8dfaf1aeec4c4a1a4b73810e4a5",
      "original_line" : 2517,
      "original_position" : 263,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 330,
      "pull_request_review_id" : 369812647,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/388481642",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r388504010"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/388504010"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I would amend the BIP to make its scope explicitly restrained. Add to 5) \"Note: this rule doesn't cover cases where a peer needs to request transaction for validation purposes but don't know its wtxid yet (e.g missing parents of a wtxid-announced child)\" ? At least to avoid someone raising same concern in the future and saying we don't commit on anything wrt to this issue.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-05T19:12:18Z",
      "diff_hunk" : "@@ -230,6 +230,12 @@ extern const char *GETBLOCKTXN;\n  * @since protocol version 70014 as described by BIP 152\n  */\n extern const char *BLOCKTXN;\n+/**\n+ * Indicates that a node prefers to relay transactions via wtxid, rather than\n+ * txid.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r388504010",
      "id" : 388504010,
      "in_reply_to_id" : 385439388,
      "line" : 266,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODUwNDAxMA==",
      "original_commit_id" : "021c5d392b6469596ba8eaa18c9ea01dafd9fdf0",
      "original_line" : 266,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/protocol.h",
      "position" : 6,
      "pull_request_review_id" : 369840075,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/388504010",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r388504839"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/388504839"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes that what I understood, you're thinking about the 2 `CheckInputScripts` in what is currently `PolicyScriptChecks`?",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-05T19:13:39Z",
      "diff_hunk" : "@@ -1942,10 +1943,16 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n             // Has inputs but not accepted to mempool\n             // Probably non-standard or insufficient fee\n             LogPrint(BCLog::MEMPOOL, \"   removed orphan tx %s\\n\", orphanHash.ToString());\n-            if (orphanTx.HasWitness() || orphan_state.GetResult() != TxValidationResult::TX_WITNESS_MUTATED) {\n-                // Do not use rejection cache for witness transactions or\n-                // witness-stripped transactions, as they can have been malleated.\n-                // See https://github.com/bitcoin/bitcoin/issues/8279 for details.\n+            if (orphan_state.GetResult() != TxValidationResult::TX_WITNESS_STRIPPED) {\n+                // Do not add txids of witness transactions or witness-stripped\n+                // transactions to the filter, as they can have been malleated;\n+                // adding such txids to the reject filter would potentially\n+                // interfere with relay of valid transactions from peers that\n+                // do not support wtxid-based relay. See\n+                // https://github.com/bitcoin/bitcoin/issues/8279 for details.\n+                // We can remove this restriction (and always add wtxids to\n+                // the filter even for witness stripped transactions) once\n+                // wtxid-based relay is broadly deployed.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r388504839",
      "id" : 388504839,
      "in_reply_to_id" : 385441278,
      "line" : 2054,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODUwNDgzOQ==",
      "original_commit_id" : "6e7290f8f830fbbe49f8578f5f4f3d52613c7056",
      "original_line" : 2054,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 304,
      "pull_request_review_id" : 369840988,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/388504839",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Explained this offline, but the issue is that in a normal, non-adversarial situation where new nodes are relaying segwit transactions that violate old nodes' policy, those old nodes will be wasting bandwidth repeatedly downloading such transactions, because we have no caching of acceptance failure for segwit transactions.\r\n\r\nYes thanks for explanation, what I didn't get was with a segwit upgrade deployment, transaction download waste wasn't encumbered only in case of _adversarial_ but also just for _normal_ situation (without change any segwit v1 would be redownload at every announcement by non-upgrades nodes).\r\n\r\n> I think you're referencing an IRC conversation about a proposal to change wtxid-based relay to use some shorter, truncated hash instead (128 bits instead of 256 bits), which one version of the Erlay proposal called for. I've opted not to pursue that, because the bandwidth savings seem small after Erlay. If someone is going to advocate for truncated hashes, we can revisit the concerns from that conversation.\r\n\r\nAttack scenario is knowing a wtxid, a counterparty may find transaction identifier _collision_ for an _invalid_ transaction to stuck a time-sensitive tx in the reject filter, and keep broadcasting such malicious transaction at every block tip until timelock expires. That's not a concern for LN today (because your counterparty doesn't know your witness for your local commitment tx) but that would change with something like Eltoo (because symmetric transaction). So Eltoo-style offchain contracts + short-bit transaction identifier is a security concern, something we should document somewhere (maybe add comment around `recentRejects`)",
      "created_at" : "2020-03-05T19:23:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-595402094",
      "id" : 595402094,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5NTQwMjA5NA==",
      "updated_at" : "2020-03-05T19:23:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/595402094",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r388927279"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/388927279"
         }
      },
      "author_association" : "MEMBER",
      "body" : "s/the filter/the recentRejects filter/ in 6e7290f to aid git grepping (in which case can drop \"reject\" in the next line).\r\n\r\nIdem for the section in `ProcessMessage()`::L2684 containing the same paragraph.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-06T14:18:39Z",
      "diff_hunk" : "@@ -1910,12 +1943,18 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n             // Has inputs but not accepted to mempool\n             // Probably non-standard or insufficient fee\n             LogPrint(BCLog::MEMPOOL, \"   removed orphan tx %s\\n\", orphanHash.ToString());\n-            if (!orphanTx.HasWitness() && orphan_state.GetResult() != TxValidationResult::TX_WITNESS_MUTATED) {\n-                // Do not use rejection cache for witness transactions or\n-                // witness-stripped transactions, as they can have been malleated.\n-                // See https://github.com/bitcoin/bitcoin/issues/8279 for details.\n+            if (orphan_state.GetResult() != TxValidationResult::TX_WITNESS_STRIPPED) {\n+                // Do not add txids of witness transactions or witness-stripped\n+                // transactions to the filter, as they can have been malleated;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r388927279",
      "id" : 388927279,
      "line" : 2047,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkyNzI3OQ==",
      "original_commit_id" : "1cdf17837b26b8dfaf1aeec4c4a1a4b73810e4a5",
      "original_line" : 2047,
      "original_position" : 228,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 297,
      "pull_request_review_id" : 353013332,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/388927279",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r388954495"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/388954495"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Further to @ariard's comment, a code doc explaining how the number 15 is arrived at might be helpful here.",
      "commit_id" : "782a0b04496738030e3e51a6bf44aa5b426870b9",
      "created_at" : "2020-03-06T15:04:34Z",
      "diff_hunk" : "@@ -912,8 +912,8 @@ bool CCoinsViewMemPool::GetCoin(const COutPoint &outpoint, Coin &coin) const {\n \n size_t CTxMemPool::DynamicMemoryUsage() const {\n     LOCK(cs);\n-    // Estimate the overhead of mapTx to be 12 pointers + an allocation, as no exact formula for boost::multi_index_contained is implemented.\n-    return memusage::MallocUsage(sizeof(CTxMemPoolEntry) + 12 * sizeof(void*)) * mapTx.size() + memusage::DynamicUsage(mapNextTx) + memusage::DynamicUsage(mapDeltas) + memusage::DynamicUsage(mapLinks) + memusage::DynamicUsage(vTxHashes) + cachedInnerUsage;\n+    // Estimate the overhead of mapTx to be 15 pointers + an allocation, as no exact formula for boost::multi_index_contained is implemented.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r388954495",
      "id" : 388954495,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk1NDQ5NQ==",
      "original_commit_id" : "1cdf17837b26b8dfaf1aeec4c4a1a4b73810e4a5",
      "original_position" : 35,
      "path" : "src/txmempool.cpp",
      "position" : 35,
      "pull_request_review_id" : 353013332,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "updated_at" : "2020-03-17T20:38:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/388954495",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : ">  So Eltoo-style offchain contracts + short-bit transaction identifier is a security concern, something we should document somewhere (maybe add comment around recentRejects)\r\n\r\n@ariard This PR does not include a \"short-bit transaction identifier\" so I don't think any additional documentation is needed.",
      "created_at" : "2020-03-06T19:46:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-595931094",
      "id" : 595931094,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5NTkzMTA5NA==",
      "updated_at" : "2020-03-06T19:46:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/595931094",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r389109682"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/389109682"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes that's right.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-06T19:46:38Z",
      "diff_hunk" : "@@ -1942,10 +1943,16 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n             // Has inputs but not accepted to mempool\n             // Probably non-standard or insufficient fee\n             LogPrint(BCLog::MEMPOOL, \"   removed orphan tx %s\\n\", orphanHash.ToString());\n-            if (orphanTx.HasWitness() || orphan_state.GetResult() != TxValidationResult::TX_WITNESS_MUTATED) {\n-                // Do not use rejection cache for witness transactions or\n-                // witness-stripped transactions, as they can have been malleated.\n-                // See https://github.com/bitcoin/bitcoin/issues/8279 for details.\n+            if (orphan_state.GetResult() != TxValidationResult::TX_WITNESS_STRIPPED) {\n+                // Do not add txids of witness transactions or witness-stripped\n+                // transactions to the filter, as they can have been malleated;\n+                // adding such txids to the reject filter would potentially\n+                // interfere with relay of valid transactions from peers that\n+                // do not support wtxid-based relay. See\n+                // https://github.com/bitcoin/bitcoin/issues/8279 for details.\n+                // We can remove this restriction (and always add wtxids to\n+                // the filter even for witness stripped transactions) once\n+                // wtxid-based relay is broadly deployed.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r389109682",
      "id" : 389109682,
      "in_reply_to_id" : 385441278,
      "line" : 2054,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTEwOTY4Mg==",
      "original_commit_id" : "6e7290f8f830fbbe49f8578f5f4f3d52613c7056",
      "original_line" : 2054,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 304,
      "pull_request_review_id" : 370583227,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/389109682",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> @ariard This PR does not include a \"short-bit transaction identifier\" so I don't think any additional documentation is needed.\r\n\r\nYeah I know it's more a safeguard against someone proposing the idea in the future and this issue not being remembered.",
      "created_at" : "2020-03-07T05:35:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-596049687",
      "id" : 596049687,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5NjA0OTY4Nw==",
      "updated_at" : "2020-03-07T05:35:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/596049687",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r389864907"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/389864907"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Curious why the `uint32_t` enum type is being added; good practice?",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-09T17:59:55Z",
      "diff_hunk" : "@@ -358,12 +364,13 @@ const uint32_t MSG_TYPE_MASK    = 0xffffffff >> 2;\n  * These numbers are defined by the protocol. When adding a new value, be sure\n  * to mention it in the respective BIP.\n  */\n-enum GetDataMsg\n+enum GetDataMsg : uint32_t",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r389864907",
      "id" : 389864907,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg2NDkwNw==",
      "original_commit_id" : "1cdf17837b26b8dfaf1aeec4c4a1a4b73810e4a5",
      "original_line" : 367,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/protocol.h",
      "position" : null,
      "pull_request_review_id" : 353013332,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/389864907",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r389956408"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/389956408"
         }
      },
      "author_association" : "MEMBER",
      "body" : "s/microseconds/seconds/ in 068bf9f -- that said, there are several other static constexprs that are also described as `Î¼s` but expressed in `s`.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-09T20:55:40Z",
      "diff_hunk" : "@@ -69,6 +69,8 @@ static constexpr int HISTORICAL_BLOCK_AGE = 7 * 24 * 60 * 60;\n static constexpr int32_t MAX_PEER_TX_IN_FLIGHT = 100;\n /** Maximum number of announced transactions from a peer */\n static constexpr int32_t MAX_PEER_TX_ANNOUNCEMENTS = 2 * MAX_INV_SZ;\n+/** How many microseconds to delay requesting transactions via txids, if we have wtxid-relaying peers */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r389956408",
      "id" : 389956408,
      "line" : 78,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk1NjQwOA==",
      "original_commit_id" : "1cdf17837b26b8dfaf1aeec4c4a1a4b73810e4a5",
      "original_line" : 78,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 4,
      "pull_request_review_id" : 353013332,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/389956408",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r390040001"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/390040001"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Perhaps update the documentation L403-404 above to mention sorting the mempool by both txid and wtxid transaction hashes (and 5 criteria rather than 4, depending on how you count it).",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-10T00:56:40Z",
      "diff_hunk" : "@@ -467,6 +484,12 @@ class CTxMemPool\n         boost::multi_index::indexed_by<\n             // sorted by txid\n             boost::multi_index::hashed_unique<mempoolentry_txid, SaltedTxidHasher>,\n+            // sorted by wtxid",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r390040001",
      "id" : 390040001,
      "line" : 490,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA0MDAwMQ==",
      "original_commit_id" : "1cdf17837b26b8dfaf1aeec4c4a1a4b73810e4a5",
      "original_line" : 490,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : 47,
      "pull_request_review_id" : 353013332,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/390040001",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r390362519"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/390362519"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Because of this confusion I am generally not a fan of mentioning the type in the comment. I don't see why it's useful since ``std::chrono::microseconds`` definition is clear enough.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-10T14:38:57Z",
      "diff_hunk" : "@@ -69,6 +69,8 @@ static constexpr int HISTORICAL_BLOCK_AGE = 7 * 24 * 60 * 60;\n static constexpr int32_t MAX_PEER_TX_IN_FLIGHT = 100;\n /** Maximum number of announced transactions from a peer */\n static constexpr int32_t MAX_PEER_TX_ANNOUNCEMENTS = 2 * MAX_INV_SZ;\n+/** How many microseconds to delay requesting transactions via txids, if we have wtxid-relaying peers */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r390362519",
      "id" : 390362519,
      "in_reply_to_id" : 389956408,
      "line" : 78,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM2MjUxOQ==",
      "original_commit_id" : "1cdf17837b26b8dfaf1aeec4c4a1a4b73810e4a5",
      "original_line" : 78,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 4,
      "pull_request_review_id" : 372013913,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/390362519",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r390368090"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/390368090"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think MSG_WTXID is even more confusing than MSG_WTX. The suffix here represents an object being fetched. So TX or BLOCK with some type. MSG_WTXID would mean we are fetching an ID.\r\nThe only thing I can thing of is MSG_TX_BY_WTXID. But I'm also fine with MSG_WTX.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-10T14:46:01Z",
      "diff_hunk" : "@@ -363,7 +369,8 @@ enum GetDataMsg\n     UNDEFINED = 0,\n     MSG_TX = 1,\n     MSG_BLOCK = 2,\n-    // The following can only occur in getdata. Invs always use TX or BLOCK.\n+    MSG_WTX = 5, // Defined in BIP XXX",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r390368090",
      "id" : 390368090,
      "in_reply_to_id" : 378574214,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM2ODA5MA==",
      "original_commit_id" : "cf8c70fac6df96e23c37afe1c27eaa3925996caf",
      "original_line" : 372,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/protocol.h",
      "position" : null,
      "pull_request_review_id" : 372020907,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/390368090",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Also, I believe #18261 (the current implementation of Erlay) depends on these changes.",
      "created_at" : "2020-03-10T14:52:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-597129322",
      "id" : 597129322,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5NzEyOTMyMg==",
      "updated_at" : "2020-03-10T14:52:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/597129322",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r390383225"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/390383225"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe I've been staring at this for too long but I agree with @naumenkogs. I confused `MSG_TX` and `MSG_WTX` once during the first pass at reviewing a few weeks ago, but then I got used to it and I like its brevity. I think it's fine for now.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-10T15:05:06Z",
      "diff_hunk" : "@@ -363,7 +369,8 @@ enum GetDataMsg\n     UNDEFINED = 0,\n     MSG_TX = 1,\n     MSG_BLOCK = 2,\n-    // The following can only occur in getdata. Invs always use TX or BLOCK.\n+    MSG_WTX = 5, // Defined in BIP XXX",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r390383225",
      "id" : 390383225,
      "in_reply_to_id" : 378574214,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM4MzIyNQ==",
      "original_commit_id" : "cf8c70fac6df96e23c37afe1c27eaa3925996caf",
      "original_line" : 372,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/protocol.h",
      "position" : null,
      "pull_request_review_id" : 372040091,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/390383225",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r392472822"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392472822"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It seems that all call sites of `get_iter_from_wtxid` hold `cs` already. Perhaps it's better to have an `AssertLockHeld` / `EXCLUSIVE_LOCKS_REQUIRED` here instead?",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-13T20:58:15Z",
      "diff_hunk" : "@@ -690,8 +713,19 @@ class CTxMemPool\n         return (mapTx.count(hash) != 0);\n     }\n \n+    bool wtxid_exists(const uint256& hash) const\n+    {\n+        LOCK(cs);\n+        return (mapTx.get<index_by_wtxid>().count(hash) != 0);\n+    }\n+\n     CTransactionRef get(const uint256& hash) const;\n-    TxMempoolInfo info(const uint256& hash) const;\n+    txiter get_iter_from_wtxid(const uint256& wtxid) const\n+    {\n+        LOCK(cs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r392472822",
      "id" : 392472822,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQ3MjgyMg==",
      "original_commit_id" : "1d1fddb9790cb3b9a70df5370a71ac245491b71c",
      "original_line" : 725,
      "original_position" : 67,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : null,
      "pull_request_review_id" : 374616026,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392472822",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r392505176"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392505176"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Slightly more efficient and C++11ish:\r\n\r\n```suggestion\r\n                            auto ret2 = mapRelay.emplace(ret.first->second->GetWitnessHash(), ret.first->second);\r\n```",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-13T21:59:00Z",
      "diff_hunk" : "@@ -3927,6 +3927,11 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n                             if (ret.second) {\n                                 vRelayExpiration.push_back(std::make_pair(nNow + std::chrono::microseconds{RELAY_TX_CACHE_TIME}.count(), ret.first));\n                             }\n+                            // Add wtxid-based lookup into mapRelay as well, so that peers can request by wtxid\n+                            auto ret2 = mapRelay.insert(std::make_pair(ret.first->second->GetWitnessHash(), ret.first->second));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r392505176",
      "id" : 392505176,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUwNTE3Ng==",
      "original_commit_id" : "b91a879d2c003dd7f7eef174aa59845137eae1a7",
      "original_line" : 3931,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 374616026,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392505176",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r392505319"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392505319"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n                                vRelayExpiration.emplace_back(nNow + std::chrono::microseconds{RELAY_TX_CACHE_TIME}.count(), ret2.first);\r\n```",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-13T21:59:31Z",
      "diff_hunk" : "@@ -3927,6 +3927,11 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n                             if (ret.second) {\n                                 vRelayExpiration.push_back(std::make_pair(nNow + std::chrono::microseconds{RELAY_TX_CACHE_TIME}.count(), ret.first));\n                             }\n+                            // Add wtxid-based lookup into mapRelay as well, so that peers can request by wtxid\n+                            auto ret2 = mapRelay.insert(std::make_pair(ret.first->second->GetWitnessHash(), ret.first->second));\n+                            if (ret2.second) {\n+                                vRelayExpiration.push_back(std::make_pair(nNow + std::chrono::microseconds{RELAY_TX_CACHE_TIME}.count(), ret2.first));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r392505319",
      "id" : 392505319,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUwNTMxOQ==",
      "original_commit_id" : "b91a879d2c003dd7f7eef174aa59845137eae1a7",
      "original_line" : 3933,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 374616026,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392505319",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r392505963"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392505963"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    g_orphans_by_wtxid.emplace(tx->GetWitnessHash(), ret.first);\r\n```",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-13T22:01:41Z",
      "diff_hunk" : "@@ -869,6 +870,8 @@ bool AddOrphanTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRE\n     auto ret = mapOrphanTransactions.emplace(hash, COrphanTx{tx, peer, GetTime() + ORPHAN_TX_EXPIRE_TIME, g_orphan_list.size()});\n     assert(ret.second);\n     g_orphan_list.push_back(ret.first);\n+    // Allow for lookups in the orphan pool by wtxid, as well as txid\n+    g_orphans_by_wtxid.insert(std::make_pair(tx->GetWitnessHash(), ret.first));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r392505963",
      "id" : 392505963,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUwNTk2Mw==",
      "original_commit_id" : "591931a2b0ea807f6f1392c4cde0f46e04b79696",
      "original_line" : 874,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 374616026,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392505963",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r392511089"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392511089"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The comment on the next line here is outdated now.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-13T22:19:59Z",
      "diff_hunk" : "@@ -1916,12 +1916,12 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n             // Has inputs but not accepted to mempool\n             // Probably non-standard or insufficient fee\n             LogPrint(BCLog::MEMPOOL, \"   removed orphan tx %s\\n\", orphanHash.ToString());\n-            if (!orphanTx.HasWitness() && orphan_state.GetResult() != TxValidationResult::TX_WITNESS_MUTATED) {\n+            if (orphanTx.HasWitness() || orphan_state.GetResult() != TxValidationResult::TX_WITNESS_MUTATED) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r392511089",
      "id" : 392511089,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxMTA4OQ==",
      "original_commit_id" : "0d3d656ab5334db15b91cc0708d7e12db32a5e0a",
      "original_line" : 1919,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 374616026,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392511089",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r392512606"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392512606"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Next line's comment is outdated here as well.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-13T22:25:30Z",
      "diff_hunk" : "@@ -2604,14 +2604,15 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n                 // We will continue to reject this tx since it has rejected\n                 // parents so avoid re-requesting it from other peers.\n                 recentRejects->insert(tx.GetHash());\n+                recentRejects->insert(tx.GetWitnessHash());\n             }\n         } else {\n-            if (!tx.HasWitness() && state.GetResult() != TxValidationResult::TX_WITNESS_MUTATED) {\n+            if (tx.HasWitness() || state.GetResult() != TxValidationResult::TX_WITNESS_MUTATED) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r392512606",
      "id" : 392512606,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxMjYwNg==",
      "original_commit_id" : "0d3d656ab5334db15b91cc0708d7e12db32a5e0a",
      "original_line" : 2610,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 374616026,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392512606",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r392513202"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392513202"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can you use braces and indentation here? Combination of a line ending with ';' followed by `else` on the next line may be confusing.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-13T22:27:43Z",
      "diff_hunk" : "@@ -1356,7 +1360,8 @@ bool static AlreadyHave(const CInv& inv) EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n \n             {\n                 LOCK(g_cs_orphans);\n-                if (mapOrphanTransactions.count(inv.hash)) return true;\n+                if (inv.type != MSG_WTX && mapOrphanTransactions.count(inv.hash)) return true;\n+                else if (inv.type == MSG_WTX && g_orphans_by_wtxid.count(inv.hash)) return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r392513202",
      "id" : 392513202,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxMzIwMg==",
      "original_commit_id" : "44ea27c61d6466a6626fd986f2942e76c09465d8",
      "original_line" : 1364,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 374616026,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392513202",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r392519821"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392519821"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The conditional seems superfluous here.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-13T22:55:17Z",
      "diff_hunk" : "@@ -2175,10 +2179,23 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n             nCMPCTBLOCKVersion = 1;\n             connman->PushMessage(pfrom, msgMaker.Make(NetMsgType::SENDCMPCT, fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion));\n         }\n+\n         pfrom->fSuccessfullyConnected = true;\n         return true;\n     }\n \n+    // Feature negotiation of wtxidrelay should happen between VERSION and\n+    // VERACK, to avoid relay problems from switching after a connection is up\n+    if (strCommand == NetMsgType::WTXIDRELAY) {\n+        if (pfrom->nVersion >= WTXID_RELAY_VERSION) {\n+            LOCK(cs_main);\n+            if (!State(pfrom->GetId())->m_wtxid_relay) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r392519821",
      "id" : 392519821,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxOTgyMQ==",
      "original_commit_id" : "021c5d392b6469596ba8eaa18c9ea01dafd9fdf0",
      "original_line" : 2200,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 374616026,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392519821",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-03-16T15:16:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-599593067",
      "id" : 599593067,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5OTU5MzA2Nw==",
      "updated_at" : "2020-03-16T15:16:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/599593067",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r393948358"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393948358"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We use it to properly count the number of wtxid-relay peers.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-17T20:25:49Z",
      "diff_hunk" : "@@ -2175,10 +2179,23 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n             nCMPCTBLOCKVersion = 1;\n             connman->PushMessage(pfrom, msgMaker.Make(NetMsgType::SENDCMPCT, fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion));\n         }\n+\n         pfrom->fSuccessfullyConnected = true;\n         return true;\n     }\n \n+    // Feature negotiation of wtxidrelay should happen between VERSION and\n+    // VERACK, to avoid relay problems from switching after a connection is up\n+    if (strCommand == NetMsgType::WTXIDRELAY) {\n+        if (pfrom->nVersion >= WTXID_RELAY_VERSION) {\n+            LOCK(cs_main);\n+            if (!State(pfrom->GetId())->m_wtxid_relay) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r393948358",
      "id" : 393948358,
      "in_reply_to_id" : 392519821,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk0ODM1OA==",
      "original_commit_id" : "021c5d392b6469596ba8eaa18c9ea01dafd9fdf0",
      "original_line" : 2200,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 376378857,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393948358",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r393950006"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393950006"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I see @naumenkogs's point that this is redundant, but I don't understand why @jonatack is saying this is incorrect?  TXID_RELAY_DELAY is the number of microseconds that we wait before requesting a transaction, no?",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-17T20:28:57Z",
      "diff_hunk" : "@@ -69,6 +69,8 @@ static constexpr int HISTORICAL_BLOCK_AGE = 7 * 24 * 60 * 60;\n static constexpr int32_t MAX_PEER_TX_IN_FLIGHT = 100;\n /** Maximum number of announced transactions from a peer */\n static constexpr int32_t MAX_PEER_TX_ANNOUNCEMENTS = 2 * MAX_INV_SZ;\n+/** How many microseconds to delay requesting transactions via txids, if we have wtxid-relaying peers */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r393950006",
      "id" : 393950006,
      "in_reply_to_id" : 389956408,
      "line" : 78,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk1MDAwNg==",
      "original_commit_id" : "1cdf17837b26b8dfaf1aeec4c4a1a4b73810e4a5",
      "original_line" : 78,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 4,
      "pull_request_review_id" : 376380913,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393950006",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r393950777"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393950777"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oh, of course.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-17T20:30:26Z",
      "diff_hunk" : "@@ -2175,10 +2179,23 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n             nCMPCTBLOCKVersion = 1;\n             connman->PushMessage(pfrom, msgMaker.Make(NetMsgType::SENDCMPCT, fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion));\n         }\n+\n         pfrom->fSuccessfullyConnected = true;\n         return true;\n     }\n \n+    // Feature negotiation of wtxidrelay should happen between VERSION and\n+    // VERACK, to avoid relay problems from switching after a connection is up\n+    if (strCommand == NetMsgType::WTXIDRELAY) {\n+        if (pfrom->nVersion >= WTXID_RELAY_VERSION) {\n+            LOCK(cs_main);\n+            if (!State(pfrom->GetId())->m_wtxid_relay) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r393950777",
      "id" : 393950777,
      "in_reply_to_id" : 392519821,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk1MDc3Nw==",
      "original_commit_id" : "021c5d392b6469596ba8eaa18c9ea01dafd9fdf0",
      "original_line" : 2200,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 376381881,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393950777",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r393956494"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393956494"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-17T20:41:01Z",
      "diff_hunk" : "@@ -1356,7 +1360,8 @@ bool static AlreadyHave(const CInv& inv) EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n \n             {\n                 LOCK(g_cs_orphans);\n-                if (mapOrphanTransactions.count(inv.hash)) return true;\n+                if (inv.type != MSG_WTX && mapOrphanTransactions.count(inv.hash)) return true;\n+                else if (inv.type == MSG_WTX && g_orphans_by_wtxid.count(inv.hash)) return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r393956494",
      "id" : 393956494,
      "in_reply_to_id" : 392513202,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk1NjQ5NA==",
      "original_commit_id" : "44ea27c61d6466a6626fd986f2942e76c09465d8",
      "original_line" : 1364,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 376388889,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393956494",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r393956622"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393956622"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks, done.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-17T20:41:15Z",
      "diff_hunk" : "@@ -869,6 +870,8 @@ bool AddOrphanTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRE\n     auto ret = mapOrphanTransactions.emplace(hash, COrphanTx{tx, peer, GetTime() + ORPHAN_TX_EXPIRE_TIME, g_orphan_list.size()});\n     assert(ret.second);\n     g_orphan_list.push_back(ret.first);\n+    // Allow for lookups in the orphan pool by wtxid, as well as txid\n+    g_orphans_by_wtxid.insert(std::make_pair(tx->GetWitnessHash(), ret.first));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r393956622",
      "id" : 393956622,
      "in_reply_to_id" : 392505963,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk1NjYyMg==",
      "original_commit_id" : "591931a2b0ea807f6f1392c4cde0f46e04b79696",
      "original_line" : 874,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 376389050,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393956622",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r393956704"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393956704"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-17T20:41:24Z",
      "diff_hunk" : "@@ -3927,6 +3927,11 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n                             if (ret.second) {\n                                 vRelayExpiration.push_back(std::make_pair(nNow + std::chrono::microseconds{RELAY_TX_CACHE_TIME}.count(), ret.first));\n                             }\n+                            // Add wtxid-based lookup into mapRelay as well, so that peers can request by wtxid\n+                            auto ret2 = mapRelay.insert(std::make_pair(ret.first->second->GetWitnessHash(), ret.first->second));\n+                            if (ret2.second) {\n+                                vRelayExpiration.push_back(std::make_pair(nNow + std::chrono::microseconds{RELAY_TX_CACHE_TIME}.count(), ret2.first));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r393956704",
      "id" : 393956704,
      "in_reply_to_id" : 392505319,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk1NjcwNA==",
      "original_commit_id" : "b91a879d2c003dd7f7eef174aa59845137eae1a7",
      "original_line" : 3933,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 376389153,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393956704",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r393957003"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393957003"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-17T20:41:57Z",
      "diff_hunk" : "@@ -3927,6 +3927,11 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n                             if (ret.second) {\n                                 vRelayExpiration.push_back(std::make_pair(nNow + std::chrono::microseconds{RELAY_TX_CACHE_TIME}.count(), ret.first));\n                             }\n+                            // Add wtxid-based lookup into mapRelay as well, so that peers can request by wtxid\n+                            auto ret2 = mapRelay.insert(std::make_pair(ret.first->second->GetWitnessHash(), ret.first->second));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r393957003",
      "id" : 393957003,
      "in_reply_to_id" : 392505176,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk1NzAwMw==",
      "original_commit_id" : "b91a879d2c003dd7f7eef174aa59845137eae1a7",
      "original_line" : 3931,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 376389516,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393957003",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r393957074"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393957074"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-17T20:42:06Z",
      "diff_hunk" : "@@ -690,8 +713,19 @@ class CTxMemPool\n         return (mapTx.count(hash) != 0);\n     }\n \n+    bool wtxid_exists(const uint256& hash) const\n+    {\n+        LOCK(cs);\n+        return (mapTx.get<index_by_wtxid>().count(hash) != 0);\n+    }\n+\n     CTransactionRef get(const uint256& hash) const;\n-    TxMempoolInfo info(const uint256& hash) const;\n+    txiter get_iter_from_wtxid(const uint256& wtxid) const\n+    {\n+        LOCK(cs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r393957074",
      "id" : 393957074,
      "in_reply_to_id" : 392472822,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk1NzA3NA==",
      "original_commit_id" : "1d1fddb9790cb3b9a70df5370a71ac245491b71c",
      "original_line" : 725,
      "original_position" : 67,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : null,
      "pull_request_review_id" : 376389609,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393957074",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r393957303"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393957303"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks, fixed.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-17T20:42:32Z",
      "diff_hunk" : "@@ -467,6 +484,12 @@ class CTxMemPool\n         boost::multi_index::indexed_by<\n             // sorted by txid\n             boost::multi_index::hashed_unique<mempoolentry_txid, SaltedTxidHasher>,\n+            // sorted by wtxid",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r393957303",
      "id" : 393957303,
      "in_reply_to_id" : 390040001,
      "line" : 490,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk1NzMwMw==",
      "original_commit_id" : "1cdf17837b26b8dfaf1aeec4c4a1a4b73810e4a5",
      "original_line" : 490,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : 47,
      "pull_request_review_id" : 376389931,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393957303",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r393957941"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393957941"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This was aj's proposed fix to the build warning you reported before: https://github.com/bitcoin/bitcoin/pull/18044#discussion_r374576703",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-17T20:43:44Z",
      "diff_hunk" : "@@ -358,12 +364,13 @@ const uint32_t MSG_TYPE_MASK    = 0xffffffff >> 2;\n  * These numbers are defined by the protocol. When adding a new value, be sure\n  * to mention it in the respective BIP.\n  */\n-enum GetDataMsg\n+enum GetDataMsg : uint32_t",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r393957941",
      "id" : 393957941,
      "in_reply_to_id" : 389864907,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk1Nzk0MQ==",
      "original_commit_id" : "1cdf17837b26b8dfaf1aeec4c4a1a4b73810e4a5",
      "original_line" : 367,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/protocol.h",
      "position" : null,
      "pull_request_review_id" : 376390731,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393957941",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "There are a couple review notes about comments that I still need to go back and look at but this is now rebased to get rid of the conflicts with master after the refactor done in #17997, and most of the non-comment review feedback has been incorporated.  \r\n\r\nI also still need to measure the memory usage of mapTx to see if the estimate I'm using is correct.  \r\n\r\nIf anyone feels like contributing a test, I think that might help get this merged.",
      "created_at" : "2020-03-17T20:46:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-600288874",
      "id" : 600288874,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwMDI4ODg3NA==",
      "updated_at" : "2020-03-17T20:46:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/600288874",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r393968535"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393968535"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The value in the definition is expressed in seconds (albeit with microsecond precision), e.g. a delay of 2 seconds and not 2 microseconds, unless I am confused. There are several similar cases; I think this can be ignored and addressed (or not) separately.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-17T21:02:19Z",
      "diff_hunk" : "@@ -69,6 +69,8 @@ static constexpr int HISTORICAL_BLOCK_AGE = 7 * 24 * 60 * 60;\n static constexpr int32_t MAX_PEER_TX_IN_FLIGHT = 100;\n /** Maximum number of announced transactions from a peer */\n static constexpr int32_t MAX_PEER_TX_ANNOUNCEMENTS = 2 * MAX_INV_SZ;\n+/** How many microseconds to delay requesting transactions via txids, if we have wtxid-relaying peers */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r393968535",
      "id" : 393968535,
      "in_reply_to_id" : 389956408,
      "line" : 78,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk2ODUzNQ==",
      "original_commit_id" : "1cdf17837b26b8dfaf1aeec4c4a1a4b73810e4a5",
      "original_line" : 78,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 4,
      "pull_request_review_id" : 376402832,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393968535",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r394060201"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/394060201"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The comment is technically correct because it's referring to the `TXID_RELAY_DELAY` constant, not how it is computed. Compare it with how before it might have been `static const int TXID_RELAY_DELAY = 2 * 1000000`, where 2 was still a value in seconds.\r\n\r\nIt's a silly semantics discussion though. With the std::chrono types everywhere the comment could just be \"Duration of delay ...\".",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-18T01:34:44Z",
      "diff_hunk" : "@@ -69,6 +69,8 @@ static constexpr int HISTORICAL_BLOCK_AGE = 7 * 24 * 60 * 60;\n static constexpr int32_t MAX_PEER_TX_IN_FLIGHT = 100;\n /** Maximum number of announced transactions from a peer */\n static constexpr int32_t MAX_PEER_TX_ANNOUNCEMENTS = 2 * MAX_INV_SZ;\n+/** How many microseconds to delay requesting transactions via txids, if we have wtxid-relaying peers */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r394060201",
      "id" : 394060201,
      "in_reply_to_id" : 389956408,
      "line" : 78,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA2MDIwMQ==",
      "original_commit_id" : "1cdf17837b26b8dfaf1aeec4c4a1a4b73810e4a5",
      "original_line" : 78,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 4,
      "pull_request_review_id" : 376509593,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/394060201",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r394200854"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/394200854"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> the comment could just be \"Duration of delay ...\".\r\n\r\nYes.\r\n",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-18T09:15:51Z",
      "diff_hunk" : "@@ -69,6 +69,8 @@ static constexpr int HISTORICAL_BLOCK_AGE = 7 * 24 * 60 * 60;\n static constexpr int32_t MAX_PEER_TX_IN_FLIGHT = 100;\n /** Maximum number of announced transactions from a peer */\n static constexpr int32_t MAX_PEER_TX_ANNOUNCEMENTS = 2 * MAX_INV_SZ;\n+/** How many microseconds to delay requesting transactions via txids, if we have wtxid-relaying peers */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r394200854",
      "id" : 394200854,
      "in_reply_to_id" : 389956408,
      "line" : 78,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDIwMDg1NA==",
      "original_commit_id" : "1cdf17837b26b8dfaf1aeec4c4a1a4b73810e4a5",
      "original_line" : 78,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 4,
      "pull_request_review_id" : 376681058,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/394200854",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r399693214"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399693214"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is there a reason you've added a new function here, instead of extending `exists()` with a boolean `wtxid` parameter (in the same way that you've extended `CompareDepthAndScore()` and `info()`?",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-28T18:22:37Z",
      "diff_hunk" : "@@ -693,8 +717,19 @@ class CTxMemPool\n         return (mapTx.count(hash) != 0);\n     }\n \n+    bool wtxid_exists(const uint256& hash) const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r399693214",
      "id" : 399693214,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY5MzIxNA==",
      "original_commit_id" : "782a0b04496738030e3e51a6bf44aa5b426870b9",
      "original_line" : 725,
      "original_position" : 69,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : null,
      "pull_request_review_id" : 383336881,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399693214",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r399693288"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399693288"
         }
      },
      "author_association" : "MEMBER",
      "body" : "As above, I think it would be clearer if this was combined with `GetIter()`",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-28T18:23:21Z",
      "diff_hunk" : "@@ -693,8 +717,19 @@ class CTxMemPool\n         return (mapTx.count(hash) != 0);\n     }\n \n+    bool wtxid_exists(const uint256& hash) const\n+    {\n+        LOCK(cs);\n+        return (mapTx.get<index_by_wtxid>().count(hash) != 0);\n+    }\n+\n     CTransactionRef get(const uint256& hash) const;\n-    TxMempoolInfo info(const uint256& hash) const;\n+    txiter get_iter_from_wtxid(const uint256& wtxid) const EXCLUSIVE_LOCKS_REQUIRED(cs)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r399693288",
      "id" : 399693288,
      "line" : 729,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY5MzI4OA==",
      "original_commit_id" : "782a0b04496738030e3e51a6bf44aa5b426870b9",
      "original_line" : 729,
      "original_position" : 77,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : 95,
      "pull_request_review_id" : 383336881,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399693288",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r399693555"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399693555"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is there a good reason not to use `txid` and `wtxid` here instead of looking them up again?",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-28T18:25:32Z",
      "diff_hunk" : "@@ -2517,26 +2577,42 @@ bool ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStream& vR\n         vRecv >> ptx;\n         const CTransaction& tx = *ptx;\n \n-        CInv inv(MSG_TX, tx.GetHash());\n-        pfrom->AddInventoryKnown(inv);\n+        const uint256& txid = ptx->GetHash();\n+        const uint256& wtxid = ptx->GetWitnessHash();\n \n         LOCK2(cs_main, g_cs_orphans);\n \n+        CNodeState* nodestate = State(pfrom->GetId());\n+\n+        const uint256& hash = nodestate->m_wtxid_relay ? wtxid : txid;\n+        pfrom->AddKnownTx(hash);\n+\n         TxValidationState state;\n \n-        CNodeState* nodestate = State(pfrom->GetId());\n-        nodestate->m_tx_download.m_tx_announced.erase(inv.hash);\n-        nodestate->m_tx_download.m_tx_in_flight.erase(inv.hash);\n-        EraseTxRequest(inv.hash);\n+        nodestate->m_tx_download.m_tx_announced.erase(hash);\n+        nodestate->m_tx_download.m_tx_in_flight.erase(hash);\n+        EraseTxRequest(hash);\n \n         std::list<CTransactionRef> lRemovedTxn;\n \n-        if (!AlreadyHave(inv, mempool) &&\n+        // We do the AlreadyHave() check using wtxid, rather than txid - in the\n+        // absence of witness malleation, this is strictly better, because the\n+        // recent rejects filter may contain the wtxid but will never contain\n+        // the txid of a segwit transaction that has been rejected.\n+        // In the presence of witness malleation, it's possible that by only\n+        // doing the check with wtxid, we could overlook a transaction which\n+        // was confirmed with a different witness, or exists in our mempool\n+        // with a different witness, but this has limited downside:\n+        // mempool validation does its own lookup of whether we have the txid\n+        // already; and an adversary can already relay us old transactions\n+        // (older than our recency filter) if trying to DoS us, without any need\n+        // for witness malleation.\n+        if (!AlreadyHave(CInv(MSG_WTX, wtxid), mempool) &&\n             AcceptToMemoryPool(mempool, state, ptx, &lRemovedTxn, false /* bypass_limits */, 0 /* nAbsurdFee */)) {\n             mempool.check(&::ChainstateActive().CoinsTip());\n-            RelayTransaction(tx.GetHash(), *connman);\n+            RelayTransaction(tx.GetHash(), tx.GetWitnessHash(), *connman);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r399693555",
      "id" : 399693555,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY5MzU1NQ==",
      "original_commit_id" : "782a0b04496738030e3e51a6bf44aa5b426870b9",
      "original_line" : 2957,
      "original_position" : 335,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 383336881,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399693555",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r399702162"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399702162"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't understand how this is supposed to work. You add the parent's txid to the node's `m_tx_process_time` via `RequestTx()` here, but when we process it in `SendMessages()` getdata logic, we always construct a `CInv` with type `MSG_WTX`. The receiving node will fail to find the tx because it searches in the mempool for a tx with that wtxid.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-28T19:50:14Z",
      "diff_hunk" : "@@ -2568,8 +2644,13 @@ bool ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStream& vR\n                 const auto current_time = GetTime<std::chrono::microseconds>();\n \n                 for (const CTxIn& txin : tx.vin) {\n+                    // Here, we only have the txid (and not wtxid) of the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r399702162",
      "id" : 399702162,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTcwMjE2Mg==",
      "original_commit_id" : "782a0b04496738030e3e51a6bf44aa5b426870b9",
      "original_line" : 2647,
      "original_position" : 346,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 383336881,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/399702162",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r400167606"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/400167606"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This also happens if a buggy node sends `CInv` with `MSG_WTX` without having announced `wtxidrelay` first, or `MSG_TX` after having announced `wtxidrelay` I think.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-30T12:54:41Z",
      "diff_hunk" : "@@ -2568,8 +2644,13 @@ bool ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStream& vR\n                 const auto current_time = GetTime<std::chrono::microseconds>();\n \n                 for (const CTxIn& txin : tx.vin) {\n+                    // Here, we only have the txid (and not wtxid) of the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r400167606",
      "id" : 400167606,
      "in_reply_to_id" : 399702162,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDE2NzYwNg==",
      "original_commit_id" : "782a0b04496738030e3e51a6bf44aa5b426870b9",
      "original_line" : 2647,
      "original_position" : 346,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 383823095,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/400167606",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r400169765"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/400169765"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`GetHash()` and `GetWitnessHash()` are inline and just return pre-cached results anyway so it should make no practical difference. Probably clearer to use the shorter aliases though.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-30T12:58:03Z",
      "diff_hunk" : "@@ -2517,26 +2577,42 @@ bool ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStream& vR\n         vRecv >> ptx;\n         const CTransaction& tx = *ptx;\n \n-        CInv inv(MSG_TX, tx.GetHash());\n-        pfrom->AddInventoryKnown(inv);\n+        const uint256& txid = ptx->GetHash();\n+        const uint256& wtxid = ptx->GetWitnessHash();\n \n         LOCK2(cs_main, g_cs_orphans);\n \n+        CNodeState* nodestate = State(pfrom->GetId());\n+\n+        const uint256& hash = nodestate->m_wtxid_relay ? wtxid : txid;\n+        pfrom->AddKnownTx(hash);\n+\n         TxValidationState state;\n \n-        CNodeState* nodestate = State(pfrom->GetId());\n-        nodestate->m_tx_download.m_tx_announced.erase(inv.hash);\n-        nodestate->m_tx_download.m_tx_in_flight.erase(inv.hash);\n-        EraseTxRequest(inv.hash);\n+        nodestate->m_tx_download.m_tx_announced.erase(hash);\n+        nodestate->m_tx_download.m_tx_in_flight.erase(hash);\n+        EraseTxRequest(hash);\n \n         std::list<CTransactionRef> lRemovedTxn;\n \n-        if (!AlreadyHave(inv, mempool) &&\n+        // We do the AlreadyHave() check using wtxid, rather than txid - in the\n+        // absence of witness malleation, this is strictly better, because the\n+        // recent rejects filter may contain the wtxid but will never contain\n+        // the txid of a segwit transaction that has been rejected.\n+        // In the presence of witness malleation, it's possible that by only\n+        // doing the check with wtxid, we could overlook a transaction which\n+        // was confirmed with a different witness, or exists in our mempool\n+        // with a different witness, but this has limited downside:\n+        // mempool validation does its own lookup of whether we have the txid\n+        // already; and an adversary can already relay us old transactions\n+        // (older than our recency filter) if trying to DoS us, without any need\n+        // for witness malleation.\n+        if (!AlreadyHave(CInv(MSG_WTX, wtxid), mempool) &&\n             AcceptToMemoryPool(mempool, state, ptx, &lRemovedTxn, false /* bypass_limits */, 0 /* nAbsurdFee */)) {\n             mempool.check(&::ChainstateActive().CoinsTip());\n-            RelayTransaction(tx.GetHash(), *connman);\n+            RelayTransaction(tx.GetHash(), tx.GetWitnessHash(), *connman);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r400169765",
      "id" : 400169765,
      "in_reply_to_id" : 399693555,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDE2OTc2NQ==",
      "original_commit_id" : "782a0b04496738030e3e51a6bf44aa5b426870b9",
      "original_line" : 2957,
      "original_position" : 335,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 383825786,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/400169765",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r400444597"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/400444597"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This logic of requesting unconfirmed parent transactions when an orphan is received should eventually go away, in favor of some sort of package relay scheme, where orphan transactions trigger discovery of all unconfirmed ancestors -- so I think the question is what to do in the meantime.  I think wtxid-based relay is more important than optimizing this behavior when we encounter an orphan.\r\n\r\nNote that we only just recently (#16851, merged last October) fixed things so that these requests worked for transactions that are not in mapRelay.  Also note that for transactions that are still in mapRelay, or for non-segwit transactions where txid and wtxid are the same, these requests will still work.  However this is admittedly a regression in behavior, undoing the benefit of #16851.  However given how long that behavior was broken (and that the recent fix was largely at my urging, I believe), it's hard for me to think that anyone is really too concerned with this.\r\n\r\nAnyway it is possible to improve this by keeping extra bookkeeping so that requests generated this way go out as MSG_TX, but I don't think it's worth it -- it's a lot of additional complexity for very little benefit, and I think effort spent on improving orphan transaction relay should be devoted to a p2p protocol extension that supports it directly.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-30T19:35:43Z",
      "diff_hunk" : "@@ -2568,8 +2644,13 @@ bool ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStream& vR\n                 const auto current_time = GetTime<std::chrono::microseconds>();\n \n                 for (const CTxIn& txin : tx.vin) {\n+                    // Here, we only have the txid (and not wtxid) of the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r400444597",
      "id" : 400444597,
      "in_reply_to_id" : 399702162,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQ0NDU5Nw==",
      "original_commit_id" : "782a0b04496738030e3e51a6bf44aa5b426870b9",
      "original_line" : 2647,
      "original_position" : 346,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 384168419,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/400444597",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r400447324"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/400447324"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this is just a style choice, trying to balance different tradeoffs:\r\n- if you change a function's arguments, then you have to change all call sites, unless you use an optional argument\r\n- changing lots of call sites is not great as it adds noise to PR review\r\n- optional arguments are not great as they can make it harder to maintain code and do review in the future\r\n\r\nBut sometimes optional arguments are the easier way to go, to avoid having to embed hairy logic at a bunch of call sites to decide which function to call, which can also harm readability.  So I think it's just a balance, and I tried to strike the balance I thought made sense when I was writing all this which wasn't always the same for every example, but maybe I could have done better.  \r\n\r\nAnyway at this point I'd prefer not to make stylistic changes to this PR.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-30T19:40:57Z",
      "diff_hunk" : "@@ -693,8 +717,19 @@ class CTxMemPool\n         return (mapTx.count(hash) != 0);\n     }\n \n+    bool wtxid_exists(const uint256& hash) const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r400447324",
      "id" : 400447324,
      "in_reply_to_id" : 399693214,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQ0NzMyNA==",
      "original_commit_id" : "782a0b04496738030e3e51a6bf44aa5b426870b9",
      "original_line" : 725,
      "original_position" : 69,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : null,
      "pull_request_review_id" : 384171979,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/400447324",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r400448519"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/400448519"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Looking at the diff, I note that the code change I have here looks clearly correct if you believe the old code was correct.  Given the lack of performance sensitivity I'm not inclined to change this.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-30T19:43:10Z",
      "diff_hunk" : "@@ -2517,26 +2577,42 @@ bool ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStream& vR\n         vRecv >> ptx;\n         const CTransaction& tx = *ptx;\n \n-        CInv inv(MSG_TX, tx.GetHash());\n-        pfrom->AddInventoryKnown(inv);\n+        const uint256& txid = ptx->GetHash();\n+        const uint256& wtxid = ptx->GetWitnessHash();\n \n         LOCK2(cs_main, g_cs_orphans);\n \n+        CNodeState* nodestate = State(pfrom->GetId());\n+\n+        const uint256& hash = nodestate->m_wtxid_relay ? wtxid : txid;\n+        pfrom->AddKnownTx(hash);\n+\n         TxValidationState state;\n \n-        CNodeState* nodestate = State(pfrom->GetId());\n-        nodestate->m_tx_download.m_tx_announced.erase(inv.hash);\n-        nodestate->m_tx_download.m_tx_in_flight.erase(inv.hash);\n-        EraseTxRequest(inv.hash);\n+        nodestate->m_tx_download.m_tx_announced.erase(hash);\n+        nodestate->m_tx_download.m_tx_in_flight.erase(hash);\n+        EraseTxRequest(hash);\n \n         std::list<CTransactionRef> lRemovedTxn;\n \n-        if (!AlreadyHave(inv, mempool) &&\n+        // We do the AlreadyHave() check using wtxid, rather than txid - in the\n+        // absence of witness malleation, this is strictly better, because the\n+        // recent rejects filter may contain the wtxid but will never contain\n+        // the txid of a segwit transaction that has been rejected.\n+        // In the presence of witness malleation, it's possible that by only\n+        // doing the check with wtxid, we could overlook a transaction which\n+        // was confirmed with a different witness, or exists in our mempool\n+        // with a different witness, but this has limited downside:\n+        // mempool validation does its own lookup of whether we have the txid\n+        // already; and an adversary can already relay us old transactions\n+        // (older than our recency filter) if trying to DoS us, without any need\n+        // for witness malleation.\n+        if (!AlreadyHave(CInv(MSG_WTX, wtxid), mempool) &&\n             AcceptToMemoryPool(mempool, state, ptx, &lRemovedTxn, false /* bypass_limits */, 0 /* nAbsurdFee */)) {\n             mempool.check(&::ChainstateActive().CoinsTip());\n-            RelayTransaction(tx.GetHash(), *connman);\n+            RelayTransaction(tx.GetHash(), tx.GetWitnessHash(), *connman);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r400448519",
      "id" : 400448519,
      "in_reply_to_id" : 399693555,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQ0ODUxOQ==",
      "original_commit_id" : "782a0b04496738030e3e51a6bf44aa5b426870b9",
      "original_line" : 2957,
      "original_position" : 335,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 384173467,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/400448519",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@fjahr Thanks for starting work on a test in #18446!  Once things converge in the review there I'd be happy to include those commits here as well.",
      "created_at" : "2020-03-30T19:48:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-606208367",
      "id" : 606208367,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwNjIwODM2Nw==",
      "updated_at" : "2020-03-30T19:48:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/606208367",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r400535511"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/400535511"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I disagree with the argument \"this was broken for a long time and we only recently fixed it, so it's ok to break it again\"\r\n\r\n> it is possible to improve this by keeping extra bookkeeping ... it's a lot of additional complexity.\r\n\r\nThis doesn't seem like too much additional complexity. We store in `m_tx_process_time` whether the request should be for a txid or a wtxid, and set the GETDATA INV based on that. That's one additional bit of information, which could be a bool or a `enum GetDataMsg`.\r\n\r\n> for transactions that are still in mapRelay [...] these requests will still work\r\n\r\nOh, I hadn't realised that we'd respond to a MSG_WTX GETDATA request for a wtxid with a transaction that has that txid. The draft BIP doesn't specify that we should do that, and it seems extremely unintuitive. Could we have two `mapRelay`s - one based on txid and one based on wtxid so we don't do this?\r\n\r\n(I also think that we should remove mapRelay entirely (#17303), which depends on responding to NOTFOUNDs (#18238), which currently is broken and seems to be waiting for this PR (https://github.com/bitcoin/bitcoin/pull/18238#discussion_r398318859))",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-30T22:35:29Z",
      "diff_hunk" : "@@ -2568,8 +2644,13 @@ bool ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStream& vR\n                 const auto current_time = GetTime<std::chrono::microseconds>();\n \n                 for (const CTxIn& txin : tx.vin) {\n+                    // Here, we only have the txid (and not wtxid) of the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r400535511",
      "id" : 400535511,
      "in_reply_to_id" : 399702162,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUzNTUxMQ==",
      "original_commit_id" : "782a0b04496738030e3e51a6bf44aa5b426870b9",
      "original_line" : 2647,
      "original_position" : 346,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 384280841,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/400535511",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r400557458"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/400557458"
         }
      },
      "author_association" : "MEMBER",
      "body" : ">I disagree with the argument \"this was broken for a long time and we only recently fixed it, so it's ok to break it again\"\r\n\r\nPlease, that is not the entirety of the argument; the substance of what is being \"broken\" -- and how significant it is -- is relevant too.  It's not like transaction relay was horribly broken until the last release.  \r\n\r\nFor context: fixing the behavior as we did was something that I suggested we do in order to make another improvement I wanted to make -- package relay -- something that we could introduce in two parts, first as a pure client-side behavior integrated with orphan handling, and then as a p2p protocol extension.  Since then, I concluded that splitting those two things up doesn't make sense, as getting the orphan handling part right is complicated enough that it isn't worth the review burden for something that would just be ripped out later (and so I think we just go straight to package relay with a p2p protocol extension).\r\n\r\nI think it'd be perfectly reasonable to just rip out this behavior of trying to request parents when we receive an orphan -- it is fundamentally unreliable and is already just an opportunistic way to improve relay in one edge case situation.  Adding complexity solely for the purpose of supporting something that flaky is something we should all be skeptical about; this part of the codebase is already very difficult for most people to understand.\r\n\r\n> Oh, I hadn't realised that we'd respond to a MSG_WTX GETDATA request for a wtxid with a transaction that has that txid. The draft BIP doesn't specify that we should do that, and it seems extremely unintuitive. Could we have two mapRelays - one based on txid and one based on wtxid so we don't do this?\r\n\r\nI don't see the downside -- the behavior I've implemented seems strictly better, though non-essential and not something I think we need to specify in a BIP as behavior we promise to maintain.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-30T23:37:02Z",
      "diff_hunk" : "@@ -2568,8 +2644,13 @@ bool ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStream& vR\n                 const auto current_time = GetTime<std::chrono::microseconds>();\n \n                 for (const CTxIn& txin : tx.vin) {\n+                    // Here, we only have the txid (and not wtxid) of the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r400557458",
      "id" : 400557458,
      "in_reply_to_id" : 399702162,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU1NzQ1OA==",
      "original_commit_id" : "782a0b04496738030e3e51a6bf44aa5b426870b9",
      "original_line" : 2647,
      "original_position" : 346,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 384306035,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/400557458",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r400567195"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/400567195"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> I don't see the downside\r\n\r\nJust my opinion, but: the p2p code is already really complicated and not really well understood, adding new behaviours and having the implementation and the spec differ in ways that matter in practice and aren't obvious seems like it makes that a fair bit worse. This makes the review burden for both this PR and future p2p changes much higher, since you can't just read the BIPs to understand how things should work, or the local bits of code to see how they do work to see if a change makes sense, but you have to deeply understand how many things interact to even get started.\r\n\r\nI was going to suggest adding code to explicitly ignore INVs that come in with the wrong TX/WTX marker for the peer sending them, and to not request orphan txs' parents when we're in WTX mode -- I do agree that behaviour's not too crucial to keep even without package relay; I just don't think mixing wtxid/txid values and having functionality relying on weird undocumented special cases like that working sometimes (only while the tx is in mapRelay but not after expiry?) is okay.\r\n\r\n(Not a nack, just my opinion; I'm open to being convinced otherwise. But I think I'll go back to poking at the notfound pr rather than holding off for this one getting merged for now)",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-31T00:08:21Z",
      "diff_hunk" : "@@ -2568,8 +2644,13 @@ bool ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStream& vR\n                 const auto current_time = GetTime<std::chrono::microseconds>();\n \n                 for (const CTxIn& txin : tx.vin) {\n+                    // Here, we only have the txid (and not wtxid) of the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r400567195",
      "id" : 400567195,
      "in_reply_to_id" : 399702162,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU2NzE5NQ==",
      "original_commit_id" : "782a0b04496738030e3e51a6bf44aa5b426870b9",
      "original_line" : 2647,
      "original_position" : 346,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 384317300,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/400567195",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r400958023"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/400958023"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@ajtowns My view on this is that what goes into a BIP are the essential behaviors that all implementations should abide by in order to make an idea work, but non-essential implementation details are left for projects to individually figure out.\r\n\r\nThis makes it easier for new protocol extensions to get adopted by the whole community (the fewer requirements, the better), and for our own software to stay compatible with the BIPs we claim to implement, as otherwise we'd have to constantly deprecate/redraft/repropose, as we make minor changes to our own implementation.\r\n\r\nI'd say that how we handle a getdata request for a value that we never announced is one of those non-essential behaviors -- ignoring it is certainly fair, and returning something useful is obviously better still.  No one should assume, or would assume, that this is something that *ought* to work, so I don't think any software would be relying on this.\r\n\r\nAlso, if we had a set of design docs for how our own project implements particular BIPs, I'd agree that those should reflect more exactly what our code does -- but that would be a new initiative for us.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-31T14:27:37Z",
      "diff_hunk" : "@@ -2568,8 +2644,13 @@ bool ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStream& vR\n                 const auto current_time = GetTime<std::chrono::microseconds>();\n \n                 for (const CTxIn& txin : tx.vin) {\n+                    // Here, we only have the txid (and not wtxid) of the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r400958023",
      "id" : 400958023,
      "in_reply_to_id" : 399702162,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDk1ODAyMw==",
      "original_commit_id" : "782a0b04496738030e3e51a6bf44aa5b426870b9",
      "original_line" : 2647,
      "original_position" : 346,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 384789380,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/400958023",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r401018724"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401018724"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I find this behavior very confusing. Can you help me understand if I'm getting any of this wrong:\r\n\r\n1. We have a peer that has negotiated wtxid relay\r\n2. That peer relays us a transaction whose parents we don't have\r\n3. We want to request the parent transaction, so we put the **txid** in the `m_tx_process_time` and `m_tx_announced` for this peer (https://github.com/bitcoin/bitcoin/pull/18044/files#diff-eff7adeaec73a769788bb78858815c91R2654). That **txid** will later be added to the global `g_already_asked_for` (https://github.com/bitcoin/bitcoin/pull/18044/files#diff-eff7adeaec73a769788bb78858815c91R4151)\r\n4. In `SendMessages()` we request that transaction with a MSG_WTX GETDATA, but with the hash set to the **txid** (https://github.com/bitcoin/bitcoin/pull/18044/files#diff-eff7adeaec73a769788bb78858815c91R3990). \r\n5. The peer responds to that GETDATA with a TX because it looks in its mapRelay for transactions with a txid OR wtxid that match (https://github.com/bitcoin/bitcoin/pull/18044/files#diff-eff7adeaec73a769788bb78858815c91R1628)\r\n6. When we receive the TX, we try to remove the **wtxid** from the peer's `m_tx_announced` and `m_tx_in_flight`, and the global `g_already_asked_for` (https://github.com/bitcoin/bitcoin/pull/18044/files#diff-eff7adeaec73a769788bb78858815c91R2587-R2594)\r\n\r\nThe thing I don't understand is that we seem to be adding the txid to these per-peer and global structures, and then trying to remove the wtxid from them. Will the txid ever be cleared? Do we end up in a request loop with the peer?",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-31T15:44:37Z",
      "diff_hunk" : "@@ -2568,8 +2644,13 @@ bool ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStream& vR\n                 const auto current_time = GetTime<std::chrono::microseconds>();\n \n                 for (const CTxIn& txin : tx.vin) {\n+                    // Here, we only have the txid (and not wtxid) of the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r401018724",
      "id" : 401018724,
      "in_reply_to_id" : 399702162,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTAxODcyNA==",
      "original_commit_id" : "782a0b04496738030e3e51a6bf44aa5b426870b9",
      "original_line" : 2647,
      "original_position" : 346,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 384865504,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401018724",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r401205210"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401205210"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I also can't quite follow the logic here: https://github.com/bitcoin/bitcoin/pull/18044/files#diff-eff7adeaec73a769788bb78858815c91R4139-R4140\r\n\r\nIt looks to me like the **txid** has been added to `m_tx_process_time`, but when we call into `AlreadyHave(inv, m_mempool)`, the inv is a `MSG_WTX`, so we'll check in our mempool for a transaction with that **wtxid** (which we won't find). We'll then rerequest the transaction from our peer.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-03-31T20:47:44Z",
      "diff_hunk" : "@@ -2568,8 +2644,13 @@ bool ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStream& vR\n                 const auto current_time = GetTime<std::chrono::microseconds>();\n \n                 for (const CTxIn& txin : tx.vin) {\n+                    // Here, we only have the txid (and not wtxid) of the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r401205210",
      "id" : 401205210,
      "in_reply_to_id" : 399702162,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIwNTIxMA==",
      "original_commit_id" : "782a0b04496738030e3e51a6bf44aa5b426870b9",
      "original_line" : 2647,
      "original_position" : 346,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 385092425,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401205210",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r402389444"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/402389444"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "@sdaftuar \"No one should assume, or would assume, that this is something that ought to work\" -- but... aren't we assuming that it will work when we send a WTX request with a txid instead of a wtxid?\r\n\r\nAside from any bugs, I think this adds three lots of technical debt:\r\n\r\n * we're replying to `GETDATA WTX <txid>` and `GETDATA TX <wtxid>` if the tx is still in mapRelay -- this will go away if/when mapRelay goes away\r\n * we're asking for `WTX <txid>` when looking for parents of orphan transactions -- if we figure out how to replace orphan handling with package relay, this will go away too; but in the meantime it means mapRelay going away breaks orphan handling, and I think it breaks orphan handling when the parent's >15m old immediately\r\n * in the functional tests, as of #18446 at least, we're still sending TX INVs/GETDATAs etc despite claiming to be of a version that supports wtxid relay\r\n\r\nOne alternative might be to embrace the ambiguity: make the BIP be \"if you signal wtxidrelay, then we'll send `INV TX wtxid` instead of `INV TX txid`, and also allow you to request txs by either `GETDATA TX txid` or `GETDATA TX wtxid`\" ?",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-04-02T15:08:52Z",
      "diff_hunk" : "@@ -2568,8 +2644,13 @@ bool ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStream& vR\n                 const auto current_time = GetTime<std::chrono::microseconds>();\n \n                 for (const CTxIn& txin : tx.vin) {\n+                    // Here, we only have the txid (and not wtxid) of the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r402389444",
      "id" : 402389444,
      "in_reply_to_id" : 399702162,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM4OTQ0NA==",
      "original_commit_id" : "782a0b04496738030e3e51a6bf44aa5b426870b9",
      "original_line" : 2647,
      "original_position" : 346,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 386522752,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/402389444",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r402545909"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/402545909"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think I'm just going to eliminate the logic for requesting orphan parents from wtxid-relay peers, as you suggested above -- I think that is the simplest approach, and should eliminate the bugs reported by @jnewbery.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-04-02T19:04:50Z",
      "diff_hunk" : "@@ -2568,8 +2644,13 @@ bool ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStream& vR\n                 const auto current_time = GetTime<std::chrono::microseconds>();\n \n                 for (const CTxIn& txin : tx.vin) {\n+                    // Here, we only have the txid (and not wtxid) of the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r402545909",
      "id" : 402545909,
      "in_reply_to_id" : 399702162,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU0NTkwOQ==",
      "original_commit_id" : "782a0b04496738030e3e51a6bf44aa5b426870b9",
      "original_line" : 2647,
      "original_position" : 346,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 386715362,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/402545909",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r403953004"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/403953004"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Seems okay. I think it could make sense to explicitly skip INVs offering a TX/WTX that we'd incorrectly GETDATA as a WTX/TX (respectively) as well:\r\n\r\n```diff\r\n--- a/src/net_processing.cpp\r\n+++ b/src/net_processing.cpp\r\n@@ -2323,6 +2323,13 @@ bool ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStream& vR\r\n             if (interruptMsgProc)\r\n                 return true;\r\n \r\n+            // ignore INVs that don't match wtxidrelay setting\r\n+            if (State(pfrom->GetId())->m_wtxid_relay) {\r\n+                if (inv.type == MSG_TX) continue;\r\n+            } else {\r\n+                if (inv.type == MSG_WTX) continue;\r\n+            }\r\n+\r\n             bool fAlreadyHave = AlreadyHave(inv, mempool);\r\n             LogPrint(BCLog::NET, \"got inv: %s  %s peer=%d\\n\", inv.ToString(), fAlreadyHave ? \"have\" : \"new\", pfrom->GetId());\r\n```\r\n\r\n[I had a go](https://github.com/bitcoin/bitcoin/pull/18446#pullrequestreview-386416835) at updating fjahr's tests, and it seems to make reasonable sense (either with or without the change I suggest here)\r\n\r\n(This still leaves us with the tech debt of our functional tests mostly testing tx relay when we'll be moving towards doing wtxid relay most of the time in the real world, but that's not really avoidable)",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-04-06T09:31:24Z",
      "diff_hunk" : "@@ -2568,8 +2644,13 @@ bool ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStream& vR\n                 const auto current_time = GetTime<std::chrono::microseconds>();\n \n                 for (const CTxIn& txin : tx.vin) {\n+                    // Here, we only have the txid (and not wtxid) of the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r403953004",
      "id" : 403953004,
      "in_reply_to_id" : 399702162,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzk1MzAwNA==",
      "original_commit_id" : "782a0b04496738030e3e51a6bf44aa5b426870b9",
      "original_line" : 2647,
      "original_position" : 346,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 388080235,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/403953004",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r412306569"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/412306569"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> (This still leaves us with the tech debt of our functional tests mostly testing tx relay when we'll be moving towards doing wtxid relay most of the time in the real world, but that's not really avoidable)\r\n\r\nI think that should be addressed with this update: https://github.com/fjahr/bitcoin/commit/becdb68ab37fdcbc1dcf743b19ea8629f52677bb",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-04-21T16:28:46Z",
      "diff_hunk" : "@@ -2568,8 +2644,13 @@ bool ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStream& vR\n                 const auto current_time = GetTime<std::chrono::microseconds>();\n \n                 for (const CTxIn& txin : tx.vin) {\n+                    // Here, we only have the txid (and not wtxid) of the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r412306569",
      "id" : 412306569,
      "in_reply_to_id" : 399702162,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjMwNjU2OQ==",
      "original_commit_id" : "782a0b04496738030e3e51a6bf44aa5b426870b9",
      "original_line" : 2647,
      "original_position" : 346,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 397471139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/412306569",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r412350247"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/412350247"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> I think it could make sense to explicitly skip INVs offering a TX/WTX that we'd incorrectly GETDATA as a WTX/TX (respectively) as well:\r\n\r\nAnd I agree with @ajtowns , this behavior makes intuitive sense to me and it matches my interpretation of the current description in the BIP: \"After a node has sent and received a \"wtxidrelay\" message to/from a given peer, the node is required to use the MSG_WTX inv-type when announcing transactions to that peer, or requesting announced transactions from that peer.\" \r\n\r\nI think it would even be reasonable to argue about banning peers for this behavior if there is an agreement that this behavior is wrong. The node is unnecessarily spamming the network and just silently dropping the message might let it take longer until an issue with this is discovered by the node user.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-04-21T17:28:16Z",
      "diff_hunk" : "@@ -2568,8 +2644,13 @@ bool ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStream& vR\n                 const auto current_time = GetTime<std::chrono::microseconds>();\n \n                 for (const CTxIn& txin : tx.vin) {\n+                    // Here, we only have the txid (and not wtxid) of the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r412350247",
      "id" : 412350247,
      "in_reply_to_id" : 399702162,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM1MDI0Nw==",
      "original_commit_id" : "782a0b04496738030e3e51a6bf44aa5b426870b9",
      "original_line" : 2647,
      "original_position" : 346,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 397520388,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/412350247",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-04-29T08:46:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-621070832",
      "id" : 621070832,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMTA3MDgzMg==",
      "updated_at" : "2020-04-29T08:46:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/621070832",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@amitiuttarwar follow-up on this https://github.com/bitcoin/bitcoin/pull/18038#discussion_r400569145, now 18038 has been merged it would be really kind to have a patch for mempool intial-broadcast reattempt support and avoid wtxid taking too much delay :)",
      "created_at" : "2020-04-30T06:28:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-621639288",
      "id" : 621639288,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMTYzOTI4OA==",
      "updated_at" : "2020-04-30T06:28:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/621639288",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@ariard yup! thanks for flagging. already working on the patch & will post it here once its ready for review ",
      "created_at" : "2020-04-30T16:06:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-621949476",
      "id" : 621949476,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMTk0OTQ3Ng==",
      "updated_at" : "2020-04-30T16:06:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/621949476",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "initial attempt here: https://github.com/amitiuttarwar/bitcoin/commits/pr18044\r\n- rebased this branch on master, turned unbroadcast set into a map of txid -> wtxid, updated logic to play nice with changes to RelayTransaction. existing tests pass\r\n- can revisit and add tests as #18807 and #18446 make progress",
      "created_at" : "2020-05-01T22:37:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-622595865",
      "id" : 622595865,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMjU5NTg2NQ==",
      "updated_at" : "2020-05-01T22:37:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/622595865",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r440251893"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/440251893"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`TX` (by txid, don't send witness), `WTX_TXID` (by txid, do send witness), `WTX_WTXID` (by wtxid, do send witness)` might be clearer?",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-06-15T15:16:54Z",
      "diff_hunk" : "@@ -363,7 +369,8 @@ enum GetDataMsg\n     UNDEFINED = 0,\n     MSG_TX = 1,\n     MSG_BLOCK = 2,\n-    // The following can only occur in getdata. Invs always use TX or BLOCK.\n+    MSG_WTX = 5, // Defined in BIP XXX",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r440251893",
      "id" : 440251893,
      "in_reply_to_id" : 378574214,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI1MTg5Mw==",
      "original_commit_id" : "cf8c70fac6df96e23c37afe1c27eaa3925996caf",
      "original_line" : 372,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/protocol.h",
      "position" : null,
      "pull_request_review_id" : 430744865,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/440251893",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> initial attempt here: [amitiuttarwar/bitcoin@`pr18044` (commits)](https://github.com/amitiuttarwar/bitcoin/commits/pr18044)\r\n> \r\n> * rebased this branch on master, turned unbroadcast set into a map of txid -> wtxid, updated logic to play nice with changes to RelayTransaction. existing tests pass\r\n> * can revisit and add tests as #18807 and #18446 make progress\r\n\r\nWhich progress are you looking for in #18446?",
      "created_at" : "2020-06-19T10:44:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-646568265",
      "id" : 646568265,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0NjU2ODI2NQ==",
      "updated_at" : "2020-06-19T10:44:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/646568265",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@sdaftuar Sorry, I may be missing context but is this work blocked somehow? How can people help bring this closer to the finish line?",
      "created_at" : "2020-06-19T11:56:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-646595546",
      "id" : 646595546,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0NjU5NTU0Ng==",
      "updated_at" : "2020-06-19T11:56:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/646595546",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@fjahr Thanks for the reminder, I've gone ahead and rebased this.  There were quite a few merge conflicts, so I hope reviewers will try to review these changes from scratch!",
      "created_at" : "2020-06-19T19:08:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-646821659",
      "id" : 646821659,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0NjgyMTY1OQ==",
      "updated_at" : "2020-06-19T19:08:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/646821659",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm seeing a few post-rebase build warnings that weren't on 9eb584e1ffefdcbf7db0c3ca592f914c9ff46f68 (macOS clang v10):\r\n\r\n```\r\nvalidation.cpp:5102:49: warning: loop variable 'elem' has type 'const std::pair<uint256, uint256> &' but is initialized with type 'std::__1::__map_iterator<std::__1::__tree_iterator<std::__1::__value_type<uint256, uint256>, std::__1::__tree_node<std::__1::__value_type<uint256, uint256>, void *> *, long> >::value_type' (aka 'pair<const uint256, uint256>') resulting in a copy [-Wrange-loop-analysis]\r\n        for (const std::pair<uint256, uint256>& elem : unbroadcast_txids) {\r\n                                                ^\r\nvalidation.cpp:5102:14: note: use non-reference type 'std::pair<uint256, uint256>' to keep the copy or type 'const std::__1::__map_iterator<std::__1::__tree_iterator<std::__1::__value_type<uint256, uint256>, std::__1::__tree_node<std::__1::__value_type<uint256, uint256>, void *> *, long> >::value_type &' (aka 'const pair<const uint256, uint256> &') to prevent copying\r\n        for (const std::pair<uint256, uint256>& elem : unbroadcast_txids) {\r\n             ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n1 warning generated.\r\n```\r\n```\r\nnet_processing.cpp:835:45: warning: loop variable 'elem' has type 'const std::pair<uint256, uint256> &' but is initialized with type 'std::__1::__map_iterator<std::__1::__tree_iterator<std::__1::__value_type<uint256, uint256>, std::__1::__tree_node<std::__1::__value_type<uint256, uint256>, void *> *, long> >::value_type' (aka 'pair<const uint256, uint256>') resulting in a copy [-Wrange-loop-analysis]\r\n    for (const std::pair<uint256, uint256>& elem : unbroadcast_txids) {\r\n                                            ^\r\nnet_processing.cpp:835:10: note: use non-reference type 'std::pair<uint256, uint256>' to keep the copy or type 'const std::__1::__map_iterator<std::__1::__tree_iterator<std::__1::__value_type<uint256, uint256>, std::__1::__tree_node<std::__1::__value_type<uint256, uint256>, void *> *, long> >::value_type &' (aka 'const pair<const uint256, uint256> &') to prevent copying\r\n    for (const std::pair<uint256, uint256>& elem : unbroadcast_txids) {\r\n         ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\nnet_processing.cpp:838:13: warning: calling function 'RelayTransaction' requires holding mutex 'cs_main' exclusively [-Wthread-safety-analysis]\r\n            RelayTransaction(elem.first, elem.second, *connman);\r\n            ^\r\n2 warnings generated.\r\n```\r\nThese two were first seen on 9f2dfa674aa54315f5c51a37463974019d091eb2.\r\n```\r\nnode/transaction.cpp:85:9: warning: calling function 'RelayTransaction' requires holding mutex 'cs_main' exclusively [-Wthread-safety-analysis]\r\n        RelayTransaction(hashTx, tx->GetWitnessHash(), *node.connman);\r\n        ^\r\n1 warning generated.\r\n```\r\nThis one seems to be introduced in 40825853e.",
      "created_at" : "2020-06-20T01:39:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-646917516",
      "id" : 646917516,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0NjkxNzUxNg==",
      "updated_at" : "2020-06-20T16:13:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/646917516",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/755825?v=4",
         "events_url" : "https://api.github.com/users/adamjonas/events{/privacy}",
         "followers_url" : "https://api.github.com/users/adamjonas/followers",
         "following_url" : "https://api.github.com/users/adamjonas/following{/other_user}",
         "gists_url" : "https://api.github.com/users/adamjonas/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/adamjonas",
         "id" : 755825,
         "login" : "adamjonas",
         "node_id" : "MDQ6VXNlcjc1NTgyNQ==",
         "organizations_url" : "https://api.github.com/users/adamjonas/orgs",
         "received_events_url" : "https://api.github.com/users/adamjonas/received_events",
         "repos_url" : "https://api.github.com/users/adamjonas/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/adamjonas/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/adamjonas/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/adamjonas"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Code review ACK a7844da61d3f9eaca9d9d35337d463c64ac541a4, I think everything looks correct.\r\n\r\n- I confirm the build warnings [above](https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-646917516), would be nice to resolve them.\r\n- Also would be nice to address [these two issues](https://github.com/bitcoin/bitcoin/pull/18044#discussion_r392511089) regarding outdated comments.\r\n- The code should be updated with BIP number once that's merged (this PR has a couple \"BIP XXX\").",
      "created_at" : "2020-06-20T09:24:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-646968108",
      "id" : 646968108,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0Njk2ODEwOA==",
      "updated_at" : "2020-06-20T09:25:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/646968108",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r443154957"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443154957"
         }
      },
      "author_association" : "MEMBER",
      "body" : "from a quick look, seems like using `const` and reference declarator together on this `std::pair<uint256,uint256>` type is causing the build warnings. I don't yet understand why. \r\n\r\nleaving `&` but removing the `const` throws an error: \r\n```\r\nnet_processing.cpp:835:39: error: non-const lvalue reference to type 'pair<uint256, [...]>' cannot bind to a value of unrelated type 'pair<const uint256, [...]>'\r\n    for (std::pair<uint256, uint256>& elem : unbroadcast_txids) {\r\n```\r\n\r\nbut removing the reference declarator allows it to build with no errors / warnings. with or without the `const`. ",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-06-20T19:41:41Z",
      "diff_hunk" : "@@ -818,14 +830,14 @@ void PeerLogicValidation::InitializeNode(CNode *pnode) {\n \n void PeerLogicValidation::ReattemptInitialBroadcast(CScheduler& scheduler) const\n {\n-    std::set<uint256> unbroadcast_txids = m_mempool.GetUnbroadcastTxs();\n+    std::map<uint256, uint256> unbroadcast_txids = m_mempool.GetUnbroadcastTxs();\n \n-    for (const uint256& txid : unbroadcast_txids) {\n+    for (const std::pair<uint256, uint256>& elem : unbroadcast_txids) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r443154957",
      "id" : 443154957,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE1NDk1Nw==",
      "original_commit_id" : "a7844da61d3f9eaca9d9d35337d463c64ac541a4",
      "original_line" : 835,
      "original_position" : 73,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 434449561,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443154957",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r443156052"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443156052"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The reason is that the element type of `unbroadcast_txids` is `std::pair<const uint256, uint256>` which can't be converted to `std::pair<uint256, uint256>`. If you want a const reference to such a thing, it will be copied, and you'll get a reference to the copy.\r\n\r\nThe correct solution is either (`const`) `std::pair<const uint256, uint256>&`, or just `const auto&`.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-06-20T20:00:23Z",
      "diff_hunk" : "@@ -818,14 +830,14 @@ void PeerLogicValidation::InitializeNode(CNode *pnode) {\n \n void PeerLogicValidation::ReattemptInitialBroadcast(CScheduler& scheduler) const\n {\n-    std::set<uint256> unbroadcast_txids = m_mempool.GetUnbroadcastTxs();\n+    std::map<uint256, uint256> unbroadcast_txids = m_mempool.GetUnbroadcastTxs();\n \n-    for (const uint256& txid : unbroadcast_txids) {\n+    for (const std::pair<uint256, uint256>& elem : unbroadcast_txids) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r443156052",
      "id" : 443156052,
      "in_reply_to_id" : 443154957,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE1NjA1Mg==",
      "original_commit_id" : "a7844da61d3f9eaca9d9d35337d463c64ac541a4",
      "original_line" : 835,
      "original_position" : 73,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 434450480,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443156052",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r443392439"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443392439"
         }
      },
      "author_association" : "MEMBER",
      "body" : "As a follow-up, I think we may scope this under a connection type, like https://github.com/bitcoin/bitcoin/pull/19316.\r\n\r\nSide-note, @amitiuttarwar, I had only a super-quick overview on connection type, it's a great move but IMO I would adopt a more fine-grained typology. Right now it sounds to confuse type of _traffic_ (block, addr, tx) and type of connection _selection_ (outbound/inbound,  normal/anchor, ...)",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-06-22T08:21:39Z",
      "diff_hunk" : "@@ -399,6 +399,9 @@ struct CNodeState {\n     //! Whether this peer is a manual connection\n     bool m_is_manual_connection;\n \n+    //! Whether this peer relays txs via wtxid\n+    bool m_wtxid_relay{false};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r443392439",
      "id" : 443392439,
      "line" : 428,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM5MjQzOQ==",
      "original_commit_id" : "40825853e2be441ef2a52ecd330f1db08b939621",
      "original_line" : 428,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 48,
      "pull_request_review_id" : 434702778,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443392439",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r443401103"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443401103"
         }
      },
      "author_association" : "MEMBER",
      "body" : "AFAICT, if we have sighash_noinput+Eltoo channel design in the future, commitment transactions are going to be _symmetric_ but witness likely _asymmetric_ (one per-party). So you would observe wtxidA != wtxidB but txidA == txidB which means in case of concurrent broadcast by different parties you will spuriously re-download transactions and only gets one version in your mempool.\r\n\r\nAssuming such class of transactions traffic (multiple-parties, asymmetric witnesses, high-rate of concurrent broadcasts) get few digits of overall traffic it may be a serious bandwidth increase and may not be compatible with a wtxid-based tx-relay. Of course, as of today it's really hypothetical but you may find such pattern with vault protocols (multiple-parties, concurrent broadcast, asymmetric witnesses). ",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-06-22T08:36:15Z",
      "diff_hunk" : "@@ -2817,23 +2833,39 @@ void ProcessMessage(\n         const CTransaction& tx = *ptx;\n \n         const uint256& txid = ptx->GetHash();\n-        pfrom.AddInventoryKnown(txid);\n+        const uint256& wtxid = ptx->GetWitnessHash();\n \n         LOCK2(cs_main, g_cs_orphans);\n \n+        CNodeState* nodestate = State(pfrom.GetId());\n+\n+        const uint256& hash = nodestate->m_wtxid_relay ? wtxid : txid;\n+        pfrom.AddInventoryKnown(hash);\n+\n         TxValidationState state;\n \n-        CNodeState* nodestate = State(pfrom.GetId());\n-        nodestate->m_tx_download.m_tx_announced.erase(txid);\n-        nodestate->m_tx_download.m_tx_in_flight.erase(txid);\n-        EraseTxRequest(txid);\n+        nodestate->m_tx_download.m_tx_announced.erase(hash);\n+        nodestate->m_tx_download.m_tx_in_flight.erase(hash);\n+        EraseTxRequest(hash);\n \n         std::list<CTransactionRef> lRemovedTxn;\n \n-        if (!AlreadyHave(CInv(MSG_TX, txid), mempool) &&\n+        // We do the AlreadyHave() check using wtxid, rather than txid - in the\n+        // absence of witness malleation, this is strictly better, because the\n+        // recent rejects filter may contain the wtxid but will never contain\n+        // the txid of a segwit transaction that has been rejected.\n+        // In the presence of witness malleation, it's possible that by only\n+        // doing the check with wtxid, we could overlook a transaction which\n+        // was confirmed with a different witness, or exists in our mempool\n+        // with a different witness, but this has limited downside:\n+        // mempool validation does its own lookup of whether we have the txid\n+        // already; and an adversary can already relay us old transactions\n+        // (older than our recency filter) if trying to DoS us, without any need\n+        // for witness malleation.\n+        if (!AlreadyHave(CInv(MSG_WTX, wtxid), mempool) &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r443401103",
      "id" : 443401103,
      "line" : 2957,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQwMTEwMw==",
      "original_commit_id" : "40825853e2be441ef2a52ecd330f1db08b939621",
      "original_line" : 2957,
      "original_position" : 168,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 423,
      "pull_request_review_id" : 434702778,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443401103",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r443409934"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443409934"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The trade-off bandwidth saving against tx-relay propagation latency may not be only the one. Investigating around transaction pinning (https://lists.linuxfoundation.org/pipermail/bitcoin-dev/2020-April/017757.html), there is this idea that an attacker, by bypassing tx-relay delay timers will always win the propagation race and that way be first in _every_ miners full-node mempools and succeed the pin. I think against some malicious party willingly to override protocol rules at its advantage we can do nothing but I'm not yet confident on this.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-06-22T08:51:50Z",
      "diff_hunk" : "@@ -768,6 +773,9 @@ std::chrono::microseconds CalculateTxGetDataTime(const uint256& txid, std::chron\n     // We delay processing announcements from inbound peers\n     if (use_inbound_delay) process_time += INBOUND_PEER_TX_DELAY;\n \n+    // We delay processing announcements from peers that use txid-relay (instead of wtxid)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r443409934",
      "id" : 443409934,
      "line" : 797,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQwOTkzNA==",
      "original_commit_id" : "9f0f4809e516b7c2393b667cb039701684e1c7b6",
      "original_line" : 797,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 66,
      "pull_request_review_id" : 434702778,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443409934",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r443419034"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443419034"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think we should be really careful about including `TX_WITNESS_STRIPPED` to the rejection filter. \r\n\r\nIn LN, your channel counterparty knows your own version of the commitment transaction as it has to build it to sign it. It means a malicious counterparty would be able to broadcast a witness _stripped_ version of it at any moment and that way get it added to the rejection filters of any p2p peers. If the full-node used by your LN-node is _non-upgraded_ it will announce broadcast of a witness transaction (the local commitment) and it won't be fetched by the lured peers thus effectively censoring your time-sensitive transactions.\r\n\r\nIs this understanding of wtxid tx-relay correct ? I don't think it changes anything that your topology is well-established with wtxid-relay peers, the issue is you not being upgraded and subject to intentional reject filters collisions.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-06-22T09:07:12Z",
      "diff_hunk" : "@@ -2954,10 +2961,16 @@ void ProcessMessage(\n                 recentRejects->insert(tx.GetWitnessHash());\n             }\n         } else {\n-            if (tx.HasWitness() || state.GetResult() != TxValidationResult::TX_WITNESS_MUTATED) {\n-                // Do not use rejection cache for witness transactions or\n-                // witness-stripped transactions, as they can have been malleated.\n-                // See https://github.com/bitcoin/bitcoin/issues/8279 for details.\n+            if (state.GetResult() != TxValidationResult::TX_WITNESS_STRIPPED) {\n+                // Do not add txids of witness transactions or witness-stripped\n+                // transactions to the filter, as they can have been malleated;\n+                // adding such txids to the reject filter would potentially\n+                // interfere with relay of valid transactions from peers that\n+                // do not support wtxid-based relay. See\n+                // https://github.com/bitcoin/bitcoin/issues/8279 for details.\n+                // We can remove this restriction (and always add wtxids to\n+                // the filter even for witness stripped transactions) once\n+                // wtxid-based relay is broadly deployed.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r443419034",
      "id" : 443419034,
      "line" : 3035,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQxOTAzNA==",
      "original_commit_id" : "247d67486a7ca8843579218f4397cdd790a67b07",
      "original_line" : 3035,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 482,
      "pull_request_review_id" : 434702778,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443419034",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r443443661"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443443661"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "\"spuriously re-download transactions and only gets one version in your mempool\" already happens with RBF; I don't think this is meaningfully different?\r\n\r\n(If you're just varying the witness you don't need SIGHASH_NOINPUT, though, so I think there's a good chance the txid would be different too for eltoo transactions if that comes into play)",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-06-22T09:50:32Z",
      "diff_hunk" : "@@ -2817,23 +2833,39 @@ void ProcessMessage(\n         const CTransaction& tx = *ptx;\n \n         const uint256& txid = ptx->GetHash();\n-        pfrom.AddInventoryKnown(txid);\n+        const uint256& wtxid = ptx->GetWitnessHash();\n \n         LOCK2(cs_main, g_cs_orphans);\n \n+        CNodeState* nodestate = State(pfrom.GetId());\n+\n+        const uint256& hash = nodestate->m_wtxid_relay ? wtxid : txid;\n+        pfrom.AddInventoryKnown(hash);\n+\n         TxValidationState state;\n \n-        CNodeState* nodestate = State(pfrom.GetId());\n-        nodestate->m_tx_download.m_tx_announced.erase(txid);\n-        nodestate->m_tx_download.m_tx_in_flight.erase(txid);\n-        EraseTxRequest(txid);\n+        nodestate->m_tx_download.m_tx_announced.erase(hash);\n+        nodestate->m_tx_download.m_tx_in_flight.erase(hash);\n+        EraseTxRequest(hash);\n \n         std::list<CTransactionRef> lRemovedTxn;\n \n-        if (!AlreadyHave(CInv(MSG_TX, txid), mempool) &&\n+        // We do the AlreadyHave() check using wtxid, rather than txid - in the\n+        // absence of witness malleation, this is strictly better, because the\n+        // recent rejects filter may contain the wtxid but will never contain\n+        // the txid of a segwit transaction that has been rejected.\n+        // In the presence of witness malleation, it's possible that by only\n+        // doing the check with wtxid, we could overlook a transaction which\n+        // was confirmed with a different witness, or exists in our mempool\n+        // with a different witness, but this has limited downside:\n+        // mempool validation does its own lookup of whether we have the txid\n+        // already; and an adversary can already relay us old transactions\n+        // (older than our recency filter) if trying to DoS us, without any need\n+        // for witness malleation.\n+        if (!AlreadyHave(CInv(MSG_WTX, wtxid), mempool) &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r443443661",
      "id" : 443443661,
      "in_reply_to_id" : 443401103,
      "line" : 2957,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ0MzY2MQ==",
      "original_commit_id" : "40825853e2be441ef2a52ecd330f1db08b939621",
      "original_line" : 2957,
      "original_position" : 168,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 423,
      "pull_request_review_id" : 434770396,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443443661",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r443446534"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443446534"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Looks like this means `cs_main` needs to be locked in `ReattemptInintialBroadcast()` (net_processing) and `BroadcastTransaction()` (node/transaction.cpp)",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-06-22T09:55:28Z",
      "diff_hunk" : "@@ -97,6 +97,6 @@ struct CNodeStateStats {\n bool GetNodeStateStats(NodeId nodeid, CNodeStateStats &stats);\n \n /** Relay transaction to every node */\n-void RelayTransaction(const uint256&, const CConnman& connman);\n+void RelayTransaction(const uint256& txid, const uint256& wtxid, const CConnman& connman) EXCLUSIVE_LOCKS_REQUIRED(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r443446534",
      "id" : 443446534,
      "line" : 103,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ0NjUzNA==",
      "original_commit_id" : "40825853e2be441ef2a52ecd330f1db08b939621",
      "original_line" : 103,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : 5,
      "pull_request_review_id" : 434774091,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443446534",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r443619023"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443619023"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed with `const auto&`.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-06-22T14:53:36Z",
      "diff_hunk" : "@@ -818,14 +830,14 @@ void PeerLogicValidation::InitializeNode(CNode *pnode) {\n \n void PeerLogicValidation::ReattemptInitialBroadcast(CScheduler& scheduler) const\n {\n-    std::set<uint256> unbroadcast_txids = m_mempool.GetUnbroadcastTxs();\n+    std::map<uint256, uint256> unbroadcast_txids = m_mempool.GetUnbroadcastTxs();\n \n-    for (const uint256& txid : unbroadcast_txids) {\n+    for (const std::pair<uint256, uint256>& elem : unbroadcast_txids) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r443619023",
      "id" : 443619023,
      "in_reply_to_id" : 443154957,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYxOTAyMw==",
      "original_commit_id" : "a7844da61d3f9eaca9d9d35337d463c64ac541a4",
      "original_line" : 835,
      "original_position" : 73,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 435003769,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443619023",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r443627585"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443627585"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks for catching those, fixed.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-06-22T15:05:17Z",
      "diff_hunk" : "@@ -97,6 +97,6 @@ struct CNodeStateStats {\n bool GetNodeStateStats(NodeId nodeid, CNodeStateStats &stats);\n \n /** Relay transaction to every node */\n-void RelayTransaction(const uint256&, const CConnman& connman);\n+void RelayTransaction(const uint256& txid, const uint256& wtxid, const CConnman& connman) EXCLUSIVE_LOCKS_REQUIRED(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r443627585",
      "id" : 443627585,
      "in_reply_to_id" : 443446534,
      "line" : 103,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYyNzU4NQ==",
      "original_commit_id" : "40825853e2be441ef2a52ecd330f1db08b939621",
      "original_line" : 103,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : 5,
      "pull_request_review_id" : 435015412,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443627585",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r443631940"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443631940"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can you explain what you think needs to change in the code here?  \r\n\r\nI think the documentation is trying to explain a necessary (but not sufficient) condition for changing the code at some unspecified point in the future.  If you want to argue that we should never change this code because other ecosystem software might break, then that's something worthy of discussion, but I don't know that we need to have that discussion in this PR, given that we're not proposing actually doing that now (nor even proposing a timeline for it).",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-06-22T15:11:28Z",
      "diff_hunk" : "@@ -2954,10 +2961,16 @@ void ProcessMessage(\n                 recentRejects->insert(tx.GetWitnessHash());\n             }\n         } else {\n-            if (tx.HasWitness() || state.GetResult() != TxValidationResult::TX_WITNESS_MUTATED) {\n-                // Do not use rejection cache for witness transactions or\n-                // witness-stripped transactions, as they can have been malleated.\n-                // See https://github.com/bitcoin/bitcoin/issues/8279 for details.\n+            if (state.GetResult() != TxValidationResult::TX_WITNESS_STRIPPED) {\n+                // Do not add txids of witness transactions or witness-stripped\n+                // transactions to the filter, as they can have been malleated;\n+                // adding such txids to the reject filter would potentially\n+                // interfere with relay of valid transactions from peers that\n+                // do not support wtxid-based relay. See\n+                // https://github.com/bitcoin/bitcoin/issues/8279 for details.\n+                // We can remove this restriction (and always add wtxids to\n+                // the filter even for witness stripped transactions) once\n+                // wtxid-based relay is broadly deployed.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r443631940",
      "id" : 443631940,
      "in_reply_to_id" : 443419034,
      "line" : 3035,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYzMTk0MA==",
      "original_commit_id" : "247d67486a7ca8843579218f4397cdd790a67b07",
      "original_line" : 3035,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 482,
      "pull_request_review_id" : 435021489,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443631940",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r443635047"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443635047"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't understand the comment here -- are you saying wtxid-relay is somehow incompatible with a future change to the protocol?  It seems to me that (a) wtxid-relay is more likely to support the ability to relay transactions with same underlying txid but different wtxid than our existing relay protocol, and (b) whether we adopt changes to the mempool acceptance rules to allow for this is otherwise orthogonal to this PR.  \r\n\r\nIf you're asking for a change here, can you indicate what that is?",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-06-22T15:16:05Z",
      "diff_hunk" : "@@ -2817,23 +2833,39 @@ void ProcessMessage(\n         const CTransaction& tx = *ptx;\n \n         const uint256& txid = ptx->GetHash();\n-        pfrom.AddInventoryKnown(txid);\n+        const uint256& wtxid = ptx->GetWitnessHash();\n \n         LOCK2(cs_main, g_cs_orphans);\n \n+        CNodeState* nodestate = State(pfrom.GetId());\n+\n+        const uint256& hash = nodestate->m_wtxid_relay ? wtxid : txid;\n+        pfrom.AddInventoryKnown(hash);\n+\n         TxValidationState state;\n \n-        CNodeState* nodestate = State(pfrom.GetId());\n-        nodestate->m_tx_download.m_tx_announced.erase(txid);\n-        nodestate->m_tx_download.m_tx_in_flight.erase(txid);\n-        EraseTxRequest(txid);\n+        nodestate->m_tx_download.m_tx_announced.erase(hash);\n+        nodestate->m_tx_download.m_tx_in_flight.erase(hash);\n+        EraseTxRequest(hash);\n \n         std::list<CTransactionRef> lRemovedTxn;\n \n-        if (!AlreadyHave(CInv(MSG_TX, txid), mempool) &&\n+        // We do the AlreadyHave() check using wtxid, rather than txid - in the\n+        // absence of witness malleation, this is strictly better, because the\n+        // recent rejects filter may contain the wtxid but will never contain\n+        // the txid of a segwit transaction that has been rejected.\n+        // In the presence of witness malleation, it's possible that by only\n+        // doing the check with wtxid, we could overlook a transaction which\n+        // was confirmed with a different witness, or exists in our mempool\n+        // with a different witness, but this has limited downside:\n+        // mempool validation does its own lookup of whether we have the txid\n+        // already; and an adversary can already relay us old transactions\n+        // (older than our recency filter) if trying to DoS us, without any need\n+        // for witness malleation.\n+        if (!AlreadyHave(CInv(MSG_WTX, wtxid), mempool) &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r443635047",
      "id" : 443635047,
      "in_reply_to_id" : 443401103,
      "line" : 2957,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYzNTA0Nw==",
      "original_commit_id" : "40825853e2be441ef2a52ecd330f1db08b939621",
      "original_line" : 2957,
      "original_position" : 168,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 423,
      "pull_request_review_id" : 435025740,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443635047",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks all for flagging the build warnings and the missing `LOCK(cs_main)` calls (at least 1 was lost inadvertently in the rebase).  Those should all be fixed now.\r\n\r\n@naumenkogs With regards to the outdated comments you referenced, I believe those were already addressed -- is there something else you wanted to see?\r\n\r\n@ariard \r\n\r\n> bandwidth measure to assess 9f0f480 worthiness\r\n\r\nFYI -- I did some testing with an older version of this PR, with one node connected to another using this patch (both running locally on the same machine), and each was also connected out to the network.  I was measuring how many times I downloaded the same transaction twice, and the number I saw over the last few months is about 0.5%.  My setup of having two nodes on the same (fast) machine is certainly not representative, so I would encourage others to do their own tests of this.\r\n\r\n> * publishing to the mailing list the BIP\r\n\r\nThe BIP was already posted to the mailing list in February (https://lists.linuxfoundation.org/pipermail/bitcoin-dev/2020-February/017648.html).  I suppose I should get a BIP number...\r\n\r\n> * addressing naming : [#18044 (comment)](https://github.com/bitcoin/bitcoin/pull/18044#discussion_r378574214) (it has been judged confusing by at least few people)\r\n\r\nThere doesn't seem to be any clear agreement on what better names would look like, so I'd be inclined to let someone try to address this as a follow-up PR, if the enum I introduced really bothers anyone.\r\n\r\n> * testing coverage : #18446\r\n\r\nI'll try to cherry-pick those testing commits later today.\r\n\r\n> * integrating mempool initial-broadcast reattempt wtxid-support : https://github.com/amitiuttarwar/bitcoin/commits/pr18044 ?\r\n\r\nCan you explain what is missing here?",
      "created_at" : "2020-06-22T15:28:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-647592408",
      "id" : 647592408,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0NzU5MjQwOA==",
      "updated_at" : "2020-06-22T18:42:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/647592408",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r443660713"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443660713"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Believe the same use of `const auto&` is needed here as used in [net_processing](https://github.com/bitcoin/bitcoin/pull/18044/commits/d5d55edb1f295711574190bf310f88171451b5cf#diff-eff7adeaec73a769788bb78858815c91R823).\r\n```suggestion\r\n        for (const auto& elem : unbroadcast_txids) {\r\n```",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-06-22T15:53:42Z",
      "diff_hunk" : "@@ -5091,19 +5091,22 @@ bool LoadMempool(CTxMemPool& pool)\n         }\n \n         // TODO: remove this try except in v0.22\n+        std::map<uint256, uint256> unbroadcast_txids;\n         try {\n-          std::set<uint256> unbroadcast_txids;\n           file >> unbroadcast_txids;\n           unbroadcast = unbroadcast_txids.size();\n-\n-          for (const auto& txid : unbroadcast_txids) {\n-            pool.AddUnbroadcastTx(txid);\n-          }\n         } catch (const std::exception&) {\n           // mempool.dat files created prior to v0.21 will not have an\n           // unbroadcast set. No need to log a failure if parsing fails here.\n         }\n-\n+        for (const std::pair<uint256, uint256>& elem : unbroadcast_txids) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r443660713",
      "id" : 443660713,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY2MDcxMw==",
      "original_commit_id" : "d5d55edb1f295711574190bf310f88171451b5cf",
      "original_line" : 5102,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 435059563,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443660713",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/755825?v=4",
         "events_url" : "https://api.github.com/users/adamjonas/events{/privacy}",
         "followers_url" : "https://api.github.com/users/adamjonas/followers",
         "following_url" : "https://api.github.com/users/adamjonas/following{/other_user}",
         "gists_url" : "https://api.github.com/users/adamjonas/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/adamjonas",
         "id" : 755825,
         "login" : "adamjonas",
         "node_id" : "MDQ6VXNlcjc1NTgyNQ==",
         "organizations_url" : "https://api.github.com/users/adamjonas/orgs",
         "received_events_url" : "https://api.github.com/users/adamjonas/received_events",
         "repos_url" : "https://api.github.com/users/adamjonas/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/adamjonas/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/adamjonas/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/adamjonas"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r443685918"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443685918"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Doh, thanks! Fixed.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-06-22T16:33:17Z",
      "diff_hunk" : "@@ -5091,19 +5091,22 @@ bool LoadMempool(CTxMemPool& pool)\n         }\n \n         // TODO: remove this try except in v0.22\n+        std::map<uint256, uint256> unbroadcast_txids;\n         try {\n-          std::set<uint256> unbroadcast_txids;\n           file >> unbroadcast_txids;\n           unbroadcast = unbroadcast_txids.size();\n-\n-          for (const auto& txid : unbroadcast_txids) {\n-            pool.AddUnbroadcastTx(txid);\n-          }\n         } catch (const std::exception&) {\n           // mempool.dat files created prior to v0.21 will not have an\n           // unbroadcast set. No need to log a failure if parsing fails here.\n         }\n-\n+        for (const std::pair<uint256, uint256>& elem : unbroadcast_txids) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r443685918",
      "id" : 443685918,
      "in_reply_to_id" : 443660713,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY4NTkxOA==",
      "original_commit_id" : "d5d55edb1f295711574190bf310f88171451b5cf",
      "original_line" : 5102,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 435092567,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443685918",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r443775360"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443775360"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> \"spuriously re-download transactions and only gets one version in your mempool\" already happens with RBF; I don't think this is meaningfully different?\r\n\r\nI think you're right we do already have this kind of case due to single-party RBF. After thoughts, qualifying them of _spurious_ was a fallacy as a smaller valid witness may increase transaction feerate and such increase its probabilities of propagating and confirming. So we _have to_ download them anyway.\r\n\r\n(I agree SIGHASH_NOINPUT doesn't force you to vary witness, it's more likely we would do it, fyi another [generalized channel](https://eprint.iacr.org/2020/476.pdf) proposal leveraging per-party adaptor sigs to get symmetric states)\r\n\r\nI'm not advocating on any change here, I was more brooding on the fact that fancier on-top-of-Bitcoin protocols and automatic dynamic-fee bumping as currently gauged by LN implementations will have for side-effect to increase bandwidth demand in case of mempool congestion.\r\n\r\n> and (b) whether we adopt changes to the mempool acceptance rules to allow for this is otherwise orthogonal to this PR.\r\n\r\nYes, I was wrong that's orthogonal to tx-relay, it's more being sure that these potential bandwidth demand surges are priced \"correctly\" with regards to BIP 125 rule 4. Not a discussion to have in this PR.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-06-22T19:22:37Z",
      "diff_hunk" : "@@ -2817,23 +2833,39 @@ void ProcessMessage(\n         const CTransaction& tx = *ptx;\n \n         const uint256& txid = ptx->GetHash();\n-        pfrom.AddInventoryKnown(txid);\n+        const uint256& wtxid = ptx->GetWitnessHash();\n \n         LOCK2(cs_main, g_cs_orphans);\n \n+        CNodeState* nodestate = State(pfrom.GetId());\n+\n+        const uint256& hash = nodestate->m_wtxid_relay ? wtxid : txid;\n+        pfrom.AddInventoryKnown(hash);\n+\n         TxValidationState state;\n \n-        CNodeState* nodestate = State(pfrom.GetId());\n-        nodestate->m_tx_download.m_tx_announced.erase(txid);\n-        nodestate->m_tx_download.m_tx_in_flight.erase(txid);\n-        EraseTxRequest(txid);\n+        nodestate->m_tx_download.m_tx_announced.erase(hash);\n+        nodestate->m_tx_download.m_tx_in_flight.erase(hash);\n+        EraseTxRequest(hash);\n \n         std::list<CTransactionRef> lRemovedTxn;\n \n-        if (!AlreadyHave(CInv(MSG_TX, txid), mempool) &&\n+        // We do the AlreadyHave() check using wtxid, rather than txid - in the\n+        // absence of witness malleation, this is strictly better, because the\n+        // recent rejects filter may contain the wtxid but will never contain\n+        // the txid of a segwit transaction that has been rejected.\n+        // In the presence of witness malleation, it's possible that by only\n+        // doing the check with wtxid, we could overlook a transaction which\n+        // was confirmed with a different witness, or exists in our mempool\n+        // with a different witness, but this has limited downside:\n+        // mempool validation does its own lookup of whether we have the txid\n+        // already; and an adversary can already relay us old transactions\n+        // (older than our recency filter) if trying to DoS us, without any need\n+        // for witness malleation.\n+        if (!AlreadyHave(CInv(MSG_WTX, wtxid), mempool) &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r443775360",
      "id" : 443775360,
      "in_reply_to_id" : 443401103,
      "line" : 2957,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc3NTM2MA==",
      "original_commit_id" : "40825853e2be441ef2a52ecd330f1db08b939621",
      "original_line" : 2957,
      "original_position" : 168,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 423,
      "pull_request_review_id" : 435208453,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443775360",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r443786487"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443786487"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can you reference this comment/issue directly around the code ?\r\n\r\nI think that's a bit different than Matt's previous comment [here](https://github.com/bitcoin/bitcoin/pull/18044#discussion_r378586654) where we only considered censorship of a wtixd-relay _requester_, which should be fine if you have at least 1 honest wtxid-relay peer as you pointed.\r\n\r\nThe scenario I'm describing is I think different, it's censorship of an non-upgraded wtxid-relay initial _sender_ being only connected to reject-witness-stripped wtxid-relay peers. This sender announcing through txid only won't have its transaction fetched and propagated due to an already existent collision in the rejection filter. Such topology configuration sounds realistic for private nodes.\r\n\r\nI don't want to argue that we should never change this but when we do it we give a clear warning and time buffer to the rest of the ecosystem to be sure they upgrade. Because by switching p2p policy rules you would effectively introduce a critical vulnerability for any higher-layer software pending on a non-upgraded full-node. LN security model fundamentally reverse the double-spend problem to a private matter, it's the duty of your _individual_ LN-node and full-node to ensure that your transactions propagate well and confirm quickly. \r\n\r\nAnd I don't think we have guidelines for this today, it sounds more like an illustration of the lack of a set of design docs for a) how we implement BIPs b) what assumptions ecosystem software can do on stability of such implemented rules that you're describing [here](https://github.com/bitcoin/bitcoin/pull/18044#discussion_r400958023).",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-06-22T19:46:25Z",
      "diff_hunk" : "@@ -2954,10 +2961,16 @@ void ProcessMessage(\n                 recentRejects->insert(tx.GetWitnessHash());\n             }\n         } else {\n-            if (tx.HasWitness() || state.GetResult() != TxValidationResult::TX_WITNESS_MUTATED) {\n-                // Do not use rejection cache for witness transactions or\n-                // witness-stripped transactions, as they can have been malleated.\n-                // See https://github.com/bitcoin/bitcoin/issues/8279 for details.\n+            if (state.GetResult() != TxValidationResult::TX_WITNESS_STRIPPED) {\n+                // Do not add txids of witness transactions or witness-stripped\n+                // transactions to the filter, as they can have been malleated;\n+                // adding such txids to the reject filter would potentially\n+                // interfere with relay of valid transactions from peers that\n+                // do not support wtxid-based relay. See\n+                // https://github.com/bitcoin/bitcoin/issues/8279 for details.\n+                // We can remove this restriction (and always add wtxids to\n+                // the filter even for witness stripped transactions) once\n+                // wtxid-based relay is broadly deployed.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r443786487",
      "id" : 443786487,
      "in_reply_to_id" : 443419034,
      "line" : 3035,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc4NjQ4Nw==",
      "original_commit_id" : "247d67486a7ca8843579218f4397cdd790a67b07",
      "original_line" : 3035,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 482,
      "pull_request_review_id" : 435222866,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443786487",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> The BIP was already posted to the mailing list in February (https://lists.linuxfoundation.org/pipermail/bitcoin-dev/2020-February/017648.html). I suppose I should get a BIP number...\r\n\r\nRight, I forgot about that. Reading about the mail again it doesn't mention the issue with wtixd-relay which may have to GETDATA(INV(MSG_TX) in case of `TX_MISSING_INPUTS` but as we agree to drop this behavior for wtixd-relay (note: not done as of tip commit da72e51 ?) I think BIP doesn't have to change. Maybe a release note if the really-unlikely-case some application was relying on it ? Is BIP number attribution considered as needed before merging this ?\r\n\r\n> Can you explain what is missing here?\r\n\r\nAFAICT, it sounds to be exhaustive with mempool initial-rebroadcast support, just wasn't pick up on main branch.\r\n\r\nI think it's just pending on removal of orphan parents fetching through txid announcement before another round of Code Review ?",
      "created_at" : "2020-06-22T21:59:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-647790378",
      "id" : 647790378,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0Nzc5MDM3OA==",
      "updated_at" : "2020-06-22T21:59:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/647790378",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Reading about the mail again it doesn't mention the issue with wtixd-relay which may have to GETDATA(INV(MSG_TX) in case of TX_MISSING_INPUTS but as we agree to drop this behavior for wtixd-relay (note: not done as of tip commit da72e51 ?)\r\n\r\nThis should have already been fixed here: https://github.com/bitcoin/bitcoin/pull/18044/commits/af8e570be4a059d254492b304f60bb0039052094#diff-eff7adeaec73a769788bb78858815c91R2902",
      "created_at" : "2020-06-23T11:54:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-648097491",
      "id" : 648097491,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0ODA5NzQ5MQ==",
      "updated_at" : "2020-06-23T11:54:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/648097491",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r444170959"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/444170959"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Do you mean just add a link to your github comment, or something else?  \r\n\r\nHere's the current comment, which I think captures the issue you're describing (as far as I understand, what you're talking about is fundamentally the same as the issue we flagged years ago when we first deployed segwit, see #8279):\r\n```\r\n                // Do not add txids of witness transactions or witness-stripped\r\n                // transactions to the filter, as they can have been malleated;\r\n                // adding such txids to the reject filter would potentially\r\n                // interfere with relay of valid transactions from peers that\r\n                // do not support wtxid-based relay. See\r\n                // https://github.com/bitcoin/bitcoin/issues/8279 for details.\r\n                // We can remove this restriction (and always add wtxids to\r\n                // the filter even for witness stripped transactions) once\r\n                // wtxid-based relay is broadly deployed.\r\n\r\n```\r\n\r\nBut if there's specific different language or a link you'd like to see in here, please just provide alternate text.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-06-23T12:04:13Z",
      "diff_hunk" : "@@ -2954,10 +2961,16 @@ void ProcessMessage(\n                 recentRejects->insert(tx.GetWitnessHash());\n             }\n         } else {\n-            if (tx.HasWitness() || state.GetResult() != TxValidationResult::TX_WITNESS_MUTATED) {\n-                // Do not use rejection cache for witness transactions or\n-                // witness-stripped transactions, as they can have been malleated.\n-                // See https://github.com/bitcoin/bitcoin/issues/8279 for details.\n+            if (state.GetResult() != TxValidationResult::TX_WITNESS_STRIPPED) {\n+                // Do not add txids of witness transactions or witness-stripped\n+                // transactions to the filter, as they can have been malleated;\n+                // adding such txids to the reject filter would potentially\n+                // interfere with relay of valid transactions from peers that\n+                // do not support wtxid-based relay. See\n+                // https://github.com/bitcoin/bitcoin/issues/8279 for details.\n+                // We can remove this restriction (and always add wtxids to\n+                // the filter even for witness stripped transactions) once\n+                // wtxid-based relay is broadly deployed.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r444170959",
      "id" : 444170959,
      "in_reply_to_id" : 443419034,
      "line" : 3035,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDE3MDk1OQ==",
      "original_commit_id" : "247d67486a7ca8843579218f4397cdd790a67b07",
      "original_line" : 3035,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 482,
      "pull_request_review_id" : 435712513,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/444170959",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r444173164"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/444173164"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Marking this as resolved -- nothing more to do here as far as I understand.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-06-23T12:08:34Z",
      "diff_hunk" : "@@ -399,6 +399,9 @@ struct CNodeState {\n     //! Whether this peer is a manual connection\n     bool m_is_manual_connection;\n \n+    //! Whether this peer relays txs via wtxid\n+    bool m_wtxid_relay{false};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r444173164",
      "id" : 444173164,
      "in_reply_to_id" : 443392439,
      "line" : 428,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDE3MzE2NA==",
      "original_commit_id" : "40825853e2be441ef2a52ecd330f1db08b939621",
      "original_line" : 428,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 48,
      "pull_request_review_id" : 435715431,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/444173164",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r444173382"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/444173382"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Marking this as resolved, as nothing more to do here as far as I understand.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-06-23T12:09:01Z",
      "diff_hunk" : "@@ -768,6 +773,9 @@ std::chrono::microseconds CalculateTxGetDataTime(const uint256& txid, std::chron\n     // We delay processing announcements from inbound peers\n     if (use_inbound_delay) process_time += INBOUND_PEER_TX_DELAY;\n \n+    // We delay processing announcements from peers that use txid-relay (instead of wtxid)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r444173382",
      "id" : 444173382,
      "in_reply_to_id" : 443409934,
      "line" : 797,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDE3MzM4Mg==",
      "original_commit_id" : "9f0f4809e516b7c2393b667cb039701684e1c7b6",
      "original_line" : 797,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 66,
      "pull_request_review_id" : 435715747,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/444173382",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r445154911"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/445154911"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@ariard lets continue the conversation here: https://github.com/bitcoin/bitcoin/pull/19316#issuecomment-649054328",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-06-24T20:33:05Z",
      "diff_hunk" : "@@ -399,6 +399,9 @@ struct CNodeState {\n     //! Whether this peer is a manual connection\n     bool m_is_manual_connection;\n \n+    //! Whether this peer relays txs via wtxid\n+    bool m_wtxid_relay{false};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r445154911",
      "id" : 445154911,
      "in_reply_to_id" : 443392439,
      "line" : 428,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE1NDkxMQ==",
      "original_commit_id" : "40825853e2be441ef2a52ecd330f1db08b939621",
      "original_line" : 428,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 48,
      "pull_request_review_id" : 436985378,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/445154911",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r446459839"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/446459839"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think you may have a slight InvBlock until wtxid-relay is double-digit deployed, a wtxid-relay-signaling inbound peer can announce a MSG_TX and thus being processed with same time priority than txid-relay outbound peers. By holding the TX and assume your victim only have txid-relay peers you block transaction propagation \r\n\r\nMaybe `CalculateTxGetDataTime` should use the inv type instead of peer signaling to apply the delay ?",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-06-27T00:24:18Z",
      "diff_hunk" : "@@ -4440,7 +4452,15 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n                     // up processing to happen after the download times out\n                     // (with a slight delay for inbound peers, to prefer\n                     // requests to outbound peers).\n-                    const auto next_process_time = CalculateTxGetDataTime(txid, current_time, !state.fPreferredDownload);\n+                    // Don't apply the txid-delay to re-requests of a\n+                    // transaction; the heuristic of delaying requests to\n+                    // txid-relay peers is to save bandwidth on initial\n+                    // announcement of a transaction, and doesn't make sense\n+                    // for a followup request if our first peer times out (and\n+                    // would open us up to an attacker using inbound\n+                    // wtxid-relay to prevent us from requesting transactions\n+                    // from outbound txid-relay peers).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r446459839",
      "id" : 446459839,
      "line" : 4552,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ1OTgzOQ==",
      "original_commit_id" : "bc565ee3bd8232ec79540061d548488fa0681c68",
      "original_line" : 4552,
      "original_position" : 84,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 628,
      "pull_request_review_id" : 438652214,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/446459839",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r446462569"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/446462569"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Right the scenario I'm describing is leveraging the same original issue from #8279, just concerning censorship of a non-upgraded initial sender.\r\n\r\n```\r\n               // Note, any on-top-of-base-layer software (eg LN-node) relying on a non-upgraded to wtxid-relay full-node \r\n              //  would be subject to censor of its time-sensitive transactions. See https://github.com/bitcoin/bitcoin/pull/18044#discussion_r443419034\r\n             //  Removing this restriction should be done considering ecosystem coordination.\r\n```\r\n\r\nI think \"broadly\" is to dim, ideally you want 99% of upgrade among LN-node's full-nodes.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-06-27T00:43:27Z",
      "diff_hunk" : "@@ -2954,10 +2961,16 @@ void ProcessMessage(\n                 recentRejects->insert(tx.GetWitnessHash());\n             }\n         } else {\n-            if (tx.HasWitness() || state.GetResult() != TxValidationResult::TX_WITNESS_MUTATED) {\n-                // Do not use rejection cache for witness transactions or\n-                // witness-stripped transactions, as they can have been malleated.\n-                // See https://github.com/bitcoin/bitcoin/issues/8279 for details.\n+            if (state.GetResult() != TxValidationResult::TX_WITNESS_STRIPPED) {\n+                // Do not add txids of witness transactions or witness-stripped\n+                // transactions to the filter, as they can have been malleated;\n+                // adding such txids to the reject filter would potentially\n+                // interfere with relay of valid transactions from peers that\n+                // do not support wtxid-based relay. See\n+                // https://github.com/bitcoin/bitcoin/issues/8279 for details.\n+                // We can remove this restriction (and always add wtxids to\n+                // the filter even for witness stripped transactions) once\n+                // wtxid-based relay is broadly deployed.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r446462569",
      "id" : 446462569,
      "in_reply_to_id" : 443419034,
      "line" : 3035,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ2MjU2OQ==",
      "original_commit_id" : "247d67486a7ca8843579218f4397cdd790a67b07",
      "original_line" : 3035,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 482,
      "pull_request_review_id" : 438656572,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/446462569",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r446572355"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/446572355"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I will update the comment to incorporate your suggestion somewhat, including providing a link to the comments as you request, but I have a philosophical difference of opinion about the implications here of ecosystem software that is dependent on particular p2p behavior (specifically with regard to your \"ideally you want 99% of upgrade among LN-node's full nodes\" comment).\r\n\r\nWe have anti-CPU DoS reasons for wanting to get rid of the code that tries to determine whether a transaction is witness stripped (as well as generally simplifying the code that handles transactions that fail mempool acceptance).  Requiring that ecosystem software eventually update -- which can be as simple as putting txid-relay nodes behind wtxid-relay border nodes -- in order to be protected against an esoteric attack, with many years of notice, seems completely reasonable to me.\r\n\r\nIn particular, if we see that the vast majority of full nodes upgrade to wtxid-relay support over the next few years, but a handful of stubborn lightning implementations have not, I think at some point we could say, too bad, find your own workaround for transaction relay if you're worried about this kind of attack.  For these kinds of non-consensus security issues, I think it's reasonable for this project to provide software and solutions (including documenting our behavior and communicating that to our users) and expect that people worried about those kinds of problems will take care of it themselves.  At some point it should be okay for us to have shipped solutions and given people plenty of time to upgrade, and it's not our responsibility if there are people who have chosen not to follow our advice.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-06-27T22:09:05Z",
      "diff_hunk" : "@@ -2954,10 +2961,16 @@ void ProcessMessage(\n                 recentRejects->insert(tx.GetWitnessHash());\n             }\n         } else {\n-            if (tx.HasWitness() || state.GetResult() != TxValidationResult::TX_WITNESS_MUTATED) {\n-                // Do not use rejection cache for witness transactions or\n-                // witness-stripped transactions, as they can have been malleated.\n-                // See https://github.com/bitcoin/bitcoin/issues/8279 for details.\n+            if (state.GetResult() != TxValidationResult::TX_WITNESS_STRIPPED) {\n+                // Do not add txids of witness transactions or witness-stripped\n+                // transactions to the filter, as they can have been malleated;\n+                // adding such txids to the reject filter would potentially\n+                // interfere with relay of valid transactions from peers that\n+                // do not support wtxid-based relay. See\n+                // https://github.com/bitcoin/bitcoin/issues/8279 for details.\n+                // We can remove this restriction (and always add wtxids to\n+                // the filter even for witness stripped transactions) once\n+                // wtxid-based relay is broadly deployed.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r446572355",
      "id" : 446572355,
      "in_reply_to_id" : 443419034,
      "line" : 3035,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU3MjM1NQ==",
      "original_commit_id" : "247d67486a7ca8843579218f4397cdd790a67b07",
      "original_line" : 3035,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 482,
      "pull_request_review_id" : 438727692,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/446572355",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r446583177"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/446583177"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think this is very significant but perhaps we can include the suggestion that I believe aj (or others) made of ignoring MSG_TX inv's from wtxid-relay peers (and vice versa).",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-06-28T00:31:29Z",
      "diff_hunk" : "@@ -4440,7 +4452,15 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n                     // up processing to happen after the download times out\n                     // (with a slight delay for inbound peers, to prefer\n                     // requests to outbound peers).\n-                    const auto next_process_time = CalculateTxGetDataTime(txid, current_time, !state.fPreferredDownload);\n+                    // Don't apply the txid-delay to re-requests of a\n+                    // transaction; the heuristic of delaying requests to\n+                    // txid-relay peers is to save bandwidth on initial\n+                    // announcement of a transaction, and doesn't make sense\n+                    // for a followup request if our first peer times out (and\n+                    // would open us up to an attacker using inbound\n+                    // wtxid-relay to prevent us from requesting transactions\n+                    // from outbound txid-relay peers).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r446583177",
      "id" : 446583177,
      "in_reply_to_id" : 446459839,
      "line" : 4552,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU4MzE3Nw==",
      "original_commit_id" : "bc565ee3bd8232ec79540061d548488fa0681c68",
      "original_line" : 4552,
      "original_position" : 84,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 628,
      "pull_request_review_id" : 438733156,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/446583177",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This PR has been updated to include the tests from #18446 (thank you @fjahr and @ajtowns!), and to reflect the bip number assignment.  I've also included logic from @ajtowns to ignore MSG_TX invs from wtxid-relay peers, and vice versa, to address concerns about (1) intentional misbehavior from wtxid-relay peers to interfere with relay, and (2) making the logic around what kind of data we process from each peer simpler to understand.",
      "created_at" : "2020-06-28T12:02:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-650742012",
      "id" : 650742012,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1MDc0MjAxMg==",
      "updated_at" : "2020-06-28T12:02:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/650742012",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Code Review ACK 00cd6e3. Enforce inv-compliance and integrate BIP number since last review.",
      "created_at" : "2020-06-29T00:28:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-650844702",
      "id" : 650844702,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1MDg0NDcwMg==",
      "updated_at" : "2020-06-29T00:28:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/650844702",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r446735110"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/446735110"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This was making a copy of the set, which could then be accessed without holding the `mempool.cs` lock; returning a const reference instead is unsafe, isn't it? (In particular, if I understand correctly, `map<uint256,uint256> x = mempool.GetUnbroadcastTxs();` will do the copy from `*(&mempool.m_unbroadcast_txids)` after releasing the lock with this code, where previously it would have either copied to a temporary first or done copy elision and copied directly to `x` while holding the lock)",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-06-29T02:05:47Z",
      "diff_hunk" : "@@ -737,19 +740,19 @@ class CTxMemPool\n     size_t DynamicMemoryUsage() const;\n \n     /** Adds a transaction to the unbroadcast set */\n-    void AddUnbroadcastTx(const uint256& txid) {\n+    void AddUnbroadcastTx(const uint256& txid, const uint256& wtxid) {\n         LOCK(cs);\n         // Sanity Check: the transaction should also be in the mempool\n         if (exists(txid)) {\n-            m_unbroadcast_txids.insert(txid);\n+            m_unbroadcast_txids[txid] = wtxid;\n         }\n     }\n \n     /** Removes a transaction from the unbroadcast set */\n     void RemoveUnbroadcastTx(const uint256& txid, const bool unchecked = false);\n \n     /** Returns transactions in unbroadcast set */\n-    std::set<uint256> GetUnbroadcastTxs() const {\n+    const std::map<uint256, uint256>& GetUnbroadcastTxs() const {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r446735110",
      "id" : 446735110,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjczNTExMA==",
      "original_commit_id" : "fec2cba022afba0da16ef4a029e4a2cd0c00153f",
      "original_line" : 755,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : null,
      "pull_request_review_id" : 438846098,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/446735110",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r446746185"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/446746185"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "FWIW, I think `mempool.exists(hash, by_wtxid)` is more convenient/readable in AlreadyHave (the only place `wtxid_exists()` is used); it would let you say:\r\n\r\n```\r\n    const bool by_wtxid = (inv.type == MSG_WTX); \r\n    return mempool.exists(inv.hash, by_wtxid));\r\n```\r\n\r\ninstead of\r\n\r\n```\r\n    return (inv.type != MSG_WTX && mempool.exists(inv.hash)) ||\r\n           (inv.type == MSG_WTX && mempool.wtxid_exists(inv.hash));\r\n```",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-06-29T02:58:11Z",
      "diff_hunk" : "@@ -693,8 +717,19 @@ class CTxMemPool\n         return (mapTx.count(hash) != 0);\n     }\n \n+    bool wtxid_exists(const uint256& hash) const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r446746185",
      "id" : 446746185,
      "in_reply_to_id" : 399693214,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njc0NjE4NQ==",
      "original_commit_id" : "782a0b04496738030e3e51a6bf44aa5b426870b9",
      "original_line" : 725,
      "original_position" : 69,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : null,
      "pull_request_review_id" : 438846098,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/446746185",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r446750838"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/446750838"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Might be clearer just to pass the CInv in instead of separating the hash and precomputing `inv.type==MSG_WTX` at the caller.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-06-29T03:20:20Z",
      "diff_hunk" : "@@ -1625,24 +1641,24 @@ void static ProcessGetBlockData(CNode& pfrom, const CChainParams& chainparams, c\n }\n \n //! Determine whether or not a peer can request a transaction, and return it (or nullptr if not found or not allowed).\n-CTransactionRef static FindTxForGetData(CNode& peer, const uint256& txid, const std::chrono::seconds mempool_req, const std::chrono::seconds longlived_mempool_time) LOCKS_EXCLUDED(cs_main)\n+CTransactionRef static FindTxForGetData(CNode& peer, const uint256& txid_or_wtxid, bool use_wtxid, const std::chrono::seconds mempool_req, const std::chrono::seconds longlived_mempool_time) LOCKS_EXCLUDED(cs_main)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r446750838",
      "id" : 446750838,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njc1MDgzOA==",
      "original_commit_id" : "b4779bbb0aa3527714fb06414774336b1799dea3",
      "original_line" : 1664,
      "original_position" : 77,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 438846098,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/446750838",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r446755938"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/446755938"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Disconnecting seems fine to me -- it's not like there are old peers sending wtxidrelay messages around that we need to worry about supporting, and if we disconnect immediately, that should prevent anyone creating any new peers that behave weirdly? Mildly prefer ignoring the wtxidrelay if proposed post-verack, than just trying to do what they intend.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-06-29T03:45:39Z",
      "diff_hunk" : "@@ -2154,10 +2197,24 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n             nCMPCTBLOCKVersion = 1;\n             connman->PushMessage(pfrom, msgMaker.Make(NetMsgType::SENDCMPCT, fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion));\n         }\n+\n         pfrom->fSuccessfullyConnected = true;\n         return true;\n     }\n \n+    // Feature negotiation of wtxidrelay should happen between VERSION and\n+    // VERACK, to avoid relay problems from switching after a connection is up",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r446755938",
      "id" : 446755938,
      "in_reply_to_id" : 384862855,
      "line" : 2517,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njc1NTkzOA==",
      "original_commit_id" : "1cdf17837b26b8dfaf1aeec4c4a1a4b73810e4a5",
      "original_line" : 2517,
      "original_position" : 263,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 330,
      "pull_request_review_id" : 438846098,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/446755938",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r446995091"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/446995091"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Isn't this block about tracking `witness txid` not `txid`?",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-06-29T14:01:55Z",
      "diff_hunk" : "@@ -2007,10 +2008,19 @@ void static ProcessOrphanTx(CConnman* connman, CTxMemPool& mempool, std::set<uin\n             // Has inputs but not accepted to mempool\n             // Probably non-standard or insufficient fee\n             LogPrint(BCLog::MEMPOOL, \"   removed orphan tx %s\\n\", orphanHash.ToString());\n-            if (orphanTx.HasWitness() || orphan_state.GetResult() != TxValidationResult::TX_WITNESS_MUTATED) {\n-                // Do not use rejection cache for witness transactions or\n-                // witness-stripped transactions, as they can have been malleated.\n-                // See https://github.com/bitcoin/bitcoin/issues/8279 for details.\n+            if (orphan_state.GetResult() != TxValidationResult::TX_WITNESS_STRIPPED) {\n+                // Do not add txids of witness transactions or witness-stripped",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r446995091",
      "id" : 446995091,
      "line" : 2046,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk5NTA5MQ==",
      "original_commit_id" : "7d742ab91120f7a6c214903a3d43642f44e75227",
      "original_line" : 2046,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 296,
      "pull_request_review_id" : 439174665,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/446995091",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r447259137"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/447259137"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks, fixed.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-06-29T21:16:48Z",
      "diff_hunk" : "@@ -737,19 +740,19 @@ class CTxMemPool\n     size_t DynamicMemoryUsage() const;\n \n     /** Adds a transaction to the unbroadcast set */\n-    void AddUnbroadcastTx(const uint256& txid) {\n+    void AddUnbroadcastTx(const uint256& txid, const uint256& wtxid) {\n         LOCK(cs);\n         // Sanity Check: the transaction should also be in the mempool\n         if (exists(txid)) {\n-            m_unbroadcast_txids.insert(txid);\n+            m_unbroadcast_txids[txid] = wtxid;\n         }\n     }\n \n     /** Removes a transaction from the unbroadcast set */\n     void RemoveUnbroadcastTx(const uint256& txid, const bool unchecked = false);\n \n     /** Returns transactions in unbroadcast set */\n-    std::set<uint256> GetUnbroadcastTxs() const {\n+    const std::map<uint256, uint256>& GetUnbroadcastTxs() const {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r447259137",
      "id" : 447259137,
      "in_reply_to_id" : 446735110,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI1OTEzNw==",
      "original_commit_id" : "fec2cba022afba0da16ef4a029e4a2cd0c00153f",
      "original_line" : 755,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : null,
      "pull_request_review_id" : 439506860,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/447259137",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r447259405"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/447259405"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ok I guess recentRejects is pretty confusing.  Made one more attempt to add comments around how this works.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-06-29T21:17:26Z",
      "diff_hunk" : "@@ -2007,10 +2008,19 @@ void static ProcessOrphanTx(CConnman* connman, CTxMemPool& mempool, std::set<uin\n             // Has inputs but not accepted to mempool\n             // Probably non-standard or insufficient fee\n             LogPrint(BCLog::MEMPOOL, \"   removed orphan tx %s\\n\", orphanHash.ToString());\n-            if (orphanTx.HasWitness() || orphan_state.GetResult() != TxValidationResult::TX_WITNESS_MUTATED) {\n-                // Do not use rejection cache for witness transactions or\n-                // witness-stripped transactions, as they can have been malleated.\n-                // See https://github.com/bitcoin/bitcoin/issues/8279 for details.\n+            if (orphan_state.GetResult() != TxValidationResult::TX_WITNESS_STRIPPED) {\n+                // Do not add txids of witness transactions or witness-stripped",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r447259405",
      "id" : 447259405,
      "in_reply_to_id" : 446995091,
      "line" : 2046,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI1OTQwNQ==",
      "original_commit_id" : "7d742ab91120f7a6c214903a3d43642f44e75227",
      "original_line" : 2046,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 296,
      "pull_request_review_id" : 439507211,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/447259405",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r447260135"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/447260135"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I kind of don't like passing the CInv around, as it makes more places in the code have to know about the different enums that we use in there (and more places to potentially change in the code if we add new enums in the future), so leaving this as-is.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-06-29T21:19:04Z",
      "diff_hunk" : "@@ -1625,24 +1641,24 @@ void static ProcessGetBlockData(CNode& pfrom, const CChainParams& chainparams, c\n }\n \n //! Determine whether or not a peer can request a transaction, and return it (or nullptr if not found or not allowed).\n-CTransactionRef static FindTxForGetData(CNode& peer, const uint256& txid, const std::chrono::seconds mempool_req, const std::chrono::seconds longlived_mempool_time) LOCKS_EXCLUDED(cs_main)\n+CTransactionRef static FindTxForGetData(CNode& peer, const uint256& txid_or_wtxid, bool use_wtxid, const std::chrono::seconds mempool_req, const std::chrono::seconds longlived_mempool_time) LOCKS_EXCLUDED(cs_main)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r447260135",
      "id" : 447260135,
      "in_reply_to_id" : 446750838,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI2MDEzNQ==",
      "original_commit_id" : "b4779bbb0aa3527714fb06414774336b1799dea3",
      "original_line" : 1664,
      "original_position" : 77,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 439508203,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/447260135",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r447260595"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/447260595"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ok made it disconnect. Failing to make any connections at all is a good way for software to get fixed I guess...",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-06-29T21:20:04Z",
      "diff_hunk" : "@@ -2154,10 +2197,24 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n             nCMPCTBLOCKVersion = 1;\n             connman->PushMessage(pfrom, msgMaker.Make(NetMsgType::SENDCMPCT, fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion));\n         }\n+\n         pfrom->fSuccessfullyConnected = true;\n         return true;\n     }\n \n+    // Feature negotiation of wtxidrelay should happen between VERSION and\n+    // VERACK, to avoid relay problems from switching after a connection is up",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r447260595",
      "id" : 447260595,
      "in_reply_to_id" : 384862855,
      "line" : 2517,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI2MDU5NQ==",
      "original_commit_id" : "1cdf17837b26b8dfaf1aeec4c4a1a4b73810e4a5",
      "original_line" : 2517,
      "original_position" : 263,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 330,
      "pull_request_review_id" : 439508804,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/447260595",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Addressed @ajtowns' comments.  Note the behavior change: we now disconnect a peer if they send a wtxidrelay message after VERACK.\r\n\r\nAlso fixed the bug I introduced in the mempool unbroadcast stuff, gave in to dropping the `wtxid_exists` function, and made yet another attempt to improve the comments explaining how we use `recentRejects`.\r\n",
      "created_at" : "2020-06-29T21:23:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-651375317",
      "id" : 651375317,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1MTM3NTMxNw==",
      "updated_at" : "2020-06-29T21:23:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/651375317",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r447677003"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/447677003"
         }
      },
      "author_association" : "MEMBER",
      "body" : "To other reviewers: this issue is addressed in one of the following commits.\r\nIt would make more sense to update it here, but it's probably fine.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-06-30T13:22:04Z",
      "diff_hunk" : "@@ -1916,12 +1916,12 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n             // Has inputs but not accepted to mempool\n             // Probably non-standard or insufficient fee\n             LogPrint(BCLog::MEMPOOL, \"   removed orphan tx %s\\n\", orphanHash.ToString());\n-            if (!orphanTx.HasWitness() && orphan_state.GetResult() != TxValidationResult::TX_WITNESS_MUTATED) {\n+            if (orphanTx.HasWitness() || orphan_state.GetResult() != TxValidationResult::TX_WITNESS_MUTATED) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r447677003",
      "id" : 447677003,
      "in_reply_to_id" : 392511089,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzY3NzAwMw==",
      "original_commit_id" : "0d3d656ab5334db15b91cc0708d7e12db32a5e0a",
      "original_line" : 1919,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 440007086,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/447677003",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r447697340"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/447697340"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm not very familiar with alternative (deployed) SIGHASH flags, but I was wondering if this can possible screw us somehow... I don't have a particular attack scenario, just throwing this idea here.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-06-30T13:49:28Z",
      "diff_hunk" : "@@ -2877,15 +2983,30 @@ void ProcessMessage(\n                 LogPrint(BCLog::MEMPOOL, \"not keeping orphan with rejected parents %s\\n\",tx.GetHash().ToString());\n                 // We will continue to reject this tx since it has rejected\n                 // parents so avoid re-requesting it from other peers.\n+                // Here we add both the txid and the wtxid, as we know that\n+                // regardless of what witness is provided, we will not accept\n+                // this, so we don't need to allow for redownload of this txid\n+                // from any of our non-wtxidrelay peers.\n                 recentRejects->insert(tx.GetHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r447697340",
      "id" : 447697340,
      "line" : 3021,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzY5NzM0MA==",
      "original_commit_id" : "6787a3dc2abb04f0b75aa2f8996e4bbd6c468ddd",
      "original_line" : 3021,
      "original_position" : 451,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 464,
      "pull_request_review_id" : 440033831,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/447697340",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r447710854"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/447710854"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't know what SIGHASH flags has to do with this, can you elaborate on the scenario you have in mind?\r\n\r\nMy understanding of the logic here is that at this point in the code, we know that a parent of this orphan transaction will definitely not be accepted by our node (as it is already in our reject filter).  Since a txid is a commitment to the inputs of a transaction, this means that we can definitively know that we'll never accept any transaction with the same txid as this orphan, regardless of what witness it comes with.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-06-30T14:07:05Z",
      "diff_hunk" : "@@ -2877,15 +2983,30 @@ void ProcessMessage(\n                 LogPrint(BCLog::MEMPOOL, \"not keeping orphan with rejected parents %s\\n\",tx.GetHash().ToString());\n                 // We will continue to reject this tx since it has rejected\n                 // parents so avoid re-requesting it from other peers.\n+                // Here we add both the txid and the wtxid, as we know that\n+                // regardless of what witness is provided, we will not accept\n+                // this, so we don't need to allow for redownload of this txid\n+                // from any of our non-wtxidrelay peers.\n                 recentRejects->insert(tx.GetHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r447710854",
      "id" : 447710854,
      "in_reply_to_id" : 447697340,
      "line" : 3021,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzcxMDg1NA==",
      "original_commit_id" : "6787a3dc2abb04f0b75aa2f8996e4bbd6c468ddd",
      "original_line" : 3021,
      "original_position" : 451,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 464,
      "pull_request_review_id" : 440051510,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/447710854",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r447715043"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/447715043"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I understand how they work(in master), I didn't understand why it was talking about something it's not doing. With the added comment it's clearer, thanks.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-06-30T14:12:31Z",
      "diff_hunk" : "@@ -2007,10 +2008,19 @@ void static ProcessOrphanTx(CConnman* connman, CTxMemPool& mempool, std::set<uin\n             // Has inputs but not accepted to mempool\n             // Probably non-standard or insufficient fee\n             LogPrint(BCLog::MEMPOOL, \"   removed orphan tx %s\\n\", orphanHash.ToString());\n-            if (orphanTx.HasWitness() || orphan_state.GetResult() != TxValidationResult::TX_WITNESS_MUTATED) {\n-                // Do not use rejection cache for witness transactions or\n-                // witness-stripped transactions, as they can have been malleated.\n-                // See https://github.com/bitcoin/bitcoin/issues/8279 for details.\n+            if (orphan_state.GetResult() != TxValidationResult::TX_WITNESS_STRIPPED) {\n+                // Do not add txids of witness transactions or witness-stripped",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r447715043",
      "id" : 447715043,
      "in_reply_to_id" : 446995091,
      "line" : 2046,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzcxNTA0Mw==",
      "original_commit_id" : "7d742ab91120f7a6c214903a3d43642f44e75227",
      "original_line" : 2046,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 296,
      "pull_request_review_id" : 440057196,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/447715043",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r447795446"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/447795446"
         }
      },
      "author_association" : "MEMBER",
      "body" : "why are these string checks removed? ",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-06-30T15:57:06Z",
      "diff_hunk" : "@@ -1296,9 +1296,9 @@ def test_tx_relay_after_segwit_activation(self):\n \n         # Node will not be blinded to the transaction\n         self.std_node.announce_tx_and_wait_for_getdata(tx3)\n-        test_transaction_acceptance(self.nodes[1], self.std_node, tx3, True, False, 'tx-size')\n+        test_transaction_acceptance(self.nodes[1], self.std_node, tx3, True, False)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r447795446",
      "id" : 447795446,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc5NTQ0Ng==",
      "original_commit_id" : "5c7c3f44bdb932c96645d74da9284e73196036d0",
      "original_line" : 1324,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "test/functional/p2p_segwit.py",
      "position" : null,
      "pull_request_review_id" : 440161436,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/447795446",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r447799731"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/447799731"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Nevermind, I was worried that something would happen to xxx | ANYONECANPAY, but now I think there are no issues there.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-06-30T16:03:16Z",
      "diff_hunk" : "@@ -2877,15 +2983,30 @@ void ProcessMessage(\n                 LogPrint(BCLog::MEMPOOL, \"not keeping orphan with rejected parents %s\\n\",tx.GetHash().ToString());\n                 // We will continue to reject this tx since it has rejected\n                 // parents so avoid re-requesting it from other peers.\n+                // Here we add both the txid and the wtxid, as we know that\n+                // regardless of what witness is provided, we will not accept\n+                // this, so we don't need to allow for redownload of this txid\n+                // from any of our non-wtxidrelay peers.\n                 recentRejects->insert(tx.GetHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r447799731",
      "id" : 447799731,
      "in_reply_to_id" : 447697340,
      "line" : 3021,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc5OTczMQ==",
      "original_commit_id" : "6787a3dc2abb04f0b75aa2f8996e4bbd6c468ddd",
      "original_line" : 3021,
      "original_position" : 451,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 464,
      "pull_request_review_id" : 440167157,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/447799731",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "utACK 6787a3dc2abb04f0b75aa2f8996e4bbd6c468ddd",
      "created_at" : "2020-06-30T16:03:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-651890399",
      "id" : 651890399,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1MTg5MDM5OQ==",
      "updated_at" : "2020-06-30T16:03:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/651890399",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r450527682"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/450527682"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@ariard I don't understand this comment (https://github.com/bitcoin/bitcoin/pull/18044/commits/1c382b500b2b6025f9a4cf4cd37af678172c6ae1#r385362270).\r\n\r\nI think 3 pointers for an extra index is probably close to correct, but #18086 may make these kinds of heuristics unnecessary, so that's probably a better approach long term.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-06T23:20:28Z",
      "diff_hunk" : "@@ -912,8 +912,8 @@ bool CCoinsViewMemPool::GetCoin(const COutPoint &outpoint, Coin &coin) const {\n \n size_t CTxMemPool::DynamicMemoryUsage() const {\n     LOCK(cs);\n-    // Estimate the overhead of mapTx to be 12 pointers + an allocation, as no exact formula for boost::multi_index_contained is implemented.\n-    return memusage::MallocUsage(sizeof(CTxMemPoolEntry) + 12 * sizeof(void*)) * mapTx.size() + memusage::DynamicUsage(mapNextTx) + memusage::DynamicUsage(mapDeltas) + memusage::DynamicUsage(mapLinks) + memusage::DynamicUsage(vTxHashes) + cachedInnerUsage;\n+    // Estimate the overhead of mapTx to be 15 pointers + an allocation, as no exact formula for boost::multi_index_contained is implemented.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r450527682",
      "id" : 450527682,
      "in_reply_to_id" : 385362270,
      "line" : 920,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUyNzY4Mg==",
      "original_commit_id" : "1d1fddb9790cb3b9a70df5370a71ac245491b71c",
      "original_line" : 920,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 35,
      "pull_request_review_id" : 443464983,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/450527682",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r450530214"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/450530214"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit \"Add wtxids of confirmed transactions to bloom filter\"\r\n\r\nIt may be worth doing this only in case the txid and wtxid differ (inserting the same thing twice still counts towards expiration of old entries). In the worst case it doesn't matter (it maintains the last 24000 inserted txid/wtxid pairs always), but in the average case, as long as there are non-witness transactions doing so would increase that to somewhere between 24000 and 48000.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-06T23:28:50Z",
      "diff_hunk" : "@@ -1236,6 +1237,7 @@ void PeerLogicValidation::BlockConnected(const std::shared_ptr<const CBlock>& pb\n         LOCK(g_cs_recent_confirmed_transactions);\n         for (const auto& ptx : pblock->vtx) {\n             g_recent_confirmed_transactions->insert(ptx->GetHash());\n+            g_recent_confirmed_transactions->insert(ptx->GetWitnessHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r450530214",
      "id" : 450530214,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUzMDIxNA==",
      "original_commit_id" : "95d729ad020dac39f93542e5366c15eba38d6c99",
      "original_line" : 1240,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 443467912,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/450530214",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r450530868"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/450530868"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Agree with @sdaftuar. It's annoying that it adds variables in many places, but the various CInv states really don't correspond to what we need here either.\r\n\r\nIt may be useful to have an encapsulated (use_wtxid, txid_or_wtxid) pair type, but let's keep that for later (I think it would make sense for combining with #19184 as well).",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-06T23:31:01Z",
      "diff_hunk" : "@@ -1625,24 +1641,24 @@ void static ProcessGetBlockData(CNode& pfrom, const CChainParams& chainparams, c\n }\n \n //! Determine whether or not a peer can request a transaction, and return it (or nullptr if not found or not allowed).\n-CTransactionRef static FindTxForGetData(CNode& peer, const uint256& txid, const std::chrono::seconds mempool_req, const std::chrono::seconds longlived_mempool_time) LOCKS_EXCLUDED(cs_main)\n+CTransactionRef static FindTxForGetData(CNode& peer, const uint256& txid_or_wtxid, bool use_wtxid, const std::chrono::seconds mempool_req, const std::chrono::seconds longlived_mempool_time) LOCKS_EXCLUDED(cs_main)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r450530868",
      "id" : 450530868,
      "in_reply_to_id" : 446750838,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUzMDg2OA==",
      "original_commit_id" : "b4779bbb0aa3527714fb06414774336b1799dea3",
      "original_line" : 1664,
      "original_position" : 77,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 443467912,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/450530868",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r450573992"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/450573992"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This will only request parents of orphan transactions when received from non-wtxid peers? What if all peers support wtxid?\r\n\r\nCan't we still request them, but with MSG_TX instead of MSG_WTX? That'd require keeping track of wtxidness per request, unfortunately.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-07T02:15:26Z",
      "diff_hunk" : "@@ -2866,10 +2898,17 @@ void ProcessMessage(\n                 uint32_t nFetchFlags = GetFetchFlags(pfrom);\n                 const auto current_time = GetTime<std::chrono::microseconds>();\n \n-                for (const CTxIn& txin : tx.vin) {\n-                    CInv _inv(MSG_TX | nFetchFlags, txin.prevout.hash);\n-                    pfrom.AddInventoryKnown(txin.prevout.hash);\n-                    if (!AlreadyHave(_inv, mempool)) RequestTx(State(pfrom.GetId()), _inv.hash, current_time);\n+                if (!State(pfrom.GetId())->m_wtxid_relay) {\n+                    for (const CTxIn& txin : tx.vin) {\n+                        // Here, we only have the txid (and not wtxid) of the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r450573992",
      "id" : 450573992,
      "line" : 2995,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU3Mzk5Mg==",
      "original_commit_id" : "5c7c3f44bdb932c96645d74da9284e73196036d0",
      "original_line" : 2995,
      "original_position" : 188,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 444,
      "pull_request_review_id" : 443467912,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/450573992",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r450581797"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/450581797"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Nit: this comment is out of date now.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-07T02:47:13Z",
      "diff_hunk" : "@@ -391,10 +391,11 @@ const uint32_t MSG_TYPE_MASK = 0xffffffff >> 2;\n  * These numbers are defined by the protocol. When adding a new value, be sure\n  * to mention it in the respective BIP.\n  */\n-enum GetDataMsg {\n+enum GetDataMsg : uint32_t {\n     UNDEFINED = 0,\n     MSG_TX = 1,\n     MSG_BLOCK = 2,\n+    MSG_WTX = 5,                                      //!< Defined in BIP 339\n     // The following can only occur in getdata. Invs always use TX or BLOCK.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r450581797",
      "id" : 450581797,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU4MTc5Nw==",
      "original_commit_id" : "5c7c3f44bdb932c96645d74da9284e73196036d0",
      "original_line" : 405,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/protocol.h",
      "position" : null,
      "pull_request_review_id" : 443467912,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/450581797",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r450604619"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/450604619"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "[Earlier discussion of this](https://github.com/bitcoin/bitcoin/pull/18044#discussion_r400444597) proposed handling this via package relay",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-07T04:30:36Z",
      "diff_hunk" : "@@ -2866,10 +2898,17 @@ void ProcessMessage(\n                 uint32_t nFetchFlags = GetFetchFlags(pfrom);\n                 const auto current_time = GetTime<std::chrono::microseconds>();\n \n-                for (const CTxIn& txin : tx.vin) {\n-                    CInv _inv(MSG_TX | nFetchFlags, txin.prevout.hash);\n-                    pfrom.AddInventoryKnown(txin.prevout.hash);\n-                    if (!AlreadyHave(_inv, mempool)) RequestTx(State(pfrom.GetId()), _inv.hash, current_time);\n+                if (!State(pfrom.GetId())->m_wtxid_relay) {\n+                    for (const CTxIn& txin : tx.vin) {\n+                        // Here, we only have the txid (and not wtxid) of the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r450604619",
      "id" : 450604619,
      "in_reply_to_id" : 450573992,
      "line" : 2995,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYwNDYxOQ==",
      "original_commit_id" : "5c7c3f44bdb932c96645d74da9284e73196036d0",
      "original_line" : 2995,
      "original_position" : 188,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 444,
      "pull_request_review_id" : 443554365,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/450604619",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r450638708"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/450638708"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think this will be an issue even when there's only a small number of wtxid peers -- in that case we'll delay requesting transactions from non-wtxid peers, so most of the txs (and hence most of the orphans) we receive will be from wtxid peers. I guess I'd still rather see this merged now and fixed later than further delayed though?",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-07T06:31:05Z",
      "diff_hunk" : "@@ -2866,10 +2898,17 @@ void ProcessMessage(\n                 uint32_t nFetchFlags = GetFetchFlags(pfrom);\n                 const auto current_time = GetTime<std::chrono::microseconds>();\n \n-                for (const CTxIn& txin : tx.vin) {\n-                    CInv _inv(MSG_TX | nFetchFlags, txin.prevout.hash);\n-                    pfrom.AddInventoryKnown(txin.prevout.hash);\n-                    if (!AlreadyHave(_inv, mempool)) RequestTx(State(pfrom.GetId()), _inv.hash, current_time);\n+                if (!State(pfrom.GetId())->m_wtxid_relay) {\n+                    for (const CTxIn& txin : tx.vin) {\n+                        // Here, we only have the txid (and not wtxid) of the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r450638708",
      "id" : 450638708,
      "in_reply_to_id" : 450573992,
      "line" : 2995,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYzODcwOA==",
      "original_commit_id" : "5c7c3f44bdb932c96645d74da9284e73196036d0",
      "original_line" : 2995,
      "original_position" : 188,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 444,
      "pull_request_review_id" : 443596461,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/450638708",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "utACK 6787a3dc2abb04f0b75aa2f8996e4bbd6c468ddd ; checked changes since previous review",
      "created_at" : "2020-07-07T06:33:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-654632344",
      "id" : 654632344,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1NDYzMjM0NA==",
      "updated_at" : "2020-07-07T06:33:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/654632344",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r450649223"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/450649223"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ok, I read back some of the history there. I see the complexity it introduces, but I'm still really uncomfortable with just breaking orphan parent-fetching. I'll instrument my node to see how frequently that actually happens.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-07T06:58:00Z",
      "diff_hunk" : "@@ -2866,10 +2898,17 @@ void ProcessMessage(\n                 uint32_t nFetchFlags = GetFetchFlags(pfrom);\n                 const auto current_time = GetTime<std::chrono::microseconds>();\n \n-                for (const CTxIn& txin : tx.vin) {\n-                    CInv _inv(MSG_TX | nFetchFlags, txin.prevout.hash);\n-                    pfrom.AddInventoryKnown(txin.prevout.hash);\n-                    if (!AlreadyHave(_inv, mempool)) RequestTx(State(pfrom.GetId()), _inv.hash, current_time);\n+                if (!State(pfrom.GetId())->m_wtxid_relay) {\n+                    for (const CTxIn& txin : tx.vin) {\n+                        // Here, we only have the txid (and not wtxid) of the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r450649223",
      "id" : 450649223,
      "in_reply_to_id" : 450573992,
      "line" : 2995,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY0OTIyMw==",
      "original_commit_id" : "5c7c3f44bdb932c96645d74da9284e73196036d0",
      "original_line" : 2995,
      "original_position" : 188,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 444,
      "pull_request_review_id" : 443610362,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/450649223",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r450687076"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/450687076"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hmm, it just doesn't seem like a big deal to me. I think https://github.com/ajtowns/bitcoin/commits/202007-wtxid-orphans should be all that's needed to fix it.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-07T08:14:15Z",
      "diff_hunk" : "@@ -2866,10 +2898,17 @@ void ProcessMessage(\n                 uint32_t nFetchFlags = GetFetchFlags(pfrom);\n                 const auto current_time = GetTime<std::chrono::microseconds>();\n \n-                for (const CTxIn& txin : tx.vin) {\n-                    CInv _inv(MSG_TX | nFetchFlags, txin.prevout.hash);\n-                    pfrom.AddInventoryKnown(txin.prevout.hash);\n-                    if (!AlreadyHave(_inv, mempool)) RequestTx(State(pfrom.GetId()), _inv.hash, current_time);\n+                if (!State(pfrom.GetId())->m_wtxid_relay) {\n+                    for (const CTxIn& txin : tx.vin) {\n+                        // Here, we only have the txid (and not wtxid) of the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r450687076",
      "id" : 450687076,
      "in_reply_to_id" : 450573992,
      "line" : 2995,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY4NzA3Ng==",
      "original_commit_id" : "5c7c3f44bdb932c96645d74da9284e73196036d0",
      "original_line" : 2995,
      "original_position" : 188,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 444,
      "pull_request_review_id" : 443661909,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/450687076",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r451055578"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/451055578"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@ajtowns That does not look bad at all, indeed. I guess we can move ahead with this and re-instate orphan fetching with a patch like that afterwards.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-07T18:16:33Z",
      "diff_hunk" : "@@ -2866,10 +2898,17 @@ void ProcessMessage(\n                 uint32_t nFetchFlags = GetFetchFlags(pfrom);\n                 const auto current_time = GetTime<std::chrono::microseconds>();\n \n-                for (const CTxIn& txin : tx.vin) {\n-                    CInv _inv(MSG_TX | nFetchFlags, txin.prevout.hash);\n-                    pfrom.AddInventoryKnown(txin.prevout.hash);\n-                    if (!AlreadyHave(_inv, mempool)) RequestTx(State(pfrom.GetId()), _inv.hash, current_time);\n+                if (!State(pfrom.GetId())->m_wtxid_relay) {\n+                    for (const CTxIn& txin : tx.vin) {\n+                        // Here, we only have the txid (and not wtxid) of the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r451055578",
      "id" : 451055578,
      "in_reply_to_id" : 450573992,
      "line" : 2995,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA1NTU3OA==",
      "original_commit_id" : "5c7c3f44bdb932c96645d74da9284e73196036d0",
      "original_line" : 2995,
      "original_position" : 188,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 444,
      "pull_request_review_id" : 444138427,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/451055578",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r451228334"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/451228334"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Seems like it would fit in well with the tx relay overhaul, if you stole another bit from m_sequence for the txid vs wtxid flag to me.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-08T01:18:17Z",
      "diff_hunk" : "@@ -2866,10 +2898,17 @@ void ProcessMessage(\n                 uint32_t nFetchFlags = GetFetchFlags(pfrom);\n                 const auto current_time = GetTime<std::chrono::microseconds>();\n \n-                for (const CTxIn& txin : tx.vin) {\n-                    CInv _inv(MSG_TX | nFetchFlags, txin.prevout.hash);\n-                    pfrom.AddInventoryKnown(txin.prevout.hash);\n-                    if (!AlreadyHave(_inv, mempool)) RequestTx(State(pfrom.GetId()), _inv.hash, current_time);\n+                if (!State(pfrom.GetId())->m_wtxid_relay) {\n+                    for (const CTxIn& txin : tx.vin) {\n+                        // Here, we only have the txid (and not wtxid) of the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r451228334",
      "id" : 451228334,
      "in_reply_to_id" : 450573992,
      "line" : 2995,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIyODMzNA==",
      "original_commit_id" : "5c7c3f44bdb932c96645d74da9284e73196036d0",
      "original_line" : 2995,
      "original_position" : 188,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 444,
      "pull_request_review_id" : 444349785,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/451228334",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r451250911"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/451250911"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit \"Add support for tx-relay via wtxid\"\r\n\r\nI think `RemoveUnbroadcastTx` will always take txids, not wtxids, so this should be changed to `tx->GetHash()`.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-08T02:47:05Z",
      "diff_hunk" : "@@ -1685,8 +1700,9 @@ void static ProcessGetData(CNode& pfrom, const CChainParams& chainparams, CConnm\n             continue;\n         }\n \n-        CTransactionRef tx = FindTxForGetData(pfrom, inv.hash, mempool_req, longlived_mempool_time);\n+        CTransactionRef tx = FindTxForGetData(pfrom, inv.hash, inv.type == MSG_WTX, mempool_req, longlived_mempool_time);\n         if (tx) {\n+            // WTX and WITNESS_TX imply we serialize with witness\n             int nSendFlags = (inv.type == MSG_TX ? SERIALIZE_TRANSACTION_NO_WITNESS : 0);\n             connman->PushMessage(&pfrom, msgMaker.Make(nSendFlags, NetMsgType::TX, *tx));\n             mempool.RemoveUnbroadcastTx(inv.hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r451250911",
      "id" : 451250911,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI1MDkxMQ==",
      "original_commit_id" : "5c7c3f44bdb932c96645d74da9284e73196036d0",
      "original_line" : 1708,
      "original_position" : 121,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 444375877,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/451250911",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r451252043"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/451252043"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@ajtowns Exactly!",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-08T02:51:36Z",
      "diff_hunk" : "@@ -2866,10 +2898,17 @@ void ProcessMessage(\n                 uint32_t nFetchFlags = GetFetchFlags(pfrom);\n                 const auto current_time = GetTime<std::chrono::microseconds>();\n \n-                for (const CTxIn& txin : tx.vin) {\n-                    CInv _inv(MSG_TX | nFetchFlags, txin.prevout.hash);\n-                    pfrom.AddInventoryKnown(txin.prevout.hash);\n-                    if (!AlreadyHave(_inv, mempool)) RequestTx(State(pfrom.GetId()), _inv.hash, current_time);\n+                if (!State(pfrom.GetId())->m_wtxid_relay) {\n+                    for (const CTxIn& txin : tx.vin) {\n+                        // Here, we only have the txid (and not wtxid) of the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r451252043",
      "id" : 451252043,
      "in_reply_to_id" : 450573992,
      "line" : 2995,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI1MjA0Mw==",
      "original_commit_id" : "5c7c3f44bdb932c96645d74da9284e73196036d0",
      "original_line" : 2995,
      "original_position" : 188,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 444,
      "pull_request_review_id" : 444375877,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/451252043",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r451354525"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/451354525"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit \"Add a wtxid-index to the mempool\"\r\n\r\nI think this would be a nice improvement.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-08T07:57:58Z",
      "diff_hunk" : "@@ -693,8 +717,19 @@ class CTxMemPool\n         return (mapTx.count(hash) != 0);\n     }\n \n+    bool wtxid_exists(const uint256& hash) const\n+    {\n+        LOCK(cs);\n+        return (mapTx.get<index_by_wtxid>().count(hash) != 0);\n+    }\n+\n     CTransactionRef get(const uint256& hash) const;\n-    TxMempoolInfo info(const uint256& hash) const;\n+    txiter get_iter_from_wtxid(const uint256& wtxid) const EXCLUSIVE_LOCKS_REQUIRED(cs)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r451354525",
      "id" : 451354525,
      "in_reply_to_id" : 399693288,
      "line" : 729,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM1NDUyNQ==",
      "original_commit_id" : "782a0b04496738030e3e51a6bf44aa5b426870b9",
      "original_line" : 729,
      "original_position" : 77,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : 95,
      "pull_request_review_id" : 444375877,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/451354525",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r451751532"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/451751532"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed, thanks!",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-08T18:40:50Z",
      "diff_hunk" : "@@ -1685,8 +1700,9 @@ void static ProcessGetData(CNode& pfrom, const CChainParams& chainparams, CConnm\n             continue;\n         }\n \n-        CTransactionRef tx = FindTxForGetData(pfrom, inv.hash, mempool_req, longlived_mempool_time);\n+        CTransactionRef tx = FindTxForGetData(pfrom, inv.hash, inv.type == MSG_WTX, mempool_req, longlived_mempool_time);\n         if (tx) {\n+            // WTX and WITNESS_TX imply we serialize with witness\n             int nSendFlags = (inv.type == MSG_TX ? SERIALIZE_TRANSACTION_NO_WITNESS : 0);\n             connman->PushMessage(&pfrom, msgMaker.Make(nSendFlags, NetMsgType::TX, *tx));\n             mempool.RemoveUnbroadcastTx(inv.hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r451751532",
      "id" : 451751532,
      "in_reply_to_id" : 451250911,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTc1MTUzMg==",
      "original_commit_id" : "5c7c3f44bdb932c96645d74da9284e73196036d0",
      "original_line" : 1708,
      "original_position" : 121,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 445034388,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/451751532",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-07-11T08:35:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-657015996",
      "id" : 657015996,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1NzAxNTk5Ng==",
      "updated_at" : "2020-07-11T08:35:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/657015996",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've been running this branch on a number of nodes, in various configurations (including one with only wtxid peers, and mixed reachable/unreachable ones).\r\n\r\nThe primary thing I wanted to know is if there was any noticable impact on the number of compact block reconstructions that need transaction requests (as this PR impacts orphan processing). At first glance everything looks fine - nearly all blocks are reconstructed without requesting anything else.\r\n\r\nSomething that did surprise me, is that there doesn't seem to be a strong bias towards wtxid peers in terms of downloaded transactions. I have one wtxid peer that is connected to both a wtxid and a normal peer, but around 60% of tx bandwidth is from the txid one. This may be due to the wtxid node just being slower, or having worse latency, or just being further away from common tx sources in the transaction graph - but I was expecting a strong effect.",
      "created_at" : "2020-07-14T00:20:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-657895276",
      "id" : 657895276,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1Nzg5NTI3Ng==",
      "updated_at" : "2020-07-14T00:20:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/657895276",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Something that did surprise me, is that there doesn't seem to be a strong bias towards wtxid peers in terms of downloaded transactions. I have one wtxid peer that is connected to both a wtxid and a normal peer, but around 60% of tx bandwidth is from the txid one. This may be due to the wtxid node just being slower, or having worse latency, or just being further away from common tx sources in the transaction graph - but I was expecting a strong effect.\r\n\r\nI think this is behaving something like:\r\n\r\n* node A and B do wtxid relay and are peered to each other, but no other wtxid relay peers\r\n* node A receives INV of tx t from node C, delays requesting it for 1+2s\r\n* node B receives INV of tx t from node D, delays requesting it for 1+2s\r\n* node A requests t from C, receives it\r\n* node B receives INV of tx t from node A, delays requesting it for 1s\r\n* node B requests t from D, receives it\r\n\r\nthat is, B's willingness to wait to receive from A is exhausted in the same time as A spend hoping to receive from B.\r\n\r\nSo I think this will likely remain a small effect for transactions that are initially broadcast to/via non-wtxid-relay nodes? Might be something to reconsider with #19184 which I think would allow prioritising from wtxid-relay peers more directly. (EDIT: on second thoughts, the approach I was thinking of would only help if you could prioritise relay-by-wtxid over relay-by-txid of the same txn, which you obviously can't do. Some sort of random delay triggered on node-secret/txid so each wtxid node has a small chance of introducing the tx to the wtxid-relay-network early could work, but probably not until there's a decent number of wtxid relay nodes out there)",
      "created_at" : "2020-07-17T23:20:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-660377717",
      "id" : 660377717,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2MDM3NzcxNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-18T05:08:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/660377717",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r456824787"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/456824787"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Took me forever to remember the issue here -- the first string check can stay, but the second one has to be removed because now that we cache failure of wtxid's in the recentRejects filter, the reason for failure on the second validation attempt will be different.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-18T20:25:54Z",
      "diff_hunk" : "@@ -1296,9 +1296,9 @@ def test_tx_relay_after_segwit_activation(self):\n \n         # Node will not be blinded to the transaction\n         self.std_node.announce_tx_and_wait_for_getdata(tx3)\n-        test_transaction_acceptance(self.nodes[1], self.std_node, tx3, True, False, 'tx-size')\n+        test_transaction_acceptance(self.nodes[1], self.std_node, tx3, True, False)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r456824787",
      "id" : 456824787,
      "in_reply_to_id" : 447795446,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjgyNDc4Nw==",
      "original_commit_id" : "5c7c3f44bdb932c96645d74da9284e73196036d0",
      "original_line" : 1324,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "test/functional/p2p_segwit.py",
      "position" : null,
      "pull_request_review_id" : 451080504,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/456824787",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r456836108"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/456836108"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Reinstating this first string check (and the second line was removed in a later commit anyway).",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-18T22:57:44Z",
      "diff_hunk" : "@@ -1296,9 +1296,9 @@ def test_tx_relay_after_segwit_activation(self):\n \n         # Node will not be blinded to the transaction\n         self.std_node.announce_tx_and_wait_for_getdata(tx3)\n-        test_transaction_acceptance(self.nodes[1], self.std_node, tx3, True, False, 'tx-size')\n+        test_transaction_acceptance(self.nodes[1], self.std_node, tx3, True, False)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r456836108",
      "id" : 456836108,
      "in_reply_to_id" : 447795446,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjgzNjEwOA==",
      "original_commit_id" : "5c7c3f44bdb932c96645d74da9284e73196036d0",
      "original_line" : 1324,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "test/functional/p2p_segwit.py",
      "position" : null,
      "pull_request_review_id" : 451086888,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/456836108",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r456836126"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/456836126"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-18T22:58:00Z",
      "diff_hunk" : "@@ -1236,6 +1237,7 @@ void PeerLogicValidation::BlockConnected(const std::shared_ptr<const CBlock>& pb\n         LOCK(g_cs_recent_confirmed_transactions);\n         for (const auto& ptx : pblock->vtx) {\n             g_recent_confirmed_transactions->insert(ptx->GetHash());\n+            g_recent_confirmed_transactions->insert(ptx->GetWitnessHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r456836126",
      "id" : 456836126,
      "in_reply_to_id" : 450530214,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjgzNjEyNg==",
      "original_commit_id" : "95d729ad020dac39f93542e5366c15eba38d6c99",
      "original_line" : 1240,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 451086901,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/456836126",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r456836147"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/456836147"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-18T22:58:14Z",
      "diff_hunk" : "@@ -391,10 +391,11 @@ const uint32_t MSG_TYPE_MASK = 0xffffffff >> 2;\n  * These numbers are defined by the protocol. When adding a new value, be sure\n  * to mention it in the respective BIP.\n  */\n-enum GetDataMsg {\n+enum GetDataMsg : uint32_t {\n     UNDEFINED = 0,\n     MSG_TX = 1,\n     MSG_BLOCK = 2,\n+    MSG_WTX = 5,                                      //!< Defined in BIP 339\n     // The following can only occur in getdata. Invs always use TX or BLOCK.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r456836147",
      "id" : 456836147,
      "in_reply_to_id" : 450581797,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjgzNjE0Nw==",
      "original_commit_id" : "5c7c3f44bdb932c96645d74da9284e73196036d0",
      "original_line" : 405,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/protocol.h",
      "position" : null,
      "pull_request_review_id" : 451086915,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-19T06:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/456836147",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "To summarize the state of review before rebase of #19109 and #19474:\r\n\r\nconcept ACK - jnewbery, TheBlueMatt, rajarshimaitra\r\ncode review ACK - sipa, ariard, jonatack\r\nutACK - ajtowns, naumenkogs, instagibbs",
      "created_at" : "2020-07-19T13:26:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-660643514",
      "id" : 660643514,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2MDY0MzUxNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-19T13:26:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/660643514",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/755825?v=4",
         "events_url" : "https://api.github.com/users/adamjonas/events{/privacy}",
         "followers_url" : "https://api.github.com/users/adamjonas/followers",
         "following_url" : "https://api.github.com/users/adamjonas/following{/other_user}",
         "gists_url" : "https://api.github.com/users/adamjonas/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/adamjonas",
         "id" : 755825,
         "login" : "adamjonas",
         "node_id" : "MDQ6VXNlcjc1NTgyNQ==",
         "organizations_url" : "https://api.github.com/users/adamjonas/orgs",
         "received_events_url" : "https://api.github.com/users/adamjonas/received_events",
         "repos_url" : "https://api.github.com/users/adamjonas/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/adamjonas/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/adamjonas/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/adamjonas"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "When I rebased this, I had to think about the interaction between #19109 and wtxid-based relay.  One change I made to this PR is to add both the txid and wtxid of an announced transaction to the `filterInventoryKnown` for a peer; this prevents clogging the filter with txid entries for that were already announced via wtxid when child transactions are relayed.\r\n\r\nAlso I found a bug with insertions into mapRelay; the intention was to add lookups by txid and wtxid whenever a transaction is relayed, but I think for wtxid-relay peers we were attempting to insert a lookup by wtxid twice instead. \r\n\r\nI also took this opportunity to address a few outstanding nits.",
      "created_at" : "2020-07-19T21:24:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-660712195",
      "id" : 660712195,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2MDcxMjE5NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-19T21:24:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/660712195",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r457768442"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/457768442"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We set `fRejectedParents` based on parent's _txid_ in `recentRejects`. If parent has been previously announced and rejected based on wtxid only we won't found it. So we won't add this orphan and may fetch it again. I don't see this case covered in new test ?\r\n",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-21T00:38:49Z",
      "diff_hunk" : "@@ -2908,14 +2908,15 @@ void ProcessMessage(\n                 // We will continue to reject this tx since it has rejected\n                 // parents so avoid re-requesting it from other peers.\n                 recentRejects->insert(tx.GetHash());\n+                recentRejects->insert(tx.GetWitnessHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r457768442",
      "id" : 457768442,
      "line" : 3022,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc2ODQ0Mg==",
      "original_commit_id" : "8e68fc246d09f1e6c6dfa8c676969d97c2eb4334",
      "original_line" : 2911,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 465,
      "pull_request_review_id" : 452049233,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-21T00:44:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/457768442",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r457775247"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/457775247"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Also if we fix it, and parent txA is rejected due to a mutated witness, child txB with a _valid_ witness will be pinned in `recentRejects`. If parent txA is re-announced and accepted with a new witness, propagation of child txB will still fail until next block, assuming there is a unique valid witness known. So in multi-party, competing scenario, you introduce a _slight_ delay vector. I think that's okay if an attacker can't repeat this game at each block. ",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-21T01:04:19Z",
      "diff_hunk" : "@@ -2908,14 +2908,15 @@ void ProcessMessage(\n                 // We will continue to reject this tx since it has rejected\n                 // parents so avoid re-requesting it from other peers.\n                 recentRejects->insert(tx.GetHash());\n+                recentRejects->insert(tx.GetWitnessHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r457775247",
      "id" : 457775247,
      "in_reply_to_id" : 457768442,
      "line" : 3022,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc3NTI0Nw==",
      "original_commit_id" : "8e68fc246d09f1e6c6dfa8c676969d97c2eb4334",
      "original_line" : 2911,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 465,
      "pull_request_review_id" : 452056852,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-21T01:14:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/457775247",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r458229569"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/458229569"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think `std::map::operator[]` returns a reference to the value if the key already exists ? You might broadcast a transaction with different witnesses and ideally you should track all of them. I don't know any application relying on this behavior though so maybe not worthy to fix.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-21T16:27:55Z",
      "diff_hunk" : "@@ -734,19 +737,19 @@ class CTxMemPool\n     size_t DynamicMemoryUsage() const;\n \n     /** Adds a transaction to the unbroadcast set */\n-    void AddUnbroadcastTx(const uint256& txid) {\n+    void AddUnbroadcastTx(const uint256& txid, const uint256& wtxid) {\n         LOCK(cs);\n         // Sanity Check: the transaction should also be in the mempool\n         if (exists(txid)) {\n-            m_unbroadcast_txids.insert(txid);\n+            m_unbroadcast_txids[txid] = wtxid;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r458229569",
      "id" : 458229569,
      "line" : 744,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIyOTU2OQ==",
      "original_commit_id" : "c7eb6b4f1fe5bd76388a023529977674534334a7",
      "original_line" : 744,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : 112,
      "pull_request_review_id" : 452629440,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-21T17:02:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/458229569",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r458383811"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/458383811"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Leaving this as-is.  There are a whole host of other places in our code that would need to change in order to support tracking of multiple transactions with the same txid (wallet, relay logic, etc).",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-21T20:58:42Z",
      "diff_hunk" : "@@ -734,19 +737,19 @@ class CTxMemPool\n     size_t DynamicMemoryUsage() const;\n \n     /** Adds a transaction to the unbroadcast set */\n-    void AddUnbroadcastTx(const uint256& txid) {\n+    void AddUnbroadcastTx(const uint256& txid, const uint256& wtxid) {\n         LOCK(cs);\n         // Sanity Check: the transaction should also be in the mempool\n         if (exists(txid)) {\n-            m_unbroadcast_txids.insert(txid);\n+            m_unbroadcast_txids[txid] = wtxid;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r458383811",
      "id" : 458383811,
      "in_reply_to_id" : 458229569,
      "line" : 744,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM4MzgxMQ==",
      "original_commit_id" : "c7eb6b4f1fe5bd76388a023529977674534334a7",
      "original_line" : 744,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : 112,
      "pull_request_review_id" : 452824126,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-21T20:58:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/458383811",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r458385588"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/458385588"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> We set `fRejectedParents` based on parent's _txid_ in `recentRejects`. If parent has been previously announced and rejected based on wtxid only we won't found it. So we won't add this orphan and may fetch it again. I don't see this case covered in new test ?\r\n\r\nYes, this is an unfortunate problem, but I don't see a way to fix the redownloading of transactions with failed parent without implementing a new p2p protocol to support efficiently communicating the unconfirmed ancestor wtxid's of a given transaction (in order to know whether to reprocess a given transaction).\r\n\r\nNote that before this PR, we have this same problem not just for child transactions of a reject parent, but for _all_ transactions that have witnesses which fail our policy checks.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-21T21:02:06Z",
      "diff_hunk" : "@@ -2908,14 +2908,15 @@ void ProcessMessage(\n                 // We will continue to reject this tx since it has rejected\n                 // parents so avoid re-requesting it from other peers.\n                 recentRejects->insert(tx.GetHash());\n+                recentRejects->insert(tx.GetWitnessHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r458385588",
      "id" : 458385588,
      "in_reply_to_id" : 457768442,
      "line" : 3022,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM4NTU4OA==",
      "original_commit_id" : "8e68fc246d09f1e6c6dfa8c676969d97c2eb4334",
      "original_line" : 2911,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 465,
      "pull_request_review_id" : 452826278,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-21T21:02:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/458385588",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r458442114"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/458442114"
         }
      },
      "author_association" : "MEMBER",
      "body" : "~~In theory we could distinguish whether failure is due to a definitely-not-witness-related reason, and in that case, add both the txid and wtxid to the recentRejects filter. I don't think this accomplishes much, because it won't occur in non-adverserial scenarios, and in adverserial ones, the attacker can just use invalid witnesses if he wants to cause harm with invalid transactions.~~\r\n\r\nEdit: seems the code is already doing that for transactions spending rejected ones.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-21T23:15:09Z",
      "diff_hunk" : "@@ -2908,14 +2908,15 @@ void ProcessMessage(\n                 // We will continue to reject this tx since it has rejected\n                 // parents so avoid re-requesting it from other peers.\n                 recentRejects->insert(tx.GetHash());\n+                recentRejects->insert(tx.GetWitnessHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r458442114",
      "id" : 458442114,
      "in_reply_to_id" : 457768442,
      "line" : 3022,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0MjExNA==",
      "original_commit_id" : "8e68fc246d09f1e6c6dfa8c676969d97c2eb4334",
      "original_line" : 2911,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 465,
      "pull_request_review_id" : 452892369,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-22T01:23:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/458442114",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r458484548"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/458484548"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think we could try to special case the common scenario that we expect to happen at some point: some transaction spending a segwit version 1 output is rejected by (older) software as nonstandard, and then child transactions are relayed and redownloaded from each upgraded peer that announces it because the parent transaction's txid wouldn't be found in the reject filter.  We could improve this behavior by treating failures in `AreInputsStandard()` as indicative of the txid being definitely bad, and therefore add the txid to the reject filter (even though the transaction has a witness).\r\n\r\nI think my preference would be to defer this kind of somewhat-tricky-to-reason-about change to a future PR, since this PR seems ready to me and is already an improvement, but if others feel differently we should discuss.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-22T01:43:48Z",
      "diff_hunk" : "@@ -2908,14 +2908,15 @@ void ProcessMessage(\n                 // We will continue to reject this tx since it has rejected\n                 // parents so avoid re-requesting it from other peers.\n                 recentRejects->insert(tx.GetHash());\n+                recentRejects->insert(tx.GetWitnessHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r458484548",
      "id" : 458484548,
      "in_reply_to_id" : 457768442,
      "line" : 3022,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ4NDU0OA==",
      "original_commit_id" : "8e68fc246d09f1e6c6dfa8c676969d97c2eb4334",
      "original_line" : 2911,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 465,
      "pull_request_review_id" : 452938851,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-22T01:43:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/458484548",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "utACK 0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-22T08:52:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-662330772",
      "id" : 662330772,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2MjMzMDc3Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-22T08:52:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/662330772",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "utACK 0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-22T18:58:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-662628799",
      "id" : 662628799,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2MjYyODc5OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-22T18:58:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/662628799",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Posthumous re-ACK 0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb\r\n\r\nSome follow-ups I'd like:\r\n* List BIP339 support in doc/bips.md\r\n* Re-enable fetching of orphans from wtxid peers (e.g. https://github.com/bitcoin/bitcoin/pull/18044/files#r450687076, see https://github.com/ajtowns/bitcoin/commits/202007-wtxid-orphans).\r\n* Possibly streamline things a bit by having an explicit pair type (bool is_wtxid, uint256 txid_or_wtxid) - possibly just for tx requesting like above, or for more places (finding in the mempool and lookups in various structures would be cleaner with this as well, I think).\r\n\r\nI'll work on that if nobody does it instead, as it'll be hard to rebase #19184 on top of this otherwise.",
      "created_at" : "2020-07-22T19:09:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-662635401",
      "id" : 662635401,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2MjYzNTQwMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-22T19:16:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/662635401",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Can the hashes get a typed wrapper so that the unit256's are e.g. subclassed to WTXID and TXID?",
      "created_at" : "2020-07-22T20:21:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-662676044",
      "id" : 662676044,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2MjY3NjA0NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-22T20:21:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/662676044",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@JeremyRubin I think that's hard, because a portion of the code relies on the fact that the wtxid of a non-witness tx is also its txid.",
      "created_at" : "2020-07-22T20:23:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-662676831",
      "id" : 662676831,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2MjY3NjgzMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-22T20:23:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/662676831",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r459164094"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/459164094"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This issue is only a bandwidth waste and this PR is already a huge improvement on this side, that's all good to defer this to future work, orphan parent handling is already an area known to be improved.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-23T00:59:22Z",
      "diff_hunk" : "@@ -2908,14 +2908,15 @@ void ProcessMessage(\n                 // We will continue to reject this tx since it has rejected\n                 // parents so avoid re-requesting it from other peers.\n                 recentRejects->insert(tx.GetHash());\n+                recentRejects->insert(tx.GetWitnessHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r459164094",
      "id" : 459164094,
      "in_reply_to_id" : 457768442,
      "line" : 3022,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTE2NDA5NA==",
      "original_commit_id" : "8e68fc246d09f1e6c6dfa8c676969d97c2eb4334",
      "original_line" : 2911,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 465,
      "pull_request_review_id" : 453778896,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-23T00:59:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/459164094",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Posthumous Code Review ACK 0a4f142\r\n\r\nAnother follow-up:\r\n* update tracking of multiple transactions with same txid, especially `BroadcastTransaction`, see https://github.com/bitcoin/bitcoin/pull/18044#discussion_r458229569",
      "created_at" : "2020-07-23T01:04:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#issuecomment-662771484",
      "id" : 662771484,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2Mjc3MTQ4NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-23T01:04:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/662771484",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r460495254"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/460495254"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think this change is necessary (or desirable). I guess it was prompted by this comment: https://github.com/bitcoin/bitcoin/pull/18038#discussion_r393293074 , but storing this as a map from txid->wtxid is unnecessary and confusing, since it obfuscates the purpose of this data, which is a *set* of transactions that may need to be rebroadcast.\r\n\r\nThe only place that the wtxid is read from this map is in `ReattemptInitialBroadcast()`, at which point we can fetch the transaction from the mempool (we very nearly do that with `m_mempool.exists()`), and get the wtxid from there.\r\n\r\ncc @amitiuttarwar @ariard ",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-26T08:07:36Z",
      "diff_hunk" : "@@ -549,8 +573,11 @@ class CTxMemPool\n \n     std::vector<indexed_transaction_set::const_iterator> GetSortedDepthAndScore() const EXCLUSIVE_LOCKS_REQUIRED(cs);\n \n-    /** track locally submitted transactions to periodically retry initial broadcast */\n-    std::set<uint256> m_unbroadcast_txids GUARDED_BY(cs);\n+    /**\n+     * track locally submitted transactions to periodically retry initial broadcast\n+     * map of txid -> wtxid\n+     */\n+    std::map<uint256, uint256> m_unbroadcast_txids GUARDED_BY(cs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r460495254",
      "id" : 460495254,
      "line" : 580,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQ5NTI1NA==",
      "original_commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "original_line" : 580,
      "original_position" : 66,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : 66,
      "pull_request_review_id" : 455342192,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-26T08:17:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/460495254",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r460496023"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/460496023"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We shouldn't be indiscriminately taking the address of a return value which may be `nullptr`. I know the same pattern exists in a few other places, but really we should check for existence here before dereferencing the pointer.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-26T08:15:35Z",
      "diff_hunk" : "@@ -1430,11 +1468,17 @@ bool static AlreadyHave(const CInv& inv, const CTxMemPool& mempool) EXCLUSIVE_LO\n     return true;\n }\n \n-void RelayTransaction(const uint256& txid, const CConnman& connman)\n+void RelayTransaction(const uint256& txid, const uint256& wtxid, const CConnman& connman)\n {\n-    connman.ForEachNode([&txid](CNode* pnode)\n+    connman.ForEachNode([&txid, &wtxid](CNode* pnode)\n     {\n-        pnode->PushTxInventory(txid);\n+        AssertLockHeld(cs_main);\n+        CNodeState &state = *State(pnode->GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r460496023",
      "id" : 460496023,
      "line" : 1476,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQ5NjAyMw==",
      "original_commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "original_line" : 1476,
      "original_position" : 216,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 216,
      "pull_request_review_id" : 455342192,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-26T08:17:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/460496023",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r460546336"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/460546336"
         }
      },
      "author_association" : "MEMBER",
      "body" : "My mistake here, effectively you need to announce transactions from the unbroadcast set by wtxid to upgraded peers but as you point out it doesn't mean we need to cache them as a solution.\r\n\r\nMaybe we should precise unbroadcast set semantic wrt same txid, different wtxids, we only guarantee reattempt to the best mempool candidate known for a given txid at the time we call `ReattemptInitialBroadcast`, not insertion (`AddUnbroadcastTx`). https://github.com/bitcoin/bitcoin/pull/18044#discussion_r458229569 isn't an issue.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-26T16:23:25Z",
      "diff_hunk" : "@@ -549,8 +573,11 @@ class CTxMemPool\n \n     std::vector<indexed_transaction_set::const_iterator> GetSortedDepthAndScore() const EXCLUSIVE_LOCKS_REQUIRED(cs);\n \n-    /** track locally submitted transactions to periodically retry initial broadcast */\n-    std::set<uint256> m_unbroadcast_txids GUARDED_BY(cs);\n+    /**\n+     * track locally submitted transactions to periodically retry initial broadcast\n+     * map of txid -> wtxid\n+     */\n+    std::map<uint256, uint256> m_unbroadcast_txids GUARDED_BY(cs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r460546336",
      "id" : 460546336,
      "in_reply_to_id" : 460495254,
      "line" : 580,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDU0NjMzNg==",
      "original_commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "original_line" : 580,
      "original_position" : 66,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : 66,
      "pull_request_review_id" : 455377646,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-26T16:24:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/460546336",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r460704950"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/460704950"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I really think this \"same txid, different wtxid\" thing is a complete red herring. The mempool can only ever be aware of one witness for a transaction, so any attempt to announce the transaction via a different wtxid would fail anyway. As Suhas pointed out earlier (https://github.com/bitcoin/bitcoin/pull/18044#discussion_r458383811), to support tracking multiple witnesses we'd need to make significant changes many of our components. Besides, the unbroadcast set is transactions that we created ourselves, so we're not expecting the witnesses to change.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-27T07:45:49Z",
      "diff_hunk" : "@@ -549,8 +573,11 @@ class CTxMemPool\n \n     std::vector<indexed_transaction_set::const_iterator> GetSortedDepthAndScore() const EXCLUSIVE_LOCKS_REQUIRED(cs);\n \n-    /** track locally submitted transactions to periodically retry initial broadcast */\n-    std::set<uint256> m_unbroadcast_txids GUARDED_BY(cs);\n+    /**\n+     * track locally submitted transactions to periodically retry initial broadcast\n+     * map of txid -> wtxid\n+     */\n+    std::map<uint256, uint256> m_unbroadcast_txids GUARDED_BY(cs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r460704950",
      "id" : 460704950,
      "in_reply_to_id" : 460495254,
      "line" : 580,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDcwNDk1MA==",
      "original_commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "original_line" : 580,
      "original_position" : 66,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : 66,
      "pull_request_review_id" : 455547884,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-27T07:45:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/460704950",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r460713629"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/460713629"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Agree with @jnewbery. There is no real way that we can reasonable start tracking multiple witnesses for the same transaction (either in the mempool or the wallet, ...), so unless this map's storing of wtxid is needed for efficiency, it seems just a set of txid should be sufficient here.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-27T08:02:18Z",
      "diff_hunk" : "@@ -549,8 +573,11 @@ class CTxMemPool\n \n     std::vector<indexed_transaction_set::const_iterator> GetSortedDepthAndScore() const EXCLUSIVE_LOCKS_REQUIRED(cs);\n \n-    /** track locally submitted transactions to periodically retry initial broadcast */\n-    std::set<uint256> m_unbroadcast_txids GUARDED_BY(cs);\n+    /**\n+     * track locally submitted transactions to periodically retry initial broadcast\n+     * map of txid -> wtxid\n+     */\n+    std::map<uint256, uint256> m_unbroadcast_txids GUARDED_BY(cs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r460713629",
      "id" : 460713629,
      "in_reply_to_id" : 460495254,
      "line" : 580,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDcxMzYyOQ==",
      "original_commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "original_line" : 580,
      "original_position" : 66,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : 66,
      "pull_request_review_id" : 455558688,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-27T08:02:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/460713629",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r461325271"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/461325271"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ð®   wow that's a great point @jnewbery. thank you!!\r\n\r\nI thought during implementation I ran into something that prevented me from exclusively having txids on the set, but that evaluation is simply wrong. I've taken a first pass at reverting unbroadcast to a set here: https://github.com/amitiuttarwar/bitcoin/commit/f51cccdd6c97d1b1e45163d56ebd6b7d29a2f587. I'll need to revisit with fresh eyes and then will PR. \r\n\r\nI agree set makes more sense than a map- its simpler, communicates the intent better, and there's no noticeable efficiency gain with the map. Since we check the transaction is the mempool, the difference between map vs set is the difference between calling `CTxMemPool::get` vs `CTxMemPool::exists`. This boils down to `mapTx.find(hash)` vs `mapTx.count(hash)`, which both have log(n) complexity (according to the boost docs I found).",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-28T05:22:49Z",
      "diff_hunk" : "@@ -549,8 +573,11 @@ class CTxMemPool\n \n     std::vector<indexed_transaction_set::const_iterator> GetSortedDepthAndScore() const EXCLUSIVE_LOCKS_REQUIRED(cs);\n \n-    /** track locally submitted transactions to periodically retry initial broadcast */\n-    std::set<uint256> m_unbroadcast_txids GUARDED_BY(cs);\n+    /**\n+     * track locally submitted transactions to periodically retry initial broadcast\n+     * map of txid -> wtxid\n+     */\n+    std::map<uint256, uint256> m_unbroadcast_txids GUARDED_BY(cs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r461325271",
      "id" : 461325271,
      "in_reply_to_id" : 460495254,
      "line" : 580,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTMyNTI3MQ==",
      "original_commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "original_line" : 580,
      "original_position" : 66,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : 66,
      "pull_request_review_id" : 456310334,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-28T05:22:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/461325271",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r461332635"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/461332635"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "@amitiuttarwar mapTX is a multiindex and we use a hashed index not a ordered index so it's O(1) lookup. Not sure exactly how mapTX relates to m_unboardcast_txids though...",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-28T05:46:30Z",
      "diff_hunk" : "@@ -549,8 +573,11 @@ class CTxMemPool\n \n     std::vector<indexed_transaction_set::const_iterator> GetSortedDepthAndScore() const EXCLUSIVE_LOCKS_REQUIRED(cs);\n \n-    /** track locally submitted transactions to periodically retry initial broadcast */\n-    std::set<uint256> m_unbroadcast_txids GUARDED_BY(cs);\n+    /**\n+     * track locally submitted transactions to periodically retry initial broadcast\n+     * map of txid -> wtxid\n+     */\n+    std::map<uint256, uint256> m_unbroadcast_txids GUARDED_BY(cs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r461332635",
      "id" : 461332635,
      "in_reply_to_id" : 460495254,
      "line" : 580,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTMzMjYzNQ==",
      "original_commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "original_line" : 580,
      "original_position" : 66,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : 66,
      "pull_request_review_id" : 456318478,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-28T05:46:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/461332635",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r461359274"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/461359274"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@amitiuttarwar that patch looks correct from a quick skim. I'll review fully once you open a PR.\r\n\r\nAs @JeremyRubin points out, we're using a `boost::multi_index::hashed_unique` index for the wtxid index, which has constant time search/retrieval.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-28T06:56:42Z",
      "diff_hunk" : "@@ -549,8 +573,11 @@ class CTxMemPool\n \n     std::vector<indexed_transaction_set::const_iterator> GetSortedDepthAndScore() const EXCLUSIVE_LOCKS_REQUIRED(cs);\n \n-    /** track locally submitted transactions to periodically retry initial broadcast */\n-    std::set<uint256> m_unbroadcast_txids GUARDED_BY(cs);\n+    /**\n+     * track locally submitted transactions to periodically retry initial broadcast\n+     * map of txid -> wtxid\n+     */\n+    std::map<uint256, uint256> m_unbroadcast_txids GUARDED_BY(cs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r461359274",
      "id" : 461359274,
      "in_reply_to_id" : 460495254,
      "line" : 580,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM1OTI3NA==",
      "original_commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "original_line" : 580,
      "original_position" : 66,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : 66,
      "pull_request_review_id" : 456350681,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-28T06:56:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/461359274",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r463532611"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/463532611"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The `else if (tx.HasWitness() && RecursiveDynamicUsage(*ptx) < 100000)` block below is now dead code and should be removed (anything that doesn't go in this if branch is `TX_WITNESS_STRIPPED` and therefore doesn't have a witness)",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-31T10:27:24Z",
      "diff_hunk" : "@@ -2899,15 +3014,30 @@ void ProcessMessage(\n                 LogPrint(BCLog::MEMPOOL, \"not keeping orphan with rejected parents %s\\n\",tx.GetHash().ToString());\n                 // We will continue to reject this tx since it has rejected\n                 // parents so avoid re-requesting it from other peers.\n+                // Here we add both the txid and the wtxid, as we know that\n+                // regardless of what witness is provided, we will not accept\n+                // this, so we don't need to allow for redownload of this txid\n+                // from any of our non-wtxidrelay peers.\n                 recentRejects->insert(tx.GetHash());\n+                recentRejects->insert(tx.GetWitnessHash());\n             }\n         } else {\n-            if (!tx.HasWitness() && state.GetResult() != TxValidationResult::TX_WITNESS_MUTATED) {\n-                // Do not use rejection cache for witness transactions or\n-                // witness-stripped transactions, as they can have been malleated.\n-                // See https://github.com/bitcoin/bitcoin/issues/8279 for details.\n+            if (state.GetResult() != TxValidationResult::TX_WITNESS_STRIPPED) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r463532611",
      "id" : 463532611,
      "line" : 3025,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzUzMjYxMQ==",
      "original_commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "original_line" : 3025,
      "original_position" : 472,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 472,
      "pull_request_review_id" : 459073764,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-31T10:27:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/463532611",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r463820204"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/463820204"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Clarification: does moving this out of the try block have any behavior change? Is it possible that a semi-corrupt unbroadcast_txids would partially deserialize and then have only some entries?",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-31T20:28:40Z",
      "diff_hunk" : "@@ -5083,19 +5083,22 @@ bool LoadMempool(CTxMemPool& pool)\n         }\n \n         // TODO: remove this try except in v0.22\n+        std::map<uint256, uint256> unbroadcast_txids;\n         try {\n-          std::set<uint256> unbroadcast_txids;\n           file >> unbroadcast_txids;\n           unbroadcast = unbroadcast_txids.size();\n-\n-          for (const auto& txid : unbroadcast_txids) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r463820204",
      "id" : 463820204,
      "line" : 5091,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzgyMDIwNA==",
      "original_commit_id" : "c7eb6b4f1fe5bd76388a023529977674534334a7",
      "original_line" : 5091,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 19,
      "pull_request_review_id" : 459450889,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-31T21:06:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/463820204",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r463820479"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/463820479"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Suggest: clearing unbroadcast_txids here in case has garbage data.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-31T20:29:22Z",
      "diff_hunk" : "@@ -5083,19 +5083,22 @@ bool LoadMempool(CTxMemPool& pool)\n         }\n \n         // TODO: remove this try except in v0.22\n+        std::map<uint256, uint256> unbroadcast_txids;\n         try {\n-          std::set<uint256> unbroadcast_txids;\n           file >> unbroadcast_txids;\n           unbroadcast = unbroadcast_txids.size();\n-\n-          for (const auto& txid : unbroadcast_txids) {\n-            pool.AddUnbroadcastTx(txid);\n-          }\n         } catch (const std::exception&) {\n           // mempool.dat files created prior to v0.21 will not have an",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r463820479",
      "id" : 463820479,
      "line" : 5091,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzgyMDQ3OQ==",
      "original_commit_id" : "c7eb6b4f1fe5bd76388a023529977674534334a7",
      "original_line" : 5091,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 23,
      "pull_request_review_id" : 459450889,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-31T21:06:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/463820479",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r463821665"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/463821665"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Is this correct? Should this transaction get queued somewhere for rebroadcasting? Or is it a known precondition that because it failed to get into the mempool before this line it will fail again?",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-31T20:32:09Z",
      "diff_hunk" : "@@ -5083,19 +5083,22 @@ bool LoadMempool(CTxMemPool& pool)\n         }\n \n         // TODO: remove this try except in v0.22\n+        std::map<uint256, uint256> unbroadcast_txids;\n         try {\n-          std::set<uint256> unbroadcast_txids;\n           file >> unbroadcast_txids;\n           unbroadcast = unbroadcast_txids.size();\n-\n-          for (const auto& txid : unbroadcast_txids) {\n-            pool.AddUnbroadcastTx(txid);\n-          }\n         } catch (const std::exception&) {\n           // mempool.dat files created prior to v0.21 will not have an\n           // unbroadcast set. No need to log a failure if parsing fails here.\n         }\n-\n+        for (const auto& elem : unbroadcast_txids) {\n+            // Don't add unbroadcast transactions that didn't get back into the\n+            // mempool.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r463821665",
      "id" : 463821665,
      "line" : 5096,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzgyMTY2NQ==",
      "original_commit_id" : "c7eb6b4f1fe5bd76388a023529977674534334a7",
      "original_line" : 5096,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 29,
      "pull_request_review_id" : 459450889,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-31T21:06:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/463821665",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r463822371"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/463822371"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I can't think of why we'd want it in the unbroadcast if it didn't make it back in the mempool, but just double checking.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-31T20:33:43Z",
      "diff_hunk" : "@@ -5083,19 +5083,22 @@ bool LoadMempool(CTxMemPool& pool)\n         }\n \n         // TODO: remove this try except in v0.22\n+        std::map<uint256, uint256> unbroadcast_txids;\n         try {\n-          std::set<uint256> unbroadcast_txids;\n           file >> unbroadcast_txids;\n           unbroadcast = unbroadcast_txids.size();\n-\n-          for (const auto& txid : unbroadcast_txids) {\n-            pool.AddUnbroadcastTx(txid);\n-          }\n         } catch (const std::exception&) {\n           // mempool.dat files created prior to v0.21 will not have an\n           // unbroadcast set. No need to log a failure if parsing fails here.\n         }\n-\n+        for (const auto& elem : unbroadcast_txids) {\n+            // Don't add unbroadcast transactions that didn't get back into the\n+            // mempool.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r463822371",
      "id" : 463822371,
      "in_reply_to_id" : 463821665,
      "line" : 5096,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzgyMjM3MQ==",
      "original_commit_id" : "c7eb6b4f1fe5bd76388a023529977674534334a7",
      "original_line" : 5096,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 29,
      "pull_request_review_id" : 459450889,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-31T21:06:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/463822371",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r463827102"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/463827102"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This line relies on the idea that it is cryptographically hard to find a TXID such that another WTXID (for a different txid) is the same. It's not clear to me that this is provably true because there may be serialization ambiguity.\r\n\r\nMy preference would be to have two different mapRelays which have a strongly typed key.\r\n\r\nIt's probably low risk, but maybe worth documenting or at least somehow guaranteeing there can never be ambiguity. I don't think there can be? Because \r\n\r\n```\r\nDefinition of txid remains unchanged: the double SHA256 of the traditional serialization format:\r\n\r\n  [nVersion][txins][txouts][nLockTime]\r\n  \r\n\r\nA new wtxid is defined: the double SHA256 of the new serialization with witness data:\r\n\r\n  [nVersion][marker][flag][txins][txouts][witness][nLockTime]\r\n```  \r\n\r\nbut it's not clear to me that with some setting of marker and flag you could cause an overlap.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-31T20:45:28Z",
      "diff_hunk" : "@@ -4246,6 +4246,11 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n                             if (ret.second) {\n                                 vRelayExpiration.push_back(std::make_pair(nNow + std::chrono::microseconds{RELAY_TX_CACHE_TIME}.count(), ret.first));\n                             }\n+                            // Add wtxid-based lookup into mapRelay as well, so that peers can request by wtxid\n+                            auto ret2 = mapRelay.emplace(ret.first->second->GetWitnessHash(), ret.first->second);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r463827102",
      "id" : 463827102,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzgyNzEwMg==",
      "original_commit_id" : "08b39955ec7f84e835ab0b1366f0dd28dfd6ce03",
      "original_line" : 4250,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 459450889,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-31T21:06:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/463827102",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r463831088"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/463831088"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Because presumably WTXID becomes the primary lookup method, someone may prefer to in the future switch the roles of mapOrphanTransactions and g_orphans_by_wtxid so that the g_orphans_by_wtxid is the owning map. This is a small performance win avoiding an extra iterator lookup.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-31T20:51:38Z",
      "diff_hunk" : "@@ -151,6 +151,7 @@ struct COrphanTx {\n };\n RecursiveMutex g_cs_orphans;\n std::map<uint256, COrphanTx> mapOrphanTransactions GUARDED_BY(g_cs_orphans);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r463831088",
      "id" : 463831088,
      "line" : 155,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzgzMTA4OA==",
      "original_commit_id" : "85c78d54af462996a0bca6cf97f91e1aa8778ae8",
      "original_line" : 153,
      "original_position" : 3,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 12,
      "pull_request_review_id" : 459450889,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-31T21:06:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/463831088",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r463851414"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/463851414"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "confirmed that  not exists tx tx2. txid(tx) == wtxid(tx2) && tx != tx2\r\n\r\n```\r\n[7/31/20 14:09] <jeremyrubin> sipa: is this proven: not exists tx tx2. txid(tx) == wtxid(tx2) && tx != tx2\r\n[7/31/20 14:10] <sipa> jeremyrubin: yes, assuming double-sha256 collision resistance that statement is equivalent to ser_without_witness(tx) == ser_with_witness(tx2)\r\n[7/31/20 14:11] <sipa> either both tx and tx2 don't have a witness, and the statement is obviously false\r\n[7/31/20 14:11] <sipa> or tx2 has a witness, in which case the serialization definitely differs, due to the flag byte\r\n[7/31/20 14:13] <jeremyrubin> but it's not possible in tx2 that the flag + marker can be read as the length field for the txins?\r\n[7/31/20 14:13] <jeremyrubin> because a leading 0 byte means it can't be a length right?\r\n[7/31/20 14:13] <jeremyrubin> in which case it would be marker and not flag that guarantees uniqueness?\r\n[7/31/20 14:15] <sipa> a valid transactions cannot have 0 inputs\r\n[7/31/20 14:15] <sipa> the witness serialization is intended to be unambiguously different from the old serialization\r\n[7/31/20 14:15] <sipa> (except that we later discovered that people do pass around transactions with 0 inputs, where things break... but that's not relevant for valid network transactions)(\r\n[7/31/20 14:17] <jeremyrubin> gotcha. and the unambiguity is because it's a compactsize field preceding the vIn\r\n[7/31/20 14:18] <jeremyrubin> so 0 is always read as a 1 byte number in any context\r\n[7/31/20 14:18] <-- proofofkeags (~proofofke@174-29-8-246.hlrn.qwest.net) has left this server (Remote host closed the connection).\r\n[7/31/20 14:19] <sipa> indeed\r\n```",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-07-31T21:20:06Z",
      "diff_hunk" : "@@ -4246,6 +4246,11 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n                             if (ret.second) {\n                                 vRelayExpiration.push_back(std::make_pair(nNow + std::chrono::microseconds{RELAY_TX_CACHE_TIME}.count(), ret.first));\n                             }\n+                            // Add wtxid-based lookup into mapRelay as well, so that peers can request by wtxid\n+                            auto ret2 = mapRelay.emplace(ret.first->second->GetWitnessHash(), ret.first->second);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r463851414",
      "id" : 463851414,
      "in_reply_to_id" : 463827102,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg1MTQxNA==",
      "original_commit_id" : "08b39955ec7f84e835ab0b1366f0dd28dfd6ce03",
      "original_line" : 4250,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 459483774,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-31T21:20:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/463851414",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r464076378"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/464076378"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I got really confused reviewing master's test. The surrounding test is dead, with incorrect comments asserting that we are checking for blinding. Seems this was deleted just to make the test pass :grimacing: ",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-08-02T13:03:39Z",
      "diff_hunk" : "@@ -1297,8 +1321,6 @@ def test_tx_relay_after_segwit_activation(self):\n         # Node will not be blinded to the transaction\n         self.std_node.announce_tx_and_wait_for_getdata(tx3)\n         test_transaction_acceptance(self.nodes[1], self.std_node, tx3, True, False, 'tx-size')\n-        self.std_node.announce_tx_and_wait_for_getdata(tx3)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r464076378",
      "id" : 464076378,
      "line" : 1300,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDA3NjM3OA==",
      "original_commit_id" : "8d8099e97ab8af2126f6fbd223fbd82c52f2e85e",
      "original_line" : 1300,
      "original_position" : 95,
      "original_start_line" : null,
      "path" : "test/functional/p2p_segwit.py",
      "position" : 96,
      "pull_request_review_id" : 459647729,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-02T13:03:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/464076378",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r476002698"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/476002698"
         }
      },
      "author_association" : "MEMBER",
      "body" : "the try block was introduced to specifically catch the error when upgrading around not having an unbroadcast set written to disk. so I think having the initialization & iteration separate actually captures that intent better. \r\n\r\nbut lmk if you think of any specific ways this logic could be problematic",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-08-25T00:34:03Z",
      "diff_hunk" : "@@ -5083,19 +5083,22 @@ bool LoadMempool(CTxMemPool& pool)\n         }\n \n         // TODO: remove this try except in v0.22\n+        std::map<uint256, uint256> unbroadcast_txids;\n         try {\n-          std::set<uint256> unbroadcast_txids;\n           file >> unbroadcast_txids;\n           unbroadcast = unbroadcast_txids.size();\n-\n-          for (const auto& txid : unbroadcast_txids) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r476002698",
      "id" : 476002698,
      "in_reply_to_id" : 463820204,
      "line" : 5091,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjAwMjY5OA==",
      "original_commit_id" : "c7eb6b4f1fe5bd76388a023529977674534334a7",
      "original_line" : 5091,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 19,
      "pull_request_review_id" : 474015507,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-25T00:34:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/476002698",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r476011194"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/476011194"
         }
      },
      "author_association" : "MEMBER",
      "body" : "the unbroadcast set should always be a subset of the mempool. it just maintains txids, so we don't have the capability to do much if its not found. \r\n\r\n> Should this transaction get queued somewhere for rebroadcasting?\r\n\r\ndo you mean re-attempt mempool submission? bc we def wouldn't want to broadcast or rebroadcast a transaction we don't have in our mempool!",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-08-25T00:46:18Z",
      "diff_hunk" : "@@ -5083,19 +5083,22 @@ bool LoadMempool(CTxMemPool& pool)\n         }\n \n         // TODO: remove this try except in v0.22\n+        std::map<uint256, uint256> unbroadcast_txids;\n         try {\n-          std::set<uint256> unbroadcast_txids;\n           file >> unbroadcast_txids;\n           unbroadcast = unbroadcast_txids.size();\n-\n-          for (const auto& txid : unbroadcast_txids) {\n-            pool.AddUnbroadcastTx(txid);\n-          }\n         } catch (const std::exception&) {\n           // mempool.dat files created prior to v0.21 will not have an\n           // unbroadcast set. No need to log a failure if parsing fails here.\n         }\n-\n+        for (const auto& elem : unbroadcast_txids) {\n+            // Don't add unbroadcast transactions that didn't get back into the\n+            // mempool.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r476011194",
      "id" : 476011194,
      "in_reply_to_id" : 463821665,
      "line" : 5096,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjAxMTE5NA==",
      "original_commit_id" : "c7eb6b4f1fe5bd76388a023529977674534334a7",
      "original_line" : 5096,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 29,
      "pull_request_review_id" : 474019167,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-25T00:46:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/476011194",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r476015987"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/476015987"
         }
      },
      "author_association" : "MEMBER",
      "body" : "looking into this- is there really a way that the CAutoFile `>>` operator could cause a silent/partial failure? as I mentioned previously the idea of this try catch is just for a smooth upgrade. To elaborate further: so we don't print `Failed to deserialize mempool data on disk: %s. Continuing anyway.\"` when everything actually went fine. the current intention is to remove this in 0.22, so if there's a possibility for `unbroadcast_txids` to have garbage data written, I'd like to think this through more carefully to find a long term solution. ",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-08-25T00:53:45Z",
      "diff_hunk" : "@@ -5083,19 +5083,22 @@ bool LoadMempool(CTxMemPool& pool)\n         }\n \n         // TODO: remove this try except in v0.22\n+        std::map<uint256, uint256> unbroadcast_txids;\n         try {\n-          std::set<uint256> unbroadcast_txids;\n           file >> unbroadcast_txids;\n           unbroadcast = unbroadcast_txids.size();\n-\n-          for (const auto& txid : unbroadcast_txids) {\n-            pool.AddUnbroadcastTx(txid);\n-          }\n         } catch (const std::exception&) {\n           // mempool.dat files created prior to v0.21 will not have an",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r476015987",
      "id" : 476015987,
      "in_reply_to_id" : 463820479,
      "line" : 5091,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjAxNTk4Nw==",
      "original_commit_id" : "c7eb6b4f1fe5bd76388a023529977674534334a7",
      "original_line" : 5091,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 23,
      "pull_request_review_id" : 474021320,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-25T00:53:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/476015987",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r476028056"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/476028056"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes I believe so? Fortunately for std::map we deserialize an element and then insert it into the map, but is a possibility that we say that there should be 10 elements and there are only 5 elements, or there are 5 elements and their are actually 10. In the event the file is corrupt, we should likely treat it as if the entire thing is corrupt, rather than continuing to process.\r\n\r\nPerhaps we should add an exception to throw from Unserialize if there are not the correct amount of entries?\r\n\r\n\r\n\r\nI'm not sure to the degree we need to worry about files on our own local being corrupt, and there are other forms of corruption that can occur. But because it is a behavior change, I'm noting it.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-08-25T01:12:02Z",
      "diff_hunk" : "@@ -5083,19 +5083,22 @@ bool LoadMempool(CTxMemPool& pool)\n         }\n \n         // TODO: remove this try except in v0.22\n+        std::map<uint256, uint256> unbroadcast_txids;\n         try {\n-          std::set<uint256> unbroadcast_txids;\n           file >> unbroadcast_txids;\n           unbroadcast = unbroadcast_txids.size();\n-\n-          for (const auto& txid : unbroadcast_txids) {\n-            pool.AddUnbroadcastTx(txid);\n-          }\n         } catch (const std::exception&) {\n           // mempool.dat files created prior to v0.21 will not have an",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r476028056",
      "id" : 476028056,
      "in_reply_to_id" : 463820479,
      "line" : 5091,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjAyODA1Ng==",
      "original_commit_id" : "c7eb6b4f1fe5bd76388a023529977674534334a7",
      "original_line" : 5091,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 23,
      "pull_request_review_id" : 474026936,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-25T01:12:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/476028056",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r476029910"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/476029910"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "to be clear the issue only comes up when you don't have enough elements or when you have a half element presently.",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-08-25T01:14:51Z",
      "diff_hunk" : "@@ -5083,19 +5083,22 @@ bool LoadMempool(CTxMemPool& pool)\n         }\n \n         // TODO: remove this try except in v0.22\n+        std::map<uint256, uint256> unbroadcast_txids;\n         try {\n-          std::set<uint256> unbroadcast_txids;\n           file >> unbroadcast_txids;\n           unbroadcast = unbroadcast_txids.size();\n-\n-          for (const auto& txid : unbroadcast_txids) {\n-            pool.AddUnbroadcastTx(txid);\n-          }\n         } catch (const std::exception&) {\n           // mempool.dat files created prior to v0.21 will not have an",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r476029910",
      "id" : 476029910,
      "in_reply_to_id" : 463820479,
      "line" : 5091,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjAyOTkxMA==",
      "original_commit_id" : "c7eb6b4f1fe5bd76388a023529977674534334a7",
      "original_line" : 5091,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 23,
      "pull_request_review_id" : 474027786,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-25T01:14:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/476029910",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r476033953"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/476033953"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "yes. it's possible that we may want to resubmit it to the mempool if it was previously in our mempool. What changed to cause it to no longer be accepted?",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-08-25T01:21:01Z",
      "diff_hunk" : "@@ -5083,19 +5083,22 @@ bool LoadMempool(CTxMemPool& pool)\n         }\n \n         // TODO: remove this try except in v0.22\n+        std::map<uint256, uint256> unbroadcast_txids;\n         try {\n-          std::set<uint256> unbroadcast_txids;\n           file >> unbroadcast_txids;\n           unbroadcast = unbroadcast_txids.size();\n-\n-          for (const auto& txid : unbroadcast_txids) {\n-            pool.AddUnbroadcastTx(txid);\n-          }\n         } catch (const std::exception&) {\n           // mempool.dat files created prior to v0.21 will not have an\n           // unbroadcast set. No need to log a failure if parsing fails here.\n         }\n-\n+        for (const auto& elem : unbroadcast_txids) {\n+            // Don't add unbroadcast transactions that didn't get back into the\n+            // mempool.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r476033953",
      "id" : 476033953,
      "in_reply_to_id" : 463821665,
      "line" : 5096,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjAzMzk1Mw==",
      "original_commit_id" : "c7eb6b4f1fe5bd76388a023529977674534334a7",
      "original_line" : 5096,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 29,
      "pull_request_review_id" : 474029757,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-25T01:21:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/476033953",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r483868162"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483868162"
         }
      },
      "author_association" : "MEMBER",
      "body" : "addressed in https://github.com/bitcoin/bitcoin/pull/19879/commits/fc66d0a65cdc52a3b259effe0c29b5eafb1b5ff5, #19879 ",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-09-04T22:28:25Z",
      "diff_hunk" : "@@ -1430,11 +1468,17 @@ bool static AlreadyHave(const CInv& inv, const CTxMemPool& mempool) EXCLUSIVE_LO\n     return true;\n }\n \n-void RelayTransaction(const uint256& txid, const CConnman& connman)\n+void RelayTransaction(const uint256& txid, const uint256& wtxid, const CConnman& connman)\n {\n-    connman.ForEachNode([&txid](CNode* pnode)\n+    connman.ForEachNode([&txid, &wtxid](CNode* pnode)\n     {\n-        pnode->PushTxInventory(txid);\n+        AssertLockHeld(cs_main);\n+        CNodeState &state = *State(pnode->GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r483868162",
      "id" : 483868162,
      "in_reply_to_id" : 460496023,
      "line" : 1476,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg2ODE2Mg==",
      "original_commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "original_line" : 1476,
      "original_position" : 216,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 216,
      "pull_request_review_id" : 482994769,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-04T22:28:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483868162",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r483868419"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483868419"
         }
      },
      "author_association" : "MEMBER",
      "body" : "reverted to set in https://github.com/bitcoin/bitcoin/pull/19879/commits/cb79b9dbf4cd06e17c8c65b36bf15c3ea2641de4, #19879 ",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-09-04T22:29:34Z",
      "diff_hunk" : "@@ -549,8 +573,11 @@ class CTxMemPool\n \n     std::vector<indexed_transaction_set::const_iterator> GetSortedDepthAndScore() const EXCLUSIVE_LOCKS_REQUIRED(cs);\n \n-    /** track locally submitted transactions to periodically retry initial broadcast */\n-    std::set<uint256> m_unbroadcast_txids GUARDED_BY(cs);\n+    /**\n+     * track locally submitted transactions to periodically retry initial broadcast\n+     * map of txid -> wtxid\n+     */\n+    std::map<uint256, uint256> m_unbroadcast_txids GUARDED_BY(cs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r483868419",
      "id" : 483868419,
      "in_reply_to_id" : 460495254,
      "line" : 580,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg2ODQxOQ==",
      "original_commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "original_line" : 580,
      "original_position" : 66,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : 66,
      "pull_request_review_id" : 482995065,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-04T22:29:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483868419",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r483868519"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483868519"
         }
      },
      "author_association" : "MEMBER",
      "body" : "addressed in: https://github.com/bitcoin/bitcoin/pull/19879/commits/125c0381266e0e05a408f8e1818501ab73d29110, #19879 ",
      "commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "created_at" : "2020-09-04T22:29:59Z",
      "diff_hunk" : "@@ -2899,15 +3014,30 @@ void ProcessMessage(\n                 LogPrint(BCLog::MEMPOOL, \"not keeping orphan with rejected parents %s\\n\",tx.GetHash().ToString());\n                 // We will continue to reject this tx since it has rejected\n                 // parents so avoid re-requesting it from other peers.\n+                // Here we add both the txid and the wtxid, as we know that\n+                // regardless of what witness is provided, we will not accept\n+                // this, so we don't need to allow for redownload of this txid\n+                // from any of our non-wtxidrelay peers.\n                 recentRejects->insert(tx.GetHash());\n+                recentRejects->insert(tx.GetWitnessHash());\n             }\n         } else {\n-            if (!tx.HasWitness() && state.GetResult() != TxValidationResult::TX_WITNESS_MUTATED) {\n-                // Do not use rejection cache for witness transactions or\n-                // witness-stripped transactions, as they can have been malleated.\n-                // See https://github.com/bitcoin/bitcoin/issues/8279 for details.\n+            if (state.GetResult() != TxValidationResult::TX_WITNESS_STRIPPED) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18044#discussion_r483868519",
      "id" : 483868519,
      "in_reply_to_id" : 463532611,
      "line" : 3025,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg2ODUxOQ==",
      "original_commit_id" : "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
      "original_line" : 3025,
      "original_position" : 472,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 472,
      "pull_request_review_id" : 482995162,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-04T22:29:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483868519",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   }
]
