[
   {
      "author_association" : "MEMBER",
      "body" : "ACK 891b0ee0167dbc7c3d149da92bf987e18d383fc2\r\n\r\nConfirms this fixes #18075",
      "created_at" : "2020-02-10T17:23:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18067#issuecomment-584235535",
      "id" : 584235535,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18067",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NDIzNTUzNQ==",
      "updated_at" : "2020-02-10T17:23:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/584235535",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Tested ACK 891b0ee. Thanks for adding all the clarifications and `scriptpubkeyman_tests`.\r\n\r\nSo IIUC the reason we didn't see addresses added with `addmultisigaddress` in older wallets, is that `AddAndGetMultisigDestination` calls `AddAndGetDestinationForScript` which in turn called `AddCScript` on the multisig p2sh script, but _not the public keys and private keys_. Without those keys it's considered `ISMINE_NO`. When `CanProvide` looks at the P2SH address, it calls `IsMine` which calls `IsMineInner` with `recurse_scripthash = true`. Starting at the TOP level `IsMineInner` it identifies the address as `TX_SCRIPTHASH`. It would then try to find the script and run it through `IsMineInner` at the `IsMineSigVersion::P2SH` level. There it would be recognised as a `TX_MULTISIG`, which requires _all_ (private) keys, but we have none (or maybe one in a more realistic wallet).\r\n\r\nI'm still not entirely clear what the workaround in 4a7e43e8460127a40a7895519587399feff3b682 did other than \"pass the tests\", but it clearly doesn't solve the above, since it still doesn't add (private) keys.\r\n\r\nIn this PR `CanProvide` uses `recurse_scripthash = false` in `IsMineInner`, and we modified that to consider a `TX_SCRIPTHASH` or `TX_WITNESS_V0_SCRIPTHASH` to be `SPENDABLE`.\r\n\r\nMeanwhile the RPC uses `pwallet->IsMine(dest)` which uses the original \"need all keys\" behaviour under `recurse_scripthash = true`. So we slightly expand what's covered by `CanProvide` without adding stuff to the wallet.\r\n\r\n@sipa does this many any sense?",
      "created_at" : "2020-02-11T20:26:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18067#issuecomment-584834871",
      "id" : 584834871,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18067",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NDgzNDg3MQ==",
      "updated_at" : "2020-02-11T20:27:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/584834871",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Would be nice to rebase and cherry-pick Sjors@bacf559 into this",
      "created_at" : "2020-02-12T14:21:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18067#issuecomment-585227568",
      "id" : 585227568,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18067",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NTIyNzU2OA==",
      "updated_at" : "2020-02-12T14:21:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/585227568",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased 891b0ee0167dbc7c3d149da92bf987e18d383fc2 -> a304a3632f0437f4d0f04589a2200e2da91624a7 ([`pr/provide.1`](https://github.com/ryanofsky/bitcoin/commits/pr/provide.1) -> [`pr/provide.2`](https://github.com/ryanofsky/bitcoin/commits/pr/provide.2), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/provide.1-rebase..pr/provide.2)) on top of #12134, also editing the mapScripts comment and cherry-picking Sjors' test commit\r\n\r\nThank you Sjors for the great test case and bug description in https://github.com/bitcoin/bitcoin/pull/18067#issuecomment-584834871! I'm really glad to see the test framework in #12134 merged, too.\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/18067#issuecomment-584834871\r\n> I'm still not entirely clear what the workaround in [4a7e43e](https://github.com/bitcoin/bitcoin/commit/4a7e43e8460127a40a7895519587399feff3b682) did other than \"pass the tests\", but it clearly doesn't solve the above, since it still doesn't add (private) keys.\r\n\r\nTheÂ reason why the workaround in 4a7e43e8460127a40a7895519587399feff3b682 was able to mask the problem is because of this condition in `LegacyScriptPubKeyMan::CanProvide`:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/2bdc476d4d23256d8396bb9051a511f540d87392/src/wallet/scriptpubkeyman.cpp#L482-L484\r\n\r\nThe first commit in this PR drops this condition so it is breaking the workaround at the same time as making the workaround unnecessary by fixing the bug.\r\n\r\nI was a little on the fence about whether to remove this condition, but I think it's better not to have it, so `CanProvide` just wraps the `IsMine` and `ProduceSignature` code instead of trying to be its own third IsMine implementation.",
      "created_at" : "2020-02-12T18:39:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18067#issuecomment-585355711",
      "id" : 585355711,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18067",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NTM1NTcxMQ==",
      "updated_at" : "2020-02-12T18:39:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/585355711",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "re-ACK a304a3632f0437f4d0f04589a2200e2da91624a7 (rebase, slight text changes and my test)",
      "created_at" : "2020-02-12T19:54:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18067#issuecomment-585388656",
      "id" : 585388656,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18067",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NTM4ODY1Ng==",
      "updated_at" : "2020-02-12T19:54:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/585388656",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "re-ACK a304a3632f0437f4d0f04589a2200e2da91624a7",
      "created_at" : "2020-02-12T20:23:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18067#issuecomment-585400282",
      "id" : 585400282,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18067",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NTQwMDI4Mg==",
      "updated_at" : "2020-02-12T20:23:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/585400282",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   }
]
