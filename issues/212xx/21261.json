{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "MEMBER",
   "body" : "Continuing the work in #20197 and #20685, this pull updates and abstracts our inbound eviction protection to make it fully ratio-based and easily extensible to peers connected via high-latency privacy networks that we newly support, like I2P and perhaps others soon, as these peers are disadvantaged by the latency criteria of our eviction logic.\r\n\r\nIt then adds eviction protection for peers connected over I2P.  As described in https://github.com/bitcoin/bitcoin/pull/20685#issuecomment-767486499, we've observed over the past few months that I2P peers have a min ping latency similar to or greater than that of onion peers.\r\n\r\nThe algorithm is a basically a multi-pass knapsack:\r\n\r\n- Count the number of eviction candidates in each of the disadvantaged\r\n  privacy networks.\r\n\r\n- Sort the networks from lower to higher candidate counts, so that\r\n  a network with fewer candidates will have the first opportunity\r\n  for any unused slots remaining from the previous iteration.  In\r\n  the case of a tie in candidate counts, priority is given by array\r\n  member order from first to last, guesstimated to favor more unusual\r\n  networks.\r\n\r\n- Iterate through the networks in this order.  On each iteration,\r\n  allocate each network an equal number of protected slots targeting\r\n  a total number of candidates to protect, provided any slots remain\r\n  in the knapsack.\r\n\r\n- Protect the candidates in that network having the longest uptime,\r\n  if any in that network are present.\r\n\r\n- Continue iterating as long as we have non-allocated slots\r\n  remaining and candidates available to protect.\r\n\r\nThe goal of this logic is to favorise the diversity of our peer connections.\r\n\r\nThe individual commit messages describe each change in more detail.\r\n\r\nSpecial thank you to Vasil Dimov for the excellent review feedback and the algorithm improvement that made this change much better than it would have been otherwise. Thanks also to Antoine Riard, whose review feedback nudged this change to protect disadvantaged networks having fewer, rather than more, eviction candidates.",
   "closed_at" : "2021-06-14T13:05:18Z",
   "closed_by" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
      "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
      "followers_url" : "https://api.github.com/users/laanwj/followers",
      "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/laanwj",
      "id" : 126646,
      "login" : "laanwj",
      "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
      "organizations_url" : "https://api.github.com/users/laanwj/orgs",
      "received_events_url" : "https://api.github.com/users/laanwj/received_events",
      "repos_url" : "https://api.github.com/users/laanwj/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/laanwj"
   },
   "comments" : 13,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21261/comments",
   "created_at" : "2021-02-22T00:29:47Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21261/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/21261",
   "id" : 812995502,
   "labels" : [
      {
         "color" : "006b75",
         "default" : false,
         "description" : null,
         "id" : 98298007,
         "name" : "P2P",
         "node_id" : "MDU6TGFiZWw5ODI5ODAwNw==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/P2P"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21261/labels{/name}",
   "locked" : false,
   "milestone" : {
      "closed_at" : null,
      "closed_issues" : 52,
      "created_at" : "2020-04-25T00:14:49Z",
      "creator" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      },
      "description" : "",
      "due_on" : null,
      "html_url" : "https://github.com/bitcoin/bitcoin/milestone/47",
      "id" : 5347322,
      "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/milestones/47/labels",
      "node_id" : "MDk6TWlsZXN0b25lNTM0NzMyMg==",
      "number" : 47,
      "open_issues" : 15,
      "state" : "open",
      "title" : "22.0",
      "updated_at" : "2021-06-14T13:05:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/milestones/47"
   },
   "node_id" : "MDExOlB1bGxSZXF1ZXN0NTc3MjEzMzUz",
   "number" : 21261,
   "performed_via_github_app" : null,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/21261.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21261",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/21261.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21261"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "p2p: update inbound eviction protection for multiple networks, add I2P peers",
   "updated_at" : "2021-06-14T13:30:38Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21261",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
      "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
      "followers_url" : "https://api.github.com/users/jonatack/followers",
      "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/jonatack",
      "id" : 2415484,
      "login" : "jonatack",
      "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
      "organizations_url" : "https://api.github.com/users/jonatack/orgs",
      "received_events_url" : "https://api.github.com/users/jonatack/received_events",
      "repos_url" : "https://api.github.com/users/jonatack/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/jonatack"
   }
}
