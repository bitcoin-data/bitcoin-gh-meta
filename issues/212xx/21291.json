{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "NONE",
   "body" : "When syncing Bitcoin Core with extremely fast storage the pre-allocation of block files with `fallocate` looks to be a surprising portion for the wall time for IBD and appears to sometimes slow down block relay at the tip of the chain. It's not completely clear why this would be the case, 300ms to write 16MB to `tmpfs` would be excessively slow. \r\n\r\nIs this an artifact of the logging (altered in #21041), or an actual performance concern?\r\n\r\n```\r\n2021-02-24T08:49:34.637365Z UpdateTip: new best=00000000000000000020fc15108523bcb10b5b76a3fd61ce57fb8460f666f845 height=578868 version=0x20000000 log2_work=90.697662 tx=420028811 date='2019-06-01T23:46:52Z' progress=0.679947 cache=74.0MiB(372110txo)\r\n2021-02-24T08:49:34.828910Z Pre-allocating up to position 0x6000000 in blk01663.dat\r\n\r\n...\r\n\r\n2021-02-24T08:49:42.683484Z Pre-allocating up to position 0x1000000 in blk01667.dat\r\n2021-02-24T08:49:42.951362Z Pre-allocating up to position 0x2000000 in blk01667.dat\r\n2021-02-24T08:49:43.257131Z Pre-allocating up to position 0x3000000 in blk01667.dat\r\n2021-02-24T08:49:43.510151Z Pre-allocating up to position 0x4000000 in blk01667.dat\r\n2021-02-24T08:49:43.752604Z Pre-allocating up to position 0x5000000 in blk01667.dat\r\n2021-02-24T08:49:44.074489Z Pre-allocating up to position 0x6000000 in blk01667.dat\r\n2021-02-24T08:49:44.341478Z Pre-allocating up to position 0x7000000 in blk01667.dat\r\n2021-02-24T08:49:44.655581Z Pre-allocating up to position 0x8000000 in blk01667.dat\r\n\r\n...\r\n\r\n2021-02-24T08:49:44.886586Z Pre-allocating up to position 0x1000000 in blk01668.dat\r\n2021-02-24T08:49:45.148651Z Pre-allocating up to position 0x2000000 in blk01668.dat\r\n2021-02-24T08:49:45.515480Z Pre-allocating up to position 0x100000 in rev01668.dat\r\n2021-02-24T08:49:45.525122Z UpdateTip: new best=0000000000000000000c7af325f257778530cd2127b0ceacb1f56ce4c98fa4dc height=578869 version=0x20c00000 log2_work=90.697685 tx=420031549 date='2019-06-02T00:18:16Z' progress=0.679951 cache=29.9MiB(12647txo)\r\n```\r\n\r\n\r\n",
   "closed_at" : "2022-08-04T17:09:06Z",
   "closed_by" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/755825?v=4",
      "events_url" : "https://api.github.com/users/adamjonas/events{/privacy}",
      "followers_url" : "https://api.github.com/users/adamjonas/followers",
      "following_url" : "https://api.github.com/users/adamjonas/following{/other_user}",
      "gists_url" : "https://api.github.com/users/adamjonas/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/adamjonas",
      "id" : 755825,
      "login" : "adamjonas",
      "node_id" : "MDQ6VXNlcjc1NTgyNQ==",
      "organizations_url" : "https://api.github.com/users/adamjonas/orgs",
      "received_events_url" : "https://api.github.com/users/adamjonas/received_events",
      "repos_url" : "https://api.github.com/users/adamjonas/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/adamjonas/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/adamjonas/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/adamjonas"
   },
   "comments" : 3,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21291/comments",
   "created_at" : "2021-02-24T09:34:51Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21291/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/21291",
   "id" : 815296567,
   "labels" : [
      {
         "color" : "000000",
         "default" : false,
         "description" : null,
         "id" : 219890555,
         "name" : "Block storage",
         "node_id" : "MDU6TGFiZWwyMTk4OTA1NTU=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Block%20storage"
      },
      {
         "color" : "006688",
         "default" : false,
         "description" : null,
         "id" : 477890092,
         "name" : "Questions and Help",
         "node_id" : "MDU6TGFiZWw0Nzc4OTAwOTI=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Questions%20and%20Help"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21291/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDU6SXNzdWU4MTUyOTY1Njc=",
   "number" : 21291,
   "performed_via_github_app" : null,
   "reactions" : {
      "+1" : 0,
      "-1" : 0,
      "confused" : 0,
      "eyes" : 0,
      "heart" : 0,
      "hooray" : 0,
      "laugh" : 0,
      "rocket" : 0,
      "total_count" : 0,
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21291/reactions"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "state_reason" : "completed",
   "timeline_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21291/timeline",
   "title" : "Block pre-allocation appears to have surprisingly poor performance ",
   "updated_at" : "2022-08-04T17:09:06Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21291",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/60858013?v=4",
      "events_url" : "https://api.github.com/users/wpeckr/events{/privacy}",
      "followers_url" : "https://api.github.com/users/wpeckr/followers",
      "following_url" : "https://api.github.com/users/wpeckr/following{/other_user}",
      "gists_url" : "https://api.github.com/users/wpeckr/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/wpeckr",
      "id" : 60858013,
      "login" : "wpeckr",
      "node_id" : "MDQ6VXNlcjYwODU4MDEz",
      "organizations_url" : "https://api.github.com/users/wpeckr/orgs",
      "received_events_url" : "https://api.github.com/users/wpeckr/received_events",
      "repos_url" : "https://api.github.com/users/wpeckr/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/wpeckr/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/wpeckr/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/wpeckr"
   }
}
